/*! For license information please see build.js.LICENSE.txt */
(()=>{var e,t={196:e=>{!function(){"use strict";e.exports={polyfill:function(){var e=window,t=document;if(!("scrollBehavior"in t.documentElement.style)||!0===e.__forceSmoothScrollPolyfill__){var i,r=e.HTMLElement||e.Element,n={scroll:e.scroll||e.scrollTo,scrollBy:e.scrollBy,elementScroll:r.prototype.scroll||o,scrollIntoView:r.prototype.scrollIntoView},s=e.performance&&e.performance.now?e.performance.now.bind(e.performance):Date.now,a=(i=e.navigator.userAgent,new RegExp(["MSIE ","Trident/","Edge/"].join("|")).test(i)?1:0);e.scroll=e.scrollTo=function(){void 0!==arguments[0]&&(!0!==l(arguments[0])?f.call(e,t.body,void 0!==arguments[0].left?~~arguments[0].left:e.scrollX||e.pageXOffset,void 0!==arguments[0].top?~~arguments[0].top:e.scrollY||e.pageYOffset):n.scroll.call(e,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:e.scrollX||e.pageXOffset,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:e.scrollY||e.pageYOffset))},e.scrollBy=function(){void 0!==arguments[0]&&(l(arguments[0])?n.scrollBy.call(e,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:0,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:0):f.call(e,t.body,~~arguments[0].left+(e.scrollX||e.pageXOffset),~~arguments[0].top+(e.scrollY||e.pageYOffset)))},r.prototype.scroll=r.prototype.scrollTo=function(){if(void 0!==arguments[0])if(!0!==l(arguments[0])){var e=arguments[0].left,t=arguments[0].top;f.call(this,this,void 0===e?this.scrollLeft:~~e,void 0===t?this.scrollTop:~~t)}else{if("number"==typeof arguments[0]&&void 0===arguments[1])throw new SyntaxError("Value could not be converted");n.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left:"object"!=typeof arguments[0]?~~arguments[0]:this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top:void 0!==arguments[1]?~~arguments[1]:this.scrollTop)}},r.prototype.scrollBy=function(){void 0!==arguments[0]&&(!0!==l(arguments[0])?this.scroll({left:~~arguments[0].left+this.scrollLeft,top:~~arguments[0].top+this.scrollTop,behavior:arguments[0].behavior}):n.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left+this.scrollLeft:~~arguments[0]+this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top+this.scrollTop:~~arguments[1]+this.scrollTop))},r.prototype.scrollIntoView=function(){if(!0!==l(arguments[0])){var i=function(e){for(;e!==t.body&&!1===d(e);)e=e.parentNode||e.host;return e}(this),r=i.getBoundingClientRect(),s=this.getBoundingClientRect();i!==t.body?(f.call(this,i,i.scrollLeft+s.left-r.left,i.scrollTop+s.top-r.top),"fixed"!==e.getComputedStyle(i).position&&e.scrollBy({left:r.left,top:r.top,behavior:"smooth"})):e.scrollBy({left:s.left,top:s.top,behavior:"smooth"})}else n.scrollIntoView.call(this,void 0===arguments[0]||arguments[0])}}function o(e,t){this.scrollLeft=e,this.scrollTop=t}function l(e){if(null===e||"object"!=typeof e||void 0===e.behavior||"auto"===e.behavior||"instant"===e.behavior)return!0;if("object"==typeof e&&"smooth"===e.behavior)return!1;throw new TypeError("behavior member of ScrollOptions "+e.behavior+" is not a valid value for enumeration ScrollBehavior.")}function h(e,t){return"Y"===t?e.clientHeight+a<e.scrollHeight:"X"===t?e.clientWidth+a<e.scrollWidth:void 0}function c(t,i){var r=e.getComputedStyle(t,null)["overflow"+i];return"auto"===r||"scroll"===r}function d(e){var t=h(e,"Y")&&c(e,"Y"),i=h(e,"X")&&c(e,"X");return t||i}function u(t){var i,r,n,a,o=(s()-t.startTime)/468;a=o=o>1?1:o,i=.5*(1-Math.cos(Math.PI*a)),r=t.startX+(t.x-t.startX)*i,n=t.startY+(t.y-t.startY)*i,t.method.call(t.scrollable,r,n),r===t.x&&n===t.y||e.requestAnimationFrame(u.bind(e,t))}function f(i,r,a){var l,h,c,d,f=s();i===t.body?(l=e,h=e.scrollX||e.pageXOffset,c=e.scrollY||e.pageYOffset,d=n.scroll):(l=i,h=i.scrollLeft,c=i.scrollTop,d=o),u({scrollable:l,method:d,startTime:f,startX:h,startY:c,x:r,y:a})}}}}()},436:e=>{var t;t=()=>{var e=(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,n={};((t,i)=>{for(var r in i)e(t,r,{get:i[r],enumerable:!0})})(n,{Iti:()=>y,default:()=>S});var s=[["af","93"],["ax","358",1],["al","355"],["dz","213"],["as","1",5,["684"]],["ad","376"],["ao","244"],["ai","1",6,["264"]],["ag","1",7,["268"]],["ar","54"],["am","374"],["aw","297"],["ac","247"],["au","61",0,null,"0"],["at","43"],["az","994"],["bs","1",8,["242"]],["bh","973"],["bd","880"],["bb","1",9,["246"]],["by","375"],["be","32"],["bz","501"],["bj","229"],["bm","1",10,["441"]],["bt","975"],["bo","591"],["ba","387"],["bw","267"],["br","55"],["io","246"],["vg","1",11,["284"]],["bn","673"],["bg","359"],["bf","226"],["bi","257"],["kh","855"],["cm","237"],["ca","1",1,["204","226","236","249","250","263","289","306","343","354","365","367","368","382","387","403","416","418","428","431","437","438","450","584","468","474","506","514","519","548","579","581","584","587","604","613","639","647","672","683","705","709","742","753","778","780","782","807","819","825","867","873","879","902","905"]],["cv","238"],["bq","599",1,["3","4","7"]],["ky","1",12,["345"]],["cf","236"],["td","235"],["cl","56"],["cn","86"],["cx","61",2,["89164"],"0"],["cc","61",1,["89162"],"0"],["co","57"],["km","269"],["cg","242"],["cd","243"],["ck","682"],["cr","506"],["ci","225"],["hr","385"],["cu","53"],["cw","599",0],["cy","357"],["cz","420"],["dk","45"],["dj","253"],["dm","1",13,["767"]],["do","1",2,["809","829","849"]],["ec","593"],["eg","20"],["sv","503"],["gq","240"],["er","291"],["ee","372"],["sz","268"],["et","251"],["fk","500"],["fo","298"],["fj","679"],["fi","358",0],["fr","33"],["gf","594"],["pf","689"],["ga","241"],["gm","220"],["ge","995"],["de","49"],["gh","233"],["gi","350"],["gr","30"],["gl","299"],["gd","1",14,["473"]],["gp","590",0],["gu","1",15,["671"]],["gt","502"],["gg","44",1,["1481","7781","7839","7911"],"0"],["gn","224"],["gw","245"],["gy","592"],["ht","509"],["hn","504"],["hk","852"],["hu","36"],["is","354"],["in","91"],["id","62"],["ir","98"],["iq","964"],["ie","353"],["im","44",2,["1624","74576","7524","7924","7624"],"0"],["il","972"],["it","39",0],["jm","1",4,["876","658"]],["jp","81"],["je","44",3,["1534","7509","7700","7797","7829","7937"],"0"],["jo","962"],["kz","7",1,["33","7"],"8"],["ke","254"],["ki","686"],["xk","383"],["kw","965"],["kg","996"],["la","856"],["lv","371"],["lb","961"],["ls","266"],["lr","231"],["ly","218"],["li","423"],["lt","370"],["lu","352"],["mo","853"],["mg","261"],["mw","265"],["my","60"],["mv","960"],["ml","223"],["mt","356"],["mh","692"],["mq","596"],["mr","222"],["mu","230"],["yt","262",1,["269","639"],"0"],["mx","52"],["fm","691"],["md","373"],["mc","377"],["mn","976"],["me","382"],["ms","1",16,["664"]],["ma","212",0,null,"0"],["mz","258"],["mm","95"],["na","264"],["nr","674"],["np","977"],["nl","31"],["nc","687"],["nz","64"],["ni","505"],["ne","227"],["ng","234"],["nu","683"],["nf","672"],["kp","850"],["mk","389"],["mp","1",17,["670"]],["no","47",0],["om","968"],["pk","92"],["pw","680"],["ps","970"],["pa","507"],["pg","675"],["py","595"],["pe","51"],["ph","63"],["pl","48"],["pt","351"],["pr","1",3,["787","939"]],["qa","974"],["re","262",0,null,"0"],["ro","40"],["ru","7",0,null,"8"],["rw","250"],["ws","685"],["sm","378"],["st","239"],["sa","966"],["sn","221"],["rs","381"],["sc","248"],["sl","232"],["sg","65"],["sx","1",21,["721"]],["sk","421"],["si","386"],["sb","677"],["so","252"],["za","27"],["kr","82"],["ss","211"],["es","34"],["lk","94"],["bl","590",1],["sh","290"],["kn","1",18,["869"]],["lc","1",19,["758"]],["mf","590",2],["pm","508"],["vc","1",20,["784"]],["sd","249"],["sr","597"],["sj","47",1,["79"]],["se","46"],["ch","41"],["sy","963"],["tw","886"],["tj","992"],["tz","255"],["th","66"],["tl","670"],["tg","228"],["tk","690"],["to","676"],["tt","1",22,["868"]],["tn","216"],["tr","90"],["tm","993"],["tc","1",23,["649"]],["tv","688"],["ug","256"],["ua","380"],["ae","971"],["gb","44",0,null,"0"],["us","1",0],["uy","598"],["vi","1",24,["340"]],["uz","998"],["vu","678"],["va","39",1,["06698"]],["ve","58"],["vn","84"],["wf","681"],["eh","212",1,["5288","5289"],"0"],["ye","967"],["zm","260"],["zw","263"]],a=[];for(let e=0;e<s.length;e++){const t=s[e];a[e]={name:"",iso2:t[0],dialCode:t[1],priority:t[2]||0,areaCodes:t[3]||null,nodeById:{},nationalPrefix:t[4]||null}}var o=a,l={ad:"Andorra",ae:"United Arab Emirates",af:"Afghanistan",ag:"Antigua & Barbuda",ai:"Anguilla",al:"Albania",am:"Armenia",ao:"Angola",ar:"Argentina",as:"American Samoa",at:"Austria",au:"Australia",aw:"Aruba",ax:"Åland Islands",az:"Azerbaijan",ba:"Bosnia & Herzegovina",bb:"Barbados",bd:"Bangladesh",be:"Belgium",bf:"Burkina Faso",bg:"Bulgaria",bh:"Bahrain",bi:"Burundi",bj:"Benin",bl:"St. Barthélemy",bm:"Bermuda",bn:"Brunei",bo:"Bolivia",bq:"Caribbean Netherlands",br:"Brazil",bs:"Bahamas",bt:"Bhutan",bw:"Botswana",by:"Belarus",bz:"Belize",ca:"Canada",cc:"Cocos (Keeling) Islands",cd:"Congo - Kinshasa",cf:"Central African Republic",cg:"Congo - Brazzaville",ch:"Switzerland",ci:"Côte d’Ivoire",ck:"Cook Islands",cl:"Chile",cm:"Cameroon",cn:"China",co:"Colombia",cr:"Costa Rica",cu:"Cuba",cv:"Cape Verde",cw:"Curaçao",cx:"Christmas Island",cy:"Cyprus",cz:"Czechia",de:"Germany",dj:"Djibouti",dk:"Denmark",dm:"Dominica",do:"Dominican Republic",dz:"Algeria",ec:"Ecuador",ee:"Estonia",eg:"Egypt",eh:"Western Sahara",er:"Eritrea",es:"Spain",et:"Ethiopia",fi:"Finland",fj:"Fiji",fk:"Falkland Islands",fm:"Micronesia",fo:"Faroe Islands",fr:"France",ga:"Gabon",gb:"United Kingdom",gd:"Grenada",ge:"Georgia",gf:"French Guiana",gg:"Guernsey",gh:"Ghana",gi:"Gibraltar",gl:"Greenland",gm:"Gambia",gn:"Guinea",gp:"Guadeloupe",gq:"Equatorial Guinea",gr:"Greece",gt:"Guatemala",gu:"Guam",gw:"Guinea-Bissau",gy:"Guyana",hk:"Hong Kong SAR China",hn:"Honduras",hr:"Croatia",ht:"Haiti",hu:"Hungary",id:"Indonesia",ie:"Ireland",il:"Israel",im:"Isle of Man",in:"India",io:"British Indian Ocean Territory",iq:"Iraq",ir:"Iran",is:"Iceland",it:"Italy",je:"Jersey",jm:"Jamaica",jo:"Jordan",jp:"Japan",ke:"Kenya",kg:"Kyrgyzstan",kh:"Cambodia",ki:"Kiribati",km:"Comoros",kn:"St. Kitts & Nevis",kp:"North Korea",kr:"South Korea",kw:"Kuwait",ky:"Cayman Islands",kz:"Kazakhstan",la:"Laos",lb:"Lebanon",lc:"St. Lucia",li:"Liechtenstein",lk:"Sri Lanka",lr:"Liberia",ls:"Lesotho",lt:"Lithuania",lu:"Luxembourg",lv:"Latvia",ly:"Libya",ma:"Morocco",mc:"Monaco",md:"Moldova",me:"Montenegro",mf:"St. Martin",mg:"Madagascar",mh:"Marshall Islands",mk:"North Macedonia",ml:"Mali",mm:"Myanmar (Burma)",mn:"Mongolia",mo:"Macao SAR China",mp:"Northern Mariana Islands",mq:"Martinique",mr:"Mauritania",ms:"Montserrat",mt:"Malta",mu:"Mauritius",mv:"Maldives",mw:"Malawi",mx:"Mexico",my:"Malaysia",mz:"Mozambique",na:"Namibia",nc:"New Caledonia",ne:"Niger",nf:"Norfolk Island",ng:"Nigeria",ni:"Nicaragua",nl:"Netherlands",no:"Norway",np:"Nepal",nr:"Nauru",nu:"Niue",nz:"New Zealand",om:"Oman",pa:"Panama",pe:"Peru",pf:"French Polynesia",pg:"Papua New Guinea",ph:"Philippines",pk:"Pakistan",pl:"Poland",pm:"St. Pierre & Miquelon",pr:"Puerto Rico",ps:"Palestinian Territories",pt:"Portugal",pw:"Palau",py:"Paraguay",qa:"Qatar",re:"Réunion",ro:"Romania",rs:"Serbia",ru:"Russia",rw:"Rwanda",sa:"Saudi Arabia",sb:"Solomon Islands",sc:"Seychelles",sd:"Sudan",se:"Sweden",sg:"Singapore",sh:"St. Helena",si:"Slovenia",sj:"Svalbard & Jan Mayen",sk:"Slovakia",sl:"Sierra Leone",sm:"San Marino",sn:"Senegal",so:"Somalia",sr:"Suriname",ss:"South Sudan",st:"São Tomé & Príncipe",sv:"El Salvador",sx:"Sint Maarten",sy:"Syria",sz:"Eswatini",tc:"Turks & Caicos Islands",td:"Chad",tg:"Togo",th:"Thailand",tj:"Tajikistan",tk:"Tokelau",tl:"Timor-Leste",tm:"Turkmenistan",tn:"Tunisia",to:"Tonga",tr:"Turkey",tt:"Trinidad & Tobago",tv:"Tuvalu",tw:"Taiwan",tz:"Tanzania",ua:"Ukraine",ug:"Uganda",us:"United States",uy:"Uruguay",uz:"Uzbekistan",va:"Vatican City",vc:"St. Vincent & Grenadines",ve:"Venezuela",vg:"British Virgin Islands",vi:"U.S. Virgin Islands",vn:"Vietnam",vu:"Vanuatu",wf:"Wallis & Futuna",ws:"Samoa",ye:"Yemen",yt:"Mayotte",za:"South Africa",zm:"Zambia",zw:"Zimbabwe",selectedCountryAriaLabel:"Selected country",noCountrySelected:"No country selected",countryListAriaLabel:"List of countries",searchPlaceholder:"Search",zeroSearchResults:"No results found",oneSearchResult:"1 result found",multipleSearchResults:"${count} results found",ac:"Ascension Island",xk:"Kosovo"};for(let e=0;e<o.length;e++)o[e].name=l[o[e].iso2];var h,c=0,d={allowDropdown:!0,autoPlaceholder:"polite",containerClass:"",countryOrder:null,countrySearch:!0,customPlaceholder:null,dropdownContainer:null,excludeCountries:[],fixDropdownWidth:!0,formatAsYouType:!0,formatOnDisplay:!0,geoIpLookup:null,hiddenInput:null,i18n:{},initialCountry:"",loadUtils:null,nationalMode:!0,onlyCountries:[],placeholderNumberType:"MOBILE",showFlags:!0,separateDialCode:!1,strictMode:!1,useFullscreenPopup:"undefined"!=typeof navigator&&"undefined"!=typeof window&&(/Android.+Mobile|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=500),validationNumberTypes:["MOBILE"]},u=["800","822","833","844","855","866","877","880","881","882","883","884","885","886","887","888","889"],f=e=>e.replace(/\D/g,""),p=(e="")=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),m=e=>{const t=f(e);if("1"===t.charAt(0)){const e=t.substr(1,3);return u.includes(e)}return!1},g=(e,t,i)=>{const r=document.createElement(e);return t&&Object.entries(t).forEach(([e,t])=>r.setAttribute(e,t)),i&&i.appendChild(r),r},v=(e,...t)=>{const{instances:i}=_;Object.values(i).forEach(i=>i[e](...t))},y=class{constructor(e,t={}){this.id=c++,this.telInput=e,this.highlightedItem=null,this.options=Object.assign({},d,t),this.hadInitialPlaceholder=Boolean(e.getAttribute("placeholder"))}_init(){this.options.useFullscreenPopup&&(this.options.fixDropdownWidth=!1),1===this.options.onlyCountries.length&&(this.options.initialCountry=this.options.onlyCountries[0]),this.options.separateDialCode&&(this.options.nationalMode=!1),!this.options.allowDropdown||this.options.showFlags||this.options.separateDialCode||(this.options.nationalMode=!1),this.options.useFullscreenPopup&&!this.options.dropdownContainer&&(this.options.dropdownContainer=document.body),this.isAndroid="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),this.isRTL=!!this.telInput.closest("[dir=rtl]");const e=this.options.allowDropdown||this.options.separateDialCode;this.showSelectedCountryOnLeft=this.isRTL?!e:e,this.options.separateDialCode&&(this.isRTL?this.originalPaddingRight=this.telInput.style.paddingRight:this.originalPaddingLeft=this.telInput.style.paddingLeft),this.options.i18n={...l,...this.options.i18n};const t=new Promise((e,t)=>{this.resolveAutoCountryPromise=e,this.rejectAutoCountryPromise=t}),i=new Promise((e,t)=>{this.resolveUtilsScriptPromise=e,this.rejectUtilsScriptPromise=t});this.promise=Promise.all([t,i]),this.selectedCountryData={},this._processCountryData(),this._generateMarkup(),this._setInitialState(),this._initListeners(),this._initRequests()}_processCountryData(){this._processAllCountries(),this._processDialCodes(),this._translateCountryNames(),this._sortCountries()}_sortCountries(){this.options.countryOrder&&(this.options.countryOrder=this.options.countryOrder.map(e=>e.toLowerCase())),this.countries.sort((e,t)=>{const{countryOrder:i}=this.options;if(i){const r=i.indexOf(e.iso2),n=i.indexOf(t.iso2),s=r>-1,a=n>-1;if(s||a)return s&&a?r-n:s?-1:1}return e.name.localeCompare(t.name)})}_addToDialCodeMap(e,t,i){t.length>this.dialCodeMaxLen&&(this.dialCodeMaxLen=t.length),this.dialCodeToIso2Map.hasOwnProperty(t)||(this.dialCodeToIso2Map[t]=[]);for(let i=0;i<this.dialCodeToIso2Map[t].length;i++)if(this.dialCodeToIso2Map[t][i]===e)return;const r=void 0!==i?i:this.dialCodeToIso2Map[t].length;this.dialCodeToIso2Map[t][r]=e}_processAllCountries(){const{onlyCountries:e,excludeCountries:t}=this.options;if(e.length){const t=e.map(e=>e.toLowerCase());this.countries=o.filter(e=>t.includes(e.iso2))}else if(t.length){const e=t.map(e=>e.toLowerCase());this.countries=o.filter(t=>!e.includes(t.iso2))}else this.countries=o}_translateCountryNames(){for(let e=0;e<this.countries.length;e++){const t=this.countries[e].iso2.toLowerCase();this.options.i18n.hasOwnProperty(t)&&(this.countries[e].name=this.options.i18n[t])}}_processDialCodes(){this.dialCodes={},this.dialCodeMaxLen=0,this.dialCodeToIso2Map={};for(let e=0;e<this.countries.length;e++){const t=this.countries[e];this.dialCodes[t.dialCode]||(this.dialCodes[t.dialCode]=!0),this._addToDialCodeMap(t.iso2,t.dialCode,t.priority)}for(let e=0;e<this.countries.length;e++){const t=this.countries[e];if(t.areaCodes){const e=this.dialCodeToIso2Map[t.dialCode][0];for(let i=0;i<t.areaCodes.length;i++){const r=t.areaCodes[i];for(let i=1;i<r.length;i++){const n=r.substr(0,i),s=t.dialCode+n;this._addToDialCodeMap(e,s),this._addToDialCodeMap(t.iso2,s)}this._addToDialCodeMap(t.iso2,t.dialCode+r)}}}}_generateMarkup(){this.telInput.classList.add("iti__tel-input"),this.telInput.hasAttribute("autocomplete")||this.telInput.form&&this.telInput.form.hasAttribute("autocomplete")||this.telInput.setAttribute("autocomplete","off");const{allowDropdown:e,separateDialCode:t,showFlags:i,containerClass:r,hiddenInput:n,dropdownContainer:s,fixDropdownWidth:a,useFullscreenPopup:o,countrySearch:l,i18n:h}=this.options;let c="iti";e&&(c+=" iti--allow-dropdown"),i&&(c+=" iti--show-flags"),r&&(c+=` ${r}`),o||(c+=" iti--inline-dropdown");const d=g("div",{class:c});if(this.telInput.parentNode?.insertBefore(d,this.telInput),e||i||t){this.countryContainer=g("div",{class:"iti__country-container"},d),this.showSelectedCountryOnLeft?this.countryContainer.style.left="0px":this.countryContainer.style.right="0px",e?(this.selectedCountry=g("button",{type:"button",class:"iti__selected-country","aria-expanded":"false","aria-label":this.options.i18n.selectedCountryAriaLabel,"aria-haspopup":"true","aria-controls":`iti-${this.id}__dropdown-content`,role:"combobox"},this.countryContainer),this.telInput.disabled&&this.selectedCountry.setAttribute("disabled","true")):this.selectedCountry=g("div",{class:"iti__selected-country"},this.countryContainer);const i=g("div",{class:"iti__selected-country-primary"},this.selectedCountry);if(this.selectedCountryInner=g("div",{class:"iti__flag"},i),this.selectedCountryA11yText=g("span",{class:"iti__a11y-text"},this.selectedCountryInner),e&&(this.dropdownArrow=g("div",{class:"iti__arrow","aria-hidden":"true"},i)),t&&(this.selectedDialCode=g("div",{class:"iti__selected-dial-code"},this.selectedCountry)),e){const e=a?"":"iti--flexible-dropdown-width";if(this.dropdownContent=g("div",{id:`iti-${this.id}__dropdown-content`,class:`iti__dropdown-content iti__hide ${e}`}),l&&(this.searchInput=g("input",{type:"text",class:"iti__search-input",placeholder:h.searchPlaceholder,role:"combobox","aria-expanded":"true","aria-label":h.searchPlaceholder,"aria-controls":`iti-${this.id}__country-listbox`,"aria-autocomplete":"list",autocomplete:"off"},this.dropdownContent),this.searchResultsA11yText=g("span",{class:"iti__a11y-text"},this.dropdownContent)),this.countryList=g("ul",{class:"iti__country-list",id:`iti-${this.id}__country-listbox`,role:"listbox","aria-label":h.countryListAriaLabel},this.dropdownContent),this._appendListItems(),l&&this._updateSearchResultsText(),s){let e="iti iti--container";e+=o?" iti--fullscreen-popup":" iti--inline-dropdown",this.dropdown=g("div",{class:e}),this.dropdown.appendChild(this.dropdownContent)}else this.countryContainer.appendChild(this.dropdownContent)}}if(d.appendChild(this.telInput),this._updateInputPadding(),n){const e=n(this.telInput.getAttribute("name")||"");if(e.phone){const t=this.telInput.form?.querySelector(`input[name="${e.phone}"]`);t?this.hiddenInput=t:(this.hiddenInput=g("input",{type:"hidden",name:e.phone}),d.appendChild(this.hiddenInput))}if(e.country){const t=this.telInput.form?.querySelector(`input[name="${e.country}"]`);t?this.hiddenInputCountry=t:(this.hiddenInputCountry=g("input",{type:"hidden",name:e.country}),d.appendChild(this.hiddenInputCountry))}}}_appendListItems(){for(let e=0;e<this.countries.length;e++){const t=this.countries[e],i=0===e?"iti__highlight":"",r=g("li",{id:`iti-${this.id}__item-${t.iso2}`,class:`iti__country ${i}`,tabindex:"-1",role:"option","data-dial-code":t.dialCode,"data-country-code":t.iso2,"aria-selected":"false"},this.countryList);t.nodeById[this.id]=r;let n="";this.options.showFlags&&(n+=`<div class='iti__flag iti__${t.iso2}'></div>`),n+=`<span class='iti__country-name'>${t.name}</span>`,n+=`<span class='iti__dial-code'>+${t.dialCode}</span>`,r.insertAdjacentHTML("beforeend",n)}}_setInitialState(e=!1){const t=this.telInput.getAttribute("value"),i=this.telInput.value,r=!t||"+"!==t.charAt(0)||i&&"+"===i.charAt(0)?i:t,n=this._getDialCode(r),s=m(r),{initialCountry:a,geoIpLookup:o}=this.options,l="auto"===a&&o;if(n&&!s)this._updateCountryFromNumber(r);else if(!l||e){const e=a?a.toLowerCase():"";e&&this._getCountryData(e,!0)?this._setCountry(e):n&&s?this._setCountry("us"):this._setCountry()}r&&this._updateValFromNumber(r)}_initListeners(){this._initTelInputListeners(),this.options.allowDropdown&&this._initDropdownListeners(),(this.hiddenInput||this.hiddenInputCountry)&&this.telInput.form&&this._initHiddenInputListener()}_initHiddenInputListener(){this._handleHiddenInputSubmit=()=>{this.hiddenInput&&(this.hiddenInput.value=this.getNumber()),this.hiddenInputCountry&&(this.hiddenInputCountry.value=this.getSelectedCountryData().iso2||"")},this.telInput.form?.addEventListener("submit",this._handleHiddenInputSubmit)}_initDropdownListeners(){this._handleLabelClick=e=>{this.dropdownContent.classList.contains("iti__hide")?this.telInput.focus():e.preventDefault()};const e=this.telInput.closest("label");e&&e.addEventListener("click",this._handleLabelClick),this._handleClickSelectedCountry=()=>{!this.dropdownContent.classList.contains("iti__hide")||this.telInput.disabled||this.telInput.readOnly||this._openDropdown()},this.selectedCountry.addEventListener("click",this._handleClickSelectedCountry),this._handleCountryContainerKeydown=e=>{this.dropdownContent.classList.contains("iti__hide")&&["ArrowUp","ArrowDown"," ","Enter"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),this._openDropdown()),"Tab"===e.key&&this._closeDropdown()},this.countryContainer.addEventListener("keydown",this._handleCountryContainerKeydown)}_initRequests(){let{loadUtils:e,initialCountry:t,geoIpLookup:i}=this.options;e&&!_.utils?(this._handlePageLoad=()=>{window.removeEventListener("load",this._handlePageLoad),_.attachUtils(e)?.catch(()=>{})},_.documentReady()?this._handlePageLoad():window.addEventListener("load",this._handlePageLoad)):this.resolveUtilsScriptPromise(),"auto"===t&&i&&!this.selectedCountryData.iso2?this._loadAutoCountry():this.resolveAutoCountryPromise()}_loadAutoCountry(){_.autoCountry?this.handleAutoCountry():_.startedLoadingAutoCountry||(_.startedLoadingAutoCountry=!0,"function"==typeof this.options.geoIpLookup&&this.options.geoIpLookup((e="")=>{const t=e.toLowerCase();t&&this._getCountryData(t,!0)?(_.autoCountry=t,setTimeout(()=>v("handleAutoCountry"))):(this._setInitialState(!0),v("rejectAutoCountryPromise"))},()=>{this._setInitialState(!0),v("rejectAutoCountryPromise")}))}_openDropdownWithPlus(){this._openDropdown(),this.searchInput.value="+",this._filterCountries("",!0)}_initTelInputListeners(){const{strictMode:e,formatAsYouType:t,separateDialCode:i,formatOnDisplay:r,allowDropdown:n,countrySearch:s}=this.options;let a=!1;/\p{L}/u.test(this.telInput.value)&&(a=!0),this._handleInputEvent=o=>{if(this.isAndroid&&"+"===o?.data&&i&&n&&s){const e=this.telInput.selectionStart||0,t=this.telInput.value.substring(0,e-1),i=this.telInput.value.substring(e);return this.telInput.value=t+i,void this._openDropdownWithPlus()}this._updateCountryFromNumber(this.telInput.value)&&this._triggerCountryChange();const l=o?.data&&/[^+0-9]/.test(o.data),h="insertFromPaste"===o?.inputType&&this.telInput.value;l||h&&!e?a=!0:/[^+0-9]/.test(this.telInput.value)||(a=!1);const c=o?.detail&&o.detail.isSetNumber&&!r;if(t&&!a&&!c){const e=this.telInput.selectionStart||0,t=this.telInput.value.substring(0,e).replace(/[^+0-9]/g,"").length,i="deleteContentForward"===o?.inputType,r=this._formatNumberAsYouType(),n=((e,t,i,r)=>{if(0===i&&!r)return 0;let n=0;for(let i=0;i<t.length;i++){if(/[+0-9]/.test(t[i])&&n++,n===e&&!r)return i+1;if(r&&n===e+1)return i}return t.length})(t,r,e,i);this.telInput.value=r,this.telInput.setSelectionRange(n,n)}},this.telInput.addEventListener("input",this._handleInputEvent),(e||i)&&(this._handleKeydownEvent=t=>{if(t.key&&1===t.key.length&&!t.altKey&&!t.ctrlKey&&!t.metaKey){if(i&&n&&s&&"+"===t.key)return t.preventDefault(),void this._openDropdownWithPlus();if(e){const e=this.telInput.value,r="+"===e.charAt(0),n=!r&&0===this.telInput.selectionStart&&"+"===t.key,s=/^[0-9]$/.test(t.key),a=i?s:n||s,o=e.slice(0,this.telInput.selectionStart)+t.key+e.slice(this.telInput.selectionEnd),l=this._getFullNumber(o),h=_.utils.getCoreNumber(l,this.selectedCountryData.iso2),c=this.maxCoreNumberLength&&h.length>this.maxCoreNumberLength;let d=!1;if(r){const e=this.selectedCountryData.iso2;d=this._getCountryFromNumber(l)!==e}a&&(!c||d||n)||t.preventDefault()}}},this.telInput.addEventListener("keydown",this._handleKeydownEvent))}_cap(e){const t=parseInt(this.telInput.getAttribute("maxlength")||"",10);return t&&e.length>t?e.substr(0,t):e}_trigger(e,t={}){const i=new CustomEvent(e,{bubbles:!0,cancelable:!0,detail:t});this.telInput.dispatchEvent(i)}_openDropdown(){const{fixDropdownWidth:e,countrySearch:t}=this.options;if(e&&(this.dropdownContent.style.width=`${this.telInput.offsetWidth}px`),this.dropdownContent.classList.remove("iti__hide"),this.selectedCountry.setAttribute("aria-expanded","true"),this._setDropdownPosition(),t){const e=this.countryList.firstElementChild;e&&(this._highlightListItem(e,!1),this.countryList.scrollTop=0),this.searchInput.focus()}this._bindDropdownListeners(),this.dropdownArrow.classList.add("iti__arrow--up"),this._trigger("open:countrydropdown")}_setDropdownPosition(){if(this.options.dropdownContainer&&this.options.dropdownContainer.appendChild(this.dropdown),!this.options.useFullscreenPopup){const e=this.telInput.getBoundingClientRect(),t=this.telInput.offsetHeight;this.options.dropdownContainer&&(this.dropdown.style.top=`${e.top+t}px`,this.dropdown.style.left=`${e.left}px`,this._handleWindowScroll=()=>this._closeDropdown(),window.addEventListener("scroll",this._handleWindowScroll))}}_bindDropdownListeners(){this._handleMouseoverCountryList=e=>{const t=e.target?.closest(".iti__country");t&&this._highlightListItem(t,!1)},this.countryList.addEventListener("mouseover",this._handleMouseoverCountryList),this._handleClickCountryList=e=>{const t=e.target?.closest(".iti__country");t&&this._selectListItem(t)},this.countryList.addEventListener("click",this._handleClickCountryList);let e=!0;this._handleClickOffToClose=()=>{e||this._closeDropdown(),e=!1},document.documentElement.addEventListener("click",this._handleClickOffToClose);let t="",i=null;if(this._handleKeydownOnDropdown=e=>{["ArrowUp","ArrowDown","Enter","Escape"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),"ArrowUp"===e.key||"ArrowDown"===e.key?this._handleUpDownKey(e.key):"Enter"===e.key?this._handleEnterKey():"Escape"===e.key&&this._closeDropdown()),!this.options.countrySearch&&/^[a-zA-ZÀ-ÿа-яА-Я ]$/.test(e.key)&&(e.stopPropagation(),i&&clearTimeout(i),t+=e.key.toLowerCase(),this._searchForCountry(t),i=setTimeout(()=>{t=""},1e3))},document.addEventListener("keydown",this._handleKeydownOnDropdown),this.options.countrySearch){const e=()=>{const e=this.searchInput.value.trim();e?this._filterCountries(e):this._filterCountries("",!0)};let t=null;this._handleSearchChange=()=>{t&&clearTimeout(t),t=setTimeout(()=>{e(),t=null},100)},this.searchInput.addEventListener("input",this._handleSearchChange),this.searchInput.addEventListener("click",e=>e.stopPropagation())}}_searchForCountry(e){for(let t=0;t<this.countries.length;t++){const i=this.countries[t];if(i.name.substr(0,e.length).toLowerCase()===e){const e=i.nodeById[this.id];this._highlightListItem(e,!1),this._scrollTo(e);break}}}_filterCountries(e,t=!1){let i=!0;this.countryList.innerHTML="";const r=p(e);for(let e=0;e<this.countries.length;e++){const n=this.countries[e],s=p(n.name),a=n.name.split(/[^a-zA-ZÀ-ÿа-яА-Я]/).map(e=>e[0]).join("").toLowerCase(),o=`+${n.dialCode}`;if(t||s.includes(r)||o.includes(r)||n.iso2.includes(r)||a.includes(r)){const e=n.nodeById[this.id];e&&this.countryList.appendChild(e),i&&(this._highlightListItem(e,!1),i=!1)}}i&&this._highlightListItem(null,!1),this.countryList.scrollTop=0,this._updateSearchResultsText()}_updateSearchResultsText(){const{i18n:e}=this.options,t=this.countryList.childElementCount;let i;i=0===t?e.zeroSearchResults:1===t?e.oneSearchResult:e.multipleSearchResults.replace("${count}",t.toString()),this.searchResultsA11yText.textContent=i}_handleUpDownKey(e){let t="ArrowUp"===e?this.highlightedItem?.previousElementSibling:this.highlightedItem?.nextElementSibling;!t&&this.countryList.childElementCount>1&&(t="ArrowUp"===e?this.countryList.lastElementChild:this.countryList.firstElementChild),t&&(this._scrollTo(t),this._highlightListItem(t,!1))}_handleEnterKey(){this.highlightedItem&&this._selectListItem(this.highlightedItem)}_updateValFromNumber(e){let t=e;if(this.options.formatOnDisplay&&_.utils&&this.selectedCountryData){const e=this.options.nationalMode||"+"!==t.charAt(0)&&!this.options.separateDialCode,{NATIONAL:i,INTERNATIONAL:r}=_.utils.numberFormat,n=e?i:r;t=_.utils.formatNumber(t,this.selectedCountryData.iso2,n)}t=this._beforeSetNumber(t),this.telInput.value=t}_updateCountryFromNumber(e){const t=this._getCountryFromNumber(e);return null!==t&&this._setCountry(t)}_ensureHasDialCode(e){const{dialCode:t,nationalPrefix:i}=this.selectedCountryData;return"+"!==e.charAt(0)&&t?`+${t}${i&&e.charAt(0)===i&&!this.options.separateDialCode?e.substring(1):e}`:e}_getCountryFromNumber(e){const t=e.indexOf("+");let i=t?e.substring(t):e;const r=this.selectedCountryData.iso2,n=this.selectedCountryData.dialCode;i=this._ensureHasDialCode(i);const s=this._getDialCode(i,!0),a=f(i);if(s){const e=f(s),t=this.dialCodeToIso2Map[e];if(!r&&this.defaultCountry&&t.includes(this.defaultCountry))return this.defaultCountry;const i=r&&t.includes(r)&&(a.length===e.length||!this.selectedCountryData.areaCodes);if(!("1"===n&&m(a)||i))for(let e=0;e<t.length;e++)if(t[e])return t[e]}else{if("+"===i.charAt(0)&&a.length)return"";if(!(i&&"+"!==i||this.selectedCountryData.iso2))return this.defaultCountry}return null}_highlightListItem(e,t){const i=this.highlightedItem;if(i&&(i.classList.remove("iti__highlight"),i.setAttribute("aria-selected","false")),this.highlightedItem=e,this.highlightedItem){this.highlightedItem.classList.add("iti__highlight"),this.highlightedItem.setAttribute("aria-selected","true");const e=this.highlightedItem.getAttribute("id")||"";this.selectedCountry.setAttribute("aria-activedescendant",e),this.options.countrySearch&&this.searchInput.setAttribute("aria-activedescendant",e)}t&&this.highlightedItem.focus()}_getCountryData(e,t){for(let t=0;t<this.countries.length;t++)if(this.countries[t].iso2===e)return this.countries[t];if(t)return null;throw new Error(`No country data for '${e}'`)}_setCountry(e){const{separateDialCode:t,showFlags:i,i18n:r}=this.options,n=this.selectedCountryData.iso2?this.selectedCountryData:{};if(this.selectedCountryData=e&&this._getCountryData(e,!1)||{},this.selectedCountryData.iso2&&(this.defaultCountry=this.selectedCountryData.iso2),this.selectedCountryInner){let t="",n="";e&&i?(t=`iti__flag iti__${e}`,n=`${this.selectedCountryData.name} +${this.selectedCountryData.dialCode}`):(t="iti__flag iti__globe",n=r.noCountrySelected),this.selectedCountryInner.className=t,this.selectedCountryA11yText.textContent=n}if(this._setSelectedCountryTitleAttribute(e,t),t){const e=this.selectedCountryData.dialCode?`+${this.selectedCountryData.dialCode}`:"";this.selectedDialCode.innerHTML=e,this._updateInputPadding()}return this._updatePlaceholder(),this._updateMaxLength(),n.iso2!==e}_updateInputPadding(){if(this.selectedCountry){const e=(this.selectedCountry.offsetWidth||this._getHiddenSelectedCountryWidth())+6;this.showSelectedCountryOnLeft?this.telInput.style.paddingLeft=`${e}px`:this.telInput.style.paddingRight=`${e}px`}}_updateMaxLength(){const{strictMode:e,placeholderNumberType:t,validationNumberTypes:i}=this.options,{iso2:r}=this.selectedCountryData;if(e&&_.utils)if(r){const e=_.utils.numberType[t];let n=_.utils.getExampleNumber(r,!1,e,!0),s=n;for(;_.utils.isPossibleNumber(n,r,i);)s=n,n+="0";const a=_.utils.getCoreNumber(s,r);this.maxCoreNumberLength=a.length,"by"===r&&(this.maxCoreNumberLength=a.length+1)}else this.maxCoreNumberLength=null}_setSelectedCountryTitleAttribute(e=null,t){if(!this.selectedCountry)return;let i;i=e&&!t?`${this.selectedCountryData.name}: +${this.selectedCountryData.dialCode}`:e?this.selectedCountryData.name:"Unknown",this.selectedCountry.setAttribute("title",i)}_getHiddenSelectedCountryWidth(){if(this.telInput.parentNode){const e=this.telInput.parentNode.cloneNode(!1);e.style.visibility="hidden",document.body.appendChild(e);const t=this.countryContainer.cloneNode();e.appendChild(t);const i=this.selectedCountry.cloneNode(!0);t.appendChild(i);const r=i.offsetWidth;return document.body.removeChild(e),r}return 0}_updatePlaceholder(){const{autoPlaceholder:e,placeholderNumberType:t,nationalMode:i,customPlaceholder:r}=this.options,n="aggressive"===e||!this.hadInitialPlaceholder&&"polite"===e;if(_.utils&&n){const e=_.utils.numberType[t];let n=this.selectedCountryData.iso2?_.utils.getExampleNumber(this.selectedCountryData.iso2,i,e):"";n=this._beforeSetNumber(n),"function"==typeof r&&(n=r(n,this.selectedCountryData)),this.telInput.setAttribute("placeholder",n)}}_selectListItem(e){const t=this._setCountry(e.getAttribute("data-country-code"));this._closeDropdown(),this._updateDialCode(e.getAttribute("data-dial-code")),this.telInput.focus(),t&&this._triggerCountryChange()}_closeDropdown(){this.dropdownContent.classList.add("iti__hide"),this.selectedCountry.setAttribute("aria-expanded","false"),this.selectedCountry.removeAttribute("aria-activedescendant"),this.highlightedItem&&this.highlightedItem.setAttribute("aria-selected","false"),this.options.countrySearch&&this.searchInput.removeAttribute("aria-activedescendant"),this.dropdownArrow.classList.remove("iti__arrow--up"),document.removeEventListener("keydown",this._handleKeydownOnDropdown),this.options.countrySearch&&this.searchInput.removeEventListener("input",this._handleSearchChange),document.documentElement.removeEventListener("click",this._handleClickOffToClose),this.countryList.removeEventListener("mouseover",this._handleMouseoverCountryList),this.countryList.removeEventListener("click",this._handleClickCountryList),this.options.dropdownContainer&&(this.options.useFullscreenPopup||window.removeEventListener("scroll",this._handleWindowScroll),this.dropdown.parentNode&&this.dropdown.parentNode.removeChild(this.dropdown)),this._handlePageLoad&&window.removeEventListener("load",this._handlePageLoad),this._trigger("close:countrydropdown")}_scrollTo(e){const t=this.countryList,i=document.documentElement.scrollTop,r=t.offsetHeight,n=t.getBoundingClientRect().top+i,s=n+r,a=e.offsetHeight,o=e.getBoundingClientRect().top+i,l=o+a,h=o-n+t.scrollTop;if(o<n)t.scrollTop=h;else if(l>s){const e=r-a;t.scrollTop=h-e}}_updateDialCode(e){const t=this.telInput.value,i=`+${e}`;let r;if("+"===t.charAt(0)){const e=this._getDialCode(t);r=e?t.replace(e,i):i,this.telInput.value=r}}_getDialCode(e,t){let i="";if("+"===e.charAt(0)){let r="";for(let n=0;n<e.length;n++){const s=e.charAt(n);if(!isNaN(parseInt(s,10))){if(r+=s,t)this.dialCodeToIso2Map[r]&&(i=e.substr(0,n+1));else if(this.dialCodes[r]){i=e.substr(0,n+1);break}if(r.length===this.dialCodeMaxLen)break}}}return i}_getFullNumber(e){const t=e||this.telInput.value.trim(),{dialCode:i}=this.selectedCountryData;let r;const n=f(t);return r=this.options.separateDialCode&&"+"!==t.charAt(0)&&i&&n?`+${i}`:"",r+t}_beforeSetNumber(e){let t=e;if(this.options.separateDialCode){let e=this._getDialCode(t);if(e){e=`+${this.selectedCountryData.dialCode}`;const i=" "===t[e.length]||"-"===t[e.length]?e.length+1:e.length;t=t.substr(i)}}return this._cap(t)}_triggerCountryChange(){this._trigger("countrychange")}_formatNumberAsYouType(){const e=this._getFullNumber(),t=_.utils?_.utils.formatNumberAsYouType(e,this.selectedCountryData.iso2):e,{dialCode:i}=this.selectedCountryData;return this.options.separateDialCode&&"+"!==this.telInput.value.charAt(0)&&t.includes(`+${i}`)?(t.split(`+${i}`)[1]||"").trim():t}handleAutoCountry(){"auto"===this.options.initialCountry&&_.autoCountry&&(this.defaultCountry=_.autoCountry,this.selectedCountryData.iso2||this.selectedCountryInner.classList.contains("iti__globe")||this.setCountry(this.defaultCountry),this.resolveAutoCountryPromise())}handleUtils(){_.utils&&(this.telInput.value&&this._updateValFromNumber(this.telInput.value),this.selectedCountryData.iso2&&(this._updatePlaceholder(),this._updateMaxLength())),this.resolveUtilsScriptPromise()}destroy(){const{allowDropdown:e,separateDialCode:t}=this.options;if(e){this._closeDropdown(),this.selectedCountry.removeEventListener("click",this._handleClickSelectedCountry),this.countryContainer.removeEventListener("keydown",this._handleCountryContainerKeydown);const e=this.telInput.closest("label");e&&e.removeEventListener("click",this._handleLabelClick)}const{form:i}=this.telInput;this._handleHiddenInputSubmit&&i&&i.removeEventListener("submit",this._handleHiddenInputSubmit),this.telInput.removeEventListener("input",this._handleInputEvent),this._handleKeydownEvent&&this.telInput.removeEventListener("keydown",this._handleKeydownEvent),this.telInput.removeAttribute("data-intl-tel-input-id"),t&&(this.isRTL?this.telInput.style.paddingRight=this.originalPaddingRight:this.telInput.style.paddingLeft=this.originalPaddingLeft);const r=this.telInput.parentNode;r?.parentNode?.insertBefore(this.telInput,r),r?.parentNode?.removeChild(r),delete _.instances[this.id]}getExtension(){return _.utils?_.utils.getExtension(this._getFullNumber(),this.selectedCountryData.iso2):""}getNumber(e){if(_.utils){const{iso2:t}=this.selectedCountryData;return _.utils.formatNumber(this._getFullNumber(),t,e)}return""}getNumberType(){return _.utils?_.utils.getNumberType(this._getFullNumber(),this.selectedCountryData.iso2):-99}getSelectedCountryData(){return this.selectedCountryData}getValidationError(){if(_.utils){const{iso2:e}=this.selectedCountryData;return _.utils.getValidationError(this._getFullNumber(),e)}return-99}isValidNumber(){if(!this.selectedCountryData.iso2)return!1;const e=this._getFullNumber(),t=e.search(/\p{L}/u);if(t>-1){const i=e.substring(0,t),r=this._utilsIsPossibleNumber(i),n=this._utilsIsPossibleNumber(e);return r&&n}return this._utilsIsPossibleNumber(e)}_utilsIsPossibleNumber(e){return _.utils?_.utils.isPossibleNumber(e,this.selectedCountryData.iso2,this.options.validationNumberTypes):null}isValidNumberPrecise(){if(!this.selectedCountryData.iso2)return!1;const e=this._getFullNumber(),t=e.search(/\p{L}/u);if(t>-1){const i=e.substring(0,t),r=this._utilsIsValidNumber(i),n=this._utilsIsValidNumber(e);return r&&n}return this._utilsIsValidNumber(e)}_utilsIsValidNumber(e){return _.utils?_.utils.isValidNumber(e,this.selectedCountryData.iso2,this.options.validationNumberTypes):null}setCountry(e){const t=e?.toLowerCase(),i=this.selectedCountryData.iso2;(e&&t!==i||!e&&i)&&(this._setCountry(t),this._updateDialCode(this.selectedCountryData.dialCode),this._triggerCountryChange())}setNumber(e){const t=this._updateCountryFromNumber(e);this._updateValFromNumber(e),t&&this._triggerCountryChange(),this._trigger("input",{isSetNumber:!0})}setPlaceholderNumberType(e){this.options.placeholderNumberType=e,this._updatePlaceholder()}setDisabled(e){this.telInput.disabled=e,e?this.selectedCountry.setAttribute("disabled","true"):this.selectedCountry.removeAttribute("disabled")}},_=Object.assign((e,t)=>{const i=new y(e,t);return i._init(),e.setAttribute("data-intl-tel-input-id",i.id.toString()),_.instances[i.id]=i,i},{defaults:d,documentReady:()=>"complete"===document.readyState,getCountryData:()=>o,getInstance:e=>{const t=e.getAttribute("data-intl-tel-input-id");return t?_.instances[t]:null},instances:{},attachUtils:e=>{if(!_.utils&&!_.startedLoadingUtilsScript){let t;if("function"!=typeof e)return Promise.reject(new TypeError("The argument passed to attachUtils must be a function that returns a promise for the utilities module, not "+typeof e));try{t=Promise.resolve(e())}catch(e){return Promise.reject(e)}return _.startedLoadingUtilsScript=!0,t.then(e=>{const t=e?.default;if(!t||"object"!=typeof t)throw new TypeError("The loader function passed to attachUtils did not resolve to a module object with utils as its default export.");return _.utils=t,v("handleUtils"),!0}).catch(e=>{throw v("rejectUtilsScriptPromise",e),e})}return null},startedLoadingUtilsScript:!1,startedLoadingAutoCountry:!1,version:"25.3.1"}),S=_;return h=n,((n,s,a,o)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of i(s))r.call(n,l)||l===a||e(n,l,{get:()=>s[l],enumerable:!(o=t(s,l))||o.enumerable});return n})(e({},"__esModule",{value:!0}),h)})();return e.default},e.exports?e.exports=t():window.intlTelInput=t()},756:(e,t)=>{"use strict";var i=window,r=i.requestAnimationFrame||i.webkitRequestAnimationFrame||i.mozRequestAnimationFrame||i.msRequestAnimationFrame||function(e){return setTimeout(e,16)},n=window,s=n.cancelAnimationFrame||n.mozCancelAnimationFrame||function(e){clearTimeout(e)};function a(){for(var e,t,i,r=arguments[0]||{},n=1,s=arguments.length;n<s;n++)if(null!==(e=arguments[n]))for(t in e)r!==(i=e[t])&&void 0!==i&&(r[t]=i);return r}function o(e){return["true","false"].indexOf(e)>=0?JSON.parse(e):e}function l(e,t,i,r){if(r)try{e.setItem(t,i)}catch(e){}return i}function h(){var e=document,t=e.body;return t||((t=e.createElement("body")).fake=!0),t}var c=document.documentElement;function d(e){var t="";return e.fake&&(t=c.style.overflow,e.style.background="",e.style.overflow=c.style.overflow="hidden",c.appendChild(e)),t}function u(e,t){e.fake&&(e.remove(),c.style.overflow=t,c.offsetHeight)}function f(e,t,i,r){"insertRule"in e?e.insertRule(t+"{"+i+"}",r):e.addRule(t,i,r)}function p(e){return("insertRule"in e?e.cssRules:e.rules).length}function m(e,t,i){for(var r=0,n=e.length;r<n;r++)t.call(i,e[r],r)}var g="classList"in document.createElement("_"),v=g?function(e,t){return e.classList.contains(t)}:function(e,t){return e.className.indexOf(t)>=0},y=g?function(e,t){v(e,t)||e.classList.add(t)}:function(e,t){v(e,t)||(e.className+=" "+t)},_=g?function(e,t){v(e,t)&&e.classList.remove(t)}:function(e,t){v(e,t)&&(e.className=e.className.replace(t,""))};function S(e,t){return e.hasAttribute(t)}function b(e,t){return e.getAttribute(t)}function T(e){return void 0!==e.item}function x(e,t){if(e=T(e)||e instanceof Array?e:[e],"[object Object]"===Object.prototype.toString.call(t))for(var i=e.length;i--;)for(var r in t)e[i].setAttribute(r,t[r])}function E(e,t){e=T(e)||e instanceof Array?e:[e];for(var i=(t=t instanceof Array?t:[t]).length,r=e.length;r--;)for(var n=i;n--;)e[r].removeAttribute(t[n])}function M(e){for(var t=[],i=0,r=e.length;i<r;i++)t.push(e[i]);return t}function w(e,t){"none"!==e.style.display&&(e.style.display="none")}function A(e,t){"none"===e.style.display&&(e.style.display="")}function L(e){return"none"!==window.getComputedStyle(e).display}function C(e){if("string"==typeof e){var t=[e],i=e.charAt(0).toUpperCase()+e.substr(1);["Webkit","Moz","ms","O"].forEach(function(r){"ms"===r&&"transform"!==e||t.push(r+i)}),e=t}var r=document.createElement("fakeelement");e.length;for(var n=0;n<e.length;n++){var s=e[n];if(void 0!==r.style[s])return s}return!1}function R(e,t){var i=!1;return/^Webkit/.test(e)?i="webkit"+t+"End":/^O/.test(e)?i="o"+t+"End":e&&(i=t.toLowerCase()+"end"),i}var P=!1;try{var D=Object.defineProperty({},"passive",{get:function(){P=!0}});window.addEventListener("test",null,D)}catch(e){}var k=!!P&&{passive:!0};function O(e,t,i){for(var r in t){var n=["touchstart","touchmove"].indexOf(r)>=0&&!i&&k;e.addEventListener(r,t[r],n)}}function U(e,t){for(var i in t){var r=["touchstart","touchmove"].indexOf(i)>=0&&k;e.removeEventListener(i,t[i],r)}}function N(){return{topics:{},on:function(e,t){this.topics[e]=this.topics[e]||[],this.topics[e].push(t)},off:function(e,t){if(this.topics[e])for(var i=0;i<this.topics[e].length;i++)if(this.topics[e][i]===t){this.topics[e].splice(i,1);break}},emit:function(e,t){t.type=e,this.topics[e]&&this.topics[e].forEach(function(i){i(t,e)})}}}Object.keys||(Object.keys=function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.push(i);return t}),"remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)});var F=function(e){e=a({container:".slider",mode:"carousel",axis:"horizontal",items:1,gutter:0,edgePadding:0,fixedWidth:!1,autoWidth:!1,viewportMax:!1,slideBy:1,center:!1,controls:!0,controlsPosition:"top",controlsText:["prev","next"],controlsContainer:!1,prevButton:!1,nextButton:!1,nav:!0,navPosition:"top",navContainer:!1,navAsThumbnails:!1,arrowKeys:!1,speed:300,autoplay:!1,autoplayPosition:"top",autoplayTimeout:5e3,autoplayDirection:"forward",autoplayText:["start","stop"],autoplayHoverPause:!1,autoplayButton:!1,autoplayButtonOutput:!0,autoplayResetOnVisibility:!0,animateIn:"tns-fadeIn",animateOut:"tns-fadeOut",animateNormal:"tns-normal",animateDelay:!1,loop:!0,rewind:!1,autoHeight:!1,responsive:!1,lazyload:!1,lazyloadSelector:".tns-lazy-img",touch:!0,mouseDrag:!1,swipeAngle:15,nested:!1,preventActionWhenRunning:!1,preventScrollOnTouch:!1,freezable:!0,onInit:!1,useLocalStorage:!0,nonce:!1},e||{});var t=document,i=window,n={ENTER:13,SPACE:32,LEFT:37,RIGHT:39},c={},g=e.useLocalStorage;if(g){var T=navigator.userAgent,P=new Date;try{(c=i.localStorage)?(c.setItem(P,P),g=c.getItem(P)==P,c.removeItem(P)):g=!1,g||(c={})}catch(e){g=!1}g&&(c.tnsApp&&c.tnsApp!==T&&["tC","tPL","tMQ","tTf","t3D","tTDu","tTDe","tADu","tADe","tTE","tAE"].forEach(function(e){c.removeItem(e)}),localStorage.tnsApp=T)}var D=c.tC?o(c.tC):l(c,"tC",function(){var e=document,t=h(),i=d(t),r=e.createElement("div"),n=!1;t.appendChild(r);try{for(var s,a="(10px * 10)",o=["calc"+a,"-moz-calc"+a,"-webkit-calc"+a],l=0;l<3;l++)if(s=o[l],r.style.width=s,100===r.offsetWidth){n=s.replace(a,"");break}}catch(e){}return t.fake?u(t,i):r.remove(),n}(),g),k=c.tPL?o(c.tPL):l(c,"tPL",function(){var e,t=document,i=h(),r=d(i),n=t.createElement("div"),s=t.createElement("div"),a="";n.className="tns-t-subp2",s.className="tns-t-ct";for(var o=0;o<70;o++)a+="<div></div>";return s.innerHTML=a,n.appendChild(s),i.appendChild(n),e=Math.abs(n.getBoundingClientRect().left-s.children[67].getBoundingClientRect().left)<2,i.fake?u(i,r):n.remove(),e}(),g),B=c.tMQ?o(c.tMQ):l(c,"tMQ",function(){if(window.matchMedia||window.msMatchMedia)return!0;var e,t=document,i=h(),r=d(i),n=t.createElement("div"),s=t.createElement("style"),a="@media all and (min-width:1px){.tns-mq-test{position:absolute}}";return s.type="text/css",n.className="tns-mq-test",i.appendChild(s),i.appendChild(n),s.styleSheet?s.styleSheet.cssText=a:s.appendChild(t.createTextNode(a)),e=window.getComputedStyle?window.getComputedStyle(n).position:n.currentStyle.position,i.fake?u(i,r):n.remove(),"absolute"===e}(),g),V=c.tTf?o(c.tTf):l(c,"tTf",C("transform"),g),G=c.t3D?o(c.t3D):l(c,"t3D",function(e){if(!e)return!1;if(!window.getComputedStyle)return!1;var t,i=document,r=h(),n=d(r),s=i.createElement("p"),a=e.length>9?"-"+e.slice(0,-9).toLowerCase()+"-":"";return a+="transform",r.insertBefore(s,null),s.style[e]="translate3d(1px,1px,1px)",t=window.getComputedStyle(s).getPropertyValue(a),r.fake?u(r,n):s.remove(),void 0!==t&&t.length>0&&"none"!==t}(V),g),z=c.tTDu?o(c.tTDu):l(c,"tTDu",C("transitionDuration"),g),H=c.tTDe?o(c.tTDe):l(c,"tTDe",C("transitionDelay"),g),$=c.tADu?o(c.tADu):l(c,"tADu",C("animationDuration"),g),W=c.tADe?o(c.tADe):l(c,"tADe",C("animationDelay"),g),q=c.tTE?o(c.tTE):l(c,"tTE",R(z,"Transition"),g),j=c.tAE?o(c.tAE):l(c,"tAE",R($,"Animation"),g),K=i.console&&"function"==typeof i.console.warn,Y=["container","controlsContainer","prevButton","nextButton","navContainer","autoplayButton"],X={};if(Y.forEach(function(i){if("string"==typeof e[i]){var r=e[i],n=t.querySelector(r);if(X[i]=r,!n||!n.nodeName)return void(K&&console.warn("Can't find",e[i]));e[i]=n}}),!(e.container.children.length<1)){var Q=e.responsive,Z=e.nested,J="carousel"===e.mode;if(Q){0 in Q&&(e=a(e,Q[0]),delete Q[0]);var ee={};for(var te in Q){var ie=Q[te];ie="number"==typeof ie?{items:ie}:ie,ee[te]=ie}Q=ee,ee=null}if(J||function e(t){for(var i in t)J||("slideBy"===i&&(t[i]="page"),"edgePadding"===i&&(t[i]=!1),"autoHeight"===i&&(t[i]=!1)),"responsive"===i&&e(t[i])}(e),!J){e.axis="horizontal",e.slideBy="page",e.edgePadding=!1;var re=e.animateIn,ne=e.animateOut,se=e.animateDelay,ae=e.animateNormal}var oe,le,he="horizontal"===e.axis,ce=t.createElement("div"),de=t.createElement("div"),ue=e.container,fe=ue.parentNode,pe=ue.outerHTML,me=ue.children,ge=me.length,ve=ki(),ye=!1;Q&&tr(),J&&(ue.className+=" tns-vpfix");var _e,Se,be,Te,xe,Ee,Me=e.autoWidth,we=Bi("fixedWidth"),Ae=Bi("edgePadding"),Le=Bi("gutter"),Ce=Ni(),Re=Bi("center"),Pe=Me?1:Math.floor(Bi("items")),Ie=Bi("slideBy"),De=e.viewportMax||e.fixedWidthViewportWidth,ke=Bi("arrowKeys"),Oe=Bi("speed"),Ue=e.rewind,Ne=!Ue&&e.loop,Fe=Bi("autoHeight"),Be=Bi("controls"),Ve=Bi("controlsText"),Ge=Bi("nav"),ze=Bi("touch"),He=Bi("mouseDrag"),$e=Bi("autoplay"),We=Bi("autoplayTimeout"),qe=Bi("autoplayText"),je=Bi("autoplayHoverPause"),Ke=Bi("autoplayResetOnVisibility"),Ye=(Te=null,xe=Bi("nonce"),Ee=document.createElement("style"),Te&&Ee.setAttribute("media",Te),xe&&Ee.setAttribute("nonce",xe),document.querySelector("head").appendChild(Ee),Ee.sheet?Ee.sheet:Ee.styleSheet),Xe=e.lazyload,Qe=e.lazyloadSelector,Ze=[],Je=Ne?(Se=function(){if(Me||we&&!De)return ge-1;var t=we?"fixedWidth":"items",i=[];if((we||e[t]<ge)&&i.push(e[t]),Q)for(var r in Q){var n=Q[r][t];n&&(we||n<ge)&&i.push(n)}return i.length||i.push(0),Math.ceil(we?De/Math.min.apply(null,i):Math.max.apply(null,i))}(),be=J?Math.ceil((5*Se-ge)/2):4*Se-ge,be=Math.max(Se,be),Fi("edgePadding")?be+1:be):0,et=J?ge+2*Je:ge+Je,tt=!(!we&&!Me||Ne),it=we?Ar():null,rt=!J||!Ne,nt=he?"left":"top",st="",at="",ot=we?function(){return Re&&!Ne?ge-1:Math.ceil(-it/(we+Le))}:Me?function(){for(var e=0;e<et;e++)if(_e[e]>=-it)return e}:function(){return Re&&J&&!Ne?ge-1:Ne||J?Math.max(0,et-Math.ceil(Pe)):et-1},lt=Pi(Bi("startIndex")),ht=lt;Ri();var ct,dt,ut,ft=0,pt=Me?null:ot(),mt=e.preventActionWhenRunning,gt=e.swipeAngle,vt=!gt||"?",yt=!1,_t=e.onInit,St=new N,bt=" tns-slider tns-"+e.mode,Tt=ue.id||(ut=window.tnsId,window.tnsId=ut?ut+1:1,"tns"+window.tnsId),xt=Bi("disable"),Et=!1,Mt=e.freezable,wt=!(!Mt||Me)&&er(),At=!1,Lt={click:Ur,keydown:function(e){e=$r(e);var t=[n.LEFT,n.RIGHT].indexOf(e.keyCode);t>=0&&(0===t?Qt.disabled||Ur(e,-1):Zt.disabled||Ur(e,1))}},Ct={click:function(e){if(yt){if(mt)return;kr()}var t=Wr(e=$r(e));for(;t!==ii&&!S(t,"data-nav");)t=t.parentNode;if(S(t,"data-nav")){var i=ai=Number(b(t,"data-nav")),r=we||Me?i*ge/ni:i*Pe;Or(Ft?i:Math.min(Math.ceil(r),ge-1),e),oi===i&&(fi&&Gr(),ai=-1)}},keydown:function(e){e=$r(e);var i=t.activeElement;if(!S(i,"data-nav"))return;var r=[n.LEFT,n.RIGHT,n.ENTER,n.SPACE].indexOf(e.keyCode),s=Number(b(i,"data-nav"));r>=0&&(0===r?s>0&&Hr(ti[s-1]):1===r?s<ni-1&&Hr(ti[s+1]):(ai=s,Or(s,e)))}},Rt={mouseover:function(){fi&&(Fr(),pi=!0)},mouseout:function(){pi&&(Nr(),pi=!1)}},Pt={visibilitychange:function(){t.hidden?fi&&(Fr(),gi=!0):gi&&(Nr(),gi=!1)}},It={keydown:function(e){e=$r(e);var t=[n.LEFT,n.RIGHT].indexOf(e.keyCode);t>=0&&Ur(e,0===t?-1:1)}},Dt={touchstart:Yr,touchmove:Xr,touchend:Zr,touchcancel:Zr},kt={mousedown:Yr,mousemove:Xr,mouseup:Zr,mouseleave:Zr},Ot=Fi("controls"),Nt=Fi("nav"),Ft=!!Me||e.navAsThumbnails,Bt=Fi("autoplay"),Vt=Fi("touch"),Gt=Fi("mouseDrag"),zt="tns-slide-active",Ht="tns-slide-cloned",$t="tns-complete",Wt={load:function(e){cr(Wr(e))},error:function(e){t=Wr(e),y(t,"failed"),dr(t);var t}},qt="force"===e.preventScrollOnTouch;if(Ot)var jt,Kt,Yt=e.controlsContainer,Xt=e.controlsContainer?e.controlsContainer.outerHTML:"",Qt=e.prevButton,Zt=e.nextButton,Jt=e.prevButton?e.prevButton.outerHTML:"",ei=e.nextButton?e.nextButton.outerHTML:"";if(Nt)var ti,ii=e.navContainer,ri=e.navContainer?e.navContainer.outerHTML:"",ni=Me?ge:en(),si=0,ai=-1,oi=Di(),li=oi,hi="tns-nav-active",ci="Carousel Page ",di=" (Current Slide)";if(Bt)var ui,fi,pi,mi,gi,vi="forward"===e.autoplayDirection?1:-1,yi=e.autoplayButton,_i=e.autoplayButton?e.autoplayButton.outerHTML:"",Si=["<span class='tns-visually-hidden'>"," animation</span>"];if(Vt||Gt)var bi,Ti,xi={},Ei={},Mi=!1,wi=he?function(e,t){return e.x-t.x}:function(e,t){return e.y-t.y};Me||Ci(xt||wt),V&&(nt=V,st="translate",G?(st+=he?"3d(":"3d(0px, ",at=he?", 0px, 0px)":", 0px)"):(st+=he?"X(":"Y(",at=")")),J&&(ue.className=ue.className.replace("tns-vpfix","")),function(){Fi("gutter"),ce.className="tns-outer",de.className="tns-inner",ce.id=Tt+"-ow",de.id=Tt+"-iw",""===ue.id&&(ue.id=Tt);bt+=k||Me?" tns-subpixel":" tns-no-subpixel",bt+=D?" tns-calc":" tns-no-calc",Me&&(bt+=" tns-autowidth");bt+=" tns-"+e.axis,ue.className+=bt,J?((oe=t.createElement("div")).id=Tt+"-mw",oe.className="tns-ovh",ce.appendChild(oe),oe.appendChild(de)):ce.appendChild(de);if(Fe){(oe||de).className+=" tns-ah"}if(fe.insertBefore(ce,ue),de.appendChild(ue),m(me,function(e,t){y(e,"tns-item"),e.id||(e.id=Tt+"-item"+t),!J&&ae&&y(e,ae),x(e,{"aria-hidden":"true",tabindex:"-1"})}),Je){for(var i=t.createDocumentFragment(),r=t.createDocumentFragment(),n=Je;n--;){var s=n%ge,a=me[s].cloneNode(!0);if(y(a,Ht),E(a,"id"),r.insertBefore(a,r.firstChild),J){var o=me[ge-1-s].cloneNode(!0);y(o,Ht),E(o,"id"),i.appendChild(o)}}ue.insertBefore(i,ue.firstChild),ue.appendChild(r),me=ue.children}}(),function(){if(!J)for(var t=lt,r=lt+Math.min(ge,Pe);t<r;t++){var n=me[t];n.style.left=100*(t-lt)/Pe+"%",y(n,re),_(n,ae)}he&&(k||Me?(f(Ye,"#"+Tt+" > .tns-item","font-size:"+i.getComputedStyle(me[0]).fontSize+";",p(Ye)),f(Ye,"#"+Tt,"font-size:0;",p(Ye))):J&&m(me,function(e,t){e.style.marginLeft=function(e){return D?D+"("+100*e+"% / "+et+")":100*e/et+"%"}(t)}));if(B){if(z){var s=oe&&e.autoHeight?Wi(e.speed):"";f(Ye,"#"+Tt+"-mw",s,p(Ye))}s=Vi(e.edgePadding,e.gutter,e.fixedWidth,e.speed,e.autoHeight),f(Ye,"#"+Tt+"-iw",s,p(Ye)),J&&(s=he&&!Me?"width:"+Gi(e.fixedWidth,e.gutter,e.items)+";":"",z&&(s+=Wi(Oe)),f(Ye,"#"+Tt,s,p(Ye))),s=he&&!Me?zi(e.fixedWidth,e.gutter,e.items):"",e.gutter&&(s+=Hi(e.gutter)),J||(z&&(s+=Wi(Oe)),$&&(s+=qi(Oe))),s&&f(Ye,"#"+Tt+" > .tns-item",s,p(Ye))}else{J&&Fe&&(oe.style[z]=Oe/1e3+"s"),de.style.cssText=Vi(Ae,Le,we,Fe),J&&he&&!Me&&(ue.style.width=Gi(we,Le,Pe));s=he&&!Me?zi(we,Le,Pe):"";Le&&(s+=Hi(Le)),s&&f(Ye,"#"+Tt+" > .tns-item",s,p(Ye))}if(Q&&B)for(var a in Q){a=parseInt(a);var o=Q[a],l=(s="",""),h="",c="",d="",u=Me?null:Bi("items",a),g=Bi("fixedWidth",a),v=Bi("speed",a),S=Bi("edgePadding",a),b=Bi("autoHeight",a),T=Bi("gutter",a);z&&oe&&Bi("autoHeight",a)&&"speed"in o&&(l="#"+Tt+"-mw{"+Wi(v)+"}"),("edgePadding"in o||"gutter"in o)&&(h="#"+Tt+"-iw{"+Vi(S,T,g,v,b)+"}"),J&&he&&!Me&&("fixedWidth"in o||"items"in o||we&&"gutter"in o)&&(c="width:"+Gi(g,T,u)+";"),z&&"speed"in o&&(c+=Wi(v)),c&&(c="#"+Tt+"{"+c+"}"),("fixedWidth"in o||we&&"gutter"in o||!J&&"items"in o)&&(d+=zi(g,T,u)),"gutter"in o&&(d+=Hi(T)),!J&&"speed"in o&&(z&&(d+=Wi(v)),$&&(d+=qi(v))),d&&(d="#"+Tt+" > .tns-item{"+d+"}"),(s=l+h+c+d)&&Ye.insertRule("@media (min-width: "+a/16+"em) {"+s+"}",Ye.cssRules.length)}}(),ji();var Ai=Ne?J?function(){var e=ft,t=pt;e+=Ie,t-=Ie,Ae?(e+=1,t-=1):we&&(Ce+Le)%(we+Le)&&(t-=1),Je&&(lt>t?lt-=ge:lt<e&&(lt+=ge))}:function(){if(lt>pt)for(;lt>=ft+ge;)lt-=ge;else if(lt<ft)for(;lt<=pt-ge;)lt+=ge}:function(){lt=Math.max(ft,Math.min(pt,lt))},Li=J?function(){var e,t,i,r,n,s,a,o,l,h,c;Mr(ue,""),z||!Oe?(Rr(),Oe&&L(ue)||kr()):(e=ue,t=nt,i=st,r=at,n=Lr(),s=Oe,a=kr,o=Math.min(s,10),l=n.indexOf("%")>=0?"%":"px",n=n.replace(l,""),h=Number(e.style[t].replace(i,"").replace(r,"").replace(l,"")),c=(n-h)/s*o,setTimeout(function n(){s-=o,h+=c,e.style[t]=i+h+l+r,s>0?setTimeout(n,o):a()},o)),he||Jr()}:function(){Ze=[];var e={};e[q]=e[j]=kr,U(me[ht],e),O(me[lt],e),Pr(ht,re,ne,!0),Pr(lt,ae,re),q&&j&&Oe&&L(ue)||kr()};return{version:"2.9.4",getInfo:rn,events:St,goTo:Or,play:function(){$e&&!fi&&(Vr(),mi=!1)},pause:function(){fi&&(Gr(),mi=!0)},isOn:ye,updateSliderHeight:vr,refresh:ji,destroy:function(){if(Ye.disabled=!0,Ye.ownerNode&&Ye.ownerNode.remove(),U(i,{resize:Zi}),ke&&U(t,It),Yt&&U(Yt,Lt),ii&&U(ii,Ct),U(ue,Rt),U(ue,Pt),yi&&U(yi,{click:zr}),$e&&clearInterval(ui),J&&q){var r={};r[q]=kr,U(ue,r)}ze&&U(ue,Dt),He&&U(ue,kt);var n=[pe,Xt,Jt,ei,ri,_i];for(var s in Y.forEach(function(t,i){var r="container"===t?ce:e[t];if("object"==typeof r&&r){var s=!!r.previousElementSibling&&r.previousElementSibling,a=r.parentNode;r.outerHTML=n[i],e[t]=s?s.nextElementSibling:a.firstElementChild}}),Y=re=ne=se=ae=he=ce=de=ue=fe=pe=me=ge=le=ve=Me=we=Ae=Le=Ce=Pe=Ie=De=ke=Oe=Ue=Ne=Fe=Ye=Xe=_e=Ze=Je=et=tt=it=rt=nt=st=at=ot=lt=ht=ft=pt=gt=vt=yt=_t=St=bt=Tt=xt=Et=Mt=wt=At=Lt=Ct=Rt=Pt=It=Dt=kt=Ot=Nt=Ft=Bt=Vt=Gt=zt=$t=Wt=ct=Be=Ve=Yt=Xt=Qt=Zt=jt=Kt=Ge=ii=ri=ti=ni=si=ai=oi=li=hi=ci=di=$e=We=vi=qe=je=yi=_i=Ke=Si=ui=fi=pi=mi=gi=xi=Ei=bi=Mi=Ti=wi=ze=He=null,this)"rebuild"!==s&&(this[s]=null);ye=!1},rebuild:function(){return F(a(e,X))}}}function Ci(e){e&&(Be=Ge=ze=He=ke=$e=je=Ke=!1)}function Ri(){for(var e=J?lt-Je:lt;e<0;)e+=ge;return e%ge+1}function Pi(e){return e=e?Math.max(0,Math.min(Ne?ge-1:ge-Pe,e)):0,J?e+Je:e}function Ii(e){for(null==e&&(e=lt),J&&(e-=Je);e<0;)e+=ge;return Math.floor(e%ge)}function Di(){var e,t=Ii();return e=Ft?t:we||Me?Math.ceil((t+1)*ni/ge-1):Math.floor(t/Pe),!Ne&&J&&lt===pt&&(e=ni-1),e}function ki(){return i.innerWidth||t.documentElement.clientWidth||t.body.clientWidth}function Oi(e){return"top"===e?"afterbegin":"beforeend"}function Ui(e){if(null!=e){var i,r,n=t.createElement("div");return e.appendChild(n),r=(i=n.getBoundingClientRect()).right-i.left,n.remove(),r||Ui(e.parentNode)}}function Ni(){var e=Ae?2*Ae-Le:0;return Ui(fe)-e}function Fi(t){if(e[t])return!0;if(Q)for(var i in Q)if(Q[i][t])return!0;return!1}function Bi(t,i){if(null==i&&(i=ve),"items"===t&&we)return Math.floor((Ce+Le)/(we+Le))||1;var r=e[t];if(Q)for(var n in Q)i>=parseInt(n)&&t in Q[n]&&(r=Q[n][t]);return"slideBy"===t&&"page"===r&&(r=Bi("items")),J||"slideBy"!==t&&"items"!==t||(r=Math.floor(r)),r}function Vi(e,t,i,r,n){var s="";if(void 0!==e){var a=e;t&&(a-=t),s=he?"margin: 0 "+a+"px 0 "+e+"px;":"margin: "+e+"px 0 "+a+"px 0;"}else if(t&&!i){var o="-"+t+"px";s="margin: 0 "+(he?o+" 0 0":"0 "+o+" 0")+";"}return!J&&n&&z&&r&&(s+=Wi(r)),s}function Gi(e,t,i){return e?(e+t)*et+"px":D?D+"("+100*et+"% / "+i+")":100*et/i+"%"}function zi(e,t,i){var r;if(e)r=e+t+"px";else{J||(i=Math.floor(i));var n=J?et:i;r=D?D+"(100% / "+n+")":100/n+"%"}return r="width:"+r,"inner"!==Z?r+";":r+" !important;"}function Hi(e){var t="";!1!==e&&(t=(he?"padding-":"margin-")+(he?"right":"bottom")+": "+e+"px;");return t}function $i(e,t){var i=e.substring(0,e.length-t).toLowerCase();return i&&(i="-"+i+"-"),i}function Wi(e){return $i(z,18)+"transition-duration:"+e/1e3+"s;"}function qi(e){return $i($,17)+"animation-duration:"+e/1e3+"s;"}function ji(){if(Fi("autoHeight")||Me||!he){var e=ue.querySelectorAll("img");m(e,function(e){var t=e.src;Xe||(t&&t.indexOf("data:image")<0?(e.src="",O(e,Wt),y(e,"loading"),e.src=t):cr(e))}),r(function(){pr(M(e),function(){ct=!0})}),Fi("autoHeight")&&(e=ur(lt,Math.min(lt+Pe-1,et-1))),Xe?Ki():r(function(){pr(M(e),Ki)})}else J&&Cr(),Xi(),Qi()}function Ki(){if(Me&&ge>1){var e=Ne?lt:ge-1;!function t(){var i=me[e].getBoundingClientRect().left,r=me[e-1].getBoundingClientRect().right;Math.abs(i-r)<=1?Yi():setTimeout(function(){t()},16)}()}else Yi()}function Yi(){he&&!Me||(yr(),Me?(it=Ar(),Mt&&(wt=er()),pt=ot(),Ci(xt||wt)):Jr()),J&&Cr(),Xi(),Qi()}function Xi(){if(_r(),ce.insertAdjacentHTML("afterbegin",'<div class="tns-liveregion tns-visually-hidden" aria-live="polite" aria-atomic="true">slide <span class="current">'+or()+"</span>  of "+ge+"</div>"),dt=ce.querySelector(".tns-liveregion .current"),Bt){var t=$e?"stop":"start";yi?x(yi,{"data-action":t}):e.autoplayButtonOutput&&(ce.insertAdjacentHTML(Oi(e.autoplayPosition),'<button type="button" data-action="'+t+'">'+Si[0]+t+Si[1]+qe[0]+"</button>"),yi=ce.querySelector("[data-action]")),yi&&O(yi,{click:zr}),$e&&(Vr(),je&&O(ue,Rt),Ke&&O(ue,Pt))}if(Nt){if(ii)x(ii,{"aria-label":"Carousel Pagination"}),m(ti=ii.children,function(e,t){x(e,{"data-nav":t,tabindex:"-1","aria-label":ci+(t+1),"aria-controls":Tt})});else{for(var i="",r=Ft?"":'style="display:none"',n=0;n<ge;n++)i+='<button type="button" data-nav="'+n+'" tabindex="-1" aria-controls="'+Tt+'" '+r+' aria-label="'+ci+(n+1)+'"></button>';i='<div class="tns-nav" aria-label="Carousel Pagination">'+i+"</div>",ce.insertAdjacentHTML(Oi(e.navPosition),i),ii=ce.querySelector(".tns-nav"),ti=ii.children}if(tn(),z){var s=z.substring(0,z.length-18).toLowerCase(),a="transition: all "+Oe/1e3+"s";s&&(a="-"+s+"-"+a),f(Ye,"[aria-controls^="+Tt+"-item]",a,p(Ye))}x(ti[oi],{"aria-label":ci+(oi+1)+di}),E(ti[oi],"tabindex"),y(ti[oi],hi),O(ii,Ct)}Ot&&(Yt||Qt&&Zt||(ce.insertAdjacentHTML(Oi(e.controlsPosition),'<div class="tns-controls" aria-label="Carousel Navigation" tabindex="0"><button type="button" data-controls="prev" tabindex="-1" aria-controls="'+Tt+'">'+Ve[0]+'</button><button type="button" data-controls="next" tabindex="-1" aria-controls="'+Tt+'">'+Ve[1]+"</button></div>"),Yt=ce.querySelector(".tns-controls")),Qt&&Zt||(Qt=Yt.children[0],Zt=Yt.children[1]),e.controlsContainer&&x(Yt,{"aria-label":"Carousel Navigation",tabindex:"0"}),(e.controlsContainer||e.prevButton&&e.nextButton)&&x([Qt,Zt],{"aria-controls":Tt,tabindex:"-1"}),(e.controlsContainer||e.prevButton&&e.nextButton)&&(x(Qt,{"data-controls":"prev"}),x(Zt,{"data-controls":"next"})),jt=br(Qt),Kt=br(Zt),Er(),Yt?O(Yt,Lt):(O(Qt,Lt),O(Zt,Lt))),ir()}function Qi(){if(J&&q){var r={};r[q]=kr,O(ue,r)}ze&&O(ue,Dt,e.preventScrollOnTouch),He&&O(ue,kt),ke&&O(t,It),"inner"===Z?St.on("outerResized",function(){Ji(),St.emit("innerLoaded",rn())}):(Q||we||Me||Fe||!he)&&O(i,{resize:Zi}),Fe&&("outer"===Z?St.on("innerLoaded",fr):xt||fr()),hr(),xt?sr():wt&&nr(),St.on("indexChanged",mr),"inner"===Z&&St.emit("innerLoaded",rn()),"function"==typeof _t&&_t(rn()),ye=!0}function Zi(e){r(function(){Ji($r(e))})}function Ji(i){if(ye){"outer"===Z&&St.emit("outerResized",rn(i)),ve=ki();var r,n=le,s=!1;Q&&(tr(),(r=n!==le)&&St.emit("newBreakpointStart",rn(i)));var a,o,l=Pe,h=xt,c=wt,d=ke,u=Be,g=Ge,v=ze,S=He,b=$e,T=je,x=Ke,E=lt;if(r){var M=we,L=Fe,C=Ve,R=Re,P=qe;if(!B)var D=Le,k=Ae}if(ke=Bi("arrowKeys"),Be=Bi("controls"),Ge=Bi("nav"),ze=Bi("touch"),Re=Bi("center"),He=Bi("mouseDrag"),$e=Bi("autoplay"),je=Bi("autoplayHoverPause"),Ke=Bi("autoplayResetOnVisibility"),r&&(xt=Bi("disable"),we=Bi("fixedWidth"),Oe=Bi("speed"),Fe=Bi("autoHeight"),Ve=Bi("controlsText"),qe=Bi("autoplayText"),We=Bi("autoplayTimeout"),B||(Ae=Bi("edgePadding"),Le=Bi("gutter"))),Ci(xt),Ce=Ni(),he&&!Me||xt||(yr(),he||(Jr(),s=!0)),(we||Me)&&(it=Ar(),pt=ot()),(r||we)&&(Pe=Bi("items"),Ie=Bi("slideBy"),(o=Pe!==l)&&(we||Me||(pt=ot()),Ai())),r&&xt!==h&&(xt?sr():function(){if(!Et)return;if(Ye.disabled=!1,ue.className+=bt,Cr(),Ne)for(var e=Je;e--;)J&&A(me[e]),A(me[et-e-1]);if(!J)for(var t=lt,i=lt+ge;t<i;t++){var r=me[t],n=t<lt+Pe?re:ae;r.style.left=100*(t-lt)/Pe+"%",y(r,n)}rr(),Et=!1}()),Mt&&(r||we||Me)&&(wt=er())!==c&&(wt?(Rr(Lr(Pi(0))),nr()):(!function(){if(!At)return;Ae&&B&&(de.style.margin="");if(Je)for(var e="tns-transparent",t=Je;t--;)J&&_(me[t],e),_(me[et-t-1],e);rr(),At=!1}(),s=!0)),Ci(xt||wt),$e||(je=Ke=!1),ke!==d&&(ke?O(t,It):U(t,It)),Be!==u&&(Be?Yt?A(Yt):(Qt&&A(Qt),Zt&&A(Zt)):Yt?w(Yt):(Qt&&w(Qt),Zt&&w(Zt))),Ge!==g&&(Ge?(A(ii),tn()):w(ii)),ze!==v&&(ze?O(ue,Dt,e.preventScrollOnTouch):U(ue,Dt)),He!==S&&(He?O(ue,kt):U(ue,kt)),$e!==b&&($e?(yi&&A(yi),fi||mi||Vr()):(yi&&w(yi),fi&&Gr())),je!==T&&(je?O(ue,Rt):U(ue,Rt)),Ke!==x&&(Ke?O(t,Pt):U(t,Pt)),r){if(we===M&&Re===R||(s=!0),Fe!==L&&(Fe||(de.style.height="")),Be&&Ve!==C&&(Qt.innerHTML=Ve[0],Zt.innerHTML=Ve[1]),yi&&qe!==P){var N=$e?1:0,F=yi.innerHTML,V=F.length-P[N].length;F.substring(V)===P[N]&&(yi.innerHTML=F.substring(0,V)+qe[N])}}else Re&&(we||Me)&&(s=!0);if((o||we&&!Me)&&(ni=en(),tn()),(a=lt!==E)?(St.emit("indexChanged",rn()),s=!0):o?a||mr():(we||Me)&&(hr(),_r(),ar()),o&&!J&&function(){for(var e=lt+Math.min(ge,Pe),t=et;t--;){var i=me[t];t>=lt&&t<e?(y(i,"tns-moving"),i.style.left=100*(t-lt)/Pe+"%",y(i,re),_(i,ae)):i.style.left&&(i.style.left="",y(i,ae),_(i,re)),_(i,ne)}setTimeout(function(){m(me,function(e){_(e,"tns-moving")})},300)}(),!xt&&!wt){if(r&&!B&&(Ae===k&&Le===D||(de.style.cssText=Vi(Ae,Le,we,Oe,Fe)),he)){J&&(ue.style.width=Gi(we,Le,Pe));var G=zi(we,Le,Pe)+Hi(Le);!function(e,t){"deleteRule"in e?e.deleteRule(t):e.removeRule(t)}(Ye,p(Ye)-1),f(Ye,"#"+Tt+" > .tns-item",G,p(Ye))}Fe&&fr(),s&&(Cr(),ht=lt)}r&&St.emit("newBreakpointEnd",rn(i))}}function er(){if(!we&&!Me)return ge<=(Re?Pe-(Pe-1)/2:Pe);var e=we?(we+Le)*ge:_e[ge],t=Ae?Ce+2*Ae:Ce+Le;return Re&&(t-=we?(Ce-we)/2:(Ce-(_e[lt+1]-_e[lt]-Le))/2),e<=t}function tr(){for(var e in le=0,Q)e=parseInt(e),ve>=e&&(le=e)}function ir(){!$e&&yi&&w(yi),!Ge&&ii&&w(ii),Be||(Yt?w(Yt):(Qt&&w(Qt),Zt&&w(Zt)))}function rr(){$e&&yi&&A(yi),Ge&&ii&&A(ii),Be&&(Yt?A(Yt):(Qt&&A(Qt),Zt&&A(Zt)))}function nr(){if(!At){if(Ae&&(de.style.margin="0px"),Je)for(var e="tns-transparent",t=Je;t--;)J&&y(me[t],e),y(me[et-t-1],e);ir(),At=!0}}function sr(){if(!Et){if(Ye.disabled=!0,ue.className=ue.className.replace(bt.substring(1),""),E(ue,["style"]),Ne)for(var e=Je;e--;)J&&w(me[e]),w(me[et-e-1]);if(he&&J||E(de,["style"]),!J)for(var t=lt,i=lt+ge;t<i;t++){var r=me[t];E(r,["style"]),_(r,re),_(r,ae)}ir(),Et=!0}}function ar(){var e=or();dt.innerHTML!==e&&(dt.innerHTML=e)}function or(){var e=lr(),t=e[0]+1,i=e[1]+1;return t===i?t+"":t+" to "+i}function lr(e){null==e&&(e=Lr());var t,i,r,n=lt;if(Re||Ae?(Me||we)&&(i=-(parseFloat(e)+Ae),r=i+Ce+2*Ae):Me&&(i=_e[lt],r=i+Ce),Me)_e.forEach(function(e,s){s<et&&((Re||Ae)&&e<=i+.5&&(n=s),r-e>=.5&&(t=s))});else{if(we){var s=we+Le;Re||Ae?(n=Math.floor(i/s),t=Math.ceil(r/s-1)):t=n+Math.ceil(Ce/s)-1}else if(Re||Ae){var a=Pe-1;if(Re?(n-=a/2,t=lt+a/2):t=lt+a,Ae){var o=Ae*Pe/Ce;n-=o,t+=o}n=Math.floor(n),t=Math.ceil(t)}else t=n+Pe-1;n=Math.max(n,0),t=Math.min(t,et-1)}return[n,t]}function hr(){if(Xe&&!xt){var e=lr();e.push(Qe),ur.apply(null,e).forEach(function(e){if(!v(e,$t)){var t={};t[q]=function(e){e.stopPropagation()},O(e,t),O(e,Wt),e.src=b(e,"data-src");var i=b(e,"data-srcset");i&&(e.srcset=i),y(e,"loading")}})}}function cr(e){y(e,"loaded"),dr(e)}function dr(e){y(e,$t),_(e,"loading"),U(e,Wt)}function ur(e,t,i){var r=[];for(i||(i="img");e<=t;)m(me[e].querySelectorAll(i),function(e){r.push(e)}),e++;return r}function fr(){var e=ur.apply(null,lr());r(function(){pr(e,vr)})}function pr(e,t){return ct?t():(e.forEach(function(t,i){!Xe&&t.complete&&dr(t),v(t,$t)&&e.splice(i,1)}),e.length?void r(function(){pr(e,t)}):t())}function mr(){hr(),_r(),ar(),Er(),function(){if(Ge&&(oi=ai>=0?ai:Di(),ai=-1,oi!==li)){var e=ti[li],t=ti[oi];x(e,{tabindex:"-1","aria-label":ci+(li+1)}),_(e,hi),x(t,{"aria-label":ci+(oi+1)+di}),E(t,"tabindex"),y(t,hi),li=oi}}()}function gr(e,t){for(var i=[],r=e,n=Math.min(e+t,et);r<n;r++)i.push(me[r].offsetHeight);return Math.max.apply(null,i)}function vr(){var e=Fe?gr(lt,Pe):gr(Je,ge),t=oe||de;t.style.height!==e&&(t.style.height=e+"px")}function yr(){_e=[0];var e=he?"left":"top",t=he?"right":"bottom",i=me[0].getBoundingClientRect()[e];m(me,function(r,n){n&&_e.push(r.getBoundingClientRect()[e]-i),n===et-1&&_e.push(r.getBoundingClientRect()[t]-i)})}function _r(){var e=lr(),t=e[0],i=e[1];m(me,function(e,r){r>=t&&r<=i?S(e,"aria-hidden")&&(E(e,["aria-hidden","tabindex"]),y(e,zt)):S(e,"aria-hidden")||(x(e,{"aria-hidden":"true",tabindex:"-1"}),_(e,zt))})}function Sr(e){return e.nodeName.toLowerCase()}function br(e){return"button"===Sr(e)}function Tr(e){return"true"===e.getAttribute("aria-disabled")}function xr(e,t,i){e?t.disabled=i:t.setAttribute("aria-disabled",i.toString())}function Er(){if(Be&&!Ue&&!Ne){var e=jt?Qt.disabled:Tr(Qt),t=Kt?Zt.disabled:Tr(Zt),i=lt<=ft,r=!Ue&&lt>=pt;i&&!e&&xr(jt,Qt,!0),!i&&e&&xr(jt,Qt,!1),r&&!t&&xr(Kt,Zt,!0),!r&&t&&xr(Kt,Zt,!1)}}function Mr(e,t){z&&(e.style[z]=t)}function wr(e){return null==e&&(e=lt),Me?(Ce-(Ae?Le:0)-(_e[e+1]-_e[e]-Le))/2:we?(Ce-we)/2:(Pe-1)/2}function Ar(){var e=Ce+(Ae?Le:0)-(we?(we+Le)*et:_e[et]);return Re&&!Ne&&(e=we?-(we+Le)*(et-1)-wr():wr(et-1)-_e[et-1]),e>0&&(e=0),e}function Lr(e){var t;if(null==e&&(e=lt),he&&!Me)if(we)t=-(we+Le)*e,Re&&(t+=wr());else{var i=V?et:Pe;Re&&(e-=wr()),t=100*-e/i}else t=-_e[e],Re&&Me&&(t+=wr());return tt&&(t=Math.max(t,it)),t+=!he||Me||we?"px":"%"}function Cr(e){Mr(ue,"0s"),Rr(e)}function Rr(e){null==e&&(e=Lr()),ue.style[nt]=st+e+at}function Pr(e,t,i,r){var n=e+Pe;Ne||(n=Math.min(n,et));for(var s=e;s<n;s++){var a=me[s];r||(a.style.left=100*(s-lt)/Pe+"%"),se&&H&&(a.style[H]=a.style[W]=se*(s-e)/1e3+"s"),_(a,t),y(a,i),r&&Ze.push(a)}}function Ir(e,t){rt&&Ai(),(lt!==ht||t)&&(St.emit("indexChanged",rn()),St.emit("transitionStart",rn()),Fe&&fr(),fi&&e&&["click","keydown"].indexOf(e.type)>=0&&Gr(),yt=!0,Li())}function Dr(e){return e.toLowerCase().replace(/-/g,"")}function kr(e){if(J||yt){if(St.emit("transitionEnd",rn(e)),!J&&Ze.length>0)for(var t=0;t<Ze.length;t++){var i=Ze[t];i.style.left="",W&&H&&(i.style[W]="",i.style[H]=""),_(i,ne),y(i,ae)}if(!e||!J&&e.target.parentNode===ue||e.target===ue&&Dr(e.propertyName)===Dr(nt)){if(!rt){var r=lt;Ai(),lt!==r&&(St.emit("indexChanged",rn()),Cr())}"inner"===Z&&St.emit("innerLoaded",rn()),yt=!1,ht=lt}}}function Or(e,t){if(!wt)if("prev"===e)Ur(t,-1);else if("next"===e)Ur(t,1);else{if(yt){if(mt)return;kr()}var i=Ii(),r=0;if("first"===e?r=-i:"last"===e?r=J?ge-Pe-i:ge-1-i:("number"!=typeof e&&(e=parseInt(e)),isNaN(e)||(t||(e=Math.max(0,Math.min(ge-1,e))),r=e-i)),!J&&r&&Math.abs(r)<Pe){var n=r>0?1:-1;r+=lt+r-ge>=ft?ge*n:2*ge*n*-1}lt+=r,J&&Ne&&(lt<ft&&(lt+=ge),lt>pt&&(lt-=ge)),Ii(lt)!==Ii(ht)&&Ir(t)}}function Ur(e,t){if(yt){if(mt)return;kr()}var i;if(!t){for(var r=Wr(e=$r(e));r!==Yt&&[Qt,Zt].indexOf(r)<0;)r=r.parentNode;var n=[Qt,Zt].indexOf(r);n>=0&&(i=!0,t=0===n?-1:1)}if(Ue){if(lt===ft&&-1===t)return void Or("last",e);if(lt===pt&&1===t)return void Or("first",e)}t&&(lt+=Ie*t,Me&&(lt=Math.floor(lt)),Ir(i||e&&"keydown"===e.type?e:null))}function Nr(){ui=setInterval(function(){Ur(null,vi)},We),fi=!0}function Fr(){clearInterval(ui),fi=!1}function Br(e,t){x(yi,{"data-action":e}),yi.innerHTML=Si[0]+e+Si[1]+t}function Vr(){Nr(),yi&&Br("stop",qe[1])}function Gr(){Fr(),yi&&Br("start",qe[0])}function zr(){fi?(Gr(),mi=!0):(Vr(),mi=!1)}function Hr(e){e.focus()}function $r(e){return qr(e=e||i.event)?e.changedTouches[0]:e}function Wr(e){return e.target||i.event.srcElement}function qr(e){return e.type.indexOf("touch")>=0}function jr(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function Kr(){return s=Ei.y-xi.y,a=Ei.x-xi.x,t=Math.atan2(s,a)*(180/Math.PI),i=gt,r=!1,(n=Math.abs(90-Math.abs(t)))>=90-i?r="horizontal":n<=i&&(r="vertical"),r===e.axis;var t,i,r,n,s,a}function Yr(e){if(yt){if(mt)return;kr()}$e&&fi&&Fr(),Mi=!0,Ti&&(s(Ti),Ti=null);var t=$r(e);St.emit(qr(e)?"touchStart":"dragStart",rn(e)),!qr(e)&&["img","a"].indexOf(Sr(Wr(e)))>=0&&jr(e),Ei.x=xi.x=t.clientX,Ei.y=xi.y=t.clientY,J&&(bi=parseFloat(ue.style[nt].replace(st,"")),Mr(ue,"0s"))}function Xr(e){if(Mi){var t=$r(e);Ei.x=t.clientX,Ei.y=t.clientY,J?Ti||(Ti=r(function(){Qr(e)})):("?"===vt&&(vt=Kr()),vt&&(qt=!0)),("boolean"!=typeof e.cancelable||e.cancelable)&&qt&&e.preventDefault()}}function Qr(e){if(vt){if(s(Ti),Mi&&(Ti=r(function(){Qr(e)})),"?"===vt&&(vt=Kr()),vt){!qt&&qr(e)&&(qt=!0);try{e.type&&St.emit(qr(e)?"touchMove":"dragMove",rn(e))}catch(e){}var t=bi,i=wi(Ei,xi);if(!he||we||Me)t+=i,t+="px";else t+=V?i*Pe*100/((Ce+Le)*et):100*i/(Ce+Le),t+="%";ue.style[nt]=st+t+at}}else Mi=!1}function Zr(t){if(Mi){Ti&&(s(Ti),Ti=null),J&&Mr(ue,""),Mi=!1;var i=$r(t);Ei.x=i.clientX,Ei.y=i.clientY;var n=wi(Ei,xi);if(Math.abs(n)){if(!qr(t)){var a=Wr(t);O(a,{click:function e(t){jr(t),U(a,{click:e})}})}J?Ti=r(function(){if(he&&!Me){var e=-n*Pe/(Ce+Le);e=n>0?Math.floor(e):Math.ceil(e),lt+=e}else{var i=-(bi+n);if(i<=0)lt=ft;else if(i>=_e[et-1])lt=pt;else for(var r=0;r<et&&i>=_e[r];)lt=r,i>_e[r]&&n<0&&(lt+=1),r++}Ir(t,n),St.emit(qr(t)?"touchEnd":"dragEnd",rn(t))}):vt&&Ur(t,n>0?-1:1)}}"auto"===e.preventScrollOnTouch&&(qt=!1),gt&&(vt="?"),$e&&!fi&&Nr()}function Jr(){(oe||de).style.height=_e[lt+Pe]-_e[lt]+"px"}function en(){var e=we?(we+Le)*ge/Ce:ge/Pe;return Math.min(Math.ceil(e),ge)}function tn(){if(Ge&&!Ft&&ni!==si){var e=si,t=ni,i=A;for(si>ni&&(e=ni,t=si,i=w);e<t;)i(ti[e]),e++;si=ni}}function rn(e){return{container:ue,slideItems:me,navContainer:ii,navItems:ti,controlsContainer:Yt,hasControls:Ot,prevButton:Qt,nextButton:Zt,items:Pe,slideBy:Ie,cloneCount:Je,slideCount:ge,slideCountNew:et,index:lt,indexCached:ht,displayIndex:Ri(),navCurrentIndex:oi,navCurrentIndexCached:li,pages:ni,pagesCached:si,sheet:Ye,isOn:ye,event:e||{}}}K&&console.warn("No slides found in",e.container)};t.U=F}},i={};function r(e){var n=i[e];if(void 0!==n)return n.exports;var s=i[e]={exports:{}};return t[e](s,s.exports,r),s.exports}r.m=t,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce((t,i)=>(r.f[i](e,t),t),[])),r.u=e=>e+".build.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},r.l=(t,i,n,s)=>{if(e[t])e[t].push(i);else{var a,o;if(void 0!==n)for(var l=document.getElementsByTagName("script"),h=0;h<l.length;h++){var c=l[h];if(c.getAttribute("src")==t){a=c;break}}a||(o=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.src=t),e[t]=[i];var d=(i,r)=>{a.onerror=a.onload=null,clearTimeout(u);var n=e[t];if(delete e[t],a.parentNode&&a.parentNode.removeChild(a),n&&n.forEach(e=>e(r)),i)return i(r)},u=setTimeout(d.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=d.bind(null,a.onerror),a.onload=d.bind(null,a.onload),o&&document.head.appendChild(a)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=i[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={792:0};r.f.j=(t,i)=>{var n=r.o(e,t)?e[t]:void 0;if(0!==n)if(n)i.push(n[2]);else{var s=new Promise((i,r)=>n=e[t]=[i,r]);i.push(n[2]=s);var a=r.p+r.u(t),o=new Error;r.l(a,i=>{if(r.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var s=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+s+": "+a+")",o.name="ChunkLoadError",o.type=s,o.request=a,n[1](o)}},"chunk-"+t,t)}};var t=(t,i)=>{var n,s,[a,o,l]=i,h=0;if(a.some(t=>0!==e[t])){for(n in o)r.o(o,n)&&(r.m[n]=o[n]);if(l)l(r)}for(t&&t(i);h<a.length;h++)s=a[h],r.o(e,s)&&e[s]&&e[s][0](),e[s]=0},i=self.webpackChunk=self.webpackChunk||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),(()=>{"use strict";class App{constructor(e){this.main=e,this.Views=[]}addView(e){this.Views[e.name]=e}addViews(...e){for(let t in e)this.Views[e[t].name]=e[t]}static getView(e){return null===e?null:("object"==typeof e&&e&&e.jquery&&(e=e.get(0)),e&&Object.prototype.hasOwnProperty.call(e,"viewInstance")?e.viewInstance:null)}getViews(e){e?"object"==typeof e&&e&&e.jquery&&(e=e.get(0)):e=document.body;var t=e.querySelectorAll("[data-view]"),i=[];const r=e=>{e&&Object.prototype.hasOwnProperty.call(e,"viewInstance")&&i.push(e.viewInstance)};for(var n=0;n<t.length;n++)r(t[n]);return r(e),i}_createView(e,t){var i=e.getAttribute("data-view");if(!(e&&Object.prototype.hasOwnProperty.call(e,"viewInstance")||!i)){var r=e.getAttribute("data-view-args"),n=this.Views[i];if(!i||void 0===n)throw"JavaScript view "+i+" not found!";r&&(r=JSON.parse(r)),n=new n(e,this.main,r),e.viewInstance=n,t.push(n)}}setupViews(e,t=!0){if(e?"object"==typeof e&&e&&e.jquery?e=e.get(0):("string"==typeof e||e instanceof String)&&(e=document.querySelector(e)):e=document.body,!e)return;let i=e.querySelectorAll("[data-view]"),r=[];for(var n=0;n<i.length;n++)this._createView(i[n],r);1==t&&this._createView(e,r),this.trigger("views:loaded",r),r=null}trigger(e,t){console.log(e,t)}destroy(){console.log("app destroy")}}function e(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function t(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var i,n,s,a,o,l,h,c,d,u,f,p={autoSleep:120,force3D:"auto",nullTargetWarn:1,units:{lineHeight:""}},m={duration:.5,overwrite:!1,delay:0},g=1e8,v=1e-8,y=2*Math.PI,_=y/4,S=0,b=Math.sqrt,T=Math.cos,x=Math.sin,E=function(e){return"string"==typeof e},M=function(e){return"function"==typeof e},w=function(e){return"number"==typeof e},A=function(e){return void 0===e},L=function(e){return"object"==typeof e},C=function(e){return!1!==e},R=function(){return"undefined"!=typeof window},P=function(e){return M(e)||E(e)},D="function"==typeof ArrayBuffer&&ArrayBuffer.isView||function(){},k=Array.isArray,O=/(?:-?\.?\d|\.)+/gi,U=/[-+=.]*\d+[.e\-+]*\d*[e\-+]*\d*/g,N=/[-+=.]*\d+[.e-]*\d*[a-z%]*/g,F=/[-+=.]*\d+\.?\d*(?:e-|e\+)?\d*/gi,B=/[+-]=-?[.\d]+/,V=/[^,'"\[\]\s]+/gi,G=/^[+\-=e\s\d]*\d+[.\d]*([a-z]*|%)\s*$/i,z={},H={},$=function(e){return(H=_e(e,z))&&bi},W=function(e,t){return console.warn("Invalid property",e,"set to",t,"Missing plugin? gsap.registerPlugin()")},q=function(e,t){return!t&&console.warn(e)},j=function(e,t){return e&&(z[e]=t)&&H&&(H[e]=t)||z},K=function(){return 0},Y={suppressEvents:!0,isStart:!0,kill:!1},X={suppressEvents:!0,kill:!1},Q={suppressEvents:!0},Z={},J=[],ee={},te={},ie={},re=30,ne=[],se="",ae=function(e){var t,i,r=e[0];if(L(r)||M(r)||(e=[e]),!(t=(r._gsap||{}).harness)){for(i=ne.length;i--&&!ne[i].targetTest(r););t=ne[i]}for(i=e.length;i--;)e[i]&&(e[i]._gsap||(e[i]._gsap=new kt(e[i],t)))||e.splice(i,1);return e},oe=function(e){return e._gsap||ae(Qe(e))[0]._gsap},le=function(e,t,i){return(i=e[t])&&M(i)?e[t]():A(i)&&e.getAttribute&&e.getAttribute(t)||i},he=function(e,t){return(e=e.split(",")).forEach(t)||e},ce=function(e){return Math.round(1e5*e)/1e5||0},de=function(e){return Math.round(1e7*e)/1e7||0},ue=function(e,t){var i=t.charAt(0),r=parseFloat(t.substr(2));return e=parseFloat(e),"+"===i?e+r:"-"===i?e-r:"*"===i?e*r:e/r},fe=function(e,t){for(var i=t.length,r=0;e.indexOf(t[r])<0&&++r<i;);return r<i},pe=function(){var e,t,i=J.length,r=J.slice(0);for(ee={},J.length=0,e=0;e<i;e++)(t=r[e])&&t._lazy&&(t.render(t._lazy[0],t._lazy[1],!0)._lazy=0)},me=function(e,t,i,r){J.length&&!n&&pe(),e.render(t,i,r||n&&t<0&&(e._initted||e._startAt)),J.length&&!n&&pe()},ge=function(e){var t=parseFloat(e);return(t||0===t)&&(e+"").match(V).length<2?t:E(e)?e.trim():e},ve=function(e){return e},ye=function(e,t){for(var i in t)i in e||(e[i]=t[i]);return e},_e=function(e,t){for(var i in t)e[i]=t[i];return e},Se=function e(t,i){for(var r in i)"__proto__"!==r&&"constructor"!==r&&"prototype"!==r&&(t[r]=L(i[r])?e(t[r]||(t[r]={}),i[r]):i[r]);return t},be=function(e,t){var i,r={};for(i in e)i in t||(r[i]=e[i]);return r},Te=function(e){var t,i=e.parent||a,r=e.keyframes?(t=k(e.keyframes),function(e,i){for(var r in i)r in e||"duration"===r&&t||"ease"===r||(e[r]=i[r])}):ye;if(C(e.inherit))for(;i;)r(e,i.vars.defaults),i=i.parent||i._dp;return e},xe=function(e,t,i,r,n){void 0===i&&(i="_first"),void 0===r&&(r="_last");var s,a=e[r];if(n)for(s=t[n];a&&a[n]>s;)a=a._prev;return a?(t._next=a._next,a._next=t):(t._next=e[i],e[i]=t),t._next?t._next._prev=t:e[r]=t,t._prev=a,t.parent=t._dp=e,t},Ee=function(e,t,i,r){void 0===i&&(i="_first"),void 0===r&&(r="_last");var n=t._prev,s=t._next;n?n._next=s:e[i]===t&&(e[i]=s),s?s._prev=n:e[r]===t&&(e[r]=n),t._next=t._prev=t.parent=null},Me=function(e,t){e.parent&&(!t||e.parent.autoRemoveChildren)&&e.parent.remove&&e.parent.remove(e),e._act=0},we=function(e,t){if(e&&(!t||t._end>e._dur||t._start<0))for(var i=e;i;)i._dirty=1,i=i.parent;return e},Ae=function(e,t,i,r){return e._startAt&&(n?e._startAt.revert(X):e.vars.immediateRender&&!e.vars.autoRevert||e._startAt.render(t,!0,r))},Le=function e(t){return!t||t._ts&&e(t.parent)},Ce=function(e){return e._repeat?Re(e._tTime,e=e.duration()+e._rDelay)*e:0},Re=function(e,t){var i=Math.floor(e=de(e/t));return e&&i===e?i-1:i},Pe=function(e,t){return(e-t._start)*t._ts+(t._ts>=0?0:t._dirty?t.totalDuration():t._tDur)},Ie=function(e){return e._end=de(e._start+(e._tDur/Math.abs(e._ts||e._rts||v)||0))},De=function(e,t){var i=e._dp;return i&&i.smoothChildTiming&&e._ts&&(e._start=de(i._time-(e._ts>0?t/e._ts:((e._dirty?e.totalDuration():e._tDur)-t)/-e._ts)),Ie(e),i._dirty||we(i,e)),e},ke=function(e,t){var i;if((t._time||!t._dur&&t._initted||t._start<e._time&&(t._dur||!t.add))&&(i=Pe(e.rawTime(),t),(!t._dur||qe(0,t.totalDuration(),i)-t._tTime>v)&&t.render(i,!0)),we(e,t)._dp&&e._initted&&e._time>=e._dur&&e._ts){if(e._dur<e.duration())for(i=e;i._dp;)i.rawTime()>=0&&i.totalTime(i._tTime),i=i._dp;e._zTime=-1e-8}},Oe=function(e,t,i,r){return t.parent&&Me(t),t._start=de((w(i)?i:i||e!==a?He(e,i,t):e._time)+t._delay),t._end=de(t._start+(t.totalDuration()/Math.abs(t.timeScale())||0)),xe(e,t,"_first","_last",e._sort?"_start":0),Be(t)||(e._recent=t),r||ke(e,t),e._ts<0&&De(e,e._tTime),e},Ue=function(e,t){return(z.ScrollTrigger||W("scrollTrigger",t))&&z.ScrollTrigger.create(t,e)},Ne=function(e,t,i,r,s){return Ht(e,t,s),e._initted?!i&&e._pt&&!n&&(e._dur&&!1!==e.vars.lazy||!e._dur&&e.vars.lazy)&&d!==bt.frame?(J.push(e),e._lazy=[s,r],1):void 0:1},Fe=function e(t){var i=t.parent;return i&&i._ts&&i._initted&&!i._lock&&(i.rawTime()<0||e(i))},Be=function(e){var t=e.data;return"isFromStart"===t||"isStart"===t},Ve=function(e,t,i,r){var n=e._repeat,s=de(t)||0,a=e._tTime/e._tDur;return a&&!r&&(e._time*=s/e._dur),e._dur=s,e._tDur=n?n<0?1e10:de(s*(n+1)+e._rDelay*n):s,a>0&&!r&&De(e,e._tTime=e._tDur*a),e.parent&&Ie(e),i||we(e.parent,e),e},Ge=function(e){return e instanceof Nt?we(e):Ve(e,e._dur)},ze={_start:0,endTime:K,totalDuration:K},He=function e(t,i,r){var n,s,a,o=t.labels,l=t._recent||ze,h=t.duration()>=g?l.endTime(!1):t._dur;return E(i)&&(isNaN(i)||i in o)?(s=i.charAt(0),a="%"===i.substr(-1),n=i.indexOf("="),"<"===s||">"===s?(n>=0&&(i=i.replace(/=/,"")),("<"===s?l._start:l.endTime(l._repeat>=0))+(parseFloat(i.substr(1))||0)*(a?(n<0?l:r).totalDuration()/100:1)):n<0?(i in o||(o[i]=h),o[i]):(s=parseFloat(i.charAt(n-1)+i.substr(n+1)),a&&r&&(s=s/100*(k(r)?r[0]:r).totalDuration()),n>1?e(t,i.substr(0,n-1),r)+s:h+s)):null==i?h:+i},$e=function(e,t,i){var r,n,s=w(t[1]),a=(s?2:1)+(e<2?0:1),o=t[a];if(s&&(o.duration=t[1]),o.parent=i,e){for(r=o,n=i;n&&!("immediateRender"in r);)r=n.vars.defaults||{},n=C(n.vars.inherit)&&n.parent;o.immediateRender=C(r.immediateRender),e<2?o.runBackwards=1:o.startAt=t[a-1]}return new Kt(t[0],o,t[a+1])},We=function(e,t){return e||0===e?t(e):t},qe=function(e,t,i){return i<e?e:i>t?t:i},je=function(e,t){return E(e)&&(t=G.exec(e))?t[1]:""},Ke=[].slice,Ye=function(e,t){return e&&L(e)&&"length"in e&&(!t&&!e.length||e.length-1 in e&&L(e[0]))&&!e.nodeType&&e!==o},Xe=function(e,t,i){return void 0===i&&(i=[]),e.forEach(function(e){var r;return E(e)&&!t||Ye(e,1)?(r=i).push.apply(r,Qe(e)):i.push(e)})||i},Qe=function(e,t,i){return s&&!t&&s.selector?s.selector(e):!E(e)||i||!l&&Tt()?k(e)?Xe(e,i):Ye(e)?Ke.call(e,0):e?[e]:[]:Ke.call((t||h).querySelectorAll(e),0)},Ze=function(e){return e=Qe(e)[0]||q("Invalid scope")||{},function(t){var i=e.current||e.nativeElement||e;return Qe(t,i.querySelectorAll?i:i===e?q("Invalid scope")||h.createElement("div"):e)}},Je=function(e){return e.sort(function(){return.5-Math.random()})},et=function(e){if(M(e))return e;var t=L(e)?e:{each:e},i=Ct(t.ease),r=t.from||0,n=parseFloat(t.base)||0,s={},a=r>0&&r<1,o=isNaN(r)||a,l=t.axis,h=r,c=r;return E(r)?h=c={center:.5,edges:.5,end:1}[r]||0:!a&&o&&(h=r[0],c=r[1]),function(e,a,d){var u,f,p,m,v,y,_,S,T,x=(d||t).length,E=s[x];if(!E){if(!(T="auto"===t.grid?0:(t.grid||[1,g])[1])){for(_=-g;_<(_=d[T++].getBoundingClientRect().left)&&T<x;);T<x&&T--}for(E=s[x]=[],u=o?Math.min(T,x)*h-.5:r%T,f=T===g?0:o?x*c/T-.5:r/T|0,_=0,S=g,y=0;y<x;y++)p=y%T-u,m=f-(y/T|0),E[y]=v=l?Math.abs("y"===l?m:p):b(p*p+m*m),v>_&&(_=v),v<S&&(S=v);"random"===r&&Je(E),E.max=_-S,E.min=S,E.v=x=(parseFloat(t.amount)||parseFloat(t.each)*(T>x?x-1:l?"y"===l?x/T:T:Math.max(T,x/T))||0)*("edges"===r?-1:1),E.b=x<0?n-x:n,E.u=je(t.amount||t.each)||0,i=i&&x<0?At(i):i}return x=(E[e]-E.min)/E.max||0,de(E.b+(i?i(x):x)*E.v)+E.u}},tt=function(e){var t=Math.pow(10,((e+"").split(".")[1]||"").length);return function(i){var r=de(Math.round(parseFloat(i)/e)*e*t);return(r-r%1)/t+(w(i)?0:je(i))}},it=function(e,t){var i,r,n=k(e);return!n&&L(e)&&(i=n=e.radius||g,e.values?(e=Qe(e.values),(r=!w(e[0]))&&(i*=i)):e=tt(e.increment)),We(t,n?M(e)?function(t){return r=e(t),Math.abs(r-t)<=i?r:t}:function(t){for(var n,s,a=parseFloat(r?t.x:t),o=parseFloat(r?t.y:0),l=g,h=0,c=e.length;c--;)(n=r?(n=e[c].x-a)*n+(s=e[c].y-o)*s:Math.abs(e[c]-a))<l&&(l=n,h=c);return h=!i||l<=i?e[h]:t,r||h===t||w(t)?h:h+je(t)}:tt(e))},rt=function(e,t,i,r){return We(k(e)?!t:!0===i?!!(i=0):!r,function(){return k(e)?e[~~(Math.random()*e.length)]:(i=i||1e-5)&&(r=i<1?Math.pow(10,(i+"").length-2):1)&&Math.floor(Math.round((e-i/2+Math.random()*(t-e+.99*i))/i)*i*r)/r})},nt=function(e,t,i){return We(i,function(i){return e[~~t(i)]})},st=function(e){for(var t,i,r,n,s=0,a="";~(t=e.indexOf("random(",s));)r=e.indexOf(")",t),n="["===e.charAt(t+7),i=e.substr(t+7,r-t-7).match(n?V:O),a+=e.substr(s,t-s)+rt(n?i:+i[0],n?0:+i[1],+i[2]||1e-5),s=r+1;return a+e.substr(s,e.length-s)},at=function(e,t,i,r,n){var s=t-e,a=r-i;return We(n,function(t){return i+((t-e)/s*a||0)})},ot=function(e,t,i){var r,n,s,a=e.labels,o=g;for(r in a)(n=a[r]-t)<0==!!i&&n&&o>(n=Math.abs(n))&&(s=r,o=n);return s},lt=function(e,t,i){var r,n,a,o=e.vars,l=o[t],h=s,c=e._ctx;if(l)return r=o[t+"Params"],n=o.callbackScope||e,i&&J.length&&pe(),c&&(s=c),a=r?l.apply(n,r):l.call(n),s=h,a},ht=function(e){return Me(e),e.scrollTrigger&&e.scrollTrigger.kill(!!n),e.progress()<1&&lt(e,"onInterrupt"),e},ct=[],dt=function(e){if(e)if(e=!e.name&&e.default||e,R()||e.headless){var t=e.name,i=M(e),r=t&&!i&&e.init?function(){this._props=[]}:e,n={init:K,render:ri,add:Gt,kill:si,modifier:ni,rawVars:0},s={targetTest:0,get:0,getSetter:Jt,aliases:{},register:0};if(Tt(),e!==r){if(te[t])return;ye(r,ye(be(e,n),s)),_e(r.prototype,_e(n,be(e,s))),te[r.prop=t]=r,e.targetTest&&(ne.push(r),Z[t]=1),t=("css"===t?"CSS":t.charAt(0).toUpperCase()+t.substr(1))+"Plugin"}j(t,r),e.register&&e.register(bi,r,li)}else ct.push(e)},ut=255,ft={aqua:[0,ut,ut],lime:[0,ut,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,ut],navy:[0,0,128],white:[ut,ut,ut],olive:[128,128,0],yellow:[ut,ut,0],orange:[ut,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[ut,0,0],pink:[ut,192,203],cyan:[0,ut,ut],transparent:[ut,ut,ut,0]},pt=function(e,t,i){return(6*(e+=e<0?1:e>1?-1:0)<1?t+(i-t)*e*6:e<.5?i:3*e<2?t+(i-t)*(2/3-e)*6:t)*ut+.5|0},mt=function(e,t,i){var r,n,s,a,o,l,h,c,d,u,f=e?w(e)?[e>>16,e>>8&ut,e&ut]:0:ft.black;if(!f){if(","===e.substr(-1)&&(e=e.substr(0,e.length-1)),ft[e])f=ft[e];else if("#"===e.charAt(0)){if(e.length<6&&(r=e.charAt(1),n=e.charAt(2),s=e.charAt(3),e="#"+r+r+n+n+s+s+(5===e.length?e.charAt(4)+e.charAt(4):"")),9===e.length)return[(f=parseInt(e.substr(1,6),16))>>16,f>>8&ut,f&ut,parseInt(e.substr(7),16)/255];f=[(e=parseInt(e.substr(1),16))>>16,e>>8&ut,e&ut]}else if("hsl"===e.substr(0,3))if(f=u=e.match(O),t){if(~e.indexOf("="))return f=e.match(U),i&&f.length<4&&(f[3]=1),f}else a=+f[0]%360/360,o=+f[1]/100,r=2*(l=+f[2]/100)-(n=l<=.5?l*(o+1):l+o-l*o),f.length>3&&(f[3]*=1),f[0]=pt(a+1/3,r,n),f[1]=pt(a,r,n),f[2]=pt(a-1/3,r,n);else f=e.match(O)||ft.transparent;f=f.map(Number)}return t&&!u&&(r=f[0]/ut,n=f[1]/ut,s=f[2]/ut,l=((h=Math.max(r,n,s))+(c=Math.min(r,n,s)))/2,h===c?a=o=0:(d=h-c,o=l>.5?d/(2-h-c):d/(h+c),a=h===r?(n-s)/d+(n<s?6:0):h===n?(s-r)/d+2:(r-n)/d+4,a*=60),f[0]=~~(a+.5),f[1]=~~(100*o+.5),f[2]=~~(100*l+.5)),i&&f.length<4&&(f[3]=1),f},gt=function(e){var t=[],i=[],r=-1;return e.split(yt).forEach(function(e){var n=e.match(N)||[];t.push.apply(t,n),i.push(r+=n.length+1)}),t.c=i,t},vt=function(e,t,i){var r,n,s,a,o="",l=(e+o).match(yt),h=t?"hsla(":"rgba(",c=0;if(!l)return e;if(l=l.map(function(e){return(e=mt(e,t,1))&&h+(t?e[0]+","+e[1]+"%,"+e[2]+"%,"+e[3]:e.join(","))+")"}),i&&(s=gt(e),(r=i.c).join(o)!==s.c.join(o)))for(a=(n=e.replace(yt,"1").split(N)).length-1;c<a;c++)o+=n[c]+(~r.indexOf(c)?l.shift()||h+"0,0,0,0)":(s.length?s:l.length?l:i).shift());if(!n)for(a=(n=e.split(yt)).length-1;c<a;c++)o+=n[c]+l[c];return o+n[a]},yt=function(){var e,t="(?:\\b(?:(?:rgb|rgba|hsl|hsla)\\(.+?\\))|\\B#(?:[0-9a-f]{3,4}){1,2}\\b";for(e in ft)t+="|"+e+"\\b";return new RegExp(t+")","gi")}(),_t=/hsl[a]?\(/,St=function(e){var t,i=e.join(" ");if(yt.lastIndex=0,yt.test(i))return t=_t.test(i),e[1]=vt(e[1],t),e[0]=vt(e[0],t,gt(e[1])),!0},bt=function(){var e,t,i,r,n,s,a=Date.now,d=500,u=33,p=a(),m=p,g=1e3/240,v=g,y=[],_=function i(o){var l,h,c,f,_=a()-m,S=!0===o;if((_>d||_<0)&&(p+=_-u),((l=(c=(m+=_)-p)-v)>0||S)&&(f=++r.frame,n=c-1e3*r.time,r.time=c/=1e3,v+=l+(l>=g?4:g-l),h=1),S||(e=t(i)),h)for(s=0;s<y.length;s++)y[s](c,n,f,o)};return r={time:0,frame:0,tick:function(){_(!0)},deltaRatio:function(e){return n/(1e3/(e||60))},wake:function(){c&&(!l&&R()&&(o=l=window,h=o.document||{},z.gsap=bi,(o.gsapVersions||(o.gsapVersions=[])).push(bi.version),$(H||o.GreenSockGlobals||!o.gsap&&o||{}),ct.forEach(dt)),i="undefined"!=typeof requestAnimationFrame&&requestAnimationFrame,e&&r.sleep(),t=i||function(e){return setTimeout(e,v-1e3*r.time+1|0)},f=1,_(2))},sleep:function(){(i?cancelAnimationFrame:clearTimeout)(e),f=0,t=K},lagSmoothing:function(e,t){d=e||1/0,u=Math.min(t||33,d)},fps:function(e){g=1e3/(e||240),v=1e3*r.time+g},add:function(e,t,i){var n=t?function(t,i,s,a){e(t,i,s,a),r.remove(n)}:e;return r.remove(e),y[i?"unshift":"push"](n),Tt(),n},remove:function(e,t){~(t=y.indexOf(e))&&y.splice(t,1)&&s>=t&&s--},_listeners:y},r}(),Tt=function(){return!f&&bt.wake()},xt={},Et=/^[\d.\-M][\d.\-,\s]/,Mt=/["']/g,wt=function(e){for(var t,i,r,n={},s=e.substr(1,e.length-3).split(":"),a=s[0],o=1,l=s.length;o<l;o++)i=s[o],t=o!==l-1?i.lastIndexOf(","):i.length,r=i.substr(0,t),n[a]=isNaN(r)?r.replace(Mt,"").trim():+r,a=i.substr(t+1).trim();return n},At=function(e){return function(t){return 1-e(1-t)}},Lt=function e(t,i){for(var r,n=t._first;n;)n instanceof Nt?e(n,i):!n.vars.yoyoEase||n._yoyo&&n._repeat||n._yoyo===i||(n.timeline?e(n.timeline,i):(r=n._ease,n._ease=n._yEase,n._yEase=r,n._yoyo=i)),n=n._next},Ct=function(e,t){return e&&(M(e)?e:xt[e]||function(e){var t,i,r,n,s=(e+"").split("("),a=xt[s[0]];return a&&s.length>1&&a.config?a.config.apply(null,~e.indexOf("{")?[wt(s[1])]:(t=e,i=t.indexOf("(")+1,r=t.indexOf(")"),n=t.indexOf("(",i),t.substring(i,~n&&n<r?t.indexOf(")",r+1):r)).split(",").map(ge)):xt._CE&&Et.test(e)?xt._CE("",e):a}(e))||t},Rt=function(e,t,i,r){void 0===i&&(i=function(e){return 1-t(1-e)}),void 0===r&&(r=function(e){return e<.5?t(2*e)/2:1-t(2*(1-e))/2});var n,s={easeIn:t,easeOut:i,easeInOut:r};return he(e,function(e){for(var t in xt[e]=z[e]=s,xt[n=e.toLowerCase()]=i,s)xt[n+("easeIn"===t?".in":"easeOut"===t?".out":".inOut")]=xt[e+"."+t]=s[t]}),s},Pt=function(e){return function(t){return t<.5?(1-e(1-2*t))/2:.5+e(2*(t-.5))/2}},It=function e(t,i,r){var n=i>=1?i:1,s=(r||(t?.3:.45))/(i<1?i:1),a=s/y*(Math.asin(1/n)||0),o=function(e){return 1===e?1:n*Math.pow(2,-10*e)*x((e-a)*s)+1},l="out"===t?o:"in"===t?function(e){return 1-o(1-e)}:Pt(o);return s=y/s,l.config=function(i,r){return e(t,i,r)},l},Dt=function e(t,i){void 0===i&&(i=1.70158);var r=function(e){return e?--e*e*((i+1)*e+i)+1:0},n="out"===t?r:"in"===t?function(e){return 1-r(1-e)}:Pt(r);return n.config=function(i){return e(t,i)},n};he("Linear,Quad,Cubic,Quart,Quint,Strong",function(e,t){var i=t<5?t+1:t;Rt(e+",Power"+(i-1),t?function(e){return Math.pow(e,i)}:function(e){return e},function(e){return 1-Math.pow(1-e,i)},function(e){return e<.5?Math.pow(2*e,i)/2:1-Math.pow(2*(1-e),i)/2})}),xt.Linear.easeNone=xt.none=xt.Linear.easeIn,Rt("Elastic",It("in"),It("out"),It()),function(e,t){var i=1/t,r=2*i,n=2.5*i,s=function(s){return s<i?e*s*s:s<r?e*Math.pow(s-1.5/t,2)+.75:s<n?e*(s-=2.25/t)*s+.9375:e*Math.pow(s-2.625/t,2)+.984375};Rt("Bounce",function(e){return 1-s(1-e)},s)}(7.5625,2.75),Rt("Expo",function(e){return Math.pow(2,10*(e-1))*e+e*e*e*e*e*e*(1-e)}),Rt("Circ",function(e){return-(b(1-e*e)-1)}),Rt("Sine",function(e){return 1===e?1:1-T(e*_)}),Rt("Back",Dt("in"),Dt("out"),Dt()),xt.SteppedEase=xt.steps=z.SteppedEase={config:function(e,t){void 0===e&&(e=1);var i=1/e,r=e+(t?0:1),n=t?1:0;return function(e){return((r*qe(0,.99999999,e)|0)+n)*i}}},m.ease=xt["quad.out"],he("onComplete,onUpdate,onStart,onRepeat,onReverseComplete,onInterrupt",function(e){return se+=e+","+e+"Params,"});var kt=function(e,t){this.id=S++,e._gsap=this,this.target=e,this.harness=t,this.get=t?t.get:le,this.set=t?t.getSetter:Jt},Ot=function(){function e(e){this.vars=e,this._delay=+e.delay||0,(this._repeat=e.repeat===1/0?-2:e.repeat||0)&&(this._rDelay=e.repeatDelay||0,this._yoyo=!!e.yoyo||!!e.yoyoEase),this._ts=1,Ve(this,+e.duration,1,1),this.data=e.data,s&&(this._ctx=s,s.data.push(this)),f||bt.wake()}var t=e.prototype;return t.delay=function(e){return e||0===e?(this.parent&&this.parent.smoothChildTiming&&this.startTime(this._start+e-this._delay),this._delay=e,this):this._delay},t.duration=function(e){return arguments.length?this.totalDuration(this._repeat>0?e+(e+this._rDelay)*this._repeat:e):this.totalDuration()&&this._dur},t.totalDuration=function(e){return arguments.length?(this._dirty=0,Ve(this,this._repeat<0?e:(e-this._repeat*this._rDelay)/(this._repeat+1))):this._tDur},t.totalTime=function(e,t){if(Tt(),!arguments.length)return this._tTime;var i=this._dp;if(i&&i.smoothChildTiming&&this._ts){for(De(this,e),!i._dp||i.parent||ke(i,this);i&&i.parent;)i.parent._time!==i._start+(i._ts>=0?i._tTime/i._ts:(i.totalDuration()-i._tTime)/-i._ts)&&i.totalTime(i._tTime,!0),i=i.parent;!this.parent&&this._dp.autoRemoveChildren&&(this._ts>0&&e<this._tDur||this._ts<0&&e>0||!this._tDur&&!e)&&Oe(this._dp,this,this._start-this._delay)}return(this._tTime!==e||!this._dur&&!t||this._initted&&Math.abs(this._zTime)===v||!e&&!this._initted&&(this.add||this._ptLookup))&&(this._ts||(this._pTime=e),me(this,e,t)),this},t.time=function(e,t){return arguments.length?this.totalTime(Math.min(this.totalDuration(),e+Ce(this))%(this._dur+this._rDelay)||(e?this._dur:0),t):this._time},t.totalProgress=function(e,t){return arguments.length?this.totalTime(this.totalDuration()*e,t):this.totalDuration()?Math.min(1,this._tTime/this._tDur):this.rawTime()>=0&&this._initted?1:0},t.progress=function(e,t){return arguments.length?this.totalTime(this.duration()*(!this._yoyo||1&this.iteration()?e:1-e)+Ce(this),t):this.duration()?Math.min(1,this._time/this._dur):this.rawTime()>0?1:0},t.iteration=function(e,t){var i=this.duration()+this._rDelay;return arguments.length?this.totalTime(this._time+(e-1)*i,t):this._repeat?Re(this._tTime,i)+1:1},t.timeScale=function(e,t){if(!arguments.length)return-1e-8===this._rts?0:this._rts;if(this._rts===e)return this;var i=this.parent&&this._ts?Pe(this.parent._time,this):this._tTime;return this._rts=+e||0,this._ts=this._ps||-1e-8===e?0:this._rts,this.totalTime(qe(-Math.abs(this._delay),this._tDur,i),!1!==t),Ie(this),function(e){for(var t=e.parent;t&&t.parent;)t._dirty=1,t.totalDuration(),t=t.parent;return e}(this)},t.paused=function(e){return arguments.length?(this._ps!==e&&(this._ps=e,e?(this._pTime=this._tTime||Math.max(-this._delay,this.rawTime()),this._ts=this._act=0):(Tt(),this._ts=this._rts,this.totalTime(this.parent&&!this.parent.smoothChildTiming?this.rawTime():this._tTime||this._pTime,1===this.progress()&&Math.abs(this._zTime)!==v&&(this._tTime-=v)))),this):this._ps},t.startTime=function(e){if(arguments.length){this._start=e;var t=this.parent||this._dp;return t&&(t._sort||!this.parent)&&Oe(t,this,e-this._delay),this}return this._start},t.endTime=function(e){return this._start+(C(e)?this.totalDuration():this.duration())/Math.abs(this._ts||1)},t.rawTime=function(e){var t=this.parent||this._dp;return t?e&&(!this._ts||this._repeat&&this._time&&this.totalProgress()<1)?this._tTime%(this._dur+this._rDelay):this._ts?Pe(t.rawTime(e),this):this._tTime:this._tTime},t.revert=function(e){void 0===e&&(e=Q);var t=n;return n=e,(this._initted||this._startAt)&&(this.timeline&&this.timeline.revert(e),this.totalTime(-.01,e.suppressEvents)),"nested"!==this.data&&!1!==e.kill&&this.kill(),n=t,this},t.globalTime=function(e){for(var t=this,i=arguments.length?e:t.rawTime();t;)i=t._start+i/(Math.abs(t._ts)||1),t=t._dp;return!this.parent&&this._sat?this._sat.globalTime(e):i},t.repeat=function(e){return arguments.length?(this._repeat=e===1/0?-2:e,Ge(this)):-2===this._repeat?1/0:this._repeat},t.repeatDelay=function(e){if(arguments.length){var t=this._time;return this._rDelay=e,Ge(this),t?this.time(t):this}return this._rDelay},t.yoyo=function(e){return arguments.length?(this._yoyo=e,this):this._yoyo},t.seek=function(e,t){return this.totalTime(He(this,e),C(t))},t.restart=function(e,t){return this.play().totalTime(e?-this._delay:0,C(t)),this._dur||(this._zTime=-1e-8),this},t.play=function(e,t){return null!=e&&this.seek(e,t),this.reversed(!1).paused(!1)},t.reverse=function(e,t){return null!=e&&this.seek(e||this.totalDuration(),t),this.reversed(!0).paused(!1)},t.pause=function(e,t){return null!=e&&this.seek(e,t),this.paused(!0)},t.resume=function(){return this.paused(!1)},t.reversed=function(e){return arguments.length?(!!e!==this.reversed()&&this.timeScale(-this._rts||(e?-1e-8:0)),this):this._rts<0},t.invalidate=function(){return this._initted=this._act=0,this._zTime=-1e-8,this},t.isActive=function(){var e,t=this.parent||this._dp,i=this._start;return!(t&&!(this._ts&&this._initted&&t.isActive()&&(e=t.rawTime(!0))>=i&&e<this.endTime(!0)-v))},t.eventCallback=function(e,t,i){var r=this.vars;return arguments.length>1?(t?(r[e]=t,i&&(r[e+"Params"]=i),"onUpdate"===e&&(this._onUpdate=t)):delete r[e],this):r[e]},t.then=function(e){var t=this;return new Promise(function(i){var r=M(e)?e:ve,n=function(){var e=t.then;t.then=null,M(r)&&(r=r(t))&&(r.then||r===t)&&(t.then=e),i(r),t.then=e};t._initted&&1===t.totalProgress()&&t._ts>=0||!t._tTime&&t._ts<0?n():t._prom=n})},t.kill=function(){ht(this)},e}();ye(Ot.prototype,{_time:0,_start:0,_end:0,_tTime:0,_tDur:0,_dirty:0,_repeat:0,_yoyo:!1,parent:null,_initted:!1,_rDelay:0,_ts:1,_dp:0,ratio:0,_zTime:-1e-8,_prom:0,_ps:!1,_rts:1});var Nt=function(i){function r(t,r){var n;return void 0===t&&(t={}),(n=i.call(this,t)||this).labels={},n.smoothChildTiming=!!t.smoothChildTiming,n.autoRemoveChildren=!!t.autoRemoveChildren,n._sort=C(t.sortChildren),a&&Oe(t.parent||a,e(n),r),t.reversed&&n.reverse(),t.paused&&n.paused(!0),t.scrollTrigger&&Ue(e(n),t.scrollTrigger),n}t(r,i);var s=r.prototype;return s.to=function(e,t,i){return $e(0,arguments,this),this},s.from=function(e,t,i){return $e(1,arguments,this),this},s.fromTo=function(e,t,i,r){return $e(2,arguments,this),this},s.set=function(e,t,i){return t.duration=0,t.parent=this,Te(t).repeatDelay||(t.repeat=0),t.immediateRender=!!t.immediateRender,new Kt(e,t,He(this,i),1),this},s.call=function(e,t,i){return Oe(this,Kt.delayedCall(0,e,t),i)},s.staggerTo=function(e,t,i,r,n,s,a){return i.duration=t,i.stagger=i.stagger||r,i.onComplete=s,i.onCompleteParams=a,i.parent=this,new Kt(e,i,He(this,n)),this},s.staggerFrom=function(e,t,i,r,n,s,a){return i.runBackwards=1,Te(i).immediateRender=C(i.immediateRender),this.staggerTo(e,t,i,r,n,s,a)},s.staggerFromTo=function(e,t,i,r,n,s,a,o){return r.startAt=i,Te(r).immediateRender=C(r.immediateRender),this.staggerTo(e,t,r,n,s,a,o)},s.render=function(e,t,i){var r,s,o,l,h,c,d,u,f,p,m,g,y=this._time,_=this._dirty?this.totalDuration():this._tDur,S=this._dur,b=e<=0?0:de(e),T=this._zTime<0!=e<0&&(this._initted||!S);if(this!==a&&b>_&&e>=0&&(b=_),b!==this._tTime||i||T){if(y!==this._time&&S&&(b+=this._time-y,e+=this._time-y),r=b,f=this._start,c=!(u=this._ts),T&&(S||(y=this._zTime),(e||!t)&&(this._zTime=e)),this._repeat){if(m=this._yoyo,h=S+this._rDelay,this._repeat<-1&&e<0)return this.totalTime(100*h+e,t,i);if(r=de(b%h),b===_?(l=this._repeat,r=S):((l=~~(p=de(b/h)))&&l===p&&(r=S,l--),r>S&&(r=S)),p=Re(this._tTime,h),!y&&this._tTime&&p!==l&&this._tTime-p*h-this._dur<=0&&(p=l),m&&1&l&&(r=S-r,g=1),l!==p&&!this._lock){var x=m&&1&p,E=x===(m&&1&l);if(l<p&&(x=!x),y=x?0:b%S?S:b,this._lock=1,this.render(y||(g?0:de(l*h)),t,!S)._lock=0,this._tTime=b,!t&&this.parent&&lt(this,"onRepeat"),this.vars.repeatRefresh&&!g&&(this.invalidate()._lock=1),y&&y!==this._time||c!==!this._ts||this.vars.onRepeat&&!this.parent&&!this._act)return this;if(S=this._dur,_=this._tDur,E&&(this._lock=2,y=x?S:-1e-4,this.render(y,!0),this.vars.repeatRefresh&&!g&&this.invalidate()),this._lock=0,!this._ts&&!c)return this;Lt(this,g)}}if(this._hasPause&&!this._forcing&&this._lock<2&&(d=function(e,t,i){var r;if(i>t)for(r=e._first;r&&r._start<=i;){if("isPause"===r.data&&r._start>t)return r;r=r._next}else for(r=e._last;r&&r._start>=i;){if("isPause"===r.data&&r._start<t)return r;r=r._prev}}(this,de(y),de(r)),d&&(b-=r-(r=d._start))),this._tTime=b,this._time=r,this._act=!u,this._initted||(this._onUpdate=this.vars.onUpdate,this._initted=1,this._zTime=e,y=0),!y&&r&&!t&&!l&&(lt(this,"onStart"),this._tTime!==b))return this;if(r>=y&&e>=0)for(s=this._first;s;){if(o=s._next,(s._act||r>=s._start)&&s._ts&&d!==s){if(s.parent!==this)return this.render(e,t,i);if(s.render(s._ts>0?(r-s._start)*s._ts:(s._dirty?s.totalDuration():s._tDur)+(r-s._start)*s._ts,t,i),r!==this._time||!this._ts&&!c){d=0,o&&(b+=this._zTime=-1e-8);break}}s=o}else{s=this._last;for(var M=e<0?e:r;s;){if(o=s._prev,(s._act||M<=s._end)&&s._ts&&d!==s){if(s.parent!==this)return this.render(e,t,i);if(s.render(s._ts>0?(M-s._start)*s._ts:(s._dirty?s.totalDuration():s._tDur)+(M-s._start)*s._ts,t,i||n&&(s._initted||s._startAt)),r!==this._time||!this._ts&&!c){d=0,o&&(b+=this._zTime=M?-1e-8:v);break}}s=o}}if(d&&!t&&(this.pause(),d.render(r>=y?0:-1e-8)._zTime=r>=y?1:-1,this._ts))return this._start=f,Ie(this),this.render(e,t,i);this._onUpdate&&!t&&lt(this,"onUpdate",!0),(b===_&&this._tTime>=this.totalDuration()||!b&&y)&&(f!==this._start&&Math.abs(u)===Math.abs(this._ts)||this._lock||((e||!S)&&(b===_&&this._ts>0||!b&&this._ts<0)&&Me(this,1),t||e<0&&!y||!b&&!y&&_||(lt(this,b===_&&e>=0?"onComplete":"onReverseComplete",!0),this._prom&&!(b<_&&this.timeScale()>0)&&this._prom())))}return this},s.add=function(e,t){var i=this;if(w(t)||(t=He(this,t,e)),!(e instanceof Ot)){if(k(e))return e.forEach(function(e){return i.add(e,t)}),this;if(E(e))return this.addLabel(e,t);if(!M(e))return this;e=Kt.delayedCall(0,e)}return this!==e?Oe(this,e,t):this},s.getChildren=function(e,t,i,r){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===i&&(i=!0),void 0===r&&(r=-g);for(var n=[],s=this._first;s;)s._start>=r&&(s instanceof Kt?t&&n.push(s):(i&&n.push(s),e&&n.push.apply(n,s.getChildren(!0,t,i)))),s=s._next;return n},s.getById=function(e){for(var t=this.getChildren(1,1,1),i=t.length;i--;)if(t[i].vars.id===e)return t[i]},s.remove=function(e){return E(e)?this.removeLabel(e):M(e)?this.killTweensOf(e):(e.parent===this&&Ee(this,e),e===this._recent&&(this._recent=this._last),we(this))},s.totalTime=function(e,t){return arguments.length?(this._forcing=1,!this._dp&&this._ts&&(this._start=de(bt.time-(this._ts>0?e/this._ts:(this.totalDuration()-e)/-this._ts))),i.prototype.totalTime.call(this,e,t),this._forcing=0,this):this._tTime},s.addLabel=function(e,t){return this.labels[e]=He(this,t),this},s.removeLabel=function(e){return delete this.labels[e],this},s.addPause=function(e,t,i){var r=Kt.delayedCall(0,t||K,i);return r.data="isPause",this._hasPause=1,Oe(this,r,He(this,e))},s.removePause=function(e){var t=this._first;for(e=He(this,e);t;)t._start===e&&"isPause"===t.data&&Me(t),t=t._next},s.killTweensOf=function(e,t,i){for(var r=this.getTweensOf(e,i),n=r.length;n--;)Ft!==r[n]&&r[n].kill(e,t);return this},s.getTweensOf=function(e,t){for(var i,r=[],n=Qe(e),s=this._first,a=w(t);s;)s instanceof Kt?fe(s._targets,n)&&(a?(!Ft||s._initted&&s._ts)&&s.globalTime(0)<=t&&s.globalTime(s.totalDuration())>t:!t||s.isActive())&&r.push(s):(i=s.getTweensOf(n,t)).length&&r.push.apply(r,i),s=s._next;return r},s.tweenTo=function(e,t){t=t||{};var i,r=this,n=He(r,e),s=t,a=s.startAt,o=s.onStart,l=s.onStartParams,h=s.immediateRender,c=Kt.to(r,ye({ease:t.ease||"none",lazy:!1,immediateRender:!1,time:n,overwrite:"auto",duration:t.duration||Math.abs((n-(a&&"time"in a?a.time:r._time))/r.timeScale())||v,onStart:function(){if(r.pause(),!i){var e=t.duration||Math.abs((n-(a&&"time"in a?a.time:r._time))/r.timeScale());c._dur!==e&&Ve(c,e,0,1).render(c._time,!0,!0),i=1}o&&o.apply(c,l||[])}},t));return h?c.render(0):c},s.tweenFromTo=function(e,t,i){return this.tweenTo(t,ye({startAt:{time:He(this,e)}},i))},s.recent=function(){return this._recent},s.nextLabel=function(e){return void 0===e&&(e=this._time),ot(this,He(this,e))},s.previousLabel=function(e){return void 0===e&&(e=this._time),ot(this,He(this,e),1)},s.currentLabel=function(e){return arguments.length?this.seek(e,!0):this.previousLabel(this._time+v)},s.shiftChildren=function(e,t,i){void 0===i&&(i=0);for(var r,n=this._first,s=this.labels;n;)n._start>=i&&(n._start+=e,n._end+=e),n=n._next;if(t)for(r in s)s[r]>=i&&(s[r]+=e);return we(this)},s.invalidate=function(e){var t=this._first;for(this._lock=0;t;)t.invalidate(e),t=t._next;return i.prototype.invalidate.call(this,e)},s.clear=function(e){void 0===e&&(e=!0);for(var t,i=this._first;i;)t=i._next,this.remove(i),i=t;return this._dp&&(this._time=this._tTime=this._pTime=0),e&&(this.labels={}),we(this)},s.totalDuration=function(e){var t,i,r,n=0,s=this,o=s._last,l=g;if(arguments.length)return s.timeScale((s._repeat<0?s.duration():s.totalDuration())/(s.reversed()?-e:e));if(s._dirty){for(r=s.parent;o;)t=o._prev,o._dirty&&o.totalDuration(),(i=o._start)>l&&s._sort&&o._ts&&!s._lock?(s._lock=1,Oe(s,o,i-o._delay,1)._lock=0):l=i,i<0&&o._ts&&(n-=i,(!r&&!s._dp||r&&r.smoothChildTiming)&&(s._start+=i/s._ts,s._time-=i,s._tTime-=i),s.shiftChildren(-i,!1,-Infinity),l=0),o._end>n&&o._ts&&(n=o._end),o=t;Ve(s,s===a&&s._time>n?s._time:n,1,1),s._dirty=0}return s._tDur},r.updateRoot=function(e){if(a._ts&&(me(a,Pe(e,a)),d=bt.frame),bt.frame>=re){re+=p.autoSleep||120;var t=a._first;if((!t||!t._ts)&&p.autoSleep&&bt._listeners.length<2){for(;t&&!t._ts;)t=t._next;t||bt.sleep()}}},r}(Ot);ye(Nt.prototype,{_lock:0,_hasPause:0,_forcing:0});var Ft,Bt,Vt=function(e,t,i,r,n,s,a){var o,l,h,c,d,u,f,p,m=new li(this._pt,e,t,0,1,ii,null,n),g=0,v=0;for(m.b=i,m.e=r,i+="",(f=~(r+="").indexOf("random("))&&(r=st(r)),s&&(s(p=[i,r],e,t),i=p[0],r=p[1]),l=i.match(F)||[];o=F.exec(r);)c=o[0],d=r.substring(g,o.index),h?h=(h+1)%5:"rgba("===d.substr(-5)&&(h=1),c!==l[v++]&&(u=parseFloat(l[v-1])||0,m._pt={_next:m._pt,p:d||1===v?d:",",s:u,c:"="===c.charAt(1)?ue(u,c)-u:parseFloat(c)-u,m:h&&h<4?Math.round:0},g=F.lastIndex);return m.c=g<r.length?r.substring(g,r.length):"",m.fp=a,(B.test(r)||f)&&(m.e=0),this._pt=m,m},Gt=function(e,t,i,r,n,s,a,o,l,h){M(r)&&(r=r(n||0,e,s));var c,d=e[t],u="get"!==i?i:M(d)?l?e[t.indexOf("set")||!M(e["get"+t.substr(3)])?t:"get"+t.substr(3)](l):e[t]():d,f=M(d)?l?Qt:Xt:Yt;if(E(r)&&(~r.indexOf("random(")&&(r=st(r)),"="===r.charAt(1)&&((c=ue(u,r)+(je(u)||0))||0===c)&&(r=c)),!h||u!==r||Bt)return isNaN(u*r)||""===r?(!d&&!(t in e)&&W(t,r),Vt.call(this,e,t,u,r,f,o||p.stringFilter,l)):(c=new li(this._pt,e,t,+u||0,r-(u||0),"boolean"==typeof d?ti:ei,0,f),l&&(c.fp=l),a&&c.modifier(a,this,e),this._pt=c)},zt=function(e,t,i,r,n,s){var a,o,l,h;if(te[e]&&!1!==(a=new te[e]).init(n,a.rawVars?t[e]:function(e,t,i,r,n){if(M(e)&&(e=Wt(e,n,t,i,r)),!L(e)||e.style&&e.nodeType||k(e)||D(e))return E(e)?Wt(e,n,t,i,r):e;var s,a={};for(s in e)a[s]=Wt(e[s],n,t,i,r);return a}(t[e],r,n,s,i),i,r,s)&&(i._pt=o=new li(i._pt,n,e,0,1,a.render,a,0,a.priority),i!==u))for(l=i._ptLookup[i._targets.indexOf(n)],h=a._props.length;h--;)l[a._props[h]]=o;return a},Ht=function e(t,r,s){var o,l,h,c,d,u,f,p,y,_,S,b,T,x=t.vars,E=x.ease,M=x.startAt,w=x.immediateRender,A=x.lazy,L=x.onUpdate,R=x.runBackwards,P=x.yoyoEase,D=x.keyframes,k=x.autoRevert,O=t._dur,U=t._startAt,N=t._targets,F=t.parent,B=F&&"nested"===F.data?F.vars.targets:N,V="auto"===t._overwrite&&!i,G=t.timeline;if(G&&(!D||!E)&&(E="none"),t._ease=Ct(E,m.ease),t._yEase=P?At(Ct(!0===P?E:P,m.ease)):0,P&&t._yoyo&&!t._repeat&&(P=t._yEase,t._yEase=t._ease,t._ease=P),t._from=!G&&!!x.runBackwards,!G||D&&!x.stagger){if(b=(p=N[0]?oe(N[0]).harness:0)&&x[p.prop],o=be(x,Z),U&&(U._zTime<0&&U.progress(1),r<0&&R&&w&&!k?U.render(-1,!0):U.revert(R&&O?X:Y),U._lazy=0),M){if(Me(t._startAt=Kt.set(N,ye({data:"isStart",overwrite:!1,parent:F,immediateRender:!0,lazy:!U&&C(A),startAt:null,delay:0,onUpdate:L&&function(){return lt(t,"onUpdate")},stagger:0},M))),t._startAt._dp=0,t._startAt._sat=t,r<0&&(n||!w&&!k)&&t._startAt.revert(X),w&&O&&r<=0&&s<=0)return void(r&&(t._zTime=r))}else if(R&&O&&!U)if(r&&(w=!1),h=ye({overwrite:!1,data:"isFromStart",lazy:w&&!U&&C(A),immediateRender:w,stagger:0,parent:F},o),b&&(h[p.prop]=b),Me(t._startAt=Kt.set(N,h)),t._startAt._dp=0,t._startAt._sat=t,r<0&&(n?t._startAt.revert(X):t._startAt.render(-1,!0)),t._zTime=r,w){if(!r)return}else e(t._startAt,v,v);for(t._pt=t._ptCache=0,A=O&&C(A)||A&&!O,l=0;l<N.length;l++){if(f=(d=N[l])._gsap||ae(N)[l]._gsap,t._ptLookup[l]=_={},ee[f.id]&&J.length&&pe(),S=B===N?l:B.indexOf(d),p&&!1!==(y=new p).init(d,b||o,t,S,B)&&(t._pt=c=new li(t._pt,d,y.name,0,1,y.render,y,0,y.priority),y._props.forEach(function(e){_[e]=c}),y.priority&&(u=1)),!p||b)for(h in o)te[h]&&(y=zt(h,o,t,S,d,B))?y.priority&&(u=1):_[h]=c=Gt.call(t,d,h,"get",o[h],S,B,0,x.stringFilter);t._op&&t._op[l]&&t.kill(d,t._op[l]),V&&t._pt&&(Ft=t,a.killTweensOf(d,_,t.globalTime(r)),T=!t.parent,Ft=0),t._pt&&A&&(ee[f.id]=1)}u&&oi(t),t._onInit&&t._onInit(t)}t._onUpdate=L,t._initted=(!t._op||t._pt)&&!T,D&&r<=0&&G.render(g,!0,!0)},$t=function(e,t,i,r){var n,s,a=t.ease||r||"power1.inOut";if(k(t))s=i[e]||(i[e]=[]),t.forEach(function(e,i){return s.push({t:i/(t.length-1)*100,v:e,e:a})});else for(n in t)s=i[n]||(i[n]=[]),"ease"===n||s.push({t:parseFloat(e),v:t[n],e:a})},Wt=function(e,t,i,r,n){return M(e)?e.call(t,i,r,n):E(e)&&~e.indexOf("random(")?st(e):e},qt=se+"repeat,repeatDelay,yoyo,repeatRefresh,yoyoEase,autoRevert",jt={};he(qt+",id,stagger,delay,duration,paused,scrollTrigger",function(e){return jt[e]=1});var Kt=function(r){function s(t,n,s,o){var l;"number"==typeof n&&(s.duration=n,n=s,s=null);var h,c,d,u,f,m,g,v,y=(l=r.call(this,o?n:Te(n))||this).vars,_=y.duration,S=y.delay,b=y.immediateRender,T=y.stagger,x=y.overwrite,E=y.keyframes,M=y.defaults,A=y.scrollTrigger,R=y.yoyoEase,O=n.parent||a,U=(k(t)||D(t)?w(t[0]):"length"in n)?[t]:Qe(t);if(l._targets=U.length?ae(U):q("GSAP target "+t+" not found. https://gsap.com",!p.nullTargetWarn)||[],l._ptLookup=[],l._overwrite=x,E||T||P(_)||P(S)){if(n=l.vars,(h=l.timeline=new Nt({data:"nested",defaults:M||{},targets:O&&"nested"===O.data?O.vars.targets:U})).kill(),h.parent=h._dp=e(l),h._start=0,T||P(_)||P(S)){if(u=U.length,g=T&&et(T),L(T))for(f in T)~qt.indexOf(f)&&(v||(v={}),v[f]=T[f]);for(c=0;c<u;c++)(d=be(n,jt)).stagger=0,R&&(d.yoyoEase=R),v&&_e(d,v),m=U[c],d.duration=+Wt(_,e(l),c,m,U),d.delay=(+Wt(S,e(l),c,m,U)||0)-l._delay,!T&&1===u&&d.delay&&(l._delay=S=d.delay,l._start+=S,d.delay=0),h.to(m,d,g?g(c,m,U):0),h._ease=xt.none;h.duration()?_=S=0:l.timeline=0}else if(E){Te(ye(h.vars.defaults,{ease:"none"})),h._ease=Ct(E.ease||n.ease||"none");var N,F,B,V=0;if(k(E))E.forEach(function(e){return h.to(U,e,">")}),h.duration();else{for(f in d={},E)"ease"===f||"easeEach"===f||$t(f,E[f],d,E.easeEach);for(f in d)for(N=d[f].sort(function(e,t){return e.t-t.t}),V=0,c=0;c<N.length;c++)(B={ease:(F=N[c]).e,duration:(F.t-(c?N[c-1].t:0))/100*_})[f]=F.v,h.to(U,B,V),V+=B.duration;h.duration()<_&&h.to({},{duration:_-h.duration()})}}_||l.duration(_=h.duration())}else l.timeline=0;return!0!==x||i||(Ft=e(l),a.killTweensOf(U),Ft=0),Oe(O,e(l),s),n.reversed&&l.reverse(),n.paused&&l.paused(!0),(b||!_&&!E&&l._start===de(O._time)&&C(b)&&Le(e(l))&&"nested"!==O.data)&&(l._tTime=-1e-8,l.render(Math.max(0,-S)||0)),A&&Ue(e(l),A),l}t(s,r);var o=s.prototype;return o.render=function(e,t,i){var r,s,a,o,l,h,c,d,u,f=this._time,p=this._tDur,m=this._dur,g=e<0,y=e>p-v&&!g?p:e<v?0:e;if(m){if(y!==this._tTime||!e||i||!this._initted&&this._tTime||this._startAt&&this._zTime<0!==g||this._lazy){if(r=y,d=this.timeline,this._repeat){if(o=m+this._rDelay,this._repeat<-1&&g)return this.totalTime(100*o+e,t,i);if(r=de(y%o),y===p?(a=this._repeat,r=m):(a=~~(l=de(y/o)))&&a===l?(r=m,a--):r>m&&(r=m),(h=this._yoyo&&1&a)&&(u=this._yEase,r=m-r),l=Re(this._tTime,o),r===f&&!i&&this._initted&&a===l)return this._tTime=y,this;a!==l&&(d&&this._yEase&&Lt(d,h),this.vars.repeatRefresh&&!h&&!this._lock&&r!==o&&this._initted&&(this._lock=i=1,this.render(de(o*a),!0).invalidate()._lock=0))}if(!this._initted){if(Ne(this,g?e:r,i,t,y))return this._tTime=0,this;if(!(f===this._time||i&&this.vars.repeatRefresh&&a!==l))return this;if(m!==this._dur)return this.render(e,t,i)}if(this._tTime=y,this._time=r,!this._act&&this._ts&&(this._act=1,this._lazy=0),this.ratio=c=(u||this._ease)(r/m),this._from&&(this.ratio=c=1-c),r&&!f&&!t&&!a&&(lt(this,"onStart"),this._tTime!==y))return this;for(s=this._pt;s;)s.r(c,s.d),s=s._next;d&&d.render(e<0?e:d._dur*d._ease(r/this._dur),t,i)||this._startAt&&(this._zTime=e),this._onUpdate&&!t&&(g&&Ae(this,e,0,i),lt(this,"onUpdate")),this._repeat&&a!==l&&this.vars.onRepeat&&!t&&this.parent&&lt(this,"onRepeat"),y!==this._tDur&&y||this._tTime!==y||(g&&!this._onUpdate&&Ae(this,e,0,!0),(e||!m)&&(y===this._tDur&&this._ts>0||!y&&this._ts<0)&&Me(this,1),t||g&&!f||!(y||f||h)||(lt(this,y===p?"onComplete":"onReverseComplete",!0),this._prom&&!(y<p&&this.timeScale()>0)&&this._prom()))}}else!function(e,t,i,r){var s,a,o,l=e.ratio,h=t<0||!t&&(!e._start&&Fe(e)&&(e._initted||!Be(e))||(e._ts<0||e._dp._ts<0)&&!Be(e))?0:1,c=e._rDelay,d=0;if(c&&e._repeat&&(d=qe(0,e._tDur,t),a=Re(d,c),e._yoyo&&1&a&&(h=1-h),a!==Re(e._tTime,c)&&(l=1-h,e.vars.repeatRefresh&&e._initted&&e.invalidate())),h!==l||n||r||e._zTime===v||!t&&e._zTime){if(!e._initted&&Ne(e,t,r,i,d))return;for(o=e._zTime,e._zTime=t||(i?v:0),i||(i=t&&!o),e.ratio=h,e._from&&(h=1-h),e._time=0,e._tTime=d,s=e._pt;s;)s.r(h,s.d),s=s._next;t<0&&Ae(e,t,0,!0),e._onUpdate&&!i&&lt(e,"onUpdate"),d&&e._repeat&&!i&&e.parent&&lt(e,"onRepeat"),(t>=e._tDur||t<0)&&e.ratio===h&&(h&&Me(e,1),i||n||(lt(e,h?"onComplete":"onReverseComplete",!0),e._prom&&e._prom()))}else e._zTime||(e._zTime=t)}(this,e,t,i);return this},o.targets=function(){return this._targets},o.invalidate=function(e){return(!e||!this.vars.runBackwards)&&(this._startAt=0),this._pt=this._op=this._onUpdate=this._lazy=this.ratio=0,this._ptLookup=[],this.timeline&&this.timeline.invalidate(e),r.prototype.invalidate.call(this,e)},o.resetTo=function(e,t,i,r,n){f||bt.wake(),this._ts||this.play();var s=Math.min(this._dur,(this._dp._time-this._start)*this._ts);return this._initted||Ht(this,s),function(e,t,i,r,n,s,a,o){var l,h,c,d,u=(e._pt&&e._ptCache||(e._ptCache={}))[t];if(!u)for(u=e._ptCache[t]=[],c=e._ptLookup,d=e._targets.length;d--;){if((l=c[d][t])&&l.d&&l.d._pt)for(l=l.d._pt;l&&l.p!==t&&l.fp!==t;)l=l._next;if(!l)return Bt=1,e.vars[t]="+=0",Ht(e,a),Bt=0,o?q(t+" not eligible for reset"):1;u.push(l)}for(d=u.length;d--;)(l=(h=u[d])._pt||h).s=!r&&0!==r||n?l.s+(r||0)+s*l.c:r,l.c=i-l.s,h.e&&(h.e=ce(i)+je(h.e)),h.b&&(h.b=l.s+je(h.b))}(this,e,t,i,r,this._ease(s/this._dur),s,n)?this.resetTo(e,t,i,r,1):(De(this,0),this.parent||xe(this._dp,this,"_first","_last",this._dp._sort?"_start":0),this.render(0))},o.kill=function(e,t){if(void 0===t&&(t="all"),!(e||t&&"all"!==t))return this._lazy=this._pt=0,this.parent?ht(this):this.scrollTrigger&&this.scrollTrigger.kill(!!n),this;if(this.timeline){var i=this.timeline.totalDuration();return this.timeline.killTweensOf(e,t,Ft&&!0!==Ft.vars.overwrite)._first||ht(this),this.parent&&i!==this.timeline.totalDuration()&&Ve(this,this._dur*this.timeline._tDur/i,0,1),this}var r,s,a,o,l,h,c,d=this._targets,u=e?Qe(e):d,f=this._ptLookup,p=this._pt;if((!t||"all"===t)&&function(e,t){for(var i=e.length,r=i===t.length;r&&i--&&e[i]===t[i];);return i<0}(d,u))return"all"===t&&(this._pt=0),ht(this);for(r=this._op=this._op||[],"all"!==t&&(E(t)&&(l={},he(t,function(e){return l[e]=1}),t=l),t=function(e,t){var i,r,n,s,a=e[0]?oe(e[0]).harness:0,o=a&&a.aliases;if(!o)return t;for(r in i=_e({},t),o)if(r in i)for(n=(s=o[r].split(",")).length;n--;)i[s[n]]=i[r];return i}(d,t)),c=d.length;c--;)if(~u.indexOf(d[c]))for(l in s=f[c],"all"===t?(r[c]=t,o=s,a={}):(a=r[c]=r[c]||{},o=t),o)(h=s&&s[l])&&("kill"in h.d&&!0!==h.d.kill(l)||Ee(this,h,"_pt"),delete s[l]),"all"!==a&&(a[l]=1);return this._initted&&!this._pt&&p&&ht(this),this},s.to=function(e,t){return new s(e,t,arguments[2])},s.from=function(e,t){return $e(1,arguments)},s.delayedCall=function(e,t,i,r){return new s(t,0,{immediateRender:!1,lazy:!1,overwrite:!1,delay:e,onComplete:t,onReverseComplete:t,onCompleteParams:i,onReverseCompleteParams:i,callbackScope:r})},s.fromTo=function(e,t,i){return $e(2,arguments)},s.set=function(e,t){return t.duration=0,t.repeatDelay||(t.repeat=0),new s(e,t)},s.killTweensOf=function(e,t,i){return a.killTweensOf(e,t,i)},s}(Ot);ye(Kt.prototype,{_targets:[],_lazy:0,_startAt:0,_op:0,_onInit:0}),he("staggerTo,staggerFrom,staggerFromTo",function(e){Kt[e]=function(){var t=new Nt,i=Ke.call(arguments,0);return i.splice("staggerFromTo"===e?5:4,0,0),t[e].apply(t,i)}});var Yt=function(e,t,i){return e[t]=i},Xt=function(e,t,i){return e[t](i)},Qt=function(e,t,i,r){return e[t](r.fp,i)},Zt=function(e,t,i){return e.setAttribute(t,i)},Jt=function(e,t){return M(e[t])?Xt:A(e[t])&&e.setAttribute?Zt:Yt},ei=function(e,t){return t.set(t.t,t.p,Math.round(1e6*(t.s+t.c*e))/1e6,t)},ti=function(e,t){return t.set(t.t,t.p,!!(t.s+t.c*e),t)},ii=function(e,t){var i=t._pt,r="";if(!e&&t.b)r=t.b;else if(1===e&&t.e)r=t.e;else{for(;i;)r=i.p+(i.m?i.m(i.s+i.c*e):Math.round(1e4*(i.s+i.c*e))/1e4)+r,i=i._next;r+=t.c}t.set(t.t,t.p,r,t)},ri=function(e,t){for(var i=t._pt;i;)i.r(e,i.d),i=i._next},ni=function(e,t,i,r){for(var n,s=this._pt;s;)n=s._next,s.p===r&&s.modifier(e,t,i),s=n},si=function(e){for(var t,i,r=this._pt;r;)i=r._next,r.p===e&&!r.op||r.op===e?Ee(this,r,"_pt"):r.dep||(t=1),r=i;return!t},ai=function(e,t,i,r){r.mSet(e,t,r.m.call(r.tween,i,r.mt),r)},oi=function(e){for(var t,i,r,n,s=e._pt;s;){for(t=s._next,i=r;i&&i.pr>s.pr;)i=i._next;(s._prev=i?i._prev:n)?s._prev._next=s:r=s,(s._next=i)?i._prev=s:n=s,s=t}e._pt=r},li=function(){function e(e,t,i,r,n,s,a,o,l){this.t=t,this.s=r,this.c=n,this.p=i,this.r=s||ei,this.d=a||this,this.set=o||Yt,this.pr=l||0,this._next=e,e&&(e._prev=this)}return e.prototype.modifier=function(e,t,i){this.mSet=this.mSet||this.set,this.set=ai,this.m=e,this.mt=i,this.tween=t},e}();he(se+"parent,duration,ease,delay,overwrite,runBackwards,startAt,yoyo,immediateRender,repeat,repeatDelay,data,paused,reversed,lazy,callbackScope,stringFilter,id,yoyoEase,stagger,inherit,repeatRefresh,keyframes,autoRevert,scrollTrigger",function(e){return Z[e]=1}),z.TweenMax=z.TweenLite=Kt,z.TimelineLite=z.TimelineMax=Nt,a=new Nt({sortChildren:!1,defaults:m,autoRemoveChildren:!0,id:"root",smoothChildTiming:!0}),p.stringFilter=St;var hi=[],ci={},di=[],ui=0,fi=0,pi=function(e){return(ci[e]||di).map(function(e){return e()})},mi=function(){var e=Date.now(),t=[];e-ui>2&&(pi("matchMediaInit"),hi.forEach(function(e){var i,r,n,s,a=e.queries,l=e.conditions;for(r in a)(i=o.matchMedia(a[r]).matches)&&(n=1),i!==l[r]&&(l[r]=i,s=1);s&&(e.revert(),n&&t.push(e))}),pi("matchMediaRevert"),t.forEach(function(e){return e.onMatch(e,function(t){return e.add(null,t)})}),ui=e,pi("matchMedia"))},gi=function(){function e(e,t){this.selector=t&&Ze(t),this.data=[],this._r=[],this.isReverted=!1,this.id=fi++,e&&this.add(e)}var t=e.prototype;return t.add=function(e,t,i){M(e)&&(i=t,t=e,e=M);var r=this,n=function(){var e,n=s,a=r.selector;return n&&n!==r&&n.data.push(r),i&&(r.selector=Ze(i)),s=r,e=t.apply(r,arguments),M(e)&&r._r.push(e),s=n,r.selector=a,r.isReverted=!1,e};return r.last=n,e===M?n(r,function(e){return r.add(null,e)}):e?r[e]=n:n},t.ignore=function(e){var t=s;s=null,e(this),s=t},t.getTweens=function(){var t=[];return this.data.forEach(function(i){return i instanceof e?t.push.apply(t,i.getTweens()):i instanceof Kt&&!(i.parent&&"nested"===i.parent.data)&&t.push(i)}),t},t.clear=function(){this._r.length=this.data.length=0},t.kill=function(e,t){var i=this;if(e?function(){for(var t,r=i.getTweens(),n=i.data.length;n--;)"isFlip"===(t=i.data[n]).data&&(t.revert(),t.getChildren(!0,!0,!1).forEach(function(e){return r.splice(r.indexOf(e),1)}));for(r.map(function(e){return{g:e._dur||e._delay||e._sat&&!e._sat.vars.immediateRender?e.globalTime(0):-1/0,t:e}}).sort(function(e,t){return t.g-e.g||-1/0}).forEach(function(t){return t.t.revert(e)}),n=i.data.length;n--;)(t=i.data[n])instanceof Nt?"nested"!==t.data&&(t.scrollTrigger&&t.scrollTrigger.revert(),t.kill()):!(t instanceof Kt)&&t.revert&&t.revert(e);i._r.forEach(function(t){return t(e,i)}),i.isReverted=!0}():this.data.forEach(function(e){return e.kill&&e.kill()}),this.clear(),t)for(var r=hi.length;r--;)hi[r].id===this.id&&hi.splice(r,1)},t.revert=function(e){this.kill(e||{})},e}(),vi=function(){function e(e){this.contexts=[],this.scope=e,s&&s.data.push(this)}var t=e.prototype;return t.add=function(e,t,i){L(e)||(e={matches:e});var r,n,a,l=new gi(0,i||this.scope),h=l.conditions={};for(n in s&&!l.selector&&(l.selector=s.selector),this.contexts.push(l),t=l.add("onMatch",t),l.queries=e,e)"all"===n?a=1:(r=o.matchMedia(e[n]))&&(hi.indexOf(l)<0&&hi.push(l),(h[n]=r.matches)&&(a=1),r.addListener?r.addListener(mi):r.addEventListener("change",mi));return a&&t(l,function(e){return l.add(null,e)}),this},t.revert=function(e){this.kill(e||{})},t.kill=function(e){this.contexts.forEach(function(t){return t.kill(e,!0)})},e}(),yi={registerPlugin:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach(function(e){return dt(e)})},timeline:function(e){return new Nt(e)},getTweensOf:function(e,t){return a.getTweensOf(e,t)},getProperty:function(e,t,i,r){E(e)&&(e=Qe(e)[0]);var n=oe(e||{}).get,s=i?ve:ge;return"native"===i&&(i=""),e?t?s((te[t]&&te[t].get||n)(e,t,i,r)):function(t,i,r){return s((te[t]&&te[t].get||n)(e,t,i,r))}:e},quickSetter:function(e,t,i){if((e=Qe(e)).length>1){var r=e.map(function(e){return bi.quickSetter(e,t,i)}),n=r.length;return function(e){for(var t=n;t--;)r[t](e)}}e=e[0]||{};var s=te[t],a=oe(e),o=a.harness&&(a.harness.aliases||{})[t]||t,l=s?function(t){var r=new s;u._pt=0,r.init(e,i?t+i:t,u,0,[e]),r.render(1,r),u._pt&&ri(1,u)}:a.set(e,o);return s?l:function(t){return l(e,o,i?t+i:t,a,1)}},quickTo:function(e,t,i){var r,n=bi.to(e,ye(((r={})[t]="+=0.1",r.paused=!0,r.stagger=0,r),i||{})),s=function(e,i,r){return n.resetTo(t,e,i,r)};return s.tween=n,s},isTweening:function(e){return a.getTweensOf(e,!0).length>0},defaults:function(e){return e&&e.ease&&(e.ease=Ct(e.ease,m.ease)),Se(m,e||{})},config:function(e){return Se(p,e||{})},registerEffect:function(e){var t=e.name,i=e.effect,r=e.plugins,n=e.defaults,s=e.extendTimeline;(r||"").split(",").forEach(function(e){return e&&!te[e]&&!z[e]&&q(t+" effect requires "+e+" plugin.")}),ie[t]=function(e,t,r){return i(Qe(e),ye(t||{},n),r)},s&&(Nt.prototype[t]=function(e,i,r){return this.add(ie[t](e,L(i)?i:(r=i)&&{},this),r)})},registerEase:function(e,t){xt[e]=Ct(t)},parseEase:function(e,t){return arguments.length?Ct(e,t):xt},getById:function(e){return a.getById(e)},exportRoot:function(e,t){void 0===e&&(e={});var i,r,n=new Nt(e);for(n.smoothChildTiming=C(e.smoothChildTiming),a.remove(n),n._dp=0,n._time=n._tTime=a._time,i=a._first;i;)r=i._next,!t&&!i._dur&&i instanceof Kt&&i.vars.onComplete===i._targets[0]||Oe(n,i,i._start-i._delay),i=r;return Oe(a,n,0),n},context:function(e,t){return e?new gi(e,t):s},matchMedia:function(e){return new vi(e)},matchMediaRefresh:function(){return hi.forEach(function(e){var t,i,r=e.conditions;for(i in r)r[i]&&(r[i]=!1,t=1);t&&e.revert()})||mi()},addEventListener:function(e,t){var i=ci[e]||(ci[e]=[]);~i.indexOf(t)||i.push(t)},removeEventListener:function(e,t){var i=ci[e],r=i&&i.indexOf(t);r>=0&&i.splice(r,1)},utils:{wrap:function e(t,i,r){var n=i-t;return k(t)?nt(t,e(0,t.length),i):We(r,function(e){return(n+(e-t)%n)%n+t})},wrapYoyo:function e(t,i,r){var n=i-t,s=2*n;return k(t)?nt(t,e(0,t.length-1),i):We(r,function(e){return t+((e=(s+(e-t)%s)%s||0)>n?s-e:e)})},distribute:et,random:rt,snap:it,normalize:function(e,t,i){return at(e,t,0,1,i)},getUnit:je,clamp:function(e,t,i){return We(i,function(i){return qe(e,t,i)})},splitColor:mt,toArray:Qe,selector:Ze,mapRange:at,pipe:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reduce(function(e,t){return t(e)},e)}},unitize:function(e,t){return function(i){return e(parseFloat(i))+(t||je(i))}},interpolate:function e(t,i,r,n){var s=isNaN(t+i)?0:function(e){return(1-e)*t+e*i};if(!s){var a,o,l,h,c,d=E(t),u={};if(!0===r&&(n=1)&&(r=null),d)t={p:t},i={p:i};else if(k(t)&&!k(i)){for(l=[],h=t.length,c=h-2,o=1;o<h;o++)l.push(e(t[o-1],t[o]));h--,s=function(e){e*=h;var t=Math.min(c,~~e);return l[t](e-t)},r=i}else n||(t=_e(k(t)?[]:{},t));if(!l){for(a in i)Gt.call(u,t,a,"get",i[a]);s=function(e){return ri(e,u)||(d?t.p:t)}}}return We(r,s)},shuffle:Je},install:$,effects:ie,ticker:bt,updateRoot:Nt.updateRoot,plugins:te,globalTimeline:a,core:{PropTween:li,globals:j,Tween:Kt,Timeline:Nt,Animation:Ot,getCache:oe,_removeLinkedListItem:Ee,reverting:function(){return n},context:function(e){return e&&s&&(s.data.push(e),e._ctx=s),s},suppressOverwrites:function(e){return i=e}}};he("to,from,fromTo,delayedCall,set,killTweensOf",function(e){return yi[e]=Kt[e]}),bt.add(Nt.updateRoot),u=yi.to({},{duration:0});var _i=function(e,t){for(var i=e._pt;i&&i.p!==t&&i.op!==t&&i.fp!==t;)i=i._next;return i},Si=function(e,t){return{name:e,rawVars:1,init:function(e,i,r){r._onInit=function(e){var r,n;if(E(i)&&(r={},he(i,function(e){return r[e]=1}),i=r),t){for(n in r={},i)r[n]=t(i[n]);i=r}!function(e,t){var i,r,n,s=e._targets;for(i in t)for(r=s.length;r--;)(n=e._ptLookup[r][i])&&(n=n.d)&&(n._pt&&(n=_i(n,i)),n&&n.modifier&&n.modifier(t[i],e,s[r],i))}(e,i)}}}},bi=yi.registerPlugin({name:"attr",init:function(e,t,i,r,n){var s,a,o;for(s in this.tween=i,t)o=e.getAttribute(s)||"",(a=this.add(e,"setAttribute",(o||0)+"",t[s],r,n,0,0,s)).op=s,a.b=o,this._props.push(s)},render:function(e,t){for(var i=t._pt;i;)n?i.set(i.t,i.p,i.b,i):i.r(e,i.d),i=i._next}},{name:"endArray",init:function(e,t){for(var i=t.length;i--;)this.add(e,i,e[i]||0,t[i],0,0,0,0,0,1)}},Si("roundProps",tt),Si("modifiers"),Si("snap",it))||yi;Kt.version=Nt.version=bi.version="3.12.7",c=1,R()&&Tt();xt.Power0,xt.Power1,xt.Power2,xt.Power3,xt.Power4,xt.Linear,xt.Quad,xt.Cubic,xt.Quart,xt.Quint,xt.Strong,xt.Elastic,xt.Back,xt.SteppedEase,xt.Bounce,xt.Sine,xt.Expo,xt.Circ;var Ti,xi,Ei,Mi,wi,Ai,Li,Ci,Ri={},Pi=180/Math.PI,Ii=Math.PI/180,Di=Math.atan2,ki=/([A-Z])/g,Oi=/(left|right|width|margin|padding|x)/i,Ui=/[\s,\(]\S/,Ni={autoAlpha:"opacity,visibility",scale:"scaleX,scaleY",alpha:"opacity"},Fi=function(e,t){return t.set(t.t,t.p,Math.round(1e4*(t.s+t.c*e))/1e4+t.u,t)},Bi=function(e,t){return t.set(t.t,t.p,1===e?t.e:Math.round(1e4*(t.s+t.c*e))/1e4+t.u,t)},Vi=function(e,t){return t.set(t.t,t.p,e?Math.round(1e4*(t.s+t.c*e))/1e4+t.u:t.b,t)},Gi=function(e,t){var i=t.s+t.c*e;t.set(t.t,t.p,~~(i+(i<0?-.5:.5))+t.u,t)},zi=function(e,t){return t.set(t.t,t.p,e?t.e:t.b,t)},Hi=function(e,t){return t.set(t.t,t.p,1!==e?t.b:t.e,t)},$i=function(e,t,i){return e.style[t]=i},Wi=function(e,t,i){return e.style.setProperty(t,i)},qi=function(e,t,i){return e._gsap[t]=i},ji=function(e,t,i){return e._gsap.scaleX=e._gsap.scaleY=i},Ki=function(e,t,i,r,n){var s=e._gsap;s.scaleX=s.scaleY=i,s.renderTransform(n,s)},Yi=function(e,t,i,r,n){var s=e._gsap;s[t]=i,s.renderTransform(n,s)},Xi="transform",Qi=Xi+"Origin",Zi=function e(t,i){var r=this,n=this.target,s=n.style,a=n._gsap;if(t in Ri&&s){if(this.tfm=this.tfm||{},"transform"===t)return Ni.transform.split(",").forEach(function(t){return e.call(r,t,i)});if(~(t=Ni[t]||t).indexOf(",")?t.split(",").forEach(function(e){return r.tfm[e]=gr(n,e)}):this.tfm[t]=a.x?a[t]:gr(n,t),t===Qi&&(this.tfm.zOrigin=a.zOrigin),this.props.indexOf(Xi)>=0)return;a.svg&&(this.svgo=n.getAttribute("data-svg-origin"),this.props.push(Qi,i,"")),t=Xi}(s||i)&&this.props.push(t,i,s[t])},Ji=function(e){e.translate&&(e.removeProperty("translate"),e.removeProperty("scale"),e.removeProperty("rotate"))},er=function(){var e,t,i=this.props,r=this.target,n=r.style,s=r._gsap;for(e=0;e<i.length;e+=3)i[e+1]?2===i[e+1]?r[i[e]](i[e+2]):r[i[e]]=i[e+2]:i[e+2]?n[i[e]]=i[e+2]:n.removeProperty("--"===i[e].substr(0,2)?i[e]:i[e].replace(ki,"-$1").toLowerCase());if(this.tfm){for(t in this.tfm)s[t]=this.tfm[t];s.svg&&(s.renderTransform(),r.setAttribute("data-svg-origin",this.svgo||"")),(e=Li())&&e.isStart||n[Xi]||(Ji(n),s.zOrigin&&n[Qi]&&(n[Qi]+=" "+s.zOrigin+"px",s.zOrigin=0,s.renderTransform()),s.uncache=1)}},tr=function(e,t){var i={target:e,props:[],revert:er,save:Zi};return e._gsap||bi.core.getCache(e),t&&e.style&&e.nodeType&&t.split(",").forEach(function(e){return i.save(e)}),i},ir=function(e,t){var i=xi.createElementNS?xi.createElementNS((t||"http://www.w3.org/1999/xhtml").replace(/^https/,"http"),e):xi.createElement(e);return i&&i.style?i:xi.createElement(e)},rr=function e(t,i,r){var n=getComputedStyle(t);return n[i]||n.getPropertyValue(i.replace(ki,"-$1").toLowerCase())||n.getPropertyValue(i)||!r&&e(t,sr(i)||i,1)||""},nr="O,Moz,ms,Ms,Webkit".split(","),sr=function(e,t,i){var r=(t||wi).style,n=5;if(e in r&&!i)return e;for(e=e.charAt(0).toUpperCase()+e.substr(1);n--&&!(nr[n]+e in r););return n<0?null:(3===n?"ms":n>=0?nr[n]:"")+e},ar=function(){"undefined"!=typeof window&&window.document&&(Ti=window,xi=Ti.document,Ei=xi.documentElement,wi=ir("div")||{style:{}},ir("div"),Xi=sr(Xi),Qi=Xi+"Origin",wi.style.cssText="border-width:0;line-height:0;position:absolute;padding:0",Ci=!!sr("perspective"),Li=bi.core.reverting,Mi=1)},or=function(e){var t,i=e.ownerSVGElement,r=ir("svg",i&&i.getAttribute("xmlns")||"http://www.w3.org/2000/svg"),n=e.cloneNode(!0);n.style.display="block",r.appendChild(n),Ei.appendChild(r);try{t=n.getBBox()}catch(e){}return r.removeChild(n),Ei.removeChild(r),t},lr=function(e,t){for(var i=t.length;i--;)if(e.hasAttribute(t[i]))return e.getAttribute(t[i])},hr=function(e){var t,i;try{t=e.getBBox()}catch(r){t=or(e),i=1}return t&&(t.width||t.height)||i||(t=or(e)),!t||t.width||t.x||t.y?t:{x:+lr(e,["x","cx","x1"])||0,y:+lr(e,["y","cy","y1"])||0,width:0,height:0}},cr=function(e){return!(!e.getCTM||e.parentNode&&!e.ownerSVGElement||!hr(e))},dr=function(e,t){if(t){var i,r=e.style;t in Ri&&t!==Qi&&(t=Xi),r.removeProperty?("ms"!==(i=t.substr(0,2))&&"webkit"!==t.substr(0,6)||(t="-"+t),r.removeProperty("--"===i?t:t.replace(ki,"-$1").toLowerCase())):r.removeAttribute(t)}},ur=function(e,t,i,r,n,s){var a=new li(e._pt,t,i,0,1,s?Hi:zi);return e._pt=a,a.b=r,a.e=n,e._props.push(i),a},fr={deg:1,rad:1,turn:1},pr={grid:1,flex:1},mr=function e(t,i,r,n){var s,a,o,l,h=parseFloat(r)||0,c=(r+"").trim().substr((h+"").length)||"px",d=wi.style,u=Oi.test(i),f="svg"===t.tagName.toLowerCase(),p=(f?"client":"offset")+(u?"Width":"Height"),m=100,g="px"===n,v="%"===n;if(n===c||!h||fr[n]||fr[c])return h;if("px"!==c&&!g&&(h=e(t,i,r,"px")),l=t.getCTM&&cr(t),(v||"%"===c)&&(Ri[i]||~i.indexOf("adius")))return s=l?t.getBBox()[u?"width":"height"]:t[p],ce(v?h/s*m:h/100*s);if(d[u?"width":"height"]=m+(g?c:n),a="rem"!==n&&~i.indexOf("adius")||"em"===n&&t.appendChild&&!f?t:t.parentNode,l&&(a=(t.ownerSVGElement||{}).parentNode),a&&a!==xi&&a.appendChild||(a=xi.body),(o=a._gsap)&&v&&o.width&&u&&o.time===bt.time&&!o.uncache)return ce(h/o.width*m);if(!v||"height"!==i&&"width"!==i)(v||"%"===c)&&!pr[rr(a,"display")]&&(d.position=rr(t,"position")),a===t&&(d.position="static"),a.appendChild(wi),s=wi[p],a.removeChild(wi),d.position="absolute";else{var y=t.style[i];t.style[i]=m+n,s=t[p],y?t.style[i]=y:dr(t,i)}return u&&v&&((o=oe(a)).time=bt.time,o.width=a[p]),ce(g?s*h/m:s&&h?m/s*h:0)},gr=function(e,t,i,r){var n;return Mi||ar(),t in Ni&&"transform"!==t&&~(t=Ni[t]).indexOf(",")&&(t=t.split(",")[0]),Ri[t]&&"transform"!==t?(n=Lr(e,r),n="transformOrigin"!==t?n[t]:n.svg?n.origin:Cr(rr(e,Qi))+" "+n.zOrigin+"px"):(!(n=e.style[t])||"auto"===n||r||~(n+"").indexOf("calc("))&&(n=br[t]&&br[t](e,t,i)||rr(e,t)||le(e,t)||("opacity"===t?1:0)),i&&!~(n+"").trim().indexOf(" ")?mr(e,t,n,i)+i:n},vr=function(e,t,i,r){if(!i||"none"===i){var n=sr(t,e,1),s=n&&rr(e,n,1);s&&s!==i?(t=n,i=s):"borderColor"===t&&(i=rr(e,"borderTopColor"))}var a,o,l,h,c,d,u,f,m,g,v,y=new li(this._pt,e.style,t,0,1,ii),_=0,S=0;if(y.b=i,y.e=r,i+="","auto"===(r+="")&&(d=e.style[t],e.style[t]=r,r=rr(e,t)||r,d?e.style[t]=d:dr(e,t)),St(a=[i,r]),r=a[1],l=(i=a[0]).match(N)||[],(r.match(N)||[]).length){for(;o=N.exec(r);)u=o[0],m=r.substring(_,o.index),c?c=(c+1)%5:"rgba("!==m.substr(-5)&&"hsla("!==m.substr(-5)||(c=1),u!==(d=l[S++]||"")&&(h=parseFloat(d)||0,v=d.substr((h+"").length),"="===u.charAt(1)&&(u=ue(h,u)+v),f=parseFloat(u),g=u.substr((f+"").length),_=N.lastIndex-g.length,g||(g=g||p.units[t]||v,_===r.length&&(r+=g,y.e+=g)),v!==g&&(h=mr(e,t,d,g)||0),y._pt={_next:y._pt,p:m||1===S?m:",",s:h,c:f-h,m:c&&c<4||"zIndex"===t?Math.round:0});y.c=_<r.length?r.substring(_,r.length):""}else y.r="display"===t&&"none"===r?Hi:zi;return B.test(r)&&(y.e=0),this._pt=y,y},yr={top:"0%",bottom:"100%",left:"0%",right:"100%",center:"50%"},_r=function(e){var t=e.split(" "),i=t[0],r=t[1]||"50%";return"top"!==i&&"bottom"!==i&&"left"!==r&&"right"!==r||(e=i,i=r,r=e),t[0]=yr[i]||i,t[1]=yr[r]||r,t.join(" ")},Sr=function(e,t){if(t.tween&&t.tween._time===t.tween._dur){var i,r,n,s=t.t,a=s.style,o=t.u,l=s._gsap;if("all"===o||!0===o)a.cssText="",r=1;else for(n=(o=o.split(",")).length;--n>-1;)i=o[n],Ri[i]&&(r=1,i="transformOrigin"===i?Qi:Xi),dr(s,i);r&&(dr(s,Xi),l&&(l.svg&&s.removeAttribute("transform"),a.scale=a.rotate=a.translate="none",Lr(s,1),l.uncache=1,Ji(a)))}},br={clearProps:function(e,t,i,r,n){if("isFromStart"!==n.data){var s=e._pt=new li(e._pt,t,i,0,0,Sr);return s.u=r,s.pr=-10,s.tween=n,e._props.push(i),1}}},Tr=[1,0,0,1,0,0],xr={},Er=function(e){return"matrix(1, 0, 0, 1, 0, 0)"===e||"none"===e||!e},Mr=function(e){var t=rr(e,Xi);return Er(t)?Tr:t.substr(7).match(U).map(ce)},wr=function(e,t){var i,r,n,s,a=e._gsap||oe(e),o=e.style,l=Mr(e);return a.svg&&e.getAttribute("transform")?"1,0,0,1,0,0"===(l=[(n=e.transform.baseVal.consolidate().matrix).a,n.b,n.c,n.d,n.e,n.f]).join(",")?Tr:l:(l!==Tr||e.offsetParent||e===Ei||a.svg||(n=o.display,o.display="block",(i=e.parentNode)&&(e.offsetParent||e.getBoundingClientRect().width)||(s=1,r=e.nextElementSibling,Ei.appendChild(e)),l=Mr(e),n?o.display=n:dr(e,"display"),s&&(r?i.insertBefore(e,r):i?i.appendChild(e):Ei.removeChild(e))),t&&l.length>6?[l[0],l[1],l[4],l[5],l[12],l[13]]:l)},Ar=function(e,t,i,r,n,s){var a,o,l,h=e._gsap,c=n||wr(e,!0),d=h.xOrigin||0,u=h.yOrigin||0,f=h.xOffset||0,p=h.yOffset||0,m=c[0],g=c[1],v=c[2],y=c[3],_=c[4],S=c[5],b=t.split(" "),T=parseFloat(b[0])||0,x=parseFloat(b[1])||0;i?c!==Tr&&(o=m*y-g*v)&&(l=T*(-g/o)+x*(m/o)-(m*S-g*_)/o,T=T*(y/o)+x*(-v/o)+(v*S-y*_)/o,x=l):(T=(a=hr(e)).x+(~b[0].indexOf("%")?T/100*a.width:T),x=a.y+(~(b[1]||b[0]).indexOf("%")?x/100*a.height:x)),r||!1!==r&&h.smooth?(_=T-d,S=x-u,h.xOffset=f+(_*m+S*v)-_,h.yOffset=p+(_*g+S*y)-S):h.xOffset=h.yOffset=0,h.xOrigin=T,h.yOrigin=x,h.smooth=!!r,h.origin=t,h.originIsAbsolute=!!i,e.style[Qi]="0px 0px",s&&(ur(s,h,"xOrigin",d,T),ur(s,h,"yOrigin",u,x),ur(s,h,"xOffset",f,h.xOffset),ur(s,h,"yOffset",p,h.yOffset)),e.setAttribute("data-svg-origin",T+" "+x)},Lr=function(e,t){var i=e._gsap||new kt(e);if("x"in i&&!t&&!i.uncache)return i;var r,n,s,a,o,l,h,c,d,u,f,m,g,v,y,_,S,b,T,x,E,M,w,A,L,C,R,P,D,k,O,U,N=e.style,F=i.scaleX<0,B="px",V="deg",G=getComputedStyle(e),z=rr(e,Qi)||"0";return r=n=s=l=h=c=d=u=f=0,a=o=1,i.svg=!(!e.getCTM||!cr(e)),G.translate&&("none"===G.translate&&"none"===G.scale&&"none"===G.rotate||(N[Xi]=("none"!==G.translate?"translate3d("+(G.translate+" 0 0").split(" ").slice(0,3).join(", ")+") ":"")+("none"!==G.rotate?"rotate("+G.rotate+") ":"")+("none"!==G.scale?"scale("+G.scale.split(" ").join(",")+") ":"")+("none"!==G[Xi]?G[Xi]:"")),N.scale=N.rotate=N.translate="none"),v=wr(e,i.svg),i.svg&&(i.uncache?(L=e.getBBox(),z=i.xOrigin-L.x+"px "+(i.yOrigin-L.y)+"px",A=""):A=!t&&e.getAttribute("data-svg-origin"),Ar(e,A||z,!!A||i.originIsAbsolute,!1!==i.smooth,v)),m=i.xOrigin||0,g=i.yOrigin||0,v!==Tr&&(b=v[0],T=v[1],x=v[2],E=v[3],r=M=v[4],n=w=v[5],6===v.length?(a=Math.sqrt(b*b+T*T),o=Math.sqrt(E*E+x*x),l=b||T?Di(T,b)*Pi:0,(d=x||E?Di(x,E)*Pi+l:0)&&(o*=Math.abs(Math.cos(d*Ii))),i.svg&&(r-=m-(m*b+g*x),n-=g-(m*T+g*E))):(U=v[6],k=v[7],R=v[8],P=v[9],D=v[10],O=v[11],r=v[12],n=v[13],s=v[14],h=(y=Di(U,D))*Pi,y&&(A=M*(_=Math.cos(-y))+R*(S=Math.sin(-y)),L=w*_+P*S,C=U*_+D*S,R=M*-S+R*_,P=w*-S+P*_,D=U*-S+D*_,O=k*-S+O*_,M=A,w=L,U=C),c=(y=Di(-x,D))*Pi,y&&(_=Math.cos(-y),O=E*(S=Math.sin(-y))+O*_,b=A=b*_-R*S,T=L=T*_-P*S,x=C=x*_-D*S),l=(y=Di(T,b))*Pi,y&&(A=b*(_=Math.cos(y))+T*(S=Math.sin(y)),L=M*_+w*S,T=T*_-b*S,w=w*_-M*S,b=A,M=L),h&&Math.abs(h)+Math.abs(l)>359.9&&(h=l=0,c=180-c),a=ce(Math.sqrt(b*b+T*T+x*x)),o=ce(Math.sqrt(w*w+U*U)),y=Di(M,w),d=Math.abs(y)>2e-4?y*Pi:0,f=O?1/(O<0?-O:O):0),i.svg&&(A=e.getAttribute("transform"),i.forceCSS=e.setAttribute("transform","")||!Er(rr(e,Xi)),A&&e.setAttribute("transform",A))),Math.abs(d)>90&&Math.abs(d)<270&&(F?(a*=-1,d+=l<=0?180:-180,l+=l<=0?180:-180):(o*=-1,d+=d<=0?180:-180)),t=t||i.uncache,i.x=r-((i.xPercent=r&&(!t&&i.xPercent||(Math.round(e.offsetWidth/2)===Math.round(-r)?-50:0)))?e.offsetWidth*i.xPercent/100:0)+B,i.y=n-((i.yPercent=n&&(!t&&i.yPercent||(Math.round(e.offsetHeight/2)===Math.round(-n)?-50:0)))?e.offsetHeight*i.yPercent/100:0)+B,i.z=s+B,i.scaleX=ce(a),i.scaleY=ce(o),i.rotation=ce(l)+V,i.rotationX=ce(h)+V,i.rotationY=ce(c)+V,i.skewX=d+V,i.skewY=u+V,i.transformPerspective=f+B,(i.zOrigin=parseFloat(z.split(" ")[2])||!t&&i.zOrigin||0)&&(N[Qi]=Cr(z)),i.xOffset=i.yOffset=0,i.force3D=p.force3D,i.renderTransform=i.svg?Ur:Ci?Or:Pr,i.uncache=0,i},Cr=function(e){return(e=e.split(" "))[0]+" "+e[1]},Rr=function(e,t,i){var r=je(t);return ce(parseFloat(t)+parseFloat(mr(e,"x",i+"px",r)))+r},Pr=function(e,t){t.z="0px",t.rotationY=t.rotationX="0deg",t.force3D=0,Or(e,t)},Ir="0deg",Dr="0px",kr=") ",Or=function(e,t){var i=t||this,r=i.xPercent,n=i.yPercent,s=i.x,a=i.y,o=i.z,l=i.rotation,h=i.rotationY,c=i.rotationX,d=i.skewX,u=i.skewY,f=i.scaleX,p=i.scaleY,m=i.transformPerspective,g=i.force3D,v=i.target,y=i.zOrigin,_="",S="auto"===g&&e&&1!==e||!0===g;if(y&&(c!==Ir||h!==Ir)){var b,T=parseFloat(h)*Ii,x=Math.sin(T),E=Math.cos(T);T=parseFloat(c)*Ii,b=Math.cos(T),s=Rr(v,s,x*b*-y),a=Rr(v,a,-Math.sin(T)*-y),o=Rr(v,o,E*b*-y+y)}m!==Dr&&(_+="perspective("+m+kr),(r||n)&&(_+="translate("+r+"%, "+n+"%) "),(S||s!==Dr||a!==Dr||o!==Dr)&&(_+=o!==Dr||S?"translate3d("+s+", "+a+", "+o+") ":"translate("+s+", "+a+kr),l!==Ir&&(_+="rotate("+l+kr),h!==Ir&&(_+="rotateY("+h+kr),c!==Ir&&(_+="rotateX("+c+kr),d===Ir&&u===Ir||(_+="skew("+d+", "+u+kr),1===f&&1===p||(_+="scale("+f+", "+p+kr),v.style[Xi]=_||"translate(0, 0)"},Ur=function(e,t){var i,r,n,s,a,o=t||this,l=o.xPercent,h=o.yPercent,c=o.x,d=o.y,u=o.rotation,f=o.skewX,p=o.skewY,m=o.scaleX,g=o.scaleY,v=o.target,y=o.xOrigin,_=o.yOrigin,S=o.xOffset,b=o.yOffset,T=o.forceCSS,x=parseFloat(c),E=parseFloat(d);u=parseFloat(u),f=parseFloat(f),(p=parseFloat(p))&&(f+=p=parseFloat(p),u+=p),u||f?(u*=Ii,f*=Ii,i=Math.cos(u)*m,r=Math.sin(u)*m,n=Math.sin(u-f)*-g,s=Math.cos(u-f)*g,f&&(p*=Ii,a=Math.tan(f-p),n*=a=Math.sqrt(1+a*a),s*=a,p&&(a=Math.tan(p),i*=a=Math.sqrt(1+a*a),r*=a)),i=ce(i),r=ce(r),n=ce(n),s=ce(s)):(i=m,s=g,r=n=0),(x&&!~(c+"").indexOf("px")||E&&!~(d+"").indexOf("px"))&&(x=mr(v,"x",c,"px"),E=mr(v,"y",d,"px")),(y||_||S||b)&&(x=ce(x+y-(y*i+_*n)+S),E=ce(E+_-(y*r+_*s)+b)),(l||h)&&(a=v.getBBox(),x=ce(x+l/100*a.width),E=ce(E+h/100*a.height)),a="matrix("+i+","+r+","+n+","+s+","+x+","+E+")",v.setAttribute("transform",a),T&&(v.style[Xi]=a)},Nr=function(e,t,i,r,n){var s,a,o=360,l=E(n),h=parseFloat(n)*(l&&~n.indexOf("rad")?Pi:1)-r,c=r+h+"deg";return l&&("short"===(s=n.split("_")[1])&&(h%=o)!==h%180&&(h+=h<0?o:-360),"cw"===s&&h<0?h=(h+36e9)%o-~~(h/o)*o:"ccw"===s&&h>0&&(h=(h-36e9)%o-~~(h/o)*o)),e._pt=a=new li(e._pt,t,i,r,h,Bi),a.e=c,a.u="deg",e._props.push(i),a},Fr=function(e,t){for(var i in t)e[i]=t[i];return e},Br=function(e,t,i){var r,n,s,a,o,l,h,c=Fr({},i._gsap),d=i.style;for(n in c.svg?(s=i.getAttribute("transform"),i.setAttribute("transform",""),d[Xi]=t,r=Lr(i,1),dr(i,Xi),i.setAttribute("transform",s)):(s=getComputedStyle(i)[Xi],d[Xi]=t,r=Lr(i,1),d[Xi]=s),Ri)(s=c[n])!==(a=r[n])&&"perspective,force3D,transformOrigin,svgOrigin".indexOf(n)<0&&(o=je(s)!==(h=je(a))?mr(i,n,s,h):parseFloat(s),l=parseFloat(a),e._pt=new li(e._pt,r,n,o,l-o,Fi),e._pt.u=h||0,e._props.push(n));Fr(r,c)};he("padding,margin,Width,Radius",function(e,t){var i="Top",r="Right",n="Bottom",s="Left",a=(t<3?[i,r,n,s]:[i+s,i+r,n+r,n+s]).map(function(i){return t<2?e+i:"border"+i+e});br[t>1?"border"+e:e]=function(e,t,i,r,n){var s,o;if(arguments.length<4)return s=a.map(function(t){return gr(e,t,i)}),5===(o=s.join(" ")).split(s[0]).length?s[0]:o;s=(r+"").split(" "),o={},a.forEach(function(e,t){return o[e]=s[t]=s[t]||s[(t-1)/2|0]}),e.init(t,o,n)}});var Vr,Gr,zr,Hr={name:"css",register:ar,targetTest:function(e){return e.style&&e.nodeType},init:function(e,t,i,r,n){var s,a,o,l,h,c,d,u,f,m,g,v,y,_,S,b,T=this._props,x=e.style,M=i.vars.startAt;for(d in Mi||ar(),this.styles=this.styles||tr(e),b=this.styles.props,this.tween=i,t)if("autoRound"!==d&&(a=t[d],!te[d]||!zt(d,t,i,r,e,n)))if(h=typeof a,c=br[d],"function"===h&&(h=typeof(a=a.call(i,r,e,n))),"string"===h&&~a.indexOf("random(")&&(a=st(a)),c)c(this,e,d,a,i)&&(S=1);else if("--"===d.substr(0,2))s=(getComputedStyle(e).getPropertyValue(d)+"").trim(),a+="",yt.lastIndex=0,yt.test(s)||(u=je(s),f=je(a)),f?u!==f&&(s=mr(e,d,s,f)+f):u&&(a+=u),this.add(x,"setProperty",s,a,r,n,0,0,d),T.push(d),b.push(d,0,x[d]);else if("undefined"!==h){if(M&&d in M?(s="function"==typeof M[d]?M[d].call(i,r,e,n):M[d],E(s)&&~s.indexOf("random(")&&(s=st(s)),je(s+"")||"auto"===s||(s+=p.units[d]||je(gr(e,d))||""),"="===(s+"").charAt(1)&&(s=gr(e,d))):s=gr(e,d),l=parseFloat(s),(m="string"===h&&"="===a.charAt(1)&&a.substr(0,2))&&(a=a.substr(2)),o=parseFloat(a),d in Ni&&("autoAlpha"===d&&(1===l&&"hidden"===gr(e,"visibility")&&o&&(l=0),b.push("visibility",0,x.visibility),ur(this,x,"visibility",l?"inherit":"hidden",o?"inherit":"hidden",!o)),"scale"!==d&&"transform"!==d&&~(d=Ni[d]).indexOf(",")&&(d=d.split(",")[0])),g=d in Ri)if(this.styles.save(d),v||((y=e._gsap).renderTransform&&!t.parseTransform||Lr(e,t.parseTransform),_=!1!==t.smoothOrigin&&y.smooth,(v=this._pt=new li(this._pt,x,Xi,0,1,y.renderTransform,y,0,-1)).dep=1),"scale"===d)this._pt=new li(this._pt,y,"scaleY",y.scaleY,(m?ue(y.scaleY,m+o):o)-y.scaleY||0,Fi),this._pt.u=0,T.push("scaleY",d),d+="X";else{if("transformOrigin"===d){b.push(Qi,0,x[Qi]),a=_r(a),y.svg?Ar(e,a,0,_,0,this):((f=parseFloat(a.split(" ")[2])||0)!==y.zOrigin&&ur(this,y,"zOrigin",y.zOrigin,f),ur(this,x,d,Cr(s),Cr(a)));continue}if("svgOrigin"===d){Ar(e,a,1,_,0,this);continue}if(d in xr){Nr(this,y,d,l,m?ue(l,m+a):a);continue}if("smoothOrigin"===d){ur(this,y,"smooth",y.smooth,a);continue}if("force3D"===d){y[d]=a;continue}if("transform"===d){Br(this,a,e);continue}}else d in x||(d=sr(d)||d);if(g||(o||0===o)&&(l||0===l)&&!Ui.test(a)&&d in x)o||(o=0),(u=(s+"").substr((l+"").length))!==(f=je(a)||(d in p.units?p.units[d]:u))&&(l=mr(e,d,s,f)),this._pt=new li(this._pt,g?y:x,d,l,(m?ue(l,m+o):o)-l,g||"px"!==f&&"zIndex"!==d||!1===t.autoRound?Fi:Gi),this._pt.u=f||0,u!==f&&"%"!==f&&(this._pt.b=s,this._pt.r=Vi);else if(d in x)vr.call(this,e,d,s,m?m+a:a);else if(d in e)this.add(e,d,s||e[d],m?m+a:a,r,n);else if("parseTransform"!==d){W(d,a);continue}g||(d in x?b.push(d,0,x[d]):"function"==typeof e[d]?b.push(d,2,e[d]()):b.push(d,1,s||e[d])),T.push(d)}S&&oi(this)},render:function(e,t){if(t.tween._time||!Li())for(var i=t._pt;i;)i.r(e,i.d),i=i._next;else t.styles.revert()},get:gr,aliases:Ni,getSetter:function(e,t,i){var r=Ni[t];return r&&r.indexOf(",")<0&&(t=r),t in Ri&&t!==Qi&&(e._gsap.x||gr(e,"x"))?i&&Ai===i?"scale"===t?ji:qi:(Ai=i||{})&&("scale"===t?Ki:Yi):e.style&&!A(e.style[t])?$i:~t.indexOf("-")?Wi:Jt(e,t)},core:{_removeProperty:dr,_getMatrix:wr}};bi.utils.checkPrefix=sr,bi.core.getStyleSaver=tr,zr=he((Vr="x,y,z,scale,scaleX,scaleY,xPercent,yPercent")+","+(Gr="rotation,rotationX,rotationY,skewX,skewY")+",transform,transformOrigin,svgOrigin,force3D,smoothOrigin,transformPerspective",function(e){Ri[e]=1}),he(Gr,function(e){p.units[e]="deg",xr[e]=1}),Ni[zr[13]]=Vr+","+Gr,he("0:translateX,1:translateY,2:translateZ,8:rotate,8:rotationZ,8:rotateZ,9:rotateX,10:rotateY",function(e){var t=e.split(":");Ni[t[1]]=zr[t[0]]}),he("x,y,z,top,right,bottom,left,width,height,fontSize,padding,margin,perspective",function(e){p.units[e]="px"}),bi.registerPlugin(Hr);var $r=bi.registerPlugin(Hr)||bi;$r.core.Tween;let Wr,qr,jr,Kr,Yr,Xr,Qr,Zr,Jr,en,tn,rn,nn,sn,an=()=>Wr||"undefined"!=typeof window&&(Wr=window.gsap)&&Wr.registerPlugin&&Wr,on=1,ln=[],hn=[],cn=[],dn=Date.now,un=(e,t)=>t,fn=(e,t)=>~cn.indexOf(e)&&cn[cn.indexOf(e)+1][t],pn=e=>!!~tn.indexOf(e),mn=(e,t,i,r,n)=>e.addEventListener(t,i,{passive:!1!==r,capture:!!n}),gn=(e,t,i,r)=>e.removeEventListener(t,i,!!r),vn=()=>rn&&rn.isPressed||hn.cache++,yn=(e,t)=>{let i=r=>{if(r||0===r){on&&(Kr.history.scrollRestoration="manual");let t=rn&&rn.isPressed;r=i.v=Math.round(r)||(rn&&rn.iOS?1:0),e(r),i.cacheID=hn.cache,t&&un("ss",r)}else(t||hn.cache!==i.cacheID||un("ref"))&&(i.cacheID=hn.cache,i.v=e());return i.v+i.offset};return i.offset=0,e&&i},_n={s:"scrollLeft",p:"left",p2:"Left",os:"right",os2:"Right",d:"width",d2:"Width",a:"x",sc:yn(function(e){return arguments.length?Kr.scrollTo(e,Sn.sc()):Kr.pageXOffset||Yr.scrollLeft||Xr.scrollLeft||Qr.scrollLeft||0})},Sn={s:"scrollTop",p:"top",p2:"Top",os:"bottom",os2:"Bottom",d:"height",d2:"Height",a:"y",op:_n,sc:yn(function(e){return arguments.length?Kr.scrollTo(_n.sc(),e):Kr.pageYOffset||Yr.scrollTop||Xr.scrollTop||Qr.scrollTop||0})},bn=(e,t)=>(t&&t._ctx&&t._ctx.selector||Wr.utils.toArray)(e)[0]||("string"==typeof e&&!1!==Wr.config().nullTargetWarn?console.warn("Element not found:",e):null),Tn=(e,{s:t,sc:i})=>{pn(e)&&(e=Yr.scrollingElement||Xr);let r=hn.indexOf(e),n=i===Sn.sc?1:2;!~r&&(r=hn.push(e)-1),hn[r+n]||mn(e,"scroll",vn);let s=hn[r+n],a=s||(hn[r+n]=yn(fn(e,t),!0)||(pn(e)?i:yn(function(i){return arguments.length?e[t]=i:e[t]})));return a.target=e,s||(a.smooth="smooth"===Wr.getProperty(e,"scrollBehavior")),a},xn=(e,t,i)=>{let r=e,n=e,s=dn(),a=s,o=t||50,l=Math.max(500,3*o),h=(e,t)=>{let l=dn();t||l-s>o?(n=r,r=e,a=s,s=l):i?r+=e:r=n+(e-n)/(l-a)*(s-a)};return{update:h,reset:()=>{n=r=i?0:r,a=s=0},getVelocity:e=>{let t=a,o=n,c=dn();return(e||0===e)&&e!==r&&h(e),s===a||c-a>l?0:(r+(i?o:-o))/((i?c:s)-t)*1e3}}},En=(e,t)=>(t&&!e._gsapAllow&&e.preventDefault(),e.changedTouches?e.changedTouches[0]:e),Mn=e=>{let t=Math.max(...e),i=Math.min(...e);return Math.abs(t)>=Math.abs(i)?t:i},wn=()=>{en=Wr.core.globals().ScrollTrigger,en&&en.core&&(()=>{let e=en.core,t=e.bridge||{},i=e._scrollers,r=e._proxies;i.push(...hn),r.push(...cn),hn=i,cn=r,un=(e,i)=>t[e](i)})()},An=e=>(Wr=e||an(),!qr&&Wr&&"undefined"!=typeof document&&document.body&&(Kr=window,Yr=document,Xr=Yr.documentElement,Qr=Yr.body,tn=[Kr,Yr,Xr,Qr],jr=Wr.utils.clamp,sn=Wr.core.context||function(){},Jr="onpointerenter"in Qr?"pointer":"mouse",Zr=I.isTouch=Kr.matchMedia&&Kr.matchMedia("(hover: none), (pointer: coarse)").matches?1:"ontouchstart"in Kr||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?2:0,nn=I.eventTypes=("ontouchstart"in Xr?"touchstart,touchmove,touchcancel,touchend":"onpointerdown"in Xr?"pointerdown,pointermove,pointercancel,pointerup":"mousedown,mousemove,mouseup,mouseup").split(","),setTimeout(()=>on=0,500),wn(),qr=1),qr);_n.op=Sn,hn.cache=0;class I{constructor(e){this.init(e)}init(e){qr||An(Wr)||console.warn("Please gsap.registerPlugin(Observer)"),en||wn();let{tolerance:t,dragMinimum:i,type:r,target:n,lineHeight:s,debounce:a,preventDefault:o,onStop:l,onStopDelay:h,ignore:c,wheelSpeed:d,event:u,onDragStart:f,onDragEnd:p,onDrag:m,onPress:g,onRelease:v,onRight:y,onLeft:_,onUp:S,onDown:b,onChangeX:T,onChangeY:x,onChange:E,onToggleX:M,onToggleY:w,onHover:A,onHoverEnd:L,onMove:C,ignoreCheck:R,isNormalizer:P,onGestureStart:D,onGestureEnd:k,onWheel:O,onEnable:U,onDisable:N,onClick:F,scrollSpeed:B,capture:V,allowClicks:G,lockAxis:z,onLockAxis:H}=e;this.target=n=bn(n)||Xr,this.vars=e,c&&(c=Wr.utils.toArray(c)),t=t||1e-9,i=i||0,d=d||1,B=B||1,r=r||"wheel,touch,pointer",a=!1!==a,s||(s=parseFloat(Kr.getComputedStyle(Qr).lineHeight)||22);let $,W,q,j,K,Y,X,Q=this,Z=0,J=0,ee=e.passive||!o&&!1!==e.passive,te=Tn(n,_n),ie=Tn(n,Sn),re=te(),ne=ie(),se=~r.indexOf("touch")&&!~r.indexOf("pointer")&&"pointerdown"===nn[0],ae=pn(n),oe=n.ownerDocument||Yr,le=[0,0,0],he=[0,0,0],ce=0,de=()=>ce=dn(),ue=(e,t)=>(Q.event=e)&&c&&~c.indexOf(e.target)||t&&se&&"touch"!==e.pointerType||R&&R(e,t),fe=()=>{let e=Q.deltaX=Mn(le),i=Q.deltaY=Mn(he),r=Math.abs(e)>=t,n=Math.abs(i)>=t;E&&(r||n)&&E(Q,e,i,le,he),r&&(y&&Q.deltaX>0&&y(Q),_&&Q.deltaX<0&&_(Q),T&&T(Q),M&&Q.deltaX<0!=Z<0&&M(Q),Z=Q.deltaX,le[0]=le[1]=le[2]=0),n&&(b&&Q.deltaY>0&&b(Q),S&&Q.deltaY<0&&S(Q),x&&x(Q),w&&Q.deltaY<0!=J<0&&w(Q),J=Q.deltaY,he[0]=he[1]=he[2]=0),(j||q)&&(C&&C(Q),q&&(f&&1===q&&f(Q),m&&m(Q),q=0),j=!1),Y&&!(Y=!1)&&H&&H(Q),K&&(O(Q),K=!1),$=0},pe=(e,t,i)=>{le[i]+=e,he[i]+=t,Q._vx.update(e),Q._vy.update(t),a?$||($=requestAnimationFrame(fe)):fe()},me=(e,t)=>{z&&!X&&(Q.axis=X=Math.abs(e)>Math.abs(t)?"x":"y",Y=!0),"y"!==X&&(le[2]+=e,Q._vx.update(e,!0)),"x"!==X&&(he[2]+=t,Q._vy.update(t,!0)),a?$||($=requestAnimationFrame(fe)):fe()},ge=e=>{if(ue(e,1))return;let t=(e=En(e,o)).clientX,r=e.clientY,n=t-Q.x,s=r-Q.y,a=Q.isDragging;Q.x=t,Q.y=r,(a||(n||s)&&(Math.abs(Q.startX-t)>=i||Math.abs(Q.startY-r)>=i))&&(q=a?2:1,a||(Q.isDragging=!0),me(n,s))},ve=Q.onPress=e=>{ue(e,1)||e&&e.button||(Q.axis=X=null,W.pause(),Q.isPressed=!0,e=En(e),Z=J=0,Q.startX=Q.x=e.clientX,Q.startY=Q.y=e.clientY,Q._vx.reset(),Q._vy.reset(),mn(P?n:oe,nn[1],ge,ee,!0),Q.deltaX=Q.deltaY=0,g&&g(Q))},ye=Q.onRelease=e=>{if(ue(e,1))return;gn(P?n:oe,nn[1],ge,!0);let t=!isNaN(Q.y-Q.startY),i=Q.isDragging,r=i&&(Math.abs(Q.x-Q.startX)>3||Math.abs(Q.y-Q.startY)>3),s=En(e);!r&&t&&(Q._vx.reset(),Q._vy.reset(),o&&G&&Wr.delayedCall(.08,()=>{if(dn()-ce>300&&!e.defaultPrevented)if(e.target.click)e.target.click();else if(oe.createEvent){let t=oe.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,Kr,1,s.screenX,s.screenY,s.clientX,s.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(t)}})),Q.isDragging=Q.isGesturing=Q.isPressed=!1,l&&i&&!P&&W.restart(!0),q&&fe(),p&&i&&p(Q),v&&v(Q,r)},_e=e=>e.touches&&e.touches.length>1&&(Q.isGesturing=!0)&&D(e,Q.isDragging),Se=()=>(Q.isGesturing=!1)||k(Q),be=e=>{if(ue(e))return;let t=te(),i=ie();pe((t-re)*B,(i-ne)*B,1),re=t,ne=i,l&&W.restart(!0)},Te=e=>{if(ue(e))return;e=En(e,o),O&&(K=!0);let t=(1===e.deltaMode?s:2===e.deltaMode?Kr.innerHeight:1)*d;pe(e.deltaX*t,e.deltaY*t,0),l&&!P&&W.restart(!0)},xe=e=>{if(ue(e))return;let t=e.clientX,i=e.clientY,r=t-Q.x,n=i-Q.y;Q.x=t,Q.y=i,j=!0,l&&W.restart(!0),(r||n)&&me(r,n)},Ee=e=>{Q.event=e,A(Q)},Me=e=>{Q.event=e,L(Q)},we=e=>ue(e)||En(e,o)&&F(Q);W=Q._dc=Wr.delayedCall(h||.25,()=>{Q._vx.reset(),Q._vy.reset(),W.pause(),l&&l(Q)}).pause(),Q.deltaX=Q.deltaY=0,Q._vx=xn(0,50,!0),Q._vy=xn(0,50,!0),Q.scrollX=te,Q.scrollY=ie,Q.isDragging=Q.isGesturing=Q.isPressed=!1,sn(this),Q.enable=e=>(Q.isEnabled||(mn(ae?oe:n,"scroll",vn),r.indexOf("scroll")>=0&&mn(ae?oe:n,"scroll",be,ee,V),r.indexOf("wheel")>=0&&mn(n,"wheel",Te,ee,V),(r.indexOf("touch")>=0&&Zr||r.indexOf("pointer")>=0)&&(mn(n,nn[0],ve,ee,V),mn(oe,nn[2],ye),mn(oe,nn[3],ye),G&&mn(n,"click",de,!0,!0),F&&mn(n,"click",we),D&&mn(oe,"gesturestart",_e),k&&mn(oe,"gestureend",Se),A&&mn(n,Jr+"enter",Ee),L&&mn(n,Jr+"leave",Me),C&&mn(n,Jr+"move",xe)),Q.isEnabled=!0,Q.isDragging=Q.isGesturing=Q.isPressed=j=q=!1,Q._vx.reset(),Q._vy.reset(),re=te(),ne=ie(),e&&e.type&&ve(e),U&&U(Q)),Q),Q.disable=()=>{Q.isEnabled&&(ln.filter(e=>e!==Q&&pn(e.target)).length||gn(ae?oe:n,"scroll",vn),Q.isPressed&&(Q._vx.reset(),Q._vy.reset(),gn(P?n:oe,nn[1],ge,!0)),gn(ae?oe:n,"scroll",be,V),gn(n,"wheel",Te,V),gn(n,nn[0],ve,V),gn(oe,nn[2],ye),gn(oe,nn[3],ye),gn(n,"click",de,!0),gn(n,"click",we),gn(oe,"gesturestart",_e),gn(oe,"gestureend",Se),gn(n,Jr+"enter",Ee),gn(n,Jr+"leave",Me),gn(n,Jr+"move",xe),Q.isEnabled=Q.isPressed=Q.isDragging=!1,N&&N(Q))},Q.kill=Q.revert=()=>{Q.disable();let e=ln.indexOf(Q);e>=0&&ln.splice(e,1),rn===Q&&(rn=0)},ln.push(Q),P&&pn(n)&&(rn=Q),Q.enable(u)}get velocityX(){return this._vx.getVelocity()}get velocityY(){return this._vy.getVelocity()}}I.version="3.12.7",I.create=e=>new I(e),I.register=An,I.getAll=()=>ln.slice(),I.getById=e=>ln.filter(t=>t.vars.id===e)[0],an()&&Wr.registerPlugin(I);let Ln,Cn,Rn,Pn,In,Dn,kn,On,Un,Nn,Fn,Bn,Vn,Gn,zn,Hn,$n,Wn,qn,jn,Kn,Yn,Xn,Qn,Zn,Jn,es,ts,is,rs,ns,ss,as,os,ls,hs,cs,ds,us=1,fs=Date.now,ps=fs(),ms=0,gs=0,vs=(e,t,i)=>{let r=Ps(e)&&("clamp("===e.substr(0,6)||e.indexOf("max")>-1);return i["_"+t+"Clamp"]=r,r?e.substr(6,e.length-7):e},ys=(e,t)=>!t||Ps(e)&&"clamp("===e.substr(0,6)?e:"clamp("+e+")",_s=()=>gs&&requestAnimationFrame(_s),Ss=()=>Gn=1,bs=()=>Gn=0,Ts=e=>e,xs=e=>Math.round(1e5*e)/1e5||0,Es=()=>"undefined"!=typeof window,Ms=()=>Ln||Es()&&(Ln=window.gsap)&&Ln.registerPlugin&&Ln,ws=e=>!!~kn.indexOf(e),As=e=>("Height"===e?ns:Rn["inner"+e])||In["client"+e]||Dn["client"+e],Ls=e=>fn(e,"getBoundingClientRect")||(ws(e)?()=>(Ca.width=Rn.innerWidth,Ca.height=ns,Ca):()=>zs(e)),Cs=(e,{s:t,d2:i,d:r,a:n})=>Math.max(0,(t="scroll"+i)&&(n=fn(e,t))?n()-Ls(e)()[r]:ws(e)?(In[t]||Dn[t])-As(i):e[t]-e["offset"+i]),Rs=(e,t)=>{for(let i=0;i<qn.length;i+=3)(!t||~t.indexOf(qn[i+1]))&&e(qn[i],qn[i+1],qn[i+2])},Ps=e=>"string"==typeof e,Is=e=>"function"==typeof e,Ds=e=>"number"==typeof e,ks=e=>"object"==typeof e,Os=(e,t,i)=>e&&e.progress(t?0:1)&&i&&e.pause(),Us=(e,t)=>{if(e.enabled){let i=e._ctx?e._ctx.add(()=>t(e)):t(e);i&&i.totalTime&&(e.callbackAnimation=i)}},Ns=Math.abs,Fs="padding",Bs="px",Vs=e=>Rn.getComputedStyle(e),Gs=(e,t)=>{for(let i in t)i in e||(e[i]=t[i]);return e},zs=(e,t)=>{let i=t&&"matrix(1, 0, 0, 1, 0, 0)"!==Vs(e)[zn]&&Ln.to(e,{x:0,y:0,xPercent:0,yPercent:0,rotation:0,rotationX:0,rotationY:0,scale:1,skewX:0,skewY:0}).progress(1),r=e.getBoundingClientRect();return i&&i.progress(0).kill(),r},Hs=(e,{d2:t})=>e["offset"+t]||e["client"+t]||0,$s=e=>{let t,i=[],r=e.labels,n=e.duration();for(t in r)i.push(r[t]/n);return i},Ws=e=>{let t=Ln.utils.snap(e),i=Array.isArray(e)&&e.slice(0).sort((e,t)=>e-t);return i?(e,r,n=.001)=>{let s;if(!r)return t(e);if(r>0){for(e-=n,s=0;s<i.length;s++)if(i[s]>=e)return i[s];return i[s-1]}for(s=i.length,e+=n;s--;)if(i[s]<=e)return i[s];return i[0]}:(i,r,n=.001)=>{let s=t(i);return!r||Math.abs(s-i)<n||s-i<0==r<0?s:t(r<0?i-e:i+e)}},qs=(e,t,i,r)=>i.split(",").forEach(i=>e(t,i,r)),js=(e,t,i,r,n)=>e.addEventListener(t,i,{passive:!r,capture:!!n}),Ks=(e,t,i,r)=>e.removeEventListener(t,i,!!r),Ys=(e,t,i)=>{(i=i&&i.wheelHandler)&&(e(t,"wheel",i),e(t,"touchmove",i))},Xs={startColor:"green",endColor:"red",indent:0,fontSize:"16px",fontWeight:"normal"},Qs={toggleActions:"play",anticipatePin:0},Zs={top:0,left:0,center:.5,bottom:1,right:1},Js=(e,t)=>{if(Ps(e)){let i=e.indexOf("="),r=~i?+(e.charAt(i-1)+1)*parseFloat(e.substr(i+1)):0;~i&&(e.indexOf("%")>i&&(r*=t/100),e=e.substr(0,i-1)),e=r+(e in Zs?Zs[e]*t:~e.indexOf("%")?parseFloat(e)*t/100:parseFloat(e)||0)}return e},ea=(e,t,i,r,{startColor:n,endColor:s,fontSize:a,indent:o,fontWeight:l},h,c,d)=>{let u=Pn.createElement("div"),f=ws(i)||"fixed"===fn(i,"pinType"),p=-1!==e.indexOf("scroller"),m=f?Dn:i,g=-1!==e.indexOf("start"),v=g?n:s,y="border-color:"+v+";font-size:"+a+";color:"+v+";font-weight:"+l+";pointer-events:none;white-space:nowrap;font-family:sans-serif,Arial;z-index:1000;padding:4px 8px;border-width:0;border-style:solid;";return y+="position:"+((p||d)&&f?"fixed;":"absolute;"),(p||d||!f)&&(y+=(r===Sn?"right":"bottom")+":"+(h+parseFloat(o))+"px;"),c&&(y+="box-sizing:border-box;text-align:left;width:"+c.offsetWidth+"px;"),u._isStart=g,u.setAttribute("class","gsap-marker-"+e+(t?" marker-"+t:"")),u.style.cssText=y,u.innerText=t||0===t?e+"-"+t:e,m.children[0]?m.insertBefore(u,m.children[0]):m.appendChild(u),u._offset=u["offset"+r.op.d2],ta(u,0,r,g),u},ta=(e,t,i,r)=>{let n={display:"block"},s=i[r?"os2":"p2"],a=i[r?"p2":"os2"];e._isFlipped=r,n[i.a+"Percent"]=r?-100:0,n[i.a]=r?"1px":0,n["border"+s+"Width"]=1,n["border"+a+"Width"]=0,n[i.p]=t+"px",Ln.set(e,n)},ia=[],ra={},na=()=>fs()-ms>34&&(ls||(ls=requestAnimationFrame(Ta))),sa=()=>{(!Xn||!Xn.isPressed||Xn.startX>Dn.clientWidth)&&(hn.cache++,Xn?ls||(ls=requestAnimationFrame(Ta)):Ta(),ms||da("scrollStart"),ms=fs())},aa=()=>{Jn=Rn.innerWidth,Zn=Rn.innerHeight},oa=e=>{hn.cache++,(!0===e||!Vn&&!Yn&&!Pn.fullscreenElement&&!Pn.webkitFullscreenElement&&(!Qn||Jn!==Rn.innerWidth||Math.abs(Rn.innerHeight-Zn)>.25*Rn.innerHeight))&&On.restart(!0)},la={},ha=[],ca=()=>Ks(Ut,"scrollEnd",ca)||_a(!0),da=e=>la[e]&&la[e].map(e=>e())||ha,ua=[],fa=e=>{for(let t=0;t<ua.length;t+=5)(!e||ua[t+4]&&ua[t+4].query===e)&&(ua[t].style.cssText=ua[t+1],ua[t].getBBox&&ua[t].setAttribute("transform",ua[t+2]||""),ua[t+3].uncache=1)},pa=(e,t)=>{let i;for(Hn=0;Hn<ia.length;Hn++)i=ia[Hn],!i||t&&i._ctx!==t||(e?i.kill(1):i.revert(!0,!0));ss=!0,t&&fa(t),t||da("revert")},ma=(e,t)=>{hn.cache++,(t||!hs)&&hn.forEach(e=>Is(e)&&e.cacheID++&&(e.rec=0)),Ps(e)&&(Rn.history.scrollRestoration=is=e)},ga=0,va=()=>{Dn.appendChild(rs),ns=!Xn&&rs.offsetHeight||Rn.innerHeight,Dn.removeChild(rs)},ya=e=>Un(".gsap-marker-start, .gsap-marker-end, .gsap-marker-scroller-start, .gsap-marker-scroller-end").forEach(t=>t.style.display=e?"none":"block"),_a=(e,t)=>{if(In=Pn.documentElement,Dn=Pn.body,kn=[Rn,Pn,In,Dn],ms&&!e&&!ss)return void js(Ut,"scrollEnd",ca);va(),hs=Ut.isRefreshing=!0,hn.forEach(e=>Is(e)&&++e.cacheID&&(e.rec=e()));let i=da("refreshInit");jn&&Ut.sort(),t||pa(),hn.forEach(e=>{Is(e)&&(e.smooth&&(e.target.style.scrollBehavior="auto"),e(0))}),ia.slice(0).forEach(e=>e.refresh()),ss=!1,ia.forEach(e=>{if(e._subPinOffset&&e.pin){let t=e.vars.horizontal?"offsetWidth":"offsetHeight",i=e.pin[t];e.revert(!0,1),e.adjustPinSpacing(e.pin[t]-i),e.refresh()}}),as=1,ya(!0),ia.forEach(e=>{let t=Cs(e.scroller,e._dir),i="max"===e.vars.end||e._endClamp&&e.end>t,r=e._startClamp&&e.start>=t;(i||r)&&e.setPositions(r?t-1:e.start,i?Math.max(r?t:e.start+1,t):e.end,!0)}),ya(!1),as=0,i.forEach(e=>e&&e.render&&e.render(-1)),hn.forEach(e=>{Is(e)&&(e.smooth&&requestAnimationFrame(()=>e.target.style.scrollBehavior="smooth"),e.rec&&e(e.rec))}),ma(is,1),On.pause(),ga++,hs=2,Ta(2),ia.forEach(e=>Is(e.vars.onRefresh)&&e.vars.onRefresh(e)),hs=Ut.isRefreshing=!1,da("refresh")},Sa=0,ba=1,Ta=e=>{if(2===e||!hs&&!ss){Ut.isUpdating=!0,ds&&ds.update(0);let e=ia.length,t=fs(),i=t-ps>=50,r=e&&ia[0].scroll();if(ba=Sa>r?-1:1,hs||(Sa=r),i&&(ms&&!Gn&&t-ms>200&&(ms=0,da("scrollEnd")),Fn=ps,ps=t),ba<0){for(Hn=e;Hn-- >0;)ia[Hn]&&ia[Hn].update(0,i);ba=1}else for(Hn=0;Hn<e;Hn++)ia[Hn]&&ia[Hn].update(0,i);Ut.isUpdating=!1}ls=0},xa=["left","top","bottom","right","marginBottom","marginRight","marginTop","marginLeft","display","flexShrink","float","zIndex","gridColumnStart","gridColumnEnd","gridRowStart","gridRowEnd","gridArea","justifySelf","alignSelf","placeSelf","order"],Ea=xa.concat(["width","height","boxSizing","maxWidth","maxHeight","position","margin",Fs,"paddingTop","paddingRight","paddingBottom","paddingLeft"]),Ma=(e,t,i,r)=>{if(!e._gsap.swappedIn){let n,s=xa.length,a=t.style,o=e.style;for(;s--;)n=xa[s],a[n]=i[n];a.position="absolute"===i.position?"absolute":"relative","inline"===i.display&&(a.display="inline-block"),o.bottom=o.right="auto",a.flexBasis=i.flexBasis||"auto",a.overflow="visible",a.boxSizing="border-box",a.width=Hs(e,_n)+Bs,a.height=Hs(e,Sn)+Bs,a.padding=o.margin=o.top=o.left="0",Aa(r),o.width=o.maxWidth=i.width,o.height=o.maxHeight=i.height,o.padding=i.padding,e.parentNode!==t&&(e.parentNode.insertBefore(t,e),t.appendChild(e)),e._gsap.swappedIn=!0}},wa=/([A-Z])/g,Aa=e=>{if(e){let t,i,r=e.t.style,n=e.length,s=0;for((e.t._gsap||Ln.core.getCache(e.t)).uncache=1;s<n;s+=2)i=e[s+1],t=e[s],i?r[t]=i:r[t]&&r.removeProperty(t.replace(wa,"-$1").toLowerCase())}},La=e=>{let t=Ea.length,i=e.style,r=[],n=0;for(;n<t;n++)r.push(Ea[n],i[Ea[n]]);return r.t=e,r},Ca={left:0,top:0},Ra=(e,t,i,r,n,s,a,o,l,h,c,d,u,f)=>{Is(e)&&(e=e(o)),Ps(e)&&"max"===e.substr(0,3)&&(e=d+("="===e.charAt(4)?Js("0"+e.substr(3),i):0));let p,m,g,v=u?u.time():0;if(u&&u.seek(0),isNaN(e)||(e=+e),Ds(e))u&&(e=Ln.utils.mapRange(u.scrollTrigger.start,u.scrollTrigger.end,0,d,e)),a&&ta(a,i,r,!0);else{Is(t)&&(t=t(o));let s,c,d,u,f=(e||"0").split(" ");g=bn(t,o)||Dn,s=zs(g)||{},s&&(s.left||s.top)||"none"!==Vs(g).display||(u=g.style.display,g.style.display="block",s=zs(g),u?g.style.display=u:g.style.removeProperty("display")),c=Js(f[0],s[r.d]),d=Js(f[1]||"0",i),e=s[r.p]-l[r.p]-h+c+n-d,a&&ta(a,d,r,i-d<20||a._isStart&&d>20),i-=i-d}if(f&&(o[f]=e||-.001,e<0&&(e=0)),s){let t=e+i,n=s._isStart;p="scroll"+r.d2,ta(s,t,r,n&&t>20||!n&&(c?Math.max(Dn[p],In[p]):s.parentNode[p])<=t+1),c&&(l=zs(a),c&&(s.style[r.op.p]=l[r.op.p]-r.op.m-s._offset+Bs))}return u&&g&&(p=zs(g),u.seek(d),m=zs(g),u._caScrollDist=p[r.p]-m[r.p],e=e/u._caScrollDist*d),u&&u.seek(v),u?e:Math.round(e)},Pa=/(webkit|moz|length|cssText|inset)/i,Ia=(e,t,i,r)=>{if(e.parentNode!==t){let n,s,a=e.style;if(t===Dn){for(n in e._stOrig=a.cssText,s=Vs(e),s)+n||Pa.test(n)||!s[n]||"string"!=typeof a[n]||"0"===n||(a[n]=s[n]);a.top=i,a.left=r}else a.cssText=e._stOrig;Ln.core.getCache(e).uncache=1,t.appendChild(e)}},Da=(e,t,i)=>{let r=t,n=r;return t=>{let s=Math.round(e());return s!==r&&s!==n&&Math.abs(s-r)>3&&Math.abs(s-n)>3&&(t=s,i&&i()),n=r,r=Math.round(t),r}},ka=(e,t,i)=>{let r={};r[t.p]="+="+i,Ln.set(e,r)},Oa=(e,t)=>{let i=Tn(e,t),r="_scroll"+t.p2,n=(t,s,a,o,l)=>{let h=n.tween,c=s.onComplete,d={};a=a||i();let u=Da(i,a,()=>{h.kill(),n.tween=0});return l=o&&l||0,o=o||t-a,h&&h.kill(),s[r]=t,s.inherit=!1,s.modifiers=d,d[r]=()=>u(a+o*h.ratio+l*h.ratio*h.ratio),s.onUpdate=()=>{hn.cache++,n.tween&&Ta()},s.onComplete=()=>{n.tween=0,c&&c.call(h)},h=n.tween=Ln.to(e,s),h};return e[r]=i,i.wheelHandler=()=>n.tween&&n.tween.kill()&&(n.tween=0),js(e,"wheel",i.wheelHandler),Ut.isTouch&&js(e,"touchmove",i.wheelHandler),n};class Ut{constructor(e,t){Cn||Ut.register(Ln)||console.warn("Please gsap.registerPlugin(ScrollTrigger)"),ts(this),this.init(e,t)}init(e,t){if(this.progress=this.start=0,this.vars&&this.kill(!0,!0),!gs)return void(this.update=this.refresh=this.kill=Ts);e=Gs(Ps(e)||Ds(e)||e.nodeType?{trigger:e}:e,Qs);let i,r,n,s,a,o,l,h,c,d,u,f,p,m,g,v,y,_,S,b,T,x,E,M,w,A,L,C,R,P,D,k,O,U,N,F,B,V,G,{onUpdate:z,toggleClass:H,id:$,onToggle:W,onRefresh:q,scrub:j,trigger:K,pin:Y,pinSpacing:X,invalidateOnRefresh:Q,anticipatePin:Z,onScrubComplete:J,onSnapComplete:ee,once:te,snap:ie,pinReparent:re,pinSpacer:ne,containerAnimation:se,fastScrollEnd:ae,preventOverlaps:oe}=e,le=e.horizontal||e.containerAnimation&&!1!==e.horizontal?_n:Sn,he=!j&&0!==j,ce=bn(e.scroller||Rn),de=Ln.core.getCache(ce),ue=ws(ce),fe="fixed"===("pinType"in e?e.pinType:fn(ce,"pinType")||ue&&"fixed"),pe=[e.onEnter,e.onLeave,e.onEnterBack,e.onLeaveBack],me=he&&e.toggleActions.split(" "),ge="markers"in e?e.markers:Qs.markers,ve=ue?0:parseFloat(Vs(ce)["border"+le.p2+"Width"])||0,ye=this,_e=e.onRefreshInit&&(()=>e.onRefreshInit(ye)),Se=((e,t,{d:i,d2:r,a:n})=>(n=fn(e,"getBoundingClientRect"))?()=>n()[i]:()=>(t?As(r):e["client"+r])||0)(ce,ue,le),be=((e,t)=>!t||~cn.indexOf(e)?Ls(e):()=>Ca)(ce,ue),Te=0,xe=0,Ee=0,Me=Tn(ce,le);var we;if(ye._startClamp=ye._endClamp=!1,ye._dir=le,Z*=45,ye.scroller=ce,ye.scroll=se?se.time.bind(se):Me,s=Me(),ye.vars=e,t=t||e.animation,"refreshPriority"in e&&(jn=1,-9999===e.refreshPriority&&(ds=ye)),de.tweenScroll=de.tweenScroll||{top:Oa(ce,Sn),left:Oa(ce,_n)},ye.tweenTo=i=de.tweenScroll[le.p],ye.scrubDuration=e=>{O=Ds(e)&&e,O?k?k.duration(e):k=Ln.to(t,{ease:"expo",totalProgress:"+=0",inherit:!1,duration:O,paused:!0,onComplete:()=>J&&J(ye)}):(k&&k.progress(1).kill(),k=0)},t&&(t.vars.lazy=!1,t._initted&&!ye.isReverted||!1!==t.vars.immediateRender&&!1!==e.immediateRender&&t.duration()&&t.render(0,!0,!0),ye.animation=t.pause(),t.scrollTrigger=ye,ye.scrubDuration(j),P=0,$||($=t.vars.id)),ie&&(ks(ie)&&!ie.push||(ie={snapTo:ie}),"scrollBehavior"in Dn.style&&Ln.set(ue?[Dn,In]:ce,{scrollBehavior:"auto"}),hn.forEach(e=>Is(e)&&e.target===(ue?Pn.scrollingElement||In:ce)&&(e.smooth=!1)),n=Is(ie.snapTo)?ie.snapTo:"labels"===ie.snapTo?(e=>t=>Ln.utils.snap($s(e),t))(t):"labelsDirectional"===ie.snapTo?(we=t,(e,t)=>Ws($s(we))(e,t.direction)):!1!==ie.directional?(e,t)=>Ws(ie.snapTo)(e,fs()-xe<500?0:t.direction):Ln.utils.snap(ie.snapTo),U=ie.duration||{min:.1,max:2},U=ks(U)?Nn(U.min,U.max):Nn(U,U),N=Ln.delayedCall(ie.delay||O/2||.1,()=>{let e=Me(),r=fs()-xe<500,s=i.tween;if(!(r||Math.abs(ye.getVelocity())<10)||s||Gn||Te===e)ye.isActive&&Te!==e&&N.restart(!0);else{let a,h,c=(e-o)/m,d=t&&!he?t.totalProgress():c,u=r?0:(d-D)/(fs()-Fn)*1e3||0,f=Ln.utils.clamp(-c,1-c,Ns(u/2)*u/.185),p=c+(!1===ie.inertia?0:f),{onStart:g,onInterrupt:v,onComplete:y}=ie;if(a=n(p,ye),Ds(a)||(a=p),h=Math.max(0,Math.round(o+a*m)),e<=l&&e>=o&&h!==e){if(s&&!s._initted&&s.data<=Ns(h-e))return;!1===ie.inertia&&(f=a-c),i(h,{duration:U(Ns(.185*Math.max(Ns(p-d),Ns(a-d))/u/.05||0)),ease:ie.ease||"power3",data:Ns(h-e),onInterrupt:()=>N.restart(!0)&&v&&v(ye),onComplete(){ye.update(),Te=Me(),t&&!he&&(k?k.resetTo("totalProgress",a,t._tTime/t._tDur):t.progress(a)),P=D=t&&!he?t.totalProgress():ye.progress,ee&&ee(ye),y&&y(ye)}},e,f*m,h-e-f*m),g&&g(ye,i.tween)}}}).pause()),$&&(ra[$]=ye),K=ye.trigger=bn(K||!0!==Y&&Y),G=K&&K._gsap&&K._gsap.stRevert,G&&(G=G(ye)),Y=!0===Y?K:bn(Y),Ps(H)&&(H={targets:K,className:H}),Y&&(!1===X||"margin"===X||(X=!(!X&&Y.parentNode&&Y.parentNode.style&&"flex"===Vs(Y.parentNode).display)&&Fs),ye.pin=Y,r=Ln.core.getCache(Y),r.spacer?g=r.pinState:(ne&&(ne=bn(ne),ne&&!ne.nodeType&&(ne=ne.current||ne.nativeElement),r.spacerIsNative=!!ne,ne&&(r.spacerState=La(ne))),r.spacer=_=ne||Pn.createElement("div"),_.classList.add("pin-spacer"),$&&_.classList.add("pin-spacer-"+$),r.pinState=g=La(Y)),!1!==e.force3D&&Ln.set(Y,{force3D:!0}),ye.spacer=_=r.spacer,R=Vs(Y),M=R[X+le.os2],b=Ln.getProperty(Y),T=Ln.quickSetter(Y,le.a,Bs),Ma(Y,_,R),y=La(Y)),ge){f=ks(ge)?Gs(ge,Xs):Xs,d=ea("scroller-start",$,ce,le,f,0),u=ea("scroller-end",$,ce,le,f,0,d),S=d["offset"+le.op.d2];let e=bn(fn(ce,"content")||ce);h=this.markerStart=ea("start",$,e,le,f,S,0,se),c=this.markerEnd=ea("end",$,e,le,f,S,0,se),se&&(V=Ln.quickSetter([h,c],le.a,Bs)),fe||cn.length&&!0===fn(ce,"fixedMarkers")||((e=>{let t=Vs(e).position;e.style.position="absolute"===t||"fixed"===t?t:"relative"})(ue?Dn:ce),Ln.set([d,u],{force3D:!0}),A=Ln.quickSetter(d,le.a,Bs),C=Ln.quickSetter(u,le.a,Bs))}if(se){let e=se.vars.onUpdate,t=se.vars.onUpdateParams;se.eventCallback("onUpdate",()=>{ye.update(0,0,1),e&&e.apply(se,t||[])})}if(ye.previous=()=>ia[ia.indexOf(ye)-1],ye.next=()=>ia[ia.indexOf(ye)+1],ye.revert=(e,i)=>{if(!i)return ye.kill(!0);let r=!1!==e||!ye.enabled,n=Vn;r!==ye.isReverted&&(r&&(F=Math.max(Me(),ye.scroll.rec||0),Ee=ye.progress,B=t&&t.progress()),h&&[h,c,d,u].forEach(e=>e.style.display=r?"none":"block"),r&&(Vn=ye,ye.update(r)),!Y||re&&ye.isActive||(r?((e,t,i)=>{Aa(i);let r=e._gsap;if(r.spacerIsNative)Aa(r.spacerState);else if(e._gsap.swappedIn){let i=t.parentNode;i&&(i.insertBefore(e,t),i.removeChild(t))}e._gsap.swappedIn=!1})(Y,_,g):Ma(Y,_,Vs(Y),w)),r||ye.update(r),Vn=n,ye.isReverted=r)},ye.refresh=(r,n,f,S)=>{if((Vn||!ye.enabled)&&!n)return;if(Y&&r&&ms)return void js(Ut,"scrollEnd",ca);!hs&&_e&&_e(ye),Vn=ye,i.tween&&!f&&(i.tween.kill(),i.tween=0),k&&k.pause(),Q&&t&&t.revert({kill:!1}).invalidate(),ye.isReverted||ye.revert(!0,!0),ye._subPinOffset=!1;let T,M,A,C,R,P,D,O,U,V,G,z,H,$=Se(),W=be(),j=se?se.duration():Cs(ce,le),Z=m<=.01,J=0,ee=S||0,te=ks(f)?f.end:e.end,ie=e.endTrigger||K,ne=ks(f)?f.start:e.start||(0!==e.start&&K?Y?"0 0":"0 100%":0),ae=ye.pinnedContainer=e.pinnedContainer&&bn(e.pinnedContainer,ye),oe=K&&Math.max(0,ia.indexOf(ye))||0,de=oe;for(ge&&ks(f)&&(z=Ln.getProperty(d,le.p),H=Ln.getProperty(u,le.p));de-- >0;)P=ia[de],P.end||P.refresh(0,1)||(Vn=ye),D=P.pin,!D||D!==K&&D!==Y&&D!==ae||P.isReverted||(V||(V=[]),V.unshift(P),P.revert(!0,!0)),P!==ia[de]&&(oe--,de--);for(Is(ne)&&(ne=ne(ye)),ne=vs(ne,"start",ye),o=Ra(ne,K,$,le,Me(),h,d,ye,W,ve,fe,j,se,ye._startClamp&&"_startClamp")||(Y?-.001:0),Is(te)&&(te=te(ye)),Ps(te)&&!te.indexOf("+=")&&(~te.indexOf(" ")?te=(Ps(ne)?ne.split(" ")[0]:"")+te:(J=Js(te.substr(2),$),te=Ps(ne)?ne:(se?Ln.utils.mapRange(0,se.duration(),se.scrollTrigger.start,se.scrollTrigger.end,o):o)+J,ie=K)),te=vs(te,"end",ye),l=Math.max(o,Ra(te||(ie?"100% 0":j),ie,$,le,Me()+J,c,u,ye,W,ve,fe,j,se,ye._endClamp&&"_endClamp"))||-.001,J=0,de=oe;de--;)P=ia[de],D=P.pin,D&&P.start-P._pinPush<=o&&!se&&P.end>0&&(T=P.end-(ye._startClamp?Math.max(0,P.start):P.start),(D===K&&P.start-P._pinPush<o||D===ae)&&isNaN(ne)&&(J+=T*(1-P.progress)),D===Y&&(ee+=T));if(o+=J,l+=J,ye._startClamp&&(ye._startClamp+=J),ye._endClamp&&!hs&&(ye._endClamp=l||-.001,l=Math.min(l,Cs(ce,le))),m=l-o||(o-=.01)&&.001,Z&&(Ee=Ln.utils.clamp(0,1,Ln.utils.normalize(o,l,F))),ye._pinPush=ee,h&&J&&(T={},T[le.a]="+="+J,ae&&(T[le.p]="-="+Me()),Ln.set([h,c],T)),!Y||as&&ye.end>=Cs(ce,le)){if(K&&Me()&&!se)for(M=K.parentNode;M&&M!==Dn;)M._pinOffset&&(o-=M._pinOffset,l-=M._pinOffset),M=M.parentNode}else T=Vs(Y),C=le===Sn,A=Me(),x=parseFloat(b(le.a))+ee,!j&&l>1&&(G=(ue?Pn.scrollingElement||In:ce).style,G={style:G,value:G["overflow"+le.a.toUpperCase()]},ue&&"scroll"!==Vs(Dn)["overflow"+le.a.toUpperCase()]&&(G.style["overflow"+le.a.toUpperCase()]="scroll")),Ma(Y,_,T),y=La(Y),M=zs(Y,!0),O=fe&&Tn(ce,C?_n:Sn)(),X?(w=[X+le.os2,m+ee+Bs],w.t=_,de=X===Fs?Hs(Y,le)+m+ee:0,de&&(w.push(le.d,de+Bs),"auto"!==_.style.flexBasis&&(_.style.flexBasis=de+Bs)),Aa(w),ae&&ia.forEach(e=>{e.pin===ae&&!1!==e.vars.pinSpacing&&(e._subPinOffset=!0)}),fe&&Me(F)):(de=Hs(Y,le),de&&"auto"!==_.style.flexBasis&&(_.style.flexBasis=de+Bs)),fe&&(R={top:M.top+(C?A-o:O)+Bs,left:M.left+(C?O:A-o)+Bs,boxSizing:"border-box",position:"fixed"},R.width=R.maxWidth=Math.ceil(M.width)+Bs,R.height=R.maxHeight=Math.ceil(M.height)+Bs,R.margin=R.marginTop=R.marginRight=R.marginBottom=R.marginLeft="0",R.padding=T.padding,R.paddingTop=T.paddingTop,R.paddingRight=T.paddingRight,R.paddingBottom=T.paddingBottom,R.paddingLeft=T.paddingLeft,v=((e,t,i)=>{let r,n=[],s=e.length,a=i?8:0;for(;a<s;a+=2)r=e[a],n.push(r,r in t?t[r]:e[a+1]);return n.t=e.t,n})(g,R,re),hs&&Me(0)),t?(U=t._initted,Kn(1),t.render(t.duration(),!0,!0),E=b(le.a)-x+m+ee,L=Math.abs(m-E)>1,fe&&L&&v.splice(v.length-2,2),t.render(0,!0,!0),U||t.invalidate(!0),t.parent||t.totalTime(t.totalTime()),Kn(0)):E=m,G&&(G.value?G.style["overflow"+le.a.toUpperCase()]=G.value:G.style.removeProperty("overflow-"+le.a));V&&V.forEach(e=>e.revert(!1,!0)),ye.start=o,ye.end=l,s=a=hs?F:Me(),se||hs||(s<F&&Me(F),ye.scroll.rec=0),ye.revert(!1,!0),xe=fs(),N&&(Te=-1,N.restart(!0)),Vn=0,t&&he&&(t._initted||B)&&t.progress()!==B&&t.progress(B||0,!0).render(t.time(),!0,!0),(Z||Ee!==ye.progress||se||Q||t&&!t._initted)&&(t&&!he&&t.totalProgress(se&&o<-.001&&!Ee?Ln.utils.normalize(o,l,0):Ee,!0),ye.progress=Z||(s-o)/m===Ee?0:Ee),Y&&X&&(_._pinOffset=Math.round(ye.progress*E)),k&&k.invalidate(),isNaN(z)||(z-=Ln.getProperty(d,le.p),H-=Ln.getProperty(u,le.p),ka(d,le,z),ka(h,le,z-(S||0)),ka(u,le,H),ka(c,le,H-(S||0))),Z&&!hs&&ye.update(),!q||hs||p||(p=!0,q(ye),p=!1)},ye.getVelocity=()=>(Me()-a)/(fs()-Fn)*1e3||0,ye.endAnimation=()=>{Os(ye.callbackAnimation),t&&(k?k.progress(1):t.paused()?he||Os(t,ye.direction<0,1):Os(t,t.reversed()))},ye.labelToScroll=e=>t&&t.labels&&(o||ye.refresh()||o)+t.labels[e]/t.duration()*m||0,ye.getTrailing=e=>{let t=ia.indexOf(ye),i=ye.direction>0?ia.slice(0,t).reverse():ia.slice(t+1);return(Ps(e)?i.filter(t=>t.vars.preventOverlaps===e):i).filter(e=>ye.direction>0?e.end<=o:e.start>=l)},ye.update=(e,r,n)=>{if(se&&!n&&!e)return;let h,c,u,f,p,g,S,b,w=!0===hs?F:ye.scroll(),R=e?0:(w-o)/m,O=R<0?0:R>1?1:R||0,U=ye.progress;if(r&&(a=s,s=se?Me():w,ie&&(D=P,P=t&&!he?t.totalProgress():O)),Z&&Y&&!Vn&&!us&&ms&&(!O&&o<w+(w-a)/(fs()-Fn)*Z?O=1e-4:1===O&&l>w+(w-a)/(fs()-Fn)*Z&&(O=.9999)),O!==U&&ye.enabled){if(h=ye.isActive=!!O&&O<1,c=!!U&&U<1,g=h!==c,p=g||!!O!=!!U,ye.direction=O>U?1:-1,ye.progress=O,p&&!Vn&&(u=O&&!U?0:1===O?1:1===U?2:3,he&&(f=!g&&"none"!==me[u+1]&&me[u+1]||me[u],b=t&&("complete"===f||"reset"===f||f in t))),oe&&(g||b)&&(b||j||!t)&&(Is(oe)?oe(ye):ye.getTrailing(oe).forEach(e=>e.endAnimation())),he||(!k||Vn||us?t&&t.totalProgress(O,!(!Vn||!xe&&!e)):(k._dp._time-k._start!==k._time&&k.render(k._dp._time-k._start),k.resetTo?k.resetTo("totalProgress",O,t._tTime/t._tDur):(k.vars.totalProgress=O,k.invalidate().restart()))),Y)if(e&&X&&(_.style[X+le.os2]=M),fe){if(p){if(S=!e&&O>U&&l+1>w&&w+1>=Cs(ce,le),re)if(e||!h&&!S)Ia(Y,_);else{let e=zs(Y,!0),t=w-o;Ia(Y,Dn,e.top+(le===Sn?t:0)+Bs,e.left+(le===Sn?0:t)+Bs)}Aa(h||S?v:y),L&&O<1&&h||T(x+(1!==O||S?0:E))}}else T(xs(x+E*O));ie&&!i.tween&&!Vn&&!us&&N.restart(!0),H&&(g||te&&O&&(O<1||!os))&&Un(H.targets).forEach(e=>e.classList[h||te?"add":"remove"](H.className)),z&&!he&&!e&&z(ye),p&&!Vn?(he&&(b&&("complete"===f?t.pause().totalProgress(1):"reset"===f?t.restart(!0).pause():"restart"===f?t.restart(!0):t[f]()),z&&z(ye)),!g&&os||(W&&g&&Us(ye,W),pe[u]&&Us(ye,pe[u]),te&&(1===O?ye.kill(!1,1):pe[u]=0),g||(u=1===O?1:3,pe[u]&&Us(ye,pe[u]))),ae&&!h&&Math.abs(ye.getVelocity())>(Ds(ae)?ae:2500)&&(Os(ye.callbackAnimation),k?k.progress(1):Os(t,"reverse"===f?1:!O,1))):he&&z&&!Vn&&z(ye)}if(C){let e=se?w/se.duration()*(se._caScrollDist||0):w;A(e+(d._isFlipped?1:0)),C(e)}V&&V(-w/se.duration()*(se._caScrollDist||0))},ye.enable=(e,t)=>{ye.enabled||(ye.enabled=!0,js(ce,"resize",oa),ue||js(ce,"scroll",sa),_e&&js(Ut,"refreshInit",_e),!1!==e&&(ye.progress=Ee=0,s=a=Te=Me()),!1!==t&&ye.refresh())},ye.getTween=e=>e&&i?i.tween:k,ye.setPositions=(e,t,i,r)=>{if(se){let i=se.scrollTrigger,r=se.duration(),n=i.end-i.start;e=i.start+n*e/r,t=i.start+n*t/r}ye.refresh(!1,!1,{start:ys(e,i&&!!ye._startClamp),end:ys(t,i&&!!ye._endClamp)},r),ye.update()},ye.adjustPinSpacing=e=>{if(w&&e){let t=w.indexOf(le.d)+1;w[t]=parseFloat(w[t])+e+Bs,w[1]=parseFloat(w[1])+e+Bs,Aa(w)}},ye.disable=(e,t)=>{if(ye.enabled&&(!1!==e&&ye.revert(!0,!0),ye.enabled=ye.isActive=!1,t||k&&k.pause(),F=0,r&&(r.uncache=1),_e&&Ks(Ut,"refreshInit",_e),N&&(N.pause(),i.tween&&i.tween.kill()&&(i.tween=0)),!ue)){let e=ia.length;for(;e--;)if(ia[e].scroller===ce&&ia[e]!==ye)return;Ks(ce,"resize",oa),ue||Ks(ce,"scroll",sa)}},ye.kill=(i,n)=>{ye.disable(i,n),k&&!n&&k.kill(),$&&delete ra[$];let s=ia.indexOf(ye);s>=0&&ia.splice(s,1),s===Hn&&ba>0&&Hn--,s=0,ia.forEach(e=>e.scroller===ye.scroller&&(s=1)),s||hs||(ye.scroll.rec=0),t&&(t.scrollTrigger=null,i&&t.revert({kill:!1}),n||t.kill()),h&&[h,c,d,u].forEach(e=>e.parentNode&&e.parentNode.removeChild(e)),ds===ye&&(ds=0),Y&&(r&&(r.uncache=1),s=0,ia.forEach(e=>e.pin===Y&&s++),s||(r.spacer=0)),e.onKill&&e.onKill(ye)},ia.push(ye),ye.enable(!1,!1),G&&G(ye),t&&t.add&&!m){let e=ye.update;ye.update=()=>{ye.update=e,hn.cache++,o||l||ye.refresh()},Ln.delayedCall(.01,ye.update),m=.01,o=l=0}else ye.refresh();Y&&(()=>{if(cs!==ga){let e=cs=ga;requestAnimationFrame(()=>e===ga&&_a(!0))}})()}static register(e){return Cn||(Ln=e||Ms(),Es()&&window.document&&Ut.enable(),Cn=gs),Cn}static defaults(e){if(e)for(let t in e)Qs[t]=e[t];return Qs}static disable(e,t){gs=0,ia.forEach(i=>i[t?"kill":"disable"](e)),Ks(Rn,"wheel",sa),Ks(Pn,"scroll",sa),clearInterval(Bn),Ks(Pn,"touchcancel",Ts),Ks(Dn,"touchstart",Ts),qs(Ks,Pn,"pointerdown,touchstart,mousedown",Ss),qs(Ks,Pn,"pointerup,touchend,mouseup",bs),On.kill(),Rs(Ks);for(let e=0;e<hn.length;e+=3)Ys(Ks,hn[e],hn[e+1]),Ys(Ks,hn[e],hn[e+2])}static enable(){if(Rn=window,Pn=document,In=Pn.documentElement,Dn=Pn.body,Ln&&(Un=Ln.utils.toArray,Nn=Ln.utils.clamp,ts=Ln.core.context||Ts,Kn=Ln.core.suppressOverwrites||Ts,is=Rn.history.scrollRestoration||"auto",Sa=Rn.pageYOffset||0,Ln.core.globals("ScrollTrigger",Ut),Dn)){gs=1,rs=document.createElement("div"),rs.style.height="100vh",rs.style.position="absolute",va(),_s(),I.register(Ln),Ut.isTouch=I.isTouch,es=I.isTouch&&/(iPad|iPhone|iPod|Mac)/g.test(navigator.userAgent),Qn=1===I.isTouch,js(Rn,"wheel",sa),kn=[Rn,Pn,In,Dn],Ln.matchMedia?(Ut.matchMedia=e=>{let t,i=Ln.matchMedia();for(t in e)i.add(t,e[t]);return i},Ln.addEventListener("matchMediaInit",()=>pa()),Ln.addEventListener("matchMediaRevert",()=>fa()),Ln.addEventListener("matchMedia",()=>{_a(0,1),da("matchMedia")}),Ln.matchMedia().add("(orientation: portrait)",()=>(aa(),aa))):console.warn("Requires GSAP 3.11.0 or later"),aa(),js(Pn,"scroll",sa);let e,t,i=Dn.hasAttribute("style"),r=Dn.style,n=r.borderTopStyle,s=Ln.core.Animation.prototype;for(s.revert||Object.defineProperty(s,"revert",{value:function(){return this.time(-.01,!0)}}),r.borderTopStyle="solid",e=zs(Dn),Sn.m=Math.round(e.top+Sn.sc())||0,_n.m=Math.round(e.left+_n.sc())||0,n?r.borderTopStyle=n:r.removeProperty("border-top-style"),i||(Dn.setAttribute("style",""),Dn.removeAttribute("style")),Bn=setInterval(na,250),Ln.delayedCall(.5,()=>us=0),js(Pn,"touchcancel",Ts),js(Dn,"touchstart",Ts),qs(js,Pn,"pointerdown,touchstart,mousedown",Ss),qs(js,Pn,"pointerup,touchend,mouseup",bs),zn=Ln.utils.checkPrefix("transform"),Ea.push(zn),Cn=fs(),On=Ln.delayedCall(.2,_a).pause(),qn=[Pn,"visibilitychange",()=>{let e=Rn.innerWidth,t=Rn.innerHeight;Pn.hidden?($n=e,Wn=t):$n===e&&Wn===t||oa()},Pn,"DOMContentLoaded",_a,Rn,"load",_a,Rn,"resize",oa],Rs(js),ia.forEach(e=>e.enable(0,1)),t=0;t<hn.length;t+=3)Ys(Ks,hn[t],hn[t+1]),Ys(Ks,hn[t],hn[t+2])}}static config(e){"limitCallbacks"in e&&(os=!!e.limitCallbacks);let t=e.syncInterval;t&&clearInterval(Bn)||(Bn=t)&&setInterval(na,t),"ignoreMobileResize"in e&&(Qn=1===Ut.isTouch&&e.ignoreMobileResize),"autoRefreshEvents"in e&&(Rs(Ks)||Rs(js,e.autoRefreshEvents||"none"),Yn=-1===(e.autoRefreshEvents+"").indexOf("resize"))}static scrollerProxy(e,t){let i=bn(e),r=hn.indexOf(i),n=ws(i);~r&&hn.splice(r,n?6:2),t&&(n?cn.unshift(Rn,t,Dn,t,In,t):cn.unshift(i,t))}static clearMatchMedia(e){ia.forEach(t=>t._ctx&&t._ctx.query===e&&t._ctx.kill(!0,!0))}static isInViewport(e,t,i){let r=(Ps(e)?bn(e):e).getBoundingClientRect(),n=r[i?"width":"height"]*t||0;return i?r.right-n>0&&r.left+n<Rn.innerWidth:r.bottom-n>0&&r.top+n<Rn.innerHeight}static positionInViewport(e,t,i){Ps(e)&&(e=bn(e));let r=e.getBoundingClientRect(),n=r[i?"width":"height"],s=null==t?n/2:t in Zs?Zs[t]*n:~t.indexOf("%")?parseFloat(t)*n/100:parseFloat(t)||0;return i?(r.left+s)/Rn.innerWidth:(r.top+s)/Rn.innerHeight}static killAll(e){if(ia.slice(0).forEach(e=>"ScrollSmoother"!==e.vars.id&&e.kill()),!0!==e){let e=la.killAll||[];la={},e.forEach(e=>e())}}}Ut.version="3.12.7",Ut.saveStyles=e=>e?Un(e).forEach(e=>{if(e&&e.style){let t=ua.indexOf(e);t>=0&&ua.splice(t,5),ua.push(e,e.style.cssText,e.getBBox&&e.getAttribute("transform"),Ln.core.getCache(e),ts())}}):ua,Ut.revert=(e,t)=>pa(!e,t),Ut.create=(e,t)=>new Ut(e,t),Ut.refresh=e=>e?oa(!0):(Cn||Ut.register())&&_a(!0),Ut.update=e=>++hn.cache&&Ta(!0===e?2:0),Ut.clearScrollMemory=ma,Ut.maxScroll=(e,t)=>Cs(e,t?_n:Sn),Ut.getScrollFunc=(e,t)=>Tn(bn(e),t?_n:Sn),Ut.getById=e=>ra[e],Ut.getAll=()=>ia.filter(e=>"ScrollSmoother"!==e.vars.id),Ut.isScrolling=()=>!!ms,Ut.snapDirectional=Ws,Ut.addEventListener=(e,t)=>{let i=la[e]||(la[e]=[]);~i.indexOf(t)||i.push(t)},Ut.removeEventListener=(e,t)=>{let i=la[e],r=i&&i.indexOf(t);r>=0&&i.splice(r,1)},Ut.batch=(e,t)=>{let i,r=[],n={},s=t.interval||.016,a=t.batchMax||1e9,o=(e,t)=>{let i=[],r=[],n=Ln.delayedCall(s,()=>{t(i,r),i=[],r=[]}).pause();return e=>{i.length||n.restart(!0),i.push(e.trigger),r.push(e),a<=i.length&&n.progress(1)}};for(i in t)n[i]="on"===i.substr(0,2)&&Is(t[i])&&"onRefreshInit"!==i?o(0,t[i]):t[i];return Is(a)&&(a=a(),js(Ut,"refresh",()=>a=t.batchMax())),Un(e).forEach(e=>{let t={};for(i in n)t[i]=n[i];t.trigger=e,r.push(Ut.create(t))}),r};let Ua,Na=(e,t,i,r)=>(t>r?e(r):t<0&&e(0),i>r?(r-t)/(i-t):i<0?t/(t-i):1),Fa=(e,t)=>{!0===t?e.style.removeProperty("touch-action"):e.style.touchAction=!0===t?"auto":t?"pan-"+t+(I.isTouch?" pinch-zoom":""):"none",e===In&&Fa(Dn,t)},Ba={auto:1,scroll:1},Va=({event:e,target:t,axis:i})=>{let r,n=(e.changedTouches?e.changedTouches[0]:e).target,s=n._gsap||Ln.core.getCache(n),a=fs();if(!s._isScrollT||a-s._isScrollT>2e3){for(;n&&n!==Dn&&(n.scrollHeight<=n.clientHeight&&n.scrollWidth<=n.clientWidth||!Ba[(r=Vs(n)).overflowY]&&!Ba[r.overflowX]);)n=n.parentNode;s._isScroll=n&&n!==t&&!ws(n)&&(Ba[(r=Vs(n)).overflowY]||Ba[r.overflowX]),s._isScrollT=a}(s._isScroll||"x"===i)&&(e.stopPropagation(),e._gsapAllow=!0)},Ga=(e,t,i,r)=>I.create({target:e,capture:!0,debounce:!1,lockAxis:!0,type:t,onWheel:r=r&&Va,onPress:r,onDrag:r,onScroll:r,onEnable:()=>i&&js(Pn,I.eventTypes[0],Ha,!1,!0),onDisable:()=>Ks(Pn,I.eventTypes[0],Ha,!0)}),za=/(input|label|select|textarea)/i,Ha=e=>{let t=za.test(e.target.tagName);(t||Ua)&&(e._gsapAllow=!0,Ua=t)};Ut.sort=e=>{if(Is(e))return ia.sort(e);let t=Rn.pageYOffset||0;return Ut.getAll().forEach(e=>e._sortY=e.trigger?t+e.trigger.getBoundingClientRect().top:e.start+Rn.innerHeight),ia.sort(e||((e,t)=>-1e6*(e.vars.refreshPriority||0)+(e.vars.containerAnimation?1e6:e._sortY)-((t.vars.containerAnimation?1e6:t._sortY)+-1e6*(t.vars.refreshPriority||0))))},Ut.observe=e=>new I(e),Ut.normalizeScroll=e=>{if(void 0===e)return Xn;if(!0===e&&Xn)return Xn.enable();if(!1===e)return Xn&&Xn.kill(),void(Xn=e);let t=e instanceof I?e:(e=>{ks(e)||(e={}),e.preventDefault=e.isNormalizer=e.allowClicks=!0,e.type||(e.type="wheel,touch"),e.debounce=!!e.debounce,e.id=e.id||"normalizer";let t,i,r,n,s,a,o,l,{normalizeScrollX:h,momentum:c,allowNestedScroll:d,onRelease:u}=e,f=bn(e.target)||In,p=Ln.core.globals().ScrollSmoother,m=p&&p.get(),g=es&&(e.content&&bn(e.content)||m&&!1!==e.content&&!m.smooth()&&m.content()),v=Tn(f,Sn),y=Tn(f,_n),_=1,S=(I.isTouch&&Rn.visualViewport?Rn.visualViewport.scale*Rn.visualViewport.width:Rn.outerWidth)/Rn.innerWidth,b=0,T=Is(c)?()=>c(t):()=>c||2.8,x=Ga(f,e.type,!0,d),E=()=>n=!1,M=Ts,w=Ts,A=()=>{i=Cs(f,Sn),w=Nn(es?1:0,i),h&&(M=Nn(0,Cs(f,_n))),r=ga},L=()=>{g._gsap.y=xs(parseFloat(g._gsap.y)+v.offset)+"px",g.style.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, "+parseFloat(g._gsap.y)+", 0, 1)",v.offset=v.cacheID=0},C=()=>{A(),s.isActive()&&s.vars.scrollY>i&&(v()>i?s.progress(1)&&v(i):s.resetTo("scrollY",i))};return g&&Ln.set(g,{y:"+=0"}),e.ignoreCheck=e=>es&&"touchmove"===e.type&&(()=>{if(n){requestAnimationFrame(E);let e=xs(t.deltaY/2),i=w(v.v-e);if(g&&i!==v.v+v.offset){v.offset=i-v.v;let e=xs((parseFloat(g&&g._gsap.y)||0)-v.offset);g.style.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, "+e+", 0, 1)",g._gsap.y=e+"px",v.cacheID=hn.cache,Ta()}return!0}v.offset&&L(),n=!0})()||_>1.05&&"touchstart"!==e.type||t.isGesturing||e.touches&&e.touches.length>1,e.onPress=()=>{n=!1;let e=_;_=xs((Rn.visualViewport&&Rn.visualViewport.scale||1)/S),s.pause(),e!==_&&Fa(f,_>1.01||!h&&"x"),a=y(),o=v(),A(),r=ga},e.onRelease=e.onGestureStart=(e,t)=>{if(v.offset&&L(),t){hn.cache++;let t,r,n=T();h&&(t=y(),r=t+.05*n*-e.velocityX/.227,n*=Na(y,t,r,Cs(f,_n)),s.vars.scrollX=M(r)),t=v(),r=t+.05*n*-e.velocityY/.227,n*=Na(v,t,r,Cs(f,Sn)),s.vars.scrollY=w(r),s.invalidate().duration(n).play(.01),(es&&s.vars.scrollY>=i||t>=i-1)&&Ln.to({},{onUpdate:C,duration:n})}else l.restart(!0);u&&u(e)},e.onWheel=()=>{s._ts&&s.pause(),fs()-b>1e3&&(r=0,b=fs())},e.onChange=(e,t,i,n,s)=>{if(ga!==r&&A(),t&&h&&y(M(n[2]===t?a+(e.startX-e.x):y()+t-n[1])),i){v.offset&&L();let t=s[2]===i,r=t?o+e.startY-e.y:v()+i-s[1],n=w(r);t&&r!==n&&(o+=n-r),v(n)}(i||t)&&Ta()},e.onEnable=()=>{Fa(f,!h&&"x"),Ut.addEventListener("refresh",C),js(Rn,"resize",C),v.smooth&&(v.target.style.scrollBehavior="auto",v.smooth=y.smooth=!1),x.enable()},e.onDisable=()=>{Fa(f,!0),Ks(Rn,"resize",C),Ut.removeEventListener("refresh",C),x.kill()},e.lockAxis=!1!==e.lockAxis,t=new I(e),t.iOS=es,es&&!v()&&v(1),es&&Ln.ticker.add(Ts),l=t._dc,s=Ln.to(t,{ease:"power4",paused:!0,inherit:!1,scrollX:h?"+=0.1":"+=0",scrollY:"+=0.1",modifiers:{scrollY:Da(v,v(),()=>s.pause())},onUpdate:Ta,onComplete:l.vars.onComplete}),t})(e);return Xn&&Xn.target===t.target&&Xn.kill(),ws(t.target)&&(Xn=t),t},Ut.core={_getVelocityProp:xn,_inputObserver:Ga,_scrollers:hn,_proxies:cn,bridge:{ss:()=>{ms||da("scrollStart"),ms=fs()},ref:()=>Vn}},Ms()&&Ln.registerPlugin(Ut);const $a=Ut;let Wa,qa,ja,Ka,Ya,Xa,Qa,Za,Ja=()=>"undefined"!=typeof window,eo=()=>Wa||Ja()&&(Wa=window.gsap)&&Wa.registerPlugin&&Wa,to=e=>"string"==typeof e,io=e=>"function"==typeof e,ro=(e,t)=>{let i="x"===t?"Width":"Height",r="scroll"+i,n="client"+i;return e===ja||e===Ka||e===Ya?Math.max(Ka[r],Ya[r])-(ja["inner"+i]||Ka[n]||Ya[n]):e[r]-e["offset"+i]},no=(e,t)=>{let i="scroll"+("x"===t?"Left":"Top");return e===ja&&(null!=e.pageXOffset?i="page"+t.toUpperCase()+"Offset":e=null!=Ka[i]?Ka:Ya),()=>e[i]},so=(e,t)=>{if(!(e=Xa(e)[0])||!e.getBoundingClientRect)return console.warn("scrollTo target doesn't exist. Using 0")||{x:0,y:0};let i=e.getBoundingClientRect(),r=!t||t===ja||t===Ya,n=r?{top:Ka.clientTop-(ja.pageYOffset||Ka.scrollTop||Ya.scrollTop||0),left:Ka.clientLeft-(ja.pageXOffset||Ka.scrollLeft||Ya.scrollLeft||0)}:t.getBoundingClientRect(),s={x:i.left-n.left,y:i.top-n.top};return!r&&t&&(s.x+=no(t,"x")(),s.y+=no(t,"y")()),s},ao=(e,t,i,r,n)=>isNaN(e)||"object"==typeof e?to(e)&&"="===e.charAt(1)?parseFloat(e.substr(2))*("-"===e.charAt(0)?-1:1)+r-n:"max"===e?ro(t,i)-n:Math.min(ro(t,i),so(e,t)[i]-n):parseFloat(e)-n,oo=()=>{Wa=eo(),Ja()&&Wa&&"undefined"!=typeof document&&document.body&&(ja=window,Ya=document.body,Ka=document.documentElement,Xa=Wa.utils.toArray,Wa.config({autoKillThreshold:7}),Qa=Wa.config(),qa=1)};const lo={version:"3.12.7",name:"scrollTo",rawVars:1,register(e){Wa=e,oo()},init(e,t,i,r,n){qa||oo();let s=this,a=Wa.getProperty(e,"scrollSnapType");s.isWin=e===ja,s.target=e,s.tween=i,t=((e,t,i,r)=>{if(io(e)&&(e=e(t,i,r)),"object"!=typeof e)return to(e)&&"max"!==e&&"="!==e.charAt(1)?{x:e,y:e}:{y:e};if(e.nodeType)return{y:e,x:e};{let n,s={};for(n in e)s[n]="onAutoKill"!==n&&io(e[n])?e[n](t,i,r):e[n];return s}})(t,r,e,n),s.vars=t,s.autoKill=!!("autoKill"in t?t:Qa).autoKill,s.getX=no(e,"x"),s.getY=no(e,"y"),s.x=s.xPrev=s.getX(),s.y=s.yPrev=s.getY(),Za||(Za=Wa.core.globals().ScrollTrigger),"smooth"===Wa.getProperty(e,"scrollBehavior")&&Wa.set(e,{scrollBehavior:"auto"}),a&&"none"!==a&&(s.snap=1,s.snapInline=e.style.scrollSnapType,e.style.scrollSnapType="none"),null!=t.x?(s.add(s,"x",s.x,ao(t.x,e,"x",s.x,t.offsetX||0),r,n),s._props.push("scrollTo_x")):s.skipX=1,null!=t.y?(s.add(s,"y",s.y,ao(t.y,e,"y",s.y,t.offsetY||0),r,n),s._props.push("scrollTo_y")):s.skipY=1},render(e,t){let i,r,n,s,a,o=t._pt,{target:l,tween:h,autoKill:c,xPrev:d,yPrev:u,isWin:f,snap:p,snapInline:m}=t;for(;o;)o.r(e,o.d),o=o._next;i=f||!t.skipX?t.getX():d,r=f||!t.skipY?t.getY():u,n=r-u,s=i-d,a=Qa.autoKillThreshold,t.x<0&&(t.x=0),t.y<0&&(t.y=0),c&&(!t.skipX&&(s>a||s<-a)&&i<ro(l,"x")&&(t.skipX=1),!t.skipY&&(n>a||n<-a)&&r<ro(l,"y")&&(t.skipY=1),t.skipX&&t.skipY&&(h.kill(),t.vars.onAutoKill&&t.vars.onAutoKill.apply(h,t.vars.onAutoKillParams||[]))),f?ja.scrollTo(t.skipX?i:t.x,t.skipY?r:t.y):(t.skipY||(l.scrollTop=t.y),t.skipX||(l.scrollLeft=t.x)),!p||1!==e&&0!==e||(r=l.scrollTop,i=l.scrollLeft,m?l.style.scrollSnapType=m:l.style.removeProperty("scroll-snap-type"),l.scrollTop=r+1,l.scrollLeft=i+1,l.scrollTop=r,l.scrollLeft=i),t.xPrev=t.x,t.yPrev=t.y,Za&&Za.update()},kill(e){let t="scrollTo"===e,i=this._props.indexOf(e);return(t||"scrollTo_x"===e)&&(this.skipX=1),(t||"scrollTo_y"===e)&&(this.skipY=1),i>-1&&this._props.splice(i,1),!this._props.length}};lo.max=ro,lo.getOffset=so,lo.buildGetter=no,lo.config=e=>{Qa||oo()||(Qa=Wa.config());for(let t in e)Qa[t]=e[t]},eo()&&Wa.registerPlugin(lo);const ho=lo;function co(e){let t,i;if("null"==e)throw"not an dom reference";for(t=function(e){let t=1,i=e.tagName;for(;e.previousSibling;)1===(e=e.previousSibling).nodeType&&i.toLowerCase()===String(e.tagName).toLowerCase()&&t++;return t}(e);e.tagName;)i=e.localName+(i?">"+i:""),e=e.parentNode;return i+=`:nth-of-type(${t})`,i}var uo={},fo={},po=function(e){fo[e.type]&&fo[e.type].forEach(function(t){let i=function(e,t){if(["*","window","document","document.documentElement",window,document,document.documentElement].indexOf(t)>-1)return!0;if("string"!=typeof t&&t.contains){if(t===e)return t;if(t.contains(e))return e}return e.closest(t)}(e.target,t.selector);i&&(e.initiator=i,t.callback(e))})};uo.on=function(e,t,i){t&&i&&("object"==typeof t&&void 0!==t.nodeType&&(t=co(t)),e.split(",").forEach(function(e){e=e.trim(),fo[e]||(fo[e]=[],window.addEventListener(e,po,!0)),fo[e].push({selector:t,callback:i})}))},uo.off=function(e,t,i){"object"==typeof t&&void 0!==t.nodeType&&(t=co(t)),e.split(",").forEach(function(e){if(e=e.trim(),fo[e]){if(fo[e].length<2||!t)return delete fo[e],void window.removeEventListener(e,po,!0);var r=function(e,t,i){"object"==typeof t&&void 0!==t.nodeType&&(t=co(t));for(var r=0;r<e.length;r++)if(e[r].selector===t&&e[r].callback.toString()===i.toString())return r;return-1}(fo[e],t,i);r<0||fo[e].splice(r,1)}})},uo.once=function(e,t,i){"object"==typeof t&&void 0!==t.nodeType&&(t=co(t)),uo.on(e,t,function r(n){i(n),uo.off(e,t,r)})},uo.get=function(){var e={};for(var t in fo)Object.prototype.hasOwnProperty.call(fo,t)&&(e[t]=fo[t]);return e};const mo=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let go=1234567;const vo=Math.PI/180,yo=180/Math.PI;function _o(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(mo[255&e]+mo[e>>8&255]+mo[e>>16&255]+mo[e>>24&255]+"-"+mo[255&t]+mo[t>>8&255]+"-"+mo[t>>16&15|64]+mo[t>>24&255]+"-"+mo[63&i|128]+mo[i>>8&255]+"-"+mo[i>>16&255]+mo[i>>24&255]+mo[255&r]+mo[r>>8&255]+mo[r>>16&255]+mo[r>>24&255]).toLowerCase()}function So(e,t,i){return Math.max(t,Math.min(i,e))}function bo(e,t){return(e%t+t)%t}function To(e,t,i){return(1-i)*e+i*t}function xo(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Eo(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Mo={DEG2RAD:vo,RAD2DEG:yo,generateUUID:_o,clamp:So,euclideanModulo:bo,mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},inverseLerp:function(e,t,i){return e!==t?(i-e)/(t-e):0},lerp:To,damp:function(e,t,i,r){return To(e,t,1-Math.exp(-i*r))},pingpong:function(e,t=1){return t-Math.abs(bo(e,2*t)-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(go=e);let t=go+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*vo},radToDeg:function(e){return e*yo},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,i,r,n){const s=Math.cos,a=Math.sin,o=s(i/2),l=a(i/2),h=s((t+r)/2),c=a((t+r)/2),d=s((t-r)/2),u=a((t-r)/2),f=s((r-t)/2),p=a((r-t)/2);switch(n){case"XYX":e.set(o*c,l*d,l*u,o*h);break;case"YZY":e.set(l*u,o*c,l*d,o*h);break;case"ZXZ":e.set(l*d,l*u,o*c,o*h);break;case"XZX":e.set(o*c,l*p,l*f,o*h);break;case"YXY":e.set(l*f,o*c,l*p,o*h);break;case"ZYZ":e.set(l*p,l*f,o*c,o*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+n)}},normalize:Eo,denormalize:xo};class Quaternion{constructor(e=0,t=0,i=0,r=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=r}static slerpFlat(e,t,i,r,n,s,a){let o=i[r+0],l=i[r+1],h=i[r+2],c=i[r+3];const d=n[s+0],u=n[s+1],f=n[s+2],p=n[s+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=h,void(e[t+3]=c);if(1===a)return e[t+0]=d,e[t+1]=u,e[t+2]=f,void(e[t+3]=p);if(c!==p||o!==d||l!==u||h!==f){let e=1-a;const t=o*d+l*u+h*f+c*p,i=t>=0?1:-1,r=1-t*t;if(r>Number.EPSILON){const n=Math.sqrt(r),s=Math.atan2(n,t*i);e=Math.sin(e*s)/n,a=Math.sin(a*s)/n}const n=a*i;if(o=o*e+d*n,l=l*e+u*n,h=h*e+f*n,c=c*e+p*n,e===1-a){const e=1/Math.sqrt(o*o+l*l+h*h+c*c);o*=e,l*=e,h*=e,c*=e}}e[t]=o,e[t+1]=l,e[t+2]=h,e[t+3]=c}static multiplyQuaternionsFlat(e,t,i,r,n,s){const a=i[r],o=i[r+1],l=i[r+2],h=i[r+3],c=n[s],d=n[s+1],u=n[s+2],f=n[s+3];return e[t]=a*f+h*c+o*u-l*d,e[t+1]=o*f+h*d+l*c-a*u,e[t+2]=l*f+h*u+a*d-o*c,e[t+3]=h*f-a*c-o*d-l*u,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const i=e._x,r=e._y,n=e._z,s=e._order,a=Math.cos,o=Math.sin,l=a(i/2),h=a(r/2),c=a(n/2),d=o(i/2),u=o(r/2),f=o(n/2);switch(s){case"XYZ":this._x=d*h*c+l*u*f,this._y=l*u*c-d*h*f,this._z=l*h*f+d*u*c,this._w=l*h*c-d*u*f;break;case"YXZ":this._x=d*h*c+l*u*f,this._y=l*u*c-d*h*f,this._z=l*h*f-d*u*c,this._w=l*h*c+d*u*f;break;case"ZXY":this._x=d*h*c-l*u*f,this._y=l*u*c+d*h*f,this._z=l*h*f+d*u*c,this._w=l*h*c-d*u*f;break;case"ZYX":this._x=d*h*c-l*u*f,this._y=l*u*c+d*h*f,this._z=l*h*f-d*u*c,this._w=l*h*c+d*u*f;break;case"YZX":this._x=d*h*c+l*u*f,this._y=l*u*c+d*h*f,this._z=l*h*f-d*u*c,this._w=l*h*c-d*u*f;break;case"XZY":this._x=d*h*c-l*u*f,this._y=l*u*c-d*h*f,this._z=l*h*f+d*u*c,this._w=l*h*c+d*u*f;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,r=Math.sin(i);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],r=t[4],n=t[8],s=t[1],a=t[5],o=t[9],l=t[2],h=t[6],c=t[10],d=i+a+c;if(d>0){const e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(h-o)*e,this._y=(n-l)*e,this._z=(s-r)*e}else if(i>a&&i>c){const e=2*Math.sqrt(1+i-a-c);this._w=(h-o)/e,this._x=.25*e,this._y=(r+s)/e,this._z=(n+l)/e}else if(a>c){const e=2*Math.sqrt(1+a-i-c);this._w=(n-l)/e,this._x=(r+s)/e,this._y=.25*e,this._z=(o+h)/e}else{const e=2*Math.sqrt(1+c-i-a);this._w=(s-r)/e,this._x=(n+l)/e,this._y=(o+h)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(So(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const r=Math.min(1,t/i);return this.slerp(e,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,r=e._y,n=e._z,s=e._w,a=t._x,o=t._y,l=t._z,h=t._w;return this._x=i*h+s*a+r*l-n*o,this._y=r*h+s*o+n*a-i*l,this._z=n*h+s*l+i*o-r*a,this._w=s*h-i*a-r*o-n*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,r=this._y,n=this._z,s=this._w;let a=s*e._w+i*e._x+r*e._y+n*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=s,this._x=i,this._y=r,this._z=n,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*i+t*this._x,this._y=e*r+t*this._y,this._z=e*n+t*this._z,this.normalize(),this}const l=Math.sqrt(o),h=Math.atan2(l,a),c=Math.sin((1-t)*h)/l,d=Math.sin(t*h)/l;return this._w=s*c+this._w*d,this._x=i*c+this._x*d,this._y=r*c+this._y*d,this._z=n*c+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),i=Math.random(),r=Math.sqrt(1-i),n=Math.sqrt(i);return this.set(r*Math.sin(e),r*Math.cos(e),n*Math.sin(t),n*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Vector3{constructor(e=0,t=0,i=0){Vector3.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(Ao.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Ao.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*r,this.y=n[1]*t+n[4]*i+n[7]*r,this.z=n[2]*t+n[5]*i+n[8]*r,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,r=this.z,n=e.elements,s=1/(n[3]*t+n[7]*i+n[11]*r+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*r+n[12])*s,this.y=(n[1]*t+n[5]*i+n[9]*r+n[13])*s,this.z=(n[2]*t+n[6]*i+n[10]*r+n[14])*s,this}applyQuaternion(e){const t=this.x,i=this.y,r=this.z,n=e.x,s=e.y,a=e.z,o=e.w,l=2*(s*r-a*i),h=2*(a*t-n*r),c=2*(n*i-s*t);return this.x=t+o*l+s*c-a*h,this.y=i+o*h+a*l-n*c,this.z=r+o*c+n*h-s*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r,this.y=n[1]*t+n[5]*i+n[9]*r,this.z=n[2]*t+n[6]*i+n[10]*r,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=So(this.x,e.x,t.x),this.y=So(this.y,e.y,t.y),this.z=So(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=So(this.x,e,t),this.y=So(this.y,e,t),this.z=So(this.z,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(So(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,r=e.y,n=e.z,s=t.x,a=t.y,o=t.z;return this.x=r*o-n*a,this.y=n*s-i*o,this.z=i*a-r*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return wo.copy(this).projectOnVector(e),this.sub(wo)}reflect(e){return this.sub(wo.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(So(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,r=this.z-e.z;return t*t+i*i+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const r=Math.sin(t)*e;return this.x=r*Math.sin(i),this.y=Math.cos(t)*e,this.z=r*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=r,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,i=Math.sqrt(1-t*t);return this.x=i*Math.cos(e),this.y=t,this.z=i*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const wo=new Vector3,Ao=new Quaternion,Lo=0,Co=1,Ro=2,Po=100,Io=101,Do=102,ko=200,Oo=201,Uo=202,No=203,Fo=204,Bo=205,Vo=206,Go=207,zo=208,Ho=209,$o=210,Wo=211,qo=212,jo=213,Ko=214,Yo=0,Xo=1,Qo=2,Zo=3,Jo=4,el=5,tl=6,il=7,rl=301,nl=302,sl=306,al=1e3,ol=1001,ll=1002,hl=1003,cl=1004,dl=1005,ul=1006,fl=1007,pl=1008,ml=1009,gl=1010,vl=1011,yl=1012,_l=1013,Sl=1014,bl=1015,Tl=1016,xl=1017,El=1018,Ml=1020,wl=35902,Al=1023,Ll=1026,Cl=1027,Rl=1029,Pl=1031,Il=1033,Dl=33776,kl=33777,Ol=33778,Ul=33779,Nl=35840,Fl=35841,Bl=35842,Vl=35843,Gl=36196,zl=37492,Hl=37496,$l=37808,Wl=37809,ql=37810,jl=37811,Kl=37812,Yl=37813,Xl=37814,Ql=37815,Zl=37816,Jl=37817,eh=37818,th=37819,ih=37820,rh=37821,nh=36492,sh=36494,ah=36495,oh=36284,lh=36285,hh=36286,ch="",dh="srgb",uh="srgb-linear",fh="linear",ph="srgb",mh=7680,gh=512,vh=513,yh=514,_h=515,Sh=516,bh=517,Th=518,xh=519,Eh="300 es",Mh=2e3,wh=2001;class Matrix3{constructor(e,t,i,r,n,s,a,o,l){Matrix3.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,i,r,n,s,a,o,l)}set(e,t,i,r,n,s,a,o,l){const h=this.elements;return h[0]=e,h[1]=r,h[2]=a,h[3]=t,h[4]=n,h[5]=o,h[6]=i,h[7]=s,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,r=t.elements,n=this.elements,s=i[0],a=i[3],o=i[6],l=i[1],h=i[4],c=i[7],d=i[2],u=i[5],f=i[8],p=r[0],m=r[3],g=r[6],v=r[1],y=r[4],_=r[7],S=r[2],b=r[5],T=r[8];return n[0]=s*p+a*v+o*S,n[3]=s*m+a*y+o*b,n[6]=s*g+a*_+o*T,n[1]=l*p+h*v+c*S,n[4]=l*m+h*y+c*b,n[7]=l*g+h*_+c*T,n[2]=d*p+u*v+f*S,n[5]=d*m+u*y+f*b,n[8]=d*g+u*_+f*T,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=e[6],l=e[7],h=e[8];return t*s*h-t*a*l-i*n*h+i*a*o+r*n*l-r*s*o}invert(){const e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=e[6],l=e[7],h=e[8],c=h*s-a*l,d=a*o-h*n,u=l*n-s*o,f=t*c+i*d+r*u;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);const p=1/f;return e[0]=c*p,e[1]=(r*l-h*i)*p,e[2]=(a*i-r*s)*p,e[3]=d*p,e[4]=(h*t-r*o)*p,e[5]=(r*n-a*t)*p,e[6]=u*p,e[7]=(i*o-l*t)*p,e[8]=(s*t-i*n)*p,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,r,n,s,a){const o=Math.cos(n),l=Math.sin(n);return this.set(i*o,i*l,-i*(o*s+l*a)+s+e,-r*l,r*o,-r*(-l*s+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(Ah.makeScale(e,t)),this}rotate(e){return this.premultiply(Ah.makeRotation(-e)),this}translate(e,t){return this.premultiply(Ah.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Ah=new Matrix3,Lh=(new Matrix3).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),Ch=(new Matrix3).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function Rh(){const e={enabled:!0,workingColorSpace:uh,spaces:{},convert:function(e,t,i){return!1!==this.enabled&&t!==i&&t&&i?(this.spaces[t].transfer===ph&&(e.r=Ih(e.r),e.g=Ih(e.g),e.b=Ih(e.b)),this.spaces[t].primaries!==this.spaces[i].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[i].fromXYZ)),this.spaces[i].transfer===ph&&(e.r=Dh(e.r),e.g=Dh(e.g),e.b=Dh(e.b)),e):e},fromWorkingColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===ch?fh:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,i){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[i].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace}},t=[.64,.33,.3,.6,.15,.06],i=[.2126,.7152,.0722],r=[.3127,.329];return e.define({[uh]:{primaries:t,whitePoint:r,transfer:fh,toXYZ:Lh,fromXYZ:Ch,luminanceCoefficients:i,workingColorSpaceConfig:{unpackColorSpace:dh},outputColorSpaceConfig:{drawingBufferColorSpace:dh}},[dh]:{primaries:t,whitePoint:r,transfer:ph,toXYZ:Lh,fromXYZ:Ch,luminanceCoefficients:i,outputColorSpaceConfig:{drawingBufferColorSpace:dh}}}),e}const Ph=Rh();function Ih(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Dh(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}const kh={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Oh={h:0,s:0,l:0},Uh={h:0,s:0,l:0};function Nh(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}class Color{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){if(void 0===t&&void 0===i){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,i);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=dh){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Ph.toWorkingColorSpace(this,t),this}setRGB(e,t,i,r=Ph.workingColorSpace){return this.r=e,this.g=t,this.b=i,Ph.toWorkingColorSpace(this,r),this}setHSL(e,t,i,r=Ph.workingColorSpace){if(e=bo(e,1),t=So(t,0,1),i=So(i,0,1),0===t)this.r=this.g=this.b=i;else{const r=i<=.5?i*(1+t):i+t-i*t,n=2*i-r;this.r=Nh(n,r,e+1/3),this.g=Nh(n,r,e),this.b=Nh(n,r,e-1/3)}return Ph.toWorkingColorSpace(this,r),this}setStyle(e,t=dh){function i(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let r;if(r=/^(\w+)\(([^\)]*)\)/.exec(e)){let n;const s=r[1],a=r[2];switch(s){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setRGB(Math.min(255,parseInt(n[1],10))/255,Math.min(255,parseInt(n[2],10))/255,Math.min(255,parseInt(n[3],10))/255,t);if(n=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setRGB(Math.min(100,parseInt(n[1],10))/100,Math.min(100,parseInt(n[2],10))/100,Math.min(100,parseInt(n[3],10))/100,t);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return i(n[4]),this.setHSL(parseFloat(n[1])/360,parseFloat(n[2])/100,parseFloat(n[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){const i=r[1],n=i.length;if(3===n)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,t);if(6===n)return this.setHex(parseInt(i,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=dh){const i=kh[e.toLowerCase()];return void 0!==i?this.setHex(i,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Ih(e.r),this.g=Ih(e.g),this.b=Ih(e.b),this}copyLinearToSRGB(e){return this.r=Dh(e.r),this.g=Dh(e.g),this.b=Dh(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=dh){return Ph.fromWorkingColorSpace(Fh.copy(this),e),65536*Math.round(So(255*Fh.r,0,255))+256*Math.round(So(255*Fh.g,0,255))+Math.round(So(255*Fh.b,0,255))}getHexString(e=dh){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Ph.workingColorSpace){Ph.fromWorkingColorSpace(Fh.copy(this),t);const i=Fh.r,r=Fh.g,n=Fh.b,s=Math.max(i,r,n),a=Math.min(i,r,n);let o,l;const h=(a+s)/2;if(a===s)o=0,l=0;else{const e=s-a;switch(l=h<=.5?e/(s+a):e/(2-s-a),s){case i:o=(r-n)/e+(r<n?6:0);break;case r:o=(n-i)/e+2;break;case n:o=(i-r)/e+4}o/=6}return e.h=o,e.s=l,e.l=h,e}getRGB(e,t=Ph.workingColorSpace){return Ph.fromWorkingColorSpace(Fh.copy(this),t),e.r=Fh.r,e.g=Fh.g,e.b=Fh.b,e}getStyle(e=dh){Ph.fromWorkingColorSpace(Fh.copy(this),e);const t=Fh.r,i=Fh.g,r=Fh.b;return e!==dh?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${r.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*i)},${Math.round(255*r)})`}offsetHSL(e,t,i){return this.getHSL(Oh),this.setHSL(Oh.h+e,Oh.s+t,Oh.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(Oh),e.getHSL(Uh);const i=To(Oh.h,Uh.h,t),r=To(Oh.s,Uh.s,t),n=To(Oh.l,Uh.l,t);return this.setHSL(i,r,n),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,i=this.g,r=this.b,n=e.elements;return this.r=n[0]*t+n[3]*i+n[6]*r,this.g=n[1]*t+n[4]*i+n[7]*r,this.b=n[2]*t+n[5]*i+n[8]*r,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Fh=new Color;Color.NAMES=kh;class Box3{constructor(e=new Vector3(1/0,1/0,1/0),t=new Vector3(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint(Vh.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint(Vh.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=Vh.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const i=e.geometry;if(void 0!==i){const r=i.getAttribute("position");if(!0===t&&void 0!==r&&!0!==e.isInstancedMesh)for(let t=0,i=r.count;t<i;t++)!0===e.isMesh?e.getVertexPosition(t,Vh):Vh.fromBufferAttribute(r,t),Vh.applyMatrix4(e.matrixWorld),this.expandByPoint(Vh);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Gh.copy(e.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),Gh.copy(i.boundingBox)),Gh.applyMatrix4(e.matrixWorld),this.union(Gh)}const r=e.children;for(let e=0,i=r.length;e<i;e++)this.expandByObject(r[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,Vh),Vh.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Kh),Yh.subVectors(this.max,Kh),zh.subVectors(e.a,Kh),Hh.subVectors(e.b,Kh),$h.subVectors(e.c,Kh),Wh.subVectors(Hh,zh),qh.subVectors($h,Hh),jh.subVectors(zh,$h);let t=[0,-Wh.z,Wh.y,0,-qh.z,qh.y,0,-jh.z,jh.y,Wh.z,0,-Wh.x,qh.z,0,-qh.x,jh.z,0,-jh.x,-Wh.y,Wh.x,0,-qh.y,qh.x,0,-jh.y,jh.x,0];return!!Zh(t,zh,Hh,$h,Yh)&&(t=[1,0,0,0,1,0,0,0,1],!!Zh(t,zh,Hh,$h,Yh)&&(Xh.crossVectors(Wh,qh),t=[Xh.x,Xh.y,Xh.z],Zh(t,zh,Hh,$h,Yh)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Vh).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(Vh).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Bh[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Bh[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Bh[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Bh[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Bh[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Bh[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Bh[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Bh[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Bh)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const Bh=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],Vh=new Vector3,Gh=new Box3,zh=new Vector3,Hh=new Vector3,$h=new Vector3,Wh=new Vector3,qh=new Vector3,jh=new Vector3,Kh=new Vector3,Yh=new Vector3,Xh=new Vector3,Qh=new Vector3;function Zh(e,t,i,r,n){for(let s=0,a=e.length-3;s<=a;s+=3){Qh.fromArray(e,s);const a=n.x*Math.abs(Qh.x)+n.y*Math.abs(Qh.y)+n.z*Math.abs(Qh.z),o=t.dot(Qh),l=i.dot(Qh),h=r.dot(Qh);if(Math.max(-Math.max(o,l,h),Math.min(o,l,h))>a)return!1}return!0}const Jh=new Box3,ec=new Vector3,tc=new Vector3;class Sphere{constructor(e=new Vector3,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):Jh.setFromPoints(e).getCenter(i);let r=0;for(let t=0,n=e.length;t<n;t++)r=Math.max(r,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(r),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;ec.subVectors(e,this.center);const t=ec.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),i=.5*(e-this.radius);this.center.addScaledVector(ec,i/e),this.radius+=i}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(tc.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(ec.copy(e.center).add(tc)),this.expandByPoint(ec.copy(e.center).sub(tc))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const ic=new Vector3,rc=new Vector3,nc=new Matrix3;class Plane{constructor(e=new Vector3(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const r=ic.subVectors(i,t).cross(rc.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const i=e.delta(ic),r=this.normal.dot(i);if(0===r)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const n=-(e.start.dot(this.normal)+this.constant)/r;return n<0||n>1?null:t.copy(e.start).addScaledVector(i,n)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||nc.getNormalMatrix(e),r=this.coplanarPoint(ic).applyMatrix4(e),n=this.normal.applyMatrix3(i).normalize();return this.constant=-r.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const sc=new Sphere,ac=new Vector3;class Frustum{constructor(e=new Plane,t=new Plane,i=new Plane,r=new Plane,n=new Plane,s=new Plane){this.planes=[e,t,i,r,n,s]}set(e,t,i,r,n,s){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(s),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=2e3){const i=this.planes,r=e.elements,n=r[0],s=r[1],a=r[2],o=r[3],l=r[4],h=r[5],c=r[6],d=r[7],u=r[8],f=r[9],p=r[10],m=r[11],g=r[12],v=r[13],y=r[14],_=r[15];if(i[0].setComponents(o-n,d-l,m-u,_-g).normalize(),i[1].setComponents(o+n,d+l,m+u,_+g).normalize(),i[2].setComponents(o+s,d+h,m+f,_+v).normalize(),i[3].setComponents(o-s,d-h,m-f,_-v).normalize(),i[4].setComponents(o-a,d-c,m-p,_-y).normalize(),t===Mh)i[5].setComponents(o+a,d+c,m+p,_+y).normalize();else{if(t!==wh)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);i[5].setComponents(a,c,p,y).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),sc.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),sc.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(sc)}intersectsSprite(e){return sc.center.set(0,0,0),sc.radius=.7071067811865476,sc.applyMatrix4(e.matrixWorld),this.intersectsSphere(sc)}intersectsSphere(e){const t=this.planes,i=e.center,r=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(i)<r)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const r=t[i];if(ac.x=r.normal.x>0?e.max.x:e.min.x,ac.y=r.normal.y>0?e.max.y:e.min.y,ac.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(ac)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class Matrix4{constructor(e,t,i,r,n,s,a,o,l,h,c,d,u,f,p,m){Matrix4.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,i,r,n,s,a,o,l,h,c,d,u,f,p,m)}set(e,t,i,r,n,s,a,o,l,h,c,d,u,f,p,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=r,g[1]=n,g[5]=s,g[9]=a,g[13]=o,g[2]=l,g[6]=h,g[10]=c,g[14]=d,g[3]=u,g[7]=f,g[11]=p,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,r=1/oc.setFromMatrixColumn(e,0).length(),n=1/oc.setFromMatrixColumn(e,1).length(),s=1/oc.setFromMatrixColumn(e,2).length();return t[0]=i[0]*r,t[1]=i[1]*r,t[2]=i[2]*r,t[3]=0,t[4]=i[4]*n,t[5]=i[5]*n,t[6]=i[6]*n,t[7]=0,t[8]=i[8]*s,t[9]=i[9]*s,t[10]=i[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,r=e.y,n=e.z,s=Math.cos(i),a=Math.sin(i),o=Math.cos(r),l=Math.sin(r),h=Math.cos(n),c=Math.sin(n);if("XYZ"===e.order){const e=s*h,i=s*c,r=a*h,n=a*c;t[0]=o*h,t[4]=-o*c,t[8]=l,t[1]=i+r*l,t[5]=e-n*l,t[9]=-a*o,t[2]=n-e*l,t[6]=r+i*l,t[10]=s*o}else if("YXZ"===e.order){const e=o*h,i=o*c,r=l*h,n=l*c;t[0]=e+n*a,t[4]=r*a-i,t[8]=s*l,t[1]=s*c,t[5]=s*h,t[9]=-a,t[2]=i*a-r,t[6]=n+e*a,t[10]=s*o}else if("ZXY"===e.order){const e=o*h,i=o*c,r=l*h,n=l*c;t[0]=e-n*a,t[4]=-s*c,t[8]=r+i*a,t[1]=i+r*a,t[5]=s*h,t[9]=n-e*a,t[2]=-s*l,t[6]=a,t[10]=s*o}else if("ZYX"===e.order){const e=s*h,i=s*c,r=a*h,n=a*c;t[0]=o*h,t[4]=r*l-i,t[8]=e*l+n,t[1]=o*c,t[5]=n*l+e,t[9]=i*l-r,t[2]=-l,t[6]=a*o,t[10]=s*o}else if("YZX"===e.order){const e=s*o,i=s*l,r=a*o,n=a*l;t[0]=o*h,t[4]=n-e*c,t[8]=r*c+i,t[1]=c,t[5]=s*h,t[9]=-a*h,t[2]=-l*h,t[6]=i*c+r,t[10]=e-n*c}else if("XZY"===e.order){const e=s*o,i=s*l,r=a*o,n=a*l;t[0]=o*h,t[4]=-c,t[8]=l*h,t[1]=e*c+n,t[5]=s*h,t[9]=i*c-r,t[2]=r*c-i,t[6]=a*h,t[10]=n*c+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(hc,e,cc)}lookAt(e,t,i){const r=this.elements;return fc.subVectors(e,t),0===fc.lengthSq()&&(fc.z=1),fc.normalize(),dc.crossVectors(i,fc),0===dc.lengthSq()&&(1===Math.abs(i.z)?fc.x+=1e-4:fc.z+=1e-4,fc.normalize(),dc.crossVectors(i,fc)),dc.normalize(),uc.crossVectors(fc,dc),r[0]=dc.x,r[4]=uc.x,r[8]=fc.x,r[1]=dc.y,r[5]=uc.y,r[9]=fc.y,r[2]=dc.z,r[6]=uc.z,r[10]=fc.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,r=t.elements,n=this.elements,s=i[0],a=i[4],o=i[8],l=i[12],h=i[1],c=i[5],d=i[9],u=i[13],f=i[2],p=i[6],m=i[10],g=i[14],v=i[3],y=i[7],_=i[11],S=i[15],b=r[0],T=r[4],x=r[8],E=r[12],M=r[1],w=r[5],A=r[9],L=r[13],C=r[2],R=r[6],P=r[10],D=r[14],k=r[3],O=r[7],U=r[11],N=r[15];return n[0]=s*b+a*M+o*C+l*k,n[4]=s*T+a*w+o*R+l*O,n[8]=s*x+a*A+o*P+l*U,n[12]=s*E+a*L+o*D+l*N,n[1]=h*b+c*M+d*C+u*k,n[5]=h*T+c*w+d*R+u*O,n[9]=h*x+c*A+d*P+u*U,n[13]=h*E+c*L+d*D+u*N,n[2]=f*b+p*M+m*C+g*k,n[6]=f*T+p*w+m*R+g*O,n[10]=f*x+p*A+m*P+g*U,n[14]=f*E+p*L+m*D+g*N,n[3]=v*b+y*M+_*C+S*k,n[7]=v*T+y*w+_*R+S*O,n[11]=v*x+y*A+_*P+S*U,n[15]=v*E+y*L+_*D+S*N,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],r=e[8],n=e[12],s=e[1],a=e[5],o=e[9],l=e[13],h=e[2],c=e[6],d=e[10],u=e[14];return e[3]*(+n*o*c-r*l*c-n*a*d+i*l*d+r*a*u-i*o*u)+e[7]*(+t*o*u-t*l*d+n*s*d-r*s*u+r*l*h-n*o*h)+e[11]*(+t*l*c-t*a*u-n*s*c+i*s*u+n*a*h-i*l*h)+e[15]*(-r*a*h-t*o*c+t*a*d+r*s*c-i*s*d+i*o*h)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=t,r[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=e[6],l=e[7],h=e[8],c=e[9],d=e[10],u=e[11],f=e[12],p=e[13],m=e[14],g=e[15],v=c*m*l-p*d*l+p*o*u-a*m*u-c*o*g+a*d*g,y=f*d*l-h*m*l-f*o*u+s*m*u+h*o*g-s*d*g,_=h*p*l-f*c*l+f*a*u-s*p*u-h*a*g+s*c*g,S=f*c*o-h*p*o-f*a*d+s*p*d+h*a*m-s*c*m,b=t*v+i*y+r*_+n*S;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const T=1/b;return e[0]=v*T,e[1]=(p*d*n-c*m*n-p*r*u+i*m*u+c*r*g-i*d*g)*T,e[2]=(a*m*n-p*o*n+p*r*l-i*m*l-a*r*g+i*o*g)*T,e[3]=(c*o*n-a*d*n-c*r*l+i*d*l+a*r*u-i*o*u)*T,e[4]=y*T,e[5]=(h*m*n-f*d*n+f*r*u-t*m*u-h*r*g+t*d*g)*T,e[6]=(f*o*n-s*m*n-f*r*l+t*m*l+s*r*g-t*o*g)*T,e[7]=(s*d*n-h*o*n+h*r*l-t*d*l-s*r*u+t*o*u)*T,e[8]=_*T,e[9]=(f*c*n-h*p*n-f*i*u+t*p*u+h*i*g-t*c*g)*T,e[10]=(s*p*n-f*a*n+f*i*l-t*p*l-s*i*g+t*a*g)*T,e[11]=(h*a*n-s*c*n-h*i*l+t*c*l+s*i*u-t*a*u)*T,e[12]=S*T,e[13]=(h*p*r-f*c*r+f*i*d-t*p*d-h*i*m+t*c*m)*T,e[14]=(f*a*r-s*p*r-f*i*o+t*p*o+s*i*m-t*a*m)*T,e[15]=(s*c*r-h*a*r+h*i*o-t*c*o-s*i*d+t*a*d)*T,this}scale(e){const t=this.elements,i=e.x,r=e.y,n=e.z;return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),r=Math.sin(t),n=1-i,s=e.x,a=e.y,o=e.z,l=n*s,h=n*a;return this.set(l*s+i,l*a-r*o,l*o+r*a,0,l*a+r*o,h*a+i,h*o-r*s,0,l*o-r*a,h*o+r*s,n*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,r,n,s){return this.set(1,i,n,0,e,1,s,0,t,r,1,0,0,0,0,1),this}compose(e,t,i){const r=this.elements,n=t._x,s=t._y,a=t._z,o=t._w,l=n+n,h=s+s,c=a+a,d=n*l,u=n*h,f=n*c,p=s*h,m=s*c,g=a*c,v=o*l,y=o*h,_=o*c,S=i.x,b=i.y,T=i.z;return r[0]=(1-(p+g))*S,r[1]=(u+_)*S,r[2]=(f-y)*S,r[3]=0,r[4]=(u-_)*b,r[5]=(1-(d+g))*b,r[6]=(m+v)*b,r[7]=0,r[8]=(f+y)*T,r[9]=(m-v)*T,r[10]=(1-(d+p))*T,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}decompose(e,t,i){const r=this.elements;let n=oc.set(r[0],r[1],r[2]).length();const s=oc.set(r[4],r[5],r[6]).length(),a=oc.set(r[8],r[9],r[10]).length();this.determinant()<0&&(n=-n),e.x=r[12],e.y=r[13],e.z=r[14],lc.copy(this);const o=1/n,l=1/s,h=1/a;return lc.elements[0]*=o,lc.elements[1]*=o,lc.elements[2]*=o,lc.elements[4]*=l,lc.elements[5]*=l,lc.elements[6]*=l,lc.elements[8]*=h,lc.elements[9]*=h,lc.elements[10]*=h,t.setFromRotationMatrix(lc),i.x=n,i.y=s,i.z=a,this}makePerspective(e,t,i,r,n,s,a=2e3){const o=this.elements,l=2*n/(t-e),h=2*n/(i-r),c=(t+e)/(t-e),d=(i+r)/(i-r);let u,f;if(a===Mh)u=-(s+n)/(s-n),f=-2*s*n/(s-n);else{if(a!==wh)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);u=-s/(s-n),f=-s*n/(s-n)}return o[0]=l,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=h,o[9]=d,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=f,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,i,r,n,s,a=2e3){const o=this.elements,l=1/(t-e),h=1/(i-r),c=1/(s-n),d=(t+e)*l,u=(i+r)*h;let f,p;if(a===Mh)f=(s+n)*c,p=-2*c;else{if(a!==wh)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);f=n*c,p=-1*c}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-d,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=p,o[14]=-f,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const oc=new Vector3,lc=new Matrix4,hc=new Vector3(0,0,0),cc=new Vector3(1,1,1),dc=new Vector3,uc=new Vector3,fc=new Vector3;class Vector4{constructor(e=0,t=0,i=0,r=1){Vector4.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,r=this.z,n=this.w,s=e.elements;return this.x=s[0]*t+s[4]*i+s[8]*r+s[12]*n,this.y=s[1]*t+s[5]*i+s[9]*r+s[13]*n,this.z=s[2]*t+s[6]*i+s[10]*r+s[14]*n,this.w=s[3]*t+s[7]*i+s[11]*r+s[15]*n,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,r,n;const s=.01,a=.1,o=e.elements,l=o[0],h=o[4],c=o[8],d=o[1],u=o[5],f=o[9],p=o[2],m=o[6],g=o[10];if(Math.abs(h-d)<s&&Math.abs(c-p)<s&&Math.abs(f-m)<s){if(Math.abs(h+d)<a&&Math.abs(c+p)<a&&Math.abs(f+m)<a&&Math.abs(l+u+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(u+1)/2,v=(g+1)/2,y=(h+d)/4,_=(c+p)/4,S=(f+m)/4;return e>o&&e>v?e<s?(i=0,r=.707106781,n=.707106781):(i=Math.sqrt(e),r=y/i,n=_/i):o>v?o<s?(i=.707106781,r=0,n=.707106781):(r=Math.sqrt(o),i=y/r,n=S/r):v<s?(i=.707106781,r=.707106781,n=0):(n=Math.sqrt(v),i=_/n,r=S/n),this.set(i,r,n,t),this}let v=Math.sqrt((m-f)*(m-f)+(c-p)*(c-p)+(d-h)*(d-h));return Math.abs(v)<.001&&(v=1),this.x=(m-f)/v,this.y=(c-p)/v,this.z=(d-h)/v,this.w=Math.acos((l+u+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=So(this.x,e.x,t.x),this.y=So(this.y,e.y,t.y),this.z=So(this.z,e.z,t.z),this.w=So(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=So(this.x,e,t),this.y=So(this.y,e,t),this.z=So(this.z,e,t),this.w=So(this.w,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(So(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}function pc(){let e=null,t=!1,i=null,r=null;function n(t,s){i(t,s),r=e.requestAnimationFrame(n)}return{start:function(){!0!==t&&null!==i&&(r=e.requestAnimationFrame(n),t=!0)},stop:function(){e.cancelAnimationFrame(r),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function mc(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);const r=t.get(i);r&&(e.deleteBuffer(r.buffer),t.delete(i))},update:function(i,r){if(i.isInterleavedBufferAttribute&&(i=i.data),i.isGLBufferAttribute){const e=t.get(i);return void((!e||e.version<i.version)&&t.set(i,{buffer:i.buffer,type:i.type,bytesPerElement:i.elementSize,version:i.version}))}const n=t.get(i);if(void 0===n)t.set(i,function(t,i){const r=t.array,n=t.usage,s=r.byteLength,a=e.createBuffer();let o;if(e.bindBuffer(i,a),e.bufferData(i,r,n),t.onUploadCallback(),r instanceof Float32Array)o=5126;else if(r instanceof Uint16Array)o=t.isFloat16BufferAttribute?5131:5123;else if(r instanceof Int16Array)o=5122;else if(r instanceof Uint32Array)o=5125;else if(r instanceof Int32Array)o=5124;else if(r instanceof Int8Array)o=5120;else if(r instanceof Uint8Array)o=5121;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);o=5121}return{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version,size:s}}(i,r));else if(n.version<i.version){if(n.size!==i.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,i,r){const n=i.array,s=i.updateRanges;if(e.bindBuffer(r,t),0===s.length)e.bufferSubData(r,0,n);else{s.sort((e,t)=>e.start-t.start);let t=0;for(let e=1;e<s.length;e++){const i=s[t],r=s[e];r.start<=i.start+i.count+1?i.count=Math.max(i.count,r.start+r.count-i.start):(++t,s[t]=r)}s.length=t+1;for(let t=0,i=s.length;t<i;t++){const i=s[t];e.bufferSubData(r,i.start*n.BYTES_PER_ELEMENT,n,i.start,i.count)}i.clearUpdateRanges()}i.onUploadCallback()}(n.buffer,i,r),n.version=i.version}}}}class Vector2{constructor(e=0,t=0){Vector2.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6],this.y=r[1]*t+r[4]*i+r[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=So(this.x,e.x,t.x),this.y=So(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=So(this.x,e,t),this.y=So(this.y,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(So(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(So(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),r=Math.sin(t),n=this.x-e.x,s=this.y-e.y;return this.x=n*i-s*r+e.x,this.y=n*r+s*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class EventDispatcher{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return void 0!==i&&(void 0!==i[e]&&-1!==i[e].indexOf(t))}removeEventListener(e,t){const i=this._listeners;if(void 0===i)return;const r=i[e];if(void 0!==r){const e=r.indexOf(t);-1!==e&&r.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const i=t[e.type];if(void 0!==i){e.target=this;const t=i.slice(0);for(let i=0,r=t.length;i<r;i++)t[i].call(this,e);e.target=null}}}const gc=new Vector3,vc=new Vector2;let yc=0;class BufferAttribute{constructor(e,t,i=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:yc++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i,this.usage=35044,this.updateRanges=[],this.gpuType=bl,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let r=0,n=this.itemSize;r<n;r++)this.array[e+r]=t.array[i+r];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)vc.fromBufferAttribute(this,t),vc.applyMatrix3(e),this.setXY(t,vc.x,vc.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)gc.fromBufferAttribute(this,t),gc.applyMatrix3(e),this.setXYZ(t,gc.x,gc.y,gc.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)gc.fromBufferAttribute(this,t),gc.applyMatrix4(e),this.setXYZ(t,gc.x,gc.y,gc.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)gc.fromBufferAttribute(this,t),gc.applyNormalMatrix(e),this.setXYZ(t,gc.x,gc.y,gc.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)gc.fromBufferAttribute(this,t),gc.transformDirection(e),this.setXYZ(t,gc.x,gc.y,gc.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=xo(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=Eo(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=xo(t,this.array)),t}setX(e,t){return this.normalized&&(t=Eo(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=xo(t,this.array)),t}setY(e,t){return this.normalized&&(t=Eo(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=xo(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Eo(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=xo(t,this.array)),t}setW(e,t){return this.normalized&&(t=Eo(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=Eo(t,this.array),i=Eo(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,r){return e*=this.itemSize,this.normalized&&(t=Eo(t,this.array),i=Eo(i,this.array),r=Eo(r,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this}setXYZW(e,t,i,r,n){return e*=this.itemSize,this.normalized&&(t=Eo(t,this.array),i=Eo(i,this.array),r=Eo(r,this.array),n=Eo(n,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this.array[e+3]=n,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class Uint16BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class Uint32BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class Float32BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Float32Array(e),t,i)}}const _c=new Matrix4,Sc=new Quaternion;class Euler{constructor(e=0,t=0,i=0,r=Euler.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,r=this._order){return this._x=e,this._y=t,this._z=i,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const r=e.elements,n=r[0],s=r[4],a=r[8],o=r[1],l=r[5],h=r[9],c=r[2],d=r[6],u=r[10];switch(t){case"XYZ":this._y=Math.asin(So(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-h,u),this._z=Math.atan2(-s,n)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-So(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(a,u),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-c,n),this._z=0);break;case"ZXY":this._x=Math.asin(So(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-c,u),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(o,n));break;case"ZYX":this._y=Math.asin(-So(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(d,u),this._z=Math.atan2(o,n)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(So(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-c,n)):(this._x=0,this._y=Math.atan2(a,u));break;case"XZY":this._z=Math.asin(-So(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,n)):(this._x=Math.atan2(-h,u),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return _c.makeRotationFromQuaternion(e),this.setFromRotationMatrix(_c,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Sc.setFromEuler(this),this.setFromQuaternion(Sc,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Euler.DEFAULT_ORDER="XYZ";class Layers{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let bc=0;const Tc=new Vector3,xc=new Quaternion,Ec=new Matrix4,Mc=new Vector3,wc=new Vector3,Ac=new Vector3,Lc=new Quaternion,Cc=new Vector3(1,0,0),Rc=new Vector3(0,1,0),Pc=new Vector3(0,0,1),Ic={type:"added"},Dc={type:"removed"},kc={type:"childadded",child:null},Oc={type:"childremoved",child:null};class Object3D extends EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:bc++}),this.uuid=_o(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DEFAULT_UP.clone();const e=new Vector3,t=new Euler,i=new Quaternion,r=new Vector3(1,1,1);t._onChange(function(){i.setFromEuler(t,!1)}),i._onChange(function(){t.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return xc.setFromAxisAngle(e,t),this.quaternion.multiply(xc),this}rotateOnWorldAxis(e,t){return xc.setFromAxisAngle(e,t),this.quaternion.premultiply(xc),this}rotateX(e){return this.rotateOnAxis(Cc,e)}rotateY(e){return this.rotateOnAxis(Rc,e)}rotateZ(e){return this.rotateOnAxis(Pc,e)}translateOnAxis(e,t){return Tc.copy(e).applyQuaternion(this.quaternion),this.position.add(Tc.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Cc,e)}translateY(e){return this.translateOnAxis(Rc,e)}translateZ(e){return this.translateOnAxis(Pc,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Ec.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?Mc.copy(e):Mc.set(e,t,i);const r=this.parent;this.updateWorldMatrix(!0,!1),wc.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ec.lookAt(wc,Mc,this.up):Ec.lookAt(Mc,wc,this.up),this.quaternion.setFromRotationMatrix(Ec),r&&(Ec.extractRotation(r.matrixWorld),xc.setFromRotationMatrix(Ec),this.quaternion.premultiply(xc.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Ic),kc.child=e,this.dispatchEvent(kc),kc.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Dc),Oc.child=e,this.dispatchEvent(Oc),Oc.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Ec.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Ec.multiply(e.parent.matrixWorld)),e.applyMatrix4(Ec),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Ic),kc.child=e,this.dispatchEvent(kc),kc.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,r=this.children.length;i<r;i++){const r=this.children[i].getObjectByProperty(e,t);if(void 0!==r)return r}}getObjectsByProperty(e,t,i=[]){this[e]===t&&i.push(this);const r=this.children;for(let n=0,s=r.length;n<s;n++)r[n].getObjectsByProperty(e,t,i);return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wc,e,Ac),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wc,Lc,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,r=t.length;i<r;i++){t[i].updateMatrixWorld(e)}}updateWorldMatrix(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++){e[t].updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const r={};function n(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),r.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(r.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(r.type="BatchedMesh",r.perObjectFrustumCulled=this.perObjectFrustumCulled,r.sortObjects=this.sortObjects,r.drawRanges=this._drawRanges,r.reservedRanges=this._reservedRanges,r.visibility=this._visibility,r.active=this._active,r.bounds=this._bounds.map(e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()})),r.maxInstanceCount=this._maxInstanceCount,r.maxVertexCount=this._maxVertexCount,r.maxIndexCount=this._maxIndexCount,r.geometryInitialized=this._geometryInitialized,r.geometryCount=this._geometryCount,r.matricesTexture=this._matricesTexture.toJSON(e),null!==this._colorsTexture&&(r.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(r.boundingSphere={center:r.boundingSphere.center.toArray(),radius:r.boundingSphere.radius}),null!==this.boundingBox&&(r.boundingBox={min:r.boundingBox.min.toArray(),max:r.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(r.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=n(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,r=i.length;t<r;t++){const r=i[t];n(e.shapes,r)}else n(e.shapes,i)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(n(e.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,r=this.material.length;i<r;i++)t.push(n(e.materials,this.material[i]));r.material=t}else r.material=n(e.materials,this.material);if(this.children.length>0){r.children=[];for(let t=0;t<this.children.length;t++)r.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){r.animations=[];for(let t=0;t<this.animations.length;t++){const i=this.animations[t];r.animations.push(n(e.animations,i))}}if(t){const t=s(e.geometries),r=s(e.materials),n=s(e.textures),a=s(e.images),o=s(e.shapes),l=s(e.skeletons),h=s(e.animations),c=s(e.nodes);t.length>0&&(i.geometries=t),r.length>0&&(i.materials=r),n.length>0&&(i.textures=n),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),h.length>0&&(i.animations=h),c.length>0&&(i.nodes=c)}return i.object=r,i;function s(e){const t=[];for(const i in e){const r=e[i];delete r.metadata,t.push(r)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const i=e.children[t];this.add(i.clone())}return this}}function Uc(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}Object3D.DEFAULT_UP=new Vector3(0,1,0),Object3D.DEFAULT_MATRIX_AUTO_UPDATE=!0,Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;function Nc(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function Fc(){const e=Nc("canvas");return e.style.display="block",e}const Bc={};function Vc(e){e in Bc||(Bc[e]=!0,console.warn(e))}let Gc=0;const zc=new Matrix4,Hc=new Object3D,$c=new Vector3,Wc=new Box3,qc=new Box3,jc=new Vector3;class BufferGeometry extends EventDispatcher{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Gc++}),this.uuid=_o(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Uc(e)?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new Matrix3).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const r=this.attributes.tangent;return void 0!==r&&(r.transformDirection(e),r.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return zc.makeRotationFromQuaternion(e),this.applyMatrix4(zc),this}rotateX(e){return zc.makeRotationX(e),this.applyMatrix4(zc),this}rotateY(e){return zc.makeRotationY(e),this.applyMatrix4(zc),this}rotateZ(e){return zc.makeRotationZ(e),this.applyMatrix4(zc),this}translate(e,t,i){return zc.makeTranslation(e,t,i),this.applyMatrix4(zc),this}scale(e,t,i){return zc.makeScale(e,t,i),this.applyMatrix4(zc),this}lookAt(e){return Hc.lookAt(e),Hc.updateMatrix(),this.applyMatrix4(Hc.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter($c).negate(),this.translate($c.x,$c.y,$c.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let i=0,r=e.length;i<r;i++){const r=e[i];t.push(r.x,r.y,r.z||0)}this.setAttribute("position",new Float32BufferAttribute(t,3))}else{const i=Math.min(e.length,t.count);for(let r=0;r<i;r++){const i=e[r];t.setXYZ(r,i.x,i.y,i.z||0)}e.length>t.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new Vector3(-1/0,-1/0,-1/0),new Vector3(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];Wc.setFromBufferAttribute(i),this.morphTargetsRelative?(jc.addVectors(this.boundingBox.min,Wc.min),this.boundingBox.expandByPoint(jc),jc.addVectors(this.boundingBox.max,Wc.max),this.boundingBox.expandByPoint(jc)):(this.boundingBox.expandByPoint(Wc.min),this.boundingBox.expandByPoint(Wc.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Vector3,1/0);if(e){const i=this.boundingSphere.center;if(Wc.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];qc.setFromBufferAttribute(i),this.morphTargetsRelative?(jc.addVectors(Wc.min,qc.min),Wc.expandByPoint(jc),jc.addVectors(Wc.max,qc.max),Wc.expandByPoint(jc)):(Wc.expandByPoint(qc.min),Wc.expandByPoint(qc.max))}Wc.getCenter(i);let r=0;for(let t=0,n=e.count;t<n;t++)jc.fromBufferAttribute(e,t),r=Math.max(r,i.distanceToSquared(jc));if(t)for(let n=0,s=t.length;n<s;n++){const s=t[n],a=this.morphTargetsRelative;for(let t=0,n=s.count;t<n;t++)jc.fromBufferAttribute(s,t),a&&($c.fromBufferAttribute(e,t),jc.add($c)),r=Math.max(r,i.distanceToSquared(jc))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=t.position,r=t.normal,n=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new BufferAttribute(new Float32Array(4*i.count),4));const s=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<i.count;e++)a[e]=new Vector3,o[e]=new Vector3;const l=new Vector3,h=new Vector3,c=new Vector3,d=new Vector2,u=new Vector2,f=new Vector2,p=new Vector3,m=new Vector3;function g(e,t,r){l.fromBufferAttribute(i,e),h.fromBufferAttribute(i,t),c.fromBufferAttribute(i,r),d.fromBufferAttribute(n,e),u.fromBufferAttribute(n,t),f.fromBufferAttribute(n,r),h.sub(l),c.sub(l),u.sub(d),f.sub(d);const s=1/(u.x*f.y-f.x*u.y);isFinite(s)&&(p.copy(h).multiplyScalar(f.y).addScaledVector(c,-u.y).multiplyScalar(s),m.copy(c).multiplyScalar(u.x).addScaledVector(h,-f.x).multiplyScalar(s),a[e].add(p),a[t].add(p),a[r].add(p),o[e].add(m),o[t].add(m),o[r].add(m))}let v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let t=0,i=v.length;t<i;++t){const i=v[t],r=i.start;for(let t=r,n=r+i.count;t<n;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const y=new Vector3,_=new Vector3,S=new Vector3,b=new Vector3;function T(e){S.fromBufferAttribute(r,e),b.copy(S);const t=a[e];y.copy(t),y.sub(S.multiplyScalar(S.dot(t))).normalize(),_.crossVectors(b,t);const i=_.dot(o[e])<0?-1:1;s.setXYZW(e,y.x,y.y,y.z,i)}for(let t=0,i=v.length;t<i;++t){const i=v[t],r=i.start;for(let t=r,n=r+i.count;t<n;t+=3)T(e.getX(t+0)),T(e.getX(t+1)),T(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new BufferAttribute(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const r=new Vector3,n=new Vector3,s=new Vector3,a=new Vector3,o=new Vector3,l=new Vector3,h=new Vector3,c=new Vector3;if(e)for(let d=0,u=e.count;d<u;d+=3){const u=e.getX(d+0),f=e.getX(d+1),p=e.getX(d+2);r.fromBufferAttribute(t,u),n.fromBufferAttribute(t,f),s.fromBufferAttribute(t,p),h.subVectors(s,n),c.subVectors(r,n),h.cross(c),a.fromBufferAttribute(i,u),o.fromBufferAttribute(i,f),l.fromBufferAttribute(i,p),a.add(h),o.add(h),l.add(h),i.setXYZ(u,a.x,a.y,a.z),i.setXYZ(f,o.x,o.y,o.z),i.setXYZ(p,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)r.fromBufferAttribute(t,e+0),n.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),h.subVectors(s,n),c.subVectors(r,n),h.cross(c),i.setXYZ(e+0,h.x,h.y,h.z),i.setXYZ(e+1,h.x,h.y,h.z),i.setXYZ(e+2,h.x,h.y,h.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)jc.fromBufferAttribute(e,t),jc.normalize(),e.setXYZ(t,jc.x,jc.y,jc.z)}toNonIndexed(){function e(e,t){const i=e.array,r=e.itemSize,n=e.normalized,s=new i.constructor(t.length*r);let a=0,o=0;for(let n=0,l=t.length;n<l;n++){a=e.isInterleavedBufferAttribute?t[n]*e.data.stride+e.offset:t[n]*r;for(let e=0;e<r;e++)s[o++]=i[a++]}return new BufferAttribute(s,r,n)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new BufferGeometry,i=this.index.array,r=this.attributes;for(const n in r){const s=e(r[n],i);t.setAttribute(n,s)}const n=this.morphAttributes;for(const r in n){const s=[],a=n[r];for(let t=0,r=a.length;t<r;t++){const r=e(a[t],i);s.push(r)}t.morphAttributes[r]=s}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let e=0,i=s.length;e<i;e++){const i=s[e];t.addGroup(i.start,i.count,i.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const t in i){const r=i[t];e.data.attributes[t]=r.toJSON(e.data)}const r={};let n=!1;for(const t in this.morphAttributes){const i=this.morphAttributes[t],s=[];for(let t=0,r=i.length;t<r;t++){const r=i[t];s.push(r.toJSON(e.data))}s.length>0&&(r[t]=s,n=!0)}n&&(e.data.morphAttributes=r,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone(t));const r=e.attributes;for(const e in r){const i=r[e];this.setAttribute(e,i.clone(t))}const n=e.morphAttributes;for(const e in n){const i=[],r=n[e];for(let e=0,n=r.length;e<n;e++)i.push(r[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}class BoxGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,r=1,n=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:n,depthSegments:s};const a=this;r=Math.floor(r),n=Math.floor(n),s=Math.floor(s);const o=[],l=[],h=[],c=[];let d=0,u=0;function f(e,t,i,r,n,s,f,p,m,g,v){const y=s/m,_=f/g,S=s/2,b=f/2,T=p/2,x=m+1,E=g+1;let M=0,w=0;const A=new Vector3;for(let s=0;s<E;s++){const a=s*_-b;for(let o=0;o<x;o++){const d=o*y-S;A[e]=d*r,A[t]=a*n,A[i]=T,l.push(A.x,A.y,A.z),A[e]=0,A[t]=0,A[i]=p>0?1:-1,h.push(A.x,A.y,A.z),c.push(o/m),c.push(1-s/g),M+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const i=d+t+x*e,r=d+t+x*(e+1),n=d+(t+1)+x*(e+1),s=d+(t+1)+x*e;o.push(i,r,s),o.push(r,n,s),w+=6}a.addGroup(u,w,v),u+=w,d+=M}f("z","y","x",-1,-1,i,t,e,s,n,0),f("z","y","x",1,-1,i,t,-e,s,n,1),f("x","z","y",1,1,e,i,t,r,s,2),f("x","z","y",1,-1,e,i,-t,r,s,3),f("x","y","z",1,-1,e,t,i,r,n,4),f("x","y","z",-1,-1,e,t,-i,r,n,5),this.setIndex(o),this.setAttribute("position",new Float32BufferAttribute(l,3)),this.setAttribute("normal",new Float32BufferAttribute(h,3)),this.setAttribute("uv",new Float32BufferAttribute(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new BoxGeometry(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}class PlaneGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,r=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r};const n=e/2,s=t/2,a=Math.floor(i),o=Math.floor(r),l=a+1,h=o+1,c=e/a,d=t/o,u=[],f=[],p=[],m=[];for(let e=0;e<h;e++){const t=e*d-s;for(let i=0;i<l;i++){const r=i*c-n;f.push(r,-t,0),p.push(0,0,1),m.push(i/a),m.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){const i=t+l*e,r=t+l*(e+1),n=t+1+l*(e+1),s=t+1+l*e;u.push(i,r,s),u.push(r,n,s)}this.setIndex(u),this.setAttribute("position",new Float32BufferAttribute(f,3)),this.setAttribute("normal",new Float32BufferAttribute(p,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new PlaneGeometry(e.width,e.height,e.widthSegments,e.heightSegments)}}let Kc=0;class Material extends EventDispatcher{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Kc++}),this.uuid=_o(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=Po,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Color(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=mh,this.stencilZFail=mh,this.stencilZPass=mh,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const r=this[t];void 0!==r?r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]=i:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function r(e){const t=[];for(const i in e){const r=e[i];delete r.metadata,t.push(r)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),this.blendEquation!==Po&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==mh&&(i.stencilFail=this.stencilFail),this.stencilZFail!==mh&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==mh&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),t){const t=r(e.textures),n=r(e.images);t.length>0&&(i.textures=t),n.length>0&&(i.images=n)}return i}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let r=0;r!==e;++r)i[r]=t[r].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}}function Yc(e){const t={};for(const i in e){t[i]={};for(const r in e[i]){const n=e[i][r];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture||n.isQuaternion)?n.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[i][r]=null):t[i][r]=n.clone():Array.isArray(n)?t[i][r]=n.slice():t[i][r]=n}}return t}function Xc(e){const t={};for(let i=0;i<e.length;i++){const r=Yc(e[i]);for(const e in r)t[e]=r[e]}return t}function Qc(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:Ph.workingColorSpace}const Zc={clone:Yc,merge:Xc};class ShaderMaterial extends Material{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",this.fragmentShader="void main(){gl_FragColor=vec4(1.0,0.0,0.0,1.0);}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Yc(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const r=this.uniforms[i].value;r&&r.isTexture?t.uniforms[i]={type:"t",value:r.toJSON(e).uuid}:r&&r.isColor?t.uniforms[i]={type:"c",value:r.getHex()}:r&&r.isVector2?t.uniforms[i]={type:"v2",value:r.toArray()}:r&&r.isVector3?t.uniforms[i]={type:"v3",value:r.toArray()}:r&&r.isVector4?t.uniforms[i]={type:"v4",value:r.toArray()}:r&&r.isMatrix3?t.uniforms[i]={type:"m3",value:r.toArray()}:r&&r.isMatrix4?t.uniforms[i]={type:"m4",value:r.toArray()}:t.uniforms[i]={value:r}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const i={};for(const e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}const Jc=new Vector3,ed=new Vector3,td=new Vector3,id=new Vector3,rd=new Vector3,nd=new Vector3,sd=new Vector3;class Ray{constructor(e=new Vector3,t=new Vector3(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Jc)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Jc.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Jc.copy(this.origin).addScaledVector(this.direction,t),Jc.distanceToSquared(e))}distanceSqToSegment(e,t,i,r){ed.copy(e).add(t).multiplyScalar(.5),td.copy(t).sub(e).normalize(),id.copy(this.origin).sub(ed);const n=.5*e.distanceTo(t),s=-this.direction.dot(td),a=id.dot(this.direction),o=-id.dot(td),l=id.lengthSq(),h=Math.abs(1-s*s);let c,d,u,f;if(h>0)if(c=s*o-a,d=s*a-o,f=n*h,c>=0)if(d>=-f)if(d<=f){const e=1/h;c*=e,d*=e,u=c*(c+s*d+2*a)+d*(s*c+d+2*o)+l}else d=n,c=Math.max(0,-(s*d+a)),u=-c*c+d*(d+2*o)+l;else d=-n,c=Math.max(0,-(s*d+a)),u=-c*c+d*(d+2*o)+l;else d<=-f?(c=Math.max(0,-(-s*n+a)),d=c>0?-n:Math.min(Math.max(-n,-o),n),u=-c*c+d*(d+2*o)+l):d<=f?(c=0,d=Math.min(Math.max(-n,-o),n),u=d*(d+2*o)+l):(c=Math.max(0,-(s*n+a)),d=c>0?n:Math.min(Math.max(-n,-o),n),u=-c*c+d*(d+2*o)+l);else d=s>0?-n:n,c=Math.max(0,-(s*d+a)),u=-c*c+d*(d+2*o)+l;return i&&i.copy(this.origin).addScaledVector(this.direction,c),r&&r.copy(ed).addScaledVector(td,d),u}intersectSphere(e,t){Jc.subVectors(e.center,this.origin);const i=Jc.dot(this.direction),r=Jc.dot(Jc)-i*i,n=e.radius*e.radius;if(r>n)return null;const s=Math.sqrt(n-r),a=i-s,o=i+s;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,r,n,s,a,o;const l=1/this.direction.x,h=1/this.direction.y,c=1/this.direction.z,d=this.origin;return l>=0?(i=(e.min.x-d.x)*l,r=(e.max.x-d.x)*l):(i=(e.max.x-d.x)*l,r=(e.min.x-d.x)*l),h>=0?(n=(e.min.y-d.y)*h,s=(e.max.y-d.y)*h):(n=(e.max.y-d.y)*h,s=(e.min.y-d.y)*h),i>s||n>r?null:((n>i||isNaN(i))&&(i=n),(s<r||isNaN(r))&&(r=s),c>=0?(a=(e.min.z-d.z)*c,o=(e.max.z-d.z)*c):(a=(e.max.z-d.z)*c,o=(e.min.z-d.z)*c),i>o||a>r?null:((a>i||i!=i)&&(i=a),(o<r||r!=r)&&(r=o),r<0?null:this.at(i>=0?i:r,t)))}intersectsBox(e){return null!==this.intersectBox(e,Jc)}intersectTriangle(e,t,i,r,n){rd.subVectors(t,e),nd.subVectors(i,e),sd.crossVectors(rd,nd);let s,a=this.direction.dot(sd);if(a>0){if(r)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}id.subVectors(this.origin,e);const o=s*this.direction.dot(nd.crossVectors(id,nd));if(o<0)return null;const l=s*this.direction.dot(rd.cross(id));if(l<0)return null;if(o+l>a)return null;const h=-s*id.dot(sd);return h<0?null:this.at(h/a,n)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}const ad=new Vector3,od=new Vector3,ld=new Vector3,hd=new Vector3,cd=new Vector3,dd=new Vector3,ud=new Vector3,fd=new Vector3,pd=new Vector3,md=new Vector3,gd=new Vector4,vd=new Vector4,yd=new Vector4;class Triangle{constructor(e=new Vector3,t=new Vector3,i=new Vector3){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,r){r.subVectors(i,t),ad.subVectors(e,t),r.cross(ad);const n=r.lengthSq();return n>0?r.multiplyScalar(1/Math.sqrt(n)):r.set(0,0,0)}static getBarycoord(e,t,i,r,n){ad.subVectors(r,t),od.subVectors(i,t),ld.subVectors(e,t);const s=ad.dot(ad),a=ad.dot(od),o=ad.dot(ld),l=od.dot(od),h=od.dot(ld),c=s*l-a*a;if(0===c)return n.set(0,0,0),null;const d=1/c,u=(l*o-a*h)*d,f=(s*h-a*o)*d;return n.set(1-u-f,f,u)}static containsPoint(e,t,i,r){return null!==this.getBarycoord(e,t,i,r,hd)&&(hd.x>=0&&hd.y>=0&&hd.x+hd.y<=1)}static getInterpolation(e,t,i,r,n,s,a,o){return null===this.getBarycoord(e,t,i,r,hd)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(n,hd.x),o.addScaledVector(s,hd.y),o.addScaledVector(a,hd.z),o)}static getInterpolatedAttribute(e,t,i,r,n,s){return gd.setScalar(0),vd.setScalar(0),yd.setScalar(0),gd.fromBufferAttribute(e,t),vd.fromBufferAttribute(e,i),yd.fromBufferAttribute(e,r),s.setScalar(0),s.addScaledVector(gd,n.x),s.addScaledVector(vd,n.y),s.addScaledVector(yd,n.z),s}static isFrontFacing(e,t,i,r){return ad.subVectors(i,t),od.subVectors(e,t),ad.cross(od).dot(r)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this}setFromAttributeAndIndices(e,t,i,r){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,r),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return ad.subVectors(this.c,this.b),od.subVectors(this.a,this.b),.5*ad.cross(od).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Triangle.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Triangle.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,i,r,n){return Triangle.getInterpolation(e,this.a,this.b,this.c,t,i,r,n)}containsPoint(e){return Triangle.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Triangle.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,r=this.b,n=this.c;let s,a;cd.subVectors(r,i),dd.subVectors(n,i),fd.subVectors(e,i);const o=cd.dot(fd),l=dd.dot(fd);if(o<=0&&l<=0)return t.copy(i);pd.subVectors(e,r);const h=cd.dot(pd),c=dd.dot(pd);if(h>=0&&c<=h)return t.copy(r);const d=o*c-h*l;if(d<=0&&o>=0&&h<=0)return s=o/(o-h),t.copy(i).addScaledVector(cd,s);md.subVectors(e,n);const u=cd.dot(md),f=dd.dot(md);if(f>=0&&u<=f)return t.copy(n);const p=u*l-o*f;if(p<=0&&l>=0&&f<=0)return a=l/(l-f),t.copy(i).addScaledVector(dd,a);const m=h*f-u*c;if(m<=0&&c-h>=0&&u-f>=0)return ud.subVectors(n,r),a=(c-h)/(c-h+(u-f)),t.copy(r).addScaledVector(ud,a);const g=1/(m+p+d);return s=p*g,a=d*g,t.copy(i).addScaledVector(cd,s).addScaledVector(dd,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}class MeshBasicMaterial extends Material{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const _d=new Matrix4,Sd=new Ray,bd=new Sphere,Td=new Vector3,xd=new Vector3,Ed=new Vector3,Md=new Vector3,wd=new Vector3,Ad=new Vector3,Ld=new Vector3,Cd=new Vector3;class Mesh extends Object3D{constructor(e=new BufferGeometry,t=new MeshBasicMaterial){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const i=this.geometry,r=i.attributes.position,n=i.morphAttributes.position,s=i.morphTargetsRelative;t.fromBufferAttribute(r,e);const a=this.morphTargetInfluences;if(n&&a){Ad.set(0,0,0);for(let i=0,r=n.length;i<r;i++){const r=a[i],o=n[i];0!==r&&(wd.fromBufferAttribute(o,e),s?Ad.addScaledVector(wd,r):Ad.addScaledVector(wd.sub(t),r))}t.add(Ad)}return t}raycast(e,t){const i=this.geometry,r=this.material,n=this.matrixWorld;if(void 0!==r){if(null===i.boundingSphere&&i.computeBoundingSphere(),bd.copy(i.boundingSphere),bd.applyMatrix4(n),Sd.copy(e.ray).recast(e.near),!1===bd.containsPoint(Sd.origin)){if(null===Sd.intersectSphere(bd,Td))return;if(Sd.origin.distanceToSquared(Td)>(e.far-e.near)**2)return}_d.copy(n).invert(),Sd.copy(e.ray).applyMatrix4(_d),null!==i.boundingBox&&!1===Sd.intersectsBox(i.boundingBox)||this._computeIntersections(e,t,Sd)}}_computeIntersections(e,t,i){let r;const n=this.geometry,s=this.material,a=n.index,o=n.attributes.position,l=n.attributes.uv,h=n.attributes.uv1,c=n.attributes.normal,d=n.groups,u=n.drawRange;if(null!==a)if(Array.isArray(s))for(let n=0,o=d.length;n<o;n++){const o=d[n],f=s[o.materialIndex];for(let n=Math.max(o.start,u.start),s=Math.min(a.count,Math.min(o.start+o.count,u.start+u.count));n<s;n+=3){r=Rd(this,f,e,i,l,h,c,a.getX(n),a.getX(n+1),a.getX(n+2)),r&&(r.faceIndex=Math.floor(n/3),r.face.materialIndex=o.materialIndex,t.push(r))}}else{for(let n=Math.max(0,u.start),o=Math.min(a.count,u.start+u.count);n<o;n+=3){r=Rd(this,s,e,i,l,h,c,a.getX(n),a.getX(n+1),a.getX(n+2)),r&&(r.faceIndex=Math.floor(n/3),t.push(r))}}else if(void 0!==o)if(Array.isArray(s))for(let n=0,a=d.length;n<a;n++){const a=d[n],f=s[a.materialIndex];for(let n=Math.max(a.start,u.start),s=Math.min(o.count,Math.min(a.start+a.count,u.start+u.count));n<s;n+=3){r=Rd(this,f,e,i,l,h,c,n,n+1,n+2),r&&(r.faceIndex=Math.floor(n/3),r.face.materialIndex=a.materialIndex,t.push(r))}}else{for(let n=Math.max(0,u.start),a=Math.min(o.count,u.start+u.count);n<a;n+=3){r=Rd(this,s,e,i,l,h,c,n,n+1,n+2),r&&(r.faceIndex=Math.floor(n/3),t.push(r))}}}}function Rd(e,t,i,r,n,s,a,o,l,h){e.getVertexPosition(o,xd),e.getVertexPosition(l,Ed),e.getVertexPosition(h,Md);const c=function(e,t,i,r,n,s,a,o){let l;if(l=1===t.side?r.intersectTriangle(a,s,n,!0,o):r.intersectTriangle(n,s,a,0===t.side,o),null===l)return null;Cd.copy(o),Cd.applyMatrix4(e.matrixWorld);const h=i.ray.origin.distanceTo(Cd);return h<i.near||h>i.far?null:{distance:h,point:Cd.clone(),object:e}}(e,t,i,r,xd,Ed,Md,Ld);if(c){const e=new Vector3;Triangle.getBarycoord(Ld,xd,Ed,Md,e),n&&(c.uv=Triangle.getInterpolatedAttribute(n,o,l,h,e,new Vector2)),s&&(c.uv1=Triangle.getInterpolatedAttribute(s,o,l,h,e,new Vector2)),a&&(c.normal=Triangle.getInterpolatedAttribute(a,o,l,h,e,new Vector3),c.normal.dot(r.direction)>0&&c.normal.multiplyScalar(-1));const t={a:o,b:l,c:h,normal:new Vector3,materialIndex:0};Triangle.getNormal(xd,Ed,Md,t.normal),c.face=t,c.barycoord=e}return c}const Pd={alphahash_fragment:"#ifdef USE_ALPHAHASH\nif(diffuseColor.a<getAlphaHashThreshold(vPosition))discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\nconst float ALPHA_HASH_SCALE=0.05;float hash2D(vec2 value){return fract(1.0e4*sin(17.0*value.x+0.1*value.y)*(0.1+abs(sin(13.0*value.y+value.x))));}float hash3D(vec3 value){return hash2D(vec2(hash2D(value.xy),value.z));}float getAlphaHashThreshold(vec3 position){float maxDeriv=max(length(dFdx(position.xyz)),length(dFdy(position.xyz)));float pixScale=1.0/(ALPHA_HASH_SCALE*maxDeriv);vec2 pixScales=vec2(exp2(floor(log2(pixScale))),exp2(ceil(log2(pixScale))));vec2 alpha=vec2(hash3D(floor(pixScales.x*position.xyz)),hash3D(floor(pixScales.y*position.xyz)));float lerpFactor=fract(log2(pixScale));float x=(1.0-lerpFactor)*alpha.x+lerpFactor*alpha.y;float a=min(lerpFactor,1.0-lerpFactor);vec3 cases=vec3(x*x/(2.0*a*(1.0-a)),(x-0.5*a)/(1.0-a),1.0-((1.0-x)*(1.0-x)/(2.0*a*(1.0-a))));float threshold=(x<(1.0-a))?((x<a)?cases.x:cases.y):cases.z;return clamp(threshold,1.0e-6,1.0);}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,vAlphaMapUv).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n#ifdef ALPHA_TO_COVERAGE\ndiffuseColor.a=smoothstep(alphaTest,alphaTest+fwidth(diffuseColor.a),diffuseColor.a);if(diffuseColor.a==0.0)discard;\n#else\nif(diffuseColor.a<alphaTest)discard;\n#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\nuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\nfloat ambientOcclusion=(texture2D(aoMap,vAoMapUv).r-1.0)*aoMapIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(USE_CLEARCOAT)\nclearcoatSpecularIndirect*=ambientOcclusion;\n#endif\n#if defined(USE_SHEEN)\nsheenSpecularIndirect*=ambientOcclusion;\n#endif\n#if defined(USE_ENVMAP)&&defined(STANDARD)\nfloat dotNV=saturate(dot(geometryNormal,geometryViewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.roughness);\n#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\nuniform sampler2D aoMap;uniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n#if !defined(GL_ANGLE_multi_draw)\n#define gl_DrawID _gl_DrawID\nuniform int _gl_DrawID;\n#endif\nuniform highp sampler2D batchingTexture;uniform highp usampler2D batchingIdTexture;mat4 getBatchingMatrix(const in float i){int size=textureSize(batchingTexture,0).x;int j=int(i)*4;int x=j%size;int y=j/size;vec4 v1=texelFetch(batchingTexture,ivec2(x,y),0);vec4 v2=texelFetch(batchingTexture,ivec2(x+1,y),0);vec4 v3=texelFetch(batchingTexture,ivec2(x+2,y),0);vec4 v4=texelFetch(batchingTexture,ivec2(x+3,y),0);return mat4(v1,v2,v3,v4);}float getIndirectIndex(const in int i){int size=textureSize(batchingIdTexture,0).x;int x=i%size;int y=i/size;return float(texelFetch(batchingIdTexture,ivec2(x,y),0).r);}\n#endif\n#ifdef USE_BATCHING_COLOR\nuniform sampler2D batchingColorTexture;vec3 getBatchingColor(const in float i){int size=textureSize(batchingColorTexture,0).x;int j=int(i);int x=j%size;int y=j/size;return texelFetch(batchingColorTexture,ivec2(x,y),0).rgb;}\n#endif",batching_vertex:"#ifdef USE_BATCHING\nmat4 batchingMatrix=getBatchingMatrix(getIndirectIndex(gl_DrawID));\n#endif",begin_vertex:"vec3 transformed=vec3(position);\n#ifdef USE_ALPHAHASH\nvPosition=vec3(position);\n#endif",beginnormal_vertex:"vec3 objectNormal=vec3(normal);\n#ifdef USE_TANGENT\nvec3 objectTangent=vec3(tangent.xyz);\n#endif",bsdfs:"float G_BlinnPhong_Implicit(){return 0.25;}float D_BlinnPhong(const in float shininess,const in float dotNH){return RECIPROCAL_PI*(shininess*0.5+1.0)*pow(dotNH,shininess);}vec3 BRDF_BlinnPhong(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float shininess){vec3 halfDir=normalize(lightDir+viewDir);float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));vec3 F=F_Schlick(specularColor,1.0,dotVH);float G=G_BlinnPhong_Implicit();float D=D_BlinnPhong(shininess,dotNH);return F*(G*D);}",iridescence_fragment:"#ifdef USE_IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(3.2404542,-0.9692660,0.0556434,-1.5371385,1.8760108,-0.2040259,-0.4985314,0.0415560,1.0572252);vec3 Fresnel0ToIor(vec3 fresnel0){vec3 sqrtF0=sqrt(fresnel0);return(vec3(1.0)+sqrtF0)/(vec3(1.0)-sqrtF0);}vec3 IorToFresnel0(vec3 transmittedIor,float incidentIor){return pow2((transmittedIor-vec3(incidentIor))/(transmittedIor+vec3(incidentIor)));}float IorToFresnel0(float transmittedIor,float incidentIor){return pow2((transmittedIor-incidentIor)/(transmittedIor+incidentIor));}vec3 evalSensitivity(float OPD,vec3 shift){float phase=2.0*PI*OPD*1.0e-9;vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-pow2(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*pow2(phase));xyz/=1.0685e-7;vec3 rgb=XYZ_TO_REC709*xyz;return rgb;}vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0){vec3 I;float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=pow2(outsideIOR/iridescenceIOR)*(1.0-pow2(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if(cosTheta2Sq<0.0){return vec3(1.0);}float cosTheta2=sqrt(cosTheta2Sq);float R0=IorToFresnel0(iridescenceIOR,outsideIOR);float R12=F_Schlick(R0,1.0,cosTheta1);float T121=1.0-R12;float phi12=0.0;if(iridescenceIOR<outsideIOR)phi12=PI;float phi21=PI-phi12;vec3 baseIOR=Fresnel0ToIor(clamp(baseF0,0.0,0.9999));vec3 R1=IorToFresnel0(baseIOR,iridescenceIOR);vec3 R23=F_Schlick(R1,1.0,cosTheta2);vec3 phi23=vec3(0.0);if(baseIOR[0]<iridescenceIOR)phi23[0]=PI;if(baseIOR[1]<iridescenceIOR)phi23[1]=PI;if(baseIOR[2]<iridescenceIOR)phi23[2]=PI;float OPD=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=pow2(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for(int m=1;m<=2;++m){Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*OPD,float(m)*phi);I+=Cm*Sm;}return max(I,vec3(0.0));}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;uniform float bumpScale;vec2 dHdxy_fwd(){vec2 dSTdx=dFdx(vBumpMapUv);vec2 dSTdy=dFdy(vBumpMapUv);float Hll=bumpScale*texture2D(bumpMap,vBumpMapUv).x;float dBx=bumpScale*texture2D(bumpMap,vBumpMapUv+dSTdx).x-Hll;float dBy=bumpScale*texture2D(bumpMap,vBumpMapUv+dSTdy).x-Hll;return vec2(dBx,dBy);}vec3 perturbNormalArb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=normalize(dFdx(surf_pos.xyz));vec3 vSigmaY=normalize(dFdy(surf_pos.xyz));vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES>0\nvec4 plane;\n#ifdef ALPHA_TO_COVERAGE\nfloat distanceToPlane,distanceGradient;float clipOpacity=1.0;\n#pragma unroll_loop_start\nfor(int i=0;i<UNION_CLIPPING_PLANES;i++){plane=clippingPlanes[i];distanceToPlane=-dot(vClipPosition,plane.xyz)+plane.w;distanceGradient=fwidth(distanceToPlane)/2.0;clipOpacity*=smoothstep(-distanceGradient,distanceGradient,distanceToPlane);if(clipOpacity==0.0)discard;}\n#pragma unroll_loop_end\n#if UNION_CLIPPING_PLANES<NUM_CLIPPING_PLANES\nfloat unionClipOpacity=1.0;\n#pragma unroll_loop_start\nfor(int i=UNION_CLIPPING_PLANES;i<NUM_CLIPPING_PLANES;i++){plane=clippingPlanes[i];distanceToPlane=-dot(vClipPosition,plane.xyz)+plane.w;distanceGradient=fwidth(distanceToPlane)/2.0;unionClipOpacity*=1.0-smoothstep(-distanceGradient,distanceGradient,distanceToPlane);}\n#pragma unroll_loop_end\nclipOpacity*=1.0-unionClipOpacity;\n#endif\ndiffuseColor.a*=clipOpacity;if(diffuseColor.a==0.0)discard;\n#else\n#pragma unroll_loop_start\nfor(int i=0;i<UNION_CLIPPING_PLANES;i++){plane=clippingPlanes[i];if(dot(vClipPosition,plane.xyz)>plane.w)discard;}\n#pragma unroll_loop_end\n#if UNION_CLIPPING_PLANES<NUM_CLIPPING_PLANES\nbool clipped=true;\n#pragma unroll_loop_start\nfor(int i=UNION_CLIPPING_PLANES;i<NUM_CLIPPING_PLANES;i++){plane=clippingPlanes[i];clipped=(dot(vClipPosition,plane.xyz)>plane.w)&&clipped;}\n#pragma unroll_loop_end\nif(clipped)discard;\n#endif\n#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES>0\nvClipPosition=-mvPosition.xyz;\n#endif",color_fragment:"#if defined(USE_COLOR_ALPHA)\ndiffuseColor*=vColor;\n#elif defined(USE_COLOR)\ndiffuseColor.rgb*=vColor;\n#endif",color_pars_fragment:"#if defined(USE_COLOR_ALPHA)\nvarying vec4 vColor;\n#elif defined(USE_COLOR)\nvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined(USE_COLOR_ALPHA)\nvarying vec4 vColor;\n#elif defined(USE_COLOR)||defined(USE_INSTANCING_COLOR)||defined(USE_BATCHING_COLOR)\nvarying vec3 vColor;\n#endif",color_vertex:"#if defined(USE_COLOR_ALPHA)\nvColor=vec4(1.0);\n#elif defined(USE_COLOR)||defined(USE_INSTANCING_COLOR)||defined(USE_BATCHING_COLOR)\nvColor=vec3(1.0);\n#endif\n#ifdef USE_COLOR\nvColor*=color;\n#endif\n#ifdef USE_INSTANCING_COLOR\nvColor.xyz*=instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\nvec3 batchingColor=getBatchingColor(getIndirectIndex(gl_DrawID));vColor.xyz*=batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\n#define whiteComplement(a)(1.0-saturate(a))\nfloat pow2(const in float x){return x*x;}vec3 pow2(const in vec3 x){return x*x;}float pow3(const in float x){return x*x*x;}float pow4(const in float x){float x2=x*x;return x2*x2;}float max3(const in vec3 v){return max(max(v.x,v.y),v.z);}float average(const in vec3 v){return dot(v,vec3(0.3333333));}highp float rand(const in vec2 uv){const highp float a=12.9898,b=78.233,c=43758.5453;highp float dt=dot(uv.xy,vec2(a,b)),sn=mod(dt,PI);return fract(sin(sn)*c);}\n#ifdef HIGH_PRECISION\nfloat precisionSafeLength(vec3 v){return length(v);}\n#else\nfloat precisionSafeLength(vec3 v){float maxComponent=max3(abs(v));return length(v/maxComponent)*maxComponent;}\n#endif\nstruct IncidentLight{vec3 color;vec3 direction;bool visible;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};\n#ifdef USE_ALPHAHASH\nvarying vec3 vPosition;\n#endif\nvec3 transformDirection(in vec3 dir,in mat4 matrix){return normalize((matrix*vec4(dir,0.0)).xyz);}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}mat3 transposeMat3(const in mat3 m){mat3 tmp;tmp[0]=vec3(m[0].x,m[1].x,m[2].x);tmp[1]=vec3(m[0].y,m[1].y,m[2].y);tmp[2]=vec3(m[0].z,m[1].z,m[2].z);return tmp;}bool isPerspectiveMatrix(mat4 m){return m[2][3]==-1.0;}vec2 equirectUv(in vec3 dir){float u=atan(dir.z,dir.x)*RECIPROCAL_PI2+0.5;float v=asin(clamp(dir.y,-1.0,1.0))*RECIPROCAL_PI+0.5;return vec2(u,v);}vec3 BRDF_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}vec3 F_Schlick(const in vec3 f0,const in float f90,const in float dotVH){float fresnel=exp2((-5.55473*dotVH-6.98316)*dotVH);return f0*(1.0-fresnel)+(f90*fresnel);}float F_Schlick(const in float f0,const in float f90,const in float dotVH){float fresnel=exp2((-5.55473*dotVH-6.98316)*dotVH);return f0*(1.0-fresnel)+(f90*fresnel);}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_minMipLevel 4.0\n#define cubeUV_minTileSize 16.0\nfloat getFace(vec3 direction){vec3 absDirection=abs(direction);float face=-1.0;if(absDirection.x>absDirection.z){if(absDirection.x>absDirection.y)face=direction.x>0.0?0.0:3.0;else face=direction.y>0.0?1.0:4.0;}else{if(absDirection.z>absDirection.y)face=direction.z>0.0?2.0:5.0;else face=direction.y>0.0?1.0:4.0;}return face;}vec2 getUV(vec3 direction,float face){vec2 uv;if(face==0.0){uv=vec2(direction.z,direction.y)/abs(direction.x);}else if(face==1.0){uv=vec2(-direction.x,-direction.z)/abs(direction.y);}else if(face==2.0){uv=vec2(-direction.x,direction.y)/abs(direction.z);}else if(face==3.0){uv=vec2(-direction.z,direction.y)/abs(direction.x);}else if(face==4.0){uv=vec2(-direction.x,direction.z)/abs(direction.y);}else{uv=vec2(direction.x,direction.y)/abs(direction.z);}return 0.5*(uv+1.0);}vec3 bilinearCubeUV(sampler2D envMap,vec3 direction,float mipInt){float face=getFace(direction);float filterInt=max(cubeUV_minMipLevel-mipInt,0.0);mipInt=max(mipInt,cubeUV_minMipLevel);float faceSize=exp2(mipInt);highp vec2 uv=getUV(direction,face)*(faceSize-2.0)+1.0;if(face>2.0){uv.y+=faceSize;face-=3.0;}uv.x+=face*faceSize;uv.x+=filterInt*3.0*cubeUV_minTileSize;uv.y+=4.0*(exp2(CUBEUV_MAX_MIP)-faceSize);uv.x*=CUBEUV_TEXEL_WIDTH;uv.y*=CUBEUV_TEXEL_HEIGHT;\n#ifdef texture2DGradEXT\nreturn texture2DGradEXT(envMap,uv,vec2(0.0),vec2(0.0)).rgb;\n#else\nreturn texture2D(envMap,uv).rgb;\n#endif\n}\n#define cubeUV_r0 1.0\n#define cubeUV_m0-2.0\n#define cubeUV_r1 0.8\n#define cubeUV_m1-1.0\n#define cubeUV_r4 0.4\n#define cubeUV_m4 2.0\n#define cubeUV_r5 0.305\n#define cubeUV_m5 3.0\n#define cubeUV_r6 0.21\n#define cubeUV_m6 4.0\nfloat roughnessToMip(float roughness){float mip=0.0;if(roughness>=cubeUV_r1){mip=(cubeUV_r0-roughness)*(cubeUV_m1-cubeUV_m0)/(cubeUV_r0-cubeUV_r1)+cubeUV_m0;}else if(roughness>=cubeUV_r4){mip=(cubeUV_r1-roughness)*(cubeUV_m4-cubeUV_m1)/(cubeUV_r1-cubeUV_r4)+cubeUV_m1;}else if(roughness>=cubeUV_r5){mip=(cubeUV_r4-roughness)*(cubeUV_m5-cubeUV_m4)/(cubeUV_r4-cubeUV_r5)+cubeUV_m4;}else if(roughness>=cubeUV_r6){mip=(cubeUV_r5-roughness)*(cubeUV_m6-cubeUV_m5)/(cubeUV_r5-cubeUV_r6)+cubeUV_m5;}else{mip=-2.0*log2(1.16*roughness);}return mip;}vec4 textureCubeUV(sampler2D envMap,vec3 sampleDir,float roughness){float mip=clamp(roughnessToMip(roughness),cubeUV_m0,CUBEUV_MAX_MIP);float mipF=fract(mip);float mipInt=floor(mip);vec3 color0=bilinearCubeUV(envMap,sampleDir,mipInt);if(mipF==0.0){return vec4(color0,1.0);}else{vec3 color1=bilinearCubeUV(envMap,sampleDir,mipInt+1.0);return vec4(mix(color0,color1,mipF),1.0);}}\n#endif",defaultnormal_vertex:"vec3 transformedNormal=objectNormal;\n#ifdef USE_TANGENT\nvec3 transformedTangent=objectTangent;\n#endif\n#ifdef USE_BATCHING\nmat3 bm=mat3(batchingMatrix);transformedNormal/=vec3(dot(bm[0],bm[0]),dot(bm[1],bm[1]),dot(bm[2],bm[2]));transformedNormal=bm*transformedNormal;\n#ifdef USE_TANGENT\ntransformedTangent=bm*transformedTangent;\n#endif\n#endif\n#ifdef USE_INSTANCING\nmat3 im=mat3(instanceMatrix);transformedNormal/=vec3(dot(im[0],im[0]),dot(im[1],im[1]),dot(im[2],im[2]));transformedNormal=im*transformedNormal;\n#ifdef USE_TANGENT\ntransformedTangent=im*transformedTangent;\n#endif\n#endif\ntransformedNormal=normalMatrix*transformedNormal;\n#ifdef FLIP_SIDED\ntransformedNormal=-transformedNormal;\n#endif\n#ifdef USE_TANGENT\ntransformedTangent=(modelViewMatrix*vec4(transformedTangent,0.0)).xyz;\n#ifdef FLIP_SIDED\ntransformedTangent=-transformedTangent;\n#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\nuniform sampler2D displacementMap;uniform float displacementScale;uniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\ntransformed+=normalize(objectNormal)*(texture2D(displacementMap,vDisplacementMapUv).x*displacementScale+displacementBias);\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\nvec4 emissiveColor=texture2D(emissiveMap,vEmissiveMapUv);\n#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\nemissiveColor=sRGBTransferEOTF(emissiveColor);\n#endif\ntotalEmissiveRadiance*=emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\nuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor=linearToOutputTexel(gl_FragColor);",colorspace_pars_fragment:"vec4 LinearTransferOETF(in vec4 value){return value;}vec4 sRGBTransferEOTF(in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}vec4 sRGBTransferOETF(in vec4 value){return vec4(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))),value.a);}",envmap_fragment:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvec3 cameraToFrag;if(isOrthographic){cameraToFrag=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToFrag=normalize(vWorldPosition-cameraPosition);}vec3 worldNormal=inverseTransformDirection(normal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvec3 reflectVec=reflect(cameraToFrag,worldNormal);\n#else\nvec3 reflectVec=refract(cameraToFrag,worldNormal,refractionRatio);\n#endif\n#else\nvec3 reflectVec=vReflect;\n#endif\n#ifdef ENVMAP_TYPE_CUBE\nvec4 envColor=textureCube(envMap,envMapRotation*vec3(flipEnvMap*reflectVec.x,reflectVec.yz));\n#else\nvec4 envColor=vec4(0.0);\n#endif\n#ifdef ENVMAP_BLENDING_MULTIPLY\noutgoingLight=mix(outgoingLight,outgoingLight*envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_MIX)\noutgoingLight=mix(outgoingLight,envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_ADD)\noutgoingLight+=envColor.xyz*specularStrength*reflectivity;\n#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\nuniform float envMapIntensity;uniform float flipEnvMap;uniform mat3 envMapRotation;\n#ifdef ENVMAP_TYPE_CUBE\nuniform samplerCube envMap;\n#else\nuniform sampler2D envMap;\n#endif\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)||defined(LAMBERT)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;uniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)||defined(LAMBERT)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;\n#else\nvarying vec3 vReflect;uniform float refractionRatio;\n#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\nvec3 getIBLIrradiance(const in vec3 normal){\n#ifdef ENVMAP_TYPE_CUBE_UV\nvec3 worldNormal=inverseTransformDirection(normal,viewMatrix);vec4 envMapColor=textureCubeUV(envMap,envMapRotation*worldNormal,1.0);return PI*envMapColor.rgb*envMapIntensity;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 getIBLRadiance(const in vec3 viewDir,const in vec3 normal,const in float roughness){\n#ifdef ENVMAP_TYPE_CUBE_UV\nvec3 reflectVec=reflect(-viewDir,normal);reflectVec=normalize(mix(reflectVec,normal,roughness*roughness));reflectVec=inverseTransformDirection(reflectVec,viewMatrix);vec4 envMapColor=textureCubeUV(envMap,envMapRotation*reflectVec,roughness);return envMapColor.rgb*envMapIntensity;\n#else\nreturn vec3(0.0);\n#endif\n}\n#ifdef USE_ANISOTROPY\nvec3 getIBLAnisotropyRadiance(const in vec3 viewDir,const in vec3 normal,const in float roughness,const in vec3 bitangent,const in float anisotropy){\n#ifdef ENVMAP_TYPE_CUBE_UV\nvec3 bentNormal=cross(bitangent,viewDir);bentNormal=normalize(cross(bentNormal,bitangent));bentNormal=normalize(mix(bentNormal,normal,pow2(pow2(1.0-anisotropy*(1.0-roughness)))));return getIBLRadiance(viewDir,bentNormal,roughness);\n#else\nreturn vec3(0.0);\n#endif\n}\n#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvWorldPosition=worldPosition.xyz;\n#else\nvec3 cameraToVertex;if(isOrthographic){cameraToVertex=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToVertex=normalize(worldPosition.xyz-cameraPosition);}vec3 worldNormal=inverseTransformDirection(transformedNormal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvReflect=reflect(cameraToVertex,worldNormal);\n#else\nvReflect=refract(cameraToVertex,worldNormal,refractionRatio);\n#endif\n#endif\n#endif",fog_vertex:"#ifdef USE_FOG\nvFogDepth=-mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\nvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n#ifdef FOG_EXP2\nfloat fogFactor=1.0-exp(-fogDensity*fogDensity*vFogDepth*vFogDepth);\n#else\nfloat fogFactor=smoothstep(fogNear,fogFar,vFogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,fogFactor);\n#endif",fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;varying float vFogDepth;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;uniform float fogFar;\n#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\nuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance(vec3 normal,vec3 lightDirection){float dotNL=dot(normal,lightDirection);vec2 coord=vec2(dotNL*0.5+0.5,0.0);\n#ifdef USE_GRADIENTMAP\nreturn vec3(texture2D(gradientMap,coord).r);\n#else\nvec2 fw=fwidth(coord)*0.5;return mix(vec3(0.7),vec3(1.0),smoothstep(0.7-fw.x,0.7+fw.x,coord.x));\n#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nuniform sampler2D lightMap;uniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;material.diffuseColor=diffuseColor.rgb;material.specularStrength=specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;struct LambertMaterial{vec3 diffuseColor;float specularStrength;};void RE_Direct_Lambert(const in IncidentLight directLight,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in LambertMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometryNormal,directLight.direction));vec3 irradiance=dotNL*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Lambert(const in vec3 irradiance,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in LambertMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_Lambert\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;uniform vec3 ambientLightColor;\n#if defined(USE_LIGHT_PROBES)\nuniform vec3 lightProbe[9];\n#endif\nvec3 shGetIrradianceAt(in vec3 normal,in vec3 shCoefficients[9]){float x=normal.x,y=normal.y,z=normal.z;vec3 result=shCoefficients[0]*0.886227;result+=shCoefficients[1]*2.0*0.511664*y;result+=shCoefficients[2]*2.0*0.511664*z;result+=shCoefficients[3]*2.0*0.511664*x;result+=shCoefficients[4]*2.0*0.429043*x*y;result+=shCoefficients[5]*2.0*0.429043*y*z;result+=shCoefficients[6]*(0.743125*z*z-0.247708);result+=shCoefficients[7]*2.0*0.429043*x*z;result+=shCoefficients[8]*0.429043*(x*x-y*y);return result;}vec3 getLightProbeIrradiance(const in vec3 lightProbe[9],const in vec3 normal){vec3 worldNormal=inverseTransformDirection(normal,viewMatrix);vec3 irradiance=shGetIrradianceAt(worldNormal,lightProbe);return irradiance;}vec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;return irradiance;}float getDistanceAttenuation(const in float lightDistance,const in float cutoffDistance,const in float decayExponent){float distanceFalloff=1.0/max(pow(lightDistance,decayExponent),0.01);if(cutoffDistance>0.0){distanceFalloff*=pow2(saturate(1.0-pow4(lightDistance/cutoffDistance)));}return distanceFalloff;}float getSpotAttenuation(const in float coneCosine,const in float penumbraCosine,const in float angleCosine){return smoothstep(coneCosine,penumbraCosine,angleCosine);}\n#if NUM_DIR_LIGHTS>0\nstruct DirectionalLight{vec3 direction;vec3 color;};uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];void getDirectionalLightInfo(const in DirectionalLight directionalLight,out IncidentLight light){light.color=directionalLight.color;light.direction=directionalLight.direction;light.visible=true;}\n#endif\n#if NUM_POINT_LIGHTS>0\nstruct PointLight{vec3 position;vec3 color;float distance;float decay;};uniform PointLight pointLights[NUM_POINT_LIGHTS];void getPointLightInfo(const in PointLight pointLight,const in vec3 geometryPosition,out IncidentLight light){vec3 lVector=pointLight.position-geometryPosition;light.direction=normalize(lVector);float lightDistance=length(lVector);light.color=pointLight.color;light.color*=getDistanceAttenuation(lightDistance,pointLight.distance,pointLight.decay);light.visible=(light.color!=vec3(0.0));}\n#endif\n#if NUM_SPOT_LIGHTS>0\nstruct SpotLight{vec3 position;vec3 direction;vec3 color;float distance;float decay;float coneCos;float penumbraCos;};uniform SpotLight spotLights[NUM_SPOT_LIGHTS];void getSpotLightInfo(const in SpotLight spotLight,const in vec3 geometryPosition,out IncidentLight light){vec3 lVector=spotLight.position-geometryPosition;light.direction=normalize(lVector);float angleCos=dot(light.direction,spotLight.direction);float spotAttenuation=getSpotAttenuation(spotLight.coneCos,spotLight.penumbraCos,angleCos);if(spotAttenuation>0.0){float lightDistance=length(lVector);light.color=spotLight.color*spotAttenuation;light.color*=getDistanceAttenuation(lightDistance,spotLight.distance,spotLight.decay);light.visible=(light.color!=vec3(0.0));}else{light.color=vec3(0.0);light.visible=false;}}\n#endif\n#if NUM_RECT_AREA_LIGHTS>0\nstruct RectAreaLight{vec3 color;vec3 position;vec3 halfWidth;vec3 halfHeight;};uniform sampler2D ltc_1;uniform sampler2D ltc_2;uniform RectAreaLight rectAreaLights[NUM_RECT_AREA_LIGHTS];\n#endif\n#if NUM_HEMI_LIGHTS>0\nstruct HemisphereLight{vec3 direction;vec3 skyColor;vec3 groundColor;};uniform HemisphereLight hemisphereLights[NUM_HEMI_LIGHTS];vec3 getHemisphereLightIrradiance(const in HemisphereLight hemiLight,const in vec3 normal){float dotNL=dot(normal,hemiLight.direction);float hemiDiffuseWeight=0.5*dotNL+0.5;vec3 irradiance=mix(hemiLight.groundColor,hemiLight.skyColor,hemiDiffuseWeight);return irradiance;}\n#endif",lights_toon_fragment:"ToonMaterial material;material.diffuseColor=diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;struct ToonMaterial{vec3 diffuseColor;};void RE_Direct_Toon(const in IncidentLight directLight,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in ToonMaterial material,inout ReflectedLight reflectedLight){vec3 irradiance=getGradientIrradiance(geometryNormal,directLight.direction)*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Toon(const in vec3 irradiance,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in ToonMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_Toon\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;material.diffuseColor=diffuseColor.rgb;material.specularColor=specular;material.specularShininess=shininess;material.specularStrength=specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;struct BlinnPhongMaterial{vec3 diffuseColor;vec3 specularColor;float specularShininess;float specularStrength;};void RE_Direct_BlinnPhong(const in IncidentLight directLight,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometryNormal,directLight.direction));vec3 irradiance=dotNL*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);reflectedLight.directSpecular+=irradiance*BRDF_BlinnPhong(directLight.direction,geometryViewDir,geometryNormal,material.specularColor,material.specularShininess)*material.specularStrength;}void RE_IndirectDiffuse_BlinnPhong(const in vec3 irradiance,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_BlinnPhong\n#define RE_IndirectDiffuse RE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;material.diffuseColor=diffuseColor.rgb*(1.0-metalnessFactor);vec3 dxy=max(abs(dFdx(nonPerturbedNormal)),abs(dFdy(nonPerturbedNormal)));float geometryRoughness=max(max(dxy.x,dxy.y),dxy.z);material.roughness=max(roughnessFactor,0.0525);material.roughness+=geometryRoughness;material.roughness=min(material.roughness,1.0);\n#ifdef IOR\nmaterial.ior=ior;\n#ifdef USE_SPECULAR\nfloat specularIntensityFactor=specularIntensity;vec3 specularColorFactor=specularColor;\n#ifdef USE_SPECULAR_COLORMAP\nspecularColorFactor*=texture2D(specularColorMap,vSpecularColorMapUv).rgb;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\nspecularIntensityFactor*=texture2D(specularIntensityMap,vSpecularIntensityMapUv).a;\n#endif\nmaterial.specularF90=mix(specularIntensityFactor,1.0,metalnessFactor);\n#else\nfloat specularIntensityFactor=1.0;vec3 specularColorFactor=vec3(1.0);material.specularF90=1.0;\n#endif\nmaterial.specularColor=mix(min(pow2((material.ior-1.0)/(material.ior+1.0))*specularColorFactor,vec3(1.0))*specularIntensityFactor,diffuseColor.rgb,metalnessFactor);\n#else\nmaterial.specularColor=mix(vec3(0.04),diffuseColor.rgb,metalnessFactor);material.specularF90=1.0;\n#endif\n#ifdef USE_CLEARCOAT\nmaterial.clearcoat=clearcoat;material.clearcoatRoughness=clearcoatRoughness;material.clearcoatF0=vec3(0.04);material.clearcoatF90=1.0;\n#ifdef USE_CLEARCOATMAP\nmaterial.clearcoat*=texture2D(clearcoatMap,vClearcoatMapUv).x;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nmaterial.clearcoatRoughness*=texture2D(clearcoatRoughnessMap,vClearcoatRoughnessMapUv).y;\n#endif\nmaterial.clearcoat=saturate(material.clearcoat);material.clearcoatRoughness=max(material.clearcoatRoughness,0.0525);material.clearcoatRoughness+=geometryRoughness;material.clearcoatRoughness=min(material.clearcoatRoughness,1.0);\n#endif\n#ifdef USE_DISPERSION\nmaterial.dispersion=dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\nmaterial.iridescence=iridescence;material.iridescenceIOR=iridescenceIOR;\n#ifdef USE_IRIDESCENCEMAP\nmaterial.iridescence*=texture2D(iridescenceMap,vIridescenceMapUv).r;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\nmaterial.iridescenceThickness=(iridescenceThicknessMaximum-iridescenceThicknessMinimum)*texture2D(iridescenceThicknessMap,vIridescenceThicknessMapUv).g+iridescenceThicknessMinimum;\n#else\nmaterial.iridescenceThickness=iridescenceThicknessMaximum;\n#endif\n#endif\n#ifdef USE_SHEEN\nmaterial.sheenColor=sheenColor;\n#ifdef USE_SHEEN_COLORMAP\nmaterial.sheenColor*=texture2D(sheenColorMap,vSheenColorMapUv).rgb;\n#endif\nmaterial.sheenRoughness=clamp(sheenRoughness,0.07,1.0);\n#ifdef USE_SHEEN_ROUGHNESSMAP\nmaterial.sheenRoughness*=texture2D(sheenRoughnessMap,vSheenRoughnessMapUv).a;\n#endif\n#endif\n#ifdef USE_ANISOTROPY\n#ifdef USE_ANISOTROPYMAP\nmat2 anisotropyMat=mat2(anisotropyVector.x,anisotropyVector.y,-anisotropyVector.y,anisotropyVector.x);vec3 anisotropyPolar=texture2D(anisotropyMap,vAnisotropyMapUv).rgb;vec2 anisotropyV=anisotropyMat*normalize(2.0*anisotropyPolar.rg-vec2(1.0))*anisotropyPolar.b;\n#else\nvec2 anisotropyV=anisotropyVector;\n#endif\nmaterial.anisotropy=length(anisotropyV);if(material.anisotropy==0.0){anisotropyV=vec2(1.0,0.0);}else{anisotropyV/=material.anisotropy;material.anisotropy=saturate(material.anisotropy);}material.alphaT=mix(pow2(material.roughness),1.0,pow2(material.anisotropy));material.anisotropyT=tbn[0]*anisotropyV.x+tbn[1]*anisotropyV.y;material.anisotropyB=tbn[1]*anisotropyV.x-tbn[0]*anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial{vec3 diffuseColor;float roughness;vec3 specularColor;float specularF90;float dispersion;\n#ifdef USE_CLEARCOAT\nfloat clearcoat;float clearcoatRoughness;vec3 clearcoatF0;float clearcoatF90;\n#endif\n#ifdef USE_IRIDESCENCE\nfloat iridescence;float iridescenceIOR;float iridescenceThickness;vec3 iridescenceFresnel;vec3 iridescenceF0;\n#endif\n#ifdef USE_SHEEN\nvec3 sheenColor;float sheenRoughness;\n#endif\n#ifdef IOR\nfloat ior;\n#endif\n#ifdef USE_TRANSMISSION\nfloat transmission;float transmissionAlpha;float thickness;float attenuationDistance;vec3 attenuationColor;\n#endif\n#ifdef USE_ANISOTROPY\nfloat anisotropy;float alphaT;vec3 anisotropyT;vec3 anisotropyB;\n#endif\n};vec3 clearcoatSpecularDirect=vec3(0.0);vec3 clearcoatSpecularIndirect=vec3(0.0);vec3 sheenSpecularDirect=vec3(0.0);vec3 sheenSpecularIndirect=vec3(0.0);vec3 Schlick_to_F0(const in vec3 f,const in float f90,const in float dotVH){float x=clamp(1.0-dotVH,0.0,1.0);float x2=x*x;float x5=clamp(x*x2*x2,0.0,0.9999);return(f-vec3(f90)*x5)/(1.0-x5);}float V_GGX_SmithCorrelated(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(const in float alpha,const in float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}\n#ifdef USE_ANISOTROPY\nfloat V_GGX_SmithCorrelated_Anisotropic(const in float alphaT,const in float alphaB,const in float dotTV,const in float dotBV,const in float dotTL,const in float dotBL,const in float dotNV,const in float dotNL){float gv=dotNL*length(vec3(alphaT*dotTV,alphaB*dotBV,dotNV));float gl=dotNV*length(vec3(alphaT*dotTL,alphaB*dotBL,dotNL));float v=0.5/(gv+gl);return saturate(v);}float D_GGX_Anisotropic(const in float alphaT,const in float alphaB,const in float dotNH,const in float dotTH,const in float dotBH){float a2=alphaT*alphaB;highp vec3 v=vec3(alphaB*dotTH,alphaT*dotBH,a2*dotNH);highp float v2=dot(v,v);float w2=a2/v2;return RECIPROCAL_PI*a2*pow2(w2);}\n#endif\n#ifdef USE_CLEARCOAT\nvec3 BRDF_GGX_Clearcoat(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in PhysicalMaterial material){vec3 f0=material.clearcoatF0;float f90=material.clearcoatF90;float roughness=material.clearcoatRoughness;float alpha=pow2(roughness);vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));vec3 F=F_Schlick(f0,f90,dotVH);float V=V_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(V*D);}\n#endif\nvec3 BRDF_GGX(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in PhysicalMaterial material){vec3 f0=material.specularColor;float f90=material.specularF90;float roughness=material.roughness;float alpha=pow2(roughness);vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));vec3 F=F_Schlick(f0,f90,dotVH);\n#ifdef USE_IRIDESCENCE\nF=mix(F,material.iridescenceFresnel,material.iridescence);\n#endif\n#ifdef USE_ANISOTROPY\nfloat dotTL=dot(material.anisotropyT,lightDir);float dotTV=dot(material.anisotropyT,viewDir);float dotTH=dot(material.anisotropyT,halfDir);float dotBL=dot(material.anisotropyB,lightDir);float dotBV=dot(material.anisotropyB,viewDir);float dotBH=dot(material.anisotropyB,halfDir);float V=V_GGX_SmithCorrelated_Anisotropic(material.alphaT,alpha,dotTV,dotBV,dotTL,dotBL,dotNV,dotNL);float D=D_GGX_Anisotropic(material.alphaT,alpha,dotNH,dotTH,dotBH);\n#else\nfloat V=V_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);\n#endif\nreturn F*(V*D);}vec2 LTC_Uv(const in vec3 N,const in vec3 V,const in float roughness){const float LUT_SIZE=64.0;const float LUT_SCALE=(LUT_SIZE-1.0)/LUT_SIZE;const float LUT_BIAS=0.5/LUT_SIZE;float dotNV=saturate(dot(N,V));vec2 uv=vec2(roughness,sqrt(1.0-dotNV));uv=uv*LUT_SCALE+LUT_BIAS;return uv;}float LTC_ClippedSphereFormFactor(const in vec3 f){float l=length(f);return max((l*l+f.z)/(l+1.0),0.0);}vec3 LTC_EdgeVectorFormFactor(const in vec3 v1,const in vec3 v2){float x=dot(v1,v2);float y=abs(x);float a=0.8543985+(0.4965155+0.0145206*y)*y;float b=3.4175940+(4.1616724+y)*y;float v=a/b;float theta_sintheta=(x>0.0)?v:0.5*inversesqrt(max(1.0-x*x,1e-7))-v;return cross(v1,v2)*theta_sintheta;}vec3 LTC_Evaluate(const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[4]){vec3 v1=rectCoords[1]-rectCoords[0];vec3 v2=rectCoords[3]-rectCoords[0];vec3 lightNormal=cross(v1,v2);if(dot(lightNormal,P-rectCoords[0])<0.0)return vec3(0.0);vec3 T1,T2;T1=normalize(V-N*dot(V,N));T2=-cross(N,T1);mat3 mat=mInv*transposeMat3(mat3(T1,T2,N));vec3 coords[4];coords[0]=mat*(rectCoords[0]-P);coords[1]=mat*(rectCoords[1]-P);coords[2]=mat*(rectCoords[2]-P);coords[3]=mat*(rectCoords[3]-P);coords[0]=normalize(coords[0]);coords[1]=normalize(coords[1]);coords[2]=normalize(coords[2]);coords[3]=normalize(coords[3]);vec3 vectorFormFactor=vec3(0.0);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[0],coords[1]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[1],coords[2]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[2],coords[3]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[3],coords[0]);float result=LTC_ClippedSphereFormFactor(vectorFormFactor);return vec3(result);}\n#if defined(USE_SHEEN)\nfloat D_Charlie(float roughness,float dotNH){float alpha=pow2(roughness);float invAlpha=1.0/alpha;float cos2h=dotNH*dotNH;float sin2h=max(1.0-cos2h,0.0078125);return(2.0+invAlpha)*pow(sin2h,invAlpha*0.5)/(2.0*PI);}float V_Neubelt(float dotNV,float dotNL){return saturate(1.0/(4.0*(dotNL+dotNV-dotNL*dotNV)));}vec3 BRDF_Sheen(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,vec3 sheenColor,const in float sheenRoughness){vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float D=D_Charlie(sheenRoughness,dotNH);float V=V_Neubelt(dotNV,dotNL);return sheenColor*(D*V);}\n#endif\nfloat IBLSheenBRDF(const in vec3 normal,const in vec3 viewDir,const in float roughness){float dotNV=saturate(dot(normal,viewDir));float r2=roughness*roughness;float a=roughness<0.25?-339.2*r2+161.4*roughness-25.9:-8.48*r2+14.3*roughness-9.95;float b=roughness<0.25?44.0*r2-23.7*roughness+3.26:1.97*r2-3.27*roughness+0.72;float DG=exp(a*dotNV+b)+(roughness<0.25?0.0:0.1*(roughness-0.25));return saturate(DG*RECIPROCAL_PI);}vec2 DFGApprox(const in vec3 normal,const in vec3 viewDir,const in float roughness){float dotNV=saturate(dot(normal,viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 fab=vec2(-1.04,1.04)*a004+r.zw;return fab;}vec3 EnvironmentBRDF(const in vec3 normal,const in vec3 viewDir,const in vec3 specularColor,const in float specularF90,const in float roughness){vec2 fab=DFGApprox(normal,viewDir,roughness);return specularColor*fab.x+specularF90*fab.y;}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence(const in vec3 normal,const in vec3 viewDir,const in vec3 specularColor,const in float specularF90,const in float iridescence,const in vec3 iridescenceF0,const in float roughness,inout vec3 singleScatter,inout vec3 multiScatter){\n#else\nvoid computeMultiscattering(const in vec3 normal,const in vec3 viewDir,const in vec3 specularColor,const in float specularF90,const in float roughness,inout vec3 singleScatter,inout vec3 multiScatter){\n#endif\nvec2 fab=DFGApprox(normal,viewDir,roughness);\n#ifdef USE_IRIDESCENCE\nvec3 Fr=mix(specularColor,iridescenceF0,iridescence);\n#else\nvec3 Fr=specularColor;\n#endif\nvec3 FssEss=Fr*fab.x+specularF90*fab.y;float Ess=fab.x+fab.y;float Ems=1.0-Ess;vec3 Favg=Fr+(1.0-Fr)*0.047619;vec3 Fms=FssEss*Favg/(1.0-Ems*Favg);singleScatter+=FssEss;multiScatter+=Fms*Ems;}\n#if NUM_RECT_AREA_LIGHTS>0\nvoid RE_Direct_RectArea_Physical(const in RectAreaLight rectAreaLight,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 normal=geometryNormal;vec3 viewDir=geometryViewDir;vec3 position=geometryPosition;vec3 lightPos=rectAreaLight.position;vec3 halfWidth=rectAreaLight.halfWidth;vec3 halfHeight=rectAreaLight.halfHeight;vec3 lightColor=rectAreaLight.color;float roughness=material.roughness;vec3 rectCoords[4];rectCoords[0]=lightPos+halfWidth-halfHeight;rectCoords[1]=lightPos-halfWidth-halfHeight;rectCoords[2]=lightPos-halfWidth+halfHeight;rectCoords[3]=lightPos+halfWidth+halfHeight;vec2 uv=LTC_Uv(normal,viewDir,roughness);vec4 t1=texture2D(ltc_1,uv);vec4 t2=texture2D(ltc_2,uv);mat3 mInv=mat3(vec3(t1.x,0,t1.y),vec3(0,1,0),vec3(t1.z,0,t1.w));vec3 fresnel=(material.specularColor*t2.x+(vec3(1.0)-material.specularColor)*t2.y);reflectedLight.directSpecular+=lightColor*fresnel*LTC_Evaluate(normal,viewDir,position,mInv,rectCoords);reflectedLight.directDiffuse+=lightColor*material.diffuseColor*LTC_Evaluate(normal,viewDir,position,mat3(1.0),rectCoords);}\n#endif\nvoid RE_Direct_Physical(const in IncidentLight directLight,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometryNormal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifdef USE_CLEARCOAT\nfloat dotNLcc=saturate(dot(geometryClearcoatNormal,directLight.direction));vec3 ccIrradiance=dotNLcc*directLight.color;clearcoatSpecularDirect+=ccIrradiance*BRDF_GGX_Clearcoat(directLight.direction,geometryViewDir,geometryClearcoatNormal,material);\n#endif\n#ifdef USE_SHEEN\nsheenSpecularDirect+=irradiance*BRDF_Sheen(directLight.direction,geometryViewDir,geometryNormal,material.sheenColor,material.sheenRoughness);\n#endif\nreflectedLight.directSpecular+=irradiance*BRDF_GGX(directLight.direction,geometryViewDir,geometryNormal,material);reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Physical(const in vec3 irradiance,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectSpecular_Physical(const in vec3 radiance,const in vec3 irradiance,const in vec3 clearcoatRadiance,const in vec3 geometryPosition,const in vec3 geometryNormal,const in vec3 geometryViewDir,const in vec3 geometryClearcoatNormal,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){\n#ifdef USE_CLEARCOAT\nclearcoatSpecularIndirect+=clearcoatRadiance*EnvironmentBRDF(geometryClearcoatNormal,geometryViewDir,material.clearcoatF0,material.clearcoatF90,material.clearcoatRoughness);\n#endif\n#ifdef USE_SHEEN\nsheenSpecularIndirect+=irradiance*material.sheenColor*IBLSheenBRDF(geometryNormal,geometryViewDir,material.sheenRoughness);\n#endif\nvec3 singleScattering=vec3(0.0);vec3 multiScattering=vec3(0.0);vec3 cosineWeightedIrradiance=irradiance*RECIPROCAL_PI;\n#ifdef USE_IRIDESCENCE\ncomputeMultiscatteringIridescence(geometryNormal,geometryViewDir,material.specularColor,material.specularF90,material.iridescence,material.iridescenceFresnel,material.roughness,singleScattering,multiScattering);\n#else\ncomputeMultiscattering(geometryNormal,geometryViewDir,material.specularColor,material.specularF90,material.roughness,singleScattering,multiScattering);\n#endif\nvec3 totalScattering=singleScattering+multiScattering;vec3 diffuse=material.diffuseColor*(1.0-max(max(totalScattering.r,totalScattering.g),totalScattering.b));reflectedLight.indirectSpecular+=radiance*singleScattering;reflectedLight.indirectSpecular+=multiScattering*cosineWeightedIrradiance;reflectedLight.indirectDiffuse+=diffuse*cosineWeightedIrradiance;}\n#define RE_Direct RE_Direct_Physical\n#define RE_Direct_RectArea RE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular RE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion(const in float dotNV,const in float ambientOcclusion,const in float roughness){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}",lights_fragment_begin:"vec3 geometryPosition=-vViewPosition;vec3 geometryNormal=normal;vec3 geometryViewDir=(isOrthographic)?vec3(0,0,1):normalize(vViewPosition);vec3 geometryClearcoatNormal=vec3(0.0);\n#ifdef USE_CLEARCOAT\ngeometryClearcoatNormal=clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\nfloat dotNVi=saturate(dot(normal,geometryViewDir));if(material.iridescenceThickness==0.0){material.iridescence=0.0;}else{material.iridescence=saturate(material.iridescence);}if(material.iridescence>0.0){material.iridescenceFresnel=evalIridescence(1.0,material.iridescenceIOR,dotNVi,material.iridescenceThickness,material.specularColor);material.iridescenceF0=Schlick_to_F0(material.iridescenceFresnel,1.0,dotNVi);}\n#endif\nIncidentLight directLight;\n#if (NUM_POINT_LIGHTS>0)&&defined(RE_Direct)\nPointLight pointLight;\n#if defined(USE_SHADOWMAP)&&NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){pointLight=pointLights[i];getPointLightInfo(pointLight,geometryPosition,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_POINT_LIGHT_SHADOWS)\npointLightShadow=pointLightShadows[i];directLight.color*=(directLight.visible&&receiveShadow)?getPointShadow(pointShadowMap[i],pointLightShadow.shadowMapSize,pointLightShadow.shadowIntensity,pointLightShadow.shadowBias,pointLightShadow.shadowRadius,vPointShadowCoord[i],pointLightShadow.shadowCameraNear,pointLightShadow.shadowCameraFar):1.0;\n#endif\nRE_Direct(directLight,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_SPOT_LIGHTS>0)&&defined(RE_Direct)\nSpotLight spotLight;vec4 spotColor;vec3 spotLightCoord;bool inSpotLightMap;\n#if defined(USE_SHADOWMAP)&&NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){spotLight=spotLights[i];getSpotLightInfo(spotLight,geometryPosition,directLight);\n#if (UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS)\n#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n#elif (UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\n#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n#else\n#define SPOT_LIGHT_MAP_INDEX(UNROLLED_LOOP_INDEX-NUM_SPOT_LIGHT_SHADOWS+NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS)\n#endif\n#if (SPOT_LIGHT_MAP_INDEX<NUM_SPOT_LIGHT_MAPS)\nspotLightCoord=vSpotLightCoord[i].xyz/vSpotLightCoord[i].w;inSpotLightMap=all(lessThan(abs(spotLightCoord*2.-1.),vec3(1.0)));spotColor=texture2D(spotLightMap[SPOT_LIGHT_MAP_INDEX],spotLightCoord.xy);directLight.color=inSpotLightMap?directLight.color*spotColor.rgb:directLight.color;\n#endif\n#undef SPOT_LIGHT_MAP_INDEX\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nspotLightShadow=spotLightShadows[i];directLight.color*=(directLight.visible&&receiveShadow)?getShadow(spotShadowMap[i],spotLightShadow.shadowMapSize,spotLightShadow.shadowIntensity,spotLightShadow.shadowBias,spotLightShadow.shadowRadius,vSpotLightCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_DIR_LIGHTS>0)&&defined(RE_Direct)\nDirectionalLight directionalLight;\n#if defined(USE_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){directionalLight=directionalLights[i];getDirectionalLightInfo(directionalLight,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_DIR_LIGHT_SHADOWS)\ndirectionalLightShadow=directionalLightShadows[i];directLight.color*=(directLight.visible&&receiveShadow)?getShadow(directionalShadowMap[i],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowIntensity,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_RECT_AREA_LIGHTS>0)&&defined(RE_Direct_RectArea)\nRectAreaLight rectAreaLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_RECT_AREA_LIGHTS;i++){rectAreaLight=rectAreaLights[i];RE_Direct_RectArea(rectAreaLight,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if defined(RE_IndirectDiffuse)\nvec3 iblIrradiance=vec3(0.0);vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);\n#if defined(USE_LIGHT_PROBES)\nirradiance+=getLightProbeIrradiance(lightProbe,geometryNormal);\n#endif\n#if (NUM_HEMI_LIGHTS>0)\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){irradiance+=getHemisphereLightIrradiance(hemisphereLights[i],geometryNormal);}\n#pragma unroll_loop_end\n#endif\n#endif\n#if defined(RE_IndirectSpecular)\nvec3 radiance=vec3(0.0);vec3 clearcoatRadiance=vec3(0.0);\n#endif",lights_fragment_maps:"#if defined(RE_IndirectDiffuse)\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vLightMapUv);vec3 lightMapIrradiance=lightMapTexel.rgb*lightMapIntensity;irradiance+=lightMapIrradiance;\n#endif\n#if defined(USE_ENVMAP)&&defined(STANDARD)&&defined(ENVMAP_TYPE_CUBE_UV)\niblIrradiance+=getIBLIrradiance(geometryNormal);\n#endif\n#endif\n#if defined(USE_ENVMAP)&&defined(RE_IndirectSpecular)\n#ifdef USE_ANISOTROPY\nradiance+=getIBLAnisotropyRadiance(geometryViewDir,geometryNormal,material.roughness,material.anisotropyB,material.anisotropy);\n#else\nradiance+=getIBLRadiance(geometryViewDir,geometryNormal,material.roughness);\n#endif\n#ifdef USE_CLEARCOAT\nclearcoatRadiance+=getIBLRadiance(geometryViewDir,geometryClearcoatNormal,material.clearcoatRoughness);\n#endif\n#endif",lights_fragment_end:"#if defined(RE_IndirectDiffuse)\nRE_IndirectDiffuse(irradiance,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);\n#endif\n#if defined(RE_IndirectSpecular)\nRE_IndirectSpecular(radiance,iblIrradiance,clearcoatRadiance,geometryPosition,geometryNormal,geometryViewDir,geometryClearcoatNormal,material,reflectedLight);\n#endif",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF)\ngl_FragDepth=vIsPerspective==0.0?gl_FragCoord.z:log2(vFragDepth)*logDepthBufFC*0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined(USE_LOGDEPTHBUF)\nuniform float logDepthBufFC;varying float vFragDepth;varying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\nvarying float vFragDepth;varying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\nvFragDepth=1.0+gl_Position.w;vIsPerspective=float(isPerspectiveMatrix(projectionMatrix));\n#endif",map_fragment:"#ifdef USE_MAP\nvec4 sampledDiffuseColor=texture2D(map,vMapUv);\n#ifdef DECODE_VIDEO_TEXTURE\nsampledDiffuseColor=sRGBTransferEOTF(sampledDiffuseColor);\n#endif\ndiffuseColor*=sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined(USE_MAP)||defined(USE_ALPHAMAP)\n#if defined(USE_POINTS_UV)\nvec2 uv=vUv;\n#else\nvec2 uv=(uvTransform*vec3(gl_PointCoord.x,1.0-gl_PointCoord.y,1)).xy;\n#endif\n#endif\n#ifdef USE_MAP\ndiffuseColor*=texture2D(map,uv);\n#endif\n#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,uv).g;\n#endif",map_particle_pars_fragment:"#if defined(USE_POINTS_UV)\nvarying vec2 vUv;\n#else\n#if defined(USE_MAP)||defined(USE_ALPHAMAP)\nuniform mat3 uvTransform;\n#endif\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor=metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness=texture2D(metalnessMap,vMetalnessMapUv);metalnessFactor*=texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\nuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\nfloat morphTargetInfluences[MORPHTARGETS_COUNT];float morphTargetBaseInfluence=texelFetch(morphTexture,ivec2(0,gl_InstanceID),0).r;for(int i=0;i<MORPHTARGETS_COUNT;i++){morphTargetInfluences[i]=texelFetch(morphTexture,ivec2(i+1,gl_InstanceID),0).r;}\n#endif",morphcolor_vertex:"#if defined(USE_MORPHCOLORS)\nvColor*=morphTargetBaseInfluence;for(int i=0;i<MORPHTARGETS_COUNT;i++){\n#if defined(USE_COLOR_ALPHA)\nif(morphTargetInfluences[i]!=0.0)vColor+=getMorph(gl_VertexID,i,2)*morphTargetInfluences[i];\n#elif defined(USE_COLOR)\nif(morphTargetInfluences[i]!=0.0)vColor+=getMorph(gl_VertexID,i,2).rgb*morphTargetInfluences[i];\n#endif\n}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nobjectNormal*=morphTargetBaseInfluence;for(int i=0;i<MORPHTARGETS_COUNT;i++){if(morphTargetInfluences[i]!=0.0)objectNormal+=getMorph(gl_VertexID,i,1).xyz*morphTargetInfluences[i];}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n#ifndef USE_INSTANCING_MORPH\nuniform float morphTargetBaseInfluence;uniform float morphTargetInfluences[MORPHTARGETS_COUNT];\n#endif\nuniform sampler2DArray morphTargetsTexture;uniform ivec2 morphTargetsTextureSize;vec4 getMorph(const in int vertexIndex,const in int morphTargetIndex,const in int offset){int texelIndex=vertexIndex*MORPHTARGETS_TEXTURE_STRIDE+offset;int y=texelIndex/morphTargetsTextureSize.x;int x=texelIndex-y*morphTargetsTextureSize.x;ivec3 morphUV=ivec3(x,y,morphTargetIndex);return texelFetch(morphTargetsTexture,morphUV,0);}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\ntransformed*=morphTargetBaseInfluence;for(int i=0;i<MORPHTARGETS_COUNT;i++){if(morphTargetInfluences[i]!=0.0)transformed+=getMorph(gl_VertexID,i,0).xyz*morphTargetInfluences[i];}\n#endif",normal_fragment_begin:"float faceDirection=gl_FrontFacing?1.0:-1.0;\n#ifdef FLAT_SHADED\nvec3 fdx=dFdx(vViewPosition);vec3 fdy=dFdy(vViewPosition);vec3 normal=normalize(cross(fdx,fdy));\n#else\nvec3 normal=normalize(vNormal);\n#ifdef DOUBLE_SIDED\nnormal*=faceDirection;\n#endif\n#endif\n#if defined(USE_NORMALMAP_TANGENTSPACE)||defined(USE_CLEARCOAT_NORMALMAP)||defined(USE_ANISOTROPY)\n#ifdef USE_TANGENT\nmat3 tbn=mat3(normalize(vTangent),normalize(vBitangent),normal);\n#else\nmat3 tbn=getTangentFrame(-vViewPosition,normal,\n#if defined(USE_NORMALMAP)\nvNormalMapUv\n#elif defined(USE_CLEARCOAT_NORMALMAP)\nvClearcoatNormalMapUv\n#else\nvUv\n#endif\n);\n#endif\n#if defined(DOUBLE_SIDED)&&!defined(FLAT_SHADED)\ntbn[0]*=faceDirection;tbn[1]*=faceDirection;\n#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n#ifdef USE_TANGENT\nmat3 tbn2=mat3(normalize(vTangent),normalize(vBitangent),normal);\n#else\nmat3 tbn2=getTangentFrame(-vViewPosition,normal,vClearcoatNormalMapUv);\n#endif\n#if defined(DOUBLE_SIDED)&&!defined(FLAT_SHADED)\ntbn2[0]*=faceDirection;tbn2[1]*=faceDirection;\n#endif\n#endif\nvec3 nonPerturbedNormal=normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\nnormal=texture2D(normalMap,vNormalMapUv).xyz*2.0-1.0;\n#ifdef FLIP_SIDED\nnormal=-normal;\n#endif\n#ifdef DOUBLE_SIDED\nnormal=normal*faceDirection;\n#endif\nnormal=normalize(normalMatrix*normal);\n#elif defined(USE_NORMALMAP_TANGENTSPACE)\nvec3 mapN=texture2D(normalMap,vNormalMapUv).xyz*2.0-1.0;mapN.xy*=normalScale;normal=normalize(tbn*mapN);\n#elif defined(USE_BUMPMAP)\nnormal=perturbNormalArb(-vViewPosition,normal,dHdxy_fwd(),faceDirection);\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#ifdef USE_TANGENT\nvTangent=normalize(transformedTangent);vBitangent=normalize(cross(vNormal,vTangent)*tangent.w);\n#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;uniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\nuniform mat3 normalMatrix;\n#endif\n#if !defined(USE_TANGENT)&&(defined(USE_NORMALMAP_TANGENTSPACE)||defined(USE_CLEARCOAT_NORMALMAP)||defined(USE_ANISOTROPY))\nmat3 getTangentFrame(vec3 eye_pos,vec3 surf_norm,vec2 uv){vec3 q0=dFdx(eye_pos.xyz);vec3 q1=dFdy(eye_pos.xyz);vec2 st0=dFdx(uv.st);vec2 st1=dFdy(uv.st);vec3 N=surf_norm;vec3 q1perp=cross(q1,N);vec3 q0perp=cross(N,q0);vec3 T=q1perp*st0.x+q0perp*st1.x;vec3 B=q1perp*st0.y+q0perp*st1.y;float det=max(dot(T,T),dot(B,B));float scale=(det==0.0)?0.0:inversesqrt(det);return mat3(T*scale,B*scale,N);}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\nvec3 clearcoatNormal=nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\nvec3 clearcoatMapN=texture2D(clearcoatNormalMap,vClearcoatNormalMapUv).xyz*2.0-1.0;clearcoatMapN.xy*=clearcoatNormalScale;clearcoatNormal=normalize(tbn2*clearcoatMapN);\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\nuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nuniform sampler2D clearcoatNormalMap;uniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\nuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\nuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a=1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a*=material.transmissionAlpha;\n#endif\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);",packing:"vec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const float ShiftRight8=1./256.;const float Inv255=1./255.;const vec4 PackFactors=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec2 UnpackFactors2=vec2(UnpackDownscale,1.0/PackFactors.g);const vec3 UnpackFactors3=vec3(UnpackDownscale/PackFactors.rg,1.0/PackFactors.b);const vec4 UnpackFactors4=vec4(UnpackDownscale/PackFactors.rgb,1.0/PackFactors.a);vec4 packDepthToRGBA(const in float v){if(v<=0.0)return vec4(0.,0.,0.,0.);if(v>=1.0)return vec4(1.,1.,1.,1.);float vuf;float af=modf(v*PackFactors.a,vuf);float bf=modf(vuf*ShiftRight8,vuf);float gf=modf(vuf*ShiftRight8,vuf);return vec4(vuf*Inv255,gf*PackUpscale,bf*PackUpscale,af);}vec3 packDepthToRGB(const in float v){if(v<=0.0)return vec3(0.,0.,0.);if(v>=1.0)return vec3(1.,1.,1.);float vuf;float bf=modf(v*PackFactors.b,vuf);float gf=modf(vuf*ShiftRight8,vuf);return vec3(vuf*Inv255,gf*PackUpscale,bf);}vec2 packDepthToRG(const in float v){if(v<=0.0)return vec2(0.,0.);if(v>=1.0)return vec2(1.,1.);float vuf;float gf=modf(v*256.,vuf);return vec2(vuf*Inv255,gf);}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors4);}float unpackRGBToDepth(const in vec3 v){return dot(v,UnpackFactors3);}float unpackRGToDepth(const in vec2 v){return v.r*UnpackFactors2.r+v.g*UnpackFactors2.g;}vec4 pack2HalfToRGBA(const in vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(const in vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float depth,const in float near,const in float far){return depth*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float depth,const in float near,const in float far){return(near*far)/((far-near)*depth-far);}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\ngl_FragColor.rgb*=gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition=vec4(transformed,1.0);\n#ifdef USE_BATCHING\nmvPosition=batchingMatrix*mvPosition;\n#endif\n#ifdef USE_INSTANCING\nmvPosition=instanceMatrix*mvPosition;\n#endif\nmvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;",dithering_fragment:"#ifdef DITHERING\ngl_FragColor.rgb=dithering(gl_FragColor.rgb);\n#endif",dithering_pars_fragment:"#ifdef DITHERING\nvec3 dithering(vec3 color){float grid_position=rand(gl_FragCoord.xy);vec3 dither_shift_RGB=vec3(0.25/255.0,-0.25/255.0,0.25/255.0);dither_shift_RGB=mix(2.0*dither_shift_RGB,-2.0*dither_shift_RGB,grid_position);return color+dither_shift_RGB;}\n#endif",roughnessmap_fragment:"float roughnessFactor=roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness=texture2D(roughnessMap,vRoughnessMapUv);roughnessFactor*=texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\nuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS>0\nvarying vec4 vSpotLightCoord[NUM_SPOT_LIGHT_COORDS];\n#endif\n#if NUM_SPOT_LIGHT_MAPS>0\nuniform sampler2D spotLightMap[NUM_SPOT_LIGHT_MAPS];\n#endif\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform sampler2D directionalShadowMap[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nuniform sampler2D spotShadowMap[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform sampler2D pointShadowMap[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\nfloat texture2DCompare(sampler2D depths,vec2 uv,float compare){return step(compare,unpackRGBAToDepth(texture2D(depths,uv)));}vec2 texture2DDistribution(sampler2D shadow,vec2 uv){return unpackRGBATo2Half(texture2D(shadow,uv));}float VSMShadow(sampler2D shadow,vec2 uv,float compare){float occlusion=1.0;vec2 distribution=texture2DDistribution(shadow,uv);float hard_shadow=step(compare,distribution.x);if(hard_shadow!=1.0){float distance=compare-distribution.x;float variance=max(0.00000,distribution.y*distribution.y);float softness_probability=variance/(variance+distance*distance);softness_probability=clamp((softness_probability-0.3)/(0.95-0.3),0.0,1.0);occlusion=clamp(max(hard_shadow,softness_probability),0.0,1.0);}return occlusion;}float getShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowIntensity,float shadowBias,float shadowRadius,vec4 shadowCoord){float shadow=1.0;shadowCoord.xyz/=shadowCoord.w;shadowCoord.z+=shadowBias;bool inFrustum=shadowCoord.x>=0.0&&shadowCoord.x<=1.0&&shadowCoord.y>=0.0&&shadowCoord.y<=1.0;bool frustumTest=inFrustum&&shadowCoord.z<=1.0;if(frustumTest){\n#if defined(SHADOWMAP_TYPE_PCF)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx0=-texelSize.x*shadowRadius;float dy0=-texelSize.y*shadowRadius;float dx1=+texelSize.x*shadowRadius;float dy1=+texelSize.y*shadowRadius;float dx2=dx0/2.0;float dy2=dy0/2.0;float dx3=dx1/2.0;float dy3=dy1/2.0;shadow=(texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy1),shadowCoord.z))*(1.0/17.0);\n#elif defined(SHADOWMAP_TYPE_PCF_SOFT)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx=texelSize.x;float dy=texelSize.y;vec2 uv=shadowCoord.xy;vec2 f=fract(uv*shadowMapSize+0.5);uv-=f*texelSize;shadow=(texture2DCompare(shadowMap,uv,shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(dx,0.0),shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(0.0,dy),shadowCoord.z)+texture2DCompare(shadowMap,uv+texelSize,shadowCoord.z)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,0.0),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,0.0),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,dy),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(0.0,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(0.0,2.0*dy),shadowCoord.z),f.y)+mix(texture2DCompare(shadowMap,uv+vec2(dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(dx,2.0*dy),shadowCoord.z),f.y)+mix(mix(texture2DCompare(shadowMap,uv+vec2(-dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,-dy),shadowCoord.z),f.x),mix(texture2DCompare(shadowMap,uv+vec2(-dx,2.0*dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,2.0*dy),shadowCoord.z),f.x),f.y))*(1.0/9.0);\n#elif defined(SHADOWMAP_TYPE_VSM)\nshadow=VSMShadow(shadowMap,shadowCoord.xy,shadowCoord.z);\n#else\nshadow=texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);\n#endif\n}return mix(1.0,shadow,shadowIntensity);}vec2 cubeToUV(vec3 v,float texelSizeY){vec3 absV=abs(v);float scaleToCube=1.0/max(absV.x,max(absV.y,absV.z));absV*=scaleToCube;v*=scaleToCube*(1.0-2.0*texelSizeY);vec2 planar=v.xy;float almostATexel=1.5*texelSizeY;float almostOne=1.0-almostATexel;if(absV.z>=almostOne){if(v.z>0.0)planar.x=4.0-v.x;}else if(absV.x>=almostOne){float signX=sign(v.x);planar.x=v.z*signX+2.0*signX;}else if(absV.y>=almostOne){float signY=sign(v.y);planar.x=v.x+2.0*signY+2.0;planar.y=v.z*signY-2.0;}return vec2(0.125,0.25)*planar+vec2(0.375,0.75);}float getPointShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowIntensity,float shadowBias,float shadowRadius,vec4 shadowCoord,float shadowCameraNear,float shadowCameraFar){float shadow=1.0;vec3 lightToPosition=shadowCoord.xyz;float lightToPositionLength=length(lightToPosition);if(lightToPositionLength-shadowCameraFar<=0.0&&lightToPositionLength-shadowCameraNear>=0.0){float dp=(lightToPositionLength-shadowCameraNear)/(shadowCameraFar-shadowCameraNear);dp+=shadowBias;vec3 bd3D=normalize(lightToPosition);vec2 texelSize=vec2(1.0)/(shadowMapSize*vec2(4.0,2.0));\n#if defined(SHADOWMAP_TYPE_PCF)||defined(SHADOWMAP_TYPE_PCF_SOFT)||defined(SHADOWMAP_TYPE_VSM)\nvec2 offset=vec2(-1,1)*shadowRadius*texelSize.y;shadow=(texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxx,texelSize.y),dp))*(1.0/9.0);\n#else\nshadow=texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp);\n#endif\n}return mix(1.0,shadow,shadowIntensity);}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS>0\nuniform mat4 spotLightMatrix[NUM_SPOT_LIGHT_COORDS];varying vec4 vSpotLightCoord[NUM_SPOT_LIGHT_COORDS];\n#endif\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform mat4 directionalShadowMatrix[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nstruct SpotLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform mat4 pointShadowMatrix[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowIntensity;float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\n#endif",shadowmap_vertex:"#if (defined(USE_SHADOWMAP)&&(NUM_DIR_LIGHT_SHADOWS>0||NUM_POINT_LIGHT_SHADOWS>0))||(NUM_SPOT_LIGHT_COORDS>0)\nvec3 shadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 shadowWorldPosition;\n#endif\n#if defined(USE_SHADOWMAP)\n#if NUM_DIR_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*directionalLightShadows[i].shadowNormalBias,0);vDirectionalShadowCoord[i]=directionalShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*pointLightShadows[i].shadowNormalBias,0);vPointShadowCoord[i]=pointShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_COORDS;i++){shadowWorldPosition=worldPosition;\n#if (defined(USE_SHADOWMAP)&&UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nshadowWorldPosition.xyz+=shadowWorldNormal*spotLightShadows[i].shadowNormalBias;\n#endif\nvSpotLightCoord[i]=spotLightMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask(){float shadow=1.0;\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){directionalLight=directionalLightShadows[i];shadow*=receiveShadow?getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,directionalLight.shadowIntensity,directionalLight.shadowBias,directionalLight.shadowRadius,vDirectionalShadowCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){spotLight=spotLightShadows[i];shadow*=receiveShadow?getShadow(spotShadowMap[i],spotLight.shadowMapSize,spotLight.shadowIntensity,spotLight.shadowBias,spotLight.shadowRadius,vSpotLightCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){pointLight=pointLightShadows[i];shadow*=receiveShadow?getPointShadow(pointShadowMap[i],pointLight.shadowMapSize,pointLight.shadowIntensity,pointLight.shadowBias,pointLight.shadowRadius,vPointShadowCoord[i],pointLight.shadowCameraNear,pointLight.shadowCameraFar):1.0;}\n#pragma unroll_loop_end\n#endif\n#endif\nreturn shadow;}",skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX=getBoneMatrix(skinIndex.x);mat4 boneMatY=getBoneMatrix(skinIndex.y);mat4 boneMatZ=getBoneMatrix(skinIndex.z);mat4 boneMatW=getBoneMatrix(skinIndex.w);\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\nuniform mat4 bindMatrix;uniform mat4 bindMatrixInverse;uniform highp sampler2D boneTexture;mat4 getBoneMatrix(const in float i){int size=textureSize(boneTexture,0).x;int j=int(i)*4;int x=j%size;int y=j/size;vec4 v1=texelFetch(boneTexture,ivec2(x,y),0);vec4 v2=texelFetch(boneTexture,ivec2(x+1,y),0);vec4 v3=texelFetch(boneTexture,ivec2(x+2,y),0);vec4 v4=texelFetch(boneTexture,ivec2(x+3,y),0);return mat4(v1,v2,v3,v4);}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\nvec4 skinVertex=bindMatrix*vec4(transformed,1.0);vec4 skinned=vec4(0.0);skinned+=boneMatX*skinVertex*skinWeight.x;skinned+=boneMatY*skinVertex*skinWeight.y;skinned+=boneMatZ*skinVertex*skinWeight.z;skinned+=boneMatW*skinVertex*skinWeight.w;transformed=(bindMatrixInverse*skinned).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix=mat4(0.0);skinMatrix+=skinWeight.x*boneMatX;skinMatrix+=skinWeight.y*boneMatY;skinMatrix+=skinWeight.z*boneMatZ;skinMatrix+=skinWeight.w*boneMatW;skinMatrix=bindMatrixInverse*skinMatrix*bindMatrix;objectNormal=vec4(skinMatrix*vec4(objectNormal,0.0)).xyz;\n#ifdef USE_TANGENT\nobjectTangent=vec4(skinMatrix*vec4(objectTangent,0.0)).xyz;\n#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular=texture2D(specularMap,vSpecularMapUv);specularStrength=texelSpecular.r;\n#else\nspecularStrength=1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined(TONE_MAPPING)\ngl_FragColor.rgb=toneMapping(gl_FragColor.rgb);\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\nuniform float toneMappingExposure;vec3 LinearToneMapping(vec3 color){return saturate(toneMappingExposure*color);}vec3 ReinhardToneMapping(vec3 color){color*=toneMappingExposure;return saturate(color/(vec3(1.0)+color));}vec3 CineonToneMapping(vec3 color){color*=toneMappingExposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 RRTAndODTFit(vec3 v){vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}vec3 ACESFilmicToneMapping(vec3 color){const mat3 ACESInputMat=mat3(vec3(0.59719,0.07600,0.02840),vec3(0.35458,0.90834,0.13383),vec3(0.04823,0.01566,0.83777));const mat3 ACESOutputMat=mat3(vec3(1.60475,-0.10208,-0.00327),vec3(-0.53108,1.10813,-0.07276),vec3(-0.07367,-0.00605,1.07602));color*=toneMappingExposure/0.6;color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;return saturate(color);}const mat3 LINEAR_REC2020_TO_LINEAR_SRGB=mat3(vec3(1.6605,-0.1246,-0.0182),vec3(-0.5876,1.1329,-0.1006),vec3(-0.0728,-0.0083,1.1187));const mat3 LINEAR_SRGB_TO_LINEAR_REC2020=mat3(vec3(0.6274,0.0691,0.0164),vec3(0.3293,0.9195,0.0880),vec3(0.0433,0.0113,0.8956));vec3 agxDefaultContrastApprox(vec3 x){vec3 x2=x*x;vec3 x4=x2*x2;return+15.5*x4*x2-40.14*x4*x+31.96*x4-6.868*x2*x+0.4298*x2+0.1191*x-0.00232;}vec3 AgXToneMapping(vec3 color){const mat3 AgXInsetMatrix=mat3(vec3(0.856627153315983,0.137318972929847,0.11189821299995),vec3(0.0951212405381588,0.761241990602591,0.0767994186031903),vec3(0.0482516061458583,0.101439036467562,0.811302368396859));const mat3 AgXOutsetMatrix=mat3(vec3(1.1271005818144368,-0.1413297634984383,-0.14132976349843826),vec3(-0.11060664309660323,1.157823702216272,-0.11060664309660294),vec3(-0.016493938717834573,-0.016493938717834257,1.2519364065950405));const float AgxMinEv=-12.47393;const float AgxMaxEv=4.026069;color*=toneMappingExposure;color=LINEAR_SRGB_TO_LINEAR_REC2020*color;color=AgXInsetMatrix*color;color=max(color,1e-10);color=log2(color);color=(color-AgxMinEv)/(AgxMaxEv-AgxMinEv);color=clamp(color,0.0,1.0);color=agxDefaultContrastApprox(color);color=AgXOutsetMatrix*color;color=pow(max(vec3(0.0),color),vec3(2.2));color=LINEAR_REC2020_TO_LINEAR_SRGB*color;color=clamp(color,0.0,1.0);return color;}vec3 NeutralToneMapping(vec3 color){const float StartCompression=0.8-0.04;const float Desaturation=0.15;color*=toneMappingExposure;float x=min(color.r,min(color.g,color.b));float offset=x<0.08?x-6.25*x*x:0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if(peak<StartCompression)return color;float d=1.-StartCompression;float newPeak=1.-d*d/(peak+d-StartCompression);color*=newPeak/peak;float g=1.-1./(Desaturation*(peak-newPeak)+1.);return mix(color,vec3(newPeak),g);}vec3 CustomToneMapping(vec3 color){return color;}",transmission_fragment:"#ifdef USE_TRANSMISSION\nmaterial.transmission=transmission;material.transmissionAlpha=1.0;material.thickness=thickness;material.attenuationDistance=attenuationDistance;material.attenuationColor=attenuationColor;\n#ifdef USE_TRANSMISSIONMAP\nmaterial.transmission*=texture2D(transmissionMap,vTransmissionMapUv).r;\n#endif\n#ifdef USE_THICKNESSMAP\nmaterial.thickness*=texture2D(thicknessMap,vThicknessMapUv).g;\n#endif\nvec3 pos=vWorldPosition;vec3 v=normalize(cameraPosition-pos);vec3 n=inverseTransformDirection(normal,viewMatrix);vec4 transmitted=getIBLVolumeRefraction(n,v,material.roughness,material.diffuseColor,material.specularColor,material.specularF90,pos,modelMatrix,viewMatrix,projectionMatrix,material.dispersion,material.ior,material.thickness,material.attenuationColor,material.attenuationDistance);material.transmissionAlpha=mix(material.transmissionAlpha,transmitted.a,material.transmission);totalDiffuse=mix(totalDiffuse,transmitted.rgb,material.transmission);\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\nuniform float transmission;uniform float thickness;uniform float attenuationDistance;uniform vec3 attenuationColor;\n#ifdef USE_TRANSMISSIONMAP\nuniform sampler2D transmissionMap;\n#endif\n#ifdef USE_THICKNESSMAP\nuniform sampler2D thicknessMap;\n#endif\nuniform vec2 transmissionSamplerSize;uniform sampler2D transmissionSamplerMap;uniform mat4 modelMatrix;uniform mat4 projectionMatrix;varying vec3 vWorldPosition;float w0(float a){return(1.0/6.0)*(a*(a*(-a+3.0)-3.0)+1.0);}float w1(float a){return(1.0/6.0)*(a*a*(3.0*a-6.0)+4.0);}float w2(float a){return(1.0/6.0)*(a*(a*(-3.0*a+3.0)+3.0)+1.0);}float w3(float a){return(1.0/6.0)*(a*a*a);}float g0(float a){return w0(a)+w1(a);}float g1(float a){return w2(a)+w3(a);}float h0(float a){return-1.0+w1(a)/(w0(a)+w1(a));}float h1(float a){return 1.0+w3(a)/(w2(a)+w3(a));}vec4 bicubic(sampler2D tex,vec2 uv,vec4 texelSize,float lod){uv=uv*texelSize.zw+0.5;vec2 iuv=floor(uv);vec2 fuv=fract(uv);float g0x=g0(fuv.x);float g1x=g1(fuv.x);float h0x=h0(fuv.x);float h1x=h1(fuv.x);float h0y=h0(fuv.y);float h1y=h1(fuv.y);vec2 p0=(vec2(iuv.x+h0x,iuv.y+h0y)-0.5)*texelSize.xy;vec2 p1=(vec2(iuv.x+h1x,iuv.y+h0y)-0.5)*texelSize.xy;vec2 p2=(vec2(iuv.x+h0x,iuv.y+h1y)-0.5)*texelSize.xy;vec2 p3=(vec2(iuv.x+h1x,iuv.y+h1y)-0.5)*texelSize.xy;return g0(fuv.y)*(g0x*textureLod(tex,p0,lod)+g1x*textureLod(tex,p1,lod))+g1(fuv.y)*(g0x*textureLod(tex,p2,lod)+g1x*textureLod(tex,p3,lod));}vec4 textureBicubic(sampler2D sampler,vec2 uv,float lod){vec2 fLodSize=vec2(textureSize(sampler,int(lod)));vec2 cLodSize=vec2(textureSize(sampler,int(lod+1.0)));vec2 fLodSizeInv=1.0/fLodSize;vec2 cLodSizeInv=1.0/cLodSize;vec4 fSample=bicubic(sampler,uv,vec4(fLodSizeInv,fLodSize),floor(lod));vec4 cSample=bicubic(sampler,uv,vec4(cLodSizeInv,cLodSize),ceil(lod));return mix(fSample,cSample,fract(lod));}vec3 getVolumeTransmissionRay(const in vec3 n,const in vec3 v,const in float thickness,const in float ior,const in mat4 modelMatrix){vec3 refractionVector=refract(-v,normalize(n),1.0/ior);vec3 modelScale;modelScale.x=length(vec3(modelMatrix[0].xyz));modelScale.y=length(vec3(modelMatrix[1].xyz));modelScale.z=length(vec3(modelMatrix[2].xyz));return normalize(refractionVector)*thickness*modelScale;}float applyIorToRoughness(const in float roughness,const in float ior){return roughness*clamp(ior*2.0-2.0,0.0,1.0);}vec4 getTransmissionSample(const in vec2 fragCoord,const in float roughness,const in float ior){float lod=log2(transmissionSamplerSize.x)*applyIorToRoughness(roughness,ior);return textureBicubic(transmissionSamplerMap,fragCoord.xy,lod);}vec3 volumeAttenuation(const in float transmissionDistance,const in vec3 attenuationColor,const in float attenuationDistance){if(isinf(attenuationDistance)){return vec3(1.0);}else{vec3 attenuationCoefficient=-log(attenuationColor)/attenuationDistance;vec3 transmittance=exp(-attenuationCoefficient*transmissionDistance);return transmittance;}}vec4 getIBLVolumeRefraction(const in vec3 n,const in vec3 v,const in float roughness,const in vec3 diffuseColor,const in vec3 specularColor,const in float specularF90,const in vec3 position,const in mat4 modelMatrix,const in mat4 viewMatrix,const in mat4 projMatrix,const in float dispersion,const in float ior,const in float thickness,const in vec3 attenuationColor,const in float attenuationDistance){vec4 transmittedLight;vec3 transmittance;\n#ifdef USE_DISPERSION\nfloat halfSpread=(ior-1.0)*0.025*dispersion;vec3 iors=vec3(ior-halfSpread,ior,ior+halfSpread);for(int i=0;i<3;i++){vec3 transmissionRay=getVolumeTransmissionRay(n,v,thickness,iors[i],modelMatrix);vec3 refractedRayExit=position+transmissionRay;vec4 ndcPos=projMatrix*viewMatrix*vec4(refractedRayExit,1.0);vec2 refractionCoords=ndcPos.xy/ndcPos.w;refractionCoords+=1.0;refractionCoords/=2.0;vec4 transmissionSample=getTransmissionSample(refractionCoords,roughness,iors[i]);transmittedLight[i]=transmissionSample[i];transmittedLight.a+=transmissionSample.a;transmittance[i]=diffuseColor[i]*volumeAttenuation(length(transmissionRay),attenuationColor,attenuationDistance)[i];}transmittedLight.a/=3.0;\n#else\nvec3 transmissionRay=getVolumeTransmissionRay(n,v,thickness,ior,modelMatrix);vec3 refractedRayExit=position+transmissionRay;vec4 ndcPos=projMatrix*viewMatrix*vec4(refractedRayExit,1.0);vec2 refractionCoords=ndcPos.xy/ndcPos.w;refractionCoords+=1.0;refractionCoords/=2.0;transmittedLight=getTransmissionSample(refractionCoords,roughness,ior);transmittance=diffuseColor*volumeAttenuation(length(transmissionRay),attenuationColor,attenuationDistance);\n#endif\nvec3 attenuatedColor=transmittance*transmittedLight.rgb;vec3 F=EnvironmentBRDF(n,v,specularColor,specularF90,roughness);float transmittanceFactor=(transmittance.r+transmittance.g+transmittance.b)/3.0;return vec4((1.0-F)*attenuatedColor,1.0-(1.0-transmittedLight.a)*transmittanceFactor);}\n#endif",uv_pars_fragment:"#if defined(USE_UV)||defined(USE_ANISOTROPY)\nvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\nvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\nvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\nvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\nvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\nvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\nvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\nvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\nvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\nvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\nvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\nvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\nvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\nvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\nvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\nvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\nvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\nvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\nvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\nuniform mat3 transmissionMapTransform;varying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\nuniform mat3 thicknessMapTransform;varying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined(USE_UV)||defined(USE_ANISOTROPY)\nvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\nuniform mat3 mapTransform;varying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\nuniform mat3 alphaMapTransform;varying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\nuniform mat3 lightMapTransform;varying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\nuniform mat3 aoMapTransform;varying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\nuniform mat3 bumpMapTransform;varying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\nuniform mat3 normalMapTransform;varying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\nuniform mat3 displacementMapTransform;varying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\nuniform mat3 emissiveMapTransform;varying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\nuniform mat3 metalnessMapTransform;varying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\nuniform mat3 roughnessMapTransform;varying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\nuniform mat3 anisotropyMapTransform;varying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\nuniform mat3 clearcoatMapTransform;varying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nuniform mat3 clearcoatNormalMapTransform;varying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nuniform mat3 clearcoatRoughnessMapTransform;varying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\nuniform mat3 sheenColorMapTransform;varying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\nuniform mat3 sheenRoughnessMapTransform;varying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\nuniform mat3 iridescenceMapTransform;varying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\nuniform mat3 iridescenceThicknessMapTransform;varying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\nuniform mat3 specularMapTransform;varying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\nuniform mat3 specularColorMapTransform;varying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\nuniform mat3 specularIntensityMapTransform;varying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\nuniform mat3 transmissionMapTransform;varying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\nuniform mat3 thicknessMapTransform;varying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined(USE_UV)||defined(USE_ANISOTROPY)\nvUv=vec3(uv,1).xy;\n#endif\n#ifdef USE_MAP\nvMapUv=(mapTransform*vec3(MAP_UV,1)).xy;\n#endif\n#ifdef USE_ALPHAMAP\nvAlphaMapUv=(alphaMapTransform*vec3(ALPHAMAP_UV,1)).xy;\n#endif\n#ifdef USE_LIGHTMAP\nvLightMapUv=(lightMapTransform*vec3(LIGHTMAP_UV,1)).xy;\n#endif\n#ifdef USE_AOMAP\nvAoMapUv=(aoMapTransform*vec3(AOMAP_UV,1)).xy;\n#endif\n#ifdef USE_BUMPMAP\nvBumpMapUv=(bumpMapTransform*vec3(BUMPMAP_UV,1)).xy;\n#endif\n#ifdef USE_NORMALMAP\nvNormalMapUv=(normalMapTransform*vec3(NORMALMAP_UV,1)).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\nvDisplacementMapUv=(displacementMapTransform*vec3(DISPLACEMENTMAP_UV,1)).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\nvEmissiveMapUv=(emissiveMapTransform*vec3(EMISSIVEMAP_UV,1)).xy;\n#endif\n#ifdef USE_METALNESSMAP\nvMetalnessMapUv=(metalnessMapTransform*vec3(METALNESSMAP_UV,1)).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\nvRoughnessMapUv=(roughnessMapTransform*vec3(ROUGHNESSMAP_UV,1)).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\nvAnisotropyMapUv=(anisotropyMapTransform*vec3(ANISOTROPYMAP_UV,1)).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\nvClearcoatMapUv=(clearcoatMapTransform*vec3(CLEARCOATMAP_UV,1)).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nvClearcoatNormalMapUv=(clearcoatNormalMapTransform*vec3(CLEARCOAT_NORMALMAP_UV,1)).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nvClearcoatRoughnessMapUv=(clearcoatRoughnessMapTransform*vec3(CLEARCOAT_ROUGHNESSMAP_UV,1)).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\nvIridescenceMapUv=(iridescenceMapTransform*vec3(IRIDESCENCEMAP_UV,1)).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\nvIridescenceThicknessMapUv=(iridescenceThicknessMapTransform*vec3(IRIDESCENCE_THICKNESSMAP_UV,1)).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\nvSheenColorMapUv=(sheenColorMapTransform*vec3(SHEEN_COLORMAP_UV,1)).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\nvSheenRoughnessMapUv=(sheenRoughnessMapTransform*vec3(SHEEN_ROUGHNESSMAP_UV,1)).xy;\n#endif\n#ifdef USE_SPECULARMAP\nvSpecularMapUv=(specularMapTransform*vec3(SPECULARMAP_UV,1)).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\nvSpecularColorMapUv=(specularColorMapTransform*vec3(SPECULAR_COLORMAP_UV,1)).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\nvSpecularIntensityMapUv=(specularIntensityMapTransform*vec3(SPECULAR_INTENSITYMAP_UV,1)).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\nvTransmissionMapUv=(transmissionMapTransform*vec3(TRANSMISSIONMAP_UV,1)).xy;\n#endif\n#ifdef USE_THICKNESSMAP\nvThicknessMapUv=(thicknessMapTransform*vec3(THICKNESSMAP_UV,1)).xy;\n#endif",worldpos_vertex:"#if defined(USE_ENVMAP)||defined(DISTANCE)||defined(USE_SHADOWMAP)||defined(USE_TRANSMISSION)||NUM_SPOT_LIGHT_COORDS>0\nvec4 worldPosition=vec4(transformed,1.0);\n#ifdef USE_BATCHING\nworldPosition=batchingMatrix*worldPosition;\n#endif\n#ifdef USE_INSTANCING\nworldPosition=instanceMatrix*worldPosition;\n#endif\nworldPosition=modelMatrix*worldPosition;\n#endif",background_vert:"varying vec2 vUv;uniform mat3 uvTransform;void main(){vUv=(uvTransform*vec3(uv,1)).xy;gl_Position=vec4(position.xy,1.0,1.0);}",background_frag:"uniform sampler2D t2D;uniform float backgroundIntensity;varying vec2 vUv;void main(){vec4 texColor=texture2D(t2D,vUv);\n#ifdef DECODE_VIDEO_TEXTURE\ntexColor=vec4(mix(pow(texColor.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),texColor.rgb*0.0773993808,vec3(lessThanEqual(texColor.rgb,vec3(0.04045)))),texColor.w);\n#endif\ntexColor.rgb*=backgroundIntensity;gl_FragColor=texColor;\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\ngl_Position.z=gl_Position.w;}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\nuniform samplerCube envMap;\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;uniform float backgroundBlurriness;uniform float backgroundIntensity;uniform mat3 backgroundRotation;varying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main(){\n#ifdef ENVMAP_TYPE_CUBE\nvec4 texColor=textureCube(envMap,backgroundRotation*vec3(flipEnvMap*vWorldDirection.x,vWorldDirection.yz));\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nvec4 texColor=textureCubeUV(envMap,backgroundRotation*vWorldDirection,backgroundBlurriness);\n#else\nvec4 texColor=vec4(0.0,0.0,0.0,1.0);\n#endif\ntexColor.rgb*=backgroundIntensity;gl_FragColor=texColor;\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\ngl_Position.z=gl_Position.w;}",cube_frag:"uniform samplerCube tCube;uniform float tFlip;uniform float opacity;varying vec3 vWorldDirection;void main(){vec4 texColor=textureCube(tCube,vec3(tFlip*vWorldDirection.x,vWorldDirection.yz));gl_FragColor=texColor;gl_FragColor.a*=opacity;\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;void main(){\n#include <uv_vertex>\n#include <batching_vertex>\n#include <skinbase_vertex>\n#include <morphinstance_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvHighPrecisionZW=gl_Position.zw;}",depth_frag:"#if DEPTH_PACKING==3200\nuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;void main(){vec4 diffuseColor=vec4(1.0);\n#include <clipping_planes_fragment>\n#if DEPTH_PACKING==3200\ndiffuseColor.a=opacity;\n#endif\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <logdepthbuf_fragment>\nfloat fragCoordZ=0.5*vHighPrecisionZW[0]/vHighPrecisionZW[1]+0.5;\n#if DEPTH_PACKING==3200\ngl_FragColor=vec4(vec3(1.0-fragCoordZ),opacity);\n#elif DEPTH_PACKING==3201\ngl_FragColor=packDepthToRGBA(fragCoordZ);\n#elif DEPTH_PACKING==3202\ngl_FragColor=vec4(packDepthToRGB(fragCoordZ),1.0);\n#elif DEPTH_PACKING==3203\ngl_FragColor=vec4(packDepthToRG(fragCoordZ),0.0,1.0);\n#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <batching_vertex>\n#include <skinbase_vertex>\n#include <morphinstance_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <clipping_planes_vertex>\nvWorldPosition=worldPosition.xyz;}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;uniform float nearDistance;uniform float farDistance;varying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(1.0);\n#include <clipping_planes_fragment>\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\nfloat dist=length(vWorldPosition-referencePosition);dist=(dist-nearDistance)/(farDistance-nearDistance);dist=saturate(dist);gl_FragColor=packDepthToRGBA(dist);}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vec3 direction=normalize(vWorldDirection);vec2 sampleUV=equirectUv(direction);gl_FragColor=texture2D(tEquirect,sampleUV);\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;attribute float lineDistance;varying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){vLineDistance=scale*lineDistance;\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;uniform float opacity;uniform float dashSize;uniform float totalSize;varying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nif(mod(vLineDistance,totalSize)>dashSize){discard;}vec3 outgoingLight=vec3(0.0);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#if defined(USE_ENVMAP)||defined(USE_SKINNING)\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;uniform float opacity;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <specularmap_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vLightMapUv);reflectedLight.indirectDiffuse+=lightMapTexel.rgb*lightMapIntensity*RECIPROCAL_PI;\n#else\nreflectedLight.indirectDiffuse+=vec3(1.0);\n#endif\n#include <aomap_fragment>\nreflectedLight.indirectDiffuse*=diffuseColor.rgb;vec3 outgoingLight=reflectedLight.indirectDiffuse;\n#include <envmap_fragment>\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <specularmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_lambert_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;\n#include <envmap_fragment>\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\nvViewPosition=-mvPosition.xyz;}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;uniform float opacity;uniform sampler2D matcap;varying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\nvec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 uv=vec2(dot(x,normal),dot(y,normal))*0.495+0.5;\n#ifdef USE_MATCAP\nvec4 matcapColor=texture2D(matcap,uv);\n#else\nvec4 matcapColor=vec4(vec3(mix(0.2,0.8,uv.y)),1.0);\n#endif\nvec3 outgoingLight=diffuseColor.rgb*matcapColor.rgb;\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(USE_NORMALMAP_TANGENTSPACE)\nvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphinstance_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(USE_NORMALMAP_TANGENTSPACE)\nvViewPosition=-mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(USE_NORMALMAP_TANGENTSPACE)\nvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(0.0,0.0,0.0,opacity);\n#include <clipping_planes_fragment>\n#include <logdepthbuf_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\ngl_FragColor=vec4(packNormalToRGB(normal),diffuseColor.a);\n#ifdef OPAQUE\ngl_FragColor.a=1.0;\n#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphinstance_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <specularmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#include <envmap_fragment>\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\nvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n#ifdef USE_TRANSMISSION\nvWorldPosition=worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;uniform vec3 emissive;uniform float roughness;uniform float metalness;uniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef USE_SPECULAR\nuniform float specularIntensity;uniform vec3 specularColor;\n#ifdef USE_SPECULAR_COLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;uniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\nuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;uniform float iridescenceIOR;uniform float iridescenceThicknessMinimum;uniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;uniform float sheenRoughness;\n#ifdef USE_SHEEN_COLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n#ifdef USE_ANISOTROPY\nuniform vec2 anisotropyVector;\n#ifdef USE_ANISOTROPYMAP\nuniform sampler2D anisotropyMap;\n#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <roughnessmap_fragment>\n#include <metalnessmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <clearcoat_normal_fragment_begin>\n#include <clearcoat_normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 totalDiffuse=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse;vec3 totalSpecular=reflectedLight.directSpecular+reflectedLight.indirectSpecular;\n#include <transmission_fragment>\nvec3 outgoingLight=totalDiffuse+totalSpecular+totalEmissiveRadiance;\n#ifdef USE_SHEEN\nfloat sheenEnergyComp=1.0-0.157*max3(material.sheenColor);outgoingLight=outgoingLight*sheenEnergyComp+sheenSpecularDirect+sheenSpecularIndirect;\n#endif\n#ifdef USE_CLEARCOAT\nfloat dotNVcc=saturate(dot(geometryClearcoatNormal,geometryViewDir));vec3 Fcc=F_Schlick(material.clearcoatF0,material.clearcoatF90,dotNVcc);outgoingLight=outgoingLight*(1.0-material.clearcoat*Fcc)+(clearcoatSpecularDirect+clearcoatSpecularIndirect)*material.clearcoat;\n#endif\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_toon_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",points_vert:"uniform float size;uniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\nvarying vec2 vUv;uniform mat3 uvTransform;\n#endif\nvoid main(){\n#ifdef USE_POINTS_UV\nvUv=(uvTransform*vec3(uv,1)).xy;\n#endif\n#include <color_vertex>\n#include <morphinstance_vertex>\n#include <morphcolor_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\ngl_PointSize=size;\n#ifdef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)gl_PointSize*=(scale/-mvPosition.z);\n#endif\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);\n#include <logdepthbuf_fragment>\n#include <map_particle_fragment>\n#include <color_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <batching_vertex>\n#include <beginnormal_vertex>\n#include <morphinstance_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;uniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main(){\n#include <logdepthbuf_fragment>\ngl_FragColor=vec4(color,opacity*(1.0-getShadowMask()));\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;uniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\nvec4 mvPosition=modelViewMatrix[3];vec2 scale=vec2(length(modelMatrix[0].xyz),length(modelMatrix[1].xyz));\n#ifndef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)scale*=-mvPosition.z;\n#endif\nvec2 alignedPosition=(position.xy-(center-vec2(0.5)))*scale;vec2 rotatedPosition;rotatedPosition.x=cos(rotation)*alignedPosition.x-sin(rotation)*alignedPosition.y;rotatedPosition.y=sin(rotation)*alignedPosition.x+cos(rotation)*alignedPosition.y;mvPosition.xy+=rotatedPosition;gl_Position=projectionMatrix*mvPosition;\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){vec4 diffuseColor=vec4(diffuse,opacity);\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <alphahash_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <opaque_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n#include <fog_fragment>\n}"},Id={common:{diffuse:{value:new Color(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Matrix3}},envmap:{envMap:{value:null},envMapRotation:{value:new Matrix3},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Matrix3}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Matrix3}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Matrix3},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Matrix3},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Matrix3},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Matrix3}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Matrix3}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Matrix3}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Color(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0},uvTransform:{value:new Matrix3}},sprite:{diffuse:{value:new Color(16777215)},opacity:{value:1},center:{value:new Vector2(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0}}},Dd={basic:{uniforms:Xc([Id.common,Id.specularmap,Id.envmap,Id.aomap,Id.lightmap,Id.fog]),vertexShader:Pd.meshbasic_vert,fragmentShader:Pd.meshbasic_frag},lambert:{uniforms:Xc([Id.common,Id.specularmap,Id.envmap,Id.aomap,Id.lightmap,Id.emissivemap,Id.bumpmap,Id.normalmap,Id.displacementmap,Id.fog,Id.lights,{emissive:{value:new Color(0)}}]),vertexShader:Pd.meshlambert_vert,fragmentShader:Pd.meshlambert_frag},phong:{uniforms:Xc([Id.common,Id.specularmap,Id.envmap,Id.aomap,Id.lightmap,Id.emissivemap,Id.bumpmap,Id.normalmap,Id.displacementmap,Id.fog,Id.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:Pd.meshphong_vert,fragmentShader:Pd.meshphong_frag},standard:{uniforms:Xc([Id.common,Id.envmap,Id.aomap,Id.lightmap,Id.emissivemap,Id.bumpmap,Id.normalmap,Id.displacementmap,Id.roughnessmap,Id.metalnessmap,Id.fog,Id.lights,{emissive:{value:new Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Pd.meshphysical_vert,fragmentShader:Pd.meshphysical_frag},toon:{uniforms:Xc([Id.common,Id.aomap,Id.lightmap,Id.emissivemap,Id.bumpmap,Id.normalmap,Id.displacementmap,Id.gradientmap,Id.fog,Id.lights,{emissive:{value:new Color(0)}}]),vertexShader:Pd.meshtoon_vert,fragmentShader:Pd.meshtoon_frag},matcap:{uniforms:Xc([Id.common,Id.bumpmap,Id.normalmap,Id.displacementmap,Id.fog,{matcap:{value:null}}]),vertexShader:Pd.meshmatcap_vert,fragmentShader:Pd.meshmatcap_frag},points:{uniforms:Xc([Id.points,Id.fog]),vertexShader:Pd.points_vert,fragmentShader:Pd.points_frag},dashed:{uniforms:Xc([Id.common,Id.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Pd.linedashed_vert,fragmentShader:Pd.linedashed_frag},depth:{uniforms:Xc([Id.common,Id.displacementmap]),vertexShader:Pd.depth_vert,fragmentShader:Pd.depth_frag},normal:{uniforms:Xc([Id.common,Id.bumpmap,Id.normalmap,Id.displacementmap,{opacity:{value:1}}]),vertexShader:Pd.meshnormal_vert,fragmentShader:Pd.meshnormal_frag},sprite:{uniforms:Xc([Id.sprite,Id.fog]),vertexShader:Pd.sprite_vert,fragmentShader:Pd.sprite_frag},background:{uniforms:{uvTransform:{value:new Matrix3},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Pd.background_vert,fragmentShader:Pd.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new Matrix3}},vertexShader:Pd.backgroundCube_vert,fragmentShader:Pd.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Pd.cube_vert,fragmentShader:Pd.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Pd.equirect_vert,fragmentShader:Pd.equirect_frag},distanceRGBA:{uniforms:Xc([Id.common,Id.displacementmap,{referencePosition:{value:new Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Pd.distanceRGBA_vert,fragmentShader:Pd.distanceRGBA_frag},shadow:{uniforms:Xc([Id.lights,Id.fog,{color:{value:new Color(0)},opacity:{value:1}}]),vertexShader:Pd.shadow_vert,fragmentShader:Pd.shadow_frag}};Dd.physical={uniforms:Xc([Dd.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Matrix3},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Matrix3},clearcoatNormalScale:{value:new Vector2(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Matrix3},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Matrix3},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Matrix3},sheen:{value:0},sheenColor:{value:new Color(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Matrix3},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Matrix3},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Matrix3},transmissionSamplerSize:{value:new Vector2},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Matrix3},attenuationDistance:{value:0},attenuationColor:{value:new Color(0)},specularColor:{value:new Color(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Matrix3},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Matrix3},anisotropyVector:{value:new Vector2},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Matrix3}}]),vertexShader:Pd.meshphysical_vert,fragmentShader:Pd.meshphysical_frag};const kd={r:0,b:0,g:0},Od=new Euler,Ud=new Matrix4;function Nd(e,t,i,r,n,s,a){const o=new Color(0);let l,h,c=!0===s?0:1,d=null,u=0,f=null;function p(e){let r=!0===e.isScene?e.background:null;if(r&&r.isTexture){r=(e.backgroundBlurriness>0?i:t).get(r)}return r}function m(t,i){t.getRGB(kd,Qc(e)),r.buffers.color.setClear(kd.r,kd.g,kd.b,i,a)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),c=t,m(o,c)},getClearAlpha:function(){return c},setClearAlpha:function(e){c=e,m(o,c)},render:function(t){let i=!1;const n=p(t);null===n?m(o,c):n&&n.isColor&&(m(n,1),i=!0);const s=e.xr.getEnvironmentBlendMode();"additive"===s?r.buffers.color.setClear(0,0,0,1,a):"alpha-blend"===s&&r.buffers.color.setClear(0,0,0,0,a),(e.autoClear||i)&&(r.buffers.depth.setTest(!0),r.buffers.depth.setMask(!0),r.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,i){const r=p(i);r&&(r.isCubeTexture||r.mapping===sl)?(void 0===h&&(h=new Mesh(new BoxGeometry(1,1,1),new ShaderMaterial({name:"BackgroundCubeMaterial",uniforms:Yc(Dd.backgroundCube.uniforms),vertexShader:Dd.backgroundCube.vertexShader,fragmentShader:Dd.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),h.geometry.deleteAttribute("normal"),h.geometry.deleteAttribute("uv"),h.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(h.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(h)),Od.copy(i.backgroundRotation),Od.x*=-1,Od.y*=-1,Od.z*=-1,r.isCubeTexture&&!1===r.isRenderTargetTexture&&(Od.y*=-1,Od.z*=-1),h.material.uniforms.envMap.value=r,h.material.uniforms.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,h.material.uniforms.backgroundBlurriness.value=i.backgroundBlurriness,h.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,h.material.uniforms.backgroundRotation.value.setFromMatrix4(Ud.makeRotationFromEuler(Od)),h.material.toneMapped=Ph.getTransfer(r.colorSpace)!==ph,d===r&&u===r.version&&f===e.toneMapping||(h.material.needsUpdate=!0,d=r,u=r.version,f=e.toneMapping),h.layers.enableAll(),t.unshift(h,h.geometry,h.material,0,0,null)):r&&r.isTexture&&(void 0===l&&(l=new Mesh(new PlaneGeometry(2,2),new ShaderMaterial({name:"BackgroundMaterial",uniforms:Yc(Dd.background.uniforms),vertexShader:Dd.background.vertexShader,fragmentShader:Dd.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(l)),l.material.uniforms.t2D.value=r,l.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,l.material.toneMapped=Ph.getTransfer(r.colorSpace)!==ph,!0===r.matrixAutoUpdate&&r.updateMatrix(),l.material.uniforms.uvTransform.value.copy(r.matrix),d===r&&u===r.version&&f===e.toneMapping||(l.material.needsUpdate=!0,d=r,u=r.version,f=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==h&&(h.geometry.dispose(),h.material.dispose(),h=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function Fd(e,t){const i=e.getParameter(34921),r={},n=h(null);let s=n,a=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function h(e){const t=[],r=[],n=[];for(let e=0;e<i;e++)t[e]=0,r[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:r,attributeDivisors:n,object:e,attributes:{},index:null}}function c(){const e=s.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function d(e){u(e,0)}function u(t,i){const r=s.newAttributes,n=s.enabledAttributes,a=s.attributeDivisors;r[t]=1,0===n[t]&&(e.enableVertexAttribArray(t),n[t]=1),a[t]!==i&&(e.vertexAttribDivisor(t,i),a[t]=i)}function f(){const t=s.newAttributes,i=s.enabledAttributes;for(let r=0,n=i.length;r<n;r++)i[r]!==t[r]&&(e.disableVertexAttribArray(r),i[r]=0)}function p(t,i,r,n,s,a,o){!0===o?e.vertexAttribIPointer(t,i,r,s,a):e.vertexAttribPointer(t,i,r,n,s,a)}function m(){g(),a=!0,s!==n&&(s=n,o(s.object))}function g(){n.geometry=null,n.program=null,n.wireframe=!1}return{setup:function(i,n,l,m,g){let v=!1;const y=function(t,i,n){const s=!0===n.wireframe;let a=r[t.id];void 0===a&&(a={},r[t.id]=a);let o=a[i.id];void 0===o&&(o={},a[i.id]=o);let l=o[s];void 0===l&&(l=h(e.createVertexArray()),o[s]=l);return l}(m,l,n);s!==y&&(s=y,o(s.object)),v=function(e,t,i,r){const n=s.attributes,a=t.attributes;let o=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){const i=n[t];let r=a[t];if(void 0===r&&("instanceMatrix"===t&&e.instanceMatrix&&(r=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(r=e.instanceColor)),void 0===i)return!0;if(i.attribute!==r)return!0;if(r&&i.data!==r.data)return!0;o++}}return s.attributesNum!==o||s.index!==r}(i,m,l,g),v&&function(e,t,i,r){const n={},a=t.attributes;let o=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){let i=a[t];void 0===i&&("instanceMatrix"===t&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(i=e.instanceColor));const r={};r.attribute=i,i&&i.data&&(r.data=i.data),n[t]=r,o++}}s.attributes=n,s.attributesNum=o,s.index=r}(i,m,l,g),null!==g&&t.update(g,34963),(v||a)&&(a=!1,function(i,r,n,s){c();const a=s.attributes,o=n.getAttributes(),l=r.defaultAttributeValues;for(const r in o){const n=o[r];if(n.location>=0){let o=a[r];if(void 0===o&&("instanceMatrix"===r&&i.instanceMatrix&&(o=i.instanceMatrix),"instanceColor"===r&&i.instanceColor&&(o=i.instanceColor)),void 0!==o){const r=o.normalized,a=o.itemSize,l=t.get(o);if(void 0===l)continue;const h=l.buffer,c=l.type,f=l.bytesPerElement,m=5124===c||5125===c||o.gpuType===_l;if(o.isInterleavedBufferAttribute){const t=o.data,l=t.stride,g=o.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<n.locationSize;e++)u(n.location+e,t.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<n.locationSize;e++)d(n.location+e);e.bindBuffer(34962,h);for(let e=0;e<n.locationSize;e++)p(n.location+e,a/n.locationSize,c,r,l*f,(g+a/n.locationSize*e)*f,m)}else{if(o.isInstancedBufferAttribute){for(let e=0;e<n.locationSize;e++)u(n.location+e,o.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=o.meshPerAttribute*o.count)}else for(let e=0;e<n.locationSize;e++)d(n.location+e);e.bindBuffer(34962,h);for(let e=0;e<n.locationSize;e++)p(n.location+e,a/n.locationSize,c,r,a*f,a/n.locationSize*e*f,m)}}else if(void 0!==l){const t=l[r];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(n.location,t);break;case 3:e.vertexAttrib3fv(n.location,t);break;case 4:e.vertexAttrib4fv(n.location,t);break;default:e.vertexAttrib1fv(n.location,t)}}}}f()}(i,n,l,m),null!==g&&e.bindBuffer(34963,t.get(g).buffer))},reset:m,resetDefaultState:g,dispose:function(){m();for(const e in r){const t=r[e];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete r[e]}},releaseStatesOfGeometry:function(e){if(void 0===r[e.id])return;const t=r[e.id];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete r[e.id]},releaseStatesOfProgram:function(e){for(const t in r){const i=r[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)l(n[e].object),delete n[e];delete i[e.id]}},initAttributes:c,enableAttribute:d,disableUnusedAttributes:f}}function Bd(e,t,i){let r;function n(t,n,s){0!==s&&(e.drawArraysInstanced(r,t,n,s),i.update(n,r,s))}this.setMode=function(e){r=e},this.render=function(t,n){e.drawArrays(r,t,n),i.update(n,r,1)},this.renderInstances=n,this.renderMultiDraw=function(e,n,s){if(0===s)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(r,e,0,n,0,s);let a=0;for(let e=0;e<s;e++)a+=n[e];i.update(a,r,1)},this.renderMultiDrawInstances=function(e,s,a,o){if(0===a)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)n(e[t],s[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(r,e,0,s,0,o,0,a);let t=0;for(let e=0;e<a;e++)t+=s[e]*o[e];i.update(t,r,1)}}}function Vd(e,t,i,r){let n;function s(t){if("highp"===t){if(e.getShaderPrecisionFormat(35633,36338).precision>0&&e.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(35633,36337).precision>0&&e.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}let a=void 0!==i.precision?i.precision:"highp";const o=s(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const l=!0===i.logarithmicDepthBuffer,h=!0===i.reverseDepthBuffer&&t.has("EXT_clip_control"),c=e.getParameter(34930),d=e.getParameter(35660);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:s,textureFormatReadable:function(t){return t===Al||r.convert(t)===e.getParameter(35739)},textureTypeReadable:function(i){const n=i===Tl&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(i!==ml&&r.convert(i)!==e.getParameter(35738)&&i!==bl&&!n)},precision:a,logarithmicDepthBuffer:l,reverseDepthBuffer:h,maxTextures:c,maxVertexTextures:d,maxTextureSize:e.getParameter(3379),maxCubemapSize:e.getParameter(34076),maxAttributes:e.getParameter(34921),maxVertexUniforms:e.getParameter(36347),maxVaryings:e.getParameter(36348),maxFragmentUniforms:e.getParameter(36349),vertexTextures:d>0,maxSamples:e.getParameter(36183)}}function Gd(e){const t=this;let i=null,r=0,n=!1,s=!1;const a=new Plane,o=new Matrix3,l={value:null,needsUpdate:!1};function h(e,i,r,n){const s=null!==e?e.length:0;let h=null;if(0!==s){if(h=l.value,!0!==n||null===h){const t=r+4*s,n=i.matrixWorldInverse;o.getNormalMatrix(n),(null===h||h.length<t)&&(h=new Float32Array(t));for(let t=0,i=r;t!==s;++t,i+=4)a.copy(e[t]).applyMatrix4(n,o),a.normal.toArray(h,i),h[i+3]=a.constant}l.value=h,l.needsUpdate=!0}return t.numPlanes=s,t.numIntersection=0,h}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const i=0!==e.length||t||0!==r||n;return n=t,r=e.length,i},this.beginShadows=function(){s=!0,h(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(e,t){i=h(e,t,0)},this.setState=function(a,o,c){const d=a.clippingPlanes,u=a.clipIntersection,f=a.clipShadows,p=e.get(a);if(!n||null===d||0===d.length||s&&!f)s?h(null):function(){l.value!==i&&(l.value=i,l.needsUpdate=r>0);t.numPlanes=r,t.numIntersection=0}();else{const e=s?0:r,t=4*e;let n=p.clippingState||null;l.value=n,n=h(d,o,t,c);for(let e=0;e!==t;++e)n[e]=i[e];p.clippingState=n,this.numIntersection=u?this.numPlanes:0,this.numPlanes+=e}}}let zd;class ImageUtils{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===zd&&(zd=Nc("canvas")),zd.width=e.width,zd.height=e.height;const i=zd.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=zd}return t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=Nc("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const r=i.getImageData(0,0,e.width,e.height),n=r.data;for(let e=0;e<n.length;e++)n[e]=255*Ih(n[e]/255);return i.putImageData(r,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*Ih(t[e]/255)):t[e]=Ih(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let Hd=0;class Source{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Hd++}),this.uuid=_o(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const i={uuid:this.uuid,url:""},r=this.data;if(null!==r){let e;if(Array.isArray(r)){e=[];for(let t=0,i=r.length;t<i;t++)r[t].isDataTexture?e.push($d(r[t].image)):e.push($d(r[t]))}else e=$d(r);i.url=e}return t||(e.images[this.uuid]=i),i}}function $d(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?ImageUtils.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Wd=0;class Texture extends EventDispatcher{constructor(e=Texture.DEFAULT_IMAGE,t=Texture.DEFAULT_MAPPING,i=1001,r=1001,n=1006,s=1008,a=1023,o=1009,l=Texture.DEFAULT_ANISOTROPY,h=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Wd++}),this.uuid=_o(),this.name="",this.source=new Source(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=r,this.magFilter=n,this.minFilter=s,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=h,this.userData={},this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case al:e.x=e.x-Math.floor(e.x);break;case ol:e.x=e.x<0?0:1;break;case ll:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case al:e.y=e.y-Math.floor(e.y);break;case ol:e.y=e.y<0?0:1;break;case ll:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Texture.DEFAULT_IMAGE=null,Texture.DEFAULT_MAPPING=300,Texture.DEFAULT_ANISOTROPY=1;class RenderTarget extends EventDispatcher{constructor(e=1,t=1,i={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t);const r={width:e,height:t,depth:1};i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:ul,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},i);const n=new Texture(r,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace);n.flipY=!1,n.generateMipmaps=i.generateMipmaps,n.internalFormat=i.internalFormat,this.textures=[];const s=i.count;for(let e=0;e<s;e++)this.textures[e]=n.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=i.depthTexture,this.samples=i.samples}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let r=0,n=this.textures.length;r<n;r++)this.textures[r].image.width=e,this.textures[r].image.height=t,this.textures[r].image.depth=i;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,i=e.textures.length;t<i;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const i=Object.assign({},e.textures[t].image);this.textures[t].source=new Source(i)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class WebGLRenderTarget extends RenderTarget{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class Camera extends Object3D{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.projectionMatrixInverse=new Matrix4,this.coordinateSystem=Mh}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const qd=new Vector3,jd=new Vector2,Kd=new Vector2;class PerspectiveCamera extends Camera{constructor(e=50,t=1,i=.1,r=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=r,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*yo*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*vo*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*yo*Math.atan(Math.tan(.5*vo*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,i){qd.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(qd.x,qd.y).multiplyScalar(-e/qd.z),qd.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(qd.x,qd.y).multiplyScalar(-e/qd.z)}getViewSize(e,t){return this.getViewBounds(e,jd,Kd),t.subVectors(Kd,jd)}setViewOffset(e,t,i,r,n,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=r,this.view.width=n,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*vo*this.fov)/this.zoom,i=2*t,r=this.aspect*i,n=-.5*r;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,a=s.fullHeight;n+=s.offsetX*r/e,t-=s.offsetY*i/a,r*=s.width/e,i*=s.height/a}const a=this.filmOffset;0!==a&&(n+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+r,t,t-i,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Yd=-90;class CubeCamera extends Object3D{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const r=new PerspectiveCamera(Yd,1,e,t);r.layers=this.layers,this.add(r);const n=new PerspectiveCamera(Yd,1,e,t);n.layers=this.layers,this.add(n);const s=new PerspectiveCamera(Yd,1,e,t);s.layers=this.layers,this.add(s);const a=new PerspectiveCamera(Yd,1,e,t);a.layers=this.layers,this.add(a);const o=new PerspectiveCamera(Yd,1,e,t);o.layers=this.layers,this.add(o);const l=new PerspectiveCamera(Yd,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[i,r,n,s,a,o]=t;for(const e of t)this.remove(e);if(e===Mh)i.up.set(0,1,0),i.lookAt(1,0,0),r.up.set(0,1,0),r.lookAt(-1,0,0),n.up.set(0,0,-1),n.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==wh)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);i.up.set(0,-1,0),i.lookAt(-1,0,0),r.up.set(0,-1,0),r.lookAt(1,0,0),n.up.set(0,0,1),n.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:r}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[n,s,a,o,l,h]=this.children,c=e.getRenderTarget(),d=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),f=e.xr.enabled;e.xr.enabled=!1;const p=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,r),e.render(t,n),e.setRenderTarget(i,1,r),e.render(t,s),e.setRenderTarget(i,2,r),e.render(t,a),e.setRenderTarget(i,3,r),e.render(t,o),e.setRenderTarget(i,4,r),e.render(t,l),i.texture.generateMipmaps=p,e.setRenderTarget(i,5,r),e.render(t,h),e.setRenderTarget(c,d,u),e.xr.enabled=f,i.texture.needsPMREMUpdate=!0}}class CubeTexture extends Texture{constructor(e,t,i,r,n,s,a,o,l,h){super(e=void 0!==e?e:[],t=void 0!==t?t:rl,i,r,n,s,a,o,l,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class WebGLCubeRenderTarget extends WebGLRenderTarget{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const i={width:e,height:e,depth:1},r=[i,i,i,i,i,i];this.texture=new CubeTexture(r,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:ul}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"varying vec3 vWorldDirection;vec3 transformDirection(in vec3 dir,in mat4 matrix){return normalize((matrix*vec4(dir,0.0)).xyz);}void main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\n}",fragmentShader:"uniform sampler2D tEquirect;varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vec3 direction=normalize(vWorldDirection);vec2 sampleUV=equirectUv(direction);gl_FragColor=texture2D(tEquirect,sampleUV);}"},r=new BoxGeometry(5,5,5),n=new ShaderMaterial({name:"CubemapFromEquirect",uniforms:Yc(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});n.uniforms.tEquirect.value=t;const s=new Mesh(r,n),a=t.minFilter;t.minFilter===pl&&(t.minFilter=ul);return new CubeCamera(1,10,this).update(e,s),t.minFilter=a,s.geometry.dispose(),s.material.dispose(),this}clear(e,t,i,r){const n=e.getRenderTarget();for(let n=0;n<6;n++)e.setRenderTarget(this,n),e.clear(t,i,r);e.setRenderTarget(n)}}function Xd(e){let t=new WeakMap;function i(e,t){return 303===t?e.mapping=rl:304===t&&(e.mapping=nl),e}function r(e){const i=e.target;i.removeEventListener("dispose",r);const n=t.get(i);void 0!==n&&(t.delete(i),n.dispose())}return{get:function(n){if(n&&n.isTexture){const s=n.mapping;if(303===s||304===s){if(t.has(n)){return i(t.get(n).texture,n.mapping)}{const s=n.image;if(s&&s.height>0){const a=new WebGLCubeRenderTarget(s.height);return a.fromEquirectangularTexture(e,n),t.set(n,a),n.addEventListener("dispose",r),i(a.texture,n.mapping)}return null}}}return n},dispose:function(){t=new WeakMap}}}class OrthographicCamera extends Camera{constructor(e=-1,t=1,i=1,r=-1,n=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=r,this.near=n,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,r,n,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=r,this.view.width=n,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let n=i-e,s=i+e,a=r+t,o=r-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=e*this.view.offsetX,s=n+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(n,s,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}const Qd=[.125,.215,.35,.446,.526,.582],Zd=20,Jd=new OrthographicCamera,eu=new Color;let tu=null,iu=0,ru=0,nu=!1;const su=(1+Math.sqrt(5))/2,au=1/su,ou=[new Vector3(-su,au,0),new Vector3(su,au,0),new Vector3(-au,0,su),new Vector3(au,0,su),new Vector3(0,su,-au),new Vector3(0,su,au),new Vector3(-1,1,-1),new Vector3(1,1,-1),new Vector3(-1,1,1),new Vector3(1,1,1)],lu=new Vector3;class PMREMGenerator{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,r=100,n={}){const{size:s=256,position:a=lu}=n;tu=this._renderer.getRenderTarget(),iu=this._renderer.getActiveCubeFace(),ru=this._renderer.getActiveMipmapLevel(),nu=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(s);const o=this._allocateTargets();return o.depthBuffer=!0,this._sceneToCubeUV(e,i,r,o,a),t>0&&this._blur(o,0,0,t),this._applyPMREM(o),this._cleanup(o),o}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=uu(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=du(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(tu,iu,ru),this._renderer.xr.enabled=nu,e.scissorTest=!1,cu(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===rl||e.mapping===nl?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),tu=this._renderer.getRenderTarget(),iu=this._renderer.getActiveCubeFace(),ru=this._renderer.getActiveMipmapLevel(),nu=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:ul,minFilter:ul,generateMipmaps:!1,type:Tl,format:Al,colorSpace:uh,depthBuffer:!1},r=hu(e,t,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=hu(e,t,i);const{_lodMax:r}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],i=[],r=[];let n=e;const s=e-4+1+Qd.length;for(let a=0;a<s;a++){const s=Math.pow(2,n);i.push(s);let o=1/s;a>e-4?o=Qd[a-e+4-1]:0===a&&(o=0),r.push(o);const l=1/(s-2),h=-l,c=1+l,d=[h,h,c,h,c,c,h,h,c,c,h,c],u=6,f=6,p=3,m=2,g=1,v=new Float32Array(p*f*u),y=new Float32Array(m*f*u),_=new Float32Array(g*f*u);for(let e=0;e<u;e++){const t=e%3*2/3-1,i=e>2?0:-1,r=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0];v.set(r,p*f*e),y.set(d,m*f*e);const n=[e,e,e,e,e,e];_.set(n,g*f*e)}const S=new BufferGeometry;S.setAttribute("position",new BufferAttribute(v,p)),S.setAttribute("uv",new BufferAttribute(y,m)),S.setAttribute("faceIndex",new BufferAttribute(_,g)),t.push(S),n>4&&n--}return{lodPlanes:t,sizeLods:i,sigmas:r}}(r)),this._blurMaterial=function(e,t,i){const r=new Float32Array(Zd),n=new Vector3(0,1,0),s=new ShaderMaterial({name:"SphericalGaussianBlur",defines:{n:Zd,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:r},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:n}},vertexShader:fu(),fragmentShader:"precision mediump float;precision mediump int;varying vec3 vOutputDirection;uniform sampler2D envMap;uniform int samples;uniform float weights[n];uniform bool latitudinal;uniform float dTheta;uniform float mipInt;uniform vec3 poleAxis;\n#define ENVMAP_TYPE_CUBE_UV\n#include <cube_uv_reflection_fragment>\nvec3 getSample(float theta,vec3 axis){float cosTheta=cos(theta);vec3 sampleDirection=vOutputDirection*cosTheta+cross(axis,vOutputDirection)*sin(theta)+axis*dot(axis,vOutputDirection)*(1.0-cosTheta);return bilinearCubeUV(envMap,sampleDirection,mipInt);}void main(){vec3 axis=latitudinal?poleAxis:cross(poleAxis,vOutputDirection);if(all(equal(axis,vec3(0.0)))){axis=vec3(vOutputDirection.z,0.0,-vOutputDirection.x);}axis=normalize(axis);gl_FragColor=vec4(0.0,0.0,0.0,1.0);gl_FragColor.rgb+=weights[0]*getSample(0.0,axis);for(int i=1;i<n;i++){if(i>=samples){break;}float theta=dTheta*float(i);gl_FragColor.rgb+=weights[i]*getSample(-1.0*theta,axis);gl_FragColor.rgb+=weights[i]*getSample(theta,axis);}}",blending:0,depthTest:!1,depthWrite:!1});return s}(r,e,t)}return r}_compileMaterial(e){const t=new Mesh(this._lodPlanes[0],e);this._renderer.compile(t,Jd)}_sceneToCubeUV(e,t,i,r,n){const s=new PerspectiveCamera(90,1,t,i),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,h=l.autoClear,c=l.toneMapping;l.getClearColor(eu),l.toneMapping=0,l.autoClear=!1;const d=new MeshBasicMaterial({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),u=new Mesh(new BoxGeometry,d);let f=!1;const p=e.background;p?p.isColor&&(d.color.copy(p),e.background=null,f=!0):(d.color.copy(eu),f=!0);for(let t=0;t<6;t++){const i=t%3;0===i?(s.up.set(0,a[t],0),s.position.set(n.x,n.y,n.z),s.lookAt(n.x+o[t],n.y,n.z)):1===i?(s.up.set(0,0,a[t]),s.position.set(n.x,n.y,n.z),s.lookAt(n.x,n.y+o[t],n.z)):(s.up.set(0,a[t],0),s.position.set(n.x,n.y,n.z),s.lookAt(n.x,n.y,n.z+o[t]));const h=this._cubeSize;cu(r,i*h,t>2?h:0,h,h),l.setRenderTarget(r),f&&l.render(u,s),l.render(e,s)}u.geometry.dispose(),u.material.dispose(),l.toneMapping=c,l.autoClear=h,e.background=p}_textureToCubeUV(e,t){const i=this._renderer,r=e.mapping===rl||e.mapping===nl;r?(null===this._cubemapMaterial&&(this._cubemapMaterial=uu()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=du());const n=r?this._cubemapMaterial:this._equirectMaterial,s=new Mesh(this._lodPlanes[0],n);n.uniforms.envMap.value=e;const a=this._cubeSize;cu(t,0,0,3*a,2*a),i.setRenderTarget(t),i.render(s,Jd)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;const r=this._lodPlanes.length;for(let t=1;t<r;t++){const i=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),n=ou[(r-t-1)%ou.length];this._blur(e,t-1,t,i,n)}t.autoClear=i}_blur(e,t,i,r,n){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,i,r,"latitudinal",n),this._halfBlur(s,e,i,i,r,"longitudinal",n)}_halfBlur(e,t,i,r,n,s,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const h=new Mesh(this._lodPlanes[r],l),c=l.uniforms,d=this._sizeLods[i]-1,u=isFinite(n)?Math.PI/(2*d):2*Math.PI/39,f=n/u,p=isFinite(n)?1+Math.floor(3*f):Zd;p>Zd&&console.warn(`sigmaRadians, ${n}, is too large and will clip, as it requested ${p} samples when the maximum is set to 20`);const m=[];let g=0;for(let e=0;e<Zd;++e){const t=e/f,i=Math.exp(-t*t/2);m.push(i),0===e?g+=i:e<p&&(g+=2*i)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;c.envMap.value=e.texture,c.samples.value=p,c.weights.value=m,c.latitudinal.value="latitudinal"===s,a&&(c.poleAxis.value=a);const{_lodMax:v}=this;c.dTheta.value=u,c.mipInt.value=v-i;const y=this._sizeLods[r];cu(t,3*y*(r>v-4?r-v+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(h,Jd)}}function hu(e,t,i){const r=new WebGLRenderTarget(e,t,i);return r.texture.mapping=sl,r.texture.name="PMREM.cubeUv",r.scissorTest=!0,r}function cu(e,t,i,r,n){e.viewport.set(t,i,r,n),e.scissor.set(t,i,r,n)}function du(){return new ShaderMaterial({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:fu(),fragmentShader:"precision mediump float;precision mediump int;varying vec3 vOutputDirection;uniform sampler2D envMap;\n#include <common>\nvoid main(){vec3 outputDirection=normalize(vOutputDirection);vec2 uv=equirectUv(outputDirection);gl_FragColor=vec4(texture2D(envMap,uv).rgb,1.0);}",blending:0,depthTest:!1,depthWrite:!1})}function uu(){return new ShaderMaterial({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:fu(),fragmentShader:"precision mediump float;precision mediump int;uniform float flipEnvMap;varying vec3 vOutputDirection;uniform samplerCube envMap;void main(){gl_FragColor=textureCube(envMap,vec3(flipEnvMap*vOutputDirection.x,vOutputDirection.yz));}",blending:0,depthTest:!1,depthWrite:!1})}function fu(){return"precision mediump float;precision mediump int;attribute float faceIndex;varying vec3 vOutputDirection;vec3 getDirection(vec2 uv,float face){uv=2.0*uv-1.0;vec3 direction=vec3(uv,1.0);if(face==0.0){direction=direction.zyx;}else if(face==1.0){direction=direction.xzy;direction.xz*=-1.0;}else if(face==2.0){direction.x*=-1.0;}else if(face==3.0){direction=direction.zyx;direction.xz*=-1.0;}else if(face==4.0){direction=direction.xzy;direction.xy*=-1.0;}else if(face==5.0){direction.z*=-1.0;}return direction;}void main(){vOutputDirection=getDirection(uv,faceIndex);gl_Position=vec4(position,1.0);}"}function pu(e){let t=new WeakMap,i=null;function r(e){const i=e.target;i.removeEventListener("dispose",r);const n=t.get(i);void 0!==n&&(t.delete(i),n.dispose())}return{get:function(n){if(n&&n.isTexture){const s=n.mapping,a=303===s||304===s,o=s===rl||s===nl;if(a||o){let s=t.get(n);const l=void 0!==s?s.texture.pmremVersion:0;if(n.isRenderTargetTexture&&n.pmremVersion!==l)return null===i&&(i=new PMREMGenerator(e)),s=a?i.fromEquirectangular(n,s):i.fromCubemap(n,s),s.texture.pmremVersion=n.pmremVersion,t.set(n,s),s.texture;if(void 0!==s)return s.texture;{const l=n.image;return a&&l&&l.height>0||o&&l&&function(e){let t=0;const i=6;for(let r=0;r<i;r++)void 0!==e[r]&&t++;return t===i}(l)?(null===i&&(i=new PMREMGenerator(e)),s=a?i.fromEquirectangular(n):i.fromCubemap(n),s.texture.pmremVersion=n.pmremVersion,t.set(n,s),n.addEventListener("dispose",r),s.texture):null}}}return n},dispose:function(){t=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function mu(e){const t={};function i(i){if(void 0!==t[i])return t[i];let r;switch(i){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=e.getExtension(i)}return t[i]=r,r}return{has:function(e){return null!==i(e)},init:function(){i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance"),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture"),i("WEBGL_render_shared_exponent")},get:function(e){const t=i(e);return null===t&&Vc("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function gu(e,t,i,r){const n={},s=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const e in o.attributes)t.remove(o.attributes[e]);o.removeEventListener("dispose",a),delete n[o.id];const l=s.get(o);l&&(t.remove(l),s.delete(o)),r.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(e){const i=[],r=e.index,n=e.attributes.position;let a=0;if(null!==r){const e=r.array;a=r.version;for(let t=0,r=e.length;t<r;t+=3){const r=e[t+0],n=e[t+1],s=e[t+2];i.push(r,n,n,s,s,r)}}else{if(void 0===n)return;{const e=n.array;a=n.version;for(let t=0,r=e.length/3-1;t<r;t+=3){const e=t+0,r=t+1,n=t+2;i.push(e,r,r,n,n,e)}}}const o=new(Uc(i)?Uint32BufferAttribute:Uint16BufferAttribute)(i,1);o.version=a;const l=s.get(e);l&&t.remove(l),s.set(e,o)}return{get:function(e,t){return!0===n[t.id]||(t.addEventListener("dispose",a),n[t.id]=!0,i.memory.geometries++),t},update:function(e){const i=e.attributes;for(const e in i)t.update(i[e],34962)},getWireframeAttribute:function(e){const t=s.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&o(e)}else o(e);return s.get(e)}}}function vu(e,t,i){let r,n,s;function a(t,a,o){0!==o&&(e.drawElementsInstanced(r,a,n,t*s,o),i.update(a,r,o))}this.setMode=function(e){r=e},this.setIndex=function(e){n=e.type,s=e.bytesPerElement},this.render=function(t,a){e.drawElements(r,a,n,t*s),i.update(a,r,1)},this.renderInstances=a,this.renderMultiDraw=function(e,s,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(r,s,0,n,e,0,a);let o=0;for(let e=0;e<a;e++)o+=s[e];i.update(o,r,1)},this.renderMultiDrawInstances=function(e,o,l,h){if(0===l)return;const c=t.get("WEBGL_multi_draw");if(null===c)for(let t=0;t<e.length;t++)a(e[t]/s,o[t],h[t]);else{c.multiDrawElementsInstancedWEBGL(r,o,0,n,e,0,h,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*h[e];i.update(t,r,1)}}}function yu(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(e,i,r){switch(t.calls++,i){case 4:t.triangles+=r*(e/3);break;case 1:t.lines+=r*(e/2);break;case 3:t.lines+=r*(e-1);break;case 2:t.lines+=r*e;break;case 0:t.points+=r*e;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}class DataArrayTexture extends Texture{constructor(e=null,t=1,i=1,r=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:r},this.magFilter=hl,this.minFilter=hl,this.wrapR=ol,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}function _u(e,t,i){const r=new WeakMap,n=new Vector4;return{update:function(s,a,o){const l=s.morphTargetInfluences,h=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,c=void 0!==h?h.length:0;let d=r.get(a);if(void 0===d||d.count!==c){void 0!==d&&d.texture.dispose();const u=void 0!==a.morphAttributes.position,f=void 0!==a.morphAttributes.normal,p=void 0!==a.morphAttributes.color,m=a.morphAttributes.position||[],g=a.morphAttributes.normal||[],v=a.morphAttributes.color||[];let y=0;!0===u&&(y=1),!0===f&&(y=2),!0===p&&(y=3);let _=a.attributes.position.count*y,S=1;_>t.maxTextureSize&&(S=Math.ceil(_/t.maxTextureSize),_=t.maxTextureSize);const b=new Float32Array(_*S*4*c),T=new DataArrayTexture(b,_,S,c);T.type=bl,T.needsUpdate=!0;const x=4*y;for(let M=0;M<c;M++){const w=m[M],A=g[M],L=v[M],C=_*S*4*M;for(let R=0;R<w.count;R++){const P=R*x;!0===u&&(n.fromBufferAttribute(w,R),b[C+P+0]=n.x,b[C+P+1]=n.y,b[C+P+2]=n.z,b[C+P+3]=0),!0===f&&(n.fromBufferAttribute(A,R),b[C+P+4]=n.x,b[C+P+5]=n.y,b[C+P+6]=n.z,b[C+P+7]=0),!0===p&&(n.fromBufferAttribute(L,R),b[C+P+8]=n.x,b[C+P+9]=n.y,b[C+P+10]=n.z,b[C+P+11]=4===L.itemSize?n.w:1)}}function E(){T.dispose(),r.delete(a),a.removeEventListener("dispose",E)}d={count:c,texture:T,size:new Vector2(_,S)},r.set(a,d),a.addEventListener("dispose",E)}if(!0===s.isInstancedMesh&&null!==s.morphTexture)o.getUniforms().setValue(e,"morphTexture",s.morphTexture,i);else{let D=0;for(let O=0;O<l.length;O++)D+=l[O];const k=a.morphTargetsRelative?1:1-D;o.getUniforms().setValue(e,"morphTargetBaseInfluence",k),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",d.texture,i),o.getUniforms().setValue(e,"morphTargetsTextureSize",d.size)}}}function Su(e,t,i,r){let n=new WeakMap;function s(e){const t=e.target;t.removeEventListener("dispose",s),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(e){const a=r.render.frame,o=e.geometry,l=t.get(e,o);if(n.get(l)!==a&&(t.update(l),n.set(l,a)),e.isInstancedMesh&&(!1===e.hasEventListener("dispose",s)&&e.addEventListener("dispose",s),n.get(e)!==a&&(i.update(e.instanceMatrix,34962),null!==e.instanceColor&&i.update(e.instanceColor,34962),n.set(e,a))),e.isSkinnedMesh){const t=e.skeleton;n.get(t)!==a&&(t.update(),n.set(t,a))}return l},dispose:function(){n=new WeakMap}}}class Data3DTexture extends Texture{constructor(e=null,t=1,i=1,r=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:r},this.magFilter=hl,this.minFilter=hl,this.wrapR=ol,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class DepthTexture extends Texture{constructor(e,t,i,r,n,s,a,o,l,h=1026){if(h!==Ll&&h!==Cl)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&h===Ll&&(i=Sl),void 0===i&&h===Cl&&(i=Ml),super(null,r,n,s,a,o,h,i,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==a?a:hl,this.minFilter=void 0!==o?o:hl,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Source(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}const bu=new Texture,Tu=new DepthTexture(1,1),xu=new DataArrayTexture,Eu=new Data3DTexture,Mu=new CubeTexture,wu=[],Au=[],Lu=new Float32Array(16),Cu=new Float32Array(9),Ru=new Float32Array(4);function Pu(e,t,i){const r=e[0];if(r<=0||r>0)return e;const n=t*i;let s=wu[n];if(void 0===s&&(s=new Float32Array(n),wu[n]=s),0!==t){r.toArray(s,0);for(let r=1,n=0;r!==t;++r)n+=i,e[r].toArray(s,n)}return s}function Iu(e,t){if(e.length!==t.length)return!1;for(let i=0,r=e.length;i<r;i++)if(e[i]!==t[i])return!1;return!0}function Du(e,t){for(let i=0,r=t.length;i<r;i++)e[i]=t[i]}function ku(e,t){let i=Au[t];void 0===i&&(i=new Int32Array(t),Au[t]=i);for(let r=0;r!==t;++r)i[r]=e.allocateTextureUnit();return i}function Ou(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function Uu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Iu(i,t))return;e.uniform2fv(this.addr,t),Du(i,t)}}function Nu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(Iu(i,t))return;e.uniform3fv(this.addr,t),Du(i,t)}}function Fu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Iu(i,t))return;e.uniform4fv(this.addr,t),Du(i,t)}}function Bu(e,t){const i=this.cache,r=t.elements;if(void 0===r){if(Iu(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),Du(i,t)}else{if(Iu(i,r))return;Ru.set(r),e.uniformMatrix2fv(this.addr,!1,Ru),Du(i,r)}}function Vu(e,t){const i=this.cache,r=t.elements;if(void 0===r){if(Iu(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),Du(i,t)}else{if(Iu(i,r))return;Cu.set(r),e.uniformMatrix3fv(this.addr,!1,Cu),Du(i,r)}}function Gu(e,t){const i=this.cache,r=t.elements;if(void 0===r){if(Iu(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),Du(i,t)}else{if(Iu(i,r))return;Lu.set(r),e.uniformMatrix4fv(this.addr,!1,Lu),Du(i,r)}}function zu(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function Hu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Iu(i,t))return;e.uniform2iv(this.addr,t),Du(i,t)}}function $u(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Iu(i,t))return;e.uniform3iv(this.addr,t),Du(i,t)}}function Wu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Iu(i,t))return;e.uniform4iv(this.addr,t),Du(i,t)}}function qu(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function ju(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Iu(i,t))return;e.uniform2uiv(this.addr,t),Du(i,t)}}function Ku(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Iu(i,t))return;e.uniform3uiv(this.addr,t),Du(i,t)}}function Yu(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Iu(i,t))return;e.uniform4uiv(this.addr,t),Du(i,t)}}function Xu(e,t,i){const r=this.cache,n=i.allocateTextureUnit();let s;r[0]!==n&&(e.uniform1i(this.addr,n),r[0]=n),35682===this.type?(Tu.compareFunction=515,s=Tu):s=bu,i.setTexture2D(t||s,n)}function Qu(e,t,i){const r=this.cache,n=i.allocateTextureUnit();r[0]!==n&&(e.uniform1i(this.addr,n),r[0]=n),i.setTexture3D(t||Eu,n)}function Zu(e,t,i){const r=this.cache,n=i.allocateTextureUnit();r[0]!==n&&(e.uniform1i(this.addr,n),r[0]=n),i.setTextureCube(t||Mu,n)}function Ju(e,t,i){const r=this.cache,n=i.allocateTextureUnit();r[0]!==n&&(e.uniform1i(this.addr,n),r[0]=n),i.setTexture2DArray(t||xu,n)}function ef(e,t){e.uniform1fv(this.addr,t)}function tf(e,t){const i=Pu(t,this.size,2);e.uniform2fv(this.addr,i)}function rf(e,t){const i=Pu(t,this.size,3);e.uniform3fv(this.addr,i)}function nf(e,t){const i=Pu(t,this.size,4);e.uniform4fv(this.addr,i)}function sf(e,t){const i=Pu(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function af(e,t){const i=Pu(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function of(e,t){const i=Pu(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function lf(e,t){e.uniform1iv(this.addr,t)}function hf(e,t){e.uniform2iv(this.addr,t)}function cf(e,t){e.uniform3iv(this.addr,t)}function df(e,t){e.uniform4iv(this.addr,t)}function uf(e,t){e.uniform1uiv(this.addr,t)}function ff(e,t){e.uniform2uiv(this.addr,t)}function pf(e,t){e.uniform3uiv(this.addr,t)}function mf(e,t){e.uniform4uiv(this.addr,t)}function gf(e,t,i){const r=this.cache,n=t.length,s=ku(i,n);Iu(r,s)||(e.uniform1iv(this.addr,s),Du(r,s));for(let e=0;e!==n;++e)i.setTexture2D(t[e]||bu,s[e])}function vf(e,t,i){const r=this.cache,n=t.length,s=ku(i,n);Iu(r,s)||(e.uniform1iv(this.addr,s),Du(r,s));for(let e=0;e!==n;++e)i.setTexture3D(t[e]||Eu,s[e])}function yf(e,t,i){const r=this.cache,n=t.length,s=ku(i,n);Iu(r,s)||(e.uniform1iv(this.addr,s),Du(r,s));for(let e=0;e!==n;++e)i.setTextureCube(t[e]||Mu,s[e])}function _f(e,t,i){const r=this.cache,n=t.length,s=ku(i,n);Iu(r,s)||(e.uniform1iv(this.addr,s),Du(r,s));for(let e=0;e!==n;++e)i.setTexture2DArray(t[e]||xu,s[e])}class SingleUniform{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Ou;case 35664:return Uu;case 35665:return Nu;case 35666:return Fu;case 35674:return Bu;case 35675:return Vu;case 35676:return Gu;case 5124:case 35670:return zu;case 35667:case 35671:return Hu;case 35668:case 35672:return $u;case 35669:case 35673:return Wu;case 5125:return qu;case 36294:return ju;case 36295:return Ku;case 36296:return Yu;case 35678:case 36198:case 36298:case 36306:case 35682:return Xu;case 35679:case 36299:case 36307:return Qu;case 35680:case 36300:case 36308:case 36293:return Zu;case 36289:case 36303:case 36311:case 36292:return Ju}}(t.type)}}class PureArrayUniform{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return ef;case 35664:return tf;case 35665:return rf;case 35666:return nf;case 35674:return sf;case 35675:return af;case 35676:return of;case 5124:case 35670:return lf;case 35667:case 35671:return hf;case 35668:case 35672:return cf;case 35669:case 35673:return df;case 5125:return uf;case 36294:return ff;case 36295:return pf;case 36296:return mf;case 35678:case 36198:case 36298:case 36306:case 35682:return gf;case 35679:case 36299:case 36307:return vf;case 35680:case 36300:case 36308:case 36293:return yf;case 36289:case 36303:case 36311:case 36292:return _f}}(t.type)}}class StructuredUniform{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,i){const r=this.seq;for(let n=0,s=r.length;n!==s;++n){const s=r[n];s.setValue(e,t[s.id],i)}}}const Sf=/(\w+)(\])?(\[|\.)?/g;function bf(e,t){e.seq.push(t),e.map[t.id]=t}function Tf(e,t,i){const r=e.name,n=r.length;for(Sf.lastIndex=0;;){const s=Sf.exec(r),a=Sf.lastIndex;let o=s[1];const l="]"===s[2],h=s[3];if(l&&(o|=0),void 0===h||"["===h&&a+2===n){bf(i,void 0===h?new SingleUniform(o,e,t):new PureArrayUniform(o,e,t));break}{let e=i.map[o];void 0===e&&(e=new StructuredUniform(o),bf(i,e)),i=e}}}class WebGLUniforms{constructor(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,35718);for(let r=0;r<i;++r){const i=e.getActiveUniform(t,r);Tf(i,e.getUniformLocation(t,i.name),this)}}setValue(e,t,i,r){const n=this.map[t];void 0!==n&&n.setValue(e,i,r)}setOptional(e,t,i){const r=t[i];void 0!==r&&this.setValue(e,i,r)}static upload(e,t,i,r){for(let n=0,s=t.length;n!==s;++n){const s=t[n],a=i[s.id];!1!==a.needsUpdate&&s.setValue(e,a.value,r)}}static seqWithValue(e,t){const i=[];for(let r=0,n=e.length;r!==n;++r){const n=e[r];n.id in t&&i.push(n)}return i}}function xf(e,t,i){const r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),r}let Ef=0;const Mf=new Matrix3;function wf(e,t,i){const r=e.getShaderParameter(t,35713),n=e.getShaderInfoLog(t).trim();if(r&&""===n)return"";const s=/ERROR: 0:(\d+)/.exec(n);if(s){const r=parseInt(s[1]);return i.toUpperCase()+"\n\n"+n+"\n\n"+function(e,t){const i=e.split("\n"),r=[],n=Math.max(t-6,0),s=Math.min(t+6,i.length);for(let e=n;e<s;e++){const n=e+1;r.push(`${n===t?">":" "} ${n}: ${i[e]}`)}return r.join("\n")}(e.getShaderSource(t),r)}return n}function Af(e,t){const i=function(e){Ph._getMatrix(Mf,Ph.workingColorSpace,e);const t=`mat3( ${Mf.elements.map(e=>e.toFixed(4))} )`;switch(Ph.getTransfer(e)){case fh:return[t,"LinearTransferOETF"];case ph:return[t,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space: ",e),[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${i[1]}( vec4( value.rgb * ${i[0]}, value.a ) );`,"}"].join("\n")}function Lf(e,t){let i;switch(t){case 1:i="Linear";break;case 2:i="Reinhard";break;case 3:i="Cineon";break;case 4:i="ACESFilmic";break;case 6:i="AgX";break;case 7:i="Neutral";break;case 5:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),i="Linear"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}const Cf=new Vector3;function Rf(){Ph.getLuminanceCoefficients(Cf);return["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${Cf.x.toFixed(4)}, ${Cf.y.toFixed(4)}, ${Cf.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function Pf(e){return""!==e}function If(e,t){const i=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Df(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const kf=/^[ \t]*#include +<([\w\d./]+)>/gm;function Of(e){return e.replace(kf,Nf)}const Uf=new Map;function Nf(e,t){let i=Pd[t];if(void 0===i){const e=Uf.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");i=Pd[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return Of(i)}const Ff=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Bf(e){return e.replace(Ff,Vf)}function Vf(e,t,i,r){let n="";for(let e=parseInt(t);e<parseInt(i);e++)n+=r.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return n}function Gf(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function zf(e,t,i,r){const n=e.getContext(),s=i.defines;let a=i.vertexShader,o=i.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(i),h=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case rl:case nl:t="ENVMAP_TYPE_CUBE";break;case sl:t="ENVMAP_TYPE_CUBE_UV"}return t}(i),c=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===nl&&(t="ENVMAP_MODE_REFRACTION");return t}(i),d=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(i),u=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const i=Math.log2(t)-2,r=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:r,maxMip:i}}(i),f=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(Pf).join("\n")}(i),p=function(e){const t=[];for(const i in e){const r=e[i];!1!==r&&t.push("#define "+i+" "+r)}return t.join("\n")}(s),m=n.createProgram();let g,v,y=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(g=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,p].filter(Pf).join("\n"),g.length>0&&(g+="\n"),v=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,p].filter(Pf).join("\n"),v.length>0&&(v+="\n")):(g=[Gf(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,p,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.batchingColor?"#define USE_BATCHING_COLOR":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.instancingMorph?"#define USE_INSTANCING_MORPH":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Pf).join("\n"),v=[Gf(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,p,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.envMap?"#define "+c:"",i.envMap?"#define "+d:"",u?"#define CUBEUV_TEXEL_WIDTH "+u.texelWidth:"",u?"#define CUBEUV_TEXEL_HEIGHT "+u.texelHeight:"",u?"#define CUBEUV_MAX_MIP "+u.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.dispersion?"#define USE_DISPERSION":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor||i.batchingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?Pd.tonemapping_pars_fragment:"",0!==i.toneMapping?Lf("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",Pd.colorspace_pars_fragment,Af("linearToOutputTexel",i.outputColorSpace),Rf(),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Pf).join("\n")),a=Of(a),a=If(a,i),a=Df(a,i),o=Of(o),o=If(o,i),o=Df(o,i),a=Bf(a),o=Bf(o),!0!==i.isRawShaderMaterial&&(y="#version 300 es\n",g=[f,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in",i.glslVersion===Eh?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===Eh?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const _=y+v+o,S=xf(n,35633,y+g+a),b=xf(n,35632,_);function T(t){if(e.debug.checkShaderErrors){const i=n.getProgramInfoLog(m).trim(),r=n.getShaderInfoLog(S).trim(),s=n.getShaderInfoLog(b).trim();let a=!0,o=!0;if(!1===n.getProgramParameter(m,35714))if(a=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(n,m,S,b);else{const e=wf(n,S,"vertex"),r=wf(n,b,"fragment");console.error("THREE.WebGLProgram: Shader Error "+n.getError()+" - VALIDATE_STATUS "+n.getProgramParameter(m,35715)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+i+"\n"+e+"\n"+r)}else""!==i?console.warn("THREE.WebGLProgram: Program Info Log:",i):""!==r&&""!==s||(o=!1);o&&(t.diagnostics={runnable:a,programLog:i,vertexShader:{log:r,prefix:g},fragmentShader:{log:s,prefix:v}})}n.deleteShader(S),n.deleteShader(b),x=new WebGLUniforms(n,m),E=function(e,t){const i={},r=e.getProgramParameter(t,35721);for(let n=0;n<r;n++){const r=e.getActiveAttrib(t,n),s=r.name;let a=1;35674===r.type&&(a=2),35675===r.type&&(a=3),35676===r.type&&(a=4),i[s]={type:r.type,location:e.getAttribLocation(t,s),locationSize:a}}return i}(n,m)}let x,E;n.attachShader(m,S),n.attachShader(m,b),void 0!==i.index0AttributeName?n.bindAttribLocation(m,0,i.index0AttributeName):!0===i.morphTargets&&n.bindAttribLocation(m,0,"position"),n.linkProgram(m),this.getUniforms=function(){return void 0===x&&T(this),x},this.getAttributes=function(){return void 0===E&&T(this),E};let M=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===M&&(M=n.getProgramParameter(m,37297)),M},this.destroy=function(){r.releaseStatesOfProgram(this),n.deleteProgram(m),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=Ef++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=S,this.fragmentShader=b,this}let Hf=0;class WebGLShaderCache{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,i=e.fragmentShader,r=this._getShaderStage(t),n=this._getShaderStage(i),s=this._getShaderCacheForMaterial(e);return!1===s.has(r)&&(s.add(r),r.usedTimes++),!1===s.has(n)&&(s.add(n),n.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let i=t.get(e);return void 0===i&&(i=new Set,t.set(e,i)),i}_getShaderStage(e){const t=this.shaderCache;let i=t.get(e);return void 0===i&&(i=new WebGLShaderStage(e),t.set(e,i)),i}}class WebGLShaderStage{constructor(e){this.id=Hf++,this.code=e,this.usedTimes=0}}function $f(e,t,i,r,n,s,a){const o=new Layers,l=new WebGLShaderCache,h=new Set,c=[],d=n.logarithmicDepthBuffer,u=n.vertexTextures;let f=n.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function m(e){return h.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(s,o,c,g,v){const y=g.fog,_=v.geometry,S=s.isMeshStandardMaterial?g.environment:null,b=(s.isMeshStandardMaterial?i:t).get(s.envMap||S),T=b&&b.mapping===sl?b.image.height:null,x=p[s.type];null!==s.precision&&(f=n.getMaxPrecision(s.precision),f!==s.precision&&console.warn("THREE.WebGLProgram.getParameters:",s.precision,"not supported, using",f,"instead."));const E=_.morphAttributes.position||_.morphAttributes.normal||_.morphAttributes.color,M=void 0!==E?E.length:0;let w,A,L,C,R=0;if(void 0!==_.morphAttributes.position&&(R=1),void 0!==_.morphAttributes.normal&&(R=2),void 0!==_.morphAttributes.color&&(R=3),x){const e=Dd[x];w=e.vertexShader,A=e.fragmentShader}else w=s.vertexShader,A=s.fragmentShader,l.update(s),L=l.getVertexShaderID(s),C=l.getFragmentShaderID(s);const P=e.getRenderTarget(),D=e.state.buffers.depth.getReversed(),k=!0===v.isInstancedMesh,O=!0===v.isBatchedMesh,U=!!s.map,N=!!s.matcap,F=!!b,B=!!s.aoMap,V=!!s.lightMap,G=!!s.bumpMap,z=!!s.normalMap,H=!!s.displacementMap,$=!!s.emissiveMap,W=!!s.metalnessMap,q=!!s.roughnessMap,j=s.anisotropy>0,K=s.clearcoat>0,Y=s.dispersion>0,X=s.iridescence>0,Q=s.sheen>0,Z=s.transmission>0,J=j&&!!s.anisotropyMap,ee=K&&!!s.clearcoatMap,te=K&&!!s.clearcoatNormalMap,ie=K&&!!s.clearcoatRoughnessMap,re=X&&!!s.iridescenceMap,ne=X&&!!s.iridescenceThicknessMap,se=Q&&!!s.sheenColorMap,ae=Q&&!!s.sheenRoughnessMap,oe=!!s.specularMap,le=!!s.specularColorMap,he=!!s.specularIntensityMap,ce=Z&&!!s.transmissionMap,de=Z&&!!s.thicknessMap,ue=!!s.gradientMap,fe=!!s.alphaMap,pe=s.alphaTest>0,me=!!s.alphaHash,ge=!!s.extensions;let ve=0;s.toneMapped&&(null!==P&&!0!==P.isXRRenderTarget||(ve=e.toneMapping));const ye={shaderID:x,shaderType:s.type,shaderName:s.name,vertexShader:w,fragmentShader:A,defines:s.defines,customVertexShaderID:L,customFragmentShaderID:C,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:f,batching:O,batchingColor:O&&null!==v._colorsTexture,instancing:k,instancingColor:k&&null!==v.instanceColor,instancingMorph:k&&null!==v.morphTexture,supportsVertexTextures:u,outputColorSpace:null===P?e.outputColorSpace:!0===P.isXRRenderTarget?P.texture.colorSpace:uh,alphaToCoverage:!!s.alphaToCoverage,map:U,matcap:N,envMap:F,envMapMode:F&&b.mapping,envMapCubeUVHeight:T,aoMap:B,lightMap:V,bumpMap:G,normalMap:z,displacementMap:u&&H,emissiveMap:$,normalMapObjectSpace:z&&1===s.normalMapType,normalMapTangentSpace:z&&0===s.normalMapType,metalnessMap:W,roughnessMap:q,anisotropy:j,anisotropyMap:J,clearcoat:K,clearcoatMap:ee,clearcoatNormalMap:te,clearcoatRoughnessMap:ie,dispersion:Y,iridescence:X,iridescenceMap:re,iridescenceThicknessMap:ne,sheen:Q,sheenColorMap:se,sheenRoughnessMap:ae,specularMap:oe,specularColorMap:le,specularIntensityMap:he,transmission:Z,transmissionMap:ce,thicknessMap:de,gradientMap:ue,opaque:!1===s.transparent&&1===s.blending&&!1===s.alphaToCoverage,alphaMap:fe,alphaTest:pe,alphaHash:me,combine:s.combine,mapUv:U&&m(s.map.channel),aoMapUv:B&&m(s.aoMap.channel),lightMapUv:V&&m(s.lightMap.channel),bumpMapUv:G&&m(s.bumpMap.channel),normalMapUv:z&&m(s.normalMap.channel),displacementMapUv:H&&m(s.displacementMap.channel),emissiveMapUv:$&&m(s.emissiveMap.channel),metalnessMapUv:W&&m(s.metalnessMap.channel),roughnessMapUv:q&&m(s.roughnessMap.channel),anisotropyMapUv:J&&m(s.anisotropyMap.channel),clearcoatMapUv:ee&&m(s.clearcoatMap.channel),clearcoatNormalMapUv:te&&m(s.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ie&&m(s.clearcoatRoughnessMap.channel),iridescenceMapUv:re&&m(s.iridescenceMap.channel),iridescenceThicknessMapUv:ne&&m(s.iridescenceThicknessMap.channel),sheenColorMapUv:se&&m(s.sheenColorMap.channel),sheenRoughnessMapUv:ae&&m(s.sheenRoughnessMap.channel),specularMapUv:oe&&m(s.specularMap.channel),specularColorMapUv:le&&m(s.specularColorMap.channel),specularIntensityMapUv:he&&m(s.specularIntensityMap.channel),transmissionMapUv:ce&&m(s.transmissionMap.channel),thicknessMapUv:de&&m(s.thicknessMap.channel),alphaMapUv:fe&&m(s.alphaMap.channel),vertexTangents:!!_.attributes.tangent&&(z||j),vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!_.attributes.color&&4===_.attributes.color.itemSize,pointsUvs:!0===v.isPoints&&!!_.attributes.uv&&(U||fe),fog:!!y,useFog:!0===s.fog,fogExp2:!!y&&y.isFogExp2,flatShading:!0===s.flatShading,sizeAttenuation:!0===s.sizeAttenuation,logarithmicDepthBuffer:d,reverseDepthBuffer:D,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==_.morphAttributes.position,morphNormals:void 0!==_.morphAttributes.normal,morphColors:void 0!==_.morphAttributes.color,morphTargetsCount:M,morphTextureStride:R,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:s.dithering,shadowMapEnabled:e.shadowMap.enabled&&c.length>0,shadowMapType:e.shadowMap.type,toneMapping:ve,decodeVideoTexture:U&&!0===s.map.isVideoTexture&&Ph.getTransfer(s.map.colorSpace)===ph,decodeVideoTextureEmissive:$&&!0===s.emissiveMap.isVideoTexture&&Ph.getTransfer(s.emissiveMap.colorSpace)===ph,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:1===s.side,useDepthPacking:s.depthPacking>=0,depthPacking:s.depthPacking||0,index0AttributeName:s.index0AttributeName,extensionClipCullDistance:ge&&!0===s.extensions.clipCullDistance&&r.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ge&&!0===s.extensions.multiDraw||O)&&r.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:r.has("KHR_parallel_shader_compile"),customProgramCacheKey:s.customProgramCacheKey()};return ye.vertexUv1s=h.has(1),ye.vertexUv2s=h.has(2),ye.vertexUv3s=h.has(3),h.clear(),ye},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.customVertexShaderID),i.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(i,t),function(e,t){o.disableAll(),t.supportsVertexTextures&&o.enable(0);t.instancing&&o.enable(1);t.instancingColor&&o.enable(2);t.instancingMorph&&o.enable(3);t.matcap&&o.enable(4);t.envMap&&o.enable(5);t.normalMapObjectSpace&&o.enable(6);t.normalMapTangentSpace&&o.enable(7);t.clearcoat&&o.enable(8);t.iridescence&&o.enable(9);t.alphaTest&&o.enable(10);t.vertexColors&&o.enable(11);t.vertexAlphas&&o.enable(12);t.vertexUv1s&&o.enable(13);t.vertexUv2s&&o.enable(14);t.vertexUv3s&&o.enable(15);t.vertexTangents&&o.enable(16);t.anisotropy&&o.enable(17);t.alphaHash&&o.enable(18);t.batching&&o.enable(19);t.dispersion&&o.enable(20);t.batchingColor&&o.enable(21);e.push(o.mask),o.disableAll(),t.fog&&o.enable(0);t.useFog&&o.enable(1);t.flatShading&&o.enable(2);t.logarithmicDepthBuffer&&o.enable(3);t.reverseDepthBuffer&&o.enable(4);t.skinning&&o.enable(5);t.morphTargets&&o.enable(6);t.morphNormals&&o.enable(7);t.morphColors&&o.enable(8);t.premultipliedAlpha&&o.enable(9);t.shadowMapEnabled&&o.enable(10);t.doubleSided&&o.enable(11);t.flipSided&&o.enable(12);t.useDepthPacking&&o.enable(13);t.dithering&&o.enable(14);t.transmission&&o.enable(15);t.sheen&&o.enable(16);t.opaque&&o.enable(17);t.pointsUvs&&o.enable(18);t.decodeVideoTexture&&o.enable(19);t.decodeVideoTextureEmissive&&o.enable(20);t.alphaToCoverage&&o.enable(21);e.push(o.mask)}(i,t),i.push(e.outputColorSpace)),i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=p[e.type];let i;if(t){const e=Dd[t];i=Zc.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let r;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(t.cacheKey===i){r=t,++r.usedTimes;break}}return void 0===r&&(r=new zf(e,i,t,s),c.push(r)),r},releaseProgram:function(e){if(0===--e.usedTimes){const t=c.indexOf(e);c[t]=c[c.length-1],c.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:c,dispose:function(){l.dispose()}}}function Wf(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,r){e.get(t)[i]=r},dispose:function(){e=new WeakMap}}}function qf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function jf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Kf(){const e=[];let t=0;const i=[],r=[],n=[];function s(i,r,n,s,a,o){let l=e[t];return void 0===l?(l={id:i.id,object:i,geometry:r,material:n,groupOrder:s,renderOrder:i.renderOrder,z:a,group:o},e[t]=l):(l.id=i.id,l.object=i,l.geometry=r,l.material=n,l.groupOrder=s,l.renderOrder=i.renderOrder,l.z=a,l.group=o),t++,l}return{opaque:i,transmissive:r,transparent:n,init:function(){t=0,i.length=0,r.length=0,n.length=0},push:function(e,t,a,o,l,h){const c=s(e,t,a,o,l,h);a.transmission>0?r.push(c):!0===a.transparent?n.push(c):i.push(c)},unshift:function(e,t,a,o,l,h){const c=s(e,t,a,o,l,h);a.transmission>0?r.unshift(c):!0===a.transparent?n.unshift(c):i.unshift(c)},finish:function(){for(let i=t,r=e.length;i<r;i++){const t=e[i];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){i.length>1&&i.sort(e||qf),r.length>1&&r.sort(t||jf),n.length>1&&n.sort(t||jf)}}}function Yf(){let e=new WeakMap;return{get:function(t,i){const r=e.get(t);let n;return void 0===r?(n=new Kf,e.set(t,[n])):i>=r.length?(n=new Kf,r.push(n)):n=r[i],n},dispose:function(){e=new WeakMap}}}function Xf(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new Vector3,color:new Color};break;case"SpotLight":i={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Vector3,color:new Color,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":i={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return e[t.id]=i,i}}}let Qf=0;function Zf(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Jf(e){const t=new Xf,i=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)r.probe.push(new Vector3);const n=new Vector3,s=new Matrix4,a=new Matrix4;return{setup:function(n){let s=0,a=0,o=0;for(let e=0;e<9;e++)r.probe[e].set(0,0,0);let l=0,h=0,c=0,d=0,u=0,f=0,p=0,m=0,g=0,v=0,y=0;n.sort(Zf);for(let e=0,_=n.length;e<_;e++){const _=n[e],S=_.color,b=_.intensity,T=_.distance,x=_.shadow&&_.shadow.map?_.shadow.map.texture:null;if(_.isAmbientLight)s+=S.r*b,a+=S.g*b,o+=S.b*b;else if(_.isLightProbe){for(let e=0;e<9;e++)r.probe[e].addScaledVector(_.sh.coefficients[e],b);y++}else if(_.isDirectionalLight){const e=t.get(_);if(e.color.copy(_.color).multiplyScalar(_.intensity),_.castShadow){const e=_.shadow,t=i.get(_);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,r.directionalShadow[l]=t,r.directionalShadowMap[l]=x,r.directionalShadowMatrix[l]=_.shadow.matrix,f++}r.directional[l]=e,l++}else if(_.isSpotLight){const e=t.get(_);e.position.setFromMatrixPosition(_.matrixWorld),e.color.copy(S).multiplyScalar(b),e.distance=T,e.coneCos=Math.cos(_.angle),e.penumbraCos=Math.cos(_.angle*(1-_.penumbra)),e.decay=_.decay,r.spot[c]=e;const n=_.shadow;if(_.map&&(r.spotLightMap[g]=_.map,g++,n.updateMatrices(_),_.castShadow&&v++),r.spotLightMatrix[c]=n.matrix,_.castShadow){const e=i.get(_);e.shadowIntensity=n.intensity,e.shadowBias=n.bias,e.shadowNormalBias=n.normalBias,e.shadowRadius=n.radius,e.shadowMapSize=n.mapSize,r.spotShadow[c]=e,r.spotShadowMap[c]=x,m++}c++}else if(_.isRectAreaLight){const e=t.get(_);e.color.copy(S).multiplyScalar(b),e.halfWidth.set(.5*_.width,0,0),e.halfHeight.set(0,.5*_.height,0),r.rectArea[d]=e,d++}else if(_.isPointLight){const e=t.get(_);if(e.color.copy(_.color).multiplyScalar(_.intensity),e.distance=_.distance,e.decay=_.decay,_.castShadow){const e=_.shadow,t=i.get(_);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,r.pointShadow[h]=t,r.pointShadowMap[h]=x,r.pointShadowMatrix[h]=_.shadow.matrix,p++}r.point[h]=e,h++}else if(_.isHemisphereLight){const e=t.get(_);e.skyColor.copy(_.color).multiplyScalar(b),e.groundColor.copy(_.groundColor).multiplyScalar(b),r.hemi[u]=e,u++}}d>0&&(!0===e.has("OES_texture_float_linear")?(r.rectAreaLTC1=Id.LTC_FLOAT_1,r.rectAreaLTC2=Id.LTC_FLOAT_2):(r.rectAreaLTC1=Id.LTC_HALF_1,r.rectAreaLTC2=Id.LTC_HALF_2)),r.ambient[0]=s,r.ambient[1]=a,r.ambient[2]=o;const _=r.hash;_.directionalLength===l&&_.pointLength===h&&_.spotLength===c&&_.rectAreaLength===d&&_.hemiLength===u&&_.numDirectionalShadows===f&&_.numPointShadows===p&&_.numSpotShadows===m&&_.numSpotMaps===g&&_.numLightProbes===y||(r.directional.length=l,r.spot.length=c,r.rectArea.length=d,r.point.length=h,r.hemi.length=u,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=p,r.pointShadowMap.length=p,r.spotShadow.length=m,r.spotShadowMap.length=m,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=p,r.spotLightMatrix.length=m+g-v,r.spotLightMap.length=g,r.numSpotLightShadowsWithMaps=v,r.numLightProbes=y,_.directionalLength=l,_.pointLength=h,_.spotLength=c,_.rectAreaLength=d,_.hemiLength=u,_.numDirectionalShadows=f,_.numPointShadows=p,_.numSpotShadows=m,_.numSpotMaps=g,_.numLightProbes=y,r.version=Qf++)},setupView:function(e,t){let i=0,o=0,l=0,h=0,c=0;const d=t.matrixWorldInverse;for(let t=0,u=e.length;t<u;t++){const u=e[t];if(u.isDirectionalLight){const e=r.directional[i];e.direction.setFromMatrixPosition(u.matrixWorld),n.setFromMatrixPosition(u.target.matrixWorld),e.direction.sub(n),e.direction.transformDirection(d),i++}else if(u.isSpotLight){const e=r.spot[l];e.position.setFromMatrixPosition(u.matrixWorld),e.position.applyMatrix4(d),e.direction.setFromMatrixPosition(u.matrixWorld),n.setFromMatrixPosition(u.target.matrixWorld),e.direction.sub(n),e.direction.transformDirection(d),l++}else if(u.isRectAreaLight){const e=r.rectArea[h];e.position.setFromMatrixPosition(u.matrixWorld),e.position.applyMatrix4(d),a.identity(),s.copy(u.matrixWorld),s.premultiply(d),a.extractRotation(s),e.halfWidth.set(.5*u.width,0,0),e.halfHeight.set(0,.5*u.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),h++}else if(u.isPointLight){const e=r.point[o];e.position.setFromMatrixPosition(u.matrixWorld),e.position.applyMatrix4(d),o++}else if(u.isHemisphereLight){const e=r.hemi[c];e.direction.setFromMatrixPosition(u.matrixWorld),e.direction.transformDirection(d),c++}}},state:r}}function ep(e){const t=new Jf(e),i=[],r=[];const n={lightsArray:i,shadowsArray:r,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){n.camera=e,i.length=0,r.length=0},state:n,setupLights:function(){t.setup(i)},setupLightsView:function(e){t.setupView(i,e)},pushLight:function(e){i.push(e)},pushShadow:function(e){r.push(e)}}}function tp(e){let t=new WeakMap;return{get:function(i,r=0){const n=t.get(i);let s;return void 0===n?(s=new ep(e),t.set(i,[s])):r>=n.length?(s=new ep(e),n.push(s)):s=n[r],s},dispose:function(){t=new WeakMap}}}class MeshDepthMaterial extends Material{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class MeshDistanceMaterial extends Material{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function ip(e,t,i){let r=new Frustum;const n=new Vector2,s=new Vector2,a=new Vector4,o=new MeshDepthMaterial({depthPacking:3201}),l=new MeshDistanceMaterial,h={},c=i.maxTextureSize,d={[Lo]:1,[Co]:0,[Ro]:2},u=new ShaderMaterial({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Vector2},radius:{value:4}},vertexShader:"void main(){gl_Position=vec4(position,1.0);}",fragmentShader:"uniform sampler2D shadow_pass;uniform vec2 resolution;uniform float radius;\n#include <packing>\nvoid main(){const float samples=float(VSM_SAMPLES);float mean=0.0;float squared_mean=0.0;float uvStride=samples<=1.0?0.0:2.0/(samples-1.0);float uvStart=samples<=1.0?0.0:-1.0;for(float i=0.0;i<samples;i++){float uvOffset=uvStart+i*uvStride;\n#ifdef HORIZONTAL_PASS\nvec2 distribution=unpackRGBATo2Half(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(uvOffset,0.0)*radius)/resolution));mean+=distribution.x;squared_mean+=distribution.y*distribution.y+distribution.x*distribution.x;\n#else\nfloat depth=unpackRGBAToDepth(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(0.0,uvOffset)*radius)/resolution));mean+=depth;squared_mean+=depth*depth;\n#endif\n}mean=mean/samples;squared_mean=squared_mean/samples;float std_dev=sqrt(squared_mean-mean*mean);gl_FragColor=pack2HalfToRGBA(vec2(mean,std_dev));}"}),f=u.clone();f.defines.HORIZONTAL_PASS=1;const p=new BufferGeometry;p.setAttribute("position",new BufferAttribute(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new Mesh(p,u),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let v=this.type;function y(i,r){const s=t.update(m);u.defines.VSM_SAMPLES!==i.blurSamples&&(u.defines.VSM_SAMPLES=i.blurSamples,f.defines.VSM_SAMPLES=i.blurSamples,u.needsUpdate=!0,f.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new WebGLRenderTarget(n.x,n.y)),u.uniforms.shadow_pass.value=i.map.texture,u.uniforms.resolution.value=i.mapSize,u.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(r,null,s,u,m,null),f.uniforms.shadow_pass.value=i.mapPass.texture,f.uniforms.resolution.value=i.mapSize,f.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(r,null,s,f,m,null)}function _(t,i,r,n){let s=null;const a=!0===r.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==a)s=a;else if(s=!0===r.isPointLight?l:o,e.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0){const e=s.uuid,t=i.uuid;let r=h[e];void 0===r&&(r={},h[e]=r);let n=r[t];void 0===n&&(n=s.clone(),r[t]=n,i.addEventListener("dispose",b)),s=n}if(s.visible=i.visible,s.wireframe=i.wireframe,s.side=3===n?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:d[i.side],s.alphaMap=i.alphaMap,s.alphaTest=i.alphaTest,s.map=i.map,s.clipShadows=i.clipShadows,s.clippingPlanes=i.clippingPlanes,s.clipIntersection=i.clipIntersection,s.displacementMap=i.displacementMap,s.displacementScale=i.displacementScale,s.displacementBias=i.displacementBias,s.wireframeLinewidth=i.wireframeLinewidth,s.linewidth=i.linewidth,!0===r.isPointLight&&!0===s.isMeshDistanceMaterial){e.properties.get(s).light=r}return s}function S(i,n,s,a,o){if(!1===i.visible)return;if(i.layers.test(n.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||r.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const r=t.update(i),l=i.material;if(Array.isArray(l)){const t=r.groups;for(let h=0,c=t.length;h<c;h++){const c=t[h],d=l[c.materialIndex];if(d&&d.visible){const t=_(i,d,a,o);i.onBeforeShadow(e,i,n,s,r,t,c),e.renderBufferDirect(s,null,r,t,i,c),i.onAfterShadow(e,i,n,s,r,t,c)}}}else if(l.visible){const t=_(i,l,a,o);i.onBeforeShadow(e,i,n,s,r,t,null),e.renderBufferDirect(s,null,r,t,i,null),i.onAfterShadow(e,i,n,s,r,t,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)S(l[e],n,s,a,o)}function b(e){e.target.removeEventListener("dispose",b);for(const t in h){const i=h[t],r=e.target.uuid;if(r in i){i[r].dispose(),delete i[r]}}}this.render=function(t,i,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),h=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),u=e.state;u.setBlending(0),u.buffers.color.setClear(1,1,1,1),u.buffers.depth.setTest(!0),u.setScissorTest(!1);const f=3!==v&&3===this.type,p=3===v&&3!==this.type;for(let l=0,h=t.length;l<h;l++){const h=t[l],d=h.shadow;if(void 0===d){console.warn("THREE.WebGLShadowMap:",h,"has no shadow.");continue}if(!1===d.autoUpdate&&!1===d.needsUpdate)continue;n.copy(d.mapSize);const m=d.getFrameExtents();if(n.multiply(m),s.copy(d.mapSize),(n.x>c||n.y>c)&&(n.x>c&&(s.x=Math.floor(c/m.x),n.x=s.x*m.x,d.mapSize.x=s.x),n.y>c&&(s.y=Math.floor(c/m.y),n.y=s.y*m.y,d.mapSize.y=s.y)),null===d.map||!0===f||!0===p){const e=3!==this.type?{minFilter:hl,magFilter:hl}:{};null!==d.map&&d.map.dispose(),d.map=new WebGLRenderTarget(n.x,n.y,e),d.map.texture.name=h.name+".shadowMap",d.camera.updateProjectionMatrix()}e.setRenderTarget(d.map),e.clear();const g=d.getViewportCount();for(let e=0;e<g;e++){const t=d.getViewport(e);a.set(s.x*t.x,s.y*t.y,s.x*t.z,s.y*t.w),u.viewport(a),d.updateMatrices(h,e),r=d.getFrustum(),S(i,o,d.camera,h,this.type)}!0!==d.isPointLightShadow&&3===this.type&&y(d,o),d.needsUpdate=!1}v=this.type,g.needsUpdate=!1,e.setRenderTarget(l,h,d)}}const rp={[Yo]:1,[Qo]:6,[Jo]:7,[Zo]:5,[Xo]:0,[tl]:2,[il]:4,[el]:3};function np(e,t){const i=new function(){let t=!1;const i=new Vector4;let r=null;const n=new Vector4(0,0,0,0);return{setMask:function(i){r===i||t||(e.colorMask(i,i,i,i),r=i)},setLocked:function(e){t=e},setClear:function(t,r,s,a,o){!0===o&&(t*=a,r*=a,s*=a),i.set(t,r,s,a),!1===n.equals(i)&&(e.clearColor(t,r,s,a),n.copy(i))},reset:function(){t=!1,r=null,n.set(-1,0,0,0)}}},r=new function(){let i=!1,r=!1,n=null,s=null,a=null;return{setReversed:function(e){if(r!==e){const e=t.get("EXT_clip_control");r?e.clipControlEXT(e.LOWER_LEFT_EXT,e.ZERO_TO_ONE_EXT):e.clipControlEXT(e.LOWER_LEFT_EXT,e.NEGATIVE_ONE_TO_ONE_EXT);const i=a;a=null,this.setClear(i)}r=e},getReversed:function(){return r},setTest:function(e){e?G(2929):z(2929)},setMask:function(t){n===t||i||(e.depthMask(t),n=t)},setFunc:function(t){if(r&&(t=rp[t]),s!==t){switch(t){case 0:e.depthFunc(512);break;case 1:e.depthFunc(519);break;case 2:e.depthFunc(513);break;case 3:default:e.depthFunc(515);break;case 4:e.depthFunc(514);break;case 5:e.depthFunc(518);break;case 6:e.depthFunc(516);break;case 7:e.depthFunc(517)}s=t}},setLocked:function(e){i=e},setClear:function(t){a!==t&&(r&&(t=1-t),e.clearDepth(t),a=t)},reset:function(){i=!1,n=null,s=null,a=null,r=!1}}},n=new function(){let t=!1,i=null,r=null,n=null,s=null,a=null,o=null,l=null,h=null;return{setTest:function(e){t||(e?G(2960):z(2960))},setMask:function(r){i===r||t||(e.stencilMask(r),i=r)},setFunc:function(t,i,a){r===t&&n===i&&s===a||(e.stencilFunc(t,i,a),r=t,n=i,s=a)},setOp:function(t,i,r){a===t&&o===i&&l===r||(e.stencilOp(t,i,r),a=t,o=i,l=r)},setLocked:function(e){t=e},setClear:function(t){h!==t&&(e.clearStencil(t),h=t)},reset:function(){t=!1,i=null,r=null,n=null,s=null,a=null,o=null,l=null,h=null}}},s=new WeakMap,a=new WeakMap;let o={},l={},h=new WeakMap,c=[],d=null,u=!1,f=null,p=null,m=null,g=null,v=null,y=null,_=null,S=new Color(0,0,0),b=0,T=!1,x=null,E=null,M=null,w=null,A=null;const L=e.getParameter(35661);let C=!1,R=0;const P=e.getParameter(7938);-1!==P.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(P)[1]),C=R>=1):-1!==P.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(P)[1]),C=R>=2);let D=null,k={};const O=e.getParameter(3088),U=e.getParameter(2978),N=(new Vector4).fromArray(O),F=(new Vector4).fromArray(U);function B(t,i,r,n){const s=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,10241,9728),e.texParameteri(t,10240,9728);for(let a=0;a<r;a++)32879===t||35866===t?e.texImage3D(i,0,6408,1,1,n,0,6408,5121,s):e.texImage2D(i+a,0,6408,1,1,0,6408,5121,s);return a}const V={};function G(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function z(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}V[3553]=B(3553,3553,1),V[34067]=B(34067,34069,6),V[35866]=B(35866,35866,1,1),V[32879]=B(32879,32879,1,1),i.setClear(0,0,0,1),r.setClear(1),n.setClear(0),G(2929),r.setFunc(3),q(!1),j(1),G(2884),W(0);const H={[Po]:32774,[Io]:32778,[Do]:32779,103:32775,104:32776},$={[ko]:0,[Oo]:1,[Uo]:768,[Fo]:770,[$o]:776,[zo]:774,[Vo]:772,[No]:769,[Bo]:771,[Ho]:775,[Go]:773,[Wo]:32769,[qo]:32770,[jo]:32771,[Ko]:32772};function W(t,i,r,n,s,a,o,l,h,c){if(0!==t){if(!1===u&&(G(3042),u=!0),5===t)s=s||i,a=a||r,o=o||n,i===p&&s===v||(e.blendEquationSeparate(H[i],H[s]),p=i,v=s),r===m&&n===g&&a===y&&o===_||(e.blendFuncSeparate($[r],$[n],$[a],$[o]),m=r,g=n,y=a,_=o),!1!==l.equals(S)&&h===b||(e.blendColor(l.r,l.g,l.b,h),S.copy(l),b=h),f=t,T=!1;else if(t!==f||c!==T){if(p===Po&&v===Po||(e.blendEquation(32774),p=Po,v=Po),c)switch(t){case 1:e.blendFuncSeparate(1,771,1,771);break;case 2:e.blendFunc(1,1);break;case 3:e.blendFuncSeparate(0,769,0,1);break;case 4:e.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(770,771,1,771);break;case 2:e.blendFunc(770,1);break;case 3:e.blendFuncSeparate(0,769,0,1);break;case 4:e.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}m=null,g=null,y=null,_=null,S.set(0,0,0),b=0,f=t,T=c}}else!0===u&&(z(3042),u=!1)}function q(t){x!==t&&(t?e.frontFace(2304):e.frontFace(2305),x=t)}function j(t){0!==t?(G(2884),t!==E&&(1===t?e.cullFace(1029):2===t?e.cullFace(1028):e.cullFace(1032))):z(2884),E=t}function K(t,i,r){t?(G(32823),w===i&&A===r||(e.polygonOffset(i,r),w=i,A=r)):z(32823)}return{buffers:{color:i,depth:r,stencil:n},enable:G,disable:z,bindFramebuffer:function(t,i){return l[t]!==i&&(e.bindFramebuffer(t,i),l[t]=i,36009===t&&(l[36160]=i),36160===t&&(l[36009]=i),!0)},drawBuffers:function(t,i){let r=c,n=!1;if(t){r=h.get(i),void 0===r&&(r=[],h.set(i,r));const e=t.textures;if(r.length!==e.length||36064!==r[0]){for(let t=0,i=e.length;t<i;t++)r[t]=36064+t;r.length=e.length,n=!0}}else 1029!==r[0]&&(r[0]=1029,n=!0);n&&e.drawBuffers(r)},useProgram:function(t){return d!==t&&(e.useProgram(t),d=t,!0)},setBlending:W,setMaterial:function(e,t){2===e.side?z(2884):G(2884);let s=1===e.side;t&&(s=!s),q(s),1===e.blending&&!1===e.transparent?W(0):W(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.blendColor,e.blendAlpha,e.premultipliedAlpha),r.setFunc(e.depthFunc),r.setTest(e.depthTest),r.setMask(e.depthWrite),i.setMask(e.colorWrite);const a=e.stencilWrite;n.setTest(a),a&&(n.setMask(e.stencilWriteMask),n.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),n.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),K(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?G(32926):z(32926)},setFlipSided:q,setCullFace:j,setLineWidth:function(t){t!==M&&(C&&e.lineWidth(t),M=t)},setPolygonOffset:K,setScissorTest:function(e){e?G(3089):z(3089)},activeTexture:function(t){void 0===t&&(t=33984+L-1),D!==t&&(e.activeTexture(t),D=t)},bindTexture:function(t,i,r){void 0===r&&(r=null===D?33984+L-1:D);let n=k[r];void 0===n&&(n={type:void 0,texture:void 0},k[r]=n),n.type===t&&n.texture===i||(D!==r&&(e.activeTexture(r),D=r),e.bindTexture(t,i||V[t]),n.type=t,n.texture=i)},unbindTexture:function(){const t=k[D];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(t,i){let r=a.get(i);void 0===r&&(r=new WeakMap,a.set(i,r));let n=r.get(t);void 0===n&&(n=e.getUniformBlockIndex(i,t.name),r.set(t,n))},uniformBlockBinding:function(t,i){const r=a.get(i).get(t);s.get(i)!==r&&(e.uniformBlockBinding(i,r,t.__bindingPointIndex),s.set(i,r))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===N.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),N.copy(t))},viewport:function(t){!1===F.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),F.copy(t))},reset:function(){e.disable(3042),e.disable(2884),e.disable(2929),e.disable(32823),e.disable(3089),e.disable(2960),e.disable(32926),e.blendEquation(32774),e.blendFunc(1,0),e.blendFuncSeparate(1,0,1,0),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(513),r.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(519,0,4294967295),e.stencilOp(7680,7680,7680),e.clearStencil(0),e.cullFace(1029),e.frontFace(2305),e.polygonOffset(0,0),e.activeTexture(33984),e.bindFramebuffer(36160,null),e.bindFramebuffer(36009,null),e.bindFramebuffer(36008,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),o={},D=null,k={},l={},h=new WeakMap,c=[],d=null,u=!1,f=null,p=null,m=null,g=null,v=null,y=null,_=null,S=new Color(0,0,0),b=0,T=!1,x=null,E=null,M=null,w=null,A=null,N.set(0,0,e.canvas.width,e.canvas.height),F.set(0,0,e.canvas.width,e.canvas.height),i.reset(),r.reset(),n.reset()}}}function sp(e,t,i,r){const n=function(e){switch(e){case ml:case gl:return{byteLength:1,components:1};case yl:case vl:case Tl:return{byteLength:2,components:1};case xl:case El:return{byteLength:2,components:4};case Sl:case _l:case bl:return{byteLength:4,components:1};case wl:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(r);switch(i){case 1021:case 1024:return e*t;case 1025:return e*t*2;case 1028:case Rl:return e*t/n.components*n.byteLength;case 1030:case Pl:return e*t*2/n.components*n.byteLength;case 1022:return e*t*3/n.components*n.byteLength;case Al:case Il:return e*t*4/n.components*n.byteLength;case Dl:case kl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Ol:case Ul:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Fl:case Vl:return Math.max(e,16)*Math.max(t,8)/4;case Nl:case Bl:return Math.max(e,8)*Math.max(t,8)/2;case Gl:case zl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Hl:case $l:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Wl:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case ql:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case jl:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case Kl:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case Yl:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Xl:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case Ql:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Zl:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Jl:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case eh:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case th:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case ih:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case rh:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case nh:case sh:case ah:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case oh:return Math.ceil(e/4)*Math.ceil(t/4)*8;case lh:case hh:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}function ap(e,t,i,r,n,s,a){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),h=new Vector2,c=new WeakMap;let d;const u=new WeakMap;let f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function p(e,t){return f?new OffscreenCanvas(e,t):Nc("canvas")}function m(e,t,i){let r=1;const n=z(e);if((n.width>i||n.height>i)&&(r=i/Math.max(n.width,n.height)),r<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const i=Math.floor(r*n.width),s=Math.floor(r*n.height);void 0===d&&(d=p(i,s));const a=t?p(i,s):d;a.width=i,a.height=s;return a.getContext("2d").drawImage(e,0,0,i,s),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+n.width+"x"+n.height+") to ("+i+"x"+s+")."),a}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+n.width+"x"+n.height+")."),e}return e}function g(e){return e.generateMipmaps}function v(t){e.generateMipmap(t)}function y(e){return e.isWebGLCubeRenderTarget?34067:e.isWebGL3DRenderTarget?32879:e.isWebGLArrayRenderTarget||e.isCompressedArrayTexture?35866:3553}function _(i,r,n,s,a=!1){if(null!==i){if(void 0!==e[i])return e[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let o=r;if(6403===r&&(5126===n&&(o=33326),5131===n&&(o=33325),5121===n&&(o=33321)),36244===r&&(5121===n&&(o=33330),5123===n&&(o=33332),5125===n&&(o=33334),5120===n&&(o=33329),5122===n&&(o=33331),5124===n&&(o=33333)),33319===r&&(5126===n&&(o=33328),5131===n&&(o=33327),5121===n&&(o=33323)),33320===r&&(5121===n&&(o=33336),5123===n&&(o=33338),5125===n&&(o=33340),5120===n&&(o=33335),5122===n&&(o=33337),5124===n&&(o=33339)),36248===r&&(5121===n&&(o=36221),5123===n&&(o=36215),5125===n&&(o=36209),5120===n&&(o=36239),5122===n&&(o=36233),5124===n&&(o=36227)),36249===r&&(5121===n&&(o=36220),5123===n&&(o=36214),5125===n&&(o=36208),5120===n&&(o=36238),5122===n&&(o=36232),5124===n&&(o=36226)),6407===r&&35902===n&&(o=35901),6408===r){const e=a?fh:Ph.getTransfer(s);5126===n&&(o=34836),5131===n&&(o=34842),5121===n&&(o=e===ph?35907:32856),32819===n&&(o=32854),32820===n&&(o=32855)}return 33325!==o&&33326!==o&&33327!==o&&33328!==o&&34842!==o&&34836!==o||t.get("EXT_color_buffer_float"),o}function S(e,t){let i;return e?null===t||t===Sl||t===Ml?i=35056:t===bl?i=36013:t===yl&&(i=35056,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===t||t===Sl||t===Ml?i=33190:t===bl?i=36012:t===yl&&(i=33189),i}function b(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==hl&&e.minFilter!==ul?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function T(e){const t=e.target;t.removeEventListener("dispose",T),function(e){const t=r.get(e);if(void 0===t.__webglInit)return;const i=e.source,n=u.get(i);if(n){const r=n[t.__cacheKey];r.usedTimes--,0===r.usedTimes&&E(e),0===Object.keys(n).length&&u.delete(i)}r.remove(e)}(t),t.isVideoTexture&&c.delete(t)}function x(t){const i=t.target;i.removeEventListener("dispose",x),function(t){const i=r.get(t);t.depthTexture&&(t.depthTexture.dispose(),r.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(i.__webglFramebuffer[t]))for(let r=0;r<i.__webglFramebuffer[t].length;r++)e.deleteFramebuffer(i.__webglFramebuffer[t][r]);else e.deleteFramebuffer(i.__webglFramebuffer[t]);i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[t])}else{if(Array.isArray(i.__webglFramebuffer))for(let t=0;t<i.__webglFramebuffer.length;t++)e.deleteFramebuffer(i.__webglFramebuffer[t]);else e.deleteFramebuffer(i.__webglFramebuffer);if(i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&e.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer)for(let t=0;t<i.__webglColorRenderbuffer.length;t++)i.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(i.__webglColorRenderbuffer[t]);i.__webglDepthRenderbuffer&&e.deleteRenderbuffer(i.__webglDepthRenderbuffer)}const n=t.textures;for(let t=0,i=n.length;t<i;t++){const i=r.get(n[t]);i.__webglTexture&&(e.deleteTexture(i.__webglTexture),a.memory.textures--),r.remove(n[t])}r.remove(t)}(i)}function E(t){const i=r.get(t);e.deleteTexture(i.__webglTexture);const n=t.source;delete u.get(n)[i.__cacheKey],a.memory.textures--}let M=0;function w(e,t){const n=r.get(e);if(e.isVideoTexture&&function(e){const t=a.render.frame;c.get(e)!==t&&(c.set(e,t),e.update())}(e),!1===e.isRenderTargetTexture&&e.version>0&&n.__version!==e.version){const i=e.image;if(null===i)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==i.complete)return void D(n,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.bindTexture(3553,n.__webglTexture,33984+t)}const A={[al]:10497,[ol]:33071,[ll]:33648},L={[hl]:9728,[cl]:9984,[dl]:9986,[ul]:9729,[fl]:9985,[pl]:9987},C={[gh]:512,[xh]:519,[vh]:513,[_h]:515,[yh]:514,[Th]:518,[Sh]:516,[bh]:517};function R(i,s){if(s.type!==bl||!1!==t.has("OES_texture_float_linear")||s.magFilter!==ul&&s.magFilter!==fl&&s.magFilter!==dl&&s.magFilter!==pl&&s.minFilter!==ul&&s.minFilter!==fl&&s.minFilter!==dl&&s.minFilter!==pl||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(i,10242,A[s.wrapS]),e.texParameteri(i,10243,A[s.wrapT]),32879!==i&&35866!==i||e.texParameteri(i,32882,A[s.wrapR]),e.texParameteri(i,10240,L[s.magFilter]),e.texParameteri(i,10241,L[s.minFilter]),s.compareFunction&&(e.texParameteri(i,34892,34894),e.texParameteri(i,34893,C[s.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(s.magFilter===hl)return;if(s.minFilter!==dl&&s.minFilter!==pl)return;if(s.type===bl&&!1===t.has("OES_texture_float_linear"))return;if(s.anisotropy>1||r.get(s).__currentAnisotropy){const a=t.get("EXT_texture_filter_anisotropic");e.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,n.getMaxAnisotropy())),r.get(s).__currentAnisotropy=s.anisotropy}}}function P(t,i){let r=!1;void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",T));const n=i.source;let s=u.get(n);void 0===s&&(s={},u.set(n,s));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(i);if(o!==t.__cacheKey){void 0===s[o]&&(s[o]={texture:e.createTexture(),usedTimes:0},a.memory.textures++,r=!0),s[o].usedTimes++;const n=s[t.__cacheKey];void 0!==n&&(s[t.__cacheKey].usedTimes--,0===n.usedTimes&&E(i)),t.__cacheKey=o,t.__webglTexture=s[o].texture}return r}function D(t,a,o){let l=3553;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=35866),a.isData3DTexture&&(l=32879);const h=P(t,a),c=a.source;i.bindTexture(l,t.__webglTexture,33984+o);const d=r.get(c);if(c.version!==d.__version||!0===h){i.activeTexture(33984+o);const t=Ph.getPrimaries(Ph.workingColorSpace),r=a.colorSpace===ch?null:Ph.getPrimaries(a.colorSpace),u=a.colorSpace===ch||t===r?0:37444;e.pixelStorei(37440,a.flipY),e.pixelStorei(37441,a.premultiplyAlpha),e.pixelStorei(3317,a.unpackAlignment),e.pixelStorei(37443,u);let f=m(a.image,!1,n.maxTextureSize);f=G(a,f);const p=s.convert(a.format,a.colorSpace),y=s.convert(a.type);let T,x=_(a.internalFormat,p,y,a.colorSpace,a.isVideoTexture);R(l,a);const E=a.mipmaps,M=!0!==a.isVideoTexture,w=void 0===d.__version||!0===h,A=c.dataReady,L=b(a,f);if(a.isDepthTexture)x=S(a.format===Cl,a.type),w&&(M?i.texStorage2D(3553,1,x,f.width,f.height):i.texImage2D(3553,0,x,f.width,f.height,0,p,y,null));else if(a.isDataTexture)if(E.length>0){M&&w&&i.texStorage2D(3553,L,x,E[0].width,E[0].height);for(let e=0,t=E.length;e<t;e++)T=E[e],M?A&&i.texSubImage2D(3553,e,0,0,T.width,T.height,p,y,T.data):i.texImage2D(3553,e,x,T.width,T.height,0,p,y,T.data);a.generateMipmaps=!1}else M?(w&&i.texStorage2D(3553,L,x,f.width,f.height),A&&i.texSubImage2D(3553,0,0,0,f.width,f.height,p,y,f.data)):i.texImage2D(3553,0,x,f.width,f.height,0,p,y,f.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){M&&w&&i.texStorage3D(35866,L,x,E[0].width,E[0].height,f.depth);for(let e=0,t=E.length;e<t;e++)if(T=E[e],a.format!==Al)if(null!==p)if(M){if(A)if(a.layerUpdates.size>0){const t=sp(T.width,T.height,a.format,a.type);for(const r of a.layerUpdates){const n=T.data.subarray(r*t/T.data.BYTES_PER_ELEMENT,(r+1)*t/T.data.BYTES_PER_ELEMENT);i.compressedTexSubImage3D(35866,e,0,0,r,T.width,T.height,1,p,n)}a.clearLayerUpdates()}else i.compressedTexSubImage3D(35866,e,0,0,0,T.width,T.height,f.depth,p,T.data)}else i.compressedTexImage3D(35866,e,x,T.width,T.height,f.depth,0,T.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else M?A&&i.texSubImage3D(35866,e,0,0,0,T.width,T.height,f.depth,p,y,T.data):i.texImage3D(35866,e,x,T.width,T.height,f.depth,0,p,y,T.data)}else{M&&w&&i.texStorage2D(3553,L,x,E[0].width,E[0].height);for(let e=0,t=E.length;e<t;e++)T=E[e],a.format!==Al?null!==p?M?A&&i.compressedTexSubImage2D(3553,e,0,0,T.width,T.height,p,T.data):i.compressedTexImage2D(3553,e,x,T.width,T.height,0,T.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):M?A&&i.texSubImage2D(3553,e,0,0,T.width,T.height,p,y,T.data):i.texImage2D(3553,e,x,T.width,T.height,0,p,y,T.data)}else if(a.isDataArrayTexture)if(M){if(w&&i.texStorage3D(35866,L,x,f.width,f.height,f.depth),A)if(a.layerUpdates.size>0){const e=sp(f.width,f.height,a.format,a.type);for(const t of a.layerUpdates){const r=f.data.subarray(t*e/f.data.BYTES_PER_ELEMENT,(t+1)*e/f.data.BYTES_PER_ELEMENT);i.texSubImage3D(35866,0,0,0,t,f.width,f.height,1,p,y,r)}a.clearLayerUpdates()}else i.texSubImage3D(35866,0,0,0,0,f.width,f.height,f.depth,p,y,f.data)}else i.texImage3D(35866,0,x,f.width,f.height,f.depth,0,p,y,f.data);else if(a.isData3DTexture)M?(w&&i.texStorage3D(32879,L,x,f.width,f.height,f.depth),A&&i.texSubImage3D(32879,0,0,0,0,f.width,f.height,f.depth,p,y,f.data)):i.texImage3D(32879,0,x,f.width,f.height,f.depth,0,p,y,f.data);else if(a.isFramebufferTexture){if(w)if(M)i.texStorage2D(3553,L,x,f.width,f.height);else{let e=f.width,t=f.height;for(let r=0;r<L;r++)i.texImage2D(3553,r,x,e,t,0,p,y,null),e>>=1,t>>=1}}else if(E.length>0){if(M&&w){const e=z(E[0]);i.texStorage2D(3553,L,x,e.width,e.height)}for(let e=0,t=E.length;e<t;e++)T=E[e],M?A&&i.texSubImage2D(3553,e,0,0,p,y,T):i.texImage2D(3553,e,x,p,y,T);a.generateMipmaps=!1}else if(M){if(w){const e=z(f);i.texStorage2D(3553,L,x,e.width,e.height)}A&&i.texSubImage2D(3553,0,0,0,p,y,f)}else i.texImage2D(3553,0,x,p,y,f);g(a)&&v(l),d.__version=c.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}function k(t,n,a,l,h,c){const d=s.convert(a.format,a.colorSpace),u=s.convert(a.type),f=_(a.internalFormat,d,u,a.colorSpace),p=r.get(n),m=r.get(a);if(m.__renderTarget=n,!p.__hasExternalTextures){const e=Math.max(1,n.width>>c),t=Math.max(1,n.height>>c);32879===h||35866===h?i.texImage3D(h,c,f,e,t,n.depth,0,d,u,null):i.texImage2D(h,c,f,e,t,0,d,u,null)}i.bindFramebuffer(36160,t),V(n)?o.framebufferTexture2DMultisampleEXT(36160,l,h,m.__webglTexture,0,B(n)):(3553===h||h>=34069&&h<=34074)&&e.framebufferTexture2D(36160,l,h,m.__webglTexture,c),i.bindFramebuffer(36160,null)}function O(t,i,r){if(e.bindRenderbuffer(36161,t),i.depthBuffer){const n=i.depthTexture,s=n&&n.isDepthTexture?n.type:null,a=S(i.stencilBuffer,s),l=i.stencilBuffer?33306:36096,h=B(i);V(i)?o.renderbufferStorageMultisampleEXT(36161,h,a,i.width,i.height):r?e.renderbufferStorageMultisample(36161,h,a,i.width,i.height):e.renderbufferStorage(36161,a,i.width,i.height),e.framebufferRenderbuffer(36160,l,36161,t)}else{const t=i.textures;for(let n=0;n<t.length;n++){const a=t[n],l=s.convert(a.format,a.colorSpace),h=s.convert(a.type),c=_(a.internalFormat,l,h,a.colorSpace),d=B(i);r&&!1===V(i)?e.renderbufferStorageMultisample(36161,d,c,i.width,i.height):V(i)?o.renderbufferStorageMultisampleEXT(36161,d,c,i.width,i.height):e.renderbufferStorage(36161,c,i.width,i.height)}}e.bindRenderbuffer(36161,null)}function U(t){const n=r.get(t),s=!0===t.isWebGLCubeRenderTarget;if(n.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(n.__depthDisposeCallback&&n.__depthDisposeCallback(),e){const t=()=>{delete n.__boundDepthTexture,delete n.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),n.__depthDisposeCallback=t}n.__boundDepthTexture=e}if(t.depthTexture&&!n.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,n){if(n&&n.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(36160,t),!n.depthTexture||!n.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const s=r.get(n.depthTexture);s.__renderTarget=n,s.__webglTexture&&n.depthTexture.image.width===n.width&&n.depthTexture.image.height===n.height||(n.depthTexture.image.width=n.width,n.depthTexture.image.height=n.height,n.depthTexture.needsUpdate=!0),w(n.depthTexture,0);const a=s.__webglTexture,l=B(n);if(n.depthTexture.format===Ll)V(n)?o.framebufferTexture2DMultisampleEXT(36160,36096,3553,a,0,l):e.framebufferTexture2D(36160,36096,3553,a,0);else{if(n.depthTexture.format!==Cl)throw new Error("Unknown depthTexture format");V(n)?o.framebufferTexture2DMultisampleEXT(36160,33306,3553,a,0,l):e.framebufferTexture2D(36160,33306,3553,a,0)}}(n.__webglFramebuffer,t)}else if(s){n.__webglDepthbuffer=[];for(let r=0;r<6;r++)if(i.bindFramebuffer(36160,n.__webglFramebuffer[r]),void 0===n.__webglDepthbuffer[r])n.__webglDepthbuffer[r]=e.createRenderbuffer(),O(n.__webglDepthbuffer[r],t,!1);else{const i=t.stencilBuffer?33306:36096,s=n.__webglDepthbuffer[r];e.bindRenderbuffer(36161,s),e.framebufferRenderbuffer(36160,i,36161,s)}}else if(i.bindFramebuffer(36160,n.__webglFramebuffer),void 0===n.__webglDepthbuffer)n.__webglDepthbuffer=e.createRenderbuffer(),O(n.__webglDepthbuffer,t,!1);else{const i=t.stencilBuffer?33306:36096,r=n.__webglDepthbuffer;e.bindRenderbuffer(36161,r),e.framebufferRenderbuffer(36160,i,36161,r)}i.bindFramebuffer(36160,null)}const N=[],F=[];function B(e){return Math.min(n.maxSamples,e.samples)}function V(e){const i=r.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function G(e,t){const i=e.colorSpace,r=e.format,n=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||i!==uh&&i!==ch&&(Ph.getTransfer(i)===ph?r===Al&&n===ml||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",i)),t}function z(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(h.width=e.naturalWidth||e.width,h.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(h.width=e.displayWidth,h.height=e.displayHeight):(h.width=e.width,h.height=e.height),h}this.allocateTextureUnit=function(){const e=M;return e>=n.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+n.maxTextures),M+=1,e},this.resetTextureUnits=function(){M=0},this.setTexture2D=w,this.setTexture2DArray=function(e,t){const n=r.get(e);e.version>0&&n.__version!==e.version?D(n,e,t):i.bindTexture(35866,n.__webglTexture,33984+t)},this.setTexture3D=function(e,t){const n=r.get(e);e.version>0&&n.__version!==e.version?D(n,e,t):i.bindTexture(32879,n.__webglTexture,33984+t)},this.setTextureCube=function(t,a){const o=r.get(t);t.version>0&&o.__version!==t.version?function(t,a,o){if(6!==a.image.length)return;const l=P(t,a),h=a.source;i.bindTexture(34067,t.__webglTexture,33984+o);const c=r.get(h);if(h.version!==c.__version||!0===l){i.activeTexture(33984+o);const t=Ph.getPrimaries(Ph.workingColorSpace),r=a.colorSpace===ch?null:Ph.getPrimaries(a.colorSpace),d=a.colorSpace===ch||t===r?0:37444;e.pixelStorei(37440,a.flipY),e.pixelStorei(37441,a.premultiplyAlpha),e.pixelStorei(3317,a.unpackAlignment),e.pixelStorei(37443,d);const u=a.isCompressedTexture||a.image[0].isCompressedTexture,f=a.image[0]&&a.image[0].isDataTexture,p=[];for(let e=0;e<6;e++)p[e]=u||f?f?a.image[e].image:a.image[e]:m(a.image[e],!0,n.maxCubemapSize),p[e]=G(a,p[e]);const y=p[0],S=s.convert(a.format,a.colorSpace),T=s.convert(a.type),x=_(a.internalFormat,S,T,a.colorSpace),E=!0!==a.isVideoTexture,M=void 0===c.__version||!0===l,w=h.dataReady;let A,L=b(a,y);if(R(34067,a),u){E&&M&&i.texStorage2D(34067,L,x,y.width,y.height);for(let e=0;e<6;e++){A=p[e].mipmaps;for(let t=0;t<A.length;t++){const r=A[t];a.format!==Al?null!==S?E?w&&i.compressedTexSubImage2D(34069+e,t,0,0,r.width,r.height,S,r.data):i.compressedTexImage2D(34069+e,t,x,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):E?w&&i.texSubImage2D(34069+e,t,0,0,r.width,r.height,S,T,r.data):i.texImage2D(34069+e,t,x,r.width,r.height,0,S,T,r.data)}}}else{if(A=a.mipmaps,E&&M){A.length>0&&L++;const e=z(p[0]);i.texStorage2D(34067,L,x,e.width,e.height)}for(let e=0;e<6;e++)if(f){E?w&&i.texSubImage2D(34069+e,0,0,0,p[e].width,p[e].height,S,T,p[e].data):i.texImage2D(34069+e,0,x,p[e].width,p[e].height,0,S,T,p[e].data);for(let t=0;t<A.length;t++){const r=A[t].image[e].image;E?w&&i.texSubImage2D(34069+e,t+1,0,0,r.width,r.height,S,T,r.data):i.texImage2D(34069+e,t+1,x,r.width,r.height,0,S,T,r.data)}}else{E?w&&i.texSubImage2D(34069+e,0,0,0,S,T,p[e]):i.texImage2D(34069+e,0,x,S,T,p[e]);for(let t=0;t<A.length;t++){const r=A[t];E?w&&i.texSubImage2D(34069+e,t+1,0,0,S,T,r.image[e]):i.texImage2D(34069+e,t+1,x,S,T,r.image[e])}}}g(a)&&v(34067),c.__version=h.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}(o,t,a):i.bindTexture(34067,o.__webglTexture,33984+a)},this.rebindTextures=function(e,t,i){const n=r.get(e);void 0!==t&&k(n.__webglFramebuffer,e,e.texture,36064,3553,0),void 0!==i&&U(e)},this.setupRenderTarget=function(t){const n=t.texture,o=r.get(t),l=r.get(n);t.addEventListener("dispose",x);const h=t.textures,c=!0===t.isWebGLCubeRenderTarget,d=h.length>1;if(d||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=n.version,a.memory.textures++),c){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(n.mipmaps&&n.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let i=0;i<n.mipmaps.length;i++)o.__webglFramebuffer[t][i]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(n.mipmaps&&n.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<n.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(d)for(let t=0,i=h.length;t<i;t++){const i=r.get(h[t]);void 0===i.__webglTexture&&(i.__webglTexture=e.createTexture(),a.memory.textures++)}if(t.samples>0&&!1===V(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],i.bindFramebuffer(36160,o.__webglMultisampledFramebuffer);for(let i=0;i<h.length;i++){const r=h[i];o.__webglColorRenderbuffer[i]=e.createRenderbuffer(),e.bindRenderbuffer(36161,o.__webglColorRenderbuffer[i]);const n=s.convert(r.format,r.colorSpace),a=s.convert(r.type),l=_(r.internalFormat,n,a,r.colorSpace,!0===t.isXRRenderTarget),c=B(t);e.renderbufferStorageMultisample(36161,c,l,t.width,t.height),e.framebufferRenderbuffer(36160,36064+i,36161,o.__webglColorRenderbuffer[i])}e.bindRenderbuffer(36161,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),O(o.__webglDepthRenderbuffer,t,!0)),i.bindFramebuffer(36160,null)}}if(c){i.bindTexture(34067,l.__webglTexture),R(34067,n);for(let e=0;e<6;e++)if(n.mipmaps&&n.mipmaps.length>0)for(let i=0;i<n.mipmaps.length;i++)k(o.__webglFramebuffer[e][i],t,n,36064,34069+e,i);else k(o.__webglFramebuffer[e],t,n,36064,34069+e,0);g(n)&&v(34067),i.unbindTexture()}else if(d){for(let e=0,n=h.length;e<n;e++){const n=h[e],s=r.get(n);i.bindTexture(3553,s.__webglTexture),R(3553,n),k(o.__webglFramebuffer,t,n,36064+e,3553,0),g(n)&&v(3553)}i.unbindTexture()}else{let e=3553;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(e=t.isWebGL3DRenderTarget?32879:35866),i.bindTexture(e,l.__webglTexture),R(e,n),n.mipmaps&&n.mipmaps.length>0)for(let i=0;i<n.mipmaps.length;i++)k(o.__webglFramebuffer[i],t,n,36064,e,i);else k(o.__webglFramebuffer,t,n,36064,e,0);g(n)&&v(e),i.unbindTexture()}t.depthBuffer&&U(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let n=0,s=t.length;n<s;n++){const s=t[n];if(g(s)){const t=y(e),n=r.get(s).__webglTexture;i.bindTexture(t,n),v(t),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===V(t)){const n=t.textures,s=t.width,a=t.height;let o=16384;const h=t.stencilBuffer?33306:36096,c=r.get(t),d=n.length>1;if(d)for(let t=0;t<n.length;t++)i.bindFramebuffer(36160,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064+t,36161,null),i.bindFramebuffer(36160,c.__webglFramebuffer),e.framebufferTexture2D(36009,36064+t,3553,null,0);i.bindFramebuffer(36008,c.__webglMultisampledFramebuffer),i.bindFramebuffer(36009,c.__webglFramebuffer);for(let i=0;i<n.length;i++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=256),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=1024)),d){e.framebufferRenderbuffer(36008,36064,36161,c.__webglColorRenderbuffer[i]);const t=r.get(n[i]).__webglTexture;e.framebufferTexture2D(36009,36064,3553,t,0)}e.blitFramebuffer(0,0,s,a,0,0,s,a,o,9728),!0===l&&(N.length=0,F.length=0,N.push(36064+i),t.depthBuffer&&!1===t.resolveDepthBuffer&&(N.push(h),F.push(h),e.invalidateFramebuffer(36009,F)),e.invalidateFramebuffer(36008,N))}if(i.bindFramebuffer(36008,null),i.bindFramebuffer(36009,null),d)for(let t=0;t<n.length;t++){i.bindFramebuffer(36160,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064+t,36161,c.__webglColorRenderbuffer[t]);const s=r.get(n[t]).__webglTexture;i.bindFramebuffer(36160,c.__webglFramebuffer),e.framebufferTexture2D(36009,36064+t,3553,s,0)}i.bindFramebuffer(36009,c.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const i=t.stencilBuffer?33306:36096;e.invalidateFramebuffer(36009,[i])}},this.setupDepthRenderbuffer=U,this.setupFrameBufferTexture=k,this.useMultisampledRTT=V}function op(e,t){return{convert:function(i,r=""){let n;const s=Ph.getTransfer(r);if(i===ml)return 5121;if(i===xl)return 32819;if(i===El)return 32820;if(i===wl)return 35902;if(i===gl)return 5120;if(i===vl)return 5122;if(i===yl)return 5123;if(i===_l)return 5124;if(i===Sl)return 5125;if(i===bl)return 5126;if(i===Tl)return 5131;if(1021===i)return 6406;if(1022===i)return 6407;if(i===Al)return 6408;if(1024===i)return 6409;if(1025===i)return 6410;if(i===Ll)return 6402;if(i===Cl)return 34041;if(1028===i)return 6403;if(i===Rl)return 36244;if(1030===i)return 33319;if(i===Pl)return 33320;if(i===Il)return 36249;if(i===Dl||i===kl||i===Ol||i===Ul)if(s===ph){if(n=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===n)return null;if(i===Dl)return n.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===kl)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===Ol)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===Ul)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(n=t.get("WEBGL_compressed_texture_s3tc"),null===n)return null;if(i===Dl)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===kl)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===Ol)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===Ul)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i===Nl||i===Fl||i===Bl||i===Vl){if(n=t.get("WEBGL_compressed_texture_pvrtc"),null===n)return null;if(i===Nl)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===Fl)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Bl)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===Vl)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===Gl||i===zl||i===Hl){if(n=t.get("WEBGL_compressed_texture_etc"),null===n)return null;if(i===Gl||i===zl)return s===ph?n.COMPRESSED_SRGB8_ETC2:n.COMPRESSED_RGB8_ETC2;if(i===Hl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:n.COMPRESSED_RGBA8_ETC2_EAC}if(i===$l||i===Wl||i===ql||i===jl||i===Kl||i===Yl||i===Xl||i===Ql||i===Zl||i===Jl||i===eh||i===th||i===ih||i===rh){if(n=t.get("WEBGL_compressed_texture_astc"),null===n)return null;if(i===$l)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:n.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===Wl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:n.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===ql)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:n.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===jl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:n.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===Kl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:n.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===Yl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:n.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===Xl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:n.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===Ql)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:n.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===Zl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:n.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===Jl)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:n.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===eh)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:n.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===th)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:n.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===ih)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:n.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===rh)return s===ph?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:n.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===nh||i===sh||i===ah){if(n=t.get("EXT_texture_compression_bptc"),null===n)return null;if(i===nh)return s===ph?n.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:n.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===sh)return n.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===ah)return n.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===i||i===oh||i===lh||i===hh){if(n=t.get("EXT_texture_compression_rgtc"),null===n)return null;if(i===nh)return n.COMPRESSED_RED_RGTC1_EXT;if(i===oh)return n.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===lh)return n.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===hh)return n.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===Ml?34042:void 0!==e[i]?e[i]:null}}}class ArrayCamera extends PerspectiveCamera{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e,this.index=0}}class Group extends Object3D{constructor(){super(),this.isGroup=!0,this.type="Group"}}const lp={type:"move"};class WebXRController{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Group,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Group,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Vector3,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Vector3),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Group,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Vector3,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Vector3),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const i of e.hand.values())this._getHandJoint(t,i)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,i){let r=null,n=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){s=!0;for(const r of e.hand.values()){const e=t.getJointPose(r,i),n=this._getHandJoint(l,r);null!==e&&(n.matrix.fromArray(e.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.matrixWorldNeedsUpdate=!0,n.jointRadius=e.radius),n.visible=null!==e}const r=l.joints["index-finger-tip"],n=l.joints["thumb-tip"],a=r.position.distanceTo(n.position),o=.02,h=.005;l.inputState.pinching&&a>o+h?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-h&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(n=t.getPose(e.gripSpace,i),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(r=t.getPose(e.targetRaySpace,i),null===r&&null!==n&&(r=n),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(lp)))}return null!==a&&(a.visible=null!==r),null!==o&&(o.visible=null!==n),null!==l&&(l.visible=null!==s),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const i=new Group;i.matrixAutoUpdate=!1,i.visible=!1,e.joints[t.jointName]=i,e.add(i)}return e.joints[t.jointName]}}class WebXRDepthSensing{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,i){if(null===this.texture){const r=new Texture;e.properties.get(r).__webglTexture=t.texture,t.depthNear===i.depthNear&&t.depthFar===i.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=r}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,i=new ShaderMaterial({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Mesh(new PlaneGeometry(20,20),i)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class WebXRManager extends EventDispatcher{constructor(e,t){super();const i=this;let r=null,n=1,s=null,a="local-floor",o=1,l=null,h=null,c=null,d=null,u=null,f=null;const p=new WebXRDepthSensing,m=t.getContextAttributes();let g=null,v=null;const y=[],_=[],S=new Vector2;let b=null;const T=new PerspectiveCamera;T.viewport=new Vector4;const x=new PerspectiveCamera;x.viewport=new Vector4;const E=[T,x],M=new ArrayCamera;let w=null,A=null;function L(e){const t=_.indexOf(e.inputSource);if(-1===t)return;const i=y[t];void 0!==i&&(i.update(e.inputSource,e.frame,l||s),i.dispatchEvent({type:e.type,data:e.inputSource}))}function C(){r.removeEventListener("select",L),r.removeEventListener("selectstart",L),r.removeEventListener("selectend",L),r.removeEventListener("squeeze",L),r.removeEventListener("squeezestart",L),r.removeEventListener("squeezeend",L),r.removeEventListener("end",C),r.removeEventListener("inputsourceschange",R);for(let e=0;e<y.length;e++){const t=_[e];null!==t&&(_[e]=null,y[e].disconnect(t))}w=null,A=null,p.reset(),e.setRenderTarget(g),u=null,d=null,c=null,r=null,v=null,U.stop(),i.isPresenting=!1,e.setPixelRatio(b),e.setSize(S.width,S.height,!1),i.dispatchEvent({type:"sessionend"})}function R(e){for(let t=0;t<e.removed.length;t++){const i=e.removed[t],r=_.indexOf(i);r>=0&&(_[r]=null,y[r].disconnect(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t];let r=_.indexOf(i);if(-1===r){for(let e=0;e<y.length;e++){if(e>=_.length){_.push(i),r=e;break}if(null===_[e]){_[e]=i,r=e;break}}if(-1===r)break}const n=y[r];n&&n.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=y[e];return void 0===t&&(t=new WebXRController,y[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=y[e];return void 0===t&&(t=new WebXRController,y[e]=t),t.getGripSpace()},this.getHand=function(e){let t=y[e];return void 0===t&&(t=new WebXRController,y[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){n=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){a=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||s},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==d?d:u},this.getBinding=function(){return c},this.getFrame=function(){return f},this.getSession=function(){return r},this.setSession=async function(h){if(r=h,null!==r){g=e.getRenderTarget(),r.addEventListener("select",L),r.addEventListener("selectstart",L),r.addEventListener("selectend",L),r.addEventListener("squeeze",L),r.addEventListener("squeezestart",L),r.addEventListener("squeezeend",L),r.addEventListener("end",C),r.addEventListener("inputsourceschange",R),!0!==m.xrCompatible&&await t.makeXRCompatible(),b=e.getPixelRatio(),e.getSize(S);if("undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype){let i=null,s=null,a=null;m.depth&&(a=m.stencil?35056:33190,i=m.stencil?Cl:Ll,s=m.stencil?Ml:Sl);const o={colorFormat:32856,depthFormat:a,scaleFactor:n};c=new XRWebGLBinding(r,t),d=c.createProjectionLayer(o),r.updateRenderState({layers:[d]}),e.setPixelRatio(1),e.setSize(d.textureWidth,d.textureHeight,!1),v=new WebGLRenderTarget(d.textureWidth,d.textureHeight,{format:Al,type:ml,depthTexture:new DepthTexture(d.textureWidth,d.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:m.stencil,colorSpace:e.outputColorSpace,samples:m.antialias?4:0,resolveDepthBuffer:!1===d.ignoreDepthValues,resolveStencilBuffer:!1===d.ignoreDepthValues})}else{const i={antialias:m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:n};u=new XRWebGLLayer(r,t,i),r.updateRenderState({baseLayer:u}),e.setPixelRatio(1),e.setSize(u.framebufferWidth,u.framebufferHeight,!1),v=new WebGLRenderTarget(u.framebufferWidth,u.framebufferHeight,{format:Al,type:ml,colorSpace:e.outputColorSpace,stencilBuffer:m.stencil,resolveDepthBuffer:!1===u.ignoreDepthValues,resolveStencilBuffer:!1===u.ignoreDepthValues})}v.isXRRenderTarget=!0,this.setFoveation(o),l=null,s=await r.requestReferenceSpace(a),U.setContext(r),U.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==r)return r.environmentBlendMode},this.getDepthTexture=function(){return p.getDepthTexture()};const P=new Vector3,D=new Vector3;function k(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===r)return;let t=e.near,i=e.far;null!==p.texture&&(p.depthNear>0&&(t=p.depthNear),p.depthFar>0&&(i=p.depthFar)),M.near=x.near=T.near=t,M.far=x.far=T.far=i,w===M.near&&A===M.far||(r.updateRenderState({depthNear:M.near,depthFar:M.far}),w=M.near,A=M.far),T.layers.mask=2|e.layers.mask,x.layers.mask=4|e.layers.mask,M.layers.mask=T.layers.mask|x.layers.mask;const n=e.parent,s=M.cameras;k(M,n);for(let e=0;e<s.length;e++)k(s[e],n);2===s.length?function(e,t,i){P.setFromMatrixPosition(t.matrixWorld),D.setFromMatrixPosition(i.matrixWorld);const r=P.distanceTo(D),n=t.projectionMatrix.elements,s=i.projectionMatrix.elements,a=n[14]/(n[10]-1),o=n[14]/(n[10]+1),l=(n[9]+1)/n[5],h=(n[9]-1)/n[5],c=(n[8]-1)/n[0],d=(s[8]+1)/s[0],u=a*c,f=a*d,p=r/(-c+d),m=p*-c;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(p),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===n[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+p,i=o+p,n=u-m,s=f+(r-m),c=l*o/i*t,d=h*o/i*t;e.projectionMatrix.makePerspective(n,s,c,d,t,i),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(M,T,x):M.projectionMatrix.copy(T.projectionMatrix),function(e,t,i){null===i?e.matrix.copy(t.matrixWorld):(e.matrix.copy(i.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*yo*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,M,n)},this.getCamera=function(){return M},this.getFoveation=function(){if(null!==d||null!==u)return o},this.setFoveation=function(e){o=e,null!==d&&(d.fixedFoveation=e),null!==u&&void 0!==u.fixedFoveation&&(u.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==p.texture},this.getDepthSensingMesh=function(){return p.getMesh(M)};let O=null;const U=new pc;U.setAnimationLoop(function(t,n){if(h=n.getViewerPose(l||s),f=n,null!==h){const t=h.views;null!==u&&(e.setRenderTargetFramebuffer(v,u.framebuffer),e.setRenderTarget(v));let i=!1;t.length!==M.cameras.length&&(M.cameras.length=0,i=!0);for(let r=0;r<t.length;r++){const n=t[r];let s=null;if(null!==u)s=u.getViewport(n);else{const t=c.getViewSubImage(d,n);s=t.viewport,0===r&&(e.setRenderTargetTextures(v,t.colorTexture,d.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(v))}let a=E[r];void 0===a&&(a=new PerspectiveCamera,a.layers.enable(r),a.viewport=new Vector4,E[r]=a),a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(n.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(s.x,s.y,s.width,s.height),0===r&&(M.matrix.copy(a.matrix),M.matrix.decompose(M.position,M.quaternion,M.scale)),!0===i&&M.cameras.push(a)}const n=r.enabledFeatures;if(n&&n.includes("depth-sensing")&&"gpu-optimized"==r.depthUsage&&c){const i=c.getDepthInformation(t[0]);i&&i.isValid&&i.texture&&p.init(e,i,r.renderState)}}for(let e=0;e<y.length;e++){const t=_[e],i=y[e];null!==t&&void 0!==i&&i.update(t,n,l||s)}O&&O(t,n),n.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:n}),f=null}),this.setAnimationLoop=function(e){O=e},this.dispose=function(){}}}const hp=new Euler,cp=new Matrix4;function dp(e,t){function i(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function r(e,r){e.opacity.value=r.opacity,r.color&&e.diffuse.value.copy(r.color),r.emissive&&e.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(e.map.value=r.map,i(r.map,e.mapTransform)),r.alphaMap&&(e.alphaMap.value=r.alphaMap,i(r.alphaMap,e.alphaMapTransform)),r.bumpMap&&(e.bumpMap.value=r.bumpMap,i(r.bumpMap,e.bumpMapTransform),e.bumpScale.value=r.bumpScale,1===r.side&&(e.bumpScale.value*=-1)),r.normalMap&&(e.normalMap.value=r.normalMap,i(r.normalMap,e.normalMapTransform),e.normalScale.value.copy(r.normalScale),1===r.side&&e.normalScale.value.negate()),r.displacementMap&&(e.displacementMap.value=r.displacementMap,i(r.displacementMap,e.displacementMapTransform),e.displacementScale.value=r.displacementScale,e.displacementBias.value=r.displacementBias),r.emissiveMap&&(e.emissiveMap.value=r.emissiveMap,i(r.emissiveMap,e.emissiveMapTransform)),r.specularMap&&(e.specularMap.value=r.specularMap,i(r.specularMap,e.specularMapTransform)),r.alphaTest>0&&(e.alphaTest.value=r.alphaTest);const n=t.get(r),s=n.envMap,a=n.envMapRotation;s&&(e.envMap.value=s,hp.copy(a),hp.x*=-1,hp.y*=-1,hp.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(hp.y*=-1,hp.z*=-1),e.envMapRotation.value.setFromMatrix4(cp.makeRotationFromEuler(hp)),e.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,e.reflectivity.value=r.reflectivity,e.ior.value=r.ior,e.refractionRatio.value=r.refractionRatio),r.lightMap&&(e.lightMap.value=r.lightMap,e.lightMapIntensity.value=r.lightMapIntensity,i(r.lightMap,e.lightMapTransform)),r.aoMap&&(e.aoMap.value=r.aoMap,e.aoMapIntensity.value=r.aoMapIntensity,i(r.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,i){i.color.getRGB(t.fogColor.value,Qc(e)),i.isFog?(t.fogNear.value=i.near,t.fogFar.value=i.far):i.isFogExp2&&(t.fogDensity.value=i.density)},refreshMaterialUniforms:function(e,n,s,a,o){n.isMeshBasicMaterial||n.isMeshLambertMaterial?r(e,n):n.isMeshToonMaterial?(r(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,n)):n.isMeshPhongMaterial?(r(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,n)):n.isMeshStandardMaterial?(r(e,n),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,i(t.metalnessMap,e.metalnessMapTransform));e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,i(t.roughnessMap,e.roughnessMapTransform));t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,n),n.isMeshPhysicalMaterial&&function(e,t,r){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,i(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,i(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,i(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,i(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,i(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate()));t.dispersion>0&&(e.dispersion.value=t.dispersion);t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,i(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,i(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=r.texture,e.transmissionSamplerSize.value.set(r.width,r.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,i(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,i(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,i(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,i(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,i(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,n,o)):n.isMeshMatcapMaterial?(r(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,n)):n.isMeshDepthMaterial?r(e,n):n.isMeshDistanceMaterial?(r(e,n),function(e,i){const r=t.get(i).light;e.referencePosition.value.setFromMatrixPosition(r.matrixWorld),e.nearDistance.value=r.shadow.camera.near,e.farDistance.value=r.shadow.camera.far}(e,n)):n.isMeshNormalMaterial?r(e,n):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform))}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,r,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*r,e.scale.value=.5*n,t.map&&(e.map.value=t.map,i(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,n,s,a):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function up(e,t,i,r){let n={},s={},a=[];const o=e.getParameter(35375);function l(e,t,i,r){const n=e.value,s=t+"_"+i;if(void 0===r[s])return r[s]="number"==typeof n||"boolean"==typeof n?n:n.clone(),!0;{const e=r[s];if("number"==typeof n||"boolean"==typeof n){if(e!==n)return r[s]=n,!0}else if(!1===e.equals(n))return e.copy(n),!0}return!1}function h(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function c(t){const i=t.target;i.removeEventListener("dispose",c);const r=a.indexOf(i.__bindingPointIndex);a.splice(r,1),e.deleteBuffer(n[i.id]),delete n[i.id],delete s[i.id]}return{bind:function(e,t){const i=t.program;r.uniformBlockBinding(e,i)},update:function(i,d){let u=n[i.id];void 0===u&&(!function(e){const t=e.uniforms;let i=0;const r=16;for(let e=0,n=t.length;e<n;e++){const n=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=Array.isArray(t.value)?t.value:[t.value];for(let e=0,n=s.length;e<n;e++){const n=h(s[e]),a=i%r,o=a%n.boundary,l=a+o;i+=o,0!==l&&r-l<n.storage&&(i+=r-l),t.__data=new Float32Array(n.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=i,i+=n.storage}}}const n=i%r;n>0&&(i+=r-n);e.__size=i,e.__cache={}}(i),u=function(t){const i=function(){for(let e=0;e<o;e++)if(-1===a.indexOf(e))return a.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=i;const r=e.createBuffer(),n=t.__size,s=t.usage;return e.bindBuffer(35345,r),e.bufferData(35345,n,s),e.bindBuffer(35345,null),e.bindBufferBase(35345,i,r),r}(i),n[i.id]=u,i.addEventListener("dispose",c));const f=d.program;r.updateUBOMapping(i,f);const p=t.render.frame;s[i.id]!==p&&(!function(t){const i=n[t.id],r=t.uniforms,s=t.__cache;e.bindBuffer(35345,i);for(let t=0,i=r.length;t<i;t++){const i=Array.isArray(r[t])?r[t]:[r[t]];for(let r=0,n=i.length;r<n;r++){const n=i[r];if(!0===l(n,t,r,s)){const t=n.__offset,i=Array.isArray(n.value)?n.value:[n.value];let r=0;for(let s=0;s<i.length;s++){const a=i[s],o=h(a);"number"==typeof a||"boolean"==typeof a?(n.__data[0]=a,e.bufferSubData(35345,t+r,n.__data)):a.isMatrix3?(n.__data[0]=a.elements[0],n.__data[1]=a.elements[1],n.__data[2]=a.elements[2],n.__data[3]=0,n.__data[4]=a.elements[3],n.__data[5]=a.elements[4],n.__data[6]=a.elements[5],n.__data[7]=0,n.__data[8]=a.elements[6],n.__data[9]=a.elements[7],n.__data[10]=a.elements[8],n.__data[11]=0):(a.toArray(n.__data,r),r+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(35345,t,n.__data)}}}e.bindBuffer(35345,null)}(i),s[i.id]=p)},dispose:function(){for(const t in n)e.deleteBuffer(n[t]);a=[],n={},s={}}}}class WebGLRenderer{constructor(e={}){const{canvas:t=Fc(),context:i=null,depth:r=!0,stencil:n=!1,alpha:s=!1,antialias:a=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:l=!1,powerPreference:h="default",failIfMajorPerformanceCaveat:c=!1,reverseDepthBuffer:d=!1}=e;let u;if(this.isWebGLRenderer=!0,null!==i){if("undefined"!=typeof WebGLRenderingContext&&i instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");u=i.getContextAttributes().alpha}else u=s;const f=new Uint32Array(4),p=new Int32Array(4);let m=null,g=null;const v=[],y=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=dh,this.toneMapping=0,this.toneMappingExposure=1;const _=this;let S=!1,b=0,T=0,x=null,E=-1,M=null;const w=new Vector4,A=new Vector4;let L=null;const C=new Color(0);let R=0,P=t.width,D=t.height,k=1,O=null,U=null;const N=new Vector4(0,0,P,D),F=new Vector4(0,0,P,D);let B=!1;const V=new Frustum;let G=!1,z=!1;this.transmissionResolutionScale=1;const H=new Matrix4,$=new Matrix4,W=new Vector3,q=new Vector4,j={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let K=!1;function Y(){return null===x?k:1}let X,Q,Z,J,ee,te,ie,re,ne,se,ae,oe,le,he,ce,de,ue,fe,pe,me,ge,ve,ye,_e,Se=i;function be(e,i){return t.getContext(e,i)}try{const e={alpha:!0,depth:r,stencil:n,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:h,failIfMajorPerformanceCaveat:c};if("setAttribute"in t&&t.setAttribute("data-engine","three.js r174"),t.addEventListener("webglcontextlost",Ee,!1),t.addEventListener("webglcontextrestored",Me,!1),t.addEventListener("webglcontextcreationerror",we,!1),null===Se){const t="webgl2";if(Se=be(t,e),null===Se)throw be(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function Te(){X=new mu(Se),X.init(),ve=new op(Se,X),Q=new Vd(Se,X,e,ve),Z=new np(Se,X),Q.reverseDepthBuffer&&d&&Z.buffers.depth.setReversed(!0),J=new yu(Se),ee=new Wf,te=new ap(Se,X,Z,ee,Q,ve,J),ie=new Xd(_),re=new pu(_),ne=new mc(Se),ye=new Fd(Se,ne),se=new gu(Se,ne,J,ye),ae=new Su(Se,se,ne,J),pe=new _u(Se,Q,te),de=new Gd(ee),oe=new $f(_,ie,re,X,Q,ye,de),le=new dp(_,ee),he=new Yf,ce=new tp(X),fe=new Nd(_,ie,re,Z,ae,u,o),ue=new ip(_,ae,Q),_e=new up(Se,J,Q,Z),me=new Bd(Se,X,J),ge=new vu(Se,X,J),J.programs=oe.programs,_.capabilities=Q,_.extensions=X,_.properties=ee,_.renderLists=he,_.shadowMap=ue,_.state=Z,_.info=J}Te();const xe=new WebXRManager(_,Se);function Ee(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),S=!0}function Me(){console.log("THREE.WebGLRenderer: Context Restored."),S=!1;const e=J.autoReset,t=ue.enabled,i=ue.autoUpdate,r=ue.needsUpdate,n=ue.type;Te(),J.autoReset=e,ue.enabled=t,ue.autoUpdate=i,ue.needsUpdate=r,ue.type=n}function we(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ae(e){const t=e.target;t.removeEventListener("dispose",Ae),function(e){(function(e){const t=ee.get(e).programs;void 0!==t&&(t.forEach(function(e){oe.releaseProgram(e)}),e.isShaderMaterial&&oe.releaseShaderCache(e))})(e),ee.remove(e)}(t)}function Le(e,t,i){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Fe(e,t,i),e.side=0,e.needsUpdate=!0,Fe(e,t,i),e.side=2):Fe(e,t,i)}this.xr=xe,this.getContext=function(){return Se},this.getContextAttributes=function(){return Se.getContextAttributes()},this.forceContextLoss=function(){const e=X.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=X.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return k},this.setPixelRatio=function(e){void 0!==e&&(k=e,this.setSize(P,D,!1))},this.getSize=function(e){return e.set(P,D)},this.setSize=function(e,i,r=!0){xe.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(P=e,D=i,t.width=Math.floor(e*k),t.height=Math.floor(i*k),!0===r&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(P*k,D*k).floor()},this.setDrawingBufferSize=function(e,i,r){P=e,D=i,k=r,t.width=Math.floor(e*r),t.height=Math.floor(i*r),this.setViewport(0,0,e,i)},this.getCurrentViewport=function(e){return e.copy(w)},this.getViewport=function(e){return e.copy(N)},this.setViewport=function(e,t,i,r){e.isVector4?N.set(e.x,e.y,e.z,e.w):N.set(e,t,i,r),Z.viewport(w.copy(N).multiplyScalar(k).round())},this.getScissor=function(e){return e.copy(F)},this.setScissor=function(e,t,i,r){e.isVector4?F.set(e.x,e.y,e.z,e.w):F.set(e,t,i,r),Z.scissor(A.copy(F).multiplyScalar(k).round())},this.getScissorTest=function(){return B},this.setScissorTest=function(e){Z.setScissorTest(B=e)},this.setOpaqueSort=function(e){O=e},this.setTransparentSort=function(e){U=e},this.getClearColor=function(e){return e.copy(fe.getClearColor())},this.setClearColor=function(){fe.setClearColor(...arguments)},this.getClearAlpha=function(){return fe.getClearAlpha()},this.setClearAlpha=function(){fe.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,i=!0){let r=0;if(e){let e=!1;if(null!==x){const t=x.texture.format;e=t===Il||t===Pl||t===Rl}if(e){const e=x.texture.type,t=e===ml||e===Sl||e===yl||e===Ml||e===xl||e===El,i=fe.getClearColor(),r=fe.getClearAlpha(),n=i.r,s=i.g,a=i.b;t?(f[0]=n,f[1]=s,f[2]=a,f[3]=r,Se.clearBufferuiv(6144,0,f)):(p[0]=n,p[1]=s,p[2]=a,p[3]=r,Se.clearBufferiv(6144,0,p))}else r|=16384}t&&(r|=256),i&&(r|=1024,this.state.buffers.stencil.setMask(4294967295)),Se.clear(r)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Ee,!1),t.removeEventListener("webglcontextrestored",Me,!1),t.removeEventListener("webglcontextcreationerror",we,!1),fe.dispose(),he.dispose(),ce.dispose(),ee.dispose(),ie.dispose(),re.dispose(),ae.dispose(),ye.dispose(),_e.dispose(),oe.dispose(),xe.dispose(),xe.removeEventListener("sessionstart",Re),xe.removeEventListener("sessionend",Pe),Ie.stop()},this.renderBufferDirect=function(e,t,i,r,n,s){null===t&&(t=j);const a=n.isMesh&&n.matrixWorld.determinant()<0,o=function(e,t,i,r,n){!0!==t.isScene&&(t=j);te.resetTextureUnits();const s=t.fog,a=r.isMeshStandardMaterial?t.environment:null,o=null===x?_.outputColorSpace:!0===x.isXRRenderTarget?x.texture.colorSpace:uh,l=(r.isMeshStandardMaterial?re:ie).get(r.envMap||a),h=!0===r.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,c=!!i.attributes.tangent&&(!!r.normalMap||r.anisotropy>0),d=!!i.morphAttributes.position,u=!!i.morphAttributes.normal,f=!!i.morphAttributes.color;let p=0;r.toneMapped&&(null!==x&&!0!==x.isXRRenderTarget||(p=_.toneMapping));const m=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,v=void 0!==m?m.length:0,y=ee.get(r),S=g.state.lights;if(!0===G&&(!0===z||e!==M)){const t=e===M&&r.id===E;de.setState(r,e,t)}let b=!1;r.version===y.__version?y.needsLights&&y.lightsStateVersion!==S.state.version||y.outputColorSpace!==o||n.isBatchedMesh&&!1===y.batching?b=!0:n.isBatchedMesh||!0!==y.batching?n.isBatchedMesh&&!0===y.batchingColor&&null===n.colorTexture||n.isBatchedMesh&&!1===y.batchingColor&&null!==n.colorTexture||n.isInstancedMesh&&!1===y.instancing?b=!0:n.isInstancedMesh||!0!==y.instancing?n.isSkinnedMesh&&!1===y.skinning?b=!0:n.isSkinnedMesh||!0!==y.skinning?n.isInstancedMesh&&!0===y.instancingColor&&null===n.instanceColor||n.isInstancedMesh&&!1===y.instancingColor&&null!==n.instanceColor||n.isInstancedMesh&&!0===y.instancingMorph&&null===n.morphTexture||n.isInstancedMesh&&!1===y.instancingMorph&&null!==n.morphTexture||y.envMap!==l||!0===r.fog&&y.fog!==s?b=!0:void 0===y.numClippingPlanes||y.numClippingPlanes===de.numPlanes&&y.numIntersection===de.numIntersection?(y.vertexAlphas!==h||y.vertexTangents!==c||y.morphTargets!==d||y.morphNormals!==u||y.morphColors!==f||y.toneMapping!==p||y.morphTargetsCount!==v)&&(b=!0):b=!0:b=!0:b=!0:b=!0:(b=!0,y.__version=r.version);let T=y.currentProgram;!0===b&&(T=Fe(r,t,n));let w=!1,A=!1,L=!1;const C=T.getUniforms(),R=y.uniforms;Z.useProgram(T.program)&&(w=!0,A=!0,L=!0);r.id!==E&&(E=r.id,A=!0);if(w||M!==e){Z.buffers.depth.getReversed()?(H.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(H),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(H),C.setValue(Se,"projectionMatrix",H)):C.setValue(Se,"projectionMatrix",e.projectionMatrix),C.setValue(Se,"viewMatrix",e.matrixWorldInverse);const t=C.map.cameraPosition;void 0!==t&&t.setValue(Se,W.setFromMatrixPosition(e.matrixWorld)),Q.logarithmicDepthBuffer&&C.setValue(Se,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial)&&C.setValue(Se,"isOrthographic",!0===e.isOrthographicCamera),M!==e&&(M=e,A=!0,L=!0)}if(n.isSkinnedMesh){C.setOptional(Se,n,"bindMatrix"),C.setOptional(Se,n,"bindMatrixInverse");const e=n.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),C.setValue(Se,"boneTexture",e.boneTexture,te))}n.isBatchedMesh&&(C.setOptional(Se,n,"batchingTexture"),C.setValue(Se,"batchingTexture",n._matricesTexture,te),C.setOptional(Se,n,"batchingIdTexture"),C.setValue(Se,"batchingIdTexture",n._indirectTexture,te),C.setOptional(Se,n,"batchingColorTexture"),null!==n._colorsTexture&&C.setValue(Se,"batchingColorTexture",n._colorsTexture,te));const P=i.morphAttributes;void 0===P.position&&void 0===P.normal&&void 0===P.color||pe.update(n,i,T);(A||y.receiveShadow!==n.receiveShadow)&&(y.receiveShadow=n.receiveShadow,C.setValue(Se,"receiveShadow",n.receiveShadow));r.isMeshGouraudMaterial&&null!==r.envMap&&(R.envMap.value=l,R.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);r.isMeshStandardMaterial&&null===r.envMap&&null!==t.environment&&(R.envMapIntensity.value=t.environmentIntensity);A&&(C.setValue(Se,"toneMappingExposure",_.toneMappingExposure),y.needsLights&&(U=L,(O=R).ambientLightColor.needsUpdate=U,O.lightProbe.needsUpdate=U,O.directionalLights.needsUpdate=U,O.directionalLightShadows.needsUpdate=U,O.pointLights.needsUpdate=U,O.pointLightShadows.needsUpdate=U,O.spotLights.needsUpdate=U,O.spotLightShadows.needsUpdate=U,O.rectAreaLights.needsUpdate=U,O.hemisphereLights.needsUpdate=U),s&&!0===r.fog&&le.refreshFogUniforms(R,s),le.refreshMaterialUniforms(R,r,k,D,g.state.transmissionRenderTarget[e.id]),WebGLUniforms.upload(Se,Be(y),R,te));var O,U;r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(WebGLUniforms.upload(Se,Be(y),R,te),r.uniformsNeedUpdate=!1);r.isSpriteMaterial&&C.setValue(Se,"center",n.center);if(C.setValue(Se,"modelViewMatrix",n.modelViewMatrix),C.setValue(Se,"normalMatrix",n.normalMatrix),C.setValue(Se,"modelMatrix",n.matrixWorld),r.isShaderMaterial||r.isRawShaderMaterial){const e=r.uniformsGroups;for(let t=0,i=e.length;t<i;t++){const i=e[t];_e.update(i,T),_e.bind(i,T)}}return T}(e,t,i,r,n);Z.setMaterial(r,a);let l=i.index,h=1;if(!0===r.wireframe){if(l=se.getWireframeAttribute(i),void 0===l)return;h=2}const c=i.drawRange,d=i.attributes.position;let u=c.start*h,f=(c.start+c.count)*h;null!==s&&(u=Math.max(u,s.start*h),f=Math.min(f,(s.start+s.count)*h)),null!==l?(u=Math.max(u,0),f=Math.min(f,l.count)):null!=d&&(u=Math.max(u,0),f=Math.min(f,d.count));const p=f-u;if(p<0||p===1/0)return;let m;ye.setup(n,r,o,i,l);let v=me;if(null!==l&&(m=ne.get(l),v=ge,v.setIndex(m)),n.isMesh)!0===r.wireframe?(Z.setLineWidth(r.wireframeLinewidth*Y()),v.setMode(1)):v.setMode(4);else if(n.isLine){let e=r.linewidth;void 0===e&&(e=1),Z.setLineWidth(e*Y()),n.isLineSegments?v.setMode(1):n.isLineLoop?v.setMode(2):v.setMode(3)}else n.isPoints?v.setMode(0):n.isSprite&&v.setMode(4);if(n.isBatchedMesh)if(null!==n._multiDrawInstances)Vc("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),v.renderMultiDrawInstances(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount,n._multiDrawInstances);else if(X.get("WEBGL_multi_draw"))v.renderMultiDraw(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount);else{const e=n._multiDrawStarts,t=n._multiDrawCounts,i=n._multiDrawCount,s=l?ne.get(l).bytesPerElement:1,a=ee.get(r).currentProgram.getUniforms();for(let r=0;r<i;r++)a.setValue(Se,"_gl_DrawID",r),v.render(e[r]/s,t[r])}else if(n.isInstancedMesh)v.renderInstances(u,p,n.count);else if(i.isInstancedBufferGeometry){const e=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,t=Math.min(i.instanceCount,e);v.renderInstances(u,p,t)}else v.render(u,p)},this.compile=function(e,t,i=null){null===i&&(i=e),g=ce.get(i),g.init(t),y.push(g),i.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),e!==i&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),g.setupLights();const r=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let n=0;n<t.length;n++){const s=t[n];Le(s,i,e),r.add(s)}else Le(t,i,e),r.add(t)}),g=y.pop(),r},this.compileAsync=function(e,t,i=null){const r=this.compile(e,t,i);return new Promise(t=>{function i(){r.forEach(function(e){ee.get(e).currentProgram.isReady()&&r.delete(e)}),0!==r.size?setTimeout(i,10):t(e)}null!==X.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)})};let Ce=null;function Re(){Ie.stop()}function Pe(){Ie.start()}const Ie=new pc;function De(e,t,i,r){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)g.pushLight(e),e.castShadow&&g.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||V.intersectsSprite(e)){r&&q.setFromMatrixPosition(e.matrixWorld).applyMatrix4($);const t=ae.update(e),n=e.material;n.visible&&m.push(e,t,n,i,q.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||V.intersectsObject(e))){const t=ae.update(e),n=e.material;if(r&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),q.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),q.copy(t.boundingSphere.center)),q.applyMatrix4(e.matrixWorld).applyMatrix4($)),Array.isArray(n)){const r=t.groups;for(let s=0,a=r.length;s<a;s++){const a=r[s],o=n[a.materialIndex];o&&o.visible&&m.push(e,t,o,i,q.z,a)}}else n.visible&&m.push(e,t,n,i,q.z,null)}const n=e.children;for(let e=0,s=n.length;e<s;e++)De(n[e],t,i,r)}function ke(e,t,i,r){const n=e.opaque,s=e.transmissive,a=e.transparent;g.setupLightsView(i),!0===G&&de.setGlobalState(_.clippingPlanes,i),r&&Z.viewport(w.copy(r)),n.length>0&&Ue(n,t,i),s.length>0&&Ue(s,t,i),a.length>0&&Ue(a,t,i),Z.buffers.depth.setTest(!0),Z.buffers.depth.setMask(!0),Z.buffers.color.setMask(!0),Z.setPolygonOffset(!1)}function Oe(e,t,i,r){if(null!==(!0===i.isScene?i.overrideMaterial:null))return;void 0===g.state.transmissionRenderTarget[r.id]&&(g.state.transmissionRenderTarget[r.id]=new WebGLRenderTarget(1,1,{generateMipmaps:!0,type:X.has("EXT_color_buffer_half_float")||X.has("EXT_color_buffer_float")?Tl:ml,minFilter:pl,samples:4,stencilBuffer:n,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Ph.workingColorSpace}));const s=g.state.transmissionRenderTarget[r.id],a=r.viewport||w;s.setSize(a.z*_.transmissionResolutionScale,a.w*_.transmissionResolutionScale);const o=_.getRenderTarget();_.setRenderTarget(s),_.getClearColor(C),R=_.getClearAlpha(),R<1&&_.setClearColor(16777215,.5),_.clear(),K&&fe.render(i);const l=_.toneMapping;_.toneMapping=0;const h=r.viewport;if(void 0!==r.viewport&&(r.viewport=void 0),g.setupLightsView(r),!0===G&&de.setGlobalState(_.clippingPlanes,r),Ue(e,i,r),te.updateMultisampleRenderTarget(s),te.updateRenderTargetMipmap(s),!1===X.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let n=0,s=t.length;n<s;n++){const s=t[n],a=s.object,o=s.geometry,l=s.material,h=s.group;if(2===l.side&&a.layers.test(r.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Ne(a,i,r,o,l,h),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(te.updateMultisampleRenderTarget(s),te.updateRenderTargetMipmap(s))}_.setRenderTarget(o),_.setClearColor(C,R),void 0!==h&&(r.viewport=h),_.toneMapping=l}function Ue(e,t,i){const r=!0===t.isScene?t.overrideMaterial:null;for(let n=0,s=e.length;n<s;n++){const s=e[n],a=s.object,o=s.geometry,l=null===r?s.material:r,h=s.group;a.layers.test(i.layers)&&Ne(a,t,i,o,l,h)}}function Ne(e,t,i,r,n,s){e.onBeforeRender(_,t,i,r,n,s),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),n.onBeforeRender(_,t,i,r,e,s),!0===n.transparent&&2===n.side&&!1===n.forceSinglePass?(n.side=1,n.needsUpdate=!0,_.renderBufferDirect(i,t,r,n,e,s),n.side=0,n.needsUpdate=!0,_.renderBufferDirect(i,t,r,n,e,s),n.side=2):_.renderBufferDirect(i,t,r,n,e,s),e.onAfterRender(_,t,i,r,n,s)}function Fe(e,t,i){!0!==t.isScene&&(t=j);const r=ee.get(e),n=g.state.lights,s=g.state.shadowsArray,a=n.state.version,o=oe.getParameters(e,n.state,s,t,i),l=oe.getProgramCacheKey(o);let h=r.programs;r.environment=e.isMeshStandardMaterial?t.environment:null,r.fog=t.fog,r.envMap=(e.isMeshStandardMaterial?re:ie).get(e.envMap||r.environment),r.envMapRotation=null!==r.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===h&&(e.addEventListener("dispose",Ae),h=new Map,r.programs=h);let c=h.get(l);if(void 0!==c){if(r.currentProgram===c&&r.lightsStateVersion===a)return Ve(e,o),c}else o.uniforms=oe.getUniforms(e),e.onBeforeCompile(o,_),c=oe.acquireProgram(o,l),h.set(l,c),r.uniforms=o.uniforms;const d=r.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(d.clippingPlanes=de.uniform),Ve(e,o),r.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),r.lightsStateVersion=a,r.needsLights&&(d.ambientLightColor.value=n.state.ambient,d.lightProbe.value=n.state.probe,d.directionalLights.value=n.state.directional,d.directionalLightShadows.value=n.state.directionalShadow,d.spotLights.value=n.state.spot,d.spotLightShadows.value=n.state.spotShadow,d.rectAreaLights.value=n.state.rectArea,d.ltc_1.value=n.state.rectAreaLTC1,d.ltc_2.value=n.state.rectAreaLTC2,d.pointLights.value=n.state.point,d.pointLightShadows.value=n.state.pointShadow,d.hemisphereLights.value=n.state.hemi,d.directionalShadowMap.value=n.state.directionalShadowMap,d.directionalShadowMatrix.value=n.state.directionalShadowMatrix,d.spotShadowMap.value=n.state.spotShadowMap,d.spotLightMatrix.value=n.state.spotLightMatrix,d.spotLightMap.value=n.state.spotLightMap,d.pointShadowMap.value=n.state.pointShadowMap,d.pointShadowMatrix.value=n.state.pointShadowMatrix),r.currentProgram=c,r.uniformsList=null,c}function Be(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=WebGLUniforms.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Ve(e,t){const i=ee.get(e);i.outputColorSpace=t.outputColorSpace,i.batching=t.batching,i.batchingColor=t.batchingColor,i.instancing=t.instancing,i.instancingColor=t.instancingColor,i.instancingMorph=t.instancingMorph,i.skinning=t.skinning,i.morphTargets=t.morphTargets,i.morphNormals=t.morphNormals,i.morphColors=t.morphColors,i.morphTargetsCount=t.morphTargetsCount,i.numClippingPlanes=t.numClippingPlanes,i.numIntersection=t.numClipIntersection,i.vertexAlphas=t.vertexAlphas,i.vertexTangents=t.vertexTangents,i.toneMapping=t.toneMapping}Ie.setAnimationLoop(function(e){Ce&&Ce(e)}),"undefined"!=typeof self&&Ie.setContext(self),this.setAnimationLoop=function(e){Ce=e,xe.setAnimationLoop(e),null===e?Ie.stop():Ie.start()},xe.addEventListener("sessionstart",Re),xe.addEventListener("sessionend",Pe),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===S)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===xe.enabled&&!0===xe.isPresenting&&(!0===xe.cameraAutoUpdate&&xe.updateCamera(t),t=xe.getCamera()),!0===e.isScene&&e.onBeforeRender(_,e,t,x),g=ce.get(e,y.length),g.init(t),y.push(g),$.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),V.setFromProjectionMatrix($),z=this.localClippingEnabled,G=de.init(this.clippingPlanes,z),m=he.get(e,v.length),m.init(),v.push(m),!0===xe.enabled&&!0===xe.isPresenting){const e=_.xr.getDepthSensingMesh();null!==e&&De(e,t,-1/0,_.sortObjects)}De(e,t,0,_.sortObjects),m.finish(),!0===_.sortObjects&&m.sort(O,U),K=!1===xe.enabled||!1===xe.isPresenting||!1===xe.hasDepthSensing(),K&&fe.addToRenderList(m,e),this.info.render.frame++,!0===G&&de.beginShadows();const i=g.state.shadowsArray;ue.render(i,e,t),!0===G&&de.endShadows(),!0===this.info.autoReset&&this.info.reset();const r=m.opaque,n=m.transmissive;if(g.setupLights(),t.isArrayCamera){const i=t.cameras;if(n.length>0)for(let t=0,s=i.length;t<s;t++){Oe(r,n,e,i[t])}K&&fe.render(e);for(let t=0,r=i.length;t<r;t++){const r=i[t];ke(m,e,r,r.viewport)}}else n.length>0&&Oe(r,n,e,t),K&&fe.render(e),ke(m,e,t);null!==x&&0===T&&(te.updateMultisampleRenderTarget(x),te.updateRenderTargetMipmap(x)),!0===e.isScene&&e.onAfterRender(_,e,t),ye.resetDefaultState(),E=-1,M=null,y.pop(),y.length>0?(g=y[y.length-1],!0===G&&de.setGlobalState(_.clippingPlanes,g.state.camera)):g=null,v.pop(),m=v.length>0?v[v.length-1]:null},this.getActiveCubeFace=function(){return b},this.getActiveMipmapLevel=function(){return T},this.getRenderTarget=function(){return x},this.setRenderTargetTextures=function(e,t,i){ee.get(e.texture).__webglTexture=t,ee.get(e.depthTexture).__webglTexture=i;const r=ee.get(e);r.__hasExternalTextures=!0,r.__autoAllocateDepthBuffer=void 0===i,r.__autoAllocateDepthBuffer||!0===X.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),r.__useRenderToTexture=!1)},this.setRenderTargetFramebuffer=function(e,t){const i=ee.get(e);i.__webglFramebuffer=t,i.__useDefaultFramebuffer=void 0===t};const Ge=Se.createFramebuffer();this.setRenderTarget=function(e,t=0,i=0){x=e,b=t,T=i;let r=!0,n=null,s=!1,a=!1;if(e){const o=ee.get(e);if(void 0!==o.__useDefaultFramebuffer)Z.bindFramebuffer(36160,null),r=!1;else if(void 0===o.__webglFramebuffer)te.setupRenderTarget(e);else if(o.__hasExternalTextures)te.rebindTextures(e,ee.get(e.texture).__webglTexture,ee.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&ee.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");te.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(a=!0);const h=ee.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(h[t])?h[t][i]:h[t],s=!0):n=e.samples>0&&!1===te.useMultisampledRTT(e)?ee.get(e).__webglMultisampledFramebuffer:Array.isArray(h)?h[i]:h,w.copy(e.viewport),A.copy(e.scissor),L=e.scissorTest}else w.copy(N).multiplyScalar(k).floor(),A.copy(F).multiplyScalar(k).floor(),L=B;0!==i&&(n=Ge);if(Z.bindFramebuffer(36160,n)&&r&&Z.drawBuffers(e,n),Z.viewport(w),Z.scissor(A),Z.setScissorTest(L),s){const r=ee.get(e.texture);Se.framebufferTexture2D(36160,36064,34069+t,r.__webglTexture,i)}else if(a){const r=ee.get(e.texture),n=t;Se.framebufferTextureLayer(36160,36064,r.__webglTexture,i,n)}else if(null!==e&&0!==i){const t=ee.get(e.texture);Se.framebufferTexture2D(36160,36064,3553,t.__webglTexture,i)}E=-1},this.readRenderTargetPixels=function(e,t,i,r,n,s,a){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ee.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){Z.bindFramebuffer(36160,o);try{const a=e.texture,o=a.format,l=a.type;if(!Q.textureFormatReadable(o))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!Q.textureTypeReadable(l))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-r&&i>=0&&i<=e.height-n&&Se.readPixels(t,i,r,n,ve.convert(o),ve.convert(l),s)}finally{const e=null!==x?ee.get(x).__webglFramebuffer:null;Z.bindFramebuffer(36160,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,i,r,n,s,a){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ee.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){const a=e.texture,l=a.format,h=a.type;if(!Q.textureFormatReadable(l))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!Q.textureTypeReadable(h))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");if(t>=0&&t<=e.width-r&&i>=0&&i<=e.height-n){Z.bindFramebuffer(36160,o);const e=Se.createBuffer();Se.bindBuffer(35051,e),Se.bufferData(35051,s.byteLength,35041),Se.readPixels(t,i,r,n,ve.convert(l),ve.convert(h),0);const a=null!==x?ee.get(x).__webglFramebuffer:null;Z.bindFramebuffer(36160,a);const c=Se.fenceSync(37143,0);return Se.flush(),await function(e,t,i){return new Promise(function(r,n){setTimeout(function s(){switch(e.clientWaitSync(t,1,0)){case 37149:n();break;case 37147:setTimeout(s,i);break;default:r()}},i)})}(Se,c,4),Se.bindBuffer(35051,e),Se.getBufferSubData(35051,0,s),Se.deleteBuffer(e),Se.deleteSync(c),s}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,i=0){!0!==e.isTexture&&(Vc("WebGLRenderer: copyFramebufferToTexture function signature has changed."),t=arguments[0]||null,e=arguments[1]);const r=Math.pow(2,-i),n=Math.floor(e.image.width*r),s=Math.floor(e.image.height*r),a=null!==t?t.x:0,o=null!==t?t.y:0;te.setTexture2D(e,0),Se.copyTexSubImage2D(3553,i,0,0,a,o,n,s),Z.unbindTexture()};const ze=Se.createFramebuffer(),He=Se.createFramebuffer();this.copyTextureToTexture=function(e,t,i=null,r=null,n=0,s=null){let a,o,l,h,c,d,u,f,p;!0!==e.isTexture&&(Vc("WebGLRenderer: copyTextureToTexture function signature has changed."),r=arguments[0]||null,e=arguments[1],t=arguments[2],s=arguments[3]||0,i=null),null===s&&(0!==n?(Vc("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),s=n,n=0):s=0);const m=e.isCompressedTexture?e.mipmaps[s]:e.image;if(null!==i)a=i.max.x-i.min.x,o=i.max.y-i.min.y,l=i.isBox3?i.max.z-i.min.z:1,h=i.min.x,c=i.min.y,d=i.isBox3?i.min.z:0;else{const t=Math.pow(2,-n);a=Math.floor(m.width*t),o=Math.floor(m.height*t),l=e.isDataArrayTexture?m.depth:e.isData3DTexture?Math.floor(m.depth*t):1,h=0,c=0,d=0}null!==r?(u=r.x,f=r.y,p=r.z):(u=0,f=0,p=0);const g=ve.convert(t.format),v=ve.convert(t.type);let y;t.isData3DTexture?(te.setTexture3D(t,0),y=32879):t.isDataArrayTexture||t.isCompressedArrayTexture?(te.setTexture2DArray(t,0),y=35866):(te.setTexture2D(t,0),y=3553),Se.pixelStorei(37440,t.flipY),Se.pixelStorei(37441,t.premultiplyAlpha),Se.pixelStorei(3317,t.unpackAlignment);const _=Se.getParameter(3314),S=Se.getParameter(32878),b=Se.getParameter(3316),T=Se.getParameter(3315),x=Se.getParameter(32877);Se.pixelStorei(3314,m.width),Se.pixelStorei(32878,m.height),Se.pixelStorei(3316,h),Se.pixelStorei(3315,c),Se.pixelStorei(32877,d);const E=e.isDataArrayTexture||e.isData3DTexture,M=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const i=ee.get(e),r=ee.get(t),m=ee.get(i.__renderTarget),g=ee.get(r.__renderTarget);Z.bindFramebuffer(36008,m.__webglFramebuffer),Z.bindFramebuffer(36009,g.__webglFramebuffer);for(let i=0;i<l;i++)E&&(Se.framebufferTextureLayer(36008,36064,ee.get(e).__webglTexture,n,d+i),Se.framebufferTextureLayer(36009,36064,ee.get(t).__webglTexture,s,p+i)),Se.blitFramebuffer(h,c,a,o,u,f,a,o,256,9728);Z.bindFramebuffer(36008,null),Z.bindFramebuffer(36009,null)}else if(0!==n||e.isRenderTargetTexture||ee.has(e)){const i=ee.get(e),r=ee.get(t);Z.bindFramebuffer(36008,ze),Z.bindFramebuffer(36009,He);for(let e=0;e<l;e++)E?Se.framebufferTextureLayer(36008,36064,i.__webglTexture,n,d+e):Se.framebufferTexture2D(36008,36064,3553,i.__webglTexture,n),M?Se.framebufferTextureLayer(36009,36064,r.__webglTexture,s,p+e):Se.framebufferTexture2D(36009,36064,3553,r.__webglTexture,s),0!==n?Se.blitFramebuffer(h,c,a,o,u,f,a,o,16384,9728):M?Se.copyTexSubImage3D(y,s,u,f,p+e,h,c,a,o):Se.copyTexSubImage2D(y,s,u,f,h,c,a,o);Z.bindFramebuffer(36008,null),Z.bindFramebuffer(36009,null)}else M?e.isDataTexture||e.isData3DTexture?Se.texSubImage3D(y,s,u,f,p,a,o,l,g,v,m.data):t.isCompressedArrayTexture?Se.compressedTexSubImage3D(y,s,u,f,p,a,o,l,g,m.data):Se.texSubImage3D(y,s,u,f,p,a,o,l,g,v,m):e.isDataTexture?Se.texSubImage2D(3553,s,u,f,a,o,g,v,m.data):e.isCompressedTexture?Se.compressedTexSubImage2D(3553,s,u,f,m.width,m.height,g,m.data):Se.texSubImage2D(3553,s,u,f,a,o,g,v,m);Se.pixelStorei(3314,_),Se.pixelStorei(32878,S),Se.pixelStorei(3316,b),Se.pixelStorei(3315,T),Se.pixelStorei(32877,x),0===s&&t.generateMipmaps&&Se.generateMipmap(y),Z.unbindTexture()},this.copyTextureToTexture3D=function(e,t,i=null,r=null,n=0){return!0!==e.isTexture&&(Vc("WebGLRenderer: copyTextureToTexture3D function signature has changed."),i=arguments[0]||null,r=arguments[1]||null,e=arguments[2],t=arguments[3],n=arguments[4]||0),Vc('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,i,r,n)},this.initRenderTarget=function(e){void 0===ee.get(e).__webglFramebuffer&&te.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?te.setTextureCube(e,0):e.isData3DTexture?te.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?te.setTexture2DArray(e,0):te.setTexture2D(e,0),Z.unbindTexture()},this.resetState=function(){b=0,T=0,x=null,Z.reset(),ye.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Mh}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorspace=Ph._getDrawingBufferColorSpace(e),t.unpackColorSpace=Ph._getUnpackColorSpace()}}const fp=new Matrix4;class Raycaster{constructor(e,t,i=0,r=1/0){this.ray=new Ray(e,t),this.near=i,this.far=r,this.camera=null,this.layers=new Layers,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return fp.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(fp),this}intersectObject(e,t=!0,i=[]){return mp(e,this,i,t),i.sort(pp),i}intersectObjects(e,t=!0,i=[]){for(let r=0,n=e.length;r<n;r++)mp(e[r],this,i,t);return i.sort(pp),i}}function pp(e,t){return e.distance-t.distance}function mp(e,t,i,r){let n=!0;if(e.layers.test(t.layers)){!1===e.raycast(t,i)&&(n=!1)}if(!0===n&&!0===r){const r=e.children;for(let e=0,n=r.length;e<n;e++)mp(r[e],t,i,!0)}}class Scene extends Object3D{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Euler,this.environmentIntensity=1,this.environmentRotation=new Euler,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class Light extends Object3D{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Color(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}const gp=new Matrix4,vp=new Vector3,yp=new Vector3;class LightShadow{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Vector2(512,512),this.map=null,this.mapPass=null,this.matrix=new Matrix4,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Frustum,this._frameExtents=new Vector2(1,1),this._viewportCount=1,this._viewports=[new Vector4(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;vp.setFromMatrixPosition(e.matrixWorld),t.position.copy(vp),yp.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(yp),t.updateMatrixWorld(),gp.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(gp),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(gp)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}const _p=new Matrix4,Sp=new Vector3,bp=new Vector3;class PointLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new Vector2(4,2),this._viewportCount=6,this._viewports=[new Vector4(2,1,1,1),new Vector4(0,1,1,1),new Vector4(3,1,1,1),new Vector4(1,1,1,1),new Vector4(3,0,1,1),new Vector4(1,0,1,1)],this._cubeDirections=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],this._cubeUps=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)]}updateMatrices(e,t=0){const i=this.camera,r=this.matrix,n=e.distance||i.far;n!==i.far&&(i.far=n,i.updateProjectionMatrix()),Sp.setFromMatrixPosition(e.matrixWorld),i.position.copy(Sp),bp.copy(i.position),bp.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(bp),i.updateMatrixWorld(),r.makeTranslation(-Sp.x,-Sp.y,-Sp.z),_p.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(_p)}}class PointLight extends Light{constructor(e,t,i=0,r=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=r,this.shadow=new PointLightShadow}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}const Tp={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class LoadingManager{constructor(e,t,i){const r=this;let n,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===s&&void 0!==r.onStart&&r.onStart(e,a,o),s=!0},this.itemEnd=function(e){a++,void 0!==r.onProgress&&r.onProgress(e,a,o),a===o&&(s=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(e){void 0!==r.onError&&r.onError(e)},this.resolveURL=function(e){return n?n(e):e},this.setURLModifier=function(e){return n=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],r=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return r}return null}}}const xp=new LoadingManager;class Loader{constructor(e){this.manager=void 0!==e?e:xp,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise(function(r,n){i.load(e,r,t,n)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}Loader.DEFAULT_MATERIAL_NAME="__DEFAULT";class ImageLoader extends Loader{constructor(e){super(e)}load(e,t,i,r){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,s=Tp.get(e);if(void 0!==s)return n.manager.itemStart(e),setTimeout(function(){t&&t(s),n.manager.itemEnd(e)},0),s;const a=Nc("img");function o(){h(),Tp.add(e,this),t&&t(this),n.manager.itemEnd(e)}function l(t){h(),r&&r(t),n.manager.itemError(e),n.manager.itemEnd(e)}function h(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),n.manager.itemStart(e),a.src=e,a}}class TextureLoader extends Loader{constructor(e){super(e)}load(e,t,i,r){const n=new Texture,s=new ImageLoader(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,function(e){n.image=e,n.needsUpdate=!0,void 0!==t&&t(n)},i,r),n}}class MeshStandardMaterial extends Material{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new Color(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class VideoTexture extends Texture{constructor(e,t,i,r,n,s,a,o,l){super(e,t,i,r,n,s,a,o,l),this.isVideoTexture=!0,this.minFilter=void 0!==s?s:ul,this.magFilter=void 0!==n?n:ul,this.generateMipmaps=!1;const h=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(function t(){h.needsUpdate=!0,e.requestVideoFrameCallback(t)})}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1==="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class Slider4D{$(e){return this.el.querySelectorAll(e)}constructor(e){this.el=e,$r.registerPlugin($a,ho),this.isPlaying=!1,this.duration=1800,this.focalDistance=8,this.imageDistanceZ=9,this._currentSlide=0,this.slides=[],this._current_id=-1,this.camTweenStack=[],this.currentCamPos={x:0,y:0,z:0},this.prlx={position:new Vector3(0,0,0),rotation:new Vector3(0,0,0)},uo.on("click","[data-slide]",this.onClick.bind(this)),this.$timeline=this.$(".m-timeline")[0],this.$items=this.$(".m-timeline > li"),this.$line=this.$(".m-timeline .line")[0],this.webGLCheck()&&this.webGL2Check()&&(this.init(),this.scene1(),this.setupTimeline(),this.play(),uo.on("mousemove",window,this.mouseMove.bind(this)),uo.on("mouseup",window,this.mouseUp.bind(this)),uo.on("resize",window,this.resize.bind(this)),this.$(".nogo-message")[0].classList.add("-hide")),uo.on("scroll",window,this.checkInViewport.bind(this))}checkInViewport(){let e=this.el.getBoundingClientRect();this.isPlaying=e.top>=-this.el.offsetHeight&&e.left>=-this.el.offsetWidth&&e.right<=(window.innerWidth||document.documentElement.clientWidth)+this.el.offsetWidth&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)+this.el.offsetHeight}destroy(){this.renderer=null,this.tl.kill(),uo.off("click","[data-slide]",this.onClick.bind(this)),uo.off("mousemove",window,this.mouseMove.bind(this)),uo.off("mouseup",window,this.mouseUp.bind(this)),uo.off("resize",window,this.resize.bind(this))}init(){this.renderer=new WebGLRenderer,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.antialias=!0,this.renderer.outputColorSpace=dh,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=2,this.$slider=this.$('[data-target="canvas"]')[0],this.$slider.appendChild(this.renderer.domElement),this.resize(),this.raycaster=new Raycaster,this.mouse=new Vector2}setupTimeline(){this.tl=$r.timeline({scrollTrigger:{trigger:this.el,pin:!0,start:"top top",end:"+="+550*this.slides.length,scrub:.3}});let e=window.innerWidth;this.$items.forEach(t=>{e+=t.getBoundingClientRect().width}),this.$line.style.width=e+"px",e=0,this.slides.every((t,i)=>(e+=this.$items[i].getBoundingClientRect().width,this.tl.add(""+i).to(this.$timeline,{x:()=>this.$timeline.getBoundingClientRect().left-this.$items[i].getBoundingClientRect().left,ease:"sine.out",onUpdate:()=>{this.currentIndex!=i&&this.toSlide(i,!1),this.$items.forEach((e,t)=>{t==i?e.classList.add("-active"):e.classList.remove("-active")})},onComplete:()=>{this.currentIndex!=i&&this.toSlide(i,!1)}}),!0)),this.toSlide(0,!1)}resize(){this.dbResize(),clearTimeout(this._tt),this._tt=setTimeout(this.dbResize.bind(this),500)}dbResize(){this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.height<450&&(this.height=450),this.renderer&&this.renderer.setSize(this.width,this.height),this.camera&&(this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix())}next(){this._currentSlide+=1,0==this.$('[data-slide="'+this._currentSlide+'"]').trigger("click").length&&this.$("[data-slide]:first").trigger("click")}play(){this.isPlaying=!0,this.render()}stop(){this.isPlaying=!1}onClick(e){e.stopPropagation(),e.preventDefault(),this.toSlide(e.initiator.dataset.slide,!0)}mouseMove(e){this.mouse.x=e.clientX/this.width*2-1,this.mouse.y=-e.clientY/this.height*2+1;this.applyPrlx({x:.5-e.clientX/this.width,y:.5-e.clientY/this.height}),this.moveCam(),this.rotCam()}applyPrlx(e){this.prlx.position.set(e.x,e.y,e.z)}mouseUp(){this.raycaster.setFromCamera(this.mouse,this.camera);let e=[];this.scene.children.map(function(t){t.children.map(function(t){e.push(t)})}),e=this.raycaster.intersectObjects(e),e.every(e=>"slide"!==e.name||(this.toSlide(e.itemindex,!0),!1))}tweenCameraTarget(e,t,i){for(var r,n=this,s=this.focalDistance,a=e.rotation.clone(),o=t.rotation.clone(),l=e.position.clone(),h=t.position.clone();1==(r=this.camTweenStack.pop());)r.kill();this.camTweenStack.push($r.to(l,{x:h.x+Math.sin(t.rotation.y)*s,z:h.z+Math.cos(t.rotation.y)*s,y:h.y,duration:i,ease:"sine.out",onUpdate:()=>{this.moveCam(l)},onComplete:()=>{for(;1==(r=n.camTweenStack.pop());)r.kill()}})),this.camTweenStack.push($r.to(a,{x:o.x,y:o.y,z:o.z,duration:i,onUpdate:()=>{this.rotCam(a)},onComplete:()=>{for(;1==(r=this.camTweenStack.pop());)r.kill()}}))}moveCam(e){e&&(this.currentCamPos=e),this.camera.position.set(this.currentCamPos.x+this.prlx.position.x,this.currentCamPos.y+this.prlx.position.y,this.currentCamPos.z),this.followLight.position.set(this.currentCamPos.x+this.prlx.rotation.x,this.currentCamPos.y+this.prlx.rotation.y,this.currentCamPos.z)}rotCam(e){e&&this.camera.rotation.set(e.x,e.y,e.z)}scene1(){let e=this;this.scene=new Scene;let t=new PerspectiveCamera(120,window.innerWidth/window.innerHeight,.5,1e3);t.position.set(0,0,150),t.lookAt(0,0,0),this.camera=t;let i=new PointLight(16777215,1,50,2);i.position.set(0,0,80),i.shadow.mapSize.width=100,i.shadow.mapSize.height=100,i.shadow.camera.near=.5,i.shadow.camera.far=1e3,i.castShadow=!1,i.angle=20,this.scene.add(i),this.followLight=i,this.$("[data-image]").forEach((t,i)=>{var r=new PlaneGeometry(1,1),n=(new TextureLoader).load(t.dataset.image,function(e){let t=e.image.width/e.image.height;a.scale.set(15*t,15,1),h.scale.set(15*t,15,1)});let s=new MeshStandardMaterial({color:16777215,map:n});s.transparent=!0,s.opacity=1;let a=new Mesh(r,s);a.scale.set(25,12,1),a.name="slide",a.itemindex=i,a.castShadow=!0,a.receiveShadow=!0,a.overdraw=!0;let o=10*Math.random(),l={x:i%2?10+o:-10-o,y:8*Math.random(),z:i*e.imageDistanceZ*1},h=new Mesh(new PlaneGeometry(1,1),new MeshStandardMaterial({color:0}));h.scale.set(25,12,1),h.position.z+=.2,h.material.opacity=0,h.material.transparent=!0;let c=new Group;c.name=t.dataset.slide,this.scene.add(c),c.position.set(l.x,l.y,l.z),c.rotation.y=Math.PI/1+(i%2?Math.random()/4:-Math.random()/4),c.add(a),c.add(h);let d=t.querySelector("video");if(d){let e=new VideoTexture(d);var u=new Mesh(new PlaneGeometry(1,1),new MeshStandardMaterial({color:16777215,map:e}));u.name="video",u.scale.set(16/9*12,12,1),u.position.z+=.3,u.material.opacity=0,u.material.transparent=!0,u.castShadow=!0,u.receiveShadow=!0,u.overdraw=!0,c.add(u)}c.tweens=[],c.hasFocus=!1,c.focusSlide=function(e){let t,i=this.children[1],r=this.children[2],n=this;for(n.hasFocus=!0;t=n.tweens.pop();)t&&t.killkill&&t.kill();let s=function(){if(0==n.hasFocus)return;let e=r.material.map.image;e.removeEventListener("canplaythrough"),e.currentTime=1,e.pause();let t=$r.timeline();t.to(i.material,{opacity:1,delay:3e3,duration:350}),t.to(r.material,{opacity:1,duration:.35,onComplete:()=>{e.play()}}),n.tweens.push(t)};if(r&&"video"==r.name){let e=r.material.map.image;e.removeEventListener("canplaythrough"),4==e.readyState?s():(uo.on("canplaythrough",e,()=>s()),e.load())}e()},c.blurSlide=function(){let e,t=this.children[1],i=this.children[2],r=this;for(r.hasFocus=!1;e=r.tweens.pop();)e&&e.kill&&e.kill();if(i&&"video"==i.name){let n=i.material.map.image;n.removeEventListener("canplaythrough"),n.pause();let s=$r.timeline();s.to(i.material,{opacity:0,duration:.35}),s.to(t.material,{opacity:0,duration:.35,onComplete:function(){n.pause()}}),r.tweens.push(e)}else e=$r.to(t.material,{opacity:0,duration:.35}),r.tweens.push(e)},e.slides.push(c)})}toSlide(e,t){clearTimeout(this._t),setTimeout(this.dbToSlide.bind(this,e,t),200)}dbToSlide(e,t){if(this.currentIndex=e,this.slides.forEach((t,i)=>{this.focusSlide(t,i===e,e)}),!0===t){let t=this.tl.scrollTrigger.labelToScroll(""+e);$r.to(window,{scrollTo:t,duration:1})}}focusSlide(e,t,i){if(t){if(this._current_id===i)return;this._current_id=i;let t=this.tweenCameraTarget.bind(this,this.camera,e,1.5);e.focusSlide(t)}else e.blurSlide()}render(){!0===this.isPlaying&&this.renderer.render(this.scene,this.camera),window.requestAnimationFrame(this.render.bind(this))}webGLCheck(){try{let e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}webGL2Check(){try{let e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(e){return!1}}}class FogExp2{constructor(e,t=25e-5){this.isFogExp2=!0,this.name="",this.color=new Color(e),this.density=t}clone(){return new FogExp2(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class SphereGeometry extends BufferGeometry{constructor(e=1,t=32,i=16,r=0,n=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:n,thetaStart:s,thetaLength:a},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const o=Math.min(s+a,Math.PI);let l=0;const h=[],c=new Vector3,d=new Vector3,u=[],f=[],p=[],m=[];for(let u=0;u<=i;u++){const g=[],v=u/i;let y=0;0===u&&0===s?y=.5/t:u===i&&o===Math.PI&&(y=-.5/t);for(let i=0;i<=t;i++){const o=i/t;c.x=-e*Math.cos(r+o*n)*Math.sin(s+v*a),c.y=e*Math.cos(s+v*a),c.z=e*Math.sin(r+o*n)*Math.sin(s+v*a),f.push(c.x,c.y,c.z),d.copy(c).normalize(),p.push(d.x,d.y,d.z),m.push(o+y,1-v),g.push(l++)}h.push(g)}for(let e=0;e<i;e++)for(let r=0;r<t;r++){const t=h[e][r+1],n=h[e][r],a=h[e+1][r],l=h[e+1][r+1];(0!==e||s>0)&&u.push(t,n,l),(e!==i-1||o<Math.PI)&&u.push(n,a,l)}this.setIndex(u),this.setAttribute("position",new Float32BufferAttribute(f,3)),this.setAttribute("normal",new Float32BufferAttribute(p,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new SphereGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class SpotLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,i=2*yo*e.angle*this.focus,r=this.mapSize.width/this.mapSize.height,n=e.distance||t.far;i===t.fov&&r===t.aspect&&n===t.far||(t.fov=i,t.aspect=r,t.far=n,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class SpotLight extends Light{constructor(e,t,i=0,r=Math.PI/3,n=0,s=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Object3D.DEFAULT_UP),this.updateMatrix(),this.target=new Object3D,this.distance=i,this.angle=r,this.penumbra=n,this.decay=s,this.map=null,this.shadow=new SpotLightShadow}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class WireframeGeometry extends BufferGeometry{constructor(e=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:e},null!==e){const t=[],i=new Set,r=new Vector3,n=new Vector3;if(null!==e.index){const s=e.attributes.position,a=e.index;let o=e.groups;0===o.length&&(o=[{start:0,count:a.count,materialIndex:0}]);for(let e=0,l=o.length;e<l;++e){const l=o[e],h=l.start;for(let e=h,o=h+l.count;e<o;e+=3)for(let o=0;o<3;o++){const l=a.getX(e+o),h=a.getX(e+(o+1)%3);r.fromBufferAttribute(s,l),n.fromBufferAttribute(s,h),!0===Ep(r,n,i)&&(t.push(r.x,r.y,r.z),t.push(n.x,n.y,n.z))}}}else{const s=e.attributes.position;for(let e=0,a=s.count/3;e<a;e++)for(let a=0;a<3;a++){const o=3*e+a,l=3*e+(a+1)%3;r.fromBufferAttribute(s,o),n.fromBufferAttribute(s,l),!0===Ep(r,n,i)&&(t.push(r.x,r.y,r.z),t.push(n.x,n.y,n.z))}}this.setAttribute("position",new Float32BufferAttribute(t,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}function Ep(e,t,i){const r=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`,n=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`;return!0!==i.has(r)&&!0!==i.has(n)&&(i.add(r),i.add(n),!0)}class LineBasicMaterial extends Material{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Color(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const Mp=new Vector3,wp=new Vector3,Ap=new Matrix4,Lp=new Ray,Cp=new Sphere,Rp=new Vector3,Pp=new Vector3;class Line extends Object3D{constructor(e=new BufferGeometry,t=new LineBasicMaterial){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,r=t.count;e<r;e++)Mp.fromBufferAttribute(t,e-1),wp.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=Mp.distanceTo(wp);e.setAttribute("lineDistance",new Float32BufferAttribute(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const i=this.geometry,r=this.matrixWorld,n=e.params.Line.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Cp.copy(i.boundingSphere),Cp.applyMatrix4(r),Cp.radius+=n,!1===e.ray.intersectsSphere(Cp))return;Ap.copy(r).invert(),Lp.copy(e.ray).applyMatrix4(Ap);const a=n/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=this.isLineSegments?2:1,h=i.index,c=i.attributes.position;if(null!==h){const i=Math.max(0,s.start),r=Math.min(h.count,s.start+s.count);for(let n=i,s=r-1;n<s;n+=l){const i=h.getX(n),r=h.getX(n+1),s=Ip(this,e,Lp,o,i,r,n);s&&t.push(s)}if(this.isLineLoop){const n=h.getX(r-1),s=h.getX(i),a=Ip(this,e,Lp,o,n,s,r-1);a&&t.push(a)}}else{const i=Math.max(0,s.start),r=Math.min(c.count,s.start+s.count);for(let n=i,s=r-1;n<s;n+=l){const i=Ip(this,e,Lp,o,n,n+1,n);i&&t.push(i)}if(this.isLineLoop){const n=Ip(this,e,Lp,o,r-1,i,r-1);n&&t.push(n)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function Ip(e,t,i,r,n,s,a){const o=e.geometry.attributes.position;Mp.fromBufferAttribute(o,n),wp.fromBufferAttribute(o,s);if(i.distanceSqToSegment(Mp,wp,Rp,Pp)>r)return;Rp.applyMatrix4(e.matrixWorld);const l=t.ray.origin.distanceTo(Rp);return l<t.near||l>t.far?void 0:{distance:l,point:Pp.clone().applyMatrix4(e.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:e}}const Dp=new Vector3,kp=new Vector3;class LineSegments extends Line{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,r=t.count;e<r;e+=2)Dp.fromBufferAttribute(t,e),kp.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+Dp.distanceTo(kp);e.setAttribute("lineDistance",new Float32BufferAttribute(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class SimpleGlobe{$(e){return this.el.querySelectorAll(e)}constructor(e){$r.registerPlugin($a),this.el=e,this.config=JSON.parse(this.el.getAttribute("data-config")),this.webGLCheck()&&this.webGL2Check()&&(uo.on("click","[data-item-id]",this.onClick.bind(this)),uo.on("mouseup",window,this.mouseUp.bind(this)),this.initGlobe(),this.$(".nogo-message")[0].classList.add("-hide"),this.initScroll()),uo.on("scroll",window,this.checkInViewport.bind(this)),uo.on("resize",window,this.resize.bind(this))}destroy(){this.tl_tour&&this.tl_tour.kill(),this.tl_globe&&this.tl_globe.kill(),this.tl_globe_rot&&this.tl_globe_rot.kill(),uo.off("resize",window,this.resize.bind(this)),uo.off("click","[data-item-id]",this.onClick.bind(this))}checkInViewport(){let e=this.el.getBoundingClientRect();this.isPlaying=e.top>=-this.el.offsetHeight&&e.left>=-this.el.offsetWidth&&e.right<=(window.innerWidth||document.documentElement.clientWidth)+this.el.offsetWidth&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)+this.el.offsetHeight}initScroll(){let e;"home"==this.config.scrollType?(this.tl_globe=$r.timeline({scrollTrigger:{trigger:".o-globe",pin:!0,pinSpacing:!1,start:"-=50vh",end:"bottom +100vh",scrub:!0}}),this.tl_globe.add("l1").to(this.universe.rotation,{x:Mo.degToRad(30),y:Mo.degToRad(-0),duration:35},"li").to(this.universe.position,{x:0,y:40,z:-450,duration:20},"li").to(this.universe.scale,{x:2.4,y:2.4,z:2.4,duration:20},"li").to(this.light,{intensity:1.8,distance:200,duration:25},"li")):(this.tl_globe=$r.timeline({scrollTrigger:{trigger:".o-globe",pin:!0,start:"-=50vh",end:"bottom +100vh",scrub:!0}}),this.tl_globe.add("l1").to(this.universe.rotation,{x:Mo.degToRad(30),y:Mo.degToRad(-0),duration:20},"li").to(this.universe.position,{x:0,y:90,z:-450,duration:25},"li").to(this.universe.scale,{x:2.4,y:2.4,z:2.4,duration:25},"li").to(this.light,{intensity:1.8,distance:200,duration:25},"li")),this.tl_globe_rot=$r.timeline({repeat:-1}),this.config.dates.every(t=>{let i={lat:parseFloat(t.lat),lng:parseFloat(t.lng)},r=this.calculateDuration(i,e);return r=r>0?.0015*r:1.5,NaN!=i.lat&&this.tl_globe_rot.to(this.globe.rotation,{y:Mo.degToRad(90-i.lng),x:Mo.degToRad(i.lat),duration:r,ease:"power2.out",delay:1,onStart:()=>{this.pois.every(e=>(e.itemId===t.id&&e.prep(),!0))},onComplete:()=>{this.pois.every(e=>(e.itemId===t.id&&e.pulse(),!0))}},"loc-"+t.id),e=i,!0})}initGlobe(){this.isPlaying=!0,this.scene=new Scene,this.camera=new PerspectiveCamera(60,window.innerWidth/window.innerHeight,.5,1e3),this.camera.position.set(0,0,200),this.camera.lookAt(0,0,0),this.scene.fog=new FogExp2(0,.001),this.renderer=new WebGLRenderer,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.antialias=!0,this.renderer.outputColorSpace=dh,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=2,this.renderer.setSize(window.innerWidth,window.innerHeight),this.$(".-canvas-bounds")[0].appendChild(this.renderer.domElement),this.raycaster=new Raycaster,this.mouse=new Vector2,this.globe=new Group,this.scene.add(this.globe),this.radius=50;let e=new Mesh(new SphereGeometry(this.radius,40,40),new MeshStandardMaterial({color:16777215,map:(new TextureLoader).load(this.config.map,function(e){})}));this.globe.add(e),e.material.rotation=Mo.degToRad(-180),e.rotation.y=Mo.degToRad(180);let t=new ShaderMaterial({uniforms:{c:{type:"f",value:.3},p:{type:"f",value:4}},vertexShader:document.getElementById("vertexShaderAtmosphere").textContent,fragmentShader:document.getElementById("fragmentShaderAtmosphere").textContent}),i=new Mesh(e.geometry.clone(),t);i.scale.x=i.scale.y=i.scale.z=1.05,i.scale.x=i.scale.y=i.scale.z=1.3,i.material.side=1,this.globe.add(i),this.globe.rotation.y=Mo.degToRad(0),this.globe.rotation.x=Mo.degToRad(30);let r=new SpotLight(16777215,.3,110,Mo.degToRad(40),.8,2);this.scene.add(r),this.scene.add(r.target),this.light=r,r.shadow.mapSize.width=250,r.shadow.mapSize.height=250,r.shadow.camera.near=.5,r.shadow.camera.far=1500,r.shadow.bias=-.001,r.castShadow=!0,r.angle=Mo.degToRad(90),r.exponent=20,r.intensity=.8,r.distance=120,r.power=5e3,r.shadowMapEnabled=!0,r.position.set(0,50,150),r.target.position.set(0,0,0),this.parseGlobePoi(),this.galaxy=new Group,this.galaxy.add(this.globe),this.scene.add(this.galaxy),this.galaxy.position.y=-80,this.galaxy.rotation.x=Mo.degToRad(-40);this.globe.scale.set(3.3,3.3,3.3);let n=this.$("[data-item-id]");if(n&&n.length>0){let e=n[0];e.onclick?e.onclick():e.click&&e.click()}else{let e=this.config.homeCord;r.position.set(0,75,140),r.angle=40,r.rotation.x=Mo.degToRad(-30),$r.to(this.globe.rotation,{y:Mo.degToRad(90-e.lng),x:Mo.degToRad(e.lat)},2e3)}this.universe=new Group,this.scene.add(this.universe),this.universe.add(this.light),this.universe.add(this.galaxy),this.animate()}parseGlobePoi(){this.pois=[],this.config.dates.every((e,t)=>{0===t&&this.activatePoint(e);let i=new Mesh(new SphereGeometry(.1,15,15),new MeshBasicMaterial({color:16777215}));i.material.opacity=.9,i.material.transparent=!0,i.name="point",i.receiveShadow=!0,i.castShadow=!0;const r=new SphereGeometry(1,6,6),n=new WireframeGeometry(r),s=new LineSegments(n);s.material.opacity=.25,s.material.transparent=!0,s.scale.x=s.scale.y=s.scale.z=0;let a=new Group;a.add(s),this.globe.add(a.add(i));let o=e.lat,l=e.lng,h=(90-o)*(Math.PI/180),c=(l+180)*(Math.PI/180),d=-this.radius*Math.sin(h)*Math.cos(c),u=this.radius*Math.sin(h)*Math.sin(c),f=this.radius*Math.cos(h);return a.position.set(d,f,u),a.itemId=e.id,a.prep=function(){let e=$r.timeline();e.add("start"),e.to(s.scale,{x:1,y:1,z:1,duration:1,ease:"expo.out"},"start"),e.to(s.rotation,{x:"+=8",y:"+=8",z:"+=8",duration:4,ease:"expo.out"},"start"),e.to(s.scale,{x:0,y:0,z:0,duration:.5,ease:"expo.out"})},a.pulse=function(){let e=$r.timeline();e.to(i.scale,{x:8,y:8,z:8,duration:.3,ease:"expo.out"}),e.to(i.scale,{x:1,y:1,z:1,duration:.3,ease:"expo.out"})},this.pois.push(a),!0})}animate(){!0===this.isPlaying&&this.renderer.render(this.scene,this.camera),requestAnimationFrame(this.animate.bind(this))}mouseUp(){}onClick(e){let t=this,i=e.initiator.dataset.itemId;this.config.dates.forEach(function(e){e.id===i&&t.activatePoint(e)})}showId(e){let t=this;this.config.dates.forEach(function(i){i.id===e&&t.activatePoint(i)})}activatePoint(e){}resize(){this._resize(),setTimeout(this._resize.bind(this),400)}_resize(){this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.height<450&&(this.height=450),this.width>window.innerWidth&&(this.width=window.innerWidth),this.renderer&&this.renderer.setSize(this.width,this.height),this.camera&&(this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix())}calculateDistance(e,t){let i=function(e){return e*Math.PI/180},r=i(e.lat),n=i(e.lng),s=i(t.lat),a=s-r,o=i(t.lng)-n,l=2*Math.asin(Math.sqrt(Math.pow(Math.sin(a/2),2)+Math.cos(r)*Math.cos(s)*Math.pow(Math.sin(o/2),2)));return Math.round(6371e3*l/1e3)}calculateDuration(e,t){if(!t)return 1e3;let i=this.calculateDistance(t,e);return i>2500&&(i=2500),i}webGLCheck(){try{let e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}webGL2Check(){try{let e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(e){return!1}}}class Tourdates{constructor(e){this.el=e,this.initScrollTourdates()}initScrollTourdates(){this.tl_tour=$r.timeline({scrollTrigger:{trigger:".o-tourdates",pin:!0,start:"-=100vh",end:"+=500px",scrub:.02}}),this.el.querySelectorAll(".o-tourdates .m-list li").forEach(e=>{this.tl_tour.to(e,{y:"-=10px",opacity:1,duration:.5,ease:"power1.inOut"})})}destroy(){this.tl_tour&&this.tl_tour.kill(),uo.off("resize",window,this.resize.bind(this)),uo.off("click","[data-item-id]",this.onClick.bind(this))}}class TourdatesAll{constructor(e){$r.registerPlugin($a),this.el=e,this.tl_tour=$r.timeline({scrollTrigger:{trigger:".o-tourdates",start:"top",end:"bottom",scrub:1,markers:!1}}),this.el.querySelectorAll(".o-tourdates .sc-out").forEach((e,t)=>{})}destroy(){this.tl_tour&&this.tl_tour.kill()}}const Op=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},Up=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=Np},Np=Number.MAX_SAFE_INTEGER||9007199254740991;let Fp=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),Bp=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",e.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",e.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.ASSET_LIST_LOAD_ERROR="assetListLoadError",e.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",e.ASSET_LIST_PARSING_ERROR="assetListParsingError",e.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.ATTACH_MEDIA_ERROR="attachMediaError",e.UNKNOWN="unknown",e}({}),Vp=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.MEDIA_ENDED="hlsMediaEnded",e.STALL_RESOLVED="hlsStallResolved",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFERED_TO_END="hlsBufferedToEnd",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e.ASSET_LIST_LOADING="hlsAssetListLoading",e.ASSET_LIST_LOADED="hlsAssetListLoaded",e.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",e.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",e.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",e.INTERSTITIAL_STARTED="hlsInterstitialStarted",e.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",e.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",e.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",e.INTERSTITIAL_ENDED="hlsInterstitialEnded",e.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",e.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",e.EVENT_CUE_ENTER="hlsEventCueEnter",e}({});var Gp="manifest",zp="level",Hp="audioTrack",$p="subtitleTrack",Wp="main",qp="audio",jp="subtitle";class EWMA{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class EwmaBandWidthEstimator{constructor(e,t,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new EWMA(e),this.fast_=new EWMA(t),this.defaultTTFB_=r,this.ttfb_=new EWMA(e)}update(e,t){const{slow_:i,fast_:r,ttfb_:n}=this;i.halfLife!==e&&(this.slow_=new EWMA(e,i.getEstimate(),i.getTotalWeight())),r.halfLife!==t&&(this.fast_=new EWMA(t,r.getEstimate(),r.getTotalWeight())),n.halfLife!==e&&(this.ttfb_=new EWMA(e,n.getEstimate(),n.getTotalWeight()))}sample(e,t){const i=(e=Math.max(e,this.minDelayMs_))/1e3,r=8*t/i;this.fast_.sample(i,r),this.slow_.sample(i,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function Kp(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Yp(){return Yp=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},Yp.apply(null,arguments)}function Xp(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function Qp(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Xp(Object(i),!0).forEach(function(t){Kp(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Xp(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}class Logger{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Zp,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Zp=function(){},Jp={trace:Zp,debug:Zp,log:Zp,warn:Zp,info:Zp,error:Zp};function em(){return Yp({},Jp)}function tm(e,t,i){return t[e]?t[e].bind(t):function(e,t){const i=self.console[e];return i?i.bind(self.console,`${t?"["+t+"] ":""}[${e}] >`):Zp}(e,i)}const im=em();const rm=im;function nm(e=!0){if("undefined"==typeof self)return;return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function sm(e,t){const i=Object.keys(e),r=Object.keys(t),n=i.length,s=r.length;return!n||!s||n===s&&!i.some(e=>-1===r.indexOf(e))}function am(e,t=!1){if("undefined"!=typeof TextDecoder){const i=new TextDecoder("utf-8").decode(e);if(t){const e=i.indexOf("\0");return-1!==e?i.substring(0,e):i}return i.replace(/\0/g,"")}const i=e.length;let r,n,s,a="",o=0;for(;o<i;){if(r=e[o++],0===r&&t)return a;if(0!==r&&3!==r)switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(r);break;case 12:case 13:n=e[o++],a+=String.fromCharCode((31&r)<<6|63&n);break;case 14:n=e[o++],s=e[o++],a+=String.fromCharCode((15&r)<<12|(63&n)<<6|63&s)}}return a}const om=function(e){let t="";for(let i=0;i<e.length;i++){let r=e[i].toString(16);r.length<2&&(r="0"+r),t+=r}return t};function lm(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var hm,cm={exports:{}};var dm,um,fm,pm,mm,gm=(hm||(hm=1,dm=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,um=/^(?=([^\/?#]*))\1([^]*)$/,fm=/(?:\/|^)\.(?=\/)/g,pm=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,cm.exports=mm={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var r=mm.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=mm.normalizePath(r.path),mm.buildURLFromParts(r)}var n=mm.parseURL(t);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return i.alwaysNormalize?(n.path=mm.normalizePath(n.path),mm.buildURLFromParts(n)):t;var s=mm.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");if(!s.netLoc&&s.path&&"/"!==s.path[0]){var a=um.exec(s.path);s.netLoc=a[1],s.path=a[2]}s.netLoc&&!s.path&&(s.path="/");var o={scheme:s.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(o.netLoc=s.netLoc,"/"!==n.path[0]))if(n.path){var l=s.path,h=l.substring(0,l.lastIndexOf("/")+1)+n.path;o.path=mm.normalizePath(h)}else o.path=s.path,n.params||(o.params=s.params,n.query||(o.query=s.query));return null===o.path&&(o.path=i.alwaysNormalize?mm.normalizePath(n.path):n.path),mm.buildURLFromParts(o)},parseURL:function(e){var t=dm.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(fm,"");e.length!==(e=e.replace(pm,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}}),cm.exports);class LoadStats{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var vm="audio",ym="video",_m="audiovideo";class BaseSegment{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,"string"==typeof e&&(e={url:e}),this.base=e,function(e,t){const i=bm(e,t);i&&(i.enumerable=!0,Object.defineProperty(e,t,i))}(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let r;r=1===i.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(i[1]),this._byteRange=[r,parseInt(i[0])+r]}get baseurl(){return this.base.url}get byteRange(){return null===this._byteRange?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return null===this._streams&&(this._streams={[vm]:null,[ym]:null,[_m]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return null!==this._stats}get hasStreams(){return null!==this._streams}get stats(){return null===this._stats&&(this._stats=new LoadStats),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=gm.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[vm]=null,e[ym]=null,e[_m]=null}}function Sm(e){return"initSegment"!==e.sn}class Fragment extends BaseSegment{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],t=this.byteRange[1];if(Op(e)&&Op(t))return t-e}return null}get bitrate(){return this.byteLength?8*this.byteLength/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;const e=Op(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}get programDateTime(){return null===this._programDateTime&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){Op(e)?this._programDateTime=e:this._programDateTime=this.rawProgramDateTime=null}get ref(){return Sm(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,i,r,n,s=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,i),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,n)):a[e]={startPTS:t,endPTS:i,startDTS:r,endDTS:n,partial:s}}}class Part extends BaseSegment{constructor(e,t,i,r,n){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=r;const s=e.enumeratedString("BYTERANGE");s&&this.setByteRange(s,n),n&&(this.fragOffset=n.fragOffset+n.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function bm(e,t){const i=Object.getPrototypeOf(e);if(i){const e=Object.getOwnPropertyDescriptor(i,t);return e||bm(i,t)}}const Tm=Math.pow(2,32)-1,xm=[].push,Em={video:1,audio:2,id3:3,text:4};function Mm(e){return String.fromCharCode.apply(null,e)}function wm(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i}function Am(e,t){const i=Cm(e,t);return i<0?4294967296+i:i}function Lm(e,t){let i=Am(e,t);return i*=Math.pow(2,32),i+=Am(e,t+4),i}function Cm(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Rm(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i}function Pm(e,t){const i=[];if(!t.length)return i;const r=e.byteLength;for(let n=0;n<r;){const s=Am(e,n),a=s>1?n+s:r;if(Mm(e.subarray(n+4,n+8))===t[0])if(1===t.length)i.push(e.subarray(n+8,a));else{const r=Pm(e.subarray(n+8,a),t.slice(1));r.length&&xm.apply(i,r)}n=a}return i}function Im(e){const t=[],i=e[0];let r=8;const n=Am(e,r);r+=4;let s=0,a=0;0===i?(s=Am(e,r),a=Am(e,r+4),r+=8):(s=Lm(e,r),a=Lm(e,r+8),r+=16),r+=2;let o=e.length+a;const l=wm(e,r);r+=2;for(let i=0;i<l;i++){let i=r;const s=Am(e,i);i+=4;const a=2147483647&s;if(1===(2147483648&s)>>>31)return rm.warn("SIDX has hierarchical references (not supported)"),null;const l=Am(e,i);i+=4,t.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/n,start:o,end:o+a-1}}),o+=a,i+=4,r=i}return{earliestPresentationTime:s,timescale:n,version:i,referencesCount:l,references:t}}function Dm(e){const t=[],i=Pm(e,["moov","trak"]);for(let e=0;e<i.length;e++){const r=i[e],n=Pm(r,["tkhd"])[0];if(n){let e=n[0];const i=Am(n,0===e?12:20),s=Pm(r,["mdia","mdhd"])[0];if(s){e=s[0];const n=Am(s,0===e?12:20),a=Pm(r,["mdia","hdlr"])[0];if(a){const e=Mm(a.subarray(8,12)),s={soun:vm,vide:ym}[e],o=km(Pm(r,["mdia","minf","stbl","stsd"])[0]);s?(t[i]={timescale:n,type:s,stsd:o},t[s]=Qp({timescale:n,id:i},o)):t[i]={timescale:n,type:e,stsd:o}}}}}return Pm(e,["moov","mvex","trex"]).forEach(e=>{const i=Am(e,4),r=t[i];r&&(r.default={duration:Am(e,12),flags:Am(e,20)})}),t}function km(e){const t=e.subarray(8),i=t.subarray(86),r=Mm(t.subarray(4,8));let n,s=r;const a="enca"===r||"encv"===r;if(a){const e=Pm(t,[r])[0];Pm(e.subarray("enca"===r?28:78),["sinf"]).forEach(e=>{const t=Pm(e,["schm"])[0];if(t){const i=Mm(t.subarray(4,8));if("cbcs"===i||"cenc"===i){const t=Pm(e,["frma"])[0];t&&(s=Mm(t))}}})}const o=s;switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const e=Pm(i,["avcC"])[0];e&&e.length>3&&(s+="."+Nm(e[1])+Nm(e[2])+Nm(e[3]),n=Om("avc1"===o?"dva1":"dvav",i));break}case"mp4a":{const e=Pm(t,[r])[0],i=Pm(e.subarray(28),["esds"])[0];if(i&&i.length>7){let e=4;if(3!==i[e++])break;e=Um(i,e),e+=2;const t=i[e++];if(128&t&&(e+=2),64&t&&(e+=i[e++]),4!==i[e++])break;e=Um(i,e);const r=i[e++];if(64!==r)break;if(s+="."+Nm(r),e+=12,5!==i[e++])break;e=Um(i,e);const n=i[e++];let a=(248&n)>>3;31===a&&(a+=1+((7&n)<<3)+((224&i[e])>>5)),s+="."+a}break}case"hvc1":case"hev1":{const e=Pm(i,["hvcC"])[0];if(e&&e.length>12){const t=e[1],i=["","A","B","C"][t>>6],r=31&t,n=Am(e,2),a=(32&t)>>5?"H":"L",o=e[12],l=e.subarray(6,12);s+="."+i+r,s+="."+function(e){let t=0;for(let i=0;i<32;i++)t|=(e>>i&1)<<31-i;return t>>>0}(n).toString(16).toUpperCase(),s+="."+a+o;let h="";for(let e=l.length;e--;){const t=l[e];if(t||h){h="."+t.toString(16).toUpperCase()+h}}s+=h}n=Om("hev1"==o?"dvhe":"dvh1",i);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":s=Om(s,i)||s;break;case"vp09":{const e=Pm(i,["vpcC"])[0];if(e&&e.length>6){const t=e[4],i=e[5],r=e[6]>>4&15;s+="."+Fm(t)+"."+Fm(i)+"."+Fm(r)}break}case"av01":{const e=Pm(i,["av1C"])[0];if(e&&e.length>2){const t=e[1]>>>5,r=31&e[1],a=e[2]>>>7?"H":"M",o=(64&e[2])>>6,l=(32&e[2])>>5,h=2===t&&o?l?12:10:o?10:8,c=(16&e[2])>>4,d=(8&e[2])>>3,u=(4&e[2])>>2,f=3&e[2],p=1,m=1,g=1,v=0;s+="."+t+"."+Fm(r)+a+"."+Fm(h)+"."+c+"."+d+u+f+"."+Fm(p)+"."+Fm(m)+"."+Fm(g)+"."+v,n=Om("dav1",i)}break}}return{codec:s,encrypted:a,supplemental:n}}function Om(e,t){const i=Pm(t,["dvvC"]),r=i.length?i[0]:Pm(t,["dvcC"])[0];if(r){const t=r[2]>>1&127,i=r[2]<<5&32|r[3]>>3&31;return e+"."+Fm(t)+"."+Fm(i)}}function Um(e,t){const i=t+5;for(;128&e[t++]&&t<i;);return t}function Nm(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function Fm(e){return(e<10?"0":"")+e}function Bm(e){const t=Pm(e,["schm"])[0];if(t){const i=Mm(t.subarray(4,8));if("cbcs"===i||"cenc"===i)return Pm(e,["schi","tenc"])[0]}return null}function Vm(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function Gm(e,t){const i=[],r=t.samples,n=t.timescale,s=t.id;let a=!1;return Pm(r,["moof"]).map(o=>{const l=o.byteOffset-8;Pm(o,["traf"]).map(o=>{const h=Pm(o,["tfdt"]).map(e=>{const t=e[0];let i=Am(e,4);return 1===t&&(i*=Math.pow(2,32),i+=Am(e,8)),i/n})[0];return void 0!==h&&(e=h),Pm(o,["tfhd"]).map(h=>{const c=Am(h,4),d=16777215&Am(h,0);let u=0;const f=!!(16&d);let p=0;const m=!!(32&d);let g=8;c===s&&(!!(1&d)&&(g+=8),!!(2&d)&&(g+=4),!!(8&d)&&(u=Am(h,g),g+=4),f&&(p=Am(h,g),g+=4),m&&(g+=4),"video"===t.type&&(a=zm(t.codec)),Pm(o,["trun"]).map(s=>{const o=s[0],h=16777215&Am(s,0),c=!!(1&h);let d=0;const f=!!(4&h),m=!!(256&h);let g=0;const v=!!(512&h);let y=0;const _=!!(1024&h),S=!!(2048&h);let b=0;const T=Am(s,4);let x=8;c&&(d=Am(s,x),x+=4),f&&(x+=4);let E=d+l;for(let l=0;l<T;l++){if(m?(g=Am(s,x),x+=4):g=u,v?(y=Am(s,x),x+=4):y=p,_&&(x+=4),S&&(b=0===o?Am(s,x):Cm(s,x),x+=4),t.type===ym){let t=0;for(;t<y;){const s=Am(r,E);if(E+=4,Hm(a,r[E])){$m(r.subarray(E,E+s),a?2:1,e+b/n,i)}E+=s,t+=s+4}}e+=g/n}}))})})}),i}function zm(e){if(!e)return!1;const t=e.substring(0,4);return"hvc1"===t||"hev1"===t||"dvh1"===t||"dvhe"===t}function Hm(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function $m(e,t,i,r){const n=Wm(e);let s=0;s+=t;let a=0,o=0,l=0;for(;s<n.length;){a=0;do{if(s>=n.length)break;l=n[s++],a+=l}while(255===l);o=0;do{if(s>=n.length)break;l=n[s++],o+=l}while(255===l);const e=n.length-s;let t=s;if(o<e)s+=o;else if(o>e){rm.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===a){if(181===n[t++]){const e=wm(n,t);if(t+=2,49===e){const e=Am(n,t);if(t+=4,1195456820===e){const e=n[t++];if(3===e){const s=n[t++],o=64&s,l=o?2+3*(31&s):0,h=new Uint8Array(l);if(o){h[0]=s;for(let e=1;e<l;e++)h[e]=n[t++]}r.push({type:e,payloadType:a,pts:i,bytes:h})}}}}}else if(5===a&&o>16){const e=[];for(let i=0;i<16;i++){const r=n[t++].toString(16);e.push(1==r.length?"0"+r:r),3!==i&&5!==i&&7!==i&&9!==i||e.push("-")}const s=o-16,l=new Uint8Array(s);for(let e=0;e<s;e++)l[e]=n[t++];r.push({payloadType:a,pts:i,uuid:e.join(""),userData:am(l),userDataBytes:l})}}}function Wm(e){const t=e.byteLength,i=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;const n=t-i.length,s=new Uint8Array(n);let a=0;for(r=0;r<n;a++,r++)a===i[0]&&(a++,i.shift()),s[r]=e[a];return s}function qm(e,t,i){if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,n,s;r=0,n=new Uint8Array,s=new Uint8Array;const a=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(a.buffer).setUint32(0,i.byteLength,!1),function(e,...t){const i=t.length;let r=8,n=i;for(;n--;)r+=t[n].byteLength;const s=new Uint8Array(r);for(s[0]=r>>24&255,s[1]=r>>16&255,s[2]=r>>8&255,s[3]=255&r,s.set(e,4),n=0,r=8;n<i;n++)s.set(t[n],r),r+=t[n].byteLength;return s}([112,115,115,104],new Uint8Array([0,0,0,0]),e,s,n,a,i||new Uint8Array)}function jm(e){const t=e.getUint32(0),i=e.byteOffset,r=e.byteLength;if(r<t)return{offset:i,size:r};if(1886614376!==e.getUint32(4))return{offset:i,size:t};const n=e.getUint32(8)>>>24;if(0!==n&&1!==n)return{offset:i,size:t};const s=e.buffer,a=om(new Uint8Array(s,i+12,16)),o=e.getUint32(28);let l=null,h=null;if(0===n){if(t-32<o||o<22)return{offset:i,size:t};h=new Uint8Array(s,i+32,o)}else if(1===n){if(!o||r<i+32+16*o+16)return{offset:i,size:t};l=[];for(let e=0;e<o;e++)l.push(new Uint8Array(s,i+32+16*e,16))}return{version:n,systemId:a,kids:l,data:h,offset:i,size:t}}const Km=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Ym={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Xm(e,t){const i=Ym[t];return!!i&&!!i[e.slice(0,4)]}function Qm(e,t,i=!0){return!e.split(",").some(e=>!Zm(e,t,i))}function Zm(e,t,i=!0){var r;const n=nm(i);return null!=(r=null==n?void 0:n.isTypeSupported(Jm(e,t)))&&r}function Jm(e,t){return`${t}/mp4;codecs=${e}`}function eg(e){if(e){const t=e.substring(0,4);return Ym.video[t]}return 2}function tg(e){const t=Km();return e.split(",").reduce((e,i)=>{const r=t&&zm(i)?9:Ym.video[i];return r?(2*r+e)/(e?3:2):(Ym.audio[i]+e)/(e?2:1)},0)}const ig={};const rg=/flac|opus|mp4a\.40\.34/i;function ng(e,t=!0){return e.replace(rg,e=>function(e,t=!0){if(ig[e])return ig[e];const i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[e];for(let n=0;n<i.length;n++){var r;if(Zm(i[n],"audio",t))return ig[e]=i[n],i[n];if("mp3"===i[n]&&null!=(r=nm(t))&&r.isTypeSupported("audio/mpeg"))return""}return e}(e.toLowerCase(),t))}function sg(e,t){if(e&&(e.length>4||-1!==["ac-3","ec-3","alac","fLaC","Opus"].indexOf(e)))return e;if(t){const i=t.split(",");if(i.length>1){if(e)for(let t=i.length;t--;)if(i[t].substring(0,4)===e.substring(0,4))return i[t];return i[0]}}return t||e}function ag(e){if(e.startsWith("av01.")){const t=e.split("."),i=["0","111","01","01","01","0"];for(let e=t.length;e>4&&e<10;e++)t[e]=i[e-4];return t.join(".")}return e}function og(e){const t=nm(e)||{isTypeSupported:()=>!1};return{mpeg:t.isTypeSupported("audio/mpeg"),mp3:t.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:t.isTypeSupported('audio/mp4; codecs="ac-3"')}}function lg(e){return e.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const hg={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function cg(e,t){return{supported:!1,configurations:t,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:e}}const dg={};function ug(e,t,i,r,n,s){const a=e.audioCodec?e.audioGroups:null,o=null==s?void 0:s.audioCodec,l=null==s?void 0:s.channels,h=l?parseInt(l):o?1/0:2;let c=null;if(null!=a&&a.length)try{c=1===a.length&&a[0]?t.groups[a[0]].channels:a.reduce((e,i)=>{if(i){const r=t.groups[i];if(!r)throw new Error(`Audio track group ${i} not found`);Object.keys(r.channels).forEach(t=>{e[t]=(e[t]||0)+r.channels[t]})}return e},{2:0})}catch(e){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(r,30)||"SDR"!==e.videoRange&&e.videoRange!==i||e.bitrate>Math.max(n,8e6))||!!c&&Op(h)&&Object.keys(c).some(e=>parseInt(e)>h)}function fg(e,t,i){const r=e.videoCodec,n=e.audioCodec;if(!r&&!n||!i)return Promise.resolve(hg);const s=[];if(r){const t={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},i=e.videoRange;"SDR"!==i&&(t.transferFunction=i.toLowerCase());const n=r.split(","),a=navigator.userAgent;if(n.some(e=>zm(e))&&Km())return Promise.resolve(cg(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${a})`),s));s.push.apply(s,n.map(e=>({type:"media-source",video:Qp(Qp({},t),{},{contentType:Jm(ag(e),"video")})})))}return n&&e.audioGroups&&e.audioGroups.forEach(e=>{var i;e&&(null==(i=t.groups[e])||i.tracks.forEach(t=>{if(t.groupId===e){const e=t.channels||"",i=parseFloat(e);Op(i)&&i>2&&s.push.apply(s,n.split(",").map(e=>({type:"media-source",audio:{contentType:Jm(e,"audio"),channels:""+i}})))}}))}),Promise.all(s.map(e=>{const t=function(e){const{audio:t,video:i}=e,r=i||t;if(r){const e=lg(r.contentType);if(i)return`r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${e}_${Math.ceil(i.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${e}`}return""}(e);return dg[t]||(dg[t]=i.decodingInfo(e))})).then(e=>({supported:!e.some(e=>!e.supported),configurations:s,decodingInfoResults:e})).catch(e=>({supported:!1,configurations:s,decodingInfoResults:[],error:e}))}const pg=["NONE","TYPE-0","TYPE-1",null];const mg=["SDR","PQ","HLG"];var gg="",vg="YES",yg="v2";function _g(e){const{canSkipUntil:t,canSkipDateRanges:i,age:r}=e;return t&&r<t/2?i?yg:vg:gg}class HlsUrlParameters{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Level{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=null==(t=e.supplemental)?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Sg(this._audioGroups,e)}hasSubtitleGroup(e){return Sg(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function Sg(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function bg(e,t){let i=!1,r=[];if(e&&(i="SDR"!==e,r=[e]),t){r=t.allowedVideoRanges||mg.slice(0);const e="SDR"!==r.join("")&&!t.videoCodec;i=void 0!==t.preferHDR?t.preferHDR:e&&function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),i||(r=["SDR"])}return{preferHDR:i,allowedVideoRanges:r}}const Tg=(e,t)=>JSON.stringify(e,(e=>{const t=new WeakSet;return(i,r)=>{if(e&&(r=e(i,r)),"object"==typeof r&&null!==r){if(t.has(r))return;t.add(r)}return r}})(t));function xg(e,t){rm.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function Eg(e){return e.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const r=t.channels||"2";return i.channels[r]=(i.channels[r]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Mg(e){if(!e)return e;const{lang:t,assocLang:i,characteristics:r,channels:n,audioCodec:s}=e;return{lang:t,assocLang:i,characteristics:r,channels:n,audioCodec:s}}function wg(e,t,i){if("attrs"in e){const i=t.indexOf(e);if(-1!==i)return i}for(let r=0;r<t.length;r++){if(Ag(e,t[r],i))return r}return-1}function Ag(e,t,i){const{groupId:r,name:n,lang:s,assocLang:a,default:o}=e,l=e.forced;return(void 0===r||t.groupId===r)&&(void 0===n||t.name===n)&&(void 0===s||function(e,t="--"){if(e.length===t.length)return e===t;return e.startsWith(t)||t.startsWith(e)}(s,t.lang))&&(void 0===s||t.assocLang===a)&&(void 0===o||t.default===o)&&(void 0===l||t.forced===l)&&(!("characteristics"in e)||function(e,t=""){const i=e.split(","),r=t.split(",");return i.length===r.length&&!i.some(e=>-1===r.indexOf(e))}(e.characteristics||"",t.characteristics))&&(void 0===i||i(e,t))}function Lg(e,t){const{audioCodec:i,channels:r}=e;return!(void 0!==i&&(t.audioCodec||"").substring(0,4)!==i.substring(0,4)||void 0!==r&&r!==(t.channels||"2"))}function Cg(e,t,i){for(let r=t;r>-1;r--)if(i(e[r]))return r;for(let r=t+1;r<e.length;r++)if(i(e[r]))return r;return-1}function Rg(e,t){var i;return!!e&&e!==(null==(i=t.loadLevelObj)?void 0:i.uri)}const Pg=function(e,t){let i=0,r=e.length-1,n=null,s=null;for(;i<=r;){n=(i+r)/2|0,s=e[n];const a=t(s);if(a>0)i=n+1;else{if(!(a<0))return s;r=n-1}}return null};function Ig(e,t,i=0,r=0,n=.005){let s=null;if(e){s=t[1+e.sn-t[0].sn]||null;const r=e.endDTS-i;r>0&&r<15e-7&&(i+=15e-7),s&&e.level!==s.level&&s.end<=e.end&&(s=t[2+e.sn-t[0].sn]||null)}else 0===i&&0===t[0].start&&(s=t[0]);if(s&&((!e||e.level===s.level)&&0===Dg(i,r,s)||function(e,t,i){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){const r=t.tagList.reduce((e,t)=>("INF"===t[0]&&(e+=parseFloat(t[1])),e),i);return e.start<=r}return!1}(s,e,Math.min(n,r))))return s;const a=Pg(t,Dg.bind(null,i,r));return!a||a===e&&s?s:a}function Dg(e=0,t=0,i){if(i.start<=e&&i.start+i.duration>e)return 0;const r=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=e?1:i.start-r>e&&i.start?-1:0}function kg(e,t,i){const r=1e3*Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-r>e}function Og(e,t,i){if(e&&e.startCC<=t&&e.endCC>=t){let r=e.fragments;const{fragmentHint:n}=e;let s;return n&&(r=r.concat(n)),Pg(r,e=>e.cc<t?1:e.cc>t?-1:(s=e,e.end<=i?1:e.start>i?-1:0)),s||null}return null}function Ug(e){switch(e.details){case Bp.FRAG_LOAD_TIMEOUT:case Bp.KEY_LOAD_TIMEOUT:case Bp.LEVEL_LOAD_TIMEOUT:case Bp.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Ng(e,t){const i=Ug(t);return e.default[(i?"timeout":"error")+"Retry"]}function Fg(e,t){const i="linear"===e.backoff?1:Math.pow(2,t);return Math.min(i*e.retryDelayMs,e.maxRetryDelayMs)}function Bg(e){return Qp(Qp({},e),{errorRetry:null,timeoutRetry:null})}function Vg(e,t,i,r){if(!e)return!1;const n=null==r?void 0:r.code,s=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(n)||!!i);return e.shouldRetry?e.shouldRetry(e,t,i,r,s):s}var Gg=0,zg=2,Hg=3,$g=5,Wg=0,qg=1,jg=2;function Kg(e){const t={action:Gg,flags:Wg};return e&&(t.resolved=!0),t}var Yg="NOT_LOADED",Xg="APPENDING",Qg="PARTIAL",Zg="OK";class FragmentTracker{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.BUFFER_APPENDED,this.onBufferAppended,this),e.on(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Vp.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.BUFFER_APPENDED,this.onBufferAppended,this),e.off(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Vp.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let t=i.length;t--;){const r=i[t];if(!r)break;const n=r.end;if(r.start<=e&&null!==n&&e<=n)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:r}=this,n=Object.keys(r);for(let s=n.length;s--;){const a=r[n[s]];if((null==a?void 0:a.body.type)===t&&(!i||a.buffered)){const t=a.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,i,r,n){this.timeRanges&&(this.timeRanges[e]=t);const s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach(r=>{const a=this.fragments[r];if(!a)return;if(s>=a.body.sn)return;if(!a.buffered&&(!a.loaded||n))return void(a.body.type===i&&this.removeFragment(a.body));const o=a.range[e];o&&(0!==o.time.length?o.time.some(e=>{const i=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return i&&this.removeFragment(a.body),i}):this.removeFragment(a.body))})}detectPartialFragments(e){const t=this.timeRanges;if(!t||"initSegment"===e.frag.sn)return;const i=e.frag,r=ev(i),n=this.fragments[r];if(!n||n.buffered&&i.gap)return;const s=!i.relurl;if(Object.keys(t).forEach(r=>{const a=i.elementaryStreams[r];if(!a)return;const o=t[r],l=s||!0===a.partial;n.range[r]=this.getBufferedTimes(i,e.part,l,o)}),n.loaded=null,Object.keys(n.range).length){n.buffered=!0;(n.body.endList=i.endList||n.body.endList)&&(this.endListFragments[n.body.type]=n),Jg(n)||this.removeParts(i.sn-1,i.type)}else this.removeFragment(n.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=tv(i,t=>t.fragment.sn>=e))}fragBuffered(e,t){const i=ev(e);let r=this.fragments[i];!r&&t&&(r=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,i,r){const n={time:[],partial:i},s=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||s;for(let e=0;e<r.length;e++){const t=r.start(e)-this.bufferPadding,i=r.end(e)+this.bufferPadding;if(l>=t&&o<=i){n.time.push({startPTS:Math.max(s,r.start(e)),endPTS:Math.min(a,r.end(e))});break}if(s<i&&a>t){const t=Math.max(s,r.start(e)),i=Math.min(a,r.end(e));i>t&&(n.partial=!0,n.time.push({startPTS:t,endPTS:i}))}else if(a<=t)break}return n}getPartialFragment(e){let t,i,r,n=null,s=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach(l=>{const h=o[l];h&&Jg(h)&&(i=h.body.start-a,r=h.body.end+a,e>=i&&e<=r&&(t=Math.min(e-i,r-e),s<=t&&(n=h.body,s=t)))}),n}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||Jg(t))}getState(e){const t=ev(e),i=this.fragments[t];return i?i.buffered?Jg(i)?Qg:Zg:Xg:Yg}isTimeBuffered(e,t,i){let r,n;for(let s=0;s<i.length;s++){if(r=i.start(s)-this.bufferPadding,n=i.end(s)+this.bufferPadding,e>=r&&t<=n)return!0;if(t<=r)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if("initSegment"===t.frag.sn||t.frag.bitrateTest)return;const i=t.frag,r=t.part?null:t,n=ev(i);this.fragments[n]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:r,timeRanges:n,type:s}=t;if("initSegment"===i.sn)return;const a=i.type;if(r){let e=this.activePartLists[a];e||(this.activePartLists[a]=e=[]),e.push(r)}this.timeRanges=n;const o=n[s];this.detectEvictedFragments(s,o,a,r)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=ev(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let r=i.length;r--;){const n=t[i[r]];if((null==n?void 0:n.body.type)===e)return!0}return!1}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,i,r,n){r&&!this.hasGaps||Object.keys(this.fragments).forEach(s=>{const a=this.fragments[s];if(!a)return;const o=a.body;o.type!==i||r&&!o.gap||o.start<t&&o.end>e&&(a.buffered||n)&&this.removeFragment(o)})}removeFragment(e){const t=ev(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const t=e.sn;this.activePartLists[e.type]=tv(i,e=>e.fragment.sn!==t)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const i=null==(e=this.hls)||null==(t=e.latestLevelDetails)?void 0:t.partList;i&&i.forEach(e=>e.clearElementaryStreamInfo())}}function Jg(e){var t,i,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(i=e.range.audio)?void 0:i.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function ev(e){return`${e.type}_${e.level}_${e.sn}`}function tv(e,t){return e.filter(e=>{const i=t(e);return i||e.clearElementaryStreamInfo(),i})}var iv=0,rv=1;class AESCrypto{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case iv:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case rv:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}class AESDecryptor{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let e=0;e<4;e++)i[e]=t.getUint32(4*e);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,r=i[0],n=i[1],s=i[2],a=i[3],o=this.invSubMix,l=o[0],h=o[1],c=o[2],d=o[3],u=new Uint32Array(256);let f=0,p=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let i=p^p<<1^p<<2^p<<3^p<<4;i=i>>>8^255&i^99,e[f]=i,t[i]=f;const o=u[f],m=u[o],g=u[m];let v=257*u[i]^16843008*i;r[f]=v<<24|v>>>8,n[f]=v<<16|v>>>16,s[f]=v<<8|v>>>24,a[f]=v,v=16843009*g^65537*m^257*o^16843008*f,l[i]=v<<24|v>>>8,h[i]=v<<16|v>>>16,c[i]=v<<8|v>>>24,d[i]=v,f?(f=o^u[u[u[g^o]]],p^=u[u[p]]):f=p=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,r=0;for(;r<t.length&&i;)i=t[r]===this.key[r],r++;if(i)return;this.key=t;const n=this.keySize=t.length;if(4!==n&&6!==n&&8!==n)throw new Error("Invalid aes key size="+n);const s=this.ksRows=4*(n+6+1);let a,o;const l=this.keySchedule=new Uint32Array(s),h=this.invKeySchedule=new Uint32Array(s),c=this.sBox,d=this.rcon,u=this.invSubMix,f=u[0],p=u[1],m=u[2],g=u[3];let v,y;for(a=0;a<s;a++)a<n?v=l[a]=t[a]:(y=v,a%n===0?(y=y<<8|y>>>24,y=c[y>>>24]<<24|c[y>>>16&255]<<16|c[y>>>8&255]<<8|c[255&y],y^=d[a/n|0]<<24):n>6&&a%n===4&&(y=c[y>>>24]<<24|c[y>>>16&255]<<16|c[y>>>8&255]<<8|c[255&y]),l[a]=v=(l[a-n]^y)>>>0);for(o=0;o<s;o++)a=s-o,y=3&o?l[a]:l[a-4],h[o]=o<4||a<=4?y:f[c[y>>>24]]^p[c[y>>>16&255]]^m[c[y>>>8&255]]^g[c[255&y]],h[o]=h[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const r=this.keySize+6,n=this.invKeySchedule,s=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],h=a[2],c=a[3],d=this.uint8ArrayToUint32Array_(i);let u=d[0],f=d[1],p=d[2],m=d[3];const g=new Int32Array(e),v=new Int32Array(g.length);let y,_,S,b,T,x,E,M,w,A,L,C,R,P;const D=this.networkToHostOrderSwap;for(;t<g.length;){for(w=D(g[t]),A=D(g[t+1]),L=D(g[t+2]),C=D(g[t+3]),T=w^n[0],x=C^n[1],E=L^n[2],M=A^n[3],R=4,P=1;P<r;P++)y=o[T>>>24]^l[x>>16&255]^h[E>>8&255]^c[255&M]^n[R],_=o[x>>>24]^l[E>>16&255]^h[M>>8&255]^c[255&T]^n[R+1],S=o[E>>>24]^l[M>>16&255]^h[T>>8&255]^c[255&x]^n[R+2],b=o[M>>>24]^l[T>>16&255]^h[x>>8&255]^c[255&E]^n[R+3],T=y,x=_,E=S,M=b,R+=4;y=s[T>>>24]<<24^s[x>>16&255]<<16^s[E>>8&255]<<8^s[255&M]^n[R],_=s[x>>>24]<<24^s[E>>16&255]<<16^s[M>>8&255]<<8^s[255&T]^n[R+1],S=s[E>>>24]<<24^s[M>>16&255]<<16^s[T>>8&255]<<8^s[255&x]^n[R+2],b=s[M>>>24]<<24^s[T>>16&255]<<16^s[x>>8&255]<<8^s[255&E]^n[R+3],v[t]=D(y^u),v[t+1]=D(b^f),v[t+2]=D(S^p),v[t+3]=D(_^m),u=w,f=A,p=L,m=C,t+=4}return v.buffer}}class FastAESKey{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=function(e){switch(e){case iv:return"AES-CBC";case rv:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${e}`)}}(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}class Decrypter{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,i=t&&new DataView(e.buffer).getUint8(t-1);return i?e.slice(0,t-i):e}(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,r){return this.useSoftware?new Promise((n,s)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,r);const o=this.flush();o?n(o.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,r)}softwareDecrypt(e,t,i,r){const{currentIV:n,currentResult:s,remainderData:a}=this;if(r!==iv||16!==t.byteLength)return rm.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=Vm(a,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;n&&(i=n);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new AESDecryptor),l.expandKey(t);const h=s;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=o.slice(-16).buffer,h||null}webCryptoDecrypt(e,t,i,r){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,r));this.key=t,this.fastAesKey=new FastAESKey(this.subtle,t,r)}return this.fastAesKey.expandKey().then(t=>{if(!this.subtle)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new AESCrypto(this.subtle,new Uint8Array(i),r).decrypt(e.buffer,t)}).catch(n=>(rm.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(e,t,i,r)))}onWebCryptoError(e,t,i,r){const n=this.enableSoftwareAES;if(n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,r);const n=this.flush();if(n)return n.buffer}throw new Error("WebCrypto"+(n?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%16;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(rm.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const nv=Math.pow(2,17);class FragmentLoader{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,n=r.fLoader,s=r.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some(e=>"GAP"===e[0]))return void o(av(e));e.gap=!1}const l=this.loader=n?new n(r):new s(r),h=sv(e);e.loader=l;const c=Bg(r.fragLoadPolicy.default),d={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:nv};e.stats=l.stats;const u={onSuccess:(t,i,r,n)=>{this.resetLoader(e,l);let s=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),a({frag:e,part:null,payload:s,networkDetails:n})},onError:(t,r,n,s)=>{this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Qp({url:i,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:n,stats:s}))},onAbort:(t,i,r)=>{this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:r,stats:t}))},onTimeout:(t,i,r)=>{this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:r,stats:t}))}};t&&(u.onProgress=(i,r,n,s)=>t({frag:e,part:null,payload:n,networkDetails:s})),l.load(h,d,u)})}loadPart(e,t,i){this.abort();const r=this.config,n=r.fLoader,s=r.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o(av(e,t));const l=this.loader=n?new n(r):new s(r),h=sv(e,t);e.loader=l;const c=Bg(r.fragLoadPolicy.default),d={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:nv};t.stats=l.stats,l.load(h,d,{onSuccess:(r,n,s,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const h={frag:e,part:t,payload:r.data,networkDetails:o};i(h),a(h)},onError:(i,r,n,s)=>{this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Qp({url:h.url,data:void 0},i),error:new Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:n,stats:s}))},onAbort:(i,r,n)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:n,stats:i}))},onTimeout:(i,r,n)=>{this.resetLoader(e,l),o(new LoadError({type:Fp.NETWORK_ERROR,details:Bp.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:n,stats:i}))}})})}updateStatsFromPart(e,t){const i=e.stats,r=t.stats,n=r.total;if(i.loaded+=r.loaded,n){const r=Math.round(e.duration/t.duration),s=Math.min(Math.round(i.loaded/n),r),a=(r-s)*Math.round(i.loaded/s);i.total=i.loaded+a}else i.total=Math.max(i.loaded,i.total);const s=i.loading,a=r.loading;s.start?s.first+=a.first-a.start:(s.start=a.start,s.first=a.first),s.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function sv(e,t=null){const i=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},n=i.byteRangeStartOffset,s=i.byteRangeEndOffset;if(Op(n)&&Op(s)){var a;let t=n,i=s;if("initSegment"===e.sn&&("AES-128"===(o=null==(a=e.decryptdata)?void 0:a.method)||"AES-256"===o)){const e=s-n;e%16&&(i=s+(16-e%16)),0!==n&&(r.resetIV=!0,t=n-16)}r.rangeStart=t,r.rangeEnd=i}var o;return r}function av(e,t){const i=new Error(`GAP ${e.gap?"tag":"attribute"} found`),r={type:Fp.MEDIA_ERROR,details:Bp.FRAG_GAP,fatal:!1,frag:e,error:i,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new LoadError(r)}class LoadError extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class TaskLoop extends Logger{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class ChunkMetadata{constructor(e,t,i,r=0,n=-1,s=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=i,this.size=r,this.part=n,this.partial=s}}const ov={length:0,start:()=>0,end:()=>0};class BufferHelper{static isBuffered(e,t){if(e){const i=BufferHelper.getBuffered(e);for(let e=i.length;e--;)if(t>=i.start(e)&&t<=i.end(e))return!0}return!1}static bufferedRanges(e){if(e){const t=BufferHelper.getBuffered(e);return BufferHelper.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const r=BufferHelper.bufferedRanges(e);if(r.length)return BufferHelper.bufferedInfo(r,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((e,t)=>e.start-t.start||t.end-e.end);let r=-1,n=[];if(i)for(let s=0;s<e.length;s++){t>=e[s].start&&t<=e[s].end&&(r=s);const a=n.length;if(a){const t=n[a-1].end;e[s].start-t<i?e[s].end>t&&(n[a-1].end=e[s].end):n.push(e[s])}else n.push(e[s])}else n=e;let s,a=0,o=t,l=t;for(let e=0;e<n.length;e++){const h=n[e].start,c=n[e].end;if(-1===r&&t>=h&&t<=c&&(r=e),t+i>=h&&t<c)o=h,l=c,a=l-t;else if(t+i<h){s=h;break}}return{len:a,start:o||0,end:l||0,nextStart:s,buffered:e,bufferedIndex:r}}static getBuffered(e){try{return e.buffered||ov}catch(e){return rm.log("failed to get media.buffered",e),ov}}}const lv=/\{\$([a-zA-Z0-9-_]+)\}/g;function hv(e){return lv.test(e)}function cv(e,t){if(null!==e.variableList||e.hasVariableRefs){const i=e.variableList;return t.replace(lv,t=>{const r=t.substring(2,t.length-1),n=null==i?void 0:i[r];return void 0===n?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),t):n})}return t}function dv(e,t,i){let r,n,s=e.variableList;if(s||(e.variableList=s={}),"QUERYPARAM"in t){r=t.QUERYPARAM;try{const e=new self.URL(i).searchParams;if(!e.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${i}"`);n=e.get(r)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`))}}else r=t.NAME,n=t.VALUE;r in s?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):s[r]=n||""}function uv(e,t,i){const r=t.IMPORT;if(i&&r in i){let t=e.variableList;t||(e.variableList=t={}),t[r]=i[r]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}const fv=/^(\d+)x(\d+)$/,pv=/(.+?)=(".*?"|.*?)(?:,|$)/g;class AttrList{constructor(e,t){"string"==typeof e&&(e=AttrList.parseAttrList(e,t)),Yp(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>"X-"===e.substring(0,2))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)i[e]=parseInt(t.slice(2*e,2*e+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((e,t)=>(e[t.toLowerCase()]=!0,e),t)}bool(e){return"YES"===this[e]}decimalResolution(e){const t=fv.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const r={};for(pv.lastIndex=0;null!==(i=pv.exec(e));){const n=i[1].trim();let s=i[2];const a=0===s.indexOf('"')&&s.lastIndexOf('"')===s.length-1;let o=!1;if(a)s=s.slice(1,-1);else switch(n){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":o=!0}if(t&&(a||o))s=cv(t,s);else if(!o&&!a)switch(n){case"CLOSED-CAPTIONS":if("NONE"===s)break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":rm.warn(`${e}: attribute ${n} is missing quotes`)}r[n]=s}return r}}function mv(e){return"ID"!==e&&"CLASS"!==e&&"CUE"!==e&&"START-DATE"!==e&&"DURATION"!==e&&"END-DATE"!==e&&"END-ON-NEXT"!==e}function gv(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e||"SCTE35-CMD"===e}class DateRange{constructor(e,t,i=0){var r;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(null==t?void 0:t.tagAnchor)||null,this.tagOrder=null!=(r=null==t?void 0:t.tagOrder)?r:i,t){const i=t.attr;for(const t in i)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==i[t]){rm.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=Yp(new AttrList({}),i,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=(null==t?void 0:t.endDate)||new Date(this.attr["END-DATE"]);Op(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return void 0===e?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return null===e||null===e.programDateTime?(rm.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return null!==t?this._dateAtEnd=new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(Op(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return"com.apple.hls.interstitial"===this.class}get isValid(){return!!this.id&&!this._badValueForSameId&&Op(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}class LevelDetails{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1}get hasProgramDateTime(){return!!this.fragments.length&&Op(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(-1!==t){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function vv(e){return"AES-128"===e||"AES-256"===e||"AES-256-CTR"===e}function yv(e){switch(e){case"AES-128":case"AES-256":return iv;case"AES-256-CTR":return rv;default:throw new Error(`invalid full segment method ${e}`)}}function _v(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function Sv(e){return Uint8Array.from(unescape(encodeURIComponent(e)),e=>e.charCodeAt(0))}function bv(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],n=r[1];t?(e.splice(-1,1),i=_v(n)):i=function(e){const t=Sv(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}(n)}}return i}const Tv="undefined"!=typeof self?self:void 0;var xv={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ev="org.w3.clearkey",Mv="com.apple.streamingkeydelivery",wv="com.microsoft.playready",Av="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function Lv(e){switch(e){case Mv:return xv.FAIRPLAY;case wv:return xv.PLAYREADY;case Av:return xv.WIDEVINE;case Ev:return xv.CLEARKEY}}var Cv="1077efecc0b24d02ace33c1e52e2fb4b",Rv="e2719d58a985b3c9781ab030af78d30e",Pv="9a04f07998404286ab92e65be0885f95",Iv="edef8ba979d64acea3c827dcd51d21ed";function Dv(e){return e===Iv?xv.WIDEVINE:e===Pv?xv.PLAYREADY:e===Cv||e===Rv?xv.CLEARKEY:void 0}function kv(e){switch(e){case xv.FAIRPLAY:return Mv;case xv.PLAYREADY:return wv;case xv.WIDEVINE:return Av;case xv.CLEARKEY:return Ev}}function Ov(e){const{drmSystems:t,widevineLicenseUrl:i}=e,r=t?[xv.FAIRPLAY,xv.WIDEVINE,xv.PLAYREADY,xv.CLEARKEY].filter(e=>!!t[e]):[];return!r[xv.WIDEVINE]&&i&&r.push(xv.WIDEVINE),r}const Uv=null!=Tv&&null!=(Nv=Tv.navigator)&&Nv.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var Nv;function Fv(e){const t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),i=String.fromCharCode.apply(null,Array.from(t)),r=i.substring(i.indexOf("<"),i.length),n=(new DOMParser).parseFromString(r,"text/xml").getElementsByTagName("KID")[0];if(n){const e=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");if(e){const t=_v(e).subarray(0,16);return function(e){const t=function(e,t,i){const r=e[t];e[t]=e[i],e[i]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),t}}return null}let Bv={};class LevelKey{static clearKeyUriToKeyIdMap(){Bv={}}constructor(e,t,i,r=[1],n=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=r,this.iv=n,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&!vv(e)}isSupported(){if(this.method){if(vv(this.method)||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case Mv:case Av:case wv:case Ev:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(vv(this.method)&&this.uri&&!this.iv){"number"!=typeof e&&(rm.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}(e);return new LevelKey(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=bv(this.uri);if(t)switch(this.keyFormat){case Av:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case wv:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=qm(e,0,t),this.keyId=Fv(t);break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=Bv[this.uri];if(!e){const t=Object.keys(Bv).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),Bv[this.uri]=e}this.keyId=e}return this}}const Vv=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Gv=/#EXT-X-MEDIA:(.*)/g,zv=/^#EXT(?:INF|-X-TARGETDURATION):/m,Hv=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),$v=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class M3U8Parser{static findGroup(e,t){for(let i=0;i<e.length;i++){const r=e[i];if(r.id===t)return r}}static resolve(e,t){return gm.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return zv.test(e)}static parseMasterPlaylist(e,t){const i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:hv(e)},r=[];let n;for(Vv.lastIndex=0;null!=(n=Vv.exec(e));)if(n[1]){var s;const e=new AttrList(n[1],i),a=cv(i,n[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:M3U8Parser.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),Yv(e.CODECS,o);const h=e["SUPPLEMENTAL-CODECS"];h&&(o.supplemental={},Yv(h,o.supplemental)),null!=(s=o.unknownCodecs)&&s.length||r.push(o),i.levels.push(o)}else if(n[3]){const e=n[3],r=n[4];switch(e){case"SESSION-DATA":{const e=new AttrList(r,i),t=e["DATA-ID"];t&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[t]=e);break}case"SESSION-KEY":{const e=jv(r,t,i);e.encrypted&&e.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(e)):rm.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":dv(i,new AttrList(r,i),t);break;case"CONTENT-STEERING":{const e=new AttrList(r,i);i.contentSteering={uri:M3U8Parser.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":i.startTimeOffset=Kv(r)}}const a=r.length>0&&r.length<i.levels.length;return i.levels=a?r:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(e,t,i){let r;const n={},s=i.levels,a={AUDIO:s.map(e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec})),SUBTITLES:s.map(e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec})),"CLOSED-CAPTIONS":[]};let o=0;for(Gv.lastIndex=0;null!==(r=Gv.exec(e));){const e=new AttrList(r[1],i),s=e.TYPE;if(s){const i=a[s],r=n[s]||[];n[s]=r;const l=e.LANGUAGE,h=e["ASSOC-LANGUAGE"],c=e.CHANNELS,d=e.CHARACTERISTICS,u=e["INSTREAM-ID"],f={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||l||"",type:s,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:l,url:e.URI?M3U8Parser.resolve(e.URI,t):""};if(h&&(f.assocLang=h),c&&(f.channels=c),d&&(f.characteristics=d),u&&(f.instreamId=u),null!=i&&i.length){const e=M3U8Parser.findGroup(i,f.groupId)||i[0];Xv(f,e,"audioCodec"),Xv(f,e,"textCodec")}r.push(f)}}return n}static parseLevelPlaylist(e,t,i,r,n,s){var a;const o={url:t},l=new LevelDetails(t),h=l.fragments,c=[];let d,u,f,p,m=null,g=0,v=0,y=0,_=0,S=0,b=null,T=new Fragment(r,o),x=-1,E=!1,M=null;if(Hv.lastIndex=0,l.m3u8=e,l.hasVariableRefs=hv(e),"#EXTM3U"!==(null==(a=Hv.exec(e))?void 0:a[0]))return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;null!==(d=Hv.exec(e));){E&&(E=!1,T=new Fragment(r,o),T.playlistOffset=y,T.start=y,T.sn=g,T.cc=_,S&&(T.bitrate=S),T.level=i,m&&(T.initSegment=m,m.rawProgramDateTime&&(T.rawProgramDateTime=m.rawProgramDateTime,m.rawProgramDateTime=null),M&&(T.setByteRange(M),M=null)));const e=d[1];if(e){T.duration=parseFloat(e);const t=(" "+d[2]).slice(1);T.title=t||null,T.tagList.push(t?["INF",e,t]:["INF",e])}else if(d[3]){if(Op(T.duration)){T.playlistOffset=y,T.start=y,f&&Jv(T,f,l),T.sn=g,T.level=i,T.cc=_,h.push(T);const e=(" "+d[3]).slice(1);T.relurl=cv(l,e),Qv(T,b,c),b=T,y+=T.duration,g++,v=0,E=!0}}else{if(d=d[0].match($v),!d){rm.warn("No matches on slow regex match for level playlist!");continue}for(u=1;u<d.length&&void 0===d[u];u++);const e=(" "+d[u]).slice(1),n=(" "+d[u+1]).slice(1),a=d[u+2]?(" "+d[u+2]).slice(1):null;switch(e){case"BYTERANGE":b?T.setByteRange(n,b):T.setByteRange(n);break;case"PROGRAM-DATE-TIME":T.rawProgramDateTime=n,T.tagList.push(["PROGRAM-DATE-TIME",n]),-1===x&&(x=h.length);break;case"PLAYLIST-TYPE":l.type&&ey(l,e,d),l.type=n.toUpperCase();break;case"MEDIA-SEQUENCE":0!==l.startSN?ey(l,e,d):h.length>0&&ty(l,e,d),g=l.startSN=parseInt(n);break;case"SKIP":{l.skippedSegments&&ey(l,e,d);const t=new AttrList(n,l),i=t.decimalInteger("SKIPPED-SEGMENTS");if(Op(i)){l.skippedSegments+=i;for(let e=i;e--;)h.push(null);g+=i}const r=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");r&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(r.split("\t")));break}case"TARGETDURATION":0!==l.targetduration&&ey(l,e,d),l.targetduration=Math.max(parseInt(n),1);break;case"VERSION":null!==l.version&&ey(l,e,d),l.version=parseInt(n);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||ey(l,e,d),l.live=!1;break;case"#":(n||a)&&T.tagList.push(a?[n,a]:[n]);break;case"DISCONTINUITY":_++,T.tagList.push(["DIS"]);break;case"GAP":T.gap=!0,T.tagList.push([e]);break;case"BITRATE":T.tagList.push([e,n]),S=1e3*parseInt(n),Op(S)?T.bitrate=S:S=0;break;case"DATERANGE":{const e=new AttrList(n,l),t=new DateRange(e,l.dateRanges[e.ID],l.dateRangeTagCount);l.dateRangeTagCount++,t.isValid||l.skippedSegments?l.dateRanges[t.id]=t:rm.warn(`Ignoring invalid DATERANGE tag: "${n}"`),T.tagList.push(["EXT-X-DATERANGE",n]);break}case"DEFINE":{const e=new AttrList(n,l);"IMPORT"in e?uv(l,e,s):dv(l,e,t)}break;case"DISCONTINUITY-SEQUENCE":0!==l.startCC?ey(l,e,d):h.length>0&&ty(l,e,d),l.startCC=_=parseInt(n);break;case"KEY":{const e=jv(n,t,l);if(e.isSupported()){if("NONE"===e.method){f=void 0;break}f||(f={}),f[e.keyFormat]&&(f=Yp({},f)),f[e.keyFormat]=e}else rm.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${n}"`);break}case"START":l.startTimeOffset=Kv(n);break;case"MAP":{const e=new AttrList(n,l);if(T.duration){const t=new Fragment(r,o);Zv(t,e,i,f),m=t,T.initSegment=m,m.rawProgramDateTime&&!T.rawProgramDateTime&&(T.rawProgramDateTime=m.rawProgramDateTime)}else{const t=T.byteRangeEndOffset;if(t){const e=T.byteRangeStartOffset;M=`${t-e}@${e}`}else M=null;Zv(T,e,i,f),m=T,E=!0}m.cc=_;break}case"SERVER-CONTROL":p&&ey(l,e,d),p=new AttrList(n),l.canBlockReload=p.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=p.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&p.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=p.optionalFloat("PART-HOLD-BACK",0),l.holdBack=p.optionalFloat("HOLD-BACK",0);break;case"PART-INF":{l.partTarget&&ey(l,e,d);const t=new AttrList(n);l.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=l.partList;e||(e=l.partList=[]);const t=v>0?e[e.length-1]:void 0,i=v++,r=new AttrList(n,l),s=new Part(r,T,o,i,t);e.push(s),T.duration+=s.duration;break}case"PRELOAD-HINT":{const e=new AttrList(n,l);l.preloadHint=e;break}case"RENDITION-REPORT":{const e=new AttrList(n,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(e);break}default:rm.warn(`line parsed but not handled: ${d}`)}}}b&&!b.relurl?(h.pop(),y-=b.duration,l.partList&&(l.fragmentHint=b)):l.partList&&(Qv(T,b,c),T.cc=_,l.fragmentHint=T,f&&Jv(T,f,l)),l.targetduration||(l.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const w=h.length,A=h[0],L=h[w-1];if(y+=l.skippedSegments*l.targetduration,y>0&&w&&L){l.averagetargetduration=y/w;const e=L.sn;l.endSN="initSegment"!==e?e:0,l.live||(L.endList=!0),A&&void 0===l.startCC&&(l.startCC=A.cc),x>0&&(!function(e,t){let i=e[t];for(let r=t;r--;){const t=e[r];if(!t)return;t.programDateTime=i.programDateTime-1e3*t.duration,i=t}}(h,x),A&&c.unshift(A))}else l.endSN=0,l.startCC=0;return l.fragmentHint&&(y+=l.fragmentHint.duration),l.totalduration=y,c.length&&l.dateRangeTagCount&&A&&Wv(c,l),l.endCC=_,l}}function Wv(e,t){const i=e.length;if(!i)return;const r=e[i-1],n=t.live?1/0:t.totalduration,s=Object.keys(t.dateRanges);for(let a=s.length;a--;){const o=t.dateRanges[s[a]],l=o.startDate.getTime();o.tagAnchor=r.ref;for(let r=i;r--;){const i=qv(t,l,e,r,n);if(-1!==i){o.tagAnchor=t.fragments[i].ref;break}}}}function qv(e,t,i,r,n){const s=i[r];if(s){const o=s.programDateTime;if(t>=o||0===r){var a;if(t<=o+1e3*(((null==(a=i[r+1])?void 0:a.start)||n)-s.start)){const n=i[r].sn-e.startSN,s=e.fragments;if(s.length>i.length){for(let a=(i[r+1]||s[s.length-1]).sn-e.startSN;a>n;a--){const e=s[a].programDateTime;if(t>=e&&t<e+1e3*s[a].duration)return a}}return n}}}return-1}function jv(e,t,i){var r,n;const s=new AttrList(e,i),a=null!=(r=s.METHOD)?r:"",o=s.URI,l=s.hexadecimalInteger("IV"),h=s.KEYFORMATVERSIONS,c=null!=(n=s.KEYFORMAT)?n:"identity";o&&s.IV&&!l&&rm.error(`Invalid IV: ${s.IV}`);const d=o?M3U8Parser.resolve(o,t):"",u=(h||"1").split("/").map(Number).filter(Number.isFinite);return new LevelKey(a,d,c,u,l)}function Kv(e){const t=new AttrList(e).decimalFloatingPoint("TIME-OFFSET");return Op(t)?t:null}function Yv(e,t){let i=(e||"").split(/[ ,]+/).filter(e=>e);["video","audio","text"].forEach(e=>{const r=i.filter(t=>Xm(t,e));r.length&&(t[`${e}Codec`]=r.map(e=>e.split("/")[0]).join(","),i=i.filter(e=>-1===r.indexOf(e)))}),t.unknownCodecs=i}function Xv(e,t,i){const r=t[i];r&&(e[i]=r)}function Qv(e,t,i){e.rawProgramDateTime?i.push(e):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime)}function Zv(e,t,i,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=i,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function Jv(e,t,i){e.levelkeys=t;const{encryptedFragments:r}=i;r.length&&r[r.length-1].levelkeys===t||!Object.keys(t).some(e=>t[e].isCommonEncryption)||r.push(e)}function ey(e,t,i){e.playlistParsingError=new Error(`#EXT-X-${t} must not appear more than once (${i[0]})`)}function ty(e,t,i){e.playlistParsingError=new Error(`#EXT-X-${t} must appear before the first Media Segment (${i[0]})`)}function iy(e,t){const i=t.startPTS;if(Op(i)){let r,n=0;t.sn>e.sn?(n=i-e.start,r=e):(n=e.start-i,r=t),r.duration!==n&&r.setDuration(n)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.setStart(e.start+(e.minEndPTS-e.start)):t.setStart(e.start+e.duration)}else t.setStart(Math.max(e.start-t.duration,0))}function ry(e,t,i,r,n,s){r-i<=0&&(rm.warn("Fragment should have a positive duration",t),r=i+t.duration,s=n+t.duration);let a=i,o=r;const l=t.startPTS,h=t.endPTS;if(Op(l)){const e=Math.abs(l-i);Op(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(i,l),i=Math.min(i,l),n=Math.min(n,t.startDTS),o=Math.min(r,h),r=Math.max(r,h),s=Math.max(s,t.endDTS)}const c=i-t.start;0!==t.start&&t.setStart(i),t.setDuration(r-t.start),t.startPTS=i,t.maxStartPTS=a,t.startDTS=n,t.endPTS=r,t.minEndPTS=o,t.endDTS=s;const d=t.sn;if(!e||d<e.startSN||d>e.endSN)return 0;let u;const f=d-e.startSN,p=e.fragments;for(p[f]=t,u=f;u>0;u--)iy(p[u],p[u-1]);for(u=f;u<p.length-1;u++)iy(p[u],p[u+1]);return e.fragmentHint&&iy(p[p.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,c}function ny(e,t){if(e===t)return;let i=null;const r=e.fragments;for(let e=r.length-1;e>=0;e--){const t=r[e].initSegment;if(t){i=t;break}}let n;e.fragmentHint&&delete e.fragmentHint.endPTS,function(e,t,i){const r=t.skippedSegments,n=Math.max(e.startSN,t.startSN)-t.startSN,s=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let h=n;h<=s;h++){const n=l[a+h];let s=o[h];if(r&&!s&&n&&(s=t.fragments[h]=n),n&&s){if(i(n,s,h,o),n.url&&n.url!==s.url)return void(t.playlistParsingError=sy(`media sequence mismatch ${s.sn}:`,e,t,n,s));if(n.cc!==s.cc)return void(t.playlistParsingError=sy(`discontinuity sequence mismatch (${n.cc}!=${s.cc})`,e,t,n,s))}}}(e,t,(e,r,s,a)=>{if((!t.startCC||t.skippedSegments)&&r.cc!==e.cc){const i=e.cc-r.cc;for(let e=s;e<a.length;e++)a[e].cc+=i;t.endCC=a[a.length-1].cc}Op(e.startPTS)&&Op(e.endPTS)&&(r.setStart(r.startPTS=e.startPTS),r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.setDuration(e.endPTS-e.startPTS),r.duration&&(n=r),t.PTSKnown=t.alignedSliding=!0),e.hasStreams&&(r.elementaryStreams=e.elementaryStreams),r.loader=e.loader,e.hasStats&&(r.stats=e.stats),e.initSegment&&(r.initSegment=e.initSegment,i=e.initSegment)});const s=t.fragments,a=t.fragmentHint?s.concat(t.fragmentHint):s;if(i&&a.forEach(e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=i)?void 0:t.relurl)||(e.initSegment=i)}),t.skippedSegments){if(t.deltaUpdateFailed=s.some(e=>!e),t.deltaUpdateFailed){rm.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)s.shift();t.startSN=s[0].sn}else{t.canSkipDateRanges&&(t.dateRanges=function(e,t){const{dateRanges:i,recentlyRemovedDateranges:r}=t,n=Yp({},e);r&&r.forEach(e=>{delete n[e]});const s=Object.keys(n).length;s&&Object.keys(i).forEach(e=>{const t=n[e],r=new DateRange(i[e].attr,t);r.isValid?(n[e]=r,t||(r.tagOrder+=s)):rm.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${Tg(i[e].attr)}"`)});return n}(e.dateRanges,t));const i=e.fragments.filter(e=>e.rawProgramDateTime);if(e.hasProgramDateTime&&!t.hasProgramDateTime)for(let e=1;e<a.length;e++)null===a[e].programDateTime&&Qv(a[e],a[e-1],i);Wv(i,t)}t.endCC=s[s.length-1].cc}if(!t.startCC){var o;const i=hy(e,t.startSN-1);t.startCC=null!=(o=null==i?void 0:i.cc)?o:s[0].cc}!function(e,t,i){if(e&&t){let r=0;for(let n=0,s=e.length;n<=s;n++){const s=e[n],a=t[n+r];s&&a&&s.index===a.index&&s.fragment.sn===a.fragment.sn?i(s,a):r--}}}(e.partList,t.partList,(e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),n?ry(t,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS):ay(e,t),s.length&&(t.totalduration=t.edge-s[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const l=t.advancedDateTime;if(t.advanced&&l){const e=t.edge;t.driftStart||(t.driftStartTime=l,t.driftStart=e),t.driftEndTime=l,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime;-1===t.requestScheduled&&(t.requestScheduled=e.requestScheduled)}function sy(e,t,i,r,n){return new Error(`${e} ${n.url}\nPlaylist starting @${t.startSN}\n${t.m3u8}\n\nPlaylist starting @${i.startSN}\n${i.m3u8}`)}function ay(e,t,i=!0){const r=t.startSN+t.skippedSegments-e.startSN,n=e.fragments,s=r>=0;let a=0;if(s&&r<n.length)a=n[r].start;else if(s&&t.startSN===e.endSN+1)a=e.fragmentEnd;else if(s&&i)a=e.fragmentStart+r*t.levelTargetDuration;else{if(t.skippedSegments||0!==t.fragmentStart)return;a=e.fragmentStart}oy(t,a)}function oy(e,t){if(t){const i=e.fragments;for(let r=e.skippedSegments;r<i.length;r++)i[r].addStart(t);e.fragmentHint&&e.fragmentHint.addStart(t)}}function ly(e,t=1/0){let i=1e3*e.targetduration;if(e.updated){const r=e.fragments,n=4;if(r.length&&i*n>t){const e=1e3*r[r.length-1].duration;e<i&&(i=e)}}else i/=2;return Math.round(i)}function hy(e,t,i){if(!e)return null;let r=e.fragments[t-e.startSN];return r||(r=e.fragmentHint,r&&r.sn===t?r:t<e.startSN&&i&&i.sn===t?i:null)}function cy(e,t,i){return e?dy(e.partList,t,i):null}function dy(e,t,i){if(e)for(let r=e.length;r--;){const n=e[r];if(n.index===i&&n.fragment.sn===t)return n}return null}function uy(e){e.forEach((e,t)=>{var i;null==(i=e.details)||i.fragments.forEach(e=>{e.level=t,e.initSegment&&(e.initSegment.level=t)})})}function fy(e,t){for(let r=0,n=e.length;r<n;r++){var i;if((null==(i=e[r])?void 0:i.cc)===t)return e[r]}return null}function py(e,t){if(e){const i=e.start+t;e.start=e.startPTS=i,e.endPTS=i+e.duration}}function my(e,t){const i=t.fragments;for(let t=0,r=i.length;t<r;t++)py(i[t],e);t.fragmentHint&&py(t.fragmentHint,e),t.alignedSliding=!0}function gy(e,t){if(!function(e,t){return!!(e&&t.startCC<e.endCC&&t.endCC>e.startCC)}(t,e))return;const i=Math.min(t.endCC,e.endCC),r=fy(t.fragments,i),n=fy(e.fragments,i);if(!r||!n)return;rm.log(`Aligning playlist at start of dicontinuity sequence ${i}`);my(r.start-n.start,e)}function vy(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const i=e.fragments,r=t.fragments;if(!i.length||!r.length)return;let n,s;const a=Math.min(t.endCC,e.endCC);t.startCC<a&&e.startCC<a&&(n=fy(r,a),s=fy(i,a)),n&&s||(n=r[Math.floor(r.length/2)],s=fy(i,n.cc)||i[Math.floor(i.length/2)]);const o=n.programDateTime,l=s.programDateTime;if(!o||!l)return;my((l-o)/1e3-(s.start-n.start),e)}const yy=function(e){let t="";const i=e.length;for(let r=0;r<i;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t},_y="STOPPED",Sy="IDLE",by="KEY_LOADING",Ty="FRAG_LOADING",xy="FRAG_LOADING_WAITING_RETRY",Ey="WAITING_TRACK",My="PARSING",wy="PARSED",Ay="ENDED",Ly="ERROR",Cy="WAITING_INIT_PTS",Ry="WAITING_LEVEL";class BaseStreamController extends TaskLoop{constructor(e,t,i,r,n){super(r,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=_y,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:e,fragCurrent:t,media:i,mediaBuffer:r,state:n}=this,s=i?i.currentTime:0,a=BufferHelper.bufferInfo(r||i,s,e.maxBufferHole);if(this.log(`media seeking to ${Op(s)?s.toFixed(3):s}, state: ${n}`),this.state===Ay)this.resetLoadingState();else if(t){const i=e.maxFragLookUpTolerance,r=t.start-i,n=t.start+t.duration+i;if(!a.len||n<a.start||r>a.end){const e=s>n;(s<r||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(i){this.fragmentTracker.removeFragmentsInRange(s,1/0,this.playlistType,!0);if(s>this.lastCurrentTime&&(this.lastCurrentTime=s),!this.loadingParts){const e=Math.max(a.end,s),t=this.shouldLoadParts(this.getLevelDetails(),e);t&&(this.log(`LL-Part loading ON after seeking to ${s.toFixed(2)} with buffer @${e.toFixed(2)}`),this.loadingParts=t)}}this.hls.hasEnoughToStart||a.len||(this.log(`setting startPosition to ${s} because of seek before start`),this.nextLoadPosition=this.startPosition=s),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=n,this.hls=e,this.fragmentLoader=new FragmentLoader(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Decrypter(e.config)}registerListeners(){const{hls:e}=this;e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Vp.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===_y)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=_y}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return-1===t&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,r=this.config.timelineOffset||0;if(i<=r)return!1;const n=e.buffered;this.config.maxBufferHole&&n&&n.length>1&&(e=BufferHelper.bufferedInfo(n,e.start,0));const s=e.nextStart;if(s&&s>r&&s<t.edge)return!1;if(this.media.currentTime<e.start)return!1;const a=t.partList;if(null!=a&&a.length){const e=a[a.length-1];return BufferHelper.isBuffered(this.media,e.start+e.duration/2)}const o=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(o)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}get timelineOffset(){const e=this.config.timelineOffset;var t;return e?(null==(t=this.getLevelDetails())?void 0:t.appliedTimelineOffset)||e:0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const r=this.config;this.levels&&r.autoStartLoad&&this.state===_y&&this.startLoad(r.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,r=this.media;if(null!==r){if(r.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),r.removeEventListener("seeking",this.onMediaSeeking),r.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i)return this.resetLoadingState(),void this.resetTransmuxer();this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=_y,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){this._doFragLoad(e,t,i,e=>{const t=e.frag;if(this.fragContextChanged(t))return this.warn(`${t.type} sn: ${t.sn}${e.part?" part: "+e.part.index:""} of ${this.fragInfo(t,!1,e.part)}) was dropped during download.`),void this.fragmentTracker.removeFragment(t);t.stats.chunkCount++,this._handleFragmentLoadProgress(e)}).then(e=>{if(!e)return;const t=this.state,i=e.frag;this.fragContextChanged(i)?(t===Ty||!this.fragCurrent&&t===My)&&(this.fragmentTracker.removeFragment(i),this.state=Sy):("payload"in e&&(this.log(`Loaded ${i.type} sn: ${i.sn} of ${this.playlistLabel()} ${i.level}`),this.hls.trigger(Vp.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e))}).catch(t=>{this.state!==_y&&this.state!==Ly&&(this.warn(`Frag error: ${(null==t?void 0:t.message)||t}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===Xg){const t=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,t),n=Math.max(e.duration,r?r.len:this.config.maxBufferLength),s=this.backtrackFragment;(1===(s?e.sn-s.sn:0)||this.reduceMaxBufferLength(n,e.duration))&&i.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Qg&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(null==t?void 0:t.live)&&"EVENT"!==t.type&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const r={startOffset:e,endOffset:t,type:i};this.hls.trigger(Vp.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(e=>{const t=null==e?void 0:e.frag;if(!t||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return e}).then(e=>{const{hls:t}=this,{frag:i,payload:r}=e,n=i.decryptdata;if(r&&r.byteLength>0&&null!=n&&n.key&&n.iv&&vv(n.method)){const s=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),n.key.buffer,n.iv.buffer,yv(n.method)).catch(e=>{throw t.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:i}),e}).then(r=>{const n=self.performance.now();return t.trigger(Vp.FRAG_DECRYPTED,{frag:i,payload:r,stats:{tstart:s,tdecrypt:n}}),e.payload=r,this.completeInitSegmentLoad(e)})}return this.completeInitSegmentLoad(e)}).catch(t=>{this.state!==_y&&this.state!==Ly&&(this.warn(t),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==_y&&(this.state=Sy),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?yy(BufferHelper.getBuffered(i)):"(detached)"})`),Sm(e)){var r;if(e.type!==jp){const t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return void(this.state=Sy)}const t=null==(r=this.levels)?void 0:r[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=Sy}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:r,partsLoaded:n}=e,s=!n||0===n.length||n.some(e=>!e),a=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!s);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,r){var n;this.fragCurrent=e;const s=null==t?void 0:t.details;if(!this.levels||!s)throw new Error(`frag load aborted, missing level${s?"":" detail"}s`);let a=null;!e.encrypted||null!=(n=e.decryptdata)&&n.key?e.encrypted||(a=this.keyLoader.loadClear(e,s.encryptedFragments),a&&this.log("[eme] blocking frag load until media-keys acquired")):(this.log(`Loading key for ${e.sn} of [${s.startSN}-${s.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=by,this.fragCurrent=e,a=this.keyLoader.load(e).then(e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(Vp.KEY_LOADED,e),this.state===by&&(this.state=Sy),e}),this.hls.trigger(Vp.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING"))));const o=this.fragPrevious;if(Sm(e)&&(!o||e.sn!==o.sn)){const i=this.shouldLoadParts(t.details,e.end);i!==this.loadingParts&&(this.log(`LL-Part loading ${i?"ON":"OFF"} loading sn ${null==o?void 0:o.sn}->${e.sn}`),this.loadingParts=i)}if(i=Math.max(e.start,i||0),this.loadingParts&&Sm(e)){const n=s.partList;if(n&&r){i>e.end&&s.fragmentHint&&(e=s.fragmentHint);const o=this.getNextPart(n,e,i);if(o>-1){const l=n[o];let h;return e=this.fragCurrent=l.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${l.index} (${o}/${n.length-1}) of ${this.fragInfo(e,!1,l)}) cc: ${e.cc} [${s.startSN}-${s.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=Ty,h=a?a.then(i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(e,l,t,r)).catch(e=>this.handleFragLoadError(e)):this.doFragPartsLoad(e,l,t,r).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(Vp.FRAG_LOADING,{frag:e,part:l,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):h}if(!e.url||this.loadedEndOfParts(n,i))return Promise.resolve(null)}}if(Sm(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${s?"["+s.startSN+"-"+s.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),Op(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Ty;const l=this.config.progressive;let h;return h=l&&a?a.then(t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,r)).catch(e=>this.handleFragLoadError(e)):Promise.all([this.fragmentLoader.load(e,l?r:void 0),a]).then(([e])=>(!l&&e&&r&&r(e),e)).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(Vp.FRAG_LOADING,{frag:e,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(e,t,i,r){return new Promise((n,s)=>{var a;const o=[],l=null==(a=i.details)?void 0:a.partList,h=t=>{this.fragmentLoader.loadPart(e,t,r).then(r=>{o[t.index]=r;const s=r.part;this.hls.trigger(Vp.FRAG_LOADED,r);const a=cy(i.details,e.sn,t.index+1)||dy(l,e.sn,t.index+1);if(!a)return n({frag:e,part:s,partsLoaded:o});h(a)}).catch(s)};h(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===Bp.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(Vp.ERROR,t)}else this.hls.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==My)return void(this.fragCurrent||this.state===_y||this.state===Ly||(this.state=Sy));const{frag:i,part:r,level:n}=t,s=self.performance.now();i.stats.parsing.end=s,r&&(r.stats.parsing.end=s);const a=this.getLevelDetails(),o=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);o!==this.loadingParts&&(this.log(`LL-Part loading ${o?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=o),this.updateLevelTiming(i,r,n,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(null!=e&&e.partList){var i;const n=e.partList[0];if(t>=n.end+((null==(i=e.fragmentHint)?void 0:i.duration)||0)){var r;if((this.hls.hasEnoughToStart?(null==(r=this.media)?void 0:r.currentTime)||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:r,sn:n,part:s}=e;if(null==t||!t[r])return this.warn(`Levels object was unset while buffering fragment ${n} of ${this.playlistLabel()} ${r}. The current chunk will not be buffered.`),null;const a=t[r],o=a.details,l=s>-1?cy(o,n,s):null,h=l?l.fragment:hy(o,n,i);return h?(i&&i!==h&&(h.stats=i.stats),{frag:h,part:l,level:a}):null}bufferFragmentData(e,t,i,r,n){var s;if(!e||this.state!==My)return;const{data1:a,data2:o}=e;let l=a;if(a&&o&&(l=Vm(a,o)),null==(s=l)||!s.length)return;const h={type:e.type,frag:t,part:i,chunkMeta:r,parent:t.type,data:l};if(this.hls.trigger(Vp.BUFFER_APPENDING,h),e.dropped&&e.independent&&!i){if(n)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!BufferHelper.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const i=t.currentTime,r=BufferHelper.bufferInfo(t,i,0),n=e.duration,s=Math.min(2*this.config.maxFragLookUpTolerance,.25*n),a=Math.max(Math.min(e.start-s,r.end-s),i+s);e.start-a>s&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const r=this.getLoadPosition();if(!Op(r))return null;const n=this.lastCurrentTime>r||null!=(i=this.media)&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,r,t,n)}getFwdBufferInfoAtPos(e,t,i,r){const n=BufferHelper.bufferInfo(e,t,r);if(0===n.len&&void 0!==n.nextStart){const s=this.fragmentTracker.getBufferedFrag(t,i);if(s&&(n.nextStart<=s.end||s.gap)){const i=Math.max(Math.min(n.nextStart,s.end)-t,r);return BufferHelper.bufferInfo(e,t,i)}}return n}getMaxBufferLength(e){const{config:t}=this;let i;return i=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,r=Math.max(Math.min(e-t,i.maxBufferLength),t),n=Math.max(e-3*t,i.maxMaxBufferLength/2,r);return n>=r&&(i.maxMaxBufferLength=n,this.warn(`Reduce max buffer length to ${n}s`),!0)}getAppendedFrag(e,t=Wp){var i;const r=null==(i=this.fragmentTracker)?void 0:i.getAppendedFrag(e,t);return r&&"fragment"in r?r.fragment:r}getNextFragment(e,t){const i=t.fragments,r=i.length;if(!r)return null;const{config:n}=this,s=i[0].start,a=n.lowLatencyMode&&!!t.partList;let o=null;if(t.live){const i=n.initialLiveManifestSize;if(r<i)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${i})`),null;if(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<s){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),o=this.getInitialLiveFragment(t);const i=this.hls.startPosition,r=this.hls.liveSyncPosition,n=o?(-1!==i&&i>=s?i:r)||o.start:e;this.log(`Setting startPosition to ${n} to match start frag at live edge. mainStart: ${i} liveSyncPosition: ${r} frag.start: ${null==(l=o)?void 0:l.start}`),this.startPosition=this.nextLoadPosition=n}}else e<=s&&(o=i[0]);if(!o){const i=this.loadingParts?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,i,t)}let h=this.filterReplacedPrimary(o,t);if(!h&&o){const e=o.sn-t.startSN;h=this.filterReplacedPrimary(i[e+1]||null,t)}return this.mapToInitFragWhenRequired(h)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Zg||i===Qg&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,r,n){let s=null;if(e.gap&&(s=this.getNextFragment(this.nextLoadPosition,t),s&&!s.gap&&i.nextStart)){const e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r,0);if(null!==e&&i.len+e.len>=n){const e=s.sn;return this.loopSn!==e&&(this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e}`),this.loopSn=e),null}}return this.loopSn=void 0,s}get primaryPrefetch(){if(Py(this.hls.config)){var e,t;if(null==(e=this.hls.interstitialsManager)||null==(t=e.playingItem)?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(Py(this.hls.config)&&e.type!==jp){const i=this.hls.interstitialsManager,r=null==i?void 0:i.bufferingItem;if(r){const i=r.event;if(i){if(i.appendInPlace||Math.abs(e.start-r.start)>1||0===r.start)return null}else{if(e.end<=r.start&&!1===(null==t?void 0:t.live))return null;if(e.start>r.end&&r.nextEvent&&(r.nextEvent.appendInPlace||e.start-r.end>1))return null}}const n=null==i?void 0:i.playerQueue;if(n)for(let t=n.length;t--;){const i=n[t].interstitial;if(i.appendInPlace&&e.start>=i.startTime&&e.end<=i.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,i){let r=-1,n=!1,s=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(s=s&&!o.independent,r>-1&&i<o.start)break;const l=o.loaded;l?r=-1:(n||o.independent||s)&&o.fragment===t&&(r=a),n=l}return r}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let r=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),r=function(e,t,i){if(null===t||!Array.isArray(e)||!e.length||!Op(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;for(let r=0;r<e.length;++r){const n=e[r];if(kg(t,i,n))return n}return null}(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const n=i.sn+1;if(n>=e.startSN&&n<=e.endSN){const s=t[n-e.startSN];i.cc===s.cc&&(r=s,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=Og(e,i.cc,i.end),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,i){const{config:r}=this;let{fragPrevious:n}=this,{fragments:s,endSN:a}=i;const{fragmentHint:o}=i,{maxFragLookUpTolerance:l}=r,h=i.partList,c=!!(this.loadingParts&&null!=h&&h.length&&o);let d;if(c&&o&&!this.bitrateTest&&h[h.length-1].fragment.sn===o.sn&&(s=s.concat(o),a=o.sn),e<t){var u;d=Ig(n,s,e,e<this.lastCurrentTime||e>t-l||null!=(u=this.media)&&u.paused||!this.startFragRequested?0:l)}else d=s[s.length-1];if(d){const e=d.sn-i.startSN,t=this.fragmentTracker.getState(d);if((t===Zg||t===Qg&&d.gap)&&(n=d),n&&d.sn===n.sn&&(!c||h[0].fragment.sn>d.sn||!i.live&&!c)){if(n&&d.level===n.level){const t=s[e+1];d=d.sn<a&&this.fragmentTracker.getState(t)!==Zg?t:null}}}return d}alignPlaylists(e,t,i){const r=e.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const n=e.fragmentStart,s=!t,a=e.alignedSliding&&Op(n);if(s||!a&&!n){!function(e,t){e&&(gy(t,e),!t.alignedSliding&&e&&vy(t,e),t.alignedSliding||!e||t.skippedSegments||ay(e,t,!1))}(i,e);const n=e.fragmentStart;return this.log(`Live playlist sliding: ${n.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${r}`),n}return n}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const r=this.timelineOffset;if(-1===i){const n=null!==this.startTimeOffset,s=n?this.startTimeOffset:e.startTimeOffset;null!==s&&Op(s)?(i=t+s,s<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${s} found in ${n?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+r}this.nextLoadPosition=i+r}getLoadPosition(){var e;const{media:t}=this;let i=0;return null!=(e=this.hls)&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Sm(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===xy)||(this.state=Sy)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;var r;if(this.fragContextChanged(i))return void this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const n=t.details===Bp.FRAG_GAP;n&&this.fragmentTracker.fragBuffered(i,!0);const s=t.errorAction,{action:a,flags:o,retryCount:l=0,retryConfig:h}=s||{},c=!!s&&!!h,d=c&&a===$g,u=c&&!s.resolved&&o===qg;if(!d&&u&&Sm(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),s.resolved=!0;else if((d||u)&&l<h.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const r=Fg(h,l);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${l+1}/${h.maxNumRetry} in ${r}ms`),s.resolved=!0,this.retryDate=self.performance.now()+r,this.state=xy}else if(h&&s){if(this.resetFragmentErrors(e),!(l<h.maxNumRetry))return void this.warn(`${t.details} reached or exceeded max retry (${l})`);n||a===Hg||(s.resolved=!0)}else this.state=a===zg?Ry:Ly;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===My||this.state===wy){const t=e.frag,i=e.parent,r=this.getFwdBufferInfo(this.mediaBuffer,i),n=r&&r.len>.5;n&&this.reduceMaxBufferLength(r.len,(null==t?void 0:t.duration)||10);const s=!n;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===qp&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==_y&&(this.state=Sy)}afterBufferFlushed(e,t,i){if(!e)return;const r=BufferHelper.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,i),this.state===Ay&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==_y&&(this.state=Sy)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,r){const n=i.details;if(!n)return void this.warn("level.details undefined");var s;if(!Object.keys(e.elementaryStreams).reduce((t,s)=>{const a=e.elementaryStreams[s];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${s} duration reliably (${o})`),t||!1;const l=r?0:ry(n,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(Vp.LEVEL_PTS_UPDATED,{details:n,level:i,drift:l,type:s,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t},!1)&&(0===i.fragmentError&&this.treatAsGap(e,i),null===(null==(s=this.transmuxer)?void 0:s.error))){const t=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(t.message),this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=wy,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(Vp.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===Wp?"level":"track"}fragInfo(e,t=!0,i){var r,n;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${(null!=(r=t&&!i?e.startPTS:(i||e).start)?r:NaN).toFixed(3)}-${(null!=(n=t&&!i?e.endPTS:(i||e).end)?n:NaN).toFixed(3)}]${i&&"main"===e.type?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;null==(e=this.transmuxer)||e.reset()}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function Py(e){return!!e.interstitialsController&&!1!==e.enableInterstitialPlayback}class ChunkCache{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;return e.length?(i=1===e.length?e[0]:function(e,t){const i=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++){const n=e[t];i.set(n,r),r+=n.length}return i}(e,t),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}var Iy,Dy={exports:{}};var ky=(Iy||(Iy=1,function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function s(e,t,r,s,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new n(r,s||e,a),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,n=[];if(0===this._eventsCount)return n;for(r in e=this._events)t.call(e,r)&&n.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,s=r.length,a=new Array(s);n<s;n++)a[n]=r[n].fn;return a},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,n,s,a){var o=i?i+e:e;if(!this._events[o])return!1;var l,h,c=this._events[o],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,n),!0;case 5:return c.fn.call(c.context,t,r,n,s),!0;case 6:return c.fn.call(c.context,t,r,n,s,a),!0}for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];c.fn.apply(c.context,l)}else{var u,f=c.length;for(h=0;h<f;h++)switch(c[h].once&&this.removeListener(e,c[h].fn,void 0,!0),d){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,t);break;case 3:c[h].fn.call(c[h].context,t,r);break;case 4:c[h].fn.call(c[h].context,t,r,n);break;default:if(!l)for(u=1,l=new Array(d-1);u<d;u++)l[u-1]=arguments[u];c[h].fn.apply(c[h].context,l)}}return!0},o.prototype.on=function(e,t,i){return s(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return s(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,n){var s=i?i+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||n&&!o.once||r&&o.context!==r||a(this,s);else{for(var l=0,h=[],c=o.length;l<c;l++)(o[l].fn!==t||n&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[s]=1===h.length?h[0]:h:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(Dy)),Dy.exports),Oy=lm(ky);const Uy="1.6.5",Ny={};function Fy(e,t){return t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function By(e,t){return t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function Vy(e,t){let i=0;return i=(127&e[t])<<21,i|=(127&e[t+1])<<14,i|=(127&e[t+2])<<7,i|=127&e[t+3],i}function Gy(e,t){const i=t;let r=0;for(;By(e,t);){r+=10;r+=Vy(e,t+6),Fy(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(i,i+r)}function zy(e,t){return 255===e[t]&&240==(246&e[t+1])}function Hy(e,t){return 1&e[t+1]?7:9}function $y(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function Wy(e,t){return t+1<e.length&&zy(e,t)}function qy(e,t){if(Wy(e,t)){const i=Hy(e,t);if(t+i>=e.length)return!1;const r=$y(e,t);if(r<=i)return!1;const n=t+r;return n===e.length||Wy(e,n)}return!1}function jy(e,t,i,r,n){if(!e.samplerate){const s=function(e,t,i,r){const n=t[i+2],s=n>>2&15;if(s>12){const t=new Error(`invalid ADTS sampling index:${s}`);return void e.emit(Vp.ERROR,Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}const a=1+(n>>6&3),o=t[i+3]>>6&3|(1&n)<<2,l="mp4a.40."+a,h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][s];let c=s;5!==a&&29!==a||(c-=3);const d=[a<<3|(14&c)>>1,(1&c)<<7|o<<3];return rm.log(`manifest codec:${r}, parsed codec:${l}, channels:${o}, rate:${h} (ADTS object type:${a} sampling index:${s})`),{config:d,samplerate:h,channelCount:o,codec:l,parsedCodec:l,manifestCodec:r}}(t,i,r,n);if(!s)return;Yp(e,s)}}function Ky(e){return 9216e4/e}function Yy(e,t,i,r,n){const s=r+n*Ky(e.samplerate),a=function(e,t){const i=Hy(e,t);if(t+i<=e.length){const r=$y(e,t)-i;if(r>0)return{headerLength:i,frameLength:r}}}(t,i);let o;if(a){const{frameLength:r,headerLength:n}=a,l=n+r,h=Math.max(0,i+l-t.length);h?(o=new Uint8Array(l-n),o.set(t.subarray(i+n,t.length),0)):o=t.subarray(i+n,i+l);const c={unit:o,pts:s};return h||e.samples.push(c),{sample:c,length:l,missing:h}}const l=t.length-i;o=new Uint8Array(l),o.set(t.subarray(i,t.length),0);return{sample:{unit:o,pts:s},length:l,missing:-1}}function Xy(e,t){return By(e,t)&&Vy(e,t+6)+10<=e.length-t}function Qy(e,t=0,i=1/0){return function(e,t,i,r){const n=function(e){return e instanceof ArrayBuffer?e:e.buffer}(e);let s=1;"BYTES_PER_ELEMENT"in r&&(s=r.BYTES_PER_ELEMENT);const a=(d=e,d&&d.buffer instanceof ArrayBuffer&&void 0!==d.byteLength&&void 0!==d.byteOffset?e.byteOffset:0),o=(a+e.byteLength)/s,l=(a+t)/s,h=Math.floor(Math.max(0,Math.min(l,o))),c=Math.floor(Math.min(h+Math.max(i,0),o));var d;return new r(n,h,c-h)}(e,t,i,Uint8Array)}function Zy(e){const t={key:e.type,description:"",data:"",mimeType:null,pictureType:null};if(e.size<2)return;if(3!==e.data[0])return void console.log("Ignore frame with unrecognized character encoding");const i=e.data.subarray(1).indexOf(0);if(-1===i)return;const r=am(Qy(e.data,1,i)),n=e.data[2+i],s=e.data.subarray(3+i).indexOf(0);if(-1===s)return;const a=am(Qy(e.data,3+i,s));let o;return o="--\x3e"===r?am(Qy(e.data,4+i+s)):function(e){return e instanceof ArrayBuffer?e:0==e.byteOffset&&e.byteLength==e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer}(e.data.subarray(4+i+s)),t.mimeType=r,t.pictureType=n,t.description=a,t.data=o,t}function Jy(e){return"PRIV"===e.type?function(e){if(e.size<2)return;const t=am(e.data,!0),i=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:i.buffer}}(e):"W"===e.type[0]?function(e){if("WXXX"===e.type){if(e.size<2)return;let t=1;const i=am(e.data.subarray(t),!0);t+=i.length+1;const r=am(e.data.subarray(t));return{key:e.type,info:i,data:r}}const t=am(e.data);return{key:e.type,info:"",data:t}}(e):"APIC"===e.type?Zy(e):function(e){if(e.size<2)return;if("TXXX"===e.type){let t=1;const i=am(e.data.subarray(t),!0);t+=i.length+1;const r=am(e.data.subarray(t));return{key:e.type,info:i,data:r}}const t=am(e.data.subarray(1));return{key:e.type,info:"",data:t}}(e)}function e_(e){const t=String.fromCharCode(e[0],e[1],e[2],e[3]),i=Vy(e,4);return{type:t,size:i,data:e.subarray(10,10+i)}}function t_(e){let t=0;const i=[];for(;By(e,t);){const r=Vy(e,t+6);e[t+5]>>6&1&&(t+=10),t+=10;const n=t+r;for(;t+10<n;){const r=e_(e.subarray(t)),n=Jy(r);n&&i.push(n),t+=r.size+10}Fy(e,t)&&(t+=10)}return i}function i_(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info}function r_(e){if(8===e.data.byteLength){const t=new Uint8Array(e.data),i=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,i&&(r+=47721858.84),Math.round(r)}}function n_(e){const t=t_(e);for(let e=0;e<t.length;e++){const i=t[e];if(i_(i))return r_(i)}}let s_=function(e){return e.audioId3="org.id3",e.dateRange="com.apple.quicktime.HLS",e.emsg="https://aomedia.org/emsg/ID3",e.misbklv="urn:misb:KLV:bin:1910.1",e}({});function a_(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class BaseAudioDemuxer{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Vm(this.cachedData,e),this.cachedData=null);let i,r=Gy(e,0),n=r?r.length:0;const s=this._audioTrack,a=this._id3Track,o=r?n_(r):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&Op(o))&&(this.basePTS=o_(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:s_.audioId3,duration:Number.POSITIVE_INFINITY});n<l;){if(this.canParse(e,n)){const t=this.appendFrame(s,e,n);t?(this.frameIndex++,this.lastPTS=t.sample.pts,n+=t.length,i=n):n=l}else Xy(e,n)?(r=Gy(e,n),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:s_.audioId3,duration:Number.POSITIVE_INFINITY}),n+=r.length,i=n):n++;if(n===l&&i!==l){const t=e.slice(i);this.cachedData?this.cachedData=Vm(this.cachedData,t):this.cachedData=t}}return{audioTrack:s,videoTrack:a_(),id3Track:a,textTrack:a_()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:a_(),id3Track:this._id3Track,textTrack:a_()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const o_=(e,t,i)=>{if(Op(e))return 90*e;return 9e4*t+(i?9e4*i.baseTime/i.timescale:0)};let l_=null;const h_=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],c_=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],d_=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],u_=[0,1,1,4];function f_(e,t,i,r,n){if(i+24>t.length)return;const s=p_(t,i);if(s&&i+s.frameLength<=t.length){const a=r+n*(9e4*s.samplesPerFrame/s.sampleRate),o={unit:t.subarray(i,i+s.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=s.channelCount,e.samplerate=s.sampleRate,e.samples.push(o),{sample:o,length:s.frameLength,missing:0}}}function p_(e,t){const i=e[t+1]>>3&3,r=e[t+1]>>1&3,n=e[t+2]>>4&15,s=e[t+2]>>2&3;if(1!==i&&0!==n&&15!==n&&3!==s){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*h_[14*(3===i?3-r:3===r?3:4)+n-1],h=c_[3*(3===i?0:2===i?1:2)+s],c=3===o?1:2,d=d_[i][r],u=u_[r],f=8*d*u,p=Math.floor(d*l/h+a)*u;if(null===l_){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);l_=e?parseInt(e[1]):0}return!!l_&&l_<=87&&2===r&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:h,channelCount:c,frameLength:p,samplesPerFrame:f}}}function m_(e,t){return!(255!==e[t]||224&~e[t+1]||!(6&e[t+1]))}function g_(e,t){return t+1<e.length&&m_(e,t)}function v_(e,t){if(t+1<e.length&&m_(e,t)){const i=4,r=p_(e,t);let n=i;null!=r&&r.frameLength&&(n=r.frameLength);const s=t+n;return s===e.length||g_(e,s)}return!1}const y_=(e,t)=>{let i=0,r=5;t+=r;const n=new Uint32Array(1),s=new Uint32Array(1),a=new Uint8Array(1);for(;r>0;){a[0]=e[t];const o=Math.min(r,8),l=8-o;s[0]=4278190080>>>24+l<<l,n[0]=(a[0]&s[0])>>l,i=i?i<<o|n[0]:n[0],t+=1,r-=o}return i};class AC3Demuxer extends BaseAudioDemuxer{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const r=__(e,t,i,this.basePTS,this.frameIndex);if(-1!==r){return{sample:e.samples[e.samples.length-1],length:r,missing:0}}}static probe(e){if(!e)return!1;const t=Gy(e,0);if(!t)return!1;const i=t.length;return 11===e[i]&&119===e[i+1]&&void 0!==n_(t)&&y_(e,i)<16}}function __(e,t,i,r,n){if(i+8>t.length)return-1;if(11!==t[i]||119!==t[i+1])return-1;const s=t[i+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],o=63&t[i+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+s];if(i+l>t.length)return-1;const h=t[i+6]>>5;let c=0;2===h?c+=2:(1&h&&1!==h&&(c+=2),4&h&&(c+=2));const d=(t[i+6]<<8|t[i+7])>>12-c&1,u=[2,1,2,3,3,4,4,5][h]+d,f=t[i+5]>>3,p=7&t[i+5],m=new Uint8Array([s<<6|f<<1|p>>2,(3&p)<<6|h<<3|d<<2|o>>4,o<<4&224]),g=r+n*(1536/a*9e4),v=t.subarray(i,i+l);return e.config=m,e.channelCount=u,e.samplerate=a,e.samples.push({unit:v,pts:g}),l}const S_=/\/emsg[-/]ID3/i;function b_(e,t){return Op(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale}class SampleAesDecrypter{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Decrypter(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,iv)}decryptAacSample(e,t,i){const r=e[t].unit;if(r.length<=16)return;const n=r.subarray(16,r.length-r.length%16),s=n.buffer.slice(n.byteOffset,n.byteOffset+n.length);this.decryptBuffer(s).then(n=>{const s=new Uint8Array(n);r.set(s,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length)return void i();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,i=new Int8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)i.set(e.subarray(t,t+16),r);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)e.set(i.subarray(r,r+16),t);return e}decryptAvcSample(e,t,i,r,n){const s=Wm(n.data),a=this.getAvcEncryptedData(s);this.decryptBuffer(a.buffer).then(a=>{n.data=this.getAvcDecryptedUnit(s,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,r)})}decryptAvcSamples(e,t,i,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length)return void r();const n=e[t].units;for(;!(i>=n.length);i++){const s=n[i];if(!(s.data.length<=48||1!==s.type&&5!==s.type||(this.decryptAvcSample(e,t,i,r,s),this.decrypter.isSync())))return}}}}class BaseVideoParser{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i,r=this.VideoSample;if(r&&0!==r.units.length||(r=e[e.length-1]),null!=(t=r)&&t.units){const e=r.units;i=e[e.length-1]}return i}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const i=t.samples,r=i.length;if(!r)return void t.dropped++;{const t=i[r-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}}parseNALu(e,t,i){const r=t.byteLength;let n=e.naluState||0;const s=n,a=[];let o,l,h,c=0,d=-1,u=0;for(-1===n&&(d=0,u=this.getNALuType(t,0),n=0,c=1);c<r;)if(o=t[c++],n)if(1!==n)if(o)if(1===o){if(l=c-n-1,d>=0){const e={data:t.subarray(d,l),type:u};a.push(e)}else{const i=this.getLastNalUnit(e.samples);i&&(s&&c<=4-s&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-s)),l>0&&(i.data=Vm(i.data,t.subarray(0,l)),i.state=0))}c<r?(h=this.getNALuType(t,c),d=c,u=h,n=0):n=-1}else n=0;else n=3;else n=o?0:2;else n=o?0:1;if(d>=0&&n>=0){const e={data:t.subarray(d,r),type:u,state:n};a.push(e)}if(0===a.length){const i=this.getLastNalUnit(e.samples);i&&(i.data=Vm(i.data,t))}return e.naluState=n,a}}class ExpGolomb{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),n=Math.min(4,t);if(0===n)throw new Error("no bytes available");r.set(e.subarray(i,i+n)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*n,this.bytesAvailable-=n}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&rm.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class AvcVideoParser extends BaseVideoParser{parsePES(e,t,i,r){const n=this.parseNALu(e,i.data,r);let s,a=this.VideoSample,o=!1;i.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),n.forEach(r=>{var n,l;switch(r.type){case 1:{let t=!1;s=!0;const n=r.data;if(o&&n.length>4){const e=this.readSliceType(n);2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var h;if(t)null!=(h=a)&&h.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.frame=!0,a.key=t;break}case 5:s=!0,null!=(n=a)&&n.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 6:s=!0,$m(r.data,1,i.pts,t.samples);break;case 7:{var c,d;s=!0,o=!0;const t=r.data,i=this.readSPS(t);if(!e.sps||e.width!==i.width||e.height!==i.height||(null==(c=e.pixelRatio)?void 0:c[0])!==i.pixelRatio[0]||(null==(d=e.pixelRatio)?void 0:d[1])!==i.pixelRatio[1]){e.width=i.width,e.height=i.height,e.pixelRatio=i.pixelRatio,e.sps=[t];const r=t.subarray(1,4);let n="avc1.";for(let e=0;e<3;e++){let t=r[e].toString(16);t.length<2&&(t="0"+t),n+=t}e.codec=n}break}case 8:s=!0,e.pps=[r.data];break;case 9:s=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:s=!0;break;default:s=!1}if(a&&s){a.units.push(r)}}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return 31&e[t]}readSliceType(e){const t=new ExpGolomb(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i,r=8,n=8;for(let s=0;s<e;s++)0!==n&&(i=t.readEG(),n=(r+i+256)%256),r=0===n?r:n}readSPS(e){const t=new ExpGolomb(e);let i,r,n,s=0,a=0,o=0,l=0;const h=t.readUByte.bind(t),c=t.readBits.bind(t),d=t.readUEG.bind(t),u=t.readBoolean.bind(t),f=t.skipBits.bind(t),p=t.skipEG.bind(t),m=t.skipUEG.bind(t),g=this.skipScalingList.bind(this);h();const v=h();if(c(5),f(3),h(),m(),100===v||110===v||122===v||244===v||44===v||83===v||86===v||118===v||128===v){const e=d();if(3===e&&f(1),m(),m(),f(1),u())for(r=3!==e?8:12,n=0;n<r;n++)u()&&g(n<6?16:64,t)}m();const y=d();if(0===y)d();else if(1===y)for(f(1),p(),p(),i=d(),n=0;n<i;n++)p();m(),f(1);const _=d(),S=d(),b=c(1);0===b&&f(1),f(1),u()&&(s=d(),a=d(),o=d(),l=d());let T=[1,1];if(u()&&u()){switch(h()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[h()<<8|h(),h()<<8|h()]}}return{width:Math.ceil(16*(_+1)-2*s-2*a),height:(2-b)*(S+1)*16-(b?2:4)*(o+l),pixelRatio:T}}}class HevcVideoParser extends BaseVideoParser{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,r){const n=this.parseNALu(e,i.data,r);let s,a=this.VideoSample,o=!1;i.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),n.forEach(r=>{var n,l;switch(r.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),a.frame=!0,s=!0;break;case 16:case 17:case 18:case 21:var h;if(s=!0,o)null!=(h=a)&&h.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 19:case 20:s=!0,null!=(n=a)&&n.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 39:s=!0,$m(r.data,2,i.pts,t.samples);break;case 32:s=!0,e.vps||("object"!=typeof e.params&&(e.params={}),e.params=Yp(e.params,this.readVPS(r.data)),this.initVPS=r.data),e.vps=[r.data];break;case 33:if(s=!0,o=!0,void 0===e.vps||e.vps[0]===this.initVPS||void 0===e.sps||this.matchSPS(e.sps[0],r.data)||(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const t=this.readSPS(r.data);e.width=t.width,e.height=t.height,e.pixelRatio=t.pixelRatio,e.codec=t.codecString,e.sps=[],"object"!=typeof e.params&&(e.params={});for(const i in t.params)e.params[i]=t.params[i]}this.pushParameterSet(e.sps,r.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0;break;case 34:if(s=!0,"object"==typeof e.params){if(!e.pps){e.pps=[];const t=this.readPPS(r.data);for(const i in t)e.params[i]=t[i]}this.pushParameterSet(e.pps,r.data,e.vps)}break;case 35:s=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:s=!1}if(a&&s){a.units.push(r)}}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(126&e[t])>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let r=0;r<e.byteLength;r++)r>=2&&3===e[r]&&0===e[r-1]&&0===e[r-2]||(t[i]=e[r],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new ExpGolomb(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);return{numTemporalLayers:t.readBits(3)+1,temporalIdNested:t.readBoolean()}}readSPS(e){const t=new ExpGolomb(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const r=t.readBits(2),n=t.readBoolean(),s=t.readBits(5),a=t.readUByte(),o=t.readUByte(),l=t.readUByte(),h=t.readUByte(),c=t.readUByte(),d=t.readUByte(),u=t.readUByte(),f=t.readUByte(),p=t.readUByte(),m=t.readUByte(),g=t.readUByte(),v=[],y=[];for(let e=0;e<i;e++)v.push(t.readBoolean()),y.push(t.readBoolean());if(i>0)for(let e=i;e<8;e++)t.readBits(2);for(let e=0;e<i;e++)v[e]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),y[e]&&t.readUByte();t.readUEG();const _=t.readUEG();3==_&&t.skipBits(1);const S=t.readUEG(),b=t.readUEG(),T=t.readBoolean();let x=0,E=0,M=0,w=0;T&&(x+=t.readUEG(),E+=t.readUEG(),M+=t.readUEG(),w+=t.readUEG());const A=t.readUEG(),L=t.readUEG(),C=t.readUEG();for(let e=t.readBoolean()?0:i;e<=i;e++)t.skipUEG(),t.skipUEG(),t.skipUEG();t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.readBoolean()){if(t.readBoolean())for(let e=0;e<4;e++)for(let i=0;i<(3===e?2:6);i++){if(t.readBoolean()){const i=Math.min(64,1<<4+(e<<1));e>1&&t.readEG();for(let e=0;e<i;e++)t.readEG()}else t.readUEG()}}t.readBoolean(),t.readBoolean();t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const R=t.readUEG();let P=0;for(let e=0;e<R;e++){let i=!1;if(0!==e&&(i=t.readBoolean()),i){e===R&&t.readUEG(),t.readBoolean(),t.readUEG();let i=0;for(let e=0;e<=P;e++){const e=t.readBoolean();let r=!1;e||(r=t.readBoolean()),(e||r)&&i++}P=i}else{const e=t.readUEG(),i=t.readUEG();P=e+i;for(let i=0;i<e;i++)t.readUEG(),t.readBoolean();for(let e=0;e<i;e++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const e=t.readUEG();for(let i=0;i<e;i++){for(let e=0;e<C+4;e++)t.readBits(1);t.readBits(1)}}let D=0,k=1,O=1,U=!0,N=1,F=0;t.readBoolean(),t.readBoolean();let B=!1;if(t.readBoolean()){if(t.readBoolean()){const e=t.readUByte();e>0&&e<16?(k=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],O=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(k=t.readBits(16),O=t.readBits(16))}t.readBoolean()&&t.readBoolean();if(t.readBoolean()){t.readBits(3),t.readBoolean();t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())}t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),B=t.readBoolean(),B&&(x+=t.readUEG(),E+=t.readUEG(),M+=t.readUEG(),w+=t.readUEG());if(t.readBoolean()){N=t.readBits(32),F=t.readBits(32);t.readBoolean()&&t.readUEG();if(t.readBoolean()){const e=t.readBoolean(),r=t.readBoolean();let n=!1;(e||r)&&(n=t.readBoolean(),n&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),n&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let s=0;s<=i;s++){U=t.readBoolean();let i=!1;U||t.readBoolean()?t.readEG():i=t.readBoolean();const s=i?1:t.readUEG()+1;if(e)for(let e=0;e<s;e++)t.readUEG(),t.readUEG(),n&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(r)for(let e=0;e<s;e++)t.readUEG(),t.readUEG(),n&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),D=t.readUEG())}let V=S,G=b;if(T||B){let e=1,t=1;1===_?e=t=2:2==_&&(e=2),V=S-e*E-e*x,G=b-t*w-t*M}const z=r?["A","B","C"][r]:"",H=a<<24|o<<16|l<<8|h;let $=0;for(let e=0;e<32;e++)$=($|(H>>e&1)<<31-e)>>>0;let W=$.toString(16);1===s&&"2"===W&&(W="6");return{codecString:`hvc1.${z}${s}.${W}.${n?"H":"L"}${g}.B0`,params:{general_tier_flag:n,general_profile_idc:s,general_profile_space:r,general_profile_compatibility_flags:[a,o,l,h],general_constraint_indicator_flags:[c,d,u,f,p,m],general_level_idc:g,bit_depth:A+8,bit_depth_luma_minus8:A,bit_depth_chroma_minus8:L,min_spatial_segmentation_idc:D,chroma_format_idc:_,frame_rate:{fixed:U,fps:F/N}},width:V,height:G,pixelRatio:[k,O]}}readPPS(e){const t=new ExpGolomb(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2);t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const i=t.readBoolean(),r=t.readBoolean();let n=1;return r&&i?n=0:r?n=3:i&&(n=2),{parallelismType:n}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const T_=188;class TSDemuxer{constructor(e,t,i,r){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=r,this.videoParser=null}static probe(e,t){const i=TSDemuxer.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),-1!==i}static syncOffset(e){const t=e.length;let i=Math.min(940,t-T_)+1,r=0;for(;r<i;){let n=!1,s=-1,a=0;for(let o=r;o<t;o+=T_){if(71!==e[o]||t-o!==T_&&71!==e[o+T_]){if(a)return-1;break}if(a++,-1===s&&(s=o,0!==s&&(i=Math.min(s+18612,e.length-T_)+1)),n||(n=0===x_(e,o)),n&&a>1&&(0===s&&a>2||o+T_>i))return s}r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Em[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,i,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=TSDemuxer.createTrack("video"),this._videoTrack.duration=r,this._audioTrack=TSDemuxer.createTrack("audio",r),this._id3Track=TSDemuxer.createTrack("id3"),this._txtTrack=TSDemuxer.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,r=!1){let n;i||(this.sampleAes=null);const s=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let h=s.pid,c=s.pesData,d=a.pid,u=o.pid,f=a.pesData,p=o.pesData,m=null,g=this.pmtParsed,v=this._pmtId,y=e.length;if(this.remainderData&&(y=(e=Vm(this.remainderData,e)).length,this.remainderData=null),y<T_&&!r)return this.remainderData=e,{audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};const _=Math.max(0,TSDemuxer.syncOffset(e));y-=(y-_)%T_,y<e.byteLength&&!r&&(this.remainderData=new Uint8Array(e.buffer,y,e.buffer.byteLength-y));let S=0;for(let t=_;t<y;t+=T_)if(71===e[t]){const r=!!(64&e[t+1]),y=x_(e,t);let S;if((48&e[t+3])>>4>1){if(S=t+5+e[t+4],S===t+T_)continue}else S=t+4;switch(y){case h:if(r){if(c&&(n=L_(c,this.logger))){if(null===this.videoParser)switch(s.segmentCodec){case"avc":this.videoParser=new AvcVideoParser;break;case"hevc":this.videoParser=new HevcVideoParser}null!==this.videoParser&&this.videoParser.parsePES(s,l,n,!1)}c={data:[],size:0}}c&&(c.data.push(e.subarray(S,t+T_)),c.size+=t+T_-S);break;case d:if(r){if(f&&(n=L_(f,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,n);break;case"mp3":this.parseMPEGPES(a,n);break;case"ac3":this.parseAC3PES(a,n)}f={data:[],size:0}}f&&(f.data.push(e.subarray(S,t+T_)),f.size+=t+T_-S);break;case u:r&&(p&&(n=L_(p,this.logger))&&this.parseID3PES(o,n),p={data:[],size:0}),p&&(p.data.push(e.subarray(S,t+T_)),p.size+=t+T_-S);break;case 0:r&&(S+=e[S]+1),v=this._pmtId=E_(e,S);break;case v:{r&&(S+=e[S]+1);const n=M_(e,S,this.typeSupported,i,this.observer,this.logger);h=n.videoPid,h>0&&(s.pid=h,s.segmentCodec=n.segmentVideoCodec),d=n.audioPid,d>0&&(a.pid=d,a.segmentCodec=n.segmentAudioCodec),u=n.id3Pid,u>0&&(o.pid=u),null===m||g||(this.logger.warn(`MPEG-TS PMT found at ${t} after unknown PID '${m}'. Backtracking to sync byte @${_} to parse all TS packets.`),m=null,t=_-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=y}}else S++;S>0&&w_(this.observer,new Error(`Found ${S} TS packet/s that do not start with 0x47`),void 0,this.logger),s.pesData=c,a.pesData=f,o.pesData=p;const b={audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(b),b}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:r,textTrack:n}=e,s=i.pesData,a=t.pesData,o=r.pesData;let l;if(s&&(l=L_(s,this.logger))){if(null===this.videoParser)switch(i.segmentCodec){case"avc":this.videoParser=new AvcVideoParser;break;case"hevc":this.videoParser=new HevcVideoParser}null!==this.videoParser&&(this.videoParser.parsePES(i,n,l,!0),i.pesData=null)}else i.pesData=s;if(a&&(l=L_(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=a&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=L_(o,this.logger))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(e,t,i){const r=this.demux(e,i,!0,!this.config.progressive),n=this.sampleAes=new SampleAesDecrypter(this.observer,this.config,t);return this.decrypt(r,n)}decrypt(e,t){return new Promise(i=>{const{audioTrack:r,videoTrack:n}=e;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,()=>{n.samples?t.decryptAvcSamples(n.samples,0,0,()=>{i(e)}):i(e)}):n.samples&&t.decryptAvcSamples(n.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const r=this.aacOverFlow;let n,s,a,o=t.data;if(r){this.aacOverFlow=null;const t=r.missing,n=r.sample.unit.byteLength;if(-1===t)o=Vm(r.sample.unit,o);else{const s=n-t;r.sample.unit.set(o.subarray(0,t),s),e.samples.push(r.sample),i=r.missing}}for(n=i,s=o.length;n<s-1&&!Wy(o,n);n++);if(n!==i){let e;const t=n<s-1;if(e=t?`AAC PES did not start with ADTS header,offset:${n}`:"No ADTS header found in AAC PES",w_(this.observer,new Error(e),t,this.logger),!t)return}if(jy(e,this.observer,o,n,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!r)return void this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=Ky(e.samplerate);a=r.sample.pts+t}}let l,h=0;for(;n<s;){if(l=Yy(e,o,n,a,h),n+=l.length,l.missing){this.aacOverFlow=l;break}for(h++;n<s-1&&!Wy(o,n);n++);}}parseMPEGPES(e,t){const i=t.data,r=i.length;let n=0,s=0;const a=t.pts;if(void 0!==a)for(;s<r;)if(g_(i,s)){const t=f_(e,i,s,a,n);if(!t)break;s+=t.length,n++}else s++;else this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const i=t.data,r=t.pts;if(void 0===r)return void this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");const n=i.length;let s,a=0,o=0;for(;o<n&&(s=__(e,i,o,r,a++))>0;)o+=s}}parseID3PES(e,t){if(void 0===t.pts)return void this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");const i=Yp({},t,{type:this._videoTrack?s_.emsg:s_.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function x_(e,t){return((31&e[t+1])<<8)+e[t+2]}function E_(e,t){return(31&e[t+10])<<8|e[t+11]}function M_(e,t,i,r,n,s){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<o;){const o=x_(e,t),l=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!r){A_("ADTS AAC",s);break}case 15:-1===a.audioPid&&(a.audioPid=o);break;case 21:-1===a.id3Pid&&(a.id3Pid=o);break;case 219:if(!r){A_("H.264",s);break}case 27:-1===a.videoPid&&(a.videoPid=o);break;case 3:case 4:i.mpeg||i.mp3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="mp3"):s.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){A_("AC-3",s);break}case 129:i.ac3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="ac3"):s.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===a.audioPid&&l>0){let r=t+5,n=l;for(;n>2;){if(106===e[r])!0!==i.ac3?s.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=o,a.segmentAudioCodec="ac3");const t=e[r+1]+2;r+=t,n-=t}}break;case 194:case 135:return w_(n,new Error("Unsupported EC-3 in M2TS found"),void 0,s),a;case 36:-1===a.videoPid&&(a.videoPid=o,a.segmentVideoCodec="hevc",s.log("HEVC in M2TS found"))}t+=l+5}return a}function w_(e,t,i,r){r.warn(`parsing error: ${t.message}`),e.emit(Vp.ERROR,Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_PARSING_ERROR,fatal:!1,levelRetry:i,error:t,reason:t.message})}function A_(e,t){t.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function L_(e,t){let i,r,n,s,a,o=0;const l=e.data;if(!e||0===e.size)return null;for(;l[0].length<19&&l.length>1;)l[0]=Vm(l[0],l[1]),l.splice(1,1);i=l[0];if(1===(i[0]<<16)+(i[1]<<8)+i[2]){if(r=(i[4]<<8)+i[5],r&&r>e.size-6)return null;const h=i[7];192&h&&(s=536870912*(14&i[9])+4194304*(255&i[10])+16384*(254&i[11])+128*(255&i[12])+(254&i[13])/2,64&h?(a=536870912*(14&i[14])+4194304*(255&i[15])+16384*(254&i[16])+128*(255&i[17])+(254&i[18])/2,s-a>54e5&&(t.warn(`${Math.round((s-a)/9e4)}s delta between PTS and DTS, align them`),s=a)):a=s),n=i[8];let c=n+9;if(e.size<=c)return null;e.size-=c;const d=new Uint8Array(e.size);for(let e=0,t=l.length;e<t;e++){i=l[e];let t=i.byteLength;if(c){if(c>t){c-=t;continue}i=i.subarray(c),t-=c,c=0}d.set(i,o),o+=t}return r&&(r-=n+3),{data:d,pts:s,dts:a,len:r}}return null}class AAC{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const C_=Math.pow(2,32)-1;class MP4{static init(){let e;for(e in MP4.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(e)&&(MP4.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:t,audio:i};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=n,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const s=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,s,o,s,a),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,r))}static box(e,...t){let i=8,r=t.length;const n=r;for(;r--;)i+=t[r].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=255&i,s.set(e,4),r=0,i=8;r<n;r++)s.set(t[r],i),i+=t[r].byteLength;return s}static hdlr(e){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[e])}static mdat(e){return MP4.box(MP4.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(C_+1)),r=Math.floor(t%(C_+1));return MP4.box(MP4.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return MP4.box(MP4.types.mdia,MP4.mdhd(e.timescale||0,e.duration||0),MP4.hdlr(e.type),MP4.minf(e))}static mfhd(e){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(e)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(e))}static moof(e,t,i){return MP4.box(MP4.types.moof,MP4.mfhd(e),MP4.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=MP4.trak(e[t]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(MP4.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=MP4.trex(e[t]);return MP4.box.apply(null,[MP4.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(C_+1)),r=Math.floor(t%(C_+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,n)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let r,n;for(r=0;r<t.length;r++)n=t[r].flags,i[r+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return MP4.box(MP4.types.sdtp,i)}static stbl(e){return MP4.box(MP4.types.stbl,MP4.stsd(e),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}static avc1(e){let t,i,r,n=[],s=[];for(t=0;t<e.sps.length;t++)i=e.sps[t],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));for(t=0;t<e.pps.length;t++)i=e.pps[t],r=i.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));const a=MP4.box(MP4.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.sps.length].concat(n).concat([e.pps.length]).concat(s))),o=e.width,l=e.height,h=e.pixelRatio[0],c=e.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return MP4.box(MP4.types.mp4a,MP4.audioStsd(e),MP4.box(MP4.types.esds,MP4.esds(e)))}static mp3(e){return MP4.box(MP4.types[".mp3"],MP4.audioStsd(e))}static ac3(e){return MP4.box(MP4.types["ac-3"],MP4.audioStsd(e),MP4.box(MP4.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if("audio"===e.type){if("aac"===t)return MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(e));if("ac3"===t&&e.config)return MP4.box(MP4.types.stsd,MP4.STSD,MP4.ac3(e));if("mp3"===t&&"mp3"===e.codec)return MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(e))}else{if(!e.pps||!e.sps)throw new Error("video track missing pps or sps");if("avc"===t)return MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(e));if("hevc"===t&&e.vps)return MP4.box(MP4.types.stsd,MP4.STSD,MP4.hvc1(e))}throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),r=e.width||0,n=e.height||0,s=Math.floor(i/(C_+1)),a=Math.floor(i%(C_+1));return MP4.box(MP4.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,n>>8&255,255&n,0,0]))}static traf(e,t){const i=MP4.sdtp(e),r=e.id,n=Math.floor(t/(C_+1)),s=Math.floor(t%(C_+1));return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),MP4.box(MP4.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,s>>24,s>>16&255,s>>8&255,255&s])),MP4.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(e),MP4.mdia(e))}static trex(e){const t=e.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],r=i.length,n=12+16*r,s=new Uint8Array(n);let a,o,l,h,c,d;for(t+=8+n,s.set(["video"===e.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)o=i[a],l=o.duration,h=o.size,c=o.flags,d=o.cts,s.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,h>>>24&255,h>>>16&255,h>>>8&255,255&h,c.isLeading<<2|c.dependsOn,c.isDependedOn<<6|c.hasRedundancy<<4|c.paddingValue<<1|c.isNonSync,61440&c.degradPrio,15&c.degradPrio,d>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*a);return MP4.box(MP4.types.trun,s)}static initSegment(e){MP4.types||MP4.init();const t=MP4.moov(e);return Vm(MP4.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),3|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let n=r.length;for(let e=0;e<i.length;e+=1){n+=3;for(let t=0;t<i[e].length;t+=1)n+=2+i[e][t].length}const s=new Uint8Array(n);s.set(r,0),n=r.length;const a=i.length-1;for(let e=0;e<i.length;e+=1){s.set(new Uint8Array([32+e|(e===a?128:0),0,i[e].length]),n),n+=3;for(let t=0;t<i[e].length;t+=1)s.set(new Uint8Array([i[e][t].length>>8,255&i[e][t].length]),n),n+=2,s.set(i[e][t],n),n+=i[e][t].length}const o=MP4.box(MP4.types.hvcC,s),l=e.width,h=e.height,c=e.pixelRatio[0],d=e.pixelRatio[1];return MP4.box(MP4.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d])))}}MP4.types=void 0,MP4.HDLR_TYPES=void 0,MP4.STTS=void 0,MP4.STSC=void 0,MP4.STCO=void 0,MP4.STSZ=void 0,MP4.VMHD=void 0,MP4.SMHD=void 0,MP4.STSD=void 0,MP4.FTYP=void 0,MP4.DINF=void 0;function R_(e,t,i=1,r=!1){const n=e*t*i;return r?Math.round(n):n}function P_(e,t=!1){return R_(e,1e3,1/9e4,t)}let I_,D_=null,k_=null;function O_(e,t,i,r){return{duration:t,size:i,cts:r,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class MP4Remuxer{constructor(e,t,i,r){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=r,this.ISGenerated=!1,null===D_){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);D_=e?parseInt(e[1]):0}if(null===k_){const e=navigator.userAgent.match(/Safari\/(\d+)/i);k_=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,r=e.reduce((e,r)=>{let n=r.pts,s=n-e;return s<-4294967296&&(t=!0,n=U_(n,i),s=n-e),s>0?e:n},i);return t&&this.logger.debug("PTS rollover detected"),r}remux(e,t,i,r,n,s,a,o){let l,h,c,d,u,f,p=n,m=n;const g=e.pid>-1,v=t.pid>-1,y=t.samples.length,_=e.samples.length>0,S=a&&y>0||y>1;if((!g||_)&&(!v||S)||this.ISGenerated||a){if(this.ISGenerated){var b,T,x,E;const e=this.videoTrackConfig;(e&&(t.width!==e.width||t.height!==e.height||(null==(b=t.pixelRatio)?void 0:b[0])!==(null==(T=e.pixelRatio)?void 0:T[0])||(null==(x=t.pixelRatio)?void 0:x[1])!==(null==(E=e.pixelRatio)?void 0:E[1]))||!e&&S||null===this.nextAudioPts&&_)&&this.resetInitSegment()}this.ISGenerated||(c=this.generateIS(e,t,n,s));const i=this.isVideoContiguous;let r,a=-1;if(S&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){this.logger.warn(`[mp4-remuxer]: Dropped ${a} out of ${y} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,m+=(t.samples[0].pts-e)/t.inputTimeScale,r=m}else-1===a&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${y} video samples`),f=!1);if(this.ISGenerated){if(_&&S){const i=this.getVideoStartPts(t.samples),r=(U_(e.samples[0].pts,i)-i)/t.inputTimeScale;p+=Math.max(0,r),m+=Math.max(0,-r)}if(_){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),c=this.generateIS(e,t,n,s)),h=this.remuxAudio(e,p,this.isAudioContiguous,s,v||S||o===qp?m:void 0),S){const r=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),c=this.generateIS(e,t,n,s)),l=this.remuxVideo(t,m,i,r)}}else S&&(l=this.remuxVideo(t,m,i,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(u=N_(i,n,this._initPTS,this._initDTS)),r.samples.length&&(d=F_(r,n,this._initPTS))),{audio:h,video:l,initSegment:c,independent:f,text:d,id3:u}}generateIS(e,t,i,r){const n=e.samples,s=t.samples,a=this.typeSupported,o={},l=this._initPTS;let h,c,d,u,f=!l||r,p="audio/mp4";if(f&&(h=c=1/0),e.config&&n.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(p="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:p,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):MP4.initSegment([e]),metadata:{channelCount:e.channelCount}},f&&(u=e.id,d=e.inputTimeScale,l&&d===l.timescale?f=!1:h=c=n[0].pts-Math.round(d*i))}if(t.sps&&t.pps&&s.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:MP4.initSegment([t]),metadata:{width:t.width,height:t.height}},f)if(u=t.id,d=t.inputTimeScale,l&&d===l.timescale)f=!1;else{const e=this.getVideoStartPts(s),t=Math.round(d*i);c=Math.min(c,U_(s[0].dts,e)-t),h=Math.min(h,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,f?(this._initPTS={baseTime:h,timescale:d},this._initDTS={baseTime:c,timescale:d}):h=d=void 0,{tracks:o,initPTS:h,timescale:d,trackId:u}}remuxVideo(e,t,i,r){const n=e.inputTimeScale,s=e.samples,a=[],o=s.length,l=this._initPTS;let h,c,d=this.nextAvcDts,u=8,f=this.videoSampleDuration,p=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,g=!1;if(!i||null===d){const e=t*n,r=s[0].pts-U_(s[0].dts,s[0].pts);D_&&null!==d&&Math.abs(e-r-d)<15e3?i=!0:d=e-r}const v=l.baseTime*n/l.timescale;for(let e=0;e<o;e++){const t=s[e];t.pts=U_(t.pts-v,d),t.dts=U_(t.dts-v,d),t.dts<s[e>0?e-1:e].dts&&(g=!0)}g&&s.sort(function(e,t){const i=e.dts-t.dts,r=e.pts-t.pts;return i||r}),h=s[0].dts,c=s[s.length-1].dts;const y=c-h,_=y?Math.round(y/(o-1)):f||e.inputTimeScale/30;if(i){const i=h-d,r=i>_,n=i<-1;if((r||n)&&(r?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${P_(i,!0)} ms (${i}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${P_(-i,!0)} ms (${i}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!n||d>=s[0].pts||D_)){h=d;const e=s[0].pts-i;if(r)s[0].dts=h,s[0].pts=e;else{let t=!0;for(let r=0;r<s.length&&!(s[r].dts>e&&t);r++){const e=s[r].pts;if(s[r].dts-=i,s[r].pts-=i,r<s.length-1){const i=s[r+1].pts;t=i<=s[r].pts==i<=e}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${P_(e,!0)}/${P_(h,!0)}, delta: ${P_(i,!0)} ms`)}}h=Math.max(0,h);let S=0,b=0,T=h;for(let e=0;e<o;e++){const t=s[e],i=t.units,r=i.length;let n=0;for(let e=0;e<r;e++)n+=i[e].data.length;b+=n,S+=r,t.length=n,t.dts<T?(t.dts=T,T+=_/4|0||1):T=t.dts,p=Math.min(t.pts,p),m=Math.max(t.pts,m)}c=s[o-1].dts;const x=b+4*S+8;let E;try{E=new Uint8Array(x)}catch(e){return void this.observer.emit(Vp.ERROR,Vp.ERROR,{type:Fp.MUX_ERROR,details:Bp.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:x,reason:`fail allocating video mdat ${x}`})}const M=new DataView(E.buffer);M.setUint32(0,x),E.set(MP4.types.mdat,4);let w=!1,A=Number.POSITIVE_INFINITY,L=Number.POSITIVE_INFINITY,C=Number.NEGATIVE_INFINITY,R=Number.NEGATIVE_INFINITY;for(let e=0;e<o;e++){const t=s[e],i=t.units;let l,h=0;for(let e=0,t=i.length;e<t;e++){const t=i[e],r=t.data,n=t.data.byteLength;M.setUint32(u,n),u+=4,E.set(r,u),u+=n,h+=4+n}if(e<o-1)f=s[e+1].dts-t.dts,l=s[e+1].pts-t.pts;else{const i=this.config,a=e>0?t.dts-s[e-1].dts:_;if(l=e>0?t.pts-s[e-1].pts:_,i.stretchShortVideoTrack&&null!==this.nextAudioPts){const e=Math.floor(i.maxBufferHole*n),s=(r?p+r*n:this.nextAudioPts)-t.pts;s>e?(f=s-a,f<0?f=a:w=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${s/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=a}else f=a}const c=Math.round(t.pts-t.dts);A=Math.min(A,f),C=Math.max(C,f),L=Math.min(L,l),R=Math.max(R,l),a.push(O_(t.key,f,h,c))}if(a.length)if(D_){if(D_<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(k_&&R-L<C-A&&_/C<.025&&0===a[0].cts){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=h;for(let t=0,i=a.length;t<i;t++){const r=e+a[t].duration,n=e+a[t].cts;if(t<i-1){const e=r+a[t+1].cts;a[t].duration=e-n}else a[t].duration=t?a[t-1].duration:_;a[t].cts=0,e=r}}f=w||!f?_:f,this.nextAvcDts=d=c+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const P={data1:MP4.moof(e.sequenceNumber++,h,Yp(e,{samples:a})),data2:E,startPTS:p/n,endPTS:(m+f)/n,startDTS:h/n,endDTS:d/n,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,P}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,i,r,n){const s=e.inputTimeScale,a=s/(e.samplerate?e.samplerate:s),o=this.getSamplesPerFrame(e),l=o*a,h=this._initPTS,c="mp3"===e.segmentCodec&&this.typeSupported.mpeg,d=[],u=void 0!==n;let f=e.samples,p=c?0:8,m=this.nextAudioPts||-1;const g=t*s,v=h.baseTime*s/h.timescale;if(this.isAudioContiguous=i=i||f.length&&m>0&&(r&&Math.abs(g-m)<9e3||Math.abs(U_(f[0].pts-v,g)-m)<20*l),f.forEach(function(e){e.pts=U_(e.pts-v,g)}),!i||m<0){if(f=f.filter(e=>e.pts>=0),!f.length)return;m=0===n?0:r&&!u?Math.max(0,g):f[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let i=0,r=m;i<f.length;i++){const n=f[i],a=n.pts,o=a-r,h=Math.abs(1e3*o/s);if(o<=-t*l&&u)0===i&&(this.logger.warn(`Audio frame @ ${(a/s).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/s)} ms.`),this.nextAudioPts=m=r=a);else if(o>=t*l&&h<1e4&&u){let t=Math.round(o/l);r=a-t*l,r<0&&(t--,r+=l),0===i&&(this.nextAudioPts=m=r),this.logger.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(r/s).toFixed(3)}s due to ${Math.round(1e3*o/s)} ms gap.`);for(let s=0;s<t;s++){const t=Math.max(r,0);let s=AAC.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);s||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),s=n.unit.subarray()),f.splice(i,0,{unit:s,pts:t}),r+=l,i++}}n.pts=r,r+=l}}let y,_=null,S=null,b=0,T=f.length;for(;T--;)b+=f[T].unit.byteLength;for(let t=0,r=f.length;t<r;t++){const r=f[t],n=r.unit;let s=r.pts;if(null!==S){d[t-1].duration=Math.round((s-S)/a)}else{if(i&&"aac"===e.segmentCodec&&(s=m),_=s,!(b>0))return;b+=p;try{y=new Uint8Array(b)}catch(e){return void this.observer.emit(Vp.ERROR,Vp.ERROR,{type:Fp.MUX_ERROR,details:Bp.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:b,reason:`fail allocating audio mdat ${b}`})}if(!c){new DataView(y.buffer).setUint32(0,b),y.set(MP4.types.mdat,4)}}y.set(n,p);const l=n.byteLength;p+=l,d.push(O_(!0,o,l,0)),S=s}const x=d.length;if(!x)return;const E=d[d.length-1];this.nextAudioPts=m=S+a*E.duration;const M=c?new Uint8Array(0):MP4.moof(e.sequenceNumber++,_/a,Yp({},e,{samples:d}));e.samples=[];const w=_/s,A=m/s,L={data1:M,data2:y,startPTS:w,endPTS:A,startDTS:w,endDTS:A,type:"audio",hasAudio:!0,hasVideo:!1,nb:x};return this.isAudioContiguous=!0,L}}function U_(e,t){let i;if(null===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}function N_(e,t,i,r){const n=e.samples.length;if(!n)return;const s=e.inputTimeScale;for(let a=0;a<n;a++){const n=e.samples[a];n.pts=U_(n.pts-i.baseTime*s/i.timescale,t*s)/s,n.dts=U_(n.dts-r.baseTime*s/r.timescale,t*s)/s}const a=e.samples;return e.samples=[],{samples:a}}function F_(e,t,i){const r=e.samples.length;if(!r)return;const n=e.inputTimeScale;for(let s=0;s<r;s++){const r=e.samples[s];r.pts=U_(r.pts-i.baseTime*n/i.timescale,t*n)/n}e.samples.sort((e,t)=>e.pts-t.pts);const s=e.samples;return e.samples=[],{samples:s}}function B_(e,t,i=!1){return void 0!==(null==e?void 0:e.start)?(e.start+(i?e.duration:0))/e.timescale:t}function V_(e,t,i){const r=null==e?void 0:e.codec;if(r&&r.length>4)return r;if(t===vm){if("ec-3"===r||"ac-3"===r||"alac"===r)return r;if("fLaC"===r||"Opus"===r){return ng(r,!1)}return i.warn(`Unhandled audio codec "${r}" in mp4 MAP`),r||"mp4a"}return i.warn(`Unhandled video codec "${r}" in mp4 MAP`),r||"avc1"}try{I_=self.performance.now.bind(self.performance)}catch(e){I_=Date.now}const G_=[{demux:class MP4Demuxer{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,r){const n=this.videoTrack=a_("video",1),s=this.audioTrack=a_("audio",1),a=this.txtTrack=a_("text",1);if(this.id3Track=a_("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=Dm(e);if(o.video){const{id:e,timescale:t,codec:i,supplemental:r}=o.video;n.id=e,n.timescale=a.timescale=t,n.codec=i,n.supplemental=r}if(o.audio){const{id:e,timescale:t,codec:i}=o.audio;s.id=e,s.timescale=t,s.codec=i}a.id=Em.text,n.sampleDuration=0,n.duration=s.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let i=0;i<t;){const r=Am(e,i);if(r>8&&109===e[i+4]&&111===e[i+5]&&111===e[i+6]&&102===e[i+7])return!0;i=r>1?i+r:t}return!1}(e)}demux(e,t){this.timeOffset=t;let i=e;const r=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Vm(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},i=Pm(e,["moof"]);if(i.length<2)return t.remainder=e,t;const r=i[i.length-1];return t.valid=e.slice(0,r.byteOffset-8),t.remainder=e.slice(r.byteOffset-8),t}(i);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=i;const s=this.extractID3Track(r,t);return n.samples=Gm(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:s,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(t,this.timeOffset);return i.samples=Gm(e,t),{videoTrack:t,audioTrack:a_(),id3Track:r,textTrack:a_()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const r=Pm(e.samples,["emsg"]);r&&r.forEach(e=>{const r=function(e){const t=e[0];let i="",r="",n=0,s=0,a=0,o=0,l=0,h=0;if(0===t){for(;"\0"!==Mm(e.subarray(h,h+1));)i+=Mm(e.subarray(h,h+1)),h+=1;for(i+=Mm(e.subarray(h,h+1)),h+=1;"\0"!==Mm(e.subarray(h,h+1));)r+=Mm(e.subarray(h,h+1)),h+=1;r+=Mm(e.subarray(h,h+1)),h+=1,n=Am(e,12),s=Am(e,16),o=Am(e,20),l=Am(e,24),h=28}else if(1===t){h+=4,n=Am(e,h),h+=4;const t=Am(e,h);h+=4;const s=Am(e,h);for(h+=4,a=2**32*t+s,Up(a)||(a=Number.MAX_SAFE_INTEGER,rm.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Am(e,h),h+=4,l=Am(e,h),h+=4;"\0"!==Mm(e.subarray(h,h+1));)i+=Mm(e.subarray(h,h+1)),h+=1;for(i+=Mm(e.subarray(h,h+1)),h+=1;"\0"!==Mm(e.subarray(h,h+1));)r+=Mm(e.subarray(h,h+1)),h+=1;r+=Mm(e.subarray(h,h+1)),h+=1}return{schemeIdUri:i,value:r,timeScale:n,presentationTime:a,presentationTimeDelta:s,eventDuration:o,id:l,payload:e.subarray(h,e.byteLength)}}(e);if(S_.test(r.schemeIdUri)){const e=b_(r,t);let n=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;n<=.001&&(n=Number.POSITIVE_INFINITY);const s=r.payload;i.samples.push({data:s,len:s.byteLength,dts:e,pts:e,type:s_.emsg,duration:n})}else if(this.config.enableEmsgKLVMetadata&&r.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const e=b_(r,t);i.samples.push({data:r.payload,len:r.payload.byteLength,dts:e,pts:e,type:s_.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}},remux:class PassThroughRemuxer{constructor(e,t,i,r){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1,this.logger=r}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,r){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(function(e,t){if(!e||!t)return e;const i=t.keyId;i&&t.isCommonEncryption&&Pm(e,["moov","trak"]).forEach(e=>{const t=Pm(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=Pm(t,["enca"]);const n=r.length>0;n||(r=Pm(t,["encv"])),r.forEach(e=>{Pm(n?e.subarray(28):e.subarray(78),["sinf"]).forEach(e=>{const t=Bm(e);if(t){const e=t.subarray(8,24);e.some(e=>0!==e)||(rm.log(`[eme] Patching keyId in 'enc${n?"a":"v"}>sinf>>tenc' box: ${om(e)} -> ${om(i)}`),t.set(i,8))}})})});return e}(e,r)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=Dm(e);r.audio&&(t=V_(r.audio,vm,this.logger)),r.video&&(i=V_(r.video,ym,this.logger));const n={};r.audio&&r.video?n.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:r.video.supplemental,initSegment:e,id:"main"}:r.audio?n.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:r.video?n.video={container:"video/mp4",codec:i,supplemental:r.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=n}remux(e,t,i,r,n,s){var a,o;let{initPTS:l,lastEndTime:h}=this;const c={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};Op(h)||(h=this.lastEndTime=n||0);const d=t.samples;if(null==d||!d.length)return c;const u={initPTS:void 0,timescale:void 0,trackId:void 0};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(d),f=this.initData),null==(o=f)||!o.length)return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),c;this.emitInitSegment&&(u.tracks=this.initTracks,this.emitInitSegment=!1);const p=function(e,t,i){const r={},n=Pm(e,["moof","traf"]);for(let e=0;e<n.length;e++){const s=n[e],a=Pm(s,["tfhd"])[0],o=Am(a,4),l=t[o];if(!l)continue;const h=r[o]||(r[o]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type}),c=Pm(s,["tfdt"])[0];if(c){const e=c[0];let t=Am(c,4);1===e&&(t===Tm?i.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(t*=Tm+1,t+=Am(c,8))),Op(t)&&(!Op(h.start)||t<h.start)&&(h.start=t)}const d=l.default,u=Am(a,0)|(null==d?void 0:d.flags);let f=(null==d?void 0:d.duration)||0;8&u&&(f=Am(a,2&u?12:8));const p=Pm(s,["trun"]);let m=h.start||0,g=0,v=f;for(let e=0;e<p.length;e++){const t=p[e],i=Am(t,4),r=h.sampleCount;h.sampleCount+=i;const n=1&t[3],s=4&t[3],a=1&t[2],o=2&t[2],l=4&t[2],c=8&t[2];let d=8,u=i;for(n&&(d+=4),s&&i&&(1&t[d+1]||void 0!==h.keyFrameIndex||(h.keyFrameIndex=r),d+=4,a?(v=Am(t,d),d+=4):v=f,o&&(d+=4),c&&(d+=4),m+=v,g+=v,u--);u--;)a?(v=Am(t,d),d+=4):v=f,o&&(d+=4),l&&(1&t[d+1]||void 0===h.keyFrameIndex&&(h.keyFrameIndex=h.sampleCount-(u+1),h.keyFrameStart=m),d+=4),c&&(d+=4),m+=v,g+=v;!g&&f&&(g+=f*i)}h.duration+=g}if(!Object.keys(r).some(e=>r[e].duration)){let t=1/0,i=0;const n=Pm(e,["sidx"]);for(let e=0;e<n.length;e++){const r=Im(n[e]);if(null!=r&&r.references){t=Math.min(t,r.earliestPresentationTime/r.timescale);const e=r.references.reduce((e,t)=>e+t.info.duration||0,0);i=Math.max(i,e+r.earliestPresentationTime/r.timescale)}}i&&Op(i)&&Object.keys(r).forEach(e=>{r[e].duration||(r[e].duration=i*r[e].timescale-r[e].start)})}return r}(d,f,this.logger),m=f.audio?p[f.audio.id]:null,g=f.video?p[f.video.id]:null,v=B_(g,1/0),y=B_(m,1/0),_=B_(g,0,!0),S=B_(m,0,!0);let b,T=n,x=0;if(m&&(!g||!l&&y<v||l&&l.trackId===f.audio.id)?(u.trackId=f.audio.id,b=m,x=S-y):g&&(u.trackId=f.video.id,b=g,x=_-v),b){const e=b.timescale;T=b.start/e,u.timescale=e,l||(u.initPTS=b.start-n*e,this.initPTS=l={baseTime:u.initPTS,timescale:e,trackId:u.trackId})}!s&&l||!function(e,t,i,r){if(null===e)return!0;const n=Math.max(r,1),s=t-e.baseTime/e.timescale;return Math.abs(s-i)>n}(l,T,n,x)&&u.timescale===l.timescale||(u.initPTS=T-n,l&&1===l.timescale&&this.logger.warn(`Adjusting initPTS @${n} from ${l.baseTime/l.timescale} to ${u.initPTS}`),this.initPTS=l={baseTime:u.initPTS,timescale:1});const E=e?T-l.baseTime/l.timescale:h;!function(e,t,i){Pm(t,["moof","traf"]).forEach(t=>{Pm(t,["tfhd"]).forEach(r=>{const n=Am(r,4),s=e[n];if(!s)return;const a=s.timescale||9e4;Pm(t,["tfdt"]).forEach(e=>{const t=e[0],r=i*a;if(r){let i=Am(e,4);if(0===t)i-=r,i=Math.max(i,0),Rm(e,4,i);else{i*=Math.pow(2,32),i+=Am(e,8),i-=r,i=Math.max(i,0);const t=Math.floor(i/(Tm+1)),n=Math.floor(i%(Tm+1));Rm(e,4,t),Rm(e,8,n)}}})})})}(f,d,l.baseTime/l.timescale);const M=E+x;x>0?this.lastEndTime=M:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const w=!!f.audio,A=!!f.video;let L="";w&&(L+="audio"),A&&(L+="video");const C={data1:d,startPTS:E,startDTS:E,endPTS:M,endDTS:M,type:L,hasAudio:w,hasVideo:A,nb:1,dropped:0};c.audio=w&&!A?C:void 0,c.video=A?C:void 0;const R=null==g?void 0:g.sampleCount;if(R){const e=g.keyFrameIndex,t=-1!==e;C.nb=R,C.dropped=0===e||this.isVideoContiguous?0:t?e:R,C.independent=t,C.firstKeyFrame=e,t&&g.keyFrameStart&&(C.firstKeyFramePTS=g.keyFrameStart-l.baseTime/l.timescale),this.isVideoContiguous||(c.independent=t),this.isVideoContiguous||(this.isVideoContiguous=t),C.dropped&&this.logger.warn(`fmp4 does not start with IDR: firstIDR ${e}/${R} dropped: ${C.dropped} pts: ${C.firstKeyFramePTS||"NA"}`)}return c.initSegment=u,c.id3=N_(i,n,l,l),r.samples.length&&(c.text=F_(r,n,l)),c}}},{demux:TSDemuxer,remux:MP4Remuxer},{demux:class AACDemuxer extends BaseAudioDemuxer{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=Gy(e,0);let r=(null==i?void 0:i.length)||0;if(v_(e,r))return!1;for(let i=e.length;r<i;r++)if(qy(e,r))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&zy(e,t)&&$y(e,t)<=e.length-t}(e,t)}appendFrame(e,t,i){jy(e,this.observer,t,i,e.manifestCodec);const r=Yy(e,t,i,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:MP4Remuxer},{demux:class MP3Demuxer extends BaseAudioDemuxer{resetInitSegment(e,t,i,r){super.resetInitSegment(e,t,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Gy(e,0);let i=(null==t?void 0:t.length)||0;if(t&&11===e[i]&&119===e[i+1]&&void 0!==n_(t)&&y_(e,i)<=16)return!1;for(let t=e.length;i<t;i++)if(v_(e,i))return rm.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return m_(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,i){if(null!==this.basePTS)return f_(e,t,i,this.basePTS,this.frameIndex)}},remux:MP4Remuxer}];G_.splice(2,0,{demux:AC3Demuxer,remux:MP4Remuxer});class Transmuxer{constructor(e,t,i,r,n,s){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=n,this.logger=s}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,r){const n=i.transmuxing;n.executeStart=I_();let s=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:h,trackSwitch:c,accurateTimeOffset:d,timeOffset:u,initSegmentChange:f}=r||a,{audioCodec:p,videoCodec:m,defaultInitPts:g,duration:v,initSegmentData:y}=o,_=function(e,t){let i=null;e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(i=t);return i}(s,t);if(_&&vv(_.method)){const e=this.getDecrypter(),t=yv(_.method);if(!e.isSync())return this.asyncResult=!0,this.decryptionPromise=e.webCryptoDecrypt(s,_.key.buffer,_.iv.buffer,t).then(e=>{const t=this.push(e,null,i);return this.decryptionPromise=null,t}),this.decryptionPromise;{let r=e.softwareDecrypt(s,_.key.buffer,_.iv.buffer,t);if(i.part>-1){const t=e.flush();r=t?t.buffer:t}if(!r)return n.executeEnd=I_(),z_(i);s=new Uint8Array(r)}}const S=this.needsProbing(h,c);if(S){const e=this.configureTransmuxer(s);if(e)return this.logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(Vp.ERROR,Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),n.executeEnd=I_(),z_(i)}(h||c||f||S)&&this.resetInitSegment(y,p,m,v,t),(h||f||S)&&this.resetInitialTimestamp(g),l||this.resetContiguity();const b=this.transmux(s,_,u,d,i);this.asyncResult=H_(b);const T=this.currentTransmuxState;return T.contiguous=!0,T.discontinuity=!1,T.trackSwitch=!1,n.executeEnd=I_(),b}flush(e){const t=e.transmuxing;t.executeStart=I_();const{decrypter:i,currentTransmuxState:r,decryptionPromise:n}=this;if(n)return this.asyncResult=!0,n.then(()=>this.flush(e));const s=[],{timeOffset:a}=r;if(i){const t=i.flush();t&&s.push(this.push(t.buffer,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l){t.executeEnd=I_();const i=[z_(e)];return this.asyncResult?Promise.resolve(i):i}const h=o.flush(a);return H_(h)?(this.asyncResult=!0,h.then(t=>(this.flushRemux(s,t,e),s))):(this.flushRemux(s,h,e),this.asyncResult?Promise.resolve(s):s)}flushRemux(e,t,i){const{audioTrack:r,videoTrack:n,id3Track:s,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===Wp?"level":"track"} ${i.level}`);const h=this.remuxer.remux(r,n,s,a,l,o,!0,this.id);e.push({remuxResult:h,chunkMeta:i}),i.transmuxing.executeEnd=I_()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;t&&i&&(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,r,n){const{demuxer:s,remuxer:a}=this;s&&a&&(s.resetInitSegment(e,t,i,r),a.resetInitSegment(e,t,i,n))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,r,n){let s;return s=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,i,r,n):this.transmuxUnencrypted(e,i,r,n),s}transmuxUnencrypted(e,t,i,r){const{audioTrack:n,videoTrack:s,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(n,s,a,o,t,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,i,r,n){return this.demuxer.demuxSampleAes(e,t,i).then(e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,i,r,!1,this.id),chunkMeta:n}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:r}=this;let n;for(let t=0,i=G_.length;t<i;t++){var s;if(null!=(s=G_[t].demux)&&s.probe(e,this.logger)){n=G_[t];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,o=this.remuxer,l=n.remux,h=n.demux;o&&o instanceof l||(this.remuxer=new l(i,t,r,this.logger)),a&&a instanceof h||(this.demuxer=new h(i,t,r,this.logger),this.probe=h.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Decrypter(this.config)),e}}const z_=e=>({remuxResult:{},chunkMeta:e});function H_(e){return"then"in e&&e.then instanceof Function}class TransmuxConfig{constructor(e,t,i,r,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=r,this.defaultInitPts=n||null}}class TransmuxState{constructor(e,t,i,r,n,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=n,this.initSegmentChange=s}}let $_=0;class TransmuxerInterface{constructor(e,t,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=$_++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=e=>{const t=e.data,i=this.hls;if(i&&null!=t&&t.event&&t.instanceNo===this.instanceNo)switch(t.event){case"init":{var r;const e=null==(r=this.workerContext)?void 0:r.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":i.logger[t.data.logType]&&i.logger[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.part=this.part,t.data.id=this.id,i.trigger(t.event,t.data)}},this.onWorkerError=e=>{if(!this.hls)return;const t=new Error(`${e.message}  (${e.filename}:${e.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:t})};const n=e.config;this.hls=e,this.id=t,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;const s=(e,t)=>{(t=t||{}).frag=this.frag||void 0,e===Vp.ERROR&&(t.parent=this.id,t.part=this.part,this.error=t.error),this.hls.trigger(e,t)};this.observer=new Oy,this.observer.on(Vp.FRAG_DECRYPTED,s),this.observer.on(Vp.ERROR,s);const a=og(n.preferManagedMediaSource);if(this.useWorker&&"undefined"!=typeof Worker){const i=this.hls.logger;if(n.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{n.workerPath?(i.log(`loading Web Worker ${n.workerPath} for "${t}"`),this.workerContext=function(e){const t=Ny[e];if(t)return t.clientCount++,t;const i=new self.URL(e,self.location.href).href,r={worker:new self.Worker(i),scriptURL:i,clientCount:1};return Ny[e]=r,r}(n.workerPath)):(i.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=Ny[Uy];if(e)return e.clientCount++,e;const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),i=self.URL.createObjectURL(t),r={worker:new self.Worker(i),objectURL:i,clientCount:1};return Ny[Uy]=r,r}());const{worker:e}=this.workerContext;e.addEventListener("message",this.onWorkerMessage),e.addEventListener("error",this.onWorkerError),e.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:Tg(n)})}catch(r){i.warn(`Error setting up "${t}" Web Worker, fallback to inline`,r),this.terminateWorker(),this.error=null,this.transmuxer=new Transmuxer(this.observer,a,n,"",t,e.logger)}return}}this.transmuxer=new Transmuxer(this.observer,a,n,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=$_++;const t=this.hls.config,i=og(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:Tg(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),function(e){const t=Ny[e||Uy];if(t&&1===t.clientCount--){const{worker:i,objectURL:r}=t;delete Ny[e||Uy],r&&self.URL.revokeObjectURL(r),i.terminate()}}(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,r,n,s,a,o,l,h){var c,d;l.transmuxing.start=self.performance.now();const{instanceNo:u,transmuxer:f}=this,p=s?s.start:n.start,m=n.decryptdata,g=this.frag,v=!(g&&n.cc===g.cc),y=!(g&&l.level===g.level),_=g?l.sn-g.sn:-1,S=this.part?l.part-this.part.index:-1,b=0===_&&l.id>1&&l.id===(null==g?void 0:g.stats.chunkCount),T=!y&&(1===_||0===_&&(1===S||b&&S<=0)),x=self.performance.now();(y||_||0===n.stats.parsing.start)&&(n.stats.parsing.start=x),!s||!S&&T||(s.stats.parsing.start=x);const E=!(g&&(null==(c=n.initSegment)?void 0:c.url)===(null==(d=g.initSegment)?void 0:d.url)),M=new TransmuxState(v,T,o,y,p,E);if(!T||v||E){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${n.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===Wp?"level":"track"}: ${l.level} id: ${l.id}\n        discontinuity: ${v}\n        trackSwitch: ${y}\n        contiguous: ${T}\n        accurateTimeOffset: ${o}\n        timeOffset: ${p}\n        initSegmentChange: ${E}`);const e=new TransmuxConfig(i,r,t,a,h);this.configureTransmuxer(e)}if(this.frag=n,this.part=s,this.workerContext)this.workerContext.worker.postMessage({instanceNo:u,cmd:"demux",data:e,decryptdata:m,chunkMeta:l,state:M},e instanceof ArrayBuffer?[e]:[]);else if(f){const t=f.push(e,m,l,M);H_(t)?t.then(e=>{this.handleTransmuxComplete(e)}).catch(e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(t)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const t=i.flush(e);H_(t)?t.then(t=>{this.handleFlushResult(t,e)}).catch(t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}):this.handleFlushResult(t,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(e=>{this.handleTransmuxComplete(e)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class BasePlaylistController extends Logger{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const r=null==t?void 0:t.renditionReports;if(r){let n=-1;for(let i=0;i<r.length;i++){const s=r[i];let a;try{a=new self.URL(s.URI,t.url).href}catch(e){this.warn(`Could not construct new URL for Rendition Report: ${e}`),a=s.URI||""}if(a===e){n=i;break}a===e.substring(0,a.length)&&(n=i)}if(-1!==n){const e=r[n],s=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}const o=i&&_g(i);return new HlsUrlParameters(s,a>=0?a:void 0,o)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}return e}playlistLoaded(e,t,i){const{details:r,stats:n}=t,s=self.performance.now(),a=n.loading.first?Math.max(0,s-n.loading.first):0;r.advancedDateTime=Date.now()-a;const o=this.hls.config.timelineOffset;if(o!==r.appliedTimelineOffset){const e=Math.max(o||0,0);r.appliedTimelineOffset=e,r.fragments.forEach(t=>{t.start=t.playlistOffset+e})}if(r.live||null!=i&&i.live){const o="levelInfo"in t?t.levelInfo:t.track;if(r.reloaded(i),i&&r.fragments.length>0){ny(i,r);const e=r.playlistParsingError;if(e){this.warn(e);const i=this.hls;if(!i.config.ignorePlaylistParsingErrors){var l;const{networkDetails:s}=t;return void i.trigger(Vp.ERROR,{type:Fp.NETWORK_ERROR,details:Bp.LEVEL_PARSING_ERROR,fatal:!1,url:r.url,error:e,reason:e.message,level:t.level||void 0,parent:null==(l=r.fragments[0])?void 0:l.type,networkDetails:s,stats:n})}r.playlistParsingError=null}}-1===r.requestScheduled&&(r.requestScheduled=n.loading.start);const h=this.hls.mainForwardBufferInfo,c=h?h.end-h.len:0,d=ly(r,1e3*(r.edge-c));if(r.requestScheduled+d<s?r.requestScheduled=s:r.requestScheduled+=d,this.log(`live playlist ${e} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),!this.canLoad||!r.live)return;let u,f,p;if(r.canBlockReload&&r.endSN&&r.advanced){const e=this.hls.config.lowLatencyMode,n=r.lastPartSn,a=r.endSN,l=r.lastPartIndex,h=n===a;-1!==l?h?(f=a+1,p=e?0:l):(f=n,p=e?l+1:r.maxPartIndex):f=a+1;const c=r.age,d=c+r.ageHeader;let m=Math.min(d-r.partTarget,1.5*r.targetduration);if(m>0){if(d>3*r.targetduration)this.log(`Playlist last advanced ${c.toFixed(2)}s ago. Omitting segment and part directives.`),f=void 0,p=void 0;else if(null!=i&&i.tuneInGoal&&d-r.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${m} with playlist age: ${r.age}`),m=0;else{const e=Math.floor(m/r.targetduration);if(f+=e,void 0!==p){p+=Math.round(m%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${c.toFixed(2)}s goal: ${m} skip sn ${e} to part ${p}`)}r.tuneInGoal=m}if(u=this.getDeliveryDirectives(r,t.deliveryDirectives,f,p),e||!h)return r.requestScheduled=s,void this.loadingPlaylist(o,u)}else(r.canBlockReload||r.canSkipUntil)&&(u=this.getDeliveryDirectives(r,t.deliveryDirectives,f,p));u&&void 0!==f&&r.canBlockReload&&(r.requestScheduled=n.loading.first+Math.max(d-2*a,d/2)),this.scheduleLoading(o,u,r)}else this.clearTimer()}scheduleLoading(e,t,i){const r=i||e.details;if(!r)return void this.loadingPlaylist(e,t);const n=self.performance.now(),s=r.requestScheduled;if(n>=s)return void this.loadingPlaylist(e,t);const a=s-n;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,r){let n=_g(e);return null!=t&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,r=t.part,n=gg),new HlsUrlParameters(i,r,n)}checkRetry(e){const t=e.details,i=Ug(e),r=e.errorAction,{action:n,retryCount:s=0,retryConfig:a}=r||{},o=!!r&&!!a&&(n===$g||!r.resolved&&n===zg);if(o){var l;if(s>=a.maxNumRetry)return!1;if(i&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=Fg(a,s);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),e),this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return o}}function W_(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!q_(e[i].attrs,t[i].attrs))return!1;return!0}function q_(e,t,i){const r=e["STABLE-RENDITION-ID"];return r&&!i?r===t["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>e[i]!==t[i])}function j_(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class BufferOperationQueue{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(null===this.queues||null===this.tracks)return;const r=this.queues[t];r.push(e),1!==r.length||i||this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){null!==this.queues&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=null==(t=e[0])?void 0:t.label;"async-blocker"!==i&&"async-blocker-prepend"!==i||(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(null===this.queues)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(null===this.queues||null===this.tracks)return;const t=this.queues[e];if(t.length){const r=t[0];try{r.execute()}catch(t){var i;if(r.onError(t),null===this.queues||null===this.tracks)return;const n=null==(i=this.tracks[e])?void 0:i.buffer;null!=n&&n.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){null!==this.queues&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return(null==(t=this.queues)?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return null===e||null===t?"<destroyed>":`\n${this.list("video")}\n${this.list("audio")}\n${this.list("audiovideo")}}`}list(e){var t,i;return null!=(t=this.queues)&&t[e]||null!=(i=this.tracks)&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=null==(t=this.tracks)?void 0:t[e],r=null==i?void 0:i.buffer;return r?`SourceBuffer${r.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return(null==(t=this.queues)?void 0:t[e].map(e=>e.label).join(", "))||""}}const K_=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Y_="HlsJsTrackRemovedError";class HlsJsTrackRemovedError extends Error{constructor(e){super(e),this.name=Y_}}function X_(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach(t=>{e.removeChild(t)})}function Q_(e){return"audio"===e?1:0}class CapLevelController{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(Vp.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Vp.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(Vp.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Vp.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&Op(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((t,i)=>this.isLevelAllowed(t)&&i<=e);return this.clientRect=null,CapLevelController.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height)}static getMaxLevelByMediaSize(e,t,i){if(null==e||!e.length)return-1;const r=(e,t)=>!t||(e.width!==t.width||e.height!==t.height);let n=e.length-1;const s=Math.max(t,i);for(let t=0;t<e.length;t+=1){const i=e[t];if((i.width>=s||i.height>=s)&&r(i,e[t+1])){n=t;break}}return n}}const Z_={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},J_={HLS:"h"},eS="CMCD-Object",tS="CMCD-Request",iS="CMCD-Session",rS="CMCD-Status",nS={[eS]:["br","d","ot","tb"],[tS]:["bl","dl","mtp","nor","nrr","su"],[iS]:["cid","pr","sf","sid","st","v"],[rS]:["bs","rtp"]};class SfItem{constructor(e,t){Array.isArray(e)&&(e=e.map(e=>e instanceof SfItem?e:new SfItem(e))),this.value=e,this.params=t}}function sS(e,t,i,r){return new Error(`failed to ${e} "${n=t,Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":"object"==typeof n?JSON.stringify(n):String(n)}" as ${i}`,{cause:r});var n}function aS(e,t,i){return sS("serialize",e,t,i)}class SfToken{constructor(e){this.description=e}}const oS="Bare Item";function lS(e){if(!1===ArrayBuffer.isView(e))throw aS(e,"Byte Sequence");return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}function hS(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw aS(e,"Integer");return e.toString()}function cS(e,t){if(e<0)return-cS(-e,t);const i=Math.pow(10,t);if(Math.abs(e*i%1-.5)<Number.EPSILON){const t=Math.floor(e*i);return(t%2==0?t:t+1)/i}return Math.round(e*i)/i}function dS(e){const t=cS(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw aS(e,"Decimal");const i=t.toString();return i.includes(".")?i:`${i}.0`}const uS=/[\x00-\x1f\x7f]+/;function fS(e){const t=(i=e).description||i.toString().slice(7,-1);var i;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw aS(t,"Token");return t}function pS(e){switch(typeof e){case"number":if(!Op(e))throw aS(e,oS);return Number.isInteger(e)?hS(e):dS(e);case"string":return function(e){if(uS.test(e))throw aS(e,"String");return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return fS(e);case"boolean":return function(e){if("boolean"!=typeof e)throw aS(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return`@${hS(e.getTime()/1e3)}`}(e);if(e instanceof Uint8Array)return lS(e);if(e instanceof SfToken)return fS(e);default:throw aS(e,oS)}}function mS(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw aS(e,"Key");return e}function gS(e){return null==e?"":Object.entries(e).map(([e,t])=>!0===t?`;${mS(e)}`:`;${mS(e)}=${pS(t)}`).join("")}function vS(e){return e instanceof SfItem?`${pS(e.value)}${gS(e.params)}`:pS(e)}function yS(e,t={whitespace:!0}){if("object"!=typeof e)throw aS(e,"Dict");const i=e instanceof Map?e.entries():Object.entries(e),r=(null==t?void 0:t.whitespace)?" ":"";return Array.from(i).map(([e,t])=>{t instanceof SfItem==!1&&(t=new SfItem(t));let i=mS(e);var r;return!0===t.value?i+=gS(t.params):(i+="=",Array.isArray(t.value)?i+=`(${(r=t).value.map(vS).join(" ")})${gS(r.params)}`:i+=vS(t)),i}).join(`,${r}`)}const _S=e=>Math.round(e),SS=e=>100*_S(e/100),bS={br:_S,d:_S,bl:SS,dl:SS,mtp:SS,nor:(e,t)=>((null==t?void 0:t.baseUrl)&&(e=function(e,t){const i=new URL(e),r=new URL(t);if(i.origin!==r.origin)return e;const n=i.pathname.split("/").slice(1),s=r.pathname.split("/").slice(1,-1);for(;n[0]===s[0];)n.shift(),s.shift();for(;s.length;)s.shift(),n.unshift("..");return n.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:SS,tb:_S};function TS(e,t){const i={};if(null==e||"object"!=typeof e)return i;const r=Object.keys(e).sort(),n=Yp({},bS,null==t?void 0:t.formatters),s=null==t?void 0:t.filter;return r.forEach(r=>{if(null==s?void 0:s(r))return;let a=e[r];const o=n[r];o&&(a=o(a,t)),"v"===r&&1===a||"pr"==r&&1===a||function(e){return"number"==typeof e?Op(e):null!=e&&""!==e&&!1!==e}(a)&&(function(e){return"ot"===e||"sf"===e||"st"===e}(r)&&"string"==typeof a&&(a=new SfToken(a)),i[r]=a)}),i}function xS(e,t={}){return e?function(e,t){return yS(e,t)}(TS(e,t),Yp({whitespace:!1},t)):""}function ES(e,t,i){return Yp(e,function(e,t={}){const i={};if(!e)return i;const r=Object.entries(e),n=Object.entries(nS).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),s=r.reduce((e,t)=>{var i,r;const[s,a]=t,o=(null===(i=n.find(e=>e[1].includes(s)))||void 0===i?void 0:i[0])||tS;return null!==(r=e[o])&&void 0!==r||(e[o]={}),e[o][s]=a,e},{});return Object.entries(s).reduce((e,[i,r])=>(e[i]=xS(r,t),e),i)}(t,i))}const MS=/CMCD=[^&#]+/;function wS(e,t,i){const r=function(e,t={}){if(!e)return"";const i=xS(e,t);return`CMCD=${encodeURIComponent(i)}`}(t,i);if(!r)return e;if(MS.test(e))return e.replace(MS,r);const n=e.includes("?")?"&":"?";return`${e}${n}${r}`}function AS(e,t,i,r){e&&Object.keys(t).forEach(n=>{const s=e.filter(e=>e.groupId===n).map(e=>{const s=Yp({},e);return s.details=void 0,s.attrs=new AttrList(s.attrs),s.url=s.attrs.URI=LS(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),s.groupId=s.attrs["GROUP-ID"]=t[n],s.attrs["PATHWAY-ID"]=r,s});e.push(...s)})}function LS(e,t,i,r){const{HOST:n,PARAMS:s,[i]:a}=r;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return n&&!o&&(l.host=n),s&&Object.keys(s).sort().forEach(e=>{e&&l.searchParams.set(e,s[e])}),l.href}function CS(e,t,i){RS(e,t,i),e.addEventListener(t,i)}function RS(e,t,i){e.removeEventListener(t,i)}class EMEController extends Logger{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=EMEController.CDMCleanupPromise?[EMEController.CDMCleanupPromise]:[],this.onMediaEncrypted=e=>{const{initDataType:t,initData:i}=e,r=`"${e.type}" event: init data type: "${t}"`;if(this.debug(r),null!==i){if(!this.keyFormatPromise){let e=Object.keys(this.keySystemAccessPromises);e.length||(e=Ov(this.config));const t=e.map(kv).filter(e=>!!e);this.keyFormatPromise=this.getKeyFormatPromise(t)}this.keyFormatPromise.then(n=>{const s=Lv(n);let a,o;if("sinf"===t){if(s!==xv.FAIRPLAY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const n=Mm(new Uint8Array(i));try{const e=Bm(_v(JSON.parse(n).sinf));if(!e)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");a=new Uint8Array(e.subarray(8,24)),o=xv.FAIRPLAY}catch(e){return void this.warn(`${r} Failed to parse sinf: ${e}`)}}else{if(s!==xv.WIDEVINE&&s!==xv.PLAYREADY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const n=function(e){const t=[];if(e instanceof ArrayBuffer){const i=e.byteLength;let r=0;for(;r+32<i;){const i=jm(new DataView(e,r));t.push(i),r+=i.size}}return t}(i),l=n.filter(e=>!!e.systemId&&Dv(e.systemId)===s);l.length>1&&this.warn(`${r} Using first of ${l.length} pssh found for selected key-system ${s}`);const h=l[0];if(!h)return void(0===n.length||n.some(e=>!e.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${n.map(e=>Dv(e.systemId)).join(",")} pssh data in favor of playlist keys`));if(o=Dv(h.systemId),0===h.version&&h.data)if(o===xv.WIDEVINE){const e=h.data.length-22;a=new Uint8Array(h.data.subarray(e,e+16))}else o===xv.PLAYREADY&&(a=Fv(h.data))}if(!o||!a)return;const l=om(a),{keyIdToKeySessionPromise:h,mediaKeySessions:c}=this;let d=h[l];for(let e=0;e<c.length;e++){const r=c[e],n=r.decryptdata;if(!n.keyId)continue;const s=om(n.keyId);if(l===s||-1!==n.uri.replace(/-/g,"").indexOf(l)){if(d=h[s],n.pssh)break;delete h[s],n.pssh=new Uint8Array(i),n.keyId=a,d=h[l]=d.then(()=>this.generateRequestWithPreferredKeySession(r,t,i,"encrypted-event-key-match")),d.catch(e=>this.handleError(e));break}}if(!d){if(o!==s)return void this.log(`Ignoring "${e.type}" event with ${o} init data for selected key-system ${s}`);d=h[l]=this.getKeySystemSelectionPromise([o]).then(({keySystem:e,mediaKeys:r})=>{var n;this.throwIfDestroyed();const s=new LevelKey("ISO-23001-7",l,null!=(n=kv(e))?n:"");return s.pssh=new Uint8Array(i),s.keyId=a,this.attemptSetMediaKeys(e,r).then(()=>{this.throwIfDestroyed();const n=this.createMediaKeySessionContext({decryptdata:s,keySystem:e,mediaKeys:r});return this.generateRequestWithPreferredKeySession(n,t,i,"encrypted-event-no-match")})}),d.catch(e=>this.handleError(e))}})}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Vp.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(Vp.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Vp.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(Vp.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,r=t[e];return r?r.licenseUrl:e===xv.WIDEVINE&&i?i:void 0}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(void 0===t)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(e,t,i)=>!!e&&i.indexOf(e)===t,r=t.map(e=>e.audioCodec).filter(i),n=t.map(e=>e.videoCodec).filter(i);return r.length+n.length===0&&n.push("avc1.42e01e"),new Promise((t,i)=>{const s=e=>{const a=e.shift();this.getMediaKeysPromise(a,r,n).then(e=>t({keySystem:a,mediaKeys:e})).catch(t=>{e.length?s(e):i(t instanceof EMEKeyError?t:new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};s(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let e=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===Uv&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return i(e,t)}getMediaKeysPromise(e,t,i){const r=function(e,t,i,r){let n;switch(e){case xv.FAIRPLAY:n=["cenc","sinf"];break;case xv.WIDEVINE:case xv.PLAYREADY:n=["cenc"];break;case xv.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,i,r){return[{initDataTypes:e,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map(e=>({contentType:`audio/mp4; codecs=${e}`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null})),videoCapabilities:i.map(e=>({contentType:`video/mp4; codecs=${e}`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}))}]}(n,t,i,r)}(e,t,i,this.config.drmSystemOptions),n=this.keySystemAccessPromises[e];let s=null==n?void 0:n.keySystemAccess;if(!s){this.log(`Requesting encrypted media "${e}" key-system access with config: ${Tg(r)}`),s=this.requestMediaKeySystemAccess(e,r);const t=this.keySystemAccessPromises[e]={keySystemAccess:s};return s.catch(t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)}),s.then(i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);const r=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=i.createMediaKeys().then(i=>(this.log(`Media-keys created for "${e}"`),t.hasMediaKeys=!0,r.then(t=>t?this.setMediaKeysServerCertificate(i,e,t):i))),t.mediaKeys.catch(t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)}),t.mediaKeys})}return s.then(()=>n.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${om(e.keyId||[])}`);const r=i.createSession(),n={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(n),n}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),r=this.getKeyIdString(t),n="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,n,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return om(e.keyId)}updateKeySession(e,t){var i;const r=e.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${om((null==(i=e.decryptdata)?void 0:i.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),r.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>kv(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:e,mediaKeys:t})=>this.attemptSetMediaKeys(e,t))}selectKeySystem(e){return new Promise((t,i)=>this.getKeySystemSelectionPromise(e).then(({keySystem:e})=>{const r=kv(e);r?t(r):i(new Error(`Unable to find format for key-system "${e}"`))}).catch(i))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=Ov(this.config),i=e.map(Lv).filter(e=>!!e&&-1!==t.indexOf(e));return this.selectKeySystem(i)}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),r=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);let n=this.keyIdToKeySessionPromise[i];if(!n){n=this.getKeySystemForKeyPromise(t).then(({keySystem:i,mediaKeys:n})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(i,n).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:i,mediaKeys:n,decryptdata:t})))));(this.keyIdToKeySessionPromise[i]=n.then(e=>{const i=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(e,"cenc",i,"playlist-key")})).catch(e=>this.handleError(e))}return n}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof EMEKeyError?this.hls.trigger(Vp.ERROR,e.data):this.hls.trigger(Vp.ERROR,{type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const t=Lv(e.keyFormat),i=t?[t]:Ov(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=Ov(this.config)),0===e.length)throw new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${Tg({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const r=Promise.all(i).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(r),r.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(e=>-1===i.indexOf(e))})}generateRequestWithPreferredKeySession(e,t,i,r){var n,s;const a=null==(n=this.config.drmSystems)||null==(s=n[e.keySystem])?void 0:s.generateRequest;if(a)try{const r=a.call(this.hls,t,i,e);if(!r)throw new Error("Invalid response from configured generateRequest filter");t=r.initDataType,i=r.initData?r.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(e){var o;if(this.warn(e.message),null!=(o=this.hls)&&o.config.debug)throw e}if(null===i)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${t} length: ${i?i.byteLength:null})`);const h=new Oy,c=e._onmessage=t=>{const i=e.mediaKeysSession;if(!i)return void h.emit("error",new Error("invalid state"));const{messageType:r,message:n}=t;this.log(`"${r}" message event for session "${i.sessionId}" message size: ${n.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(e,n).catch(e=>{h.eventNames().length?h.emit("error",e):this.handleError(e)}):"license-release"===r?e.keySystem===xv.FAIRPLAY&&(this.updateKeySession(e,Sv("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${r}"`)},d=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void h.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const i=e.keyStatus;h.emit("keyStatus",i),"expired"===i&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};CS(e.mediaKeysSession,"message",c),CS(e.mediaKeysSession,"keystatuseschange",d);const u=new Promise((e,t)=>{h.on("error",t),h.on("keyStatus",i=>{i.startsWith("usable")?e():"output-restricted"===i?t(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?t(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)}).catch(e=>{throw new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)}).then(()=>u).catch(t=>{throw h.removeAllListeners(),this.removeSession(e),t}).then(()=>(h.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if("string"==typeof i&&"object"==typeof t){const e=i;i=t,t=e}this.log(`key status change "${t}" for keyStatuses keyId: ${om("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${om(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=new(0,t.loader)(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((n,s)=>{const a={responseType:"arraybuffer",url:r},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(e,t,i,r)=>{n(e.data)},onError:(t,i,n,o)=>{s(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:Qp({url:a.url,data:void 0},t)},`"${e}" certificate request failed (${r}). Status: ${t.code} (${t.text})`))},onTimeout:(t,i,n)=>{s(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:a.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(e,t,i)=>{s(new Error("aborted"))}};i.load(a,l,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((r,n)=>{e.setServerCertificate(i).then(n=>{this.log(`setServerCertificate ${n?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${t}"`),r(e)}).catch(e=>{n(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(t=>this.updateKeySession(e,new Uint8Array(t)).catch(e=>{throw new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const r=(new DOMParser).parseFromString(i,"application/xml"),n=r.querySelectorAll("HttpHeader");if(n.length>0){let t;for(let i=0,r=n.length;i<r;i++){var s,a;t=n[i];const r=null==(s=t.querySelector("name"))?void 0:s.textContent,o=null==(a=t.querySelector("value"))?void 0:a.textContent;r&&o&&e.setRequestHeader(r,o)}}const o=r.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Sv(atob(l))}setupLicenseXHR(e,t,i,r){const n=this.config.licenseXhrSetup;return n?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return n.call(this.hls,e,t,i,r)}).catch(s=>{if(!i.decryptdata)throw s;return e.open("POST",t,!0),n.call(this.hls,e,t,i,r)}).then(i=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:i||r}}):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((r,n)=>{const s=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${s}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return n(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let t=a.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const i=this.config.licenseResponseCallback;if(i)try{t=i.call(this.hls,a,s,e)}catch(e){this.error(e)}r(t)}else{const o=i.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)n(new EMEKeyError({type:Fp.KEY_SYSTEM_ERROR,details:Bp.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:s,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${s}). Status: ${a.status} (${a.statusText})`));else{const i=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(e,t).then(r,n)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,s,e,t).then(({xhr:t,licenseChallenge:i})=>{e.keySystem==xv.PLAYREADY&&(i=this.unpackPlayReadyKeyMessage(t,i)),t.send(i)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,CS(i,"encrypted",this.onMediaEncrypted),CS(i,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(RS(e,"encrypted",this.onMediaEncrypted),RS(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,LevelKey.clearKeyUriToKeyIdMap();const r=i.length;EMEController.CDMCleanupPromise=Promise.all(i.map(e=>this.removeSession(e)).concat(null==t||null==(e=t.setMediaKeys(null))?void 0:e.catch(e=>{var t;this.log(`Could not clear media keys: ${e}`),null==(t=this.hls)||t.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${e}`)})}))).catch(e=>{var t;this.log(`Could not close sessions and clear media keys: ${e}`),null==(t=this.hls)||t.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${e}`)})}).then(()=>{r&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);r>-1&&this.mediaKeySessions.splice(r,1);const{drmSystemOptions:n}=this.config,s=function(e){var t;return"persistent-license"===e.sessionType||!(null==(t=e.sessionTypes)||!t.some(e=>"persistent-license"===e))}(n)?new Promise((e,i)=>{self.setTimeout(()=>i(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(e)}):Promise.resolve();return s.catch(e=>{var t;this.log(`Could not remove session: ${e}`),null==(t=this.hls)||t.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${e}`)})}).then(()=>t.close()).catch(e=>{var t;this.log(`Could not close session: ${e}`),null==(t=this.hls)||t.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${e}`)})})}}}EMEController.CDMCleanupPromise=void 0;class EMEKeyError extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}function PS(e,t){let i;try{i=new Event("addtrack")}catch(e){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}function IS(e,t){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(i){rm.debug(`[texttrack-utils]: ${i}`);try{const i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,e.addCue(i)}catch(e){rm.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}"disabled"===i&&(e.mode=i)}function DS(e,t){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues)for(let i=e.cues.length;i--;)t&&e.cues[i].removeEventListener("enter",t),e.removeCue(e.cues[i]);"disabled"===i&&(e.mode=i)}function kS(e,t,i,r){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&e.cues.length>0){const n=function(e,t,i){const r=[],n=function(e,t){if(t<=e[0].startTime)return 0;const i=e.length-1;if(t>e[i].endTime)return-1;let r,n=0,s=i;for(;n<=s;)if(r=Math.floor((s+n)/2),t<e[r].startTime)s=r-1;else{if(!(t>e[r].startTime&&n<i))return r;n=r+1}return e[n].startTime-t<t-e[s].startTime?n:s}(e,t);if(n>-1)for(let s=n,a=e.length;s<a;s++){const n=e[s];if(n.startTime>=t&&n.endTime<=i)r.push(n);else if(n.startTime>i)return r}return r}(e.cues,t,i);for(let t=0;t<n.length;t++)r&&!r(n[t])||e.removeCue(n[t])}"disabled"===n&&(e.mode=n)}function OS(e){const t=[];for(let i=0;i<e.length;i++){const r=e[i];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||t.push(e[i])}return t}function US(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}const NS=.025;let FS=function(e){return e[e.Point=0]="Point",e[e.Range=1]="Range",e}({});function BS(e,t,i){return`${e.identifier}-${i+1}-${US(t)}`}class InterstitialEvent{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,null==(e=this.assetListLoader)||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;if(e<=0||isNaN(i))return!1;if(0===i)return!0;return((null==(t=this.assetList[e])?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return VS(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(0===this.startTime||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime;return t-VS(t,e)<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=Op(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return VS(e,t)}return e}get appendInPlace(){return!!this.appendInPlaceStarted||!this.appendInPlaceDisabled&&!(this.cue.once||this.cue.pre||!this.startIsAligned||!(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<NS))}set appendInPlace(e){this.appendInPlaceStarted?this.resetOnResume=!e:this.appendInPlaceDisabled=!e}get timelineStart(){return null!==this._timelineStart?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return t=null!==this._duration?this._duration:this.dateRange.duration?this.dateRange.duration:this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return"RANGE"===this.dateRange.attr["X-TIMELINE-OCCUPIES"]?FS.Range:FS.Point}get supplementsPrimary(){return"PRIMARY"===this.dateRange.attr["X-TIMELINE-STYLE"]}get contentMayVary(){return"NO"!==this.dateRange.attr["X-CONTENT-MAY-VARY"]}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||null!==this.assetListResponse}toString(){return`["${(e=this).identifier}" ${e.cue.pre?"<pre>":e.cue.post?"<post>":""}${e.timelineStart.toFixed(2)}-${e.resumeTime.toFixed(2)}]`;var e}}function VS(e,t){return e-t.start<t.duration/2&&!(Math.abs(e-(t.start+t.duration))<NS)?t.start:t.start+t.duration}function GS(e,t,i){const r=new self.URL(e,i);return"data:"!==r.protocol&&r.searchParams.set("_HLS_primary_id",t),r}function zS(e,t){for(;null!=(i=e.assetList[++t])&&i.error;)var i;return t}function HS(e){const t=e.timelineStart,i=e.duration||0;return`["${e.identifier}" ${t.toFixed(2)}-${(t+i).toFixed(2)}]`}class HlsAssetPlayer{constructor(e,t,i,r){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(Vp.PLAYOUT_LIMIT_REACHED,{})};const n=this.hls=new e(t);this.interstitial=i,this.assetItem=r;let s=r.uri;try{s=GS(s,t.primarySessionId).href}catch(e){}n.loadSource(s);const a=()=>{this.hasDetails=!0};n.once(Vp.LEVEL_LOADED,a),n.once(Vp.AUDIO_TRACK_LOADED,a),n.once(Vp.SUBTITLE_TRACK_LOADED,a),n.on(Vp.MEDIA_ATTACHING,(e,{media:t})=>{this.removeMediaListeners(),this.mediaAttached=t;this.interstitial.playoutLimit&&(t.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&n.on(Vp.BUFFER_APPENDED,()=>{const e=this.bufferedEnd;this.reachedPlayout(e)&&(this._bufferedEosTime=e,n.trigger(Vp.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return(null==(e=this.interstitial)?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if(null!=(t=this.hls)&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const i=this.timelineOffset,r=BufferHelper.bufferInfo(e,i,0);return this.getAssetTime(r.end)>=this._bufferedEosTime-.02}reachedPlayout(e){const t=this.interstitial.playoutLimit;return this.startOffset+e>=t}get destroyed(){var e;return!(null!=(e=this.hls)&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return(null==(e=this.hls)?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=BufferHelper.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return(null==(e=this.hls)?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){var e;this.mediaAttached&&(null!=(e=this.hls)&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd))}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){const e=this.hls;if(this.hasDetails){e.stopLoad();const t=e=>delete e.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${HS(this.assetItem)} ${null==(e=this.hls)?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}class InterstitialsSchedule extends Logger{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,r)=>e<=r.startOffset&&t>r.startOffset?(delete r.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const r=this.items;if(r)for(r[i]||(void 0===t&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&null!=(n=r[i])&&n.event;){var n;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let r=0;r<i.length;r++){let n=i[r];if(t&&"primary"!==t&&(n=n[t]),e===n.start||e>n.start&&e<n.end)return r}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let r=e;r<=t&&i[r];r++){const e=i[r].event;if(null!=e&&e.restrictions.jump&&!e.appendInPlace)return r}return-1}findEventIndex(e){const t=this.items;if(t)for(let r=t.length;r--;){var i;if((null==(i=t[r].event)?void 0:i.identifier)===e)return r}return-1}findAssetIndex(e,t){const i=e.assetList,r=i.length;if(r>1)for(let e=0;e<r;e++){const r=i[e];if(!r.error){const i=r.timelineStart;if(t===i||t>i&&t<i+(r.duration||0))return e}}return 0}get assetIdAtEnd(){var e,t;const i=null==(e=this.items)||null==(t=e[this.length-1])?void 0:t.event;if(i){const e=i.assetList,t=e[e.length-1];if(t)return t.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:r}=i,n=this.events,s=this.parseDateRanges(r,{url:i.url},t),a=Object.keys(r),o=n?n.filter(e=>!a.includes(e.identifier)):[];s.length&&s.sort((e,t)=>{const i=e.cue.pre,r=e.cue.post,n=t.cue.pre,s=t.cue.post;if(i&&!n)return-1;if(n&&!i)return 1;if(r&&!s)return 1;if(s&&!r)return-1;if(!(i||n||r||s)){const i=e.startTime,r=t.startTime;if(i!==r)return i-r}return e.dateRange.tagOrder-t.dateRange.tagOrder}),this.events=s,o.forEach(e=>{this.removeEvent(e)}),this.updateSchedule(e,o)}updateSchedule(e,t=[]){const i=this.events||[];if(i.length||t.length||this.length<2){const r=this.items,n=this.parseSchedule(i,e),s=t.length||(null==r?void 0:r.length)!==n.length||n.some((e,t)=>Math.abs(e.playout.start-r[t].playout.start)>.005||Math.abs(e.playout.end-r[t].playout.end)>.005);s&&(this.items=n,this.onScheduleUpdate(t,r))}}parseDateRanges(e,t,i){const r=[],n=Object.keys(e);for(let s=0;s<n.length;s++){const a=n[s],o=e[a];if(o.isInterstitial){let e=this.eventMap[a];e?e.setDateRange(o):(e=new InterstitialEvent(o,t),this.eventMap[a]=e,!1===i&&(e.appendInPlace=i)),r.push(e)}}return r}parseSchedule(e,t){const i=[],r=t.main.details,n=r.live?1/0:r.edge;let s=0;if((e=e.filter(e=>!(e.error||e.cue.once&&e.hasPlayed))).length){this.resolveOffsets(e,t);let r=0,o=0;if(e.forEach((t,a)=>{const l=t.cue.pre,h=t.cue.post,c=e[a-1]||null,d=t.appendInPlace,u=h?n:t.startOffset,f=t.duration,p=t.timelineOccupancy===FS.Range?f:0,m=t.resumptionOffset,g=(null==c?void 0:c.startTime)===u,v=u+t.cumulativeDuration;let y=d?v+f:u+m;if(l||!h&&u<=0){const e=o;o+=p,t.timelineStart=v;const r=s;s+=f,i.push({event:t,start:v,end:y,playout:{start:r,end:s},integrated:{start:e,end:o}})}else{if(!(u<=n))return;{if(!g){const n=u-r;if(n>.033){const l=r,h=o;o+=n;const c=s;s+=n;const d={previousEvent:e[a-1]||null,nextEvent:t,start:l,end:l+n,playout:{start:c,end:s},integrated:{start:h,end:o}};i.push(d)}else n>0&&c&&(c.cumulativeDuration+=n,i[i.length-1].end=u)}h&&(y=v),t.timelineStart=v;const n=o;o+=p;const l=s;s+=f,i.push({event:t,start:v,end:y,playout:{start:l,end:s},integrated:{start:n,end:o}})}}const _=t.resumeTime;r=h||_>n?n:_}),r<n){var a;const e=r,t=o,l=n-r;o+=l;const h=s;s+=l,i.push({previousEvent:(null==(a=i[i.length-1])?void 0:a.event)||null,nextEvent:null,start:r,end:e+l,playout:{start:h,end:s},integrated:{start:t,end:o}})}this.setDurations(n,s,o)}else{const e=0;i.push({previousEvent:null,nextEvent:null,start:e,end:n,playout:{start:e,end:n},integrated:{start:e,end:n}}),this.setDurations(n,n,n)}return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,r=i.live?1/0:i.edge;let n=0,s=-1;e.forEach((a,o)=>{const l=a.cue.pre,h=a.cue.post,c=l?0:h?r:a.startTime;this.updateAssetDurations(a);if(s===c?a.cumulativeDuration=n:(n=0,s=c),!h&&a.snapOptions.in&&(a.resumeAnchor=Ig(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted){this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)}if(!a.appendInPlace&&o+1<e.length){e[o+1].startTime-e[o].resumeTime<.033&&(e[o+1].appendInPlace=!1,e[o+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`))}const d=Op(a.resumeOffset)?a.resumeOffset:a.duration;n+=d})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,r=e.startTime+e.resumptionOffset;if(Math.abs(i-r)>NS)return this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${r}`),!1;if(!t)return this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1;return!Object.keys(t).some(r=>{const n=t[r].details,s=n.edge;if(i>=s)return this.log(`"${e.identifier}" resumption ${i} past ${r} playlist end ${s}`),!1;const a=Ig(null,n.fragments,i);if(!a)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${r} playlist (${n.fragStart}-${n.fragmentEnd})`),!0;const o="audio"===r?.175:0;return!(Math.abs(a.start-i)<NS+o||Math.abs(a.end-i)<NS+o)&&(this.log(`"${e.identifier}" resumption ${i} not aligned with ${r} fragment bounds (${a.start}-${a.end} sn: ${a.sn} cc: ${a.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,r=!1,n=!1;e.assetList.forEach((e,s)=>{const a=t+i;e.startOffset=i,e.timelineStart=a,r||(r=null===e.duration),n||(n=!!e.error);const o=e.error?0:e.duration||0;i+=o}),e.duration=r&&!n?Math.max(i,e.duration):i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function $S(e){return`[${e.event?'"'+e.event.identifier+'"':"primary"}: ${e.start.toFixed(2)}-${e.end.toFixed(2)}]`}class AssetListLoader{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let r;try{r=GS(i,this.hls.sessionId,e.baseUrl)}catch(t){const r=this.assignAssetListError(e,Bp.ASSET_LIST_LOAD_ERROR,t,i);return void this.hls.trigger(Vp.ERROR,r)}t&&"data:"!==r.protocol&&r.searchParams.set("_HLS_start_offset",""+t);const n=this.hls.config,s=new(0,n.loader)(n),a={responseType:"json",url:r.href},o=n.interstitialAssetListLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(t,i,r,n)=>{const s=t.data,a=null==s?void 0:s.ASSETS;if(!Array.isArray(a)){const t=this.assignAssetListError(e,Bp.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),r.url,i,n);return void this.hls.trigger(Vp.ERROR,t)}e.assetListResponse=s,this.hls.trigger(Vp.ASSET_LIST_LOADED,{event:e,assetListResponse:s,networkDetails:n})},onError:(t,i,r,n)=>{const s=this.assignAssetListError(e,Bp.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${t.code} ${t.text} (${i.url})`),i.url,n,r);this.hls.trigger(Vp.ERROR,s)},onTimeout:(t,i,r)=>{const n=this.assignAssetListError(e,Bp.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${i.url})`),i.url,t,r);this.hls.trigger(Vp.ERROR,n)}};return s.load(a,l,h),this.hls.trigger(Vp.ASSET_LIST_LOADING,{event:e}),s}assignAssetListError(e,t,i,r,n,s){return e.error=i,{type:Fp.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:r,error:i,networkDetails:s,stats:n}}}function WS(e){null==e||e.play().catch(()=>{})}class BufferableInstance{constructor(e){this.buffered=void 0;const t=(t,i,r)=>{if((i>>>=0)>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${r})`);return e[i][t]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const qS={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},jS=e=>String.fromCharCode(qS[e]||e),KS=15,YS=100,XS={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},QS={17:2,18:4,21:6,22:8,23:10,19:13,20:15},ZS={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},JS={25:2,26:4,29:6,30:8,31:10,27:13,28:15},eb=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class CaptionsLogger{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i="function"==typeof t?t():t;rm.log(`${this.time} [${e}] ${i}`)}}}const tb=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class PenState{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const r=t[i];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class StyledUnicodeChar{constructor(){this.uchar=" ",this.penState=new PenState}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Row{constructor(e){this.chars=[],this.pos=0,this.currPenState=new PenState,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<YS;e++)this.chars.push(new StyledUnicodeChar);this.logger=e}equals(e){for(let t=0;t<YS;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<YS;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<YS;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>YS&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=YS)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=jS(e);this.pos>=YS?this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<YS;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<YS;i++){const r=this.chars[i].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class CaptionScreen{constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<KS;t++)this.rows.push(new Row(e));this.logger=e}reset(){for(let e=0;e<KS;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let i=0;i<KS;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<KS;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<KS;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+Tg(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<KS;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const r=i.rows[e].cueStartTime,n=this.logger.time;if(null!==r&&null!==n&&r<n)for(let r=0;r<this.nrRollUpRows;r++)this.rows[t-this.nrRollUpRows+r+1].copy(i.rows[e+r])}}this.currRow=t;const i=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,r=Math.max(t-1,0);i.setCursor(e.indent),e.color=i.chars[r].penState.foreground}const r={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+Tg(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",r=-1;for(let i=0;i<KS;i++){const n=this.rows[i].getTextString();n&&(r=i+1,e?t.push("Row "+r+": '"+n+"'"):t.push(n.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class Cea608Channel{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new CaptionScreen(i),this.nonDisplayedMemory=new CaptionScreen(i),this.lastOutputScreen=new CaptionScreen(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=r[i]}this.logger.log(2,"MIDROW: "+Tg(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Cea608Parser{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const r=this.logger=new CaptionsLogger;this.channels=[null,new Cea608Channel(e,t,r),new Cea608Channel(e+1,i,r)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let e=0;e<t.length;e+=2){const i=127&t[e],r=127&t[e+1];let n=!1,s=null;if(0===i&&0===r)continue;this.logger.log(3,()=>"["+tb([t[e],t[e+1]])+"] -> ("+tb([i,r])+")");const a=this.cmdHistory;if(i>=16&&i<=31){if(rb(i,r,a)){ib(null,null,a),this.logger.log(3,()=>"Repeated command ("+tb([i,r])+") is dropped");continue}ib(i,r,this.cmdHistory),n=this.parseCmd(i,r),n||(n=this.parseMidrow(i,r)),n||(n=this.parsePAC(i,r)),n||(n=this.parseBackgroundAttributes(i,r))}else ib(null,null,a);if(!n&&(s=this.parseChars(i,r),s)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(s)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}n||s||this.logger.log(2,()=>"Couldn't parse cleaned data "+tb([i,r])+" orig: "+tb([t[e],t[e+1]]))}}parseCmd(e,t){if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;const i=20===e||21===e||23===e?1:2,r=this.channels[i];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.currentChannel=i,!0}parseMidrow(e,t){let i=0;if((17===e||25===e)&&t>=32&&t<=47){if(i=17===e?1:2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[i];return!!r&&(r.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+tb([e,t])+")"),!0)}return!1}parsePAC(e,t){let i;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;const r=e<=23?1:2;i=t>=64&&t<=95?1===r?XS[e]:ZS[e]:1===r?QS[e]:JS[e];const n=this.channels[r];return!!n&&(n.setPAC(this.interpretPAC(i,t)),this.currentChannel=r,!0)}interpretPAC(e,t){let i;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,r.underline=!(1&~i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(e,t){let i,r=null,n=null;if(e>=25?(i=2,n=e-8):(i=1,n=e),n>=17&&n<=19){let e;e=17===n?t+80:18===n?t+112:t+144,this.logger.log(2,()=>"Special char '"+jS(e)+"' in channel "+i),r=[e]}else e>=32&&e<=127&&(r=0===t?[e]:[e,t]);return r&&this.logger.log(3,()=>"Char codes =  "+tb(r).join(",")),r}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let i;const r={};16===e||24===e?(i=Math.floor((t-32)/2),r.background=eb[i],t%2==1&&(r.background=r.background+"_semi")):45===t?r.background="transparent":(r.foreground="black",47===t&&(r.underline=!0));const n=e<=23?1:2;return this.channels[n].setBkgData(r),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}ib(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function ib(e,t,i){i.a=e,i.b=t}function rb(e,t,i){return i.a===e&&i.b===t}var nb=function(){if(null!=Tv&&Tv.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function i(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const i=t.toLowerCase();return!!~e.indexOf(i)&&i}function r(e){return i(t,e)}function n(e,...t){let i=1;for(;i<arguments.length;i++){const t=arguments[i];for(const i in t)e[i]=t[i]}return e}function s(t,s,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let h="",c=!1,d=t,u=s,f=a,p=null,m="",g=!0,v="auto",y="start",_=50,S="middle",b=50,T="middle";Object.defineProperty(o,"id",n({},l,{get:function(){return h},set:function(e){h=""+e}})),Object.defineProperty(o,"pauseOnExit",n({},l,{get:function(){return c},set:function(e){c=!!e}})),Object.defineProperty(o,"startTime",n({},l,{get:function(){return d},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",n({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",n({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",n({},l,{get:function(){return p},set:function(e){p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",n({},l,{get:function(){return m},set:function(t){const r=function(t){return i(e,t)}(t);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",n({},l,{get:function(){return g},set:function(e){g=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",n({},l,{get:function(){return v},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",n({},l,{get:function(){return y},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",n({},l,{get:function(){return _},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");_=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",n({},l,{get:function(){return S},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");S=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",n({},l,{get:function(){return b},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");b=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",n({},l,{get:function(){return T},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),o.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class StringDecoder{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function sb(e){function t(e,t,i,r){return 3600*(0|e)+60*(0|t)+(0|i)+parseFloat(r||0)}const i=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?t(i[2],i[3],0,i[4]):t(i[1],i[2],i[3],i[4]):null}class Settings{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function ab(e,t,i,r){const n=r?e.split(r):[e];for(const e in n){if("string"!=typeof n[e])continue;const r=n[e].split(i);if(2!==r.length)continue;t(r[0],r[1])}}const ob=new nb(0,0,""),lb="middle"===ob.align?"middle":"center";function hb(e,t,i){const r=e;function n(){const t=sb(e);if(null===t)throw new Error("Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function s(){e=e.replace(/^\s+/,"")}if(s(),t.startTime=n(),s(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.slice(3),s(),t.endTime=n(),s(),function(e,t){const r=new Settings;ab(e,function(e,t){let n;switch(e){case"region":for(let n=i.length-1;n>=0;n--)if(i[n].id===t){r.set(e,i[n].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":n=t.split(","),r.integer(e,n[0]),r.percent(e,n[0])&&r.set("snapToLines",!1),r.alt(e,n[0],["auto"]),2===n.length&&r.alt("lineAlign",n[1],["start",lb,"end"]);break;case"position":n=t.split(","),r.percent(e,n[0]),2===n.length&&r.alt("positionAlign",n[1],["start",lb,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",lb,"end","left","right"])}},/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");let n=r.get("line","auto");"auto"===n&&-1===ob.line&&(n=-1),t.line=n,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",lb);let s=r.get("position","auto");"auto"===s&&50===ob.position&&(s="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=s}(e,t)}function cb(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class VTTParser{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new StringDecoder,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function i(){let e=t.buffer,i=0;for(e=cb(e);i<e.length&&"\r"!==e[i]&&"\n"!==e[i];)++i;const r=e.slice(0,i);return"\r"===e[i]&&++i,"\n"===e[i]&&++i,t.buffer=e.slice(i),r}function r(e){ab(e,function(e,t){},/:/)}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=i();const r=e.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let n=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(n?n=!1:e=i(),t.state){case"HEADER":/:/.test(e)?r(e):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new nb(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{hb(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const i=-1!==e.indexOf("--\x3e");if(!e||i&&(n=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const db=/\r\n|\n\r|\n|\r/g,ub=function(e,t,i=0){return e.slice(i,i+t.length)===t};function fb(e,t,i){return US(e.toString())+US(t.toString())+US(i)}function pb(e,t,i,r,n,s,a){const o=new VTTParser,l=am(new Uint8Array(e)).trim().replace(db,"\n").split("\n"),h=[],c=t?function(e,t=1){return R_(e,9e4,1/t)}(t.baseTime,t.timescale):0;let d,u="00:00.000",f=0,p=0,m=!0;o.oncue=function(e){const s=i[r];let a=i.ccOffset;const o=(f-c)/9e4;if(null!=s&&s.new&&(void 0!==p?a=i.ccOffset=s.start:function(e,t,i){let r=e[t],n=e[r.prevCC];if(!n||!n.new&&r.new)return e.ccOffset=e.presentationOffset=r.start,void(r.new=!1);for(;null!=(s=n)&&s.new;){var s;e.ccOffset+=r.start-n.start,r.new=!1,r=n,n=e[r.prevCC]}e.presentationOffset=i}(i,r,o)),o){if(!t)return void(d=new Error("Missing initPTS for VTT MPEGTS"));a=o-i.presentationOffset}const l=e.endTime-e.startTime,u=U_(9e4*(e.startTime+a-p),9e4*n)/9e4;e.startTime=Math.max(u,0),e.endTime=Math.max(u+l,0);const m=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(m)),e.id||(e.id=fb(e.startTime,e.endTime,m)),e.endTime>0&&h.push(e)},o.onparsingerror=function(e){d=e},o.onflush=function(){d?a(d):s(h)},l.forEach(e=>{if(m){if(ub(e,"X-TIMESTAMP-MAP=")){m=!1,e.slice(16).split(",").forEach(e=>{ub(e,"LOCAL:")?u=e.slice(6):ub(e,"MPEGTS:")&&(f=parseInt(e.slice(7)))});try{p=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),n=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(Op(t)&&Op(i)&&Op(r)&&Op(n)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=6e4*r,t+=36e5*n,t}(u)/1e3}catch(e){d=e}return}""===e&&(m=!1)}o.parse(e+"\n")}),o.flush()}const mb="stpp.ttml.im1t",gb=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,vb=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,yb={left:"start",center:"center",right:"end",start:"start",end:"end"};function _b(e,t,i,r){const n=Pm(new Uint8Array(e),["mdat"]);if(0===n.length)return void r(new Error("Could not parse IMSC1 mdat"));const s=n.map(e=>am(e)),a=function(e,t,i=1,r=!1){return R_(e,t,1/i,r)}(t.baseTime,1,t.timescale);try{s.forEach(e=>i(function(e,t){const i=(new DOMParser).parseFromString(e,"text/xml"),r=i.getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const n={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(n).reduce((e,t)=>(e[t]=r.getAttribute(`ttp:${t}`)||n[t],e),{}),a="preserve"!==r.getAttribute("xml:space"),o=bb(Sb(r,"styling","style")),l=bb(Sb(r,"layout","region")),h=Sb(r,"body","[begin]");return[].map.call(h,e=>{const i=Tb(e,a);if(!i||!e.hasAttribute("begin"))return null;const r=Mb(e.getAttribute("begin"),s),n=Mb(e.getAttribute("dur"),s);let h=Mb(e.getAttribute("end"),s);if(null===r)throw Eb(e);if(null===h){if(null===n)throw Eb(e);h=r+n}const c=new nb(r-t,h-t,i);c.id=fb(c.startTime,c.endTime,c.text);const d=function(e,t,i){const r="http://www.w3.org/ns/ttml#styling";let n=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;a&&i.hasOwnProperty(a)&&(n=i[a]);return s.reduce((i,s)=>{const a=xb(t,r,s)||xb(e,r,s)||xb(n,r,s);return a&&(i[s]=a),i},{})}(l[e.getAttribute("region")],o[e.getAttribute("style")],o),{textAlign:u}=d;if(u){const e=yb[u];e&&(c.lineAlign=e),c.align=u}return Yp(c,d),c}).filter(e=>null!==e)}(e,a)))}catch(e){r(e)}}function Sb(e,t,i){const r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(i)):[]}function bb(e){return e.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Tb(e,t){return[].slice.call(e.childNodes).reduce((e,i,r)=>{var n;return"br"===i.nodeName&&r?e+"\n":null!=(n=i.childNodes)&&n.length?Tb(i,t):t?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent},"")}function xb(e,t,i){return e&&e.hasAttributeNS(t,i)?e.getAttributeNS(t,i):null}function Eb(e){return new Error(`Could not parse ttml timestamp ${e}`)}function Mb(e,t){if(!e)return null;let i=sb(e);return null===i&&(gb.test(e)?i=function(e,t){const i=gb.exec(e),r=(0|i[4])+(0|i[5])/t.subFrameRate;return 3600*(0|i[1])+60*(0|i[2])+(0|i[3])+r/t.frameRate}(e,t):vb.test(e)&&(i=function(e,t){const i=vb.exec(e),r=Number(i[1]);switch(i[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/t.frameRate;case"t":return r/t.tickRate}return r}(e,t))),i}class OutputFilter{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}function wb(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function Ab(e,t){return!!e&&e.kind===wb(t)&&j_(t,e)}function Lb(e,t,i,r){return Math.min(t,r)-Math.max(e,i)}const Cb=/\s/,Rb={newCue(e,t,i,r){const n=[];let s,a,o,l,h;const c=self.VTTCue||self.TextTrackCue;for(let u=0;u<r.rows.length;u++)if(s=r.rows[u],o=!0,l=0,h="",!s.isEmpty()){var d;for(let e=0;e<s.chars.length;e++)Cb.test(s.chars[e].uchar)&&o?l++:(h+=s.chars[e].uchar,o=!1);s.cueStartTime=t,t===i&&(i+=1e-4),l>=16?l--:l++;const r=cb(h.trim()),f=fb(t,i,r);null!=e&&null!=(d=e.cues)&&d.getCueById(f)||(a=new c(t,i,r),a.id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),n.push(a))}return e&&n.length&&(n.sort((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line),n.forEach(t=>IS(e,t))),n}};const Pb=/(\d+)-(\d+)\/(\d+)/;class FetchLoader{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Ib,this.controller=new self.AbortController,this.stats=new LoadStats}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const n=function(e,t){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(Yp({},e.headers))};e.rangeEnd&&i.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return i}(e,this.controller.signal),s="arraybuffer"===e.responseType,a=s?"byteLength":"length",{maxTimeToFirstByteMs:o,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,n),self.clearTimeout(this.requestTimeout),t.timeout=o&&Op(o)?o:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},t.timeout);(H_(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(i=>{var n;this.response=this.loader=i;const a=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},l-(a-r.loading.start)),!i.ok){const{status:e,statusText:t}=i;throw new FetchError(t||"fetch, bad network response",e,i)}r.loading.first=a,r.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=Pb.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(Op(e))return e}const i=e.get("Content-Length");if(i)return parseInt(i)}(i.headers)||r.total;const o=null==(n=this.callbacks)?void 0:n.onProgress;return o&&Op(t.highWaterMark)?this.loadProgressively(i,r,e,t.highWaterMark,o):s?i.arrayBuffer():"json"===e.responseType?i.json():i.text()}).then(i=>{var n,s;const o=this.response;if(!o)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=i[a];l&&(r.loaded=r.total=l);const h={url:o.url,data:i,code:o.status},c=null==(n=this.callbacks)?void 0:n.onProgress;c&&!Op(t.highWaterMark)&&c(r,e,i,o),null==(s=this.callbacks)||s.onSuccess(h,r,e,o)}).catch(t=>{var i;if(self.clearTimeout(this.requestTimeout),r.aborted)return;const n=t&&t.code||0,s=t?t.message:null;null==(i=this.callbacks)||i.onError({code:n,text:s},e,t?t.details:null,r)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,r=0,n){const s=new ChunkCache,a=e.body.getReader(),o=()=>a.read().then(a=>{if(a.done)return s.dataLength&&n(t,i,s.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const l=a.value,h=l.length;return t.loaded+=h,h<r||s.dataLength?(s.push(l),s.dataLength>=r&&n(t,i,s.flush().buffer,e)):n(t,i,l.buffer,e),o()}).catch(()=>Promise.reject());return o()}}function Ib(e,t){return new self.Request(e.url,t)}class FetchError extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const Db=/^age:\s*[\d.]+\s*$/im;class XhrLoader{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new LoadStats,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const n=this.xhrSetup;n?Promise.resolve().then(()=>{if(this.loader===i&&!this.stats.aborted)return n(i,t.url)}).catch(e=>{if(this.loader===i&&!this.stats.aborted)return i.open("GET",t.url,!0),n(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(e=>{var n;null==(n=this.callbacks)||n.onError({code:i.status,text:e.message},t,i,r)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const r=t.headers,{maxTimeToFirstByteMs:n,maxLoadTimeMs:s}=i.loadPolicy;if(r)for(const t in r)e.setRequestHeader(t,r[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=n&&Op(n)?n:s,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const r=t.readyState,n=this.config;if(!i.aborted&&r>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),n.timeout!==n.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),n.timeout=n.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const r=t.status,l="text"===t.responseType?t.responseText:null;if(r>=200&&r<300){const n=null!=l?l:t.response;if(null!=n){var s,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const o="arraybuffer"===t.responseType?n.byteLength:n.length;i.loaded=i.total=o,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first);const l=null==(s=this.callbacks)?void 0:s.onProgress;l&&l(i,e,n,t);const h={url:t.responseURL,data:n,code:r};return void(null==(a=this.callbacks)||a.onSuccess(h,i,e,t))}}const h=n.loadPolicy.errorRetry;var o;if(Vg(h,i.retry,!1,{url:e.url,data:void 0,code:r}))this.retry(h);else rm.error(`${r} while loading ${e.url}`),null==(o=this.callbacks)||o.onError({code:r,text:t.statusText},e,t,i)}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry;if(Vg(e,this.stats.retry,!0))this.retry(e);else{var t;rm.warn(`timeout while loading ${null==(t=this.context)?void 0:t.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Fg(e,i.retry),i.retry++,rm.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Db.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const kb=Qp(Qp({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:6e7,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:XhrLoader,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class AbrController extends Logger{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=e=>{var t;const{fragCurrent:i,partCurrent:r,hls:n}=this,{autoLevelEnabled:s,media:a}=n;if(!i||!a)return;const o=performance.now(),l=r?r.stats:i.stats,h=r?r.duration:i.duration,c=o-l.loading.start,d=n.minAutoLevel,u=i.level,f=this._nextAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||u<=d)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!s)return;const p=f>-1&&f!==u,m=!!e||p;if(!m&&(a.paused||!a.playbackRate||!a.readyState))return;const g=n.mainForwardBufferInfo;if(!m&&null===g)return;const v=this.bwEstimator.getEstimateTTFB(),y=Math.abs(a.playbackRate);if(c<=Math.max(v,h/(2*y)*1e3))return;const _=g?g.len/y:0,S=l.loading.first?l.loading.first-l.loading.start:-1,b=l.loaded&&S>-1,T=this.getBwEstimate(),x=n.levels,E=x[u],M=Math.max(l.loaded,Math.round(h*(i.bitrate||E.averageBitrate)/8));let w=b?c-S:c;w<1&&b&&(w=Math.min(c,8*l.loaded/T));const A=b?1e3*l.loaded/w:0,L=v/1e3,C=A?(M-l.loaded)/A:8*M/T+L;if(C<=_)return;const R=A?8*A:T,P=!0===(null==(t=(null==e?void 0:e.details)||this.hls.latestLevelDetails)?void 0:t.live),D=this.hls.config.abrBandWidthUpFactor;let k,O=Number.POSITIVE_INFINITY;for(k=u-1;k>d;k--){const e=x[k].maxBitrate,t=!x[k].details||P;if(O=this.getTimeToLoadFrag(L,R,h*e,t),O<Math.min(_,h+L))break}if(O>=C)return;if(O>10*h)return;b?this.bwEstimator.sample(c-Math.min(v,S),l.loaded):this.bwEstimator.sampleTTFB(c);const U=x[k].maxBitrate;this.getBwEstimate()*D>U&&this.resetEstimator(U);const N=this.findBestLevel(U,d,k,0,_,1,1);N>-1&&(k=N),this.warn(`Fragment ${i.sn}${r?" part "+r.index:""} of level ${u} is loading too slowly;\n      Fragment duration: ${i.duration.toFixed(3)}\n      Time to underbuffer: ${_.toFixed(3)} s\n      Estimated load time for current fragment: ${C.toFixed(3)} s\n      Estimated load time for down switch fragment: ${O.toFixed(3)} s\n      TTFB estimate: ${0|S} ms\n      Current BW estimate: ${Op(T)?0|T:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${k} @ ${0|U} bps`),n.nextLoadLevel=n.nextAutoLevel=k,this.clearTimer();const F=()=>{if(this.clearTimer(),this.fragCurrent===i&&this.hls.loadLevel===k&&k>0){const e=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${k>0?"and switching down":""}\n      Fragment duration: ${i.duration.toFixed(3)} s\n      Time to underbuffer: ${e.toFixed(3)} s`),i.abortRequests(),this.fragCurrent=this.partCurrent=null,k>d){let t=this.findBestLevel(this.hls.levels[d].bitrate,d,k,0,e,1,1);-1===t&&(t=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=t,this.resetEstimator(this.hls.levels[t].bitrate)}}};p||C>2*O?F():this.timer=self.setInterval(F,1e3*O),n.trigger(Vp.FRAG_LOAD_EMERGENCY_ABORTED,{frag:i,part:r,stats:l})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new EwmaBandWidthEstimator(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.FRAG_LOADING,this.onFragLoading,this),e.on(Vp.FRAG_LOADED,this.onFragLoaded,this),e.on(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Vp.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.FRAG_LOADING,this.onFragLoading,this),e.off(Vp.FRAG_LOADED,this.onFragLoaded,this),e.off(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Vp.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(Vp.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){var r;if(!i.bitrateTest)this.fragCurrent=i,this.partCurrent=null!=(r=t.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case Bp.BUFFER_ADD_CODEC_ERROR:case Bp.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case Bp.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:i,partCurrent:r}=this;if(e&&i&&e.sn===i.sn&&e.level===i.level){const t=performance.now(),i=r?r.stats:e.stats,n=t-i.loading.start,s=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&s>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(n-Math.min(e,s),i.loaded)}else this.bwEstimator.sampleTTFB(n)}break}}}getTimeToLoadFrag(e,t,i,r){return e+i/t+(r?e+this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const i=this.hls.config,{loading:r}=t.stats,n=r.end-r.first;Op(n)&&(this.lastLevelLoadSec=n/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const r=i?i.stats:t.stats;if(t.type===Wp&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=i?i.duration:t.duration,n=this.hls.levels[t.level],s=(n.loaded?n.loaded.bytes:0)+r.loaded,a=(n.loaded?n.loaded.duration:0)+e;n.loaded={bytes:s,duration:a},n.realBitrate=Math.round(8*s/a)}if(t.bitrateTest){const e={stats:r,frag:t,part:i,id:t.type};this.onFragBuffered(Vp.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:r}=t,n=null!=r&&r.stats.loaded?r.stats:i.stats;if(n.aborted)return;if(this.ignoreFragment(i))return;const s=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(s,n.loaded),n.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==Wp||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,n=this.findBestLevel(i,t,e,0,r,1,1);if(n>-1)return n;const s=this.hls.firstLevel,a=Math.min(Math.max(s,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${s} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&i&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const r=t&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,r)&&t[e].loadError<=t[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:r,config:n,minAutoLevel:s}=i,a=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let h=n.abrBandWidthFactor,c=n.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,s,r,l,0,h,c);if(e>=0)return this.rebufferNotice=-1,e}let d=a?Math.min(a,n.maxStarvationDelay):n.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;if(e){d=(a?Math.min(a,n.maxLoadingDelay):n.maxLoadingDelay)-e,this.info(`bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),h=c=1}}const u=this.findBestLevel(o,s,r,l,d,h,c);if(this.rebufferNotice!==u&&(this.rebufferNotice=u,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${u}`)),u>-1)return u;const f=i.levels[s],p=i.loadLevelObj;return p&&(null==f?void 0:f.bitrate)<p.bitrate?s:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,r=e.mainForwardBufferInfo;return(r?r.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,r,n,s,a){var o;const l=r+n,h=this.lastLoadedFragLevel,c=-1===h?this.hls.firstLevel:h,{fragCurrent:d,partCurrent:u}=this,{levels:f,allAudioTracks:p,loadLevel:m,config:g}=this.hls;if(1===f.length)return 0;const v=f[c],y=!(null==(o=this.hls.latestLevelDetails)||!o.live),_=-1===m||-1===h;let S,b="SDR",T=(null==v?void 0:v.frameRate)||0;const{audioPreference:x,videoPreference:E}=g,M=this.audioTracksByGroup||(this.audioTracksByGroup=Eg(p));let w=-1;if(_){if(-1!==this.firstSelection)return this.firstSelection;const r=this.codecTiers||(this.codecTiers=function(e,t,i,r){return e.slice(i,r+1).reduce((e,i,r)=>{if(!i.codecSet)return e;const n=i.audioGroups;let s=e[i.codecSet];s||(e[i.codecSet]=s={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:r,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!n,fragmentError:0}),s.minBitrate=Math.min(s.minBitrate,i.bitrate);const a=Math.min(i.height,i.width);return s.minHeight=Math.min(s.minHeight,a),s.minFramerate=Math.min(s.minFramerate,i.frameRate),s.minIndex=Math.min(s.minIndex,r),s.maxScore=Math.max(s.maxScore,i.score),s.fragmentError+=i.fragmentError,s.videoRanges[i.videoRange]=(s.videoRanges[i.videoRange]||0)+1,n&&n.forEach(e=>{if(!e)return;const i=t.groups[e];i&&(s.hasDefaultAudio=s.hasDefaultAudio||t.hasDefaultAudio?i.hasDefault:i.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(i.channels).forEach(e=>{s.channels[e]=(s.channels[e]||0)+i.channels[e]}))}),e},{})}(f,M,t,i)),n=function(e,t,i,r,n){const s=Object.keys(e),a=null==r?void 0:r.channels,o=null==r?void 0:r.audioCodec,l=null==n?void 0:n.videoCodec,h=a&&2===parseInt(a);let c=!1,d=!1,u=1/0,f=1/0,p=1/0,m=1/0,g=0,v=[];const{preferHDR:y,allowedVideoRanges:_}=bg(t,n);for(let t=s.length;t--;){const i=e[s[t]];c||(c=i.channels[2]>0),u=Math.min(u,i.minHeight),f=Math.min(f,i.minFramerate),p=Math.min(p,i.minBitrate),_.filter(e=>i.videoRanges[e]>0).length>0&&(d=!0)}u=Op(u)?u:0,f=Op(f)?f:0;const S=Math.max(1080,u),b=Math.max(30,f);p=Op(p)?p:i,i=Math.max(p,i),d||(t=void 0);const T=s.length>1;return{codecSet:s.reduce((t,r)=>{const n=e[r];if(r===t)return t;if(v=d?_.filter(e=>n.videoRanges[e]>0):[],T){if(n.minBitrate>i)return xg(r,`min bitrate of ${n.minBitrate} > current estimate of ${i}`),t;if(!n.hasDefaultAudio)return xg(r,"no renditions with default or auto-select sound found"),t;if(o&&r.indexOf(o.substring(0,4))%5!=0)return xg(r,`audio codec preference "${o}" not found`),t;if(a&&!h){if(!n.channels[a])return xg(r,`no renditions with ${a} channel sound found (channels options: ${Object.keys(n.channels)})`),t}else if((!o||h)&&c&&0===n.channels[2])return xg(r,"no renditions with stereo sound found"),t;if(n.minHeight>S)return xg(r,`min resolution of ${n.minHeight} > maximum of ${S}`),t;if(n.minFramerate>b)return xg(r,`min framerate of ${n.minFramerate} > maximum of ${b}`),t;if(!v.some(e=>n.videoRanges[e]>0))return xg(r,`no variants with VIDEO-RANGE of ${Tg(v)} found`),t;if(l&&r.indexOf(l.substring(0,4))%5!=0)return xg(r,`video codec preference "${l}" not found`),t;if(n.maxScore<g)return xg(r,`max score of ${n.maxScore} < selected max of ${g}`),t}return t&&(tg(r)>=tg(t)||n.fragmentError>e[t].fragmentError)?t:(m=n.minIndex,g=n.maxScore,r)},void 0),videoRanges:v,preferHDR:y,minFramerate:f,minBitrate:p,minIndex:m}}(r,b,e,x,E),{codecSet:s,videoRanges:a,minFramerate:o,minBitrate:l,minIndex:h,preferHDR:c}=n;w=h,S=s,b=c?a[a.length-1]:a[0],T=o,e=Math.max(e,l),this.log(`picked start tier ${Tg(n)}`)}else S=null==v?void 0:v.codecSet,b=null==v?void 0:v.videoRange;const A=u?u.duration:d?d.duration:0,L=this.bwEstimator.getEstimateTTFB()/1e3,C=[];for(let o=i;o>=t;o--){var R;const t=f[o],d=o>c;if(!t)continue;if(g.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const i=navigator.mediaCapabilities;"function"==typeof(null==i?void 0:i.decodingInfo)&&(ug(t,M,b,T,e,x)||zm(t.videoCodec))?(t.supportedPromise=fg(t,M,i),t.supportedPromise.then(e=>{if(!this.hls)return;t.supportedResult=e;const i=this.hls.levels,r=i.indexOf(t);e.error?this.warn(`MediaCapabilities decodingInfo error: "${e.error}" for level ${r} ${Tg(e)}`):e.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${r} ${Tg(e)}`),r>-1&&i.length>1&&(this.log(`Removing unsupported level ${r}`),this.hls.removeLevel(r),-1===this.hls.loadLevel&&(this.hls.nextLoadLevel=0)))})):t.supportedResult=hg}if((S&&t.codecSet!==S||b&&t.videoRange!==b||d&&T>t.frameRate||!d&&T>0&&T<t.frameRate||t.supportedResult&&(null==(R=t.supportedResult.decodingInfoResults)||!R[0].smooth))&&(!_||o!==w)){C.push(o);continue}const p=t.details,v=(u?null==p?void 0:p.partTarget:null==p?void 0:p.averagetargetduration)||A;let E;E=d?a*e:s*e;const P=A&&r>=2*A&&0===n?t.averageBitrate:t.maxBitrate,D=this.getTimeToLoadFrag(L,E,P*v,void 0===p);if(E>=P&&(o===h||0===t.loadError&&0===t.fragmentError)&&(D<=L||!Op(D)||y&&!this.bitrateTestDelay||D<l)){const e=this.forcedAutoLevel;return o===m||-1!==e&&e===m||(C.length&&this.trace(`Skipped level(s) ${C.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${f[C[0]].codecs}" ${f[C[0]].videoRange}; not compatible with "${S}" ${b}`),this.info(`switch candidate:${c}->${o} adjustedbw(${Math.round(E)})-bitrate=${Math.round(E-P)} ttfb:${L.toFixed(1)} avgDuration:${v.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${D.toFixed(1)} firstSelection:${_} codecSet:${t.codecSet} videoRange:${t.videoRange} hls.loadLevel:${m}`)),_&&(this.firstSelection=o),o}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}},bufferController:class BufferController extends Logger{constructor(e,t){var i;super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=e=>{var t;this.hls&&"open"===(null==(t=this.mediaSource)?void 0:t.readyState)&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=e=>{const{media:t,mediaSource:i}=this;e&&this.log("Media source opened"),t&&i&&(i.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(Vp.MEDIA_ATTACHED,{media:t,mediaSource:i}),null!==this.mediaSource&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&this.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=(i=nm(e.config.preferManagedMediaSource),"undefined"!=typeof self&&i===self.ManagedMediaSource),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.BUFFER_RESET,this.onBufferReset,this),e.on(Vp.BUFFER_APPENDING,this.onBufferAppending,this),e.on(Vp.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Vp.BUFFER_EOS,this.onBufferEos,this),e.on(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Vp.FRAG_PARSED,this.onFragParsed,this),e.on(Vp.FRAG_CHANGED,this.onFragChanged,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.BUFFER_RESET,this.onBufferReset,this),e.off(Vp.BUFFER_APPENDING,this.onBufferAppending,this),e.off(Vp.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Vp.BUFFER_EOS,this.onBufferEos,this),e.off(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Vp.FRAG_PARSED,this.onFragParsed,this),e.off(Vp.FRAG_CHANGED,this.onFragChanged,this),e.off(Vp.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const e=this.isUpdating();e||this.operationQueue.removeBlockers();const t=this.isQueued();(e||t)&&this.warn(`Transfering MediaSource with${t?" operations in queue":""}${e?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const r=this.transferData;return!this.sourceBufferCount&&r&&r.mediaSource===t?Yp(i,r.tracks):this.sourceBuffers.forEach(e=>{const[t]=e;t&&(i[t]=Yp({},this.tracks[t]),this.removeBuffer(t)),e[0]=e[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){this.sourceBuffers=[[null,null],[null,null]],this.tracks={},this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let r=2;(t.audio&&!t.video||!t.altAudio)&&(r=1),this.bufferCodecEventsTotal=r,this.log(`${r} bufferCodec event(s) expected.`),null!=(i=this.transferData)&&i.mediaSource&&this.sourceBufferCount&&r&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media,r=nm(this.appendSource);if(this.transferData=this.overrides=void 0,i&&r){const e=!!t.mediaSource;(e||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const n=this.mediaSource=t.mediaSource||new r;if(this.assignMediaSource(n),e)this._objectUrl=i.src,this.attachTransferred();else{const e=this._objectUrl=self.URL.createObjectURL(n);if(this.appendSource)try{i.removeAttribute("src");const t=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||t&&n instanceof t,X_(i),function(e,t){const i=self.document.createElement("source");i.type="video/mp4",i.src=t,e.appendChild(i)}(i,e),i.load()}catch(t){i.src=e}else i.src=e}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${(null==(t=this.transferData)?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${null==(i=e.constructor)?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,r=t.tracks,n=r?Object.keys(r):null,s=n?n.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(r&&n&&s){if(!this.tracksReady)return this.hls.config.startFragPrefetch=!0,void this.log("attachTransferred: waiting for SourceBuffer track info");if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})\nrequired tracks: ${Tg(i,(e,t)=>"initSegment"===e?void 0:t)};\ntransfer tracks: ${Tg(r,(e,t)=>"initSegment"===e?void 0:t)}}`),!sm(r,i)){t.mediaSource=null,t.tracks=void 0;const n=e.currentTime,s=this.details,a=Math.max(n,(null==s?void 0:s.fragments[0].start)||0);return a-n>1?void this.log(`attachTransferred: waiting for playback to reach new tracks start time ${n} -> ${a}`):(this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(r)}"->"${Object.keys(i)}") start time: ${a} currentTime: ${n}`),this.onMediaDetaching(Vp.MEDIA_DETACHING,{}),this.onMediaAttaching(Vp.MEDIA_ATTACHING,t),void(e.currentTime=a))}this.transferData=void 0,n.forEach(e=>{const t=e,i=r[t];if(i){const e=i.buffer;if(e){const r=this.fragmentTracker,n=i.id;if(r.hasFragments(n)||r.hasParts(n)){const i=BufferHelper.getBuffered(e);r.detectEvictedFragments(t,i,n,null,!0)}const s=Q_(t),a=[t,e];this.sourceBuffers[s]=a,e.updating&&this.operationQueue&&this.operationQueue.prependBlocker(t),this.trackSourceBuffer(t,i)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=null==(e=this.mediaSource)?void 0:e.readyState;return"open"===t||"ended"===t}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:r,mediaSource:n,_objectUrl:s}=this;if(n){if(this.log("media source "+(i?"transferring":"detaching")),i)this.sourceBuffers.forEach(([e])=>{e&&this.removeBuffer(e)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const e="open"===n.readyState;try{const t=n.sourceBuffers;for(let i=t.length;i--;)e&&t[i].abort(),n.removeSourceBuffer(t[i]);e&&n.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.removeEventListener("startstreaming",this._onStartStreaming),n.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}r&&(r.removeEventListener("emptied",this._onMediaEmptied),i||(s&&self.URL.revokeObjectURL(s),this.mediaSrc===s?(r.removeAttribute("src"),this.appendSource&&X_(r),r.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(Vp.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=null==(t=this.tracks[e])?void 0:t.buffer;if(this.removeBuffer(e),i)try{var r;null!=(r=this.mediaSource)&&r.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(t){this.warn(`onBufferReset ${e}`,t)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Q_(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new BufferOperationQueue(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,r=Object.keys(t);this.log(`BUFFER_CODECS: "${r}" (current SB count ${this.sourceBufferCount})`);const n="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),s=!n&&this.sourceBufferCount&&this.media&&r.some(e=>!i[e]);n||s?this.warn(`Unsupported transition between "${Object.keys(i)}" and "${r}" SourceBuffers`):(r.forEach(e=>{var r,n,s;const a=t[e],{id:o,codec:l,levelCodec:h,container:c,metadata:d,supplemental:u}=a;let f=i[e];const p=null==(r=this.transferData)||null==(n=r.tracks)?void 0:n[e],m=null!=p&&p.buffer?p:f,g=(null==m?void 0:m.pendingCodec)||(null==m?void 0:m.codec),v=null==m?void 0:m.levelCodec;f||(f=i[e]={buffer:void 0,listeners:[],codec:l,supplemental:u,container:c,levelCodec:h,metadata:d,id:o});const y=sg(g,v),_=null==y?void 0:y.replace(K_,"$1");let S=sg(l,h);const b=null==(s=S)?void 0:s.replace(K_,"$1");S&&y&&_!==b&&("audio"===e.slice(0,5)&&(S=ng(S,this.appendSource)),this.log(`switching codec ${g} to ${S}`),S!==(f.pendingCodec||f.codec)&&(f.pendingCodec=S),f.container=c,this.appendChangeType(e,c,S))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),this.sourceBufferCount||this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const r=`${t};codecs=${i}`,n={label:`change-type=${r}`,execute:()=>{const n=this.tracks[e];if(n){const s=n.buffer;null!=s&&s.changeType&&(this.log(`changing ${e} sourceBuffer type to ${r}`),s.changeType(r),n.codec=i,n.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};this.append(n,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,r=i+.05*e.duration;if(!0===(null==(t=this.fragmentTracker.getAppendedFrag(i,Wp))?void 0:t.gap))return;const n={label:"block-audio",execute:()=>{var e;const t=this.tracks.video;(this.lastVideoAppendEnd>r||null!=t&&t.buffer&&BufferHelper.isBuffered(t.buffer,r)||!0===(null==(e=this.fragmentTracker.getAppendedFrag(r,Wp))?void 0:e.gap))&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn("Error executing block-audio operation",e)}};this.blockedAudioAppend={op:n,frag:e},this.append(n,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:r,type:n,parent:s,frag:a,part:o,chunkMeta:l}=t,h=l.buffering[n],c=a.sn,d=self.performance.now();h.start=d;const u=a.stats.buffering,f=o?o.stats.buffering:null;0===u.start&&(u.start=d),f&&0===f.start&&(f.start=d);const p=i.audio;let m=!1;"audio"===n&&"audio/mpeg"===(null==p?void 0:p.container)&&(m=!this.lastMpegAudioChunk||1===l.id||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const g=this.tracks.video,v=null==g?void 0:g.buffer;if(v&&"initSegment"!==c){const e=o||a,t=this.blockedAudioAppend;if("audio"!==n||"main"===s||this.blockedAudioAppend){if("video"===n){const i=e.end;if(t){const e=t.frag.start;(i>e||i<this.lastVideoAppendEnd||BufferHelper.isBuffered(v,e))&&this.unblockAudio()}this.lastVideoAppendEnd=i}}else{const t=e.start+.05*e.duration,i=v.buffered,r=this.currentOp("video");i.length||r?!r&&!BufferHelper.isBuffered(v,t)&&this.lastVideoAppendEnd<t&&this.blockAudio(e):this.blockAudio(e)}}const y=(o||a).start,_={label:`append-${n}`,execute:()=>{if(h.executeStart=self.performance.now(),m){const e=this.tracks[n];if(e){const t=e.buffer;if(t){const e=y-t.timestampOffset;Math.abs(e)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${y} (delta: ${e}) sn: ${c})`),t.timestampOffset=y)}}}this.appendExecutor(r,n)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();h.executeEnd=h.end=e,0===u.first&&(u.first=e),f&&0===f.first&&(f.first=e);const t={};this.sourceBuffers.forEach(([e,i])=>{e&&(t[e]=BufferHelper.getBuffered(i))}),this.appendErrors[n]=0,"audio"===n||"video"===n?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(Vp.BUFFER_APPENDED,{type:n,frag:a,part:o,chunkMeta:l,parent:a.type,timeRanges:t})},onError:e=>{var t;const i={type:Fp.MEDIA_ERROR,parent:a.type,details:Bp.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:a,part:o,chunkMeta:l,error:e,err:e,fatal:!1},r=null==(t=this.media)?void 0:t.error;if(e.code===DOMException.QUOTA_EXCEEDED_ERR)i.details=Bp.BUFFER_FULL_ERROR;else if(e.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!r)i.errorAction=Kg(!0);else if(e.name===Y_&&0===this.sourceBufferCount)i.errorAction=Kg(!0);else{const e=++this.appendErrors[n];this.warn(`Failed ${e}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${n}" sourceBuffer (${r||"no media error"})`),(e>=this.hls.config.appendErrorMaxRetry||r)&&(i.fatal=!0)}this.hls.trigger(Vp.ERROR,i)}};this.append(_,n,this.isPending(this.tracks[n]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(Vp.BUFFER_FLUSHED,{type:e})},onError:r=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,r)}}}onBufferFlushing(e,t){const{type:i,startOffset:r,endOffset:n}=t;i?this.append(this.getFlushOp(i,r,n),i):this.sourceBuffers.forEach(([e])=>{e&&this.append(this.getFlushOp(e,r,n),e)})}onFragParsed(e,t){const{frag:i,part:r}=t,n=[],s=r?r.elementaryStreams:i.elementaryStreams;s[_m]?n.push("audiovideo"):(s[vm]&&n.push("audio"),s[ym]&&n.push("video"));0===n.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(()=>{const e=self.performance.now();i.stats.buffering.end=e,r&&(r.stats.buffering.end=e);const t=r?r.stats:i.stats;this.hls.trigger(Vp.FRAG_BUFFERED,{frag:i,part:r,stats:t,id:i.type})},n).catch(e=>{this.warn(`Fragment buffered callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!(null!=(t=this.tracks[e])&&t.ended)||(null==(i=this.tracks[e])?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([e])=>{if(e){const i=this.tracks[e];t.type&&t.type!==e||(i.ending=!0,i.ended||(i.ended=!0,this.log(`${e} buffer reached EOS`)))}});const r=!1!==(null==(i=this.overrides)?void 0:i.endOfStream);this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t;return e&&!(null!=(t=this.tracks[e])&&t.ended)})&&(r?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream(),this.hls.trigger(Vp.BUFFERED_TO_END,void 0)):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})):(this.tracksEnded(),this.hls.trigger(Vp.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(null!==e){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===Bp.BUFFER_APPEND_ERROR&&t.frag){var i;const e=null==(i=t.errorAction)?void 0:i.nextAutoLevel;Op(e)&&e!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||null===t)return;if(!this.sourceBufferCount)return;const r=e.config,n=i.currentTime,s=t.levelTargetDuration,a=t.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(Op(a)&&a>=0){const e=Math.max(a,s),t=Math.floor(n/s)*s-e;this.flushBackBuffer(n,s,t)}if(Op(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const e=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),t=Math.max(e,s),i=Math.floor(n/s)*s+t;this.flushFrontBuffer(n,s,i)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([e,t])=>{if(t){const n=BufferHelper.getBuffered(t);if(n.length>0&&i>n.start(0)){var r;this.hls.trigger(Vp.BACK_BUFFER_REACHED,{bufferEnd:i});const t=this.tracks[e];if(null!=(r=this.details)&&r.live)this.hls.trigger(Vp.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(null!=t&&t.ended)return void this.log(`Cannot flush ${e} back buffer while SourceBuffer is in ended state`);this.hls.trigger(Vp.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:e})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([t,r])=>{if(r){const n=BufferHelper.getBuffered(r),s=n.length;if(s<2)return;const a=n.start(s-1),o=n.end(s-1);if(i>a||e>=a&&e<=o)return;this.hls.trigger(Vp.BUFFER_FLUSHING,{startOffset:a,endOffset:1/0,type:t})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||"open"!==(null==i?void 0:i.readyState))return null;const r=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){const e=Math.max(0,t.fragmentStart);return{duration:1/0,start:e,end:Math.max(e,r)}}return{duration:1/0}}const n=null==(e=this.overrides)?void 0:e.duration;if(n)return Op(n)?{duration:n}:null;const s=this.media.duration;return r>(Op(i.duration)?i.duration:0)&&r>s||!Op(s)?{duration:r}:null}updateMediaSource({duration:e,start:t,end:i}){const r=this.mediaSource;this.media&&r&&"open"===r.readyState&&(r.duration!==e&&(Op(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),r.duration=e),void 0!==t&&void 0!==i&&(this.log(`MediaSource duration is set to ${r.duration}. Setting seekable range to ${t}-${i}.`),r.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${Tg(i)}`),this.tracksReady){var r;const e=null==(r=this.transferData)?void 0:r.tracks;e&&Object.keys(e).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const r=this.tracks[t];e[t]={buffer:i,container:r.container,codec:r.codec,supplemental:r.supplemental,levelCodec:r.levelCodec,id:r.id,metadata:r.metadata}}}),this.hls.trigger(Vp.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([e])=>{this.executeNext(e)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const n in e){const s=n,a=e[s];if(this.isPending(a)){const e=this.getTrackCodec(a,s),n=`${a.container};codecs=${e}`;a.codec=e,this.log(`creating sourceBuffer(${n})${this.currentOp(s)?" Queued":""} ${Tg(a)}`);try{const e=i.addSourceBuffer(n),r=Q_(s),o=[s,e];t[r]=o,a.buffer=e}catch(e){var r;return this.error(`error while trying to add sourceBuffer: ${e.message}`),this.shiftAndExecuteNext(s),null==(r=this.operationQueue)||r.removeBlockers(),delete this.tracks[s],void this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:s,mimeType:n,parent:a.id})}this.trackSourceBuffer(s,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let r=e.codec;i&&("video"===t||"audiovideo"===t)&&Qm(i,"video")&&(r=function(e,t){const i=[];if(e){const t=e.split(",");for(let e=0;e<t.length;e++)Xm(t[e],"video")||i.push(t[e])}return t&&i.push(t),i.join(",")}(r,i));const n=sg(r,e.levelCodec);return n?"audio"===t.slice(0,5)?ng(n,this.appendSource):n:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const r=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:r,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(e,t)=>{const i=t.removedRanges;null!=i&&i.length&&this.hls.trigger(Vp.BUFFER_FLUSHED,{type:e})})}get mediaSrc(){var e,t;const i=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==i?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const r=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(i=this.mediaSource)?void 0:i.readyState}`);this.error(`${r}`,t),this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:r,fatal:!1});const n=this.currentOp(e);n&&n.onError(r)}removeExecutor(e,t,i){const{media:r,mediaSource:n}=this,s=this.tracks[e],a=null==s?void 0:s.buffer;if(!r||!n||!a)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void this.shiftAndExecuteNext(e);const o=Op(r.duration)?r.duration:1/0,l=Op(n.duration)?n.duration:1/0,h=Math.max(0,t),c=Math.min(i,o,l);c>h&&(!s.ending||s.ended)?(s.ended=!1,this.log(`Removing [${h},${c}] from the ${e} SourceBuffer`),a.remove(h,c)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],r=null==i?void 0:i.buffer;if(!r)throw new HlsJsTrackRemovedError(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,r.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(e=>{this.warn(`SourceBuffer blocked callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(e){this.warn(`Callback run without blocking ${this.operationQueue} ${e}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,r=t.map(e=>this.appendBlocker(e));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(r).then(t=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(e=>{var t;const i=null==(t=this.tracks[e])?void 0:t.buffer;i&&!i.updating&&this.shiftAndExecuteNext(e)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const r=this.tracks[e];if(!r)return;const n=r.buffer;if(!n)return;const s=i.bind(this,e);r.listeners.push({event:t,listener:s}),n.addEventListener(t,s)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(e=>{i.removeEventListener(e.event,e.listener)}),t.listeners.length=0)}},capLevelController:CapLevelController,errorController:class ErrorController extends Logger{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(Vp.ERROR,this.onError,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Vp.ERROR,this.onError,this),e.off(Vp.ERROR,this.onErrorOut,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===Wp?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const r=this.hls,n=t.context;switch(t.details){case Bp.FRAG_LOAD_ERROR:case Bp.FRAG_LOAD_TIMEOUT:case Bp.KEY_LOAD_ERROR:case Bp.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case Bp.FRAG_PARSING_ERROR:if(null!=(i=t.frag)&&i.gap)return void(t.errorAction=Kg());case Bp.FRAG_GAP:case Bp.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=zg);case Bp.LEVEL_EMPTY_ERROR:case Bp.LEVEL_PARSING_ERROR:{var s,a;const e=t.parent===Wp?t.level:r.loadLevel;t.details===Bp.LEVEL_EMPTY_ERROR&&null!=(s=t.context)&&null!=(a=s.levelDetails)&&a.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case Bp.LEVEL_LOAD_ERROR:case Bp.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==n?void 0:n.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.level)));case Bp.AUDIO_TRACK_LOAD_ERROR:case Bp.AUDIO_TRACK_LOAD_TIMEOUT:case Bp.SUBTITLE_LOAD_ERROR:case Bp.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const e=r.loadLevelObj;if(e&&(n.type===Hp&&e.hasAudioGroup(n.groupId)||n.type===$p&&e.hasSubtitleGroup(n.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=zg,void(t.errorAction.flags=qg)}return;case Bp.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=r.loadLevelObj,i=null==e?void 0:e.attrs["HDCP-LEVEL"];i?t.errorAction={action:zg,flags:jg,hdcpLevel:i}:this.keySystemError(t)}return;case Bp.BUFFER_ADD_CODEC_ERROR:case Bp.REMUX_ALLOC_ERROR:case Bp.BUFFER_APPEND_ERROR:var o;if(!t.errorAction)t.errorAction=this.getLevelSwitchAction(t,null!=(o=t.level)?o:r.loadLevel);return;case Bp.INTERNAL_EXCEPTION:case Bp.BUFFER_APPENDING_ERROR:case Bp.BUFFER_FULL_ERROR:case Bp.LEVEL_SWITCH_ERROR:case Bp.BUFFER_STALLED_ERROR:case Bp.BUFFER_SEEK_OVER_HOLE:case Bp.BUFFER_NUDGE_ON_STALL:return void(t.errorAction=Kg())}t.type===Fp.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=Ng(this.hls.config.playlistLoadPolicy,e),r=this.playlistError++;if(Vg(i,r,Ug(e),e.response))return{action:$g,flags:Wg,retryConfig:i,retryCount:r};const n=this.getLevelSwitchAction(e,t);return i&&(n.retryConfig=i,n.retryCount=r),n}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),r=t.levels[i],{fragLoadPolicy:n,keyLoadPolicy:s}=t.config,a=Ng(e.details.startsWith("key")?s:n,e),o=t.levels.reduce((e,t)=>e+t.fragmentError,0);if(r){e.details!==Bp.FRAG_GAP&&r.fragmentError++;if(Vg(a,o,Ug(e),e.response))return{action:$g,flags:Wg,retryConfig:a,retryCount:o}}const l=this.getLevelSwitchAction(e,i);return a&&(l.retryConfig=a,l.retryCount=o),l}getLevelSwitchAction(e,t){const i=this.hls;null==t&&(t=i.loadLevel);const r=this.hls.levels[t];if(r){var n,s;const t=e.details;r.loadError++,t===Bp.BUFFER_APPEND_ERROR&&r.fragmentError++;let l=-1;const{levels:h,loadLevel:c,minAutoLevel:d,maxAutoLevel:u}=i;i.autoLevelEnabled||i.config.preserveManualLevelOnError||(i.loadLevel=-1);const f=null==(n=e.frag)?void 0:n.type,p=(f===qp&&t===Bp.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===Bp.BUFFER_ADD_CODEC_ERROR||t===Bp.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:e})=>r.audioCodec!==e),m="video"===e.sourceBufferName&&(t===Bp.BUFFER_ADD_CODEC_ERROR||t===Bp.BUFFER_APPEND_ERROR)&&h.some(({codecSet:e,audioCodec:t})=>r.codecSet!==e&&r.audioCodec===t),{type:g,groupId:v}=null!=(s=e.context)?s:{};for(let i=h.length;i--;){const n=(i+c)%h.length;if(n!==c&&n>=d&&n<=u&&0===h[n].loadError){var a,o;const i=h[n];if(t===Bp.FRAG_GAP&&f===Wp&&e.frag){const t=h[n].details;if(t){const i=Ig(e.frag,t.fragments,e.frag.start);if(null!=i&&i.gap)continue}}else{if(g===Hp&&i.hasAudioGroup(v)||g===$p&&i.hasSubtitleGroup(v))continue;if(f===qp&&null!=(a=r.audioGroups)&&a.some(e=>i.hasAudioGroup(e))||f===jp&&null!=(o=r.subtitleGroups)&&o.some(e=>i.hasSubtitleGroup(e))||p&&r.audioCodec===i.audioCodec||!p&&r.audioCodec!==i.audioCodec||m&&r.codecSet===i.codecSet)continue}l=n;break}}if(l>-1&&i.loadLevel!==l)return e.levelRetry=!0,this.playlistError=0,{action:zg,flags:Wg,nextAutoLevel:l}}return{action:zg,flags:qg}}onErrorOut(e,t){var i;switch(null==(i=t.errorAction)?void 0:i.action){case Gg:break;case zg:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===Bp.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:r,hdcpLevel:n,nextAutoLevel:s}=i;switch(r){case Wg:this.switchLevel(e,s);break;case jg:n&&(t.maxHdcpLevel=pg[pg.indexOf(n)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(e,s)}switchLevel(e,t){if(void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===Bp.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&"audiovideo"!==e.sourceBufferName)){const t=lg(e.mimeType),i=this.hls.levels;for(let r=i.length;r--;)i[r][`${e.sourceBufferName}Codec`]===t&&this.hls.removeLevel(r)}}},fpsController:class FPSController{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const r=performance.now();if(t){if(this.lastTime){const e=r-this.lastTime,n=i-this.lastDroppedFrames,s=t-this.lastDecodedFrames,a=1e3*n/e,o=this.hls;if(o.trigger(Vp.FPS_DROP,{currentDropped:n,currentDecoded:s,totalDroppedFrames:i}),a>0&&n>o.config.fpsDroppedMonitoringThreshold*s){let e=o.currentLevel;o.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(Vp.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Uv,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:Rb,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class SubtitleStreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",jp),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Vp.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Vp.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(Vp.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Vp.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Vp.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Vp.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(Vp.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Vp.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=Sy,this.setInterval(500),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:r}=t;if(Sm(i)&&(this.fragPrevious=i),this.state=Sy,!r)return;const n=this.tracksBuffered[this.currentTrackId];if(!n)return;let s;const a=i.start;for(let e=0;e<n.length;e++)if(a>=n[e].start&&a<=n[e].end){s=n[e];break}const o=i.start+i.duration;s?s.end=o:(s={start:a,end:o},n.push(s)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:r}=t;if(0===i&&r!==Number.POSITIVE_INFINITY){const e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach(t=>{for(let i=0;i<t.length;)if(t[i].end<=e)t.shift();else{if(!(t[i].start<e))break;t[i].start=e,i++}}),this.fragmentTracker.removeFragmentsInRange(i,e,jp)}}onError(e,t){const i=t.frag;(null==i?void 0:i.type)===jp&&(t.details===Bp.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==_y&&(this.state=Sy))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&W_(this.levels,t)?this.levels=t.map(e=>new Level(e)):(this.tracksBuffered=[],this.levels=t.map(e=>{const t=new Level(e);return this.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,jp),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,null==(i=this.levels)||!i.length||-1===this.currentTrackId)return void this.clearInterval();const r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.state!==_y&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:r,levels:n}=this,{details:s,id:a}=t;if(!n)return void this.warn(`Subtitle tracks were reset while loading level ${a}`);const o=n[a];if(a>=n.length||!o)return;this.log(`Subtitle track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(s.live||null!=(i=o.details)&&i.live){const e=this.mainDetails;if(s.deltaUpdateFailed||!e)return;const t=e.fragments[0];var h;if(o.details)l=this.alignPlaylists(s,o.details,null==(h=this.levelLastLoaded)?void 0:h.details),0===l&&t&&(l=t.start,oy(s,l));else s.hasProgramDateTime&&e.hasProgramDateTime?(vy(s,e),l=s.fragmentStart):t&&(l=t.start,oy(s,l))}if(o.details=s,this.levelLastLoaded=o,a===r&&(this.hls.trigger(Vp.SUBTITLE_TRACK_UPDATED,{details:s,id:a,groupId:t.groupId}),this.tick(),s.live&&!this.fragCurrent&&this.media&&this.state===Sy)){Ig(null,s.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,r=t.decryptdata,n=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&null!=r&&r.key&&r.iv&&vv(r.method)){const e=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer,yv(r.method)).catch(e=>{throw n.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(i=>{const r=performance.now();n.trigger(Vp.FRAG_DECRYPTED,{frag:t,payload:i,stats:{tstart:e,tdecrypt:r}})}).catch(e=>{this.warn(`${e.name}: ${e.message}`),this.state=Sy})}}doTick(){if(this.media){if(this.state===Sy){const{currentTrackId:e,levels:t}=this,i=null==t?void 0:t[e];if(!i||!t.length||!i.details)return;if(this.waitForLive(i))return;const{config:r}=this,n=this.getLoadPosition(),s=BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,r.maxBufferHole),{end:a,len:o}=s,l=i.details;if(o>this.hls.maxBufferLength+l.levelTargetDuration)return;const h=l.fragments,c=h.length,d=l.edge;let u=null;const f=this.fragPrevious;if(a<d){const e=r.maxFragLookUpTolerance,t=a>d-e?0:e;u=Ig(f,h,Math.max(h[0].start,a),t),!u&&f&&f.start<h[0].start&&(u=h[0])}else u=h[c-1];if(u=this.filterReplacedPrimary(u,i.details),!u)return;const p=h[u.sn-l.startSN-1];if(p&&p.cc===u.cc&&this.fragmentTracker.getState(p)===Yg&&(u=p),this.fragmentTracker.getState(u)===Yg){const e=this.mapToInitFragWhenRequired(u);e&&this.loadFragment(e,i,a)}}}else this.state=Sy}loadFragment(e,t,i){Sm(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new BufferableInstance(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class SubtitleTrackController extends BasePlaylistController{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=OS(this.media.textTracks);for(let i=0;i<t.length;i++)if("hidden"===t[i].mode)e=t[i];else if("showing"===t[i].mode){e=t[i];break}const i=this.findTrackForTextTrack(e);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.on(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Vp.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.off(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Vp.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Vp.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const r=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,r)return;OS(i.textTracks).forEach(e=>{DS(e)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:r,details:n}=t,s=this.tracksInGroup[i];if(!s||s.groupId!==r)return void this.warn(`Subtitle track with id:${i} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Subtitle track ${i} "${s.name}" lang:${s.lang} group:${r} loaded [${n.startSN}-${n.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,r=this.groupIds;let n=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some(e=>-1===(null==r?void 0:r.indexOf(e)))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!i||-1!==i.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!n&&t){this.selectDefaultTrack=!1;const i=wg(t,e);if(i>-1)n=e[i];else{const e=wg(t,this.tracks);n=this.tracks[e]}}let r=this.findTrackId(n);-1===r&&n&&(r=this.findTrackId(null));const s={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==i?void 0:i.join(",")}" group-id`),this.hls.trigger(Vp.SUBTITLE_TRACKS_UPDATED,s),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let r=0;r<t.length;r++){const n=t[r];if((!i||n.default)&&(i||e)&&(!e||Ag(n,e)))return r}if(e){for(let i=0;i<t.length;i++){const r=t[i];if(q_(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const r=t[i];if(q_(e.attrs,r.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){if(j_(t[i],e))return i}}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==$p||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(-1===e.id)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Ag(e,i))return i;const r=wg(e,this.tracksInGroup);if(r>-1){const e=this.tracksInGroup[r];return this.setSubtitleTrack(r),e}if(i)return null;{const i=wg(e,t);if(i>-1)return t[i]}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,r=e.groupId,n=this.getUrlWithDirectives(e.url,t),s=e.details,a=null==s?void 0:s.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&s.live?" age "+a.toFixed(1)+(s.type?" "+s.type||0:""):""} ${n}`),this.hls.trigger(Vp.SUBTITLE_TRACK_LOADING,{url:n,id:i,groupId:r,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=OS(e.textTracks),i=this.currentTrack;let r;if(i&&(r=t.filter(e=>j_(i,e))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(e=>{"disabled"!==e.mode&&e!==r&&(e.mode="disabled")}),r){const e=this.subtitleDisplay?"showing":"hidden";r.mode!==e&&(r.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!Op(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.selectDefaultTrack=!1;const i=this.currentTrack,r=t[e]||null;if(this.trackId=e,this.currentTrack=r,this.toggleTrackModes(),!r)return void this.hls.trigger(Vp.SUBTITLE_TRACK_SWITCH,{id:e});const n=!!r.details&&!r.details.live;if(e===this.trackId&&r===i&&n)return;this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:s,groupId:a="",name:o,type:l,url:h}=r;this.hls.trigger(Vp.SUBTITLE_TRACK_SWITCH,{id:s,groupId:a,name:o,type:l,url:h});const c=this.switchParams(r.url,null==i?void 0:i.details,r.details);this.loadPlaylist(c)}},timelineController:class TimelineController{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Vp.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Vp.FRAG_LOADING,this.onFragLoading,this),e.on(Vp.FRAG_LOADED,this.onFragLoaded,this),e.on(Vp.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(Vp.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(Vp.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Vp.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Vp.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Vp.FRAG_LOADING,this.onFragLoading,this),e.off(Vp.FRAG_LOADED,this.onFragLoaded,this),e.off(Vp.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(Vp.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(Vp.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Vp.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new OutputFilter(this,"textTrack1"),t=new OutputFilter(this,"textTrack2"),i=new OutputFilter(this,"textTrack3"),r=new OutputFilter(this,"textTrack4");this.cea608Parser1=new Cea608Parser(1,e,t),this.cea608Parser2=new Cea608Parser(3,i,r)}addCues(e,t,i,r,n){let s=!1;for(let e=n.length;e--;){const r=n[e],a=Lb(r[0],r[1],t,i);if(a>=0&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i),s=!0,a/(i-t)>.5))return}if(s||n.push([t,i]),this.config.renderTextTracksNatively){const n=this.captionsTracks[e];this.Cues.newCue(n,t,i,r)}else{const n=this.Cues.newCue(null,t,i,r);this.hls.trigger(Vp.CUES_PARSED,{type:"captions",cues:n,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:r,timescale:n}){const{unparsedVttFrags:s}=this;i===Wp&&(this.initPTS[t.cc]={baseTime:r,timescale:n}),s.length&&(this.unparsedVttFrags=[],s.forEach(e=>{this.onFragLoaded(Vp.FRAG_LOADED,e)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let r=0;r<i.textTracks.length;r++){const n=i.textTracks[r];if(Ab(n,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return n}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:r}=this,{label:n,languageCode:s}=t[e],a=this.getExistingTrack(n,s);if(a)i[e]=a,DS(i[e]),PS(i[e],r);else{const t=this.createTextTrack("captions",n,s);t&&(t[e]=!0,i[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(Vp.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(e,t,i){const r=this.media;if(r)return r.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:r}=this;Object.keys(r).forEach(e=>{DS(r[e]),delete r[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)DS(t[e])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],r=i.some(e=>e.textCodec===mb);if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(W_(this.tracks,i))return void(this.tracks=i);if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const e=this.media,t=e?OS(e.textTracks):null;if(this.tracks.forEach((e,i)=>{let r;if(t){let i=null;for(let r=0;r<t.length;r++)if(t[r]&&Ab(t[r],e)){i=t[r],t[r]=null;break}i&&(r=i)}if(r)DS(r);else{const t=wb(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode="disabled")}r&&this.textTracks.push(r)}),null!=t&&t.length){const e=t.filter(e=>null!==e).map(e=>e.label);e.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map(e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}));this.hls.trigger(Vp.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const i=`textTrack${t[1]}`,r=this.captionsProperties[i];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===Wp){var i,r;const{cea608Parser1:e,cea608Parser2:n,lastSn:s}=this,{cc:a,sn:o}=t.frag,l=null!=(i=null==(r=t.part)?void 0:r.index)?i:-1;e&&n&&(o!==s+1||o===s&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(e.reset(),n.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:i,payload:r}=t;if(i.type===jp)if(r.byteLength){const e=i.decryptdata,n="stats"in t;if(null==e||!e.encrypted||n){const e=this.tracks[i.level],n=this.vttCCs;n[i.cc]||(n[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),e&&e.textCodec===mb?this._parseIMSC1(i,r):this._parseVTTs(t)}}else this.hls.trigger(Vp.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;_b(t,this.initPTS[e.cc],t=>{this._appendCues(t,e.level),i.trigger(Vp.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},t=>{i.logger.log(`Failed to parse IMSC1: ${t}`),i.trigger(Vp.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})}_parseVTTs(e){var t;const{frag:i,payload:r}=e,{initPTS:n,unparsedVttFrags:s}=this,a=n.length-1;if(!n[i.cc]&&-1===a)return void s.push(e);const o=this.hls;pb(null!=(t=i.initSegment)&&t.data?Vm(i.initSegment.data,new Uint8Array(r)).buffer:r,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,e=>{this._appendCues(e,i.level),o.trigger(Vp.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},t=>{const n="Missing initPTS for VTT MPEGTS"===t.message;n?s.push(e):this._fallbackToIMSC1(i,r),o.logger.log(`Failed to parse VTT cue: ${t}`),n&&a>i.cc||o.trigger(Vp.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:t})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||_b(t,this.initPTS[e.cc],()=>{i.textCodec=mb,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[t];if(!i||"disabled"===i.mode)return;e.forEach(e=>IS(i,e))}else{const r=this.tracks[t];if(!r)return;const n=r.default?"default":"subtitles"+t;i.trigger(Vp.CUES_PARSED,{type:"subtitles",cues:e,track:n})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===jp&&this.onFragLoaded(Vp.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:r}=t;if(i.type!==Wp||"NONE"!==this.closedCaptionsForLevel(i))for(let e=0;e<r.length;e++){const t=r[e].bytes;if(t){this.cea608Parser1||this.initCea608Parsers();const i=this.extractCea608Data(t);this.cea608Parser1.addData(r[e].pts,i[0]),this.cea608Parser2.addData(r[e].pts,i[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:r,type:n}){const{media:s}=this;if(s&&!(s.currentTime<i)){if(!n||"video"===n){const{captionsTracks:e}=this;Object.keys(e).forEach(r=>kS(e[r],t,i))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==r){const{textTracks:e}=this;Object.keys(e).forEach(i=>kS(e[i],t,r))}}}extractCea608Data(e){const t=[[],[]],i=31&e[0];let r=2;for(let n=0;n<i;n++){const i=e[r++],n=127&e[r++],s=127&e[r++];if(0===n&&0===s)continue;if(!!(4&i)){const e=3&i;0!==e&&1!==e||(t[e].push(n),t[e].push(s))}}return t}},audioStreamController:class AudioStreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"audio-stream-controller",qp),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Vp.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Vp.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Vp.BUFFER_RESET,this.onBufferReset,this),e.on(Vp.BUFFER_CREATED,this.onBufferCreated,this),e.on(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Vp.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Vp.FRAG_LOADING,this.onFragLoading,this),e.on(Vp.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Vp.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Vp.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Vp.BUFFER_RESET,this.onBufferReset,this),e.off(Vp.BUFFER_CREATED,this.onBufferCreated,this),e.off(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Vp.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Vp.FRAG_LOADING,this.onFragLoading,this),e.off(Vp.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:r,timescale:n}){if(i===Wp){const e=t.cc,i=this.fragCurrent;if(this.initPTS[e]={baseTime:r,timescale:n},this.log(`InitPTS for cc: ${e} found from main: ${r}/${n}`),this.mainAnchor=t,this.state===Cy){const i=this.waitingData;(!i&&!this.loadingParts||i&&i.frag.cc!==e)&&this.syncWithAnchor(t,null==i?void 0:i.frag)}else!this.hls.hasEnoughToStart&&i&&i.cc!==e?(i.abortRequests(),this.syncWithAnchor(t,i)):this.state===Sy&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const r=(null==(i=this.mainFragLoading)?void 0:i.frag)||null;if(t&&(null==r?void 0:r.cc)===t.cc)return;const n=(r||e).cc,s=Og(this.getLevelDetails(),n,this.getLoadPosition());s&&(this.log(`Waiting fragment cc (${null==t?void 0:t.cc}) cancelled because video is at cc ${e.cc}`),this.startFragRequested=!1,this.nextLoadPosition=s.start,this.resetLoadingState(),this.state===Sy&&this.doTickIdle())}startLoad(e,t){if(!this.levels)return this.startPosition=e,void(this.state=_y);const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),i>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=Sy):this.state=Ey,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case Sy:this.doTickIdle();break;case Ey:{const{levels:e,trackId:t}=this,i=null==e?void 0:e[t],r=null==i?void 0:i.details;if(r&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(r))break;this.state=Cy}break}case xy:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=Sy}break}case Cy:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:r,complete:n}=e,s=this.mainAnchor;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.state=Ty;const e={frag:t,part:i,payload:r.flush().buffer,networkDetails:null};this._handleFragmentLoadProgress(e),n&&super._handleFragmentLoadComplete(e)}else s&&s.cc!==e.frag.cc&&this.syncWithAnchor(s,e.frag)}else this.state=Sy}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:r,trackId:n}=this,s=t.config;if(!this.buffering||!r&&!this.primaryPrefetch&&(this.startFragRequested||!s.startFragPrefetch)||null==i||!i[n])return;const a=i[n],o=a.details;if(!o||this.waitForLive(a)||this.waitForCdnTuneIn(o))return this.state=Ey,void(this.startFragRequested=!1);const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,vm,qp));const h=this.getFwdBufferInfo(l,qp);if(null===h)return;if(!this.switchingTrack&&this._streamEnded(h,o))return t.trigger(Vp.BUFFER_EOS,{type:"audio"}),void(this.state=Ay);const c=h.len,d=t.maxBufferLength,u=o.fragments,f=u[0].start,p=this.getLoadPosition(),m=this.flushing?p:h.end;if(this.switchingTrack&&r){const e=p;o.PTSKnown&&e<f&&(h.end>f||h.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),r.currentTime=f+.05)}if(c>=d&&!this.switchingTrack&&m<u[u.length-1].start)return;let g=this.getNextFragment(m,o);if(g&&this.isLoopLoading(g,m)&&(g=this.getNextFragmentLoopLoading(g,o,h,Wp,d)),!g)return void(this.bufferFlushed=!0);let v=(null==(e=this.mainFragLoading)?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&v&&Sm(g)&&!g.endList&&(!o.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===Zg&&(this.mainFragLoading=v=null),v&&Sm(v))){if(g.start>v.end){const e=this.fragmentTracker.getFragAtPos(m,Wp);e&&e.end>v.end&&(v=e,this.mainFragLoading={frag:e,targetBufferTime:null})}if(g.start>v.end)return}this.loadFragment(g,a,m)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(e=>new Level(e))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==_y&&(this.setInterval(100),this.state=Sy,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(Vp.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:r}=this,{details:n,id:s,groupId:a,track:o}=t;if(!r)return void this.warn(`Audio tracks reset while loading track ${s} "${o.name}" of "${a}"`);const l=this.mainDetails;if(!l||n.endCC>l.endCC||l.expired)return this.cachedTrackLoadedData=t,void(this.state!==_y&&(this.state=Ey));this.cachedTrackLoadedData=null,this.log(`Audio track ${s} "${o.name}" of "${a}" loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`);const h=r[s];let c=0;if(n.live||null!=(i=h.details)&&i.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;var d;if(h.details)c=this.alignPlaylists(n,h.details,null==(d=this.levelLastLoaded)?void 0:d.details);n.alignedSliding||(gy(n,l),n.alignedSliding||vy(n,l),c=n.fragmentStart)}h.details=n,this.levelLastLoaded=h,this.startFragRequested||this.setStartPosition(l,c),this.hls.trigger(Vp.AUDIO_TRACK_UPDATED,{details:n,id:s,groupId:t.groupId}),this.state!==Ey||this.waitForCdnTuneIn(n)||(this.state=Sy),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:r,payload:n}=e,{config:s,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const h=l.details;if(!h)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(i.start);const c=s.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new TransmuxerInterface(this.hls,qp,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[i.cc],f=null==(t=i.initSegment)?void 0:t.data;if(void 0!==u){const e=!1,t=r?r.index:-1,s=-1!==t,a=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount,n.byteLength,t,s);d.push(n,f,c,"",i,r,h.totalduration,e,a,u)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${h.startSN} ,${h.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new ChunkCache,complete:!1};e.push(new Uint8Array(n)),this.state!==_y&&(this.state=Cy)}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===Wp&&Sm(t.frag)&&(this.mainFragLoading=t,this.state===Sy&&this.tick())}onFragBuffered(e,t){const{frag:i,part:r}=t;if(i.type===qp)if(this.fragContextChanged(i))this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if(Sm(i)){this.fragPrevious=i;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(Vp.AUDIO_TRACK_SWITCHED,Qp({},e)))}this.fragBufferedComplete(i,r),this.media&&this.tick()}else this.audioOnly||i.type!==Wp||i.elementaryStreams.video||i.elementaryStreams.audiovideo||(this.audioOnly=!0,this.mainFragLoading=null)}onError(e,t){var i;if(t.fatal)this.state=Ly;else switch(t.details){case Bp.FRAG_GAP:case Bp.FRAG_PARSING_ERROR:case Bp.FRAG_DECRYPT_ERROR:case Bp.FRAG_LOAD_ERROR:case Bp.FRAG_LOAD_TIMEOUT:case Bp.KEY_LOAD_ERROR:case Bp.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(qp,t);break;case Bp.AUDIO_TRACK_LOAD_ERROR:case Bp.AUDIO_TRACK_LOAD_TIMEOUT:case Bp.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Ey||(null==(i=t.context)?void 0:i.type)!==Hp||(this.state=Sy);break;case Bp.BUFFER_ADD_CODEC_ERROR:case Bp.BUFFER_APPEND_ERROR:if("audio"!==t.parent)return;this.resetLoadingState();break;case Bp.BUFFER_FULL_ERROR:if("audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case Bp.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==ym&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==ym){this.flushing=!1,this.bufferFlushed=!0,this.state===Ay&&(this.state=Sy);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,qp),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:r}=this,{remuxResult:n,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:h}=a,{details:c}=h,{audio:d,text:u,id3:f,initSegment:p}=n;if(!this.fragContextChanged(o)&&c){if(this.state=My,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){const e=o.initSegment||o;this._bufferInitSegment(h,p.tracks,e,s),r.trigger(Vp.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:p.tracks})}if(d){const{startPTS:e,endPTS:t,startDTS:i,endDTS:r}=d;l&&(l.elementaryStreams[vm]={startPTS:e,endPTS:t,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(vm,e,t,i,r),this.bufferFragmentData(d,o,l,s)}if(null!=f&&null!=(t=f.samples)&&t.length){const e=Yp({id:i,frag:o,details:c},f);r.trigger(Vp.FRAG_PARSING_METADATA,e)}if(u){const e=Yp({id:i,frag:o,details:c},u);r.trigger(Vp.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,i,r){if(this.state!==My)return;if(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio)return;const n=t.audio;n.id=qp;const s=e.audioCodec;this.log(`Init audio buffer, container:${n.container}, codecs[level/parsed]=[${s}/${n.codec}]`),s&&1===s.split(",").length&&(n.levelCodec=s),this.hls.trigger(Vp.BUFFER_CODECS,t);const a=n.initSegment;if(null!=a&&a.byteLength){const e={type:"audio",frag:i,part:null,chunkMeta:r,parent:i.type,data:a};this.hls.trigger(Vp.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,i){const r=this.fragmentTracker.getState(e);var n;if(this.switchingTrack||r===Yg||r===Qg)if(Sm(e))if(null!=(n=t.details)&&n.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=Cy;const i=this.mainDetails;i&&i.fragmentStart!==t.details.fragmentStart&&vy(t.details,i)}else super.loadFragment(e,t,i);else this._loadInitSegment(e,t);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:r,characteristics:n,audioCodec:s,channels:a}=this.bufferedTrack;Ag({name:t,lang:i,assocLang:r,characteristics:n,audioCodec:s,channels:a},e,Lg)||(Rg(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(Vp.AUDIO_TRACK_SWITCHED,Qp({},e))}},audioTrackController:class AudioTrackController extends BasePlaylistController{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.on(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Vp.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.off(Vp.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Vp.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Vp.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:r,details:n}=t,s=this.tracksInGroup[i];if(!s||s.groupId!==r)return void this.warn(`Audio track with id:${i} and group:${r} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Audio track ${i} "${s.name}" lang:${s.lang} group:${r} loaded [${n.startSN}-${n.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,r=this.groupIds;let n=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some(e=>-1===(null==r?void 0:r.indexOf(e)))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!i||-1!==i.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!n&&t){const i=wg(t,e,Lg);if(i>-1)n=e[i];else{const e=wg(t,this.tracks);n=this.tracks[e]}}let r=this.findTrackId(n);-1===r&&n&&(r=this.findTrackId(null));const a={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==i?void 0:i.join(",")}`),this.hls.trigger(Vp.AUDIO_TRACKS_UPDATED,a);const o=this.trackId;if(-1!==r&&-1===o)this.setAudioTrack(r);else if(e.length&&-1===o){var s;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(s=this.groupIds)?void 0:s.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}}onError(e,t){!t.fatal&&t.context&&(t.context.type!==Hp||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const r=this.currentTrack;if(r&&Ag(e,r,Lg))return r;const n=wg(e,this.tracksInGroup,Lg);if(n>-1){const e=this.tracksInGroup[n];return this.setAudioTrack(n),e}if(r){let r=t.loadLevel;-1===r&&(r=t.firstAutoLevel);const n=function(e,t,i,r,n){const s=t[r],a=t.reduce((e,t,i)=>{const r=t.uri;return(e[r]||(e[r]=[])).push(i),e},{})[s.uri];a.length>1&&(r=Math.max.apply(Math,a));const o=s.videoRange,l=s.frameRate,h=s.codecSet.substring(0,4),c=Cg(t,r,t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==h)return!1;const r=t.audioGroups,s=i.filter(e=>!r||-1!==r.indexOf(e.groupId));return wg(e,s,n)>-1});return c>-1?c:Cg(t,r,t=>{const r=t.audioGroups,s=i.filter(e=>!r||-1!==r.indexOf(e.groupId));return wg(e,s,n)>-1})}(e,t.levels,i,r,Lg);if(-1===n)return null;t.nextLoadLevel=n}if(e.channels||e.audioCodec){const t=wg(e,i);if(t>-1)return i[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.selectDefaultTrack=!1;const i=this.currentTrack,r=t[e],n=r.details&&!r.details.live;if(e===this.trackId&&r===i&&n)return;if(this.log(`Switching to audio-track ${e} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=e,this.currentTrack=r,this.hls.trigger(Vp.AUDIO_TRACK_SWITCHING,Qp({},r)),n)return;const s=this.switchParams(r.url,null==i?void 0:i.details,r.details);this.loadPlaylist(s)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const r=t[i];if((!this.selectDefaultTrack||r.default)&&(!e||Ag(e,r,Lg)))return i}if(e){const{name:i,lang:r,assocLang:n,characteristics:s,audioCodec:a,channels:o}=e;for(let e=0;e<t.length;e++){if(Ag({name:i,lang:r,assocLang:n,characteristics:s,audioCodec:a,channels:o},t[e],Lg))return e}for(let i=0;i<t.length;i++){const r=t[i];if(q_(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const r=t[i];if(q_(e.attrs,r.attrs,["LANGUAGE"]))return i}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&Rg(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,r=e.groupId,n=this.getUrlWithDirectives(e.url,t),s=e.details,a=null==s?void 0:s.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&s.live?" age "+a.toFixed(1)+(s.type?" "+s.type||0:""):""} ${n}`),this.hls.trigger(Vp.AUDIO_TRACK_LOADING,{url:n,id:i,groupId:r,deliveryDirectives:t||null,track:e})}},emeController:EMEController,cmcdController:class CMCDController{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:Z_.MANIFEST,su:!this.initialized})}catch(e){this.hls.logger.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const{frag:t,part:i}=e,r=this.hls.levels[t.level],n=this.getObjectType(t),s={d:1e3*(i||t).duration,ot:n};n!==Z_.VIDEO&&n!==Z_.AUDIO&&n!=Z_.MUXED||(s.br=r.bitrate/1e3,s.tb=this.getTopBandwidth(n)/1e3,s.bl=this.getBufferLength(n));const a=i?this.getNextPart(i):this.getNextFrag(t);null!=a&&a.url&&a.url!==t.url&&(s.nor=a.url),this.apply(e,s)}catch(e){this.hls.logger.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;null!=i&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHED,this.onMediaDetached,this),e.on(Vp.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHED,this.onMediaDetached,this),e.off(Vp.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,r;this.audioBuffer=null==(i=t.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(r=t.tracks.video)?void 0:r.buffer}createData(){var e;return{v:1,sf:J_.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Yp(t,this.createData());const i=t.ot===Z_.INIT||t.ot===Z_.VIDEO||t.ot===Z_.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:r}=this;r&&(t=Object.keys(t).reduce((e,i)=>(r.includes(i)&&(e[i]=t[i]),e),{}));const n={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),ES(e.headers,t,n)):e.url=wS(e.url,t,n)}getNextFrag(e){var t;const i=null==(t=this.hls.levels[e.level])?void 0:t.details;if(i){const t=e.sn-i.startSN;return i.fragments[t+1]}}getNextPart(e){var t,i;const{index:r,fragment:n}=e,s=null==(t=this.hls.levels[n.level])||null==(i=t.details)?void 0:i.partList;if(s){const{sn:e}=n;for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.index===r&&i.fragment.sn===e)return s[t+1]}}}getObjectType(e){const{type:t}=e;return"subtitle"===t?Z_.TIMED_TEXT:"initSegment"===e.sn?Z_.INIT:"audio"===t?Z_.AUDIO:"main"===t?this.hls.audioTracks.length?Z_.VIDEO:Z_.MUXED:void 0}getTopBandwidth(e){let t,i=0;const r=this.hls;if(e===Z_.AUDIO)t=r.audioTracks;else{const e=r.maxAutoLevel,i=e>-1?e+1:r.levels.length;t=r.levels.slice(0,i)}return t.forEach(e=>{e.bitrate>i&&(i=e.bitrate)}),i>0?i:NaN}getBufferLength(e){const t=this.media,i=e===Z_.AUDIO?this.audioBuffer:this.videoBuffer;if(!i||!t)return NaN;return 1e3*BufferHelper.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class CmcdPlaylistLoader{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,r){t(e),this.loader.load(e,i,r)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class CmcdFragmentLoader{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,r){t(e),this.loader.load(e,i,r)}}}},contentSteeringController:class ContentSteeringController extends Logger{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(t=>t!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((null==i?void 0:i.action)===zg&&i.flags===qg){const e=this.levels;let r=this._pathwayPriority,n=this.pathwayId;if(t.context){const{groupId:i,pathwayId:r,type:s}=t.context;i&&e?n=this.getPathwayForGroupId(i,s,n):r&&(n=r)}n in this.penalizedPathways||(this.penalizedPathways[n]=performance.now()),!r&&e&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==n),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${n} levels: ${e?e.length:e} priorities: ${Tg(r)} penalized: ${Tg(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){let t;this._pathwayPriority=e;const i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach(e=>{r-i[e]>3e5&&delete i[e]});for(let r=0;r<e.length;r++){const n=e[r];if(n in i)continue;if(n===this.pathwayId)return;const s=this.hls.nextLoadLevel,a=this.hls.levels[s];if(t=this.getLevelsForPathway(n),t.length>0){this.log(`Setting Pathway to "${n}"`),this.pathwayId=n,uy(t),this.hls.trigger(Vp.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[s];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=s);break}}}getPathwayForGroupId(e,t,i){const r=this.getLevelsForPathway(i).concat(this.levels||[]);for(let i=0;i<r.length;i++)if(t===Hp&&r[i].hasAudioGroup(e)||t===$p&&r[i].hasSubtitleGroup(e))return r[i].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},r={};e.forEach(e=>{const{ID:n,"BASE-ID":s,"URI-REPLACEMENT":a}=e;if(t.some(e=>e.pathwayId===n))return;const o=this.getLevelsForPathway(s).map(e=>{const t=new AttrList(e.attrs);t["PATHWAY-ID"]=n;const s=t.AUDIO&&`${t.AUDIO}_clone_${n}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${n}`;s&&(i[t.AUDIO]=s,t.AUDIO=s),o&&(r[t.SUBTITLES]=o,t.SUBTITLES=o);const l=LS(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),h=new Level({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)h.addGroupId("audio",`${e.audioGroups[t]}_clone_${n}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)h.addGroupId("text",`${e.subtitleGroups[t]}_clone_${n}`);return h});t.push(...o),AS(this.audioTracks,i,a,n),AS(this.subtitleTracks,r,a,n)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;let r;this.loader&&this.loader.destroy(),this.loader=new i(t);try{r=new self.URL(e)}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==r.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+e)}const n={responseType:"json",url:r.href},s=t.steeringManifestLoadPolicy.default,a=s.errorRetry||s.timeoutRetry||{},o={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,i,n)=>{this.log(`Loaded steering manifest: "${r}"`);const s=e.data;if(1!==(null==s?void 0:s.VERSION))return void this.log(`Steering VERSION ${s.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=s.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=s;if(a)try{this.uri=new self.URL(a,r).href}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||i.url),o&&this.clonePathways(o);const h={steeringManifest:s,url:r.toString()};this.hls.trigger(Vp.STEERING_MANIFEST_LOADED,h),l&&this.updatePathwayPriority(l)},onError:(e,t,i,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let n=1e3*this.timeToLoad;if(429===e.code){const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(n=1e3*parseFloat(t))}return void this.log(`Steering manifest ${t.url} rate limited`)}this.scheduleRefresh(this.uri||t.url,n)},onTimeout:(e,t,i)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(n,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var t;const i=null==(t=this.hls)?void 0:t.media;!i||i.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)},t)}},interstitialsController:class InterstitialsController extends Logger{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;const t=e-this.timelinePos;if(Math.abs(t)<1/7056e5)return;const i=t<=-.01;this.timelinePos=e,this.bufferedPos=e;const r=this.playingItem;if(!r)return void this.checkBuffer();if(i){this.schedule.resetErrorsInRange(e,e-t)&&this.updateSchedule()}if(this.checkBuffer(),i&&e<r.start||e>=r.end){var n;const e=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(r)&&null!=(n=this.media)&&n.paused&&(this.shouldPlay=!1),!i){const t=this.findItemIndex(r);if(e>t){const i=this.schedule.findJumpRestrictedIndex(t+1,e);if(i>t)return void this.setSchedulePosition(i)}}return void this.setSchedulePosition(e)}const s=this.playingAsset;if(!s){if(this.playingLastItem&&this.isInterstitial(r)){const t=r.event.assetList[0];t&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(e,t))}return}const a=s.timelineStart,o=s.duration||0;(i&&e<a||e>=a+o)&&this.setScheduleToAssetAtTime(e,s)},this.onTimeupdate=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;if(!(e>this.timelinePos))return;this.timelinePos=e,e>this.bufferedPos&&this.checkBuffer();const t=this.playingItem;if(!t||this.playingLastItem)return;if(e>=t.end){this.timelinePos=t.end;const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}const i=this.playingAsset;if(!i)return;e>=i.timelineStart+(i.duration||0)&&this.setScheduleToAssetAtTime(e,i)},this.onScheduleUpdate=(e,t)=>{const i=this.schedule,r=this.playingItem,n=i.events||[],s=i.items||[],a=i.durations,o=e.map(e=>e.identifier),l=!(!n.length&&!o.length);(l||t)&&this.log(`INTERSTITIALS_UPDATED (${n.length}): ${n}\nSchedule: ${s.map(e=>$S(e))} pos: ${this.timelinePos}`),o.length&&this.log(`Removed events ${o}`),this.playerQueue.forEach(e=>{if(e.interstitial.appendInPlace){const t=e.assetItem.timelineStart,i=e.timelineOffset-t;if(i)try{e.timelineOffset=t}catch(r){Math.abs(i)>NS&&this.warn(`${r} ("${e.assetId}" ${e.timelineOffset}->${t})`)}}});let h=null;if(r){const e=this.updateItem(r,this.timelinePos);this.itemsMatch(r,e)&&(this.playingItem=e,this.waitingItem=this.endedItem=null,h=()=>this.trimInPlace(e,r))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const c=this.bufferingItem;if(c){const e=this.updateItem(c,this.bufferedPos);this.itemsMatch(c,e)?(this.bufferingItem=e,h||(h=()=>this.trimInPlace(e,c))):c.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(c.event,null))}if(e.forEach(e=>{e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,null)})}),l||t){if(this.hls.trigger(Vp.INTERSTITIALS_UPDATED,{events:n.slice(0),schedule:s.slice(0),durations:a,removedIds:o}),this.isInterstitial(r)&&o.includes(r.event.identifier))return this.warn(`Interstitial "${r.event.identifier}" removed while playing`),void this.primaryFallback(r.event);h&&h(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new AssetListLoader(e),this.schedule=new InterstitialsSchedule(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Vp.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(Vp.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(Vp.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(Vp.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(Vp.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(Vp.BUFFER_APPENDED,this.onBufferAppended,this),e.on(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Vp.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(Vp.MEDIA_ENDED,this.onMediaEnded,this),e.on(Vp.ERROR,this.onError,this),e.on(Vp.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Vp.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(Vp.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(Vp.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(Vp.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(Vp.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(Vp.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Vp.BUFFER_APPENDED,this.onBufferAppended,this),e.off(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Vp.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(Vp.MEDIA_ENDED,this.onMediaEnded,this),e.off(Vp.ERROR,this.onError,this),e.off(Vp.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;null==(e=this.getBufferingPlayer())||e.resumeBuffering()}pauseBuffering(){var e;null==(e=this.getBufferingPlayer())||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){RS(e,"play",this.onPlay),RS(e,"pause",this.onPause),RS(e,"seeking",this.onSeeking),RS(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;CS(i,"seeking",this.onSeeking),CS(i,"timeupdate",this.onTimeupdate),CS(i,"play",this.onPlay),CS(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,r=this.detachedData;if(this.detachedData=null,null===i)this.checkStart();else if(!r){this.clearScheduleState();const e=this.findItemIndex(i);this.setSchedulePosition(e)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,r=this.media;if(this.media=null,!i&&(r&&this.removeMediaListeners(r),this.detachedData)){const e=this.getBufferingPlayer();e&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,e.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=t=>t?e.getAssetPlayer(t.identifier):t,r=(t,r,n,a,o)=>{if(t){let l=t[r].start;const h=t.event;if(h){if("playout"===r||h.timelineOccupancy!==FS.Point){const e=i(n);(null==e?void 0:e.interstitial)===h&&(l+=e.assetItem.startOffset+e[o])}}else{l+=("bufferedPos"===a?s():e[a])-t.start}return l}return 0},n=(t,i)=>{if(0!==t&&"primary"!==i&&e.schedule.length){var r;const n=e.schedule.findItemIndexAtTime(t),s=null==(r=e.schedule.items)?void 0:r[n];if(s){return t+(s[i].start-s.start)}}return t},s=()=>{const t=e.bufferedPos;return t===Number.MAX_VALUE?a("primary"):Math.max(t,0)},a=t=>{var i;return null!=(i=e.primaryDetails)&&i.live?e.primaryDetails.edge:e.schedule.durations[t]},o=(t,n)=>{var s,a;const o=e.effectivePlayingItem;if(null!=o&&null!=(s=o.event)&&s.restrictions.skip)return;e.log(`seek to ${t} "${n}"`);const l=e.effectivePlayingItem,h=e.schedule.findItemIndexAtTime(t,n),c=null==(a=e.schedule.items)?void 0:a[h],d=e.getBufferingPlayer(),u=null==d?void 0:d.interstitial,f=null==u?void 0:u.appendInPlace,p=l&&e.itemsMatch(l,c);if(l&&(f||p)){const s=i(e.playingAsset),a=(null==s?void 0:s.media)||e.primaryMedia;if(a){const i="primary"===n?a.currentTime:r(l,n,e.playingAsset,"timelinePos","currentTime"),o=t-i,h=(f?i:a.currentTime)+o;if(h>=0&&(!s||f||h<=s.duration))return void(a.currentTime=h)}}if(c){let i=t;if("primary"!==n){const e=t-c[n].start;i=c.start+e}const r=!e.isInterstitial(c);if(e.isInterstitial(l)&&!l.event.appendInPlace||!r&&!c.event.appendInPlace){if(l){const s=e.findItemIndex(l);if(h>s){const t=e.schedule.findJumpRestrictedIndex(s+1,h);if(t>s)return void e.setSchedulePosition(t)}let a=0;if(r)e.timelinePos=i,e.checkBuffer();else{var m;const e=null==c||null==(m=c.event)?void 0:m.assetList;if(e){const i=t-(c[n]||c).start;for(let t=e.length;t--;){const r=e[t];if(r.duration&&i>=r.startOffset&&i<r.startOffset+r.duration){a=t;break}}}}e.setSchedulePosition(h,a)}}else{const t=e.media||(f?null==d?void 0:d.media:null);t&&(t.currentTime=i)}}},l=()=>{const i=e.effectivePlayingItem;if(e.isInterstitial(i))return i;const r=t();return e.isInterstitial(r)?r:null},h={get currentTime(){const t=l(),i=e.effectivePlayingItem;return i&&i===t?r(i,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-i.playout.start:0},set currentTime(t){const i=l(),r=e.effectivePlayingItem;r&&r===i&&o(t+r.playout.start,"playout")},get duration(){const e=l();return e?e.playout.end-e.playout.start:0},get assetPlayers(){var t;const i=null==(t=l())?void 0:t.event.assetList;return i?i.map(t=>e.getAssetPlayer(t.identifier)):[]},get playingIndex(){var t;const i=null==(t=l())?void 0:t.event;return i&&e.effectivePlayingAsset?i.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};this.manager={get events(){var t,i;return(null==(t=e.schedule)||null==(i=t.events)?void 0:i.slice(0))||[]},get schedule(){var t,i;return(null==(t=e.schedule)||null==(i=t.items)?void 0:i.slice(0))||[]},get interstitialPlayer(){return l()?h:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const i=t();return e.findItemIndex(i)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const t=e.effectivePlayingItem;return e.findItemIndex(t)},primary:{get bufferedEnd(){return s()},get currentTime(){const t=e.timelinePos;return t>0?t:0},set currentTime(e){o(e,"primary")},get duration(){return a("primary")},get seekableStart(){var t;return(null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0}},integrated:{get bufferedEnd(){return r(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return r(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(e){o(e,"integrated")},get duration(){return a("integrated")},get seekableStart(){var t;return n((null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0,"integrated")}},skip:()=>{const t=e.effectivePlayingItem,i=null==t?void 0:t.event;if(i&&!i.restrictions.skip){const r=e.findItemIndex(t);if(i.appendInPlace){const e=t.playout.start+t.event.duration;o(e+.001,"playout")}else e.advanceAfterAssetEnded(i,r,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=null==(e=this.schedule)?void 0:e.items;return!!(this.playbackStarted&&t&&i)&&this.findItemIndex(t)===i.length-1}get playbackStarted(){return null!==this.effectivePlayingItem}get currentTime(){var e,t,i;if(null===this.mediaSelection)return;const r=this.waitingItem||this.playingItem;if(this.isInterstitial(r)&&!r.event.appendInPlace)return;let n=this.media;!n&&null!=(e=this.bufferingItem)&&null!=(t=e.event)&&t.appendInPlace&&(n=this.primaryMedia);const s=null==(i=n)?void 0:i.currentTime;return void 0!==s&&Op(s)?s:void 0}get primaryMedia(){var e;return this.media||(null==(e=this.detachedData)?void 0:e.media)||null}isInterstitial(e){return!(null==e||!e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,r=e.media;if(i&&r===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&r)return void(this.detachedData={media:r});const i=e.transferMedia();this.log(`transfer MediaSource from ${e} ${Tg(i)}`),this.detachedData=i}else t&&r&&(this.shouldPlay||(this.shouldPlay=!r.paused))}transferMediaTo(e,t){var i,r;if(e.media===t)return;let n=null;const s=this.hls,a=e!==s,o=a&&e.interstitial.appendInPlace,l=null==(i=this.detachedData)?void 0:i.mediaSource;let h;if(s.media)o&&(n=s.transferMedia(),this.detachedData=n),h="Primary";else if(l){const e=this.getBufferingPlayer();e?(n=e.transferMedia(),h=`${e}`):h="detached MediaSource"}else h="detached media";if(!n)if(l)n=this.detachedData,this.log(`using detachedData: MediaSource ${Tg(n)}`);else if(!this.detachedData||s.media===t){const e=this.playerQueue;e.length>1&&e.forEach(e=>{if(a&&e.interstitial.appendInPlace!==o){const t=e.interstitial;this.clearInterstitial(e.interstitial,null),t.appendInPlace=!1,t.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${t}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}const c=n&&"mediaSource"in n&&"closed"!==(null==(r=n.mediaSource)?void 0:r.readyState),d=c&&n?n:t;if(this.log(`${c?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${h}`),d===n){const t=a&&e.assetId===this.schedule.assetIdAtEnd;d.overrides={duration:this.schedule.duration,endOfStream:!a||t,cueRemoval:!a}}e.attachMedia(d)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;-1===this.bufferedPos&&(this.bufferedPos=0);const i=this.timelinePos,r=this.effectivePlayingItem;if(-1===i){const i=this.hls.startPosition;if(this.timelinePos=i,t.length&&t[0].cue.pre){const i=e.findEventIndex(t[0].identifier);this.setSchedulePosition(i)}else if(i>=0||!this.primaryLive){const t=this.timelinePos=i>0?i:0,r=e.findItemIndexAtTime(t);this.setSchedulePosition(r)}}else if(r&&!this.playingItem){const t=e.findItemIndex(r);this.setSchedulePosition(t)}}advanceAfterAssetEnded(e,t,i){const r=zS(e,i);if(e.isAssetPastPlayoutLimit(r)){const i=this.schedule.items;if(i){const r=t+1;if(r>=i.length)return void this.setSchedulePosition(-1);const n=e.resumeTime;this.timelinePos<n&&(this.timelinePos=n,this.checkBuffer()),this.setSchedulePosition(r)}}else this.setSchedulePosition(t,r)}setScheduleToAssetAtTime(e,t){const i=this.schedule,r=t.parentIdentifier,n=i.getEvent(r);if(n){const t=i.findEventIndex(r),s=i.findAssetIndex(n,e);this.advanceAfterAssetEnded(n,t,s-1)}}setSchedulePosition(e,t){const i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const r=e>=0?i[e]:null,n=this.playingItem,s=this.playingLastItem;if(this.isInterstitial(n)){var a;const l=n.event,h=this.playingAsset,c=null==h?void 0:h.identifier,d=c?this.getAssetPlayer(c):null;if(d&&c&&(!this.eventItemsMatch(n,r)||void 0!==t&&c!==(null==(a=l.assetList)?void 0:a[t].identifier))){var o;const t=l.findAssetIndex(h);this.log(`INTERSTITIAL_ASSET_ENDED ${t+1}/${l.assetList.length} ${HS(h)}`),this.endedAsset=h,this.playingAsset=null,this.hls.trigger(Vp.INTERSTITIAL_ASSET_ENDED,{asset:h,assetListIndex:t,event:l,schedule:i.slice(0),scheduleIndex:e,player:d}),this.retreiveMediaSource(c,r),!d.media||null!=(o=this.detachedData)&&o.mediaSource||d.detachMedia()}if(!this.eventItemsMatch(n,r)&&(this.endedItem=n,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${l} ${$S(n)}`),l.hasPlayed=!0,this.hls.trigger(Vp.INTERSTITIAL_ENDED,{event:l,schedule:i.slice(0),scheduleIndex:e}),l.cue.once)){this.updateSchedule();const e=this.schedule.items;if(r&&e){const i=this.schedule.findItemIndex(r);this.advanceSchedule(i,e,t,n,s)}return}}this.advanceSchedule(e,i,t,n,s)}advanceSchedule(e,t,i,r,n){const s=e>=0?t[e]:null,a=this.primaryMedia,o=this.playerQueue;if(o.length&&o.forEach(t=>{const i=t.interstitial,r=this.schedule.findEventIndex(i.identifier);(r<e||r>e+1)&&this.clearInterstitial(i,s)}),this.isInterstitial(s)){this.timelinePos=Math.min(Math.max(this.timelinePos,s.start),s.end);const n=s.event;if(void 0===i){const t=zS(n,(i=this.schedule.findAssetIndex(n,this.timelinePos))-1);if(n.isAssetPastPlayoutLimit(t))return void this.advanceAfterAssetEnded(n,e,i);i=t}const o=this.waitingItem;this.assetsBuffered(s,a)||this.setBufferingItem(s);let l=this.preloadAssets(n,i);if(this.eventItemsMatch(s,o||r)||(this.waitingItem=s,this.log(`INTERSTITIAL_STARTED ${$S(s)} ${n.appendInPlace?"append in place":""}`),this.hls.trigger(Vp.INTERSTITIAL_STARTED,{event:n,schedule:t.slice(0),scheduleIndex:e})),!n.assetListLoaded)return void this.log(`Waiting for ASSET-LIST to complete loading ${n}`);if(n.assetListLoader&&(n.assetListLoader.destroy(),n.assetListLoader=void 0),!a)return void this.log(`Waiting for attachMedia to start Interstitial ${n}`);this.waitingItem=this.endedItem=null,this.playingItem=s;const h=n.assetList[i];if(!h){const r=t[e+1],s=this.media;return r&&s&&!this.isInterstitial(r)&&s.currentTime<r.start&&(s.currentTime=this.timelinePos=r.start),void this.advanceAfterAssetEnded(n,e,i||0)}if(l||(l=this.getAssetPlayer(h.identifier)),null===l||l.destroyed){const e=n.assetList.length;this.warn(`asset ${i+1}/${e} player destroyed ${n}`),l=this.createAssetPlayer(n,h,i)}if(!this.eventItemsMatch(s,this.bufferingItem)&&n.appendInPlace&&this.isAssetBuffered(h))return;this.startAssetPlayer(l,i,t,e,a),this.shouldPlay&&WS(l.media)}else null!==s?(this.resumePrimary(s,e,r),this.shouldPlay&&WS(this.hls.media)):n&&this.isInterstitial(r)&&(this.endedItem=null,this.playingItem=r,r.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return!1===this.hls.config.enableInterstitialPlayback}get primaryDetails(){var e,t;return null==(e=this.mediaSelection)||null==(t=e.main)?void 0:t.details}get primaryLive(){var e;return!(null==(e=this.primaryDetails)||!e.live)}resumePrimary(e,t,i){var r;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${$S(e)}`),null==(r=this.detachedData)||!r.mediaSource){let i=this.timelinePos;(i<e.start||i>=e.end)&&(i=this.getPrimaryResumption(e,t),this.timelinePos=i),this.attachPrimary(i,e)}if(!i)return;const n=this.schedule.items;n&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${$S(e)}`),this.hls.trigger(Vp.INTERSTITIALS_PRIMARY_RESUMED,{schedule:n.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const e=this.primaryDetails;if(0===t)return this.hls.startPosition;if(e&&(i<e.fragmentStart||i>e.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);if(null!=t&&t.hls)return t.hls.bufferedToEnd;return BufferHelper.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const r=this.primaryMedia;if(!r)return;const n=this.hls;n.media?this.checkBuffer():(this.transferMediaTo(n,r),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const r=this.hls;!r.loadingEnabled||!r.media||Math.abs(((null==(i=r.mainForwardBufferInfo)?void 0:i.start)||r.media.currentTime)-e)>.5?r.startLoad(e,t):r.bufferingEnabled||r.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(Vp.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(Vp.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(-1===t.level)return;const i=this.hls.levels[t.level],r=Qp(Qp({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=r,this.schedule.parseInterstitialDateRanges(r,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],r=this.mediaSelection;if(!r)return void(this.altSelection=Qp(Qp({},this.altSelection),{},{audio:i}));const n=Qp(Qp({},r),{},{audio:i});this.mediaSelection=n}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],r=this.mediaSelection;if(!r)return void(this.altSelection=Qp(Qp({},this.altSelection),{},{subtitles:i}));const n=Qp(Qp({},r),{},{subtitles:i});this.mediaSelection=n}onAudioTrackSwitching(e,t){const i=Mg(t);this.playerQueue.forEach(e=>e.hls.setAudioOption(t)||e.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){const i=Mg(t);this.playerQueue.forEach(e=>e.hls.setSubtitleOption(t)||-1!==t.id&&e.hls.setSubtitleOption(i))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const e=this.timelinePos;this.bufferedPos=e,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let e=0;e<t.length;e++){const r=t[e];if(r.cue.post){var i;const e=this.schedule.findEventIndex(r.identifier),t=null==(i=this.schedule.items)?void 0:i[e];this.isInterstitial(t)&&this.eventItemsMatch(t,this.bufferingItem)&&this.bufferedToItem(t,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}else this.shouldPlay=!1}updateItem(e,t){const i=this.schedule.items;if(e&&i){return i[this.findItemIndex(e,t)]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((t,i)=>{e.event.isAssetPastPlayoutLimit(i)&&this.clearAssetPlayer(t.identifier,null)});const t=e.end+.25,i=BufferHelper.bufferInfo(this.primaryMedia,t,0);(i.end>t||(i.nextStart||0)>t)&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===(null==(i=t.event)?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const i=BufferHelper.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){const r=this.schedule,n=this.bufferingItem;if(this.bufferedPos>e)return;if(1===t.length&&this.itemsMatch(t[0],n))return void(this.bufferedPos=e);const s=this.playingItem,a=this.findItemIndex(s);let o=r.findItemIndexAtTime(e);if(this.bufferedPos<e){var l,h;const i=this.findItemIndex(n),r=Math.min(i+1,t.length-1),s=t[r];if((-1===o&&n&&e>=n.end||null!=(l=s.event)&&l.appendInPlace&&e+.01>=s.start)&&(o=r),r-a>1&&!1===(null==n||null==(h=n.event)?void 0:h.appendInPlace))return;if(this.bufferedPos=e,o>i&&o>a)this.bufferedToItem(s);else{const t=this.primaryDetails;this.primaryLive&&t&&e>t.edge-t.targetduration&&s.start<t.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(s)&&this.preloadAssets(s.event,0)}}else i&&s&&!this.itemsMatch(s,n)&&(o===a?this.bufferedToItem(s):o===a+1&&this.bufferedToItem(t[o]))}assetsBuffered(e,t){return 0!==e.event.assetList.length&&!e.event.assetList.some(e=>{const i=this.getAssetPlayer(e.identifier);return!(null!=i&&i.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:r,events:n}=i;if(!r||!n)return t;const s=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const o=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${$S(e)}`+(t?` (${o.toFixed(2)} remaining)`:"")),this.playbackDisabled||(s?e.event.assetList.forEach(e=>{const t=this.getAssetPlayer(e.identifier);t&&t.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(e=>e.pauseBuffering()))),this.hls.trigger(Vp.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:n.slice(0),schedule:r.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled)if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(null!==i){this.bufferingAsset=null;const t=this.detachedData;if(t)if(t.mediaSource){const t=!0;this.attachPrimary(e.start,e,t)}else this.preloadPrimary(e);else this.preloadPrimary(e)}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,r=0===i.assetList.length&&!i.assetListLoader,n=i.cue.once;if(r||!n){const e=this.preloadAssets(i,t);if(null!=e&&e.interstitial.appendInPlace){const r=i.assetList[t],n=this.primaryMedia;r&&n&&this.bufferAssetPlayer(e,n)}}}preloadAssets(e,t){const i=e.assetUrl,r=e.assetList.length,n=0===r&&!e.assetListLoader,s=e.cue.once;if(n){const n=e.timelineStart;if(e.appendInPlace){var a;const t=this.playingItem;this.isInterstitial(t)||(null==t||null==(a=t.nextEvent)?void 0:a.identifier)!==e.identifier||this.flushFrontBuffer(n+.25)}let s,o=0;if(!this.playingItem&&this.primaryLive&&(o=this.hls.startPosition,-1===o&&(o=this.hls.liveSyncPosition||0)),o&&!e.cue.pre&&!e.cue.post){const e=o-n;e>0&&(s=Math.round(1e3*e)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:r} ${e}${s?` live-start: ${o} start-offset: ${s}`:""}`),i)return this.createAsset(e,0,0,n,e.duration,i);const l=this.assetListLoader.loadAssetList(e,s);l&&(e.assetListLoader=l)}else if(!s&&r){for(let i=t;i<r;i++){const t=e.assetList[i],r=this.getAssetPlayerQueueIndex(t.identifier);-1!==r&&!this.playerQueue[r].destroyed||t.error||this.createAssetPlayer(e,t,i)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`);Object.keys(t).forEach(t=>{this.hls.trigger(Vp.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:t})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t)for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i];return null}createAsset(e,t,i,r,n,s){const a={parentIdentifier:e.identifier,identifier:BS(e,s,t),duration:n,startOffset:i,timelineStart:r,uri:s};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const r=this.hls,n=r.userConfig;let s=n.videoPreference;const a=r.loadLevelObj||r.levels[r.currentLevel];(s||a)&&(s=Yp({},s),a.videoCodec&&(s.videoCodec=a.videoCodec),a.videoRange&&(s.allowedVideoRanges=[a.videoRange]));const o=r.audioTracks[r.audioTrack],l=r.subtitleTracks[r.subtitleTrack];let h=0;if(this.primaryLive||e.appendInPlace){const e=this.timelinePos-t.timelineStart;if(e>1){const i=t.duration;i&&e<i&&(h=e)}}const c=t.identifier,d=Qp(Qp({},n),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:r.sessionId,assetPlayerId:c,abrEwmaDefaultEstimate:r.bandwidthEstimate,interstitialsController:void 0,startPosition:h,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:s,audioPreference:o||n.audioPreference,subtitlePreference:l||n.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(d.timelineOffset=t.timelineStart));const u=d.cmcd;null!=u&&u.sessionId&&u.contentId&&(d.cmcd=Yp({},u,{contentId:US(t.uri)})),this.getAssetPlayer(c)&&this.warn(`Duplicate date range identifier ${e} and asset ${c}`);const f=new HlsAssetPlayer(this.HlsPlayerClass,d,e,t);this.playerQueue.push(f),e.assetList[i]=t;const p=r=>{if(r.live){const t=new Error(`Interstitials MUST be VOD assets ${e}`),r={fatal:!0,type:Fp.OTHER_ERROR,details:Bp.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};return void this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),i,t.message)}const n=r.edge-r.fragmentStart,s=t.duration;(null===s||n>s)&&(this.log(`Interstitial asset "${c}" duration change ${s} > ${n}`),t.duration=n,this.updateSchedule())};f.on(Vp.LEVEL_UPDATED,(e,{details:t})=>p(t)),f.on(Vp.LEVEL_PTS_UPDATED,(e,{details:t})=>p(t));const m=(e,t)=>{const i=this.getAssetPlayer(c);if(i&&t.tracks){i.off(Vp.BUFFER_CODECS,m),i.tracks=t.tracks;const e=this.primaryMedia;this.bufferingAsset===i.assetItem&&e&&!i.media&&this.bufferAssetPlayer(i,e)}};f.on(Vp.BUFFER_CODECS,m);const g=()=>{var i;const r=this.getAssetPlayer(c);if(this.log(`buffered to end of asset ${r}`),!r)return;const n=this.schedule.findEventIndex(e.identifier),s=null==(i=this.schedule.items)?void 0:i[n];if(this.isInterstitial(s)){const i=e.findAssetIndex(t),r=zS(e,i);if(e.isAssetPastPlayoutLimit(r)){var a;const e=null==(a=this.schedule.items)?void 0:a[n+1];e&&this.bufferedToItem(e)}else this.bufferedToItem(s,r)}};f.on(Vp.BUFFERED_TO_END,g);const v=t=>()=>{if(!this.getAssetPlayer(c))return;this.shouldPlay=!0;const i=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,i,t)};return f.once(Vp.MEDIA_ENDED,v(i)),f.once(Vp.PLAYOUT_LIMIT_REACHED,v(1/0)),f.on(Vp.ERROR,(t,r)=>{const n=this.getAssetPlayer(c);if(r.details!==Bp.BUFFER_STALLED_ERROR)this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${r.error} ${e}`);else if(null!=n&&n.media){const t=n.currentTime,i=n.duration-t;t&&e.appendInPlace&&i/n.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${c} ${e} at ${n.media.currentTime}`),g()):(this.warn(`Stalled at ${t} of ${t+i} in asset ${c} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}}),f.on(Vp.DESTROYING,()=>{if(!this.getAssetPlayer(c))return;const t=new Error(`Asset player destroyed unexpectedly ${c}`),r={fatal:!0,type:Fp.OTHER_ERROR,details:Bp.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),i,t.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${HS(t)}`),this.hls.trigger(Vp.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:f}),f}clearInterstitial(e,t){e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(-1!==t){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(-1!==i){this.log(`clear asset player "${e}" toSegment: ${t?$S(t):t}`);const r=this.playerQueue[i];this.transferMediaFromPlayer(r,t),this.playerQueue.splice(i,1),r.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,r,n){const{interstitial:s,assetItem:a,assetId:o}=e,l=s.assetList.length,h=this.playingAsset;this.endedAsset=null,this.playingAsset=a,h&&h.identifier===o||(h&&(this.clearAssetPlayer(h.identifier,i[r]),delete h.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${HS(a)}`),this.hls.trigger(Vp.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:s,schedule:i.slice(0),scheduleIndex:r,player:e})),this.bufferAssetPlayer(e,n)}bufferAssetPlayer(e,t){var i,r;const{interstitial:n,assetItem:s}=e,a=this.schedule.findEventIndex(n.identifier),o=null==(i=this.schedule.items)?void 0:i[a];if(!o)return;this.setBufferingItem(o),this.bufferingAsset=s;const l=this.getBufferingPlayer();if(l===e)return;const h=n.appendInPlace;if(h&&!1===(null==l?void 0:l.interstitial.appendInPlace))return;const c=(null==l?void 0:l.tracks)||(null==(r=this.detachedData)?void 0:r.tracks)||this.requiredTracks;if(h&&s!==this.playingAsset){if(!e.tracks)return;if(c&&!sm(c,e.tracks)){const t=new Error(`Asset ${HS(s)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(c)}')`),i={fatal:!0,type:Fp.OTHER_ERROR,details:Bp.INTERSTITIAL_ASSET_ITEM_ERROR,error:t},r=n.findAssetIndex(s);return void this.handleAssetItemError(i,n,a,r,t.message)}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,r,n){if(e.details===Bp.BUFFER_STALLED_ERROR)return;const s=t.assetList[r];this.warn(`INTERSTITIAL_ASSET_ERROR ${s?HS(s):s} ${e.error}`);const a=null==s?void 0:s.identifier,o=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[o]||null,h=this.schedule.items,c=Yp({},e,{fatal:!1,errorAction:Kg(!0),asset:s,assetListIndex:r,event:t,schedule:h,scheduleIndex:i,player:l});if(this.hls.trigger(Vp.INTERSTITIAL_ASSET_ERROR,c),!e.fatal)return;const d=this.playingAsset,u=new Error(n);if(s&&(this.clearAssetPlayer(a,null),s.error=u),t.assetList.some(e=>!e.error)){if(t.appendInPlace){for(let e=r;e<t.assetList.length;e++)this.resetAssetPlayer(t.assetList[e].identifier);this.updateSchedule()}}else t.error=u;t.error?this.primaryFallback(t):d&&d.identifier===a&&this.advanceAfterAssetEnded(t,i,r)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?$S(i):"<none>"} error: ${e.error}`);let r=this.timelinePos;-1===r&&(r=this.hls.startPosition);const n=this.updateItem(i,r);this.itemsMatch(i,n)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));const s=this.schedule.findItemIndexAtTime(r);this.setSchedulePosition(s)}else this.checkStart()}onAssetListLoaded(e,t){var i;const r=t.event,n=r.identifier,s=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(n))return;const a=r.timelineStart,o=r.duration;let l=0;s.forEach((e,t)=>{const i=parseFloat(e.DURATION);this.createAsset(r,t,l,a+l,i,e.URI),l+=i}),r.duration=l,this.log(`Loaded asset-list with duration: ${l} (was: ${o}) ${r}`);const h=this.waitingItem,c=(null==h?void 0:h.event.identifier)===n;this.updateSchedule();const d=null==(i=this.bufferingItem)?void 0:i.event;if(c){var u;const e=this.schedule.findEventIndex(n),t=null==(u=this.schedule.items)?void 0:u[e];if(t){if(!this.playingItem&&this.timelinePos>t.end){if(this.schedule.findItemIndexAtTime(this.timelinePos)!==e)return r.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${r}`),void this.primaryFallback(r)}this.setBufferingItem(t)}this.setSchedulePosition(e)}else if((null==d?void 0:d.identifier)===n&&d.appendInPlace){const e=r.assetList[0],t=this.getAssetPlayer(e.identifier),i=this.primaryMedia;e&&t&&i&&this.bufferAssetPlayer(t,i)}}onError(e,t){switch(t.details){case Bp.ASSET_LIST_PARSING_ERROR:case Bp.ASSET_LIST_LOAD_ERROR:case Bp.ASSET_LIST_LOAD_TIMEOUT:{const e=t.interstitial;e&&this.primaryFallback(e);break}case Bp.BUFFER_STALLED_ERROR:this.onTimeupdate(),this.checkBuffer(!0)}}}});function Ob(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(Ob):Object.keys(e).reduce((t,i)=>(t[i]=Ob(e[i]),t),{}):e}function Ub(e,t){const i=e.loader;if(i!==FetchLoader&&i!==XhrLoader)t.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(e.loader=FetchLoader,e.progressive=!0,e.enableSoftwareAES=!0,t.log("[config]: Progressive streaming enabled, using FetchLoader"))}}class GapController extends TaskLoop{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var e;null!=(e=this.media)&&e.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{var e;this.hls&&(this.ended=(null==(e=this.media)?void 0:e.currentTime)||1,this.hls.trigger(Vp.MEDIA_ENDED,{stalled:!1}))},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(100),this.mediaSource=t.mediaSource;const i=this.media=t.media;CS(i,"playing",this.onMediaPlaying),CS(i,"waiting",this.onMediaWaiting),CS(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(RS(i,"playing",this.onMediaPlaying),RS(i,"waiting",this.onMediaWaiting),RS(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(null==(e=this.media)||!e.readyState||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,r;const n=null==(i=this.hls)?void 0:i.config;if(!n)return;const s=this.media;if(!s)return;const{seeking:a}=s,o=this.seeking&&!a,l=!this.seeking&&a,h=s.paused&&!a||s.ended||0===s.playbackRate;if(this.seeking=a,e!==t)return t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,n.nudgeOnVideoHole&&!h&&e>t&&this.nudgeOnVideoHole(e,t)),void(0===this.waiting&&this.stallResolved(e));if(l||o)return void(o&&this.stallResolved(e));if(h)return this.nudgeRetry=0,this.stallResolved(e),void(!this.ended&&s.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(Vp.MEDIA_ENDED,{stalled:!1})));if(!BufferHelper.getBuffered(s).length)return void(this.nudgeRetry=0);const c=BufferHelper.bufferInfo(s,e,0),d=c.nextStart||0,u=this.fragmentTracker;if(a&&u&&this.hls){const t=Nb(this.hls.inFlightFragments,e),i=c.len>2,r=!d||t||d-e>2&&!u.getPartialFragment(e);if(i||r)return;this.moved=!1}const f=null==(r=this.hls)?void 0:r.latestLevelDetails;if(!this.moved&&null!==this.stalled&&u){if(!(c.len>0)&&!d)return;const t=Math.max(d,c.start||0)-e,i=!(null==f||!f.live)?2*f.targetduration:2,r=u.getPartialFragment(e);if(t>0&&(t<=i||r))return void(s.paused||this._trySkipBufferHole(r))}const p=n.detectStallWithCurrentTimeMs,m=self.performance.now(),g=this.waiting;let v=this.stalled;if(null===v){if(!(g>0&&m-g<p))return void(this.stalled=m);v=this.stalled=g}const y=m-v;if(!a&&(y>=p||g)&&this.hls){var _;if("ended"===(null==(_=this.mediaSource)?void 0:_.readyState)&&(null==f||!f.live)&&Math.abs(e-((null==f?void 0:f.edge)||0))<1){if(this.ended)return;return this.ended=e||1,void this.hls.trigger(Vp.MEDIA_ENDED,{stalled:!0})}if(this._reportStall(c),!this.media||!this.hls)return}const S=BufferHelper.bufferInfo(s,e,n.maxBufferHole);this._tryFixBufferStall(S,y,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(Vp.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const r=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&null!=(i=this.buffered.audio)&&i.length&&r&&r.length>1&&e>r.end(0)){const i=BufferHelper.bufferedInfo(BufferHelper.timeRangesToArray(this.buffered.audio),e,0);if(i.len>1&&t>=i.start){const i=BufferHelper.timeRangesToArray(r),n=BufferHelper.bufferedInfo(i,t,0).bufferedIndex;if(n>-1&&n<i.length-1){const t=BufferHelper.bufferedInfo(i,e,0).bufferedIndex,r=i[n].end,s=i[n+1].start;if((-1===t||t>n)&&s-r<1&&e-r<2){const i=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${r} -> ${s} buffered index: ${t}`);this.warn(i.message),this.media.currentTime+=1e-6;const n=this.fragmentTracker.getPartialFragment(e)||void 0,a=BufferHelper.bufferInfo(this.media,e,0);this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:i,reason:i.message,frag:n,buffer:a.len,bufferInfo:a})}}}}}_tryFixBufferStall(e,t,i){var r,n;const{fragmentTracker:s,media:a}=this,o=null==(r=this.hls)?void 0:r.config;if(!a||!s||!o)return;const l=null==(n=this.hls)?void 0:n.latestLevelDetails,h=s.getPartialFragment(i);if(h||null!=l&&l.live&&i<l.fragmentStart){if(this._trySkipBufferHole(h)||!this.media)return}const c=e.buffered,d=this.adjacentTraversal(e,i);(c&&c.length>1&&e.len>o.maxBufferHole||e.nextStart&&(e.nextStart-i<o.maxBufferHole||d))&&(t>1e3*o.highBufferWatchdogPeriod||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,r=e.nextStart;if(i&&r){const e=i.getFragAtPos(t,Wp),n=i.getFragAtPos(r,Wp);if(e&&n)return n.sn-e.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:r,stalled:n}=this;if(!r&&null!==n&&i&&t){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${Tg(e)})`);this.warn(r.message),t.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len,bufferInfo:e,stalled:{start:n}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:r}=this,n=null==(t=this.hls)?void 0:t.config;if(!r||!i||!n)return 0;const s=r.currentTime,a=BufferHelper.bufferInfo(r,s,0),o=s<a.start?a.start:a.nextStart;if(o&&this.hls){const t=a.len<=n.maxBufferHole,h=a.len>0&&a.len<1&&r.readyState<3,c=o-s;if(c>0&&(t||h)){if(c>n.maxBufferHole){let t=!1;if(0===s){const e=i.getAppendedFrag(0,Wp);e&&o<e.end&&(t=!0)}if(!t){const t=e||i.getAppendedFrag(s,Wp);if(t){var l;if(null==(l=this.hls.loadLevelObj)||!l.details)return 0;if(Nb(this.hls.inFlightFragments,o))return 0;let e=!1,r=t.end;for(;r<o;){const t=i.getPartialFragment(r);if(!t){e=!0;break}r+=t.duration}if(e)return 0}}}const t=Math.max(o+.05,s+.1);if(this.warn(`skipping hole, adjusting currentTime from ${s} to ${t}`),this.moved=!0,r.currentTime=t,null==e||!e.gap){const i=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${t}`);this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:i,reason:i.message,frag:e||void 0,buffer:a.len,bufferInfo:a})}return t}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:r}=this,n=null==t?void 0:t.config;if(!i||!n)return 0;const s=i.currentTime;if(this.nudgeRetry++,r<n.nudgeMaxRetry){const a=s+(r+1)*n.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${s} to ${a}`);this.warn(o.message),i.currentTime=a,t.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1,buffer:e.len,bufferInfo:e})}else{const i=new Error(`Playhead still not moving while enough data buffered @${s} after ${n.nudgeMaxRetry} nudges`);this.error(i.message),t.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.BUFFER_STALLED_ERROR,error:i,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Nb(e,t){const i=Fb(e.main);if(i&&i.start<=t)return i;const r=Fb(e.audio);return r&&r.start<=t?r:null}function Fb(e){if(!e)return null;switch(e.state){case Sy:case _y:case Ay:case Ly:return null}return e.frag}function Bb(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function Vb(e,t,i,r,n){let s=new e(t,i,"");try{s.value=r,n&&(s.type=n)}catch(a){s=new e(t,i,Tg(n?Qp({type:n},r):r))}return s}const Gb=(()=>{const e=Bb();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function zb(e){return Uint8Array.from(e.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class ID3TrackController{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(Vp.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Vp.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(Vp.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(Vp.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Vp.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var i;this.media=t.media,!1===(null==(i=t.overrides)?void 0:i.cueRemoval)&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null;!!t.transferMedia||(this.id3Track&&(this.removeCues&&DS(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if("metadata"===i.kind&&"id3"===i.label)return PS(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;const{samples:n}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const s=Bb();if(s)for(let e=0;e<n.length;e++){const t=n[e].type;if(t===s_.emsg&&!i||!r)continue;const a=t_(n[e].data);if(a){const i=n[e].pts;let r=i+n[e].duration;r>Gb&&(r=Gb);r-i<=0&&(r=i+.25);for(let e=0;e<a.length;e++){const n=a[e];if(!i_(n)){this.updateId3CueEnds(i,t);const e=Vb(s,i,r,n,t);e&&this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var i;const r=null==(i=this.id3Track)?void 0:i.cues;if(r)for(let i=r.length;i--;){const n=r[i];n.type===t&&n.startTime<e&&n.endTime===Gb&&(n.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:r}){const{id3Track:n,hls:s}=this;if(!s)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=s;if(n&&(a||o)){let e;e="audio"===r?e=>e.type===s_.audioId3&&o:"video"===r?e=>e.type===s_.emsg&&a:e=>e.type===s_.audioId3&&o||e.type===s_.emsg&&a,kS(n,t,i,e)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:i}=this,{dateRanges:r}=e,n=Object.keys(r);let s=this.dateRangeCuesAppended;var a;if(i&&t)if(null!=(a=i.cues)&&a.length){const e=Object.keys(s).filter(e=>!n.includes(e));for(let t=e.length;t--;){const r=e[t],n=s[r].cues;delete s[r],Object.keys(n).forEach(e=>{try{const t=n[e];t.removeEventListener("enter",this.onEventCueEnter),i.removeCue(t)}catch(e){}})}}else s=this.dateRangeCuesAppended={};const o=e.fragments[e.fragments.length-1];if(0===n.length||!Op(null==o?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=Bb();for(let e=0;e<n.length;e++){const t=n[e],i=r[t],a=i.startTime,o=s[t],h=(null==o?void 0:o.cues)||{};let c=(null==o?void 0:o.durationKnown)||!1,d=Gb;const{duration:u,endDate:f}=i;if(f&&null!==u)d=a+u,c=!0;else if(i.endOnNext&&!c){const e=n.reduce((e,t)=>{if(t!==i.id){const n=r[t];if(n.class===i.class&&n.startDate>i.startDate&&(!e||i.startDate<e.startDate))return n}return e},null);e&&(d=e.startTime,c=!0)}const p=Object.keys(i.attr);for(let e=0;e<p.length;e++){const r=p[e];if(!mv(r))continue;const n=h[r];if(n)c&&!o.durationKnown?n.endTime=d:Math.abs(n.startTime-a)>.01&&(n.startTime=a,n.endTime=d);else if(l){let e=i.attr[r];gv(r)&&(e=zb(e));const n=Vb(l,a,d,{key:r,data:e},s_.dateRange);n&&(n.id=t,this.id3Track.addCue(n),h[r]=n,this.hls.config.interstitialsController&&("X-ASSET-LIST"!==r&&"X-ASSET-URL"!==r||n.addEventListener("enter",this.onEventCueEnter)))}}s[t]={cues:h,dateRange:i,durationKnown:c}}}}class LatencyController{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:e}=this,t=this.levelDetails;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:n}=this.config;if(!r||1===n||!t.live)return;const s=this.targetLatency;if(null===s)return;const a=i-s;if(a<Math.min(this.maxLatency,s+t.targetduration)&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,n)),i=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20,r=Math.min(t,Math.max(1,i));this.changeMediaPlaybackRate(e,r)}else 1!==e.playbackRate&&0!==e.playbackRate&&this.changeMediaPlaybackRate(e,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return(null==(e=this.hls)?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(void 0!==e.liveMaxLatencyDuration)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(null===e||null===this.hls)return null;const{holdBack:t,partHoldBack:i,targetduration:r}=e,{liveSyncDuration:n,liveSyncDurationCount:s,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&i||t;(this._targetLatencyUpdated||o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==n?n:s*r);const h=r;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,h)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(null===e||null===t)return null;const i=this.levelDetails;if(null===i)return null;const r=i.edge,n=e-t-this.edgeStalled,s=r-i.totalduration,a=r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(s,n),a)}get drift(){const e=this.levelDetails;return null===e?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Vp.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(Vp.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Vp.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Vp.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===Bp.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&null!=(i=this.levelDetails)&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,r;e.playbackRate!==t&&(null==(i=this.hls)||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${null==(r=this.targetLatency)?void 0:r.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}class LevelController extends BasePlaylistController{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Vp.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Vp.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Vp.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,r=[],n={},s={};let a=!1,o=!1,l=!1;t.levels.forEach(e=>{const t=e.attrs;let{audioCodec:h,videoCodec:c}=e;h&&(e.audioCodec=h=ng(h,i)||void 0),c&&(c=e.videoCodec=function(e){const t=e.split(",");for(let e=0;e<t.length;e++){const i=t[e].split(".");i.length>2&&"avc1"===i[0]&&(t[e]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return t.join(",")}(c));const{width:d,height:u,unknownCodecs:f}=e;let p=f?f.length:0;if(f)for(let t=p;t--;){const i=f[t];this.isAudioSupported(i)?(e.audioCodec=h=h?`${h},${i}`:i,p--,Ym.audio[h.substring(0,4)]=2):this.isVideoSupported(i)&&(e.videoCodec=c=c?`${c},${i}`:i,p--,Ym.video[c.substring(0,4)]=2)}if(a||(a=!(!d||!u)),o||(o=!!c),l||(l=!!h),p||h&&!this.isAudioSupported(h)||c&&!this.isVideoSupported(c))return void this.log(`Some or all CODECS not supported "${t.CODECS}"`);const{CODECS:m,"FRAME-RATE":g,"HDCP-LEVEL":v,"PATHWAY-ID":y,RESOLUTION:_,"VIDEO-RANGE":S}=t,b=`${`${y||"."}-`}${e.bitrate}-${_}-${g}-${m}-${S}-${v}`;if(n[b])if(n[b].uri===e.url||e.attrs["PATHWAY-ID"])n[b].addGroupId("audio",t.AUDIO),n[b].addGroupId("text",t.SUBTITLES);else{const t=s[b]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const i=this.createLevel(e);n[b]=i,r.push(i)}else{const t=this.createLevel(e);n[b]=t,s[b]=1,r.push(t)}}),this.filterAndSortMediaOptions(r,t,a,o,l)}createLevel(e){const t=new Level(e),i=e.supplemental;if(null!=i&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const e=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(e.message),t.supportedResult=cg(e,[])}return t}isAudioSupported(e){return Qm(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Qm(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,r,n){let s=[],a=[],o=e;if((i||r)&&n&&(o=o.filter(({videoCodec:e,videoRange:t,width:i,height:r})=>{return(!!e||!(!i||!r))&&(!!(n=t)&&mg.indexOf(n)>-1);var n})),0===o.length)return void Promise.resolve().then(()=>{if(this.hls){let e="no level with compatible codecs found in manifest",i=e;t.levels.length&&(i=`one or more CODECS in variant not supported: ${Tg(t.levels.map(e=>e.attrs.CODECS).filter((e,t,i)=>i.indexOf(e)===t))}`,this.warn(i),e+=` (${i})`);const r=new Error(e);this.hls.trigger(Vp.ERROR,{type:Fp.MEDIA_ERROR,details:Bp.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:r,reason:i})}});t.audioTracks&&(s=t.audioTracks.filter(e=>!e.audioCodec||this.isAudioSupported(e.audioCodec)),Hb(s)),t.subtitles&&(a=t.subtitles,Hb(a));const l=o.slice(0);o.sort((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return mg.indexOf(e.videoRange)-mg.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const i=eg(e.videoCodec),r=eg(t.videoCodec);if(i!==r)return r-i}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const i=tg(e.codecSet),r=tg(t.codecSet);if(i!==r)return r-i}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0});let h=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let e=0;e<l.length;e++)if(l[e].pathwayId===o[0].pathwayId){h=l[e];break}this._levels=o;for(let e=0;e<o.length;e++)if(o[e]===h){var c;this._firstLevel=e;const t=h.bitrate,i=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${t}`),void 0===(null==(c=this.hls.userConfig)?void 0:c.abrEwmaDefaultEstimate)){const e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>i&&i===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}const d=n&&!r,u=this.hls.config,f=!(!u.audioStreamController||!u.audioTrackController),p={levels:o,audioTracks:s,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:n,video:r,altAudio:f&&!d&&s.some(e=>!!e.url)};this.hls.trigger(Vp.MANIFEST_PARSED,p)}get levels(){return 0===this._levels.length?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const i=new Error("invalid level idx"),r=e<0;if(this.hls.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:i,reason:i.message}),r)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,r=this.currentLevel,n=r?r.attrs["PATHWAY-ID"]:void 0,s=t[e],a=s.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=s,i===e&&r&&n===a)return;this.log(`Switching to level ${e} (${s.height?s.height+"p ":""}${s.videoRange?s.videoRange+" ":""}${s.codecSet?s.codecSet+" ":""}@${s.bitrate})${a?" with Pathway "+a:""} from level ${i}${n?" with Pathway "+n:""}`);const o={level:e,attrs:s.attrs,details:s.details,bitrate:s.bitrate,averageBitrate:s.averageBitrate,maxBitrate:s.maxBitrate,realBitrate:s.realBitrate,width:s.width,height:s.height,codecSet:s.codecSet,audioCodec:s.audioCodec,videoCodec:s.videoCodec,audioGroups:s.audioGroups,subtitleGroups:s.subtitleGroups,loaded:s.loaded,loadError:s.loadError,fragmentError:s.fragmentError,name:s.name,id:s.id,uri:s.uri,url:s.url,urlId:0,audioGroupIds:s.audioGroupIds,textGroupIds:s.textGroupIds};this.hls.trigger(Vp.LEVEL_SWITCHING,o);const l=s.details;if(!l||l.live){const e=this.switchParams(s.uri,null==r?void 0:r.details,l);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(e=>-1!==t.indexOf(e));if(e.length<1)return void this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);this.steering.pathwayPriority=i}}onError(e,t){!t.fatal&&t.context&&t.context.type===zp&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===Wp){const e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t]))return;const i=this._levels[t.level];null!=i&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(e,t){var i;const{level:r,details:n}=t,s=t.levelInfo;var a;if(!s)return this.warn(`Invalid level index ${r}`),void(null!=(a=t.deliveryDirectives)&&a.skip&&(n.deltaUpdateFailed=!0));if(s===this.currentLevel||t.withoutMultiVariant){0===s.fragmentError&&(s.loadError=0);let e=s.details;e===t.details&&e.advanced&&(e=void 0),this.playlistLoaded(r,t,e)}else null!=(i=t.deliveryDirectives)&&i.skip&&(n.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),r=this.currentLevelIndex,n=e.attrs["PATHWAY-ID"],s=e.details,a=null==s?void 0:s.age;this.log(`Loading level index ${r}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${n?" Pathway "+n:""}${a&&s.live?" age "+a.toFixed(1)+(s.type?" "+s.type||0:""):""} ${i}`),this.hls.trigger(Vp.LEVEL_LOADING,{url:i,level:r,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(1===this._levels.length)return;const i=this._levels.filter((t,i)=>i!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach(e=>e.level=-1)),!1));uy(i),this._levels=i,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const r=i.length-1;this._firstLevel=Math.min(this._firstLevel,r),this._startLevel&&(this._startLevel=Math.min(this._startLevel,r)),this.hls.trigger(Vp.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(Vp.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function Hb(e){const t={};e.forEach(e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++})}function $b(){return self.SourceBuffer||self.WebKitSourceBuffer}function Wb(){if(!nm())return!1;const e=$b();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}class StreamController extends BaseStreamController{constructor(e,t,i){super(e,t,i,"stream-controller",Wp),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const e=this.media,t=e?e.currentTime:null;if(null===t||!Op(t))return;if(this.log(`Media seeked to ${t.toFixed(3)}`),!this.getBufferedFrag(t))return;const i=this.getFwdBufferInfoAtPos(e,t,Wp,0);null!==i&&0!==i.len?this.tick():this.warn(`Main forward buffer length at ${t} on "seeked" event ${i?i.len:"empty"})`)},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.on(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Vp.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Vp.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(Vp.BUFFER_CREATED,this.onBufferCreated,this),e.on(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Vp.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(Vp.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Vp.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Vp.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(Vp.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Vp.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(Vp.BUFFER_CREATED,this.onBufferCreated,this),e.off(Vp.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Vp.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:r}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=r.startLevel;-1===e&&(r.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=r.firstAutoLevel),r.nextLoadLevel=e,this.level=r.loadLevel,this._hasEnoughToStart=!!t}i>0&&-1===e&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=Sy,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=_y}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case Ry:{const{levels:e,level:t}=this,i=null==e?void 0:e[t],r=null==i?void 0:i.details;if(r&&(!r.live||this.levelLastLoaded===i&&!this.waitForLive(i))){if(this.waitForCdnTuneIn(r))break;this.state=Sy;break}if(this.hls.nextLoadLevel!==this.level){this.state=Sy;break}break}case xy:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,i=null==e?void 0:e[t];this.resetStartWhenNotLoaded(i||null),this.state=Sy}}}this.state===Sy&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),null!=(e=this.media)&&e.readyState&&!1===this.media.seeking&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:r}=this;if(null===t||!r&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const n=this.buffering?e.nextLoadLevel:e.loadLevel;if(null==i||!i[n])return;const s=i[n],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const e={};return 2===this.altAudio&&(e.type="video"),this.hls.trigger(Vp.BUFFER_EOS,e),void(this.state=Ay)}if(!this.buffering)return;e.loadLevel!==n&&-1===e.manualLevel&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=e.nextLoadLevel=n;const l=s.details;if(!l||this.state===Ry||this.waitForLive(s))return this.level=n,this.state=Ry,void(this.startFragRequested=!1);const h=a.len,c=this.getMaxBufferLength(s.maxBitrate);if(h>=c)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:a.end;let u=this.getNextFragment(d,l);if(this.couldBacktrack&&!this.fragPrevious&&u&&Sm(u)&&this.fragmentTracker.getState(u)!==Zg){var f;const e=(null!=(f=this.backtrackFragment)?f:u).sn-l.startSN,t=l.fragments[e-1];t&&u.cc===t.cc&&(u=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(u&&this.isLoopLoading(u,d)){if(!u.gap){const e=this.audioOnly&&!this.altAudio?vm:ym,t=(e===ym?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,Wp)}u=this.getNextFragmentLoopLoading(u,l,a,Wp,c)}u&&(!u.initSegment||u.initSegment.data||this.bitrateTest||(u=u.initSegment),this.loadFragment(u,s,d))}loadFragment(e,t,i){const r=this.fragmentTracker.getState(e);r===Yg||r===Qg?Sm(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,Wp)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let i;const r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const n=this.getLevelDetails();if(null!=n&&n.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*n.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;i=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else i=0;const s=this.getBufferedFrag(t.currentTime+i);if(s){const e=this.followingBufferedFrag(s);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,i=e.duration,r=Math.max(s.end,t+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case by:case Ty:case xy:case My:case wy:this.state=Sy}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,2===this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;CS(i,"playing",this.onMediaPlaying),CS(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(RS(i,"playing",this.onMediaPlaying),RS(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t);!!t.transferMedia||(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(Vp.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,r=!1;t.levels.forEach(e=>{const t=e.audioCodec;t&&(i=i||-1!==t.indexOf("mp4a.40.2"),r=r||-1!==t.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=i&&r&&!function(){var e;const t=$b();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==Sy)return;const r=t.levelInfo;(!r.details||r.details.live&&(this.levelLastLoaded!==r||r.details.expired)||this.waitForCdnTuneIn(r.details))&&(this.state=Ry)}onLevelLoaded(e,t){var i;const{levels:r,startFragRequested:n}=this,s=t.level,a=t.details,o=a.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const l=t.levelInfo,h=this.fragCurrent;!h||this.state!==Ty&&this.state!==xy||h.level!==t.level&&h.loader&&this.abortCurrentFrag();let c=0;if(a.live||null!=(i=l.details)&&i.live){var d;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;c=this.alignPlaylists(a,l.details,null==(d=this.levelLastLoaded)?void 0:d.details)}if(l.details=a,this.levelLastLoaded=l,n||this.setStartPosition(a,c),this.hls.trigger(Vp.LEVEL_UPDATED,{details:a,level:s}),this.state===Ry){if(this.waitForCdnTuneIn(a))return;this.state=Sy}n&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const r=this.hls.liveSyncPosition,n=this.getLoadPosition(),s=e.fragmentStart,a=e.edge,o=n>=s-t.maxFragLookUpTolerance&&n<=a;if(null!==r&&i.duration>r&&(n<r||!o)){const s=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!o&&i.readyState<4||n<a-s)&&(this._hasEnoughToStart||(this.nextLoadPosition=r),i.readyState))if(this.warn(`Playback: ${n.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),"buffered"===this.config.liveSyncMode){var l;const e=BufferHelper.bufferInfo(i,r,0);if(null==e||null==(l=e.buffered)||!l.length)return void(i.currentTime=r);if(e.start<=n)return void(i.currentTime=r);const{nextStart:t}=BufferHelper.bufferedInfo(e.buffered,n,0);t&&(i.currentTime=t)}else i.currentTime=r}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:r,payload:n}=e,{levels:s}=this;if(!s)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const a=s[i.level];if(!a)return void this.warn(`Level ${i.level} not found on progress`);const o=a.details;if(!o)return this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),void this.fragmentTracker.removeFragment(i);const l=a.videoCodec,h=o.PTSKnown||!o.live,c=null==(t=i.initSegment)?void 0:t.data,d=this._getAudioCodec(a),u=this.transmuxer=this.transmuxer||new TransmuxerInterface(this.hls,Wp,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,p=-1!==f,m=new ChunkMetadata(i.level,i.sn,i.stats.chunkCount,n.byteLength,f,p),g=this.initPTS[i.cc];u.push(n,c,d,l,i,r,o.totalduration,h,m,g)}onAudioTrackSwitching(e,t){const i=this.hls,r=2===this.altAudio;if(Rg(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(r)return this.fragmentTracker.removeAllFragments(),i.once(Vp.BUFFER_FLUSHED,()=>{var e;null==(e=this.hls)||e.trigger(Vp.AUDIO_TRACK_SWITCHED,t)}),void i.trigger(Vp.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});i.trigger(Vp.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=Rg(t.url,this.hls);if(i){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let r,n,s=!1;for(const e in i){const t=i[e];if("main"===t.id){if(n=e,r=t,"video"===e){const t=i[e];t&&(this.videoBuffer=t.buffer)}}else s=!0}s&&r?(this.log(`Alternate track found, use ${n}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:r}=t,n=i.type===Wp;if(n){if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===wy&&(this.state=Sy));const e=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*e.total/(e.buffering.end-e.loading.first)),Sm(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}const s=this.media;s&&(!this._hasEnoughToStart&&BufferHelper.getBuffered(s).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),n&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal)this.state=Ly;else switch(t.details){case Bp.FRAG_GAP:case Bp.FRAG_PARSING_ERROR:case Bp.FRAG_DECRYPT_ERROR:case Bp.FRAG_LOAD_ERROR:case Bp.FRAG_LOAD_TIMEOUT:case Bp.KEY_LOAD_ERROR:case Bp.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(Wp,t);break;case Bp.LEVEL_LOAD_ERROR:case Bp.LEVEL_LOAD_TIMEOUT:case Bp.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Ry||(null==(i=t.context)?void 0:i.type)!==zp||(this.state=Sy);break;case Bp.BUFFER_ADD_CODEC_ERROR:case Bp.BUFFER_APPEND_ERROR:if("main"!==t.parent)return;this.resetLoadingState();break;case Bp.BUFFER_FULL_ERROR:if("main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case Bp.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onFragLoadEmergencyAborted(){this.state=Sy,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==vm||!this.altAudio){const e=(t===ym?this.videoBuffer:this.mediaBuffer)||this.media;e&&(this.afterBufferFlushed(e,t,Wp),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,-1===this.level&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking)return void this.log(`could not seek to ${i}, already seeking at ${t}`);const r=this.timelineOffset;r&&i&&(i+=r);const n=this.getLevelDetails(),s=BufferHelper.getBuffered(e),a=s.length?s.start(0):0,o=a-i,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||o>0&&(o<l||this.loadingParts&&o<2*((null==n?void 0:n.partTarget)||0)))&&(this.log(`adjusting start position by ${o} to match buffer start`),i+=o,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(e=>{const{hls:i}=this,r=null==e?void 0:e.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=Sy,this.startFragRequested=!1,this.bitrateTest=!1;const n=r.stats;n.parsing.start=n.parsing.end=n.buffering.start=n.buffering.end=self.performance.now(),i.trigger(Vp.FRAG_LOADED,e),r.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i=this.playlistType,{hls:r}=this,{remuxResult:n,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:h}=a,{video:c,text:d,id3:u,initSegment:f}=n,{details:p}=h,m=this.altAudio?void 0:n.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=My,f){if(null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(h,f.tracks,e,s),r.trigger(Vp.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:f.tracks})}const e=f.initPTS,t=f.timescale;Op(e)&&(this.initPTS[o.cc]={baseTime:e,timescale:t},r.trigger(Vp.INIT_PTS_FOUND,{frag:o,id:i,initPTS:e,timescale:t}))}if(c&&p){m&&"audiovideo"===c.type&&this.logMuxedErr(o);const e=p.fragments[o.sn-1-p.startSN],t=o.sn===p.startSN,i=!e||o.cc>e.cc;if(!1!==n.independent){const{startPTS:e,endPTS:r,startDTS:n,endDTS:a}=c;if(l)l.elementaryStreams[c.type]={startPTS:e,endPTS:r,startDTS:n,endDTS:a};else if(c.firstKeyFrame&&c.independent&&1===s.id&&!i&&(this.couldBacktrack=!0),c.dropped&&c.independent){const n=this.getMainFwdBufferInfo(),s=(n?n.end:this.getLoadPosition())+this.config.maxBufferHole,l=c.firstKeyFramePTS?c.firstKeyFramePTS:e;if(!t&&s<l-this.config.maxBufferHole&&!i)return void this.backtrack(o);i&&(o.gap=!0),o.setElementaryStreamInfo(c.type,o.start,r,o.start,a,!0)}else t&&e-(p.appliedTimelineOffset||0)>2&&(o.gap=!0);o.setElementaryStreamInfo(c.type,e,r,n,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(c,o,l,s,t||i)}else{if(!t&&!i)return void this.backtrack(o);o.gap=!0}}if(m){const{startPTS:e,endPTS:t,startDTS:i,endDTS:r}=m;l&&(l.elementaryStreams[vm]={startPTS:e,endPTS:t,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(vm,e,t,i,r),this.bufferFragmentData(m,o,l,s)}if(p&&null!=u&&null!=(t=u.samples)&&t.length){const e={id:i,frag:o,details:p,samples:u.samples};r.trigger(Vp.FRAG_PARSING_METADATA,e)}if(p&&d){const e={id:i,frag:o,details:p,samples:d.samples};r.trigger(Vp.FRAG_PARSING_USERDATA,e)}}}logMuxedErr(e){this.warn(`${Sm(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,r){if(this.state!==My)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:n,video:s,audiovideo:a}=t;if(n){let i=sg(n.codec,e.audioCodec);"mp4a"===i&&(i="mp4a.40.5");const r=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){i&&(i=-1!==i.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const e=n.metadata;e&&"channelCount"in e&&1!==(e.channelCount||1)&&-1===r.indexOf("firefox")&&(i="mp4a.40.5")}i&&-1!==i.indexOf("mp4a.40.5")&&-1!==r.indexOf("android")&&"audio/mpeg"!==n.container&&(i="mp4a.40.2",this.log(`Android: force audio codec to ${i}`)),e.audioCodec&&e.audioCodec!==i&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${i}"`),n.levelCodec=i,n.id=Wp,this.log(`Init audio buffer, container:${n.container}, codecs[selected/level/parsed]=[${i||""}/${e.audioCodec||""}/${n.codec}]`),delete t.audiovideo}if(s){s.levelCodec=e.videoCodec,s.id=Wp;const i=s.codec;if(4===(null==i?void 0:i.length))switch(i){case"hvc1":case"hev1":s.codec="hvc1.1.6.L120.90";break;case"av01":s.codec="av01.0.04M.08";break;case"avc1":s.codec="avc1.42e01e"}this.log(`Init video buffer, container:${s.container}, codecs[level/parsed]=[${e.videoCodec||""}/${i}]${s.codec!==i?" parsed-corrected="+s.codec:""}${s.supplemental?" supplemental="+s.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const o=Object.keys(t);if(o.length){if(this.hls.trigger(Vp.BUFFER_CODECS,t),!this.hls)return;o.forEach(e=>{const n=t[e].initSegment;null!=n&&n.byteLength&&this.hls.trigger(Vp.BUFFER_APPENDING,{type:e,data:n,frag:i,part:null,chunkMeta:r,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&2===this.altAudio?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,Wp)}get maxBufferLength(){const{levels:e,level:t}=this,i=null==e?void 0:e[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Sy}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const i=e.currentTime;if(BufferHelper.isBuffered(e,i)?t=this.getAppendedFrag(i):BufferHelper.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,i=t.level;e&&t.sn===e.sn&&e.level===i||(this.fragPlaying=t,this.hls.trigger(Vp.FRAG_CHANGED,{frag:t}),e&&e.level===i||this.hls.trigger(Vp.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;return Op(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;if(Op(t)){const e=this.getLevelDetails(),i=this.currentFrag||(e?Ig(null,e.fragments,t):null);if(i){const e=i.programDateTime;if(null!==e){const r=e+1e3*(t-i.start);return new Date(r)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class KeyLoader{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[i].loader;if(r){var t;if(e&&e!==(null==(t=r.context)?void 0:t.frag.type))return;r.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=Bp.KEY_LOAD_ERROR,i,r,n){return new LoadError({type:Fp.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:n,error:i,networkDetails:r})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length)if(t.length){const{sn:i,cc:r}=e;for(let e=0;e<t.length;e++){const n=t[e];if(r<=n.cc&&("initSegment"===i||"initSegment"===n.sn||i<n.sn))return this.emeController.selectKeySystemFormat(n).then(e=>{if(n.setKeyFormat(e),this.emeController&&this.config.requireKeySystemAccessOnStart){const t=Lv(e);if(t)return this.emeController.getKeySystemAccess([t])}})}}else if(this.config.requireKeySystemAccessOnStart){const e=Ov(this.config);if(e.length)return this.emeController.getKeySystemAccess(e)}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,r;t&&e.setKeyFormat(t);const n=e.decryptdata;if(!n){const i=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,Bp.KEY_LOAD_ERROR,i))}const s=n.uri;if(!s)return Promise.reject(this.createKeyLoadError(e,Bp.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${s}"`)));let a=this.keyUriToKeyInfo[s];if(null!=(i=a)&&i.decryptdata.key)return n.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(t=>(n.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}switch(a=this.keyUriToKeyInfo[s]={decryptdata:n,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},n.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===n.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,Bp.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${n.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(i);if(t)return(e.keyLoadPromise=t.then(t=>(e.mediaKeySessionContext=t,i))).catch(t=>{throw e.keyLoadPromise=null,t})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,r=new(0,i.loader)(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((n,s)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=i.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(e,t,i,r)=>{const{frag:a,keyInfo:o,url:l}=i;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return s(this.createKeyLoadError(a,Bp.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,o.loader=null,n({frag:a,keyInfo:o})},onError:(e,i,r,n)=>{this.resetLoader(i),s(this.createKeyLoadError(t,Bp.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),r,Qp({url:a.url,data:void 0},e)))},onTimeout:(e,i,r)=>{this.resetLoader(i),s(this.createKeyLoadError(t,Bp.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(e,i,r)=>{this.resetLoader(i),s(this.createKeyLoadError(t,Bp.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(a,l,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:r}=e,n=i.loader;t.keyLoader===n&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],n&&n.destroy()}}function qb(e){const{type:t}=e;switch(t){case Hp:return qp;case $p:return jp;default:return Wp}}function jb(e,t){let i=e.url;return void 0!==i&&0!==i.indexOf("data:")||(i=t.url),i}class PlaylistLoader{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.on(Vp.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(Vp.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(Vp.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Vp.LEVEL_LOADING,this.onLevelLoading,this),e.off(Vp.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(Vp.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(Vp.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,r=t.loader,n=new(i||r)(t);return this.loaders[e.type]=n,n}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Gp,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:r,pathwayId:n,url:s,deliveryDirectives:a,levelInfo:o}=t;this.load({id:i,level:r,pathwayId:n,responseType:"text",type:zp,url:s,deliveryDirectives:a,levelOrTrack:o})}onAudioTrackLoading(e,t){const{id:i,groupId:r,url:n,deliveryDirectives:s,track:a}=t;this.load({id:i,groupId:r,level:null,responseType:"text",type:Hp,url:n,deliveryDirectives:s,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:r,url:n,deliveryDirectives:s,track:a}=t;this.load({id:i,groupId:r,level:null,responseType:"text",type:$p,url:n,deliveryDirectives:s,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[zp];if(i){const e=i.context;e&&!t.levels.some(t=>t===e.levelOrTrack)&&(i.abort(),delete this.loaders[zp])}}load(e){var t;const i=this.hls.config;let r,n=this.getInternalLoader(e);if(n){const t=this.hls.logger,i=n.context;if(i&&i.levelOrTrack===e.levelOrTrack&&(i.url===e.url||i.deliveryDirectives&&!e.deliveryDirectives))return void(i.url===e.url?t.log(`[playlist-loader]: ignore ${e.url} ongoing request`):t.log(`[playlist-loader]: ignore ${e.url} in favor of ${i.url}`));t.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}if(r=e.type===Gp?i.manifestLoadPolicy.default:Yp({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),Op(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===zp&&null!==e.level?t=this.hls.levels[e.level].details:e.type===Hp&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===$p&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,i=t.targetduration;if(e&&i){const t=1e3*Math.max(3*e,.8*i);r=Yp({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}const s=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:s.maxNumRetry||0,retryDelay:s.retryDelayMs||0,maxRetryDelay:s.maxRetryDelayMs||0},o={onSuccess:(e,t,i,r)=>{const n=this.getInternalLoader(i);this.resetInternalLoader(i.type);const s=e.data;0===s.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),M3U8Parser.isMediaPlaylist(s)||i.type!==Gp?this.handleTrackOrLevelPlaylist(e,t,i,r||null,n):this.handleMasterPlaylist(e,t,i,r)):this.handleManifestParsingError(e,i,new Error("no EXTM3U delimiter"),r||null,t)},onError:(e,t,i,r)=>{this.handleNetworkError(t,i,!1,e,r)},onTimeout:(e,t,i)=>{this.handleNetworkError(t,i,!0,void 0,e)}};n.load(e,a,o)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,r){const n=this.hls,s=e.data,a=jb(e,i),o=M3U8Parser.parseMasterPlaylist(s,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,i,o.playlistParsingError,r,t);const{contentSteering:l,levels:h,sessionData:c,sessionKeys:d,startTimeOffset:u,variableList:f}=o;this.variableList=f;const{AUDIO:p=[],SUBTITLES:m,"CLOSED-CAPTIONS":g}=M3U8Parser.parseMasterPlaylistMedia(s,a,o);if(p.length){p.some(e=>!e.url)||!h[0].audioCodec||h[0].attrs.AUDIO||(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new AttrList({}),bitrate:0,url:""}))}n.trigger(Vp.MANIFEST_LOADED,{levels:h,audioTracks:p,subtitles:m,captions:g,contentSteering:l,url:a,stats:t,networkDetails:r,sessionData:c,sessionKeys:d,startTimeOffset:u,variableList:f})}handleTrackOrLevelPlaylist(e,t,i,r,n){const s=this.hls,{id:a,level:o,type:l}=i,h=jb(e,i),c=Op(o)?o:Op(a)?a:0,d=qb(i),u=M3U8Parser.parseLevelPlaylist(e.data,h,c,d,0,this.variableList);if(l===Gp){const e={attrs:new AttrList({}),bitrate:0,details:u,name:"",url:h};u.requestScheduled=t.loading.start+ly(u,0),s.trigger(Vp.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:h,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=u,this.handlePlaylistLoaded(u,e,t,i,r,n)}handleManifestParsingError(e,t,i,r,n){this.hls.trigger(Vp.ERROR,{type:Fp.NETWORK_ERROR,details:Bp.MANIFEST_PARSING_ERROR,fatal:t.type===Gp,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:r,stats:n})}handleNetworkError(e,t,i=!1,r,n){let s=`A network ${i?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${e.type}`;e.type===zp?s+=`: ${e.level} id: ${e.id}`:e.type!==Hp&&e.type!==$p||(s+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(s);this.hls.logger.warn(`[playlist-loader]: ${s}`);let o=Bp.UNKNOWN,l=!1;const h=this.getInternalLoader(e);switch(e.type){case Gp:o=i?Bp.MANIFEST_LOAD_TIMEOUT:Bp.MANIFEST_LOAD_ERROR,l=!0;break;case zp:o=i?Bp.LEVEL_LOAD_TIMEOUT:Bp.LEVEL_LOAD_ERROR,l=!1;break;case Hp:o=i?Bp.AUDIO_TRACK_LOAD_TIMEOUT:Bp.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case $p:o=i?Bp.SUBTITLE_TRACK_LOAD_TIMEOUT:Bp.SUBTITLE_LOAD_ERROR,l=!1}h&&this.resetInternalLoader(e.type);const c={type:Fp.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:h,context:e,error:a,networkDetails:t,stats:n};if(r){const i=(null==t?void 0:t.url)||e.url;c.response=Qp({url:i,data:void 0},r)}this.hls.trigger(Vp.ERROR,c)}handlePlaylistLoaded(e,t,i,r,n,s){const a=this.hls,{type:o,level:l,id:h,groupId:c,deliveryDirectives:d}=r,u=jb(t,r),f=qb(r),p="number"==typeof r.level&&f===Wp?l:void 0;if(!e.fragments.length){const s=e.playlistParsingError=new Error("No Segments found in Playlist");return void a.trigger(Vp.ERROR,{type:Fp.NETWORK_ERROR,details:Bp.LEVEL_EMPTY_ERROR,fatal:!1,url:u,error:s,reason:s.message,response:t,context:r,level:p,parent:f,networkDetails:n,stats:i})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const m=e.playlistParsingError;if(m){if(this.hls.logger.warn(m),!a.config.ignorePlaylistParsingErrors)return void a.trigger(Vp.ERROR,{type:Fp.NETWORK_ERROR,details:Bp.LEVEL_PARSING_ERROR,fatal:!1,url:u,error:m,reason:m.message,response:t,context:r,level:p,parent:f,networkDetails:n,stats:i});e.playlistParsingError=null}switch(e.live&&s&&(s.getCacheAge&&(e.ageHeader=s.getCacheAge()||0),s.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case Gp:case zp:a.trigger(Vp.LEVEL_LOADED,{details:e,levelInfo:r.levelOrTrack||a.levels[0],level:p||0,id:h||0,stats:i,networkDetails:n,deliveryDirectives:d,withoutMultiVariant:o===Gp});break;case Hp:a.trigger(Vp.AUDIO_TRACK_LOADED,{details:e,track:r.levelOrTrack,id:h||0,groupId:c||"",stats:i,networkDetails:n,deliveryDirectives:d});break;case $p:a.trigger(Vp.SUBTITLE_TRACK_LOADED,{details:e,track:r.levelOrTrack,id:h||0,groupId:c||"",stats:i,networkDetails:n,deliveryDirectives:d})}}}class Hls{static get version(){return Uy}static isMSESupported(){return Wb()}static isSupported(){return function(){if(!Wb())return!1;const e=nm();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>e.isTypeSupported(Jm(t,"video")))||["mp4a.40.2","fLaC"].some(t=>e.isTypeSupported(Jm(t,"audio"))))}()}static getMediaSource(){return nm()}static get Events(){return Vp}static get MetadataSchema(){return s_}static get ErrorTypes(){return Fp}static get ErrorDetails(){return Bp}static get DefaultConfig(){return Hls.defaultConfig?Hls.defaultConfig:kb}static set DefaultConfig(e){Hls.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Oy,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=function(e,t,i){const r=em();if("object"==typeof console&&!0===e||"object"==typeof e){const n=["debug","log","info","warn","error"];n.forEach(t=>{r[t]=tm(t,e,i)});try{r.log(`Debug logs enabled for "${t}" in hls.js version 1.6.5`)}catch(e){return em()}n.forEach(t=>{im[t]=tm(t,e)})}else Yp(im,r);return r}(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=function(e,t,i){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const r=Ob(e),n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(e=>{const s=`${"level"===e?"playlist":e}LoadPolicy`,a=void 0===t[s],o=[];n.forEach(i=>{const n=`${e}Loading${i}`,l=t[n];if(void 0!==l&&a){o.push(n);const e=r[s].default;switch(t[s]={default:e},i){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}}),o.length&&i.warn(`hls.js config: "${o.join('", "')}" setting(s) are deprecated, use "${s}": ${Tg(t[s])}`)}),Qp(Qp({},r),t)}(Hls.DefaultConfig,e,t);this.userConfig=e,i.progressive&&Ub(i,t);const{abrController:r,bufferController:n,capLevelController:s,errorController:a,fpsController:o}=i,l=new a(this),h=this.abrController=new r(this),c=new FragmentTracker(this),d=i.interstitialsController,u=d?this.interstitialsController=new d(this,Hls):null,f=this.bufferController=new n(this,c),p=this.capLevelController=new s(this),m=new o(this),g=new PlaylistLoader(this),v=i.contentSteeringController,y=v?new v(this):null,_=this.levelController=new LevelController(this,y),S=new ID3TrackController(this),b=new KeyLoader(this.config),T=this.streamController=new StreamController(this,c,b),x=this.gapController=new GapController(this,c);p.setStreamController(T),m.setStreamController(T);const E=[g,_,T];u&&E.splice(1,0,u),y&&E.splice(1,0,y),this.networkControllers=E;const M=[h,f,x,p,m,S,c];this.audioTrackController=this.createController(i.audioTrackController,E);const w=i.audioStreamController;w&&E.push(this.audioStreamController=new w(this,c,b)),this.subtitleTrackController=this.createController(i.subtitleTrackController,E);const A=i.subtitleStreamController;A&&E.push(this.subtititleStreamController=new A(this,c,b)),this.createController(i.timelineController,M),b.emeController=this.emeController=this.createController(i.emeController,M),this.cmcdController=this.createController(i.cmcdController,M),this.latencyController=this.createController(LatencyController,M),this.coreComponents=M,E.push(l);const L=l.onErrorOut;"function"==typeof L&&this.on(Vp.ERROR,L,l),this.on(Vp.MANIFEST_LOADED,g.onManifestLoaded,g)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,r){this._emitter.off(e,t,i,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;const i=e===Vp.ERROR;this.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.INTERNAL_EXCEPTION,fatal:i,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(Vp.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const t=new Error(`attachMedia failed: invalid argument (${e})`);return void this.trigger(Vp.ERROR,{type:Fp.OTHER_ERROR,details:Bp.ATTACH_MEDIA_ERROR,fatal:!0,error:t})}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,r=t?e:{media:i};this._media=i,this.trigger(Vp.MEDIA_ATTACHING,r)}detachMedia(){this.logger.log("detachMedia"),this.trigger(Vp.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(Vp.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,r=this._url=gm.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${r}`),t&&i&&(i!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(Vp.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),this.started&&this.networkControllers);i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!this.started&&this.networkControllers);e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[Wp]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[qp]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[jp]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=null==e?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();const i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)});return i}}}()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return pg.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let r=0;r<i;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let r;if(r=-1===t&&null!=e&&e.length?e.length-1:t,i)for(let t=r;t--;){const r=e[t].attrs["HDCP-LEVEL"];if(r&&r<=i)return t}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return(null==(t=this.audioTrackController)?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return(null==(t=this.subtitleTrackController)?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!(null==(e=this.bufferController)||!e.bufferedToEnd)}get interstitialsManager(){var e;return(null==(e=this.interstitialsController)?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){return fg(e,Eg(t),navigator.mediaCapabilities)}}Hls.defaultConfig=void 0;class Video{initialized=!1;constructor(e,t){this.el=e,this.Main=t,this.upload_id=this.el.getAttribute("data-id"),this.el.hasAttribute("init")&&this.init()}init(){let e="https://cloudflarestream.com/"+this.upload_id+"/manifest/video.m3u8?&muted=false&";Hls.isSupported()?(this.hls=new Hls,this.hls.loadSource(e),this.hls.attachMedia(this.el)):this.el.canPlayType("application/vnd.apple.mpegurl")&&(this.el.src=e),this.initialized=!0}destroy(){for(this.el&&this.el.pause&&this.el.pause();this.el.firstChild;)this.el.removeChild(this.el.firstChild);this.hls&&this.hls.destroy(),delete this.el,delete this.hls}play(){!1===this.initialized&&this.init(),this.el&&this.el.play()}pause(){this.el&&this.el.pause&&this.el.pause()}}class GsapSequence{constructor(e){$r.registerPlugin($a);const t=e.getAttribute("data-src"),i=parseInt(e.getAttribute("data-travel")),r=e.getAttribute("data-frame-count"),n=e.querySelector("canvas"),s=n.getContext("2d"),a=[],o={frame:0},l=()=>{s.drawImage(a[o.frame],0,0)},h=e=>t.replace("{index}",e.toString().padStart(3,"0"));n.width=1920,n.height=1440;for(let e=0;e<r;e++){const t=new Image;t.src=h(e),a.push(t)}$r.to(o,{frame:r-1,snap:"frame",ease:"none",scrollTrigger:{scrub:.3,trigger:e,start:"top bottom",end:"+="+i},onUpdate:l}),a[0].onload=l}}class GsapScrollReveal{constructor(e){let t="100px",i=100;e.hasAttribute("data-t-start")&&(t=e.getAttribute("data-t-start")),e.hasAttribute("data-t-travel")&&(i=parseInt(e.getAttribute("data-t-travel"))),$r.registerPlugin($a),$r.fromTo(e,{opacity:0,y:i},{opacity:1,y:0,scrollTrigger:{scrub:!0,trigger:e,start:"top+="+t+" bottom",end:"+=40%"}})}}class Transitions{constructor(e){e||(e=document),this.el=e,this.queue_items=[],this.queue_timeout=null,uo.on("scroll",window,this.scroll.bind(this)),uo.on("resize",window,this.setup.bind(this))}setup(){this.el.querySelectorAll("[data-gs-pin]").forEach(e=>{window.innerWidth<768||($r.registerPlugin(Ut),$r.timeline({scrollTrigger:{trigger:e,pin:e.querySelector(e.getAttribute("data-gs-pin")),start:"top top",end:"bottom bottom"}}))}),this.el.querySelectorAll("[data-t-type]").forEach(e=>{let t=null!=e.getAttribute("data-t-offset");var i=e.getBoundingClientRect().top+window.pageYOffset;if(e.setAttribute("data-t-offset",i),!t)switch(e.getAttribute("data-t-type")){case"fadeIn":break;case"scrollReveal":new GsapScrollReveal(e),e.removeAttribute("data-t-type");break;case"imgSequence":e.HwTransition=new GsapSequence(e),e.removeAttribute("data-t-type")}}),this.scroll()}destroy(){uo.off("scroll",window,this.scroll.bind(this))}queue(e,t){e.dataset.queued||(e.dataset.queued=!0,this.queue_items.push(t),this.prepareQueue())}prepareQueue(){this.queue_timeout&&clearTimeout(this.queue_timeout),this.queue_timeout=setTimeout(this.processQueue.bind(this),100)}processQueue(){let e=this.queue_items.shift();e&&e(),this.queue_items.length&&this.prepareQueue()}scroll(){let e=(document.documentElement.scrollTop||document.body.scrollTop)+window.innerHeight+50;this.el.querySelectorAll('[data-t-type="fadeIn"][data-t-offset]').forEach(t=>{if(!(e<t.getAttribute("data-t-offset"))&&"fadeIn"===t.getAttribute("data-t-type"))this.queue(t,()=>{t.classList.add("--in"),t.addEventListener("transitionend",()=>{t.removeAttribute("data-t-offset"),t.removeAttribute("data-t-type")},{once:!0})})})}}class Form{constructor(e,t){this.el=e,this.Main=t,uo.on("submit",this.el,this.submit.bind(this))}destroy(){uo.off("submit",this.el,this.submit.bind(this))}submit(e){e&&e.preventDefault();let t=new FormData(this.el);this.el.classList.add("--loading");let i=this.el.querySelector('[type="submit"]');i&&i.blur(),window.setTimeout(()=>{fetch(this.el.getAttribute("action")||window.location.href,{method:this.el.getAttribute("method"),body:t}).then(e=>{if(e.ok)return e.json();throw new Error("Failed to submit")}).then(e=>{e.errors?(this.setErrors(e.errors),this.el.classList.remove("--loading")):e.data.url?setTimeout(()=>{this.Main.navigatePush(e.data.url,!0)},e.data.delay||0):e.data.reload?this.Main.navigate(window.location.href):(e.data.message||e.data.title)&&(this.openSuccessModal(e.data.title,e.data.message),this.el.classList.remove("--loading"))}).catch(e=>{console.log("error",e)})},750)}openSuccessModal(e,t){let i=`<div class="m-modal__box"><article class="m-article --center --black"><h2 class="a-heading --h1">${e}</h2><p>${t}</p></article></div>`,r=document.createElement("div");r.classList.add("m-modal"),r.innerHTML=i,document.body.appendChild(r),window.requestAnimationFrame(()=>{r.classList.add("--open")}),window.dispatchEvent(new CustomEvent("modal-close")),r.addEventListener("click",()=>{r.remove()},{once:!0})}setErrors(e){var t=null;this.el.querySelectorAll("[name]").forEach(i=>{var r=i.getAttribute("name"),n=App.getView(i.closest("[data-view]"));n.error&&n.error(!1,[]),(Object.prototype.hasOwnProperty.call(e,r)||Object.prototype.hasOwnProperty.call(e,r+"[]"))&&n&&n.error&&null!==n.el.offsetParent&&(n.error(!0,e[r]),t||(t=n))}),t&&t.el.scrollIntoView&&t.el.scrollIntoView({behavior:"smooth",block:"nearest"})}}class Field{constructor(e,t){this.el=e,this.options=t}destroy(){}error(e,t){!0===e?(this.el.classList.add("--error"),t&&this.el.setAttribute("data-error",t)):(this.el.classList.remove("--error"),this.el.removeAttribute("data-error"))}}var Kb=r(436),Yb=r.n(Kb);class FieldPhonenumber extends Field{constructor(e,t){super(e,t),this.input=this.el.querySelector("input"),this.iti=Yb()(this.input,{initialCountry:"us",preferredCountries:[],autoPlaceholder:"aggressive",utilsScript:"/uploads/assets/1647877338.1647521905/static/site/js/intl-tel-input-utils.js",formatOnDisplay:!0,nationalMode:!1,separateDialCode:!1,loadUtils:()=>r.e(183).then(r.bind(r,183))}),uo.on("change",this.input,this.formatInput.bind(this)),uo.on("input",this.input,this.formatInput.bind(this))}destroy(){uo.off("change",this.input,this.formatInput.bind(this)),uo.off("input",this.input,this.formatInput.bind(this))}formatInput(){if(this.iti.isValidNumber()){this.el.classList.remove("--error");var e=this.iti.getNumber(1);this.input.value=e}else this.el.classList.add("--error")}}class FieldMultiselect extends Field{constructor(e,t){super(e,t);const i=this;this.input=this.el.querySelector(".a-input"),this.checkboxes=this.el.querySelectorAll("[name]"),uo.on("click",this.input,this.showDropdown.bind(this)),this.checkboxes.forEach(e=>uo.on("change",e,i.formatInput.bind(i)))}destroy(){uo.off("click",this.input,this.showDropdown.bind(this));let e=this;this.checkboxes.forEach(t=>uo.off("change",t,e.formatInput.bind(e)))}showDropdown(e){e.preventDefault(),this.el.querySelector(".m-group").classList.add("--dropdownOpen")}formatInput(){let e=[];this.checkboxes.forEach(t=>{t.checked&&e.push(t.getAttribute("data-text"))}),this.input.innerText=e.join(", ")}}var Xb=r(756);var Qb="data-scramble-text-idling",Zb="data-scramble-text-running";function Jb(){var e=Date.now()-this._startTime,t=e-this._elapsedTime;if(1e3/this.fps<=t){if(this._elapsedTime=e,this._position=this._idling?0:this._elapsedTime/this.timeOffset|0,this._running){if(this._position>=this._contents.length)return this._running=!1,this.el.innerHTML=this._contents.map(function(e){return e.content}).join(""),this.el.removeAttribute("data-scramble-text-running"),void this.callback();requestAnimationFrame(this._anim);var i=function(e,t,i){for(var r=[],n=0,s=e.length;n<s;n++)"tag"!==e[n].type?n<i?r.push(e[n].content):(/\s/.test(e[n].content)&&r.push(e[n].content),r.push(eT(t))):r.push(e[n].content);return r}(this._contents,this.chars,this._position);this.el.innerHTML=i.join("")}}else requestAnimationFrame(this._anim)}function eT(e){var t=Math.floor(Math.random()*e.length),i=-.5+Math.random(),r=e[t];return i<0?r.toLowerCase():r}const tT=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._startTime=0,this._elapsedTime=0,this._running=!1,this._idling=!0,this._position=0,this._contents=function(e){var t=[],i=/^(\s*)?<\/?[a-z](.*?)>(\s*)?/i,r=/^\s+/;e=e.replace(r,"").replace(/\s+$/,"");for(;0!==e.length;){var n=e.match(i);if(n)t.push({type:"tag",content:n[0].replace(/^(\s*)(.+)(\s*)$/,"$1$2$3")}),e=e.replace(n[0],"");else{var s=e.match(r);s?(t.push({type:"space",content:" "}),e=e.replace(s[0],"")):(t.push({type:"character",content:e[0]}),e=e.slice(1))}}return t}(t.innerHTML),this._anim=Jb.bind(this),this.el=t,this.timeOffset=i.timeOffset||50,this.fps=i.fps||60,this.chars=i.chars||["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","!","#","$","%","&",":",";","?","@","[","]","^","_","{","|","}","~"],this.callback="function"==typeof i.callback?i.callback:function(){},this.play(),this}return e.prototype.play=function(){return this._running||(this._idling=!0,this._running=!0,this._position=0,this.el.setAttribute(Qb,""),this.el.setAttribute(Zb,""),this._anim()),this},e.prototype.start=function(){return this._idling=!1,this._startTime=Date.now(),this._elapsedTime=0,this._position=0,this.el.removeAttribute(Qb),this},e.prototype.stop=function(){return this._running=!1,this.el.removeAttribute(Qb),this.el.removeAttribute(Zb),this},e}();class HOASlide{constructor(e,t){this.el=e,this.isReady=!1,this.end=this.el.dataset.end,this.checkPublished(),this.initAnimations(t)}checkPublished(){let e=!0;if(""!==this.end){e=parseInt(this.end)<(new Date).getTime()/1e3}this.isReady=e,this.el.classList.toggle("--is-public",this.isReady),this.isReady||setTimeout(this.checkPublished.bind(this),1e3);let t=this.el.querySelector("[data-pending]");t&&(t.innerHTML=this.isReady?t.dataset.public:t.dataset.pending)}pause(){this.timeline.pause()}play(){this.timeline.play()}initAnimations(e){this.timeline=$r.timeline({delay:.5,repeat:-1});let t=this.el.querySelector(".a-meta.--awaiting"),i=this.el.querySelector(".a-heading span");this.animations={heading_left:i?new tT(i,{timeOffset:100,chars:"__->",fps:10}):null,meta_right:t?new tT(t,{timeOffset:100,chars:"__->",fps:10}):null},this.timeline.add(()=>{this.animations.heading_left&&this.animations.heading_left.start(),this.animations.meta_right&&this.animations.meta_right.start()}),this.timeline.add(()=>{this.animations.heading_left&&this.animations.heading_left.play(),this.animations.meta_right&&this.animations.meta_right.play()},"+=5s");let r=e.el,n=!1;var s=new MutationObserver(e=>{e.forEach(e=>{n||!1!==e.target.classList.contains("--loadingComplete")&&(e.oldValue.indexOf("--loadingComplete")>0||(this.timeline.play(),n=!0,s.disconnect()))})});s.observe(r,{attributeFilter:["class"],attributeOldValue:!0})}}class HOA{constructor(e,t){this.el=e,this.initSlider(),this.initAnimations(t),this.ctrlState()}initSlider(){let e=this;this.next=this.el.querySelector('.o-hoa [data-control="next"]'),this.prev=this.el.querySelector('.o-hoa [data-control="prev"]'),this.el.querySelector(".o-hoa .m-slider")&&(uo.on("click",'.o-hoa [data-video="play"]',this.playVideo.bind(this)),uo.on("click",".o-hoa article[data-item-index]",this.openSlide.bind(this)),uo.on("click",this.next,this.nextSlide.bind(this)),uo.on("click",this.prev,this.prevSlide.bind(this)),this.slider_title=(0,Xb.U)({container:this.el.querySelector(".m-slider-title"),mode:"carousel",items:1,slideBy:"page",autoplay:!1,mouseDrag:!1,controls:!1,loop:!1,speed:800,nav:!1}),this.slider=(0,Xb.U)({container:this.el.querySelector(".m-slider"),mode:"carousel",items:1,slideBy:"page",autoplay:!1,mouseDrag:!0,controls:!1,loop:!1,speed:800,nav:!1}),this.slider.events.on("indexChanged",this.activateSlide.bind(this)),this.slider.events.on("transitionStart",()=>{e.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.add("--premove")})}),this.slider.events.on("transitionStart",()=>{e.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.remove("--premove")})}),this.slider.events.on("indexChanged",e=>{this.slider_title.goTo(e.index),this.ctrlState()}))}initAnimations(e){this.timeline=$r.timeline({delay:.5,repeat:-1}),this.timeline.add(()=>{this.animations.meta_bottom.start()}),this.timeline.add(()=>{this.animations.meta_bottom.play()},"+=5s"),this.animations={meta_bottom:new tT(this.el.querySelector(".a-meta.--monthly"),{timeOffset:100,chars:"__->",fps:10})};let t=e.el,i=!1;var r=new MutationObserver(e=>{e.forEach(e=>{i||!1!==e.target.classList.contains("--loadingComplete")&&(e.oldValue.indexOf("--loadingComplete")>0||(this.timeline.play(),i=!0,r.disconnect()))})});r.observe(t,{attributeFilter:["class"],attributeOldValue:!0})}nextSlide(){this.slider.goTo("next")}prevSlide(){this.slider.goTo("prev")}ctrlState(){var e=this.slider.getInfo();this.next.classList.toggle("--active",e.index<e.slideCount-1),this.prev.classList.toggle("--active",e.index>0)}activateSlide(e){this.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.remove("--active"),e.classList.remove("--videoPlaying"),e.classList.remove("--videoLoading");let t=App.getView(e.querySelector('[data-view="Video"]'));t&&t.pause();let i=e.querySelector(".-iframe-video");i&&(i.src="")});let t=this.el.querySelector('.m-featured[data-item-index="'+e.index+'"]');t&&t.classList.add("--active")}openSlide(e){e.preventDefault();let t=e.initiator.dataset.itemIndex;this.slider.goTo(t),this.slider_title.goTo(t),this.activateSlide({index:t})}destroy(){uo.off("click",'.o-hoa [data-video="play"]',this.playVideo.bind(this)),uo.off("click",".o-hoa article[data-item-index]",this.openSlide.bind(this)),uo.off("click",this.next,this.nextSlide.bind(this)),uo.off("click",this.prev,this.prevSlide.bind(this)),this.slider&&this.slider.destroy(),this.slider_title&&this.slider_title.destroy()}playVideo(e){e.preventDefault();let t=e.initiator.closest(".m-featured");if(!t)return;let i=t.querySelector(".-iframe-video");if(t&&i)return this.el.classList.add("--videoPlaying"),t.classList.add("--videoPlaying"),t.classList.remove("--videoLoading"),void(i.src=i.dataset.src);let r=App.getView(t.querySelector('[data-view="Video"]'));t.classList.add("--videoLoading"),r&&(this.el.classList.add("--videoPlaying"),t.classList.add("--videoPlaying"),t.classList.remove("--videoLoading"),r.play())}}class USA2025{constructor(e,t){this.el=e,this.Main=t,this.map=this.el.querySelector(".a-map-usa"),uo.on("resize",window,this.resize),this.scaleMap(),this.init()}scaleMap(){this.mapImage=new Image,this.mapImage.addEventListener("load",this.resize),this.mapImage.src=this.map.dataset.src}resize=()=>{var e,t=this.mapImage.width,i=this.mapImage.height;e=window.innerWidth>799?Math.min(window.innerWidth/t,window.innerHeight/i):Math.max(window.innerWidth/t,window.innerHeight/i);var r=this.map;if(r.style.width=t*e+"px",r.style.height=i*e+"px",r.style.backgroundImage="url("+this.map.dataset.src+")",r.style.left=(window.innerWidth-t*e)/2+"px","west"===this.mode&&(r.style.left="0px"),"east"===this.mode){var n=window.innerWidth>799?1:.9;r.style.left=-(t*n*e-window.innerWidth)+"px"}};init(){uo.on("modal-close",window,this.resetUSA.bind(this)),uo.on("click",'.a-btn[data-action="pre-register"]',this.goPreRegister.bind(this)),uo.on("click",'.a-btn[data-action="vote"]',this.goVote.bind(this)),uo.on("click",'[data-action="back"]',this.backVote.bind(this)),uo.on("click",'.a-btn[data-action="west"]',this.goWest.bind(this)),uo.on("click",'.a-btn[data-action="east"]',this.goEast.bind(this)),uo.on("click",'[data-action="hotspot"]',this.setCity.bind(this)),uo.on("click",'[data-action="model-vote-pre-register"]',this.modalVotePreRegister.bind(this)),uo.on("click",'[data-action="close-modal"]',this.closeModal.bind(this)),uo.on("click",'[data-action="buy-tickets"]',this.openUrl.bind(this)),uo.on("click",'[data-action="watch-video"]',this.toggleVideoModal.bind(this))}openUrl(e){e=e.target.closest(".a-btn");window.open(e.dataset.href,"_blank")}toggleVideoModal(e){var t=document.querySelector(".video--modal");if(t.classList.toggle("--active"),t.classList.contains("--active")){var i=t.querySelector("[data-src]");i&&(i.src=i.dataset.src)}}resetUSA(){setTimeout(()=>{var e=document.querySelector(".m-modal");e&&e.remove()},2e3),setTimeout(()=>{this.el.classList.remove("--vote","--stand","--west","--east","--city--west","--city--east","--picked-city","--modal-vote-preregister")},3500),setTimeout(()=>{this.Main.navigatePush("/",!0)},4e3)}goVote(){this.el.classList.add("--vote")}goPreRegister(){this.el.classList.add("--pre-register"),this.Main.navigatePush("/subscribe",!0)}backVote(){this.el.classList.remove("--stand","--west","--east","--picked-city"),this.mode="",this.resize()}goWest(){this.el.classList.add("--stand","--west"),this.mode="west",this.resize()}goEast(){this.el.classList.add("--stand","--east"),this.mode="east",this.resize()}setCity(e){this.el.querySelectorAll(".a-city").forEach(e=>e.classList.remove("--active")),this.el.querySelectorAll(".a-city-line").forEach(e=>e.classList.remove("--active"));var t=e.target.closest(".a-city");t||(t=e.target.closest(".a-city-line")),t.classList.add("--active"),this.el.classList.remove("--city--west","--city--east"),this.el.classList.add("--picked-city","--city--"+t.dataset.type),this.city=t.dataset.title,this.el.querySelector('[name="city"]').value=this.city,this.el.querySelectorAll(".selected-city").forEach(e=>e.innerHTML=t.dataset.title);var i=document.querySelector('[data-action="buy-tickets"]');t.dataset.venue&&t.dataset.date?(this.el.querySelectorAll(".selected-venue-date").forEach(e=>e.classList.remove("--hide")),this.el.querySelectorAll(".selected-venue").forEach(e=>e.innerHTML=t.dataset.venue),this.el.querySelectorAll(".selected-date").forEach(e=>e.innerHTML=t.dataset.date),t.dataset.tickets&&t.dataset.tickets.length>0?(this.el.querySelector('[data-action="model-vote-pre-register"]').classList.add("--hide"),i.classList.remove("--hide"),"1"==t.dataset.soldout?(i.dataset.href="#",i.textContent="Sold Out",i.disabled=!0):(i.dataset.href=t.dataset.tickets,i.textContent="Buy Tickets",i.disabled=!1)):i.classList.add("--hide")):(this.el.querySelectorAll(".selected-venue-date").forEach(e=>e.classList.add("--hide")),this.el.querySelector('[data-action="model-vote-pre-register"]').classList.remove("--hide"),i.classList.add("--hide"))}modalVotePreRegister(){this.el.classList.add("--modal-vote-preregister")}closeModal(){this.el.classList.remove("--modal-vote-preregister")}destroy(){uo.off("modal-close",window,this.resetUSA.bind(this)),uo.off("click",'.a-btn[data-action="pre-register"]',this.goPreRegister.bind(this)),uo.off("click",'.a-btn[data-action="vote"]',this.goVote.bind(this)),uo.off("click",'[data-action="back"]',this.backVote.bind(this)),uo.off("click",'.a-btn[data-action="west"]',this.goWest.bind(this)),uo.off("click",'.a-btn[data-action="east"]',this.goEast.bind(this)),uo.off("click",'[data-action="hotspot"]',this.setCity.bind(this)),uo.off("click",'[data-action="model-vote-pre-register"]',this.modalVotePreRegister.bind(this)),uo.off("click",'[data-action="close-modal"]',this.closeModal.bind(this)),uo.off("resize",window,this.resize)}}class Music{$(e){return this.el.querySelectorAll(e)}constructor(e,t){this.el=e;let i=this;this.el.querySelector(".m-slider")&&(uo.on("click",'.o-music [data-video="play"]',this.playVideo.bind(this)),uo.on("click",".o-music article[data-item-index]",this.openSlide.bind(this)),uo.on("click",".o-music .m-leds button",this.openThumb.bind(this)),this.slider=(0,Xb.U)({container:this.el.querySelector(".m-slider"),mode:"carousel",items:1,slideBy:"page",autoplay:!1,mouseDrag:!0,controls:!1,loop:!1,speed:800,nav:!0,navPosition:"bottom",responsive:{991:{nav:!1}}}),this.slider.events.on("indexChanged",this.activateSlide.bind(this)),this.slider.events.on("transitionStart",()=>{i.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.add("--premove")})}),this.slider.events.on("transitionStart",()=>{i.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.remove("--premove")})}),this.thumbs=(0,Xb.U)({container:this.el.querySelector(".m-horizontalScroller"),items:1,autoplay:!1,speed:800,mouseDrag:!0,fixedWidth:!1,loop:!1,controls:!1,nav:!1,disable:!0,responsive:{991:{disable:!1,items:3,slideBy:2}}}),this.$leds=this.el.querySelectorAll(".m-leds li"),this.thumbs.events.on("indexChanged",e=>{var t=Math.floor(e.index/2);this.$leds.forEach((e,i)=>{i===t?e.classList.add("-active"):e.classList.remove("-active")})}))}activateSlide(e){if(this.el.querySelectorAll(".m-featured").forEach(e=>{e.classList.remove("--active"),e.classList.remove("--videoPlaying"),e.classList.remove("--videoLoading");let t=App.getView(e.querySelector('[data-view="Video"]'));t&&t.pause();let i=e.querySelector(".-iframe-video");i&&(i.src="")}),!e)return;let t=this.el.querySelector('.m-featured[data-item-index="'+e.index+'"]');t&&t.classList.add("--active")}openThumb(e){e.preventDefault();let t=e.initiator.dataset.itemIndex;this.thumbs.goTo(t)}openSlide(e){e.preventDefault();let t=e.initiator.dataset.itemIndex;this.slider.goTo(t),this.activateSlide({index:t})}destroy(){uo.off("click",'.o-music [data-video="play"]',this.playVideo.bind(this)),uo.off("click",".o-music article[data-item-index]",this.openSlide.bind(this)),uo.off("click",".o-music .m-leds button",this.openThumb.bind(this)),this.slider&&this.slider.destroy(),this.thumbs&&this.thumbs.destroy()}playVideo(e){e.preventDefault();let t=e.initiator.closest(".m-featuredMusic");if(!t)return;let i=t.querySelector(".-iframe-video");if(i)return this.el.classList.add("--videoPlaying"),t.classList.add("--videoPlaying"),t.classList.remove("--videoLoading"),void(i.src=i.dataset.src);let r=App.getView(t.querySelector('[data-view="Video"]'));t.classList.add("--videoLoading"),r&&(this.el.classList.add("--videoPlaying"),t.classList.add("--videoPlaying"),t.classList.remove("--videoLoading"),r.play())}}var iT={intro:{comment:"1 door open",ids:{0:"0a616074e1f041b2bc5253b0c929335c",1:"2b86886a9f11c0434512731e0e87ee7e",2:"22b18c8d339a7966b28f3e406db51aef",3:"b44a19eddf3ad630d7eb8544dc84cdb3",4:"9eb8c04b41d37d0b557e5e0118060c4c",5:"c1e7891bf4e44323389c8eb8228218f4",6:"d70bba6ca5a3dbac90a4fa6a2fb77109",7:"012aab4c81dae2a2490caebdf0b93040"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:6,callback:function(e){document.querySelector("body").classList.remove("-hide-logo")}},{at:10,callback:function(e){e.parent_el.classList.remove("--hide-header"),e.parent_el.classList.remove("--hide-doors"),e.parent_el.classList.remove("--hide-counter"),e.body.classList.remove("--fade-countdown"),document.querySelectorAll(".-fade-in").forEach(function(e,t){setTimeout(function(){e.classList.add("in")},250*t+1e3)})}},{ended:!0,goto:19.2,play:!0}]},door_1:{comment:"sequence towards door 1",id:"2b86886a9f11c0434512731e0e87ee7e",events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-1"})}}]},door_2:{comment:"sequence towards door 2",id:"f0bc1bbea0db9be21587c4601af2b75a",ids:{1:"78df2de1e606f22a23c7f9078524d3af",2:"f0bc1bbea0db9be21587c4601af2b75a"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-2"})}}]},door_3:{comment:"sequence towards door 3",id:"f3fa5b9e04d51c7c08628f145b1ecfee",ids:{1:"61ae603958544b450bcd30f324b5eb53",2:"3ca120cd8bf85e6703c49e494b67ce32",3:"f3fa5b9e04d51c7c08628f145b1ecfee"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-3"})}}]},door_4:{comment:"sequence towards door 4",id:"e82f950979421d21f19a591e06180f0d",ids:{1:"2fd41b7911e3008e3fc705a5fec45ba9",2:"6d732cfc8dc016b39cf0eead77a404a1",3:"7aa8afe4c1793968d3304afc2c23555d",4:"e82f950979421d21f19a591e06180f0d"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-4"})}}]},door_5:{comment:"sequence towards door 5",id:"6f0bf2c38c43365c40d52156f2febd32",ids:{1:"1829c6af46ff21ab4bdfba9d76d66894",2:"048ca2ed5ccea0faf9509d67cba80032",3:"7caf198d2a8b91e0ee4767014d997fca",4:"e88fafb8250c134609e88f7fa7d6865f",5:"6f0bf2c38c43365c40d52156f2febd32"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-5"})}}]},door_6:{comment:"sequence towards door 6",id:"3bda7fb6eb6720ddd2be8c7814a07d8c",ids:{1:"9eb8eb8a2e6d0b9b0d65319e8b1a45d9",2:"e0564f5acced27ac9ea35f1c0e4e0e43",3:"d01e953a92c51e2b34f4fa4f07cda45d",4:"6452d8cd03abd0f43371b9315d141b42",5:"6fbfb6ea3a8c31d576b8f0acc9c494f2",6:"3bda7fb6eb6720ddd2be8c7814a07d8c"},events:[{at:1,callback:function(e){e.parent_el.classList.add("--hide-doors")}},{at:2,callback:function(e){e.fadeCountdown()}},{at:5.5,ended:!0,callback:function(e){e.openModal({url:"/doors/door-6"})}}]}};class Doorways{initialized=!1;is_ready=!1;sequences=iT;constructor(e,t){this.el=e,this.parent_el=document.querySelector("#doorways"),this.modal=document.querySelector("#doorways-modal"),this.body=document.querySelector("body"),this.videoIndex=this.el.getAttribute("data-video-index"),this.Main=t,this.init(),this._load(this.sequences.intro)}init(){this.initialized=!0,uo.on("click",'[data-action="story"]',this.openSequence.bind(this)),uo.on("timeupdate",this.el,this._timeUpdate.bind(this)),uo.on("ended",this.el,this._ended.bind(this)),uo.on("click",".a-logo",this.toHome.bind(this))}toHome(e){e&&e.preventDefault(),e&&e.stopPropagation(),this.closeModal(),this._load(this.sequence.intro)}currenct_modal_url={};openModal(e){if(this.currenct_modal_url==e.url)return;this.currenct_modal_url=e.url,uo.on("click",'[data-method="close-modal"]',this.closeModal.bind(this)),this.body.classList.add("--modal--open");let t=this,i=this.modal.querySelector(".o-modal--content");fetch(e.url,{method:"GET"}).then(e=>{if(i.innerHTML='<div class="-center"><h1>Doorway not ready, please check-in later!</h1></div>',e.ok)return e.text();throw setTimeout(function(){t.modal.classList.add("--modal--ready")},600),new Error("Failed to submit")}).then(e=>{let r=(e=(new DOMParser).parseFromString(e,"text/html")).querySelector(".content-container");i.innerHTML=r?r.innerHTML:"Gateway not ready, please checkin later",t.Main.App.setupViews(i),setTimeout(function(){t.modal.classList.add("--modal--ready")},1200)})}fadeCountdown(){this.body.classList.add("--fade-countdown")}closeModal(){this.currenct_modal_url="",uo.off("click",'[data-method="close-modal"]',this.closeModal.bind(this)),this.body.classList.remove("--modal--open");let e=this.Main.App.getViews(this.modal);for(let t in e)e[t]&&e[t].destroy&&(e[t].destroy(),e[t]=null);this.modal.classList.remove("--modal--ready"),this._load(this.sequences.intro)}openSequence(e){let t=e.target.getAttribute("data-door");this.sequences[t]?(this.is_ready=!0,this._load(this.sequences[t]),this.fadeCountdown()):console.log("door not ready",t)}_load(e){if(!e)return;let t="object"==typeof e.ids&&e.ids[this.videoIndex]?e.ids[this.videoIndex]:e.id;if(this.sequence=e,this.current_video===t)return void(this.sequence.callback&&this.sequence.callback(this));this.current_video=t,this.el.currentTime=0,this.is_ready&&this.parent_el.classList.add("--loading"),this.el&&this.el.pause&&this.el.pause();let i="https://cloudflarestream.com/"+t+"/manifest/video.m3u8?&muted=true";return Hls.isSupported()?(this.hls&&(this.hls.stopLoad(),this.hls.detachMedia(),this.hls.destroy()),this.hls=new Hls,this.hls.lowLatencyMode=!0,this.hls.attachMedia(this.el),this.hls.on(Hls.Events.ERROR,function(e,t){if(t.fatal)switch(t.type){case Hls.ErrorTypes.NETWORK_ERROR:console.log("fatal network error encountered, try to recover"),hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.log("fatal media error encountered, try to recover"),hls.recoverMediaError();break;default:hls.destroy()}}),this.hls.loadSource(i)):this.el.canPlayType("application/vnd.apple.mpegurl")&&(this.el.src=i),this.canPlayThrough(),!0}canPlayThrough(){uo.off("canplaythrough",this.el,this.canPlayThrough.bind(this)),this.parent_el.classList.remove("--loading"),this.el.currentTime=0,this.is_ready&&this.play(),this.sequence.callback&&this.sequence.callback(this)}_timeUpdate(){let e=this;e.el&&e.el.currentTime&&this.sequence.events.map(function(t){e.el.currentTime>t.at-.2&&e.el.currentTime<t.at+.2&&(t.goto&&(e.el.currentTime=t.goto),t.callback&&t.callback(e))})}_ended(){let e=this;this.sequence.events.map(function(t){return!t.ended||(t.goto&&(e.el.currentTime=t.goto),t.play&&e.el.play(),t.callback&&t.callback(e),!1)})}destroy(){for(uo.off("click",'[data-action="story"]',this.openSequence.bind(this)),uo.off("timeupdate",this.el,this._timeUpdate.bind(this)),uo.off("ended",this.el,this._ended.bind(this)),uo.off("click",".a-logo",this.toHome.bind(this)),this.pause();this.el.firstChild;)this.el.removeChild(this.el.firstChild);this.hls&&this.hls.destroy(),delete this.el,delete this.hls}play(){this.is_ready=!0,!1===this.initialized&&this.init(),this.el&&this.el.play()}pause(){this.el&&this.el.pause&&this.el.pause()}}const rT=function(){var e,t;window.onerror=(e=0,t=0,function(i,r,n,s,a){var o=Date.now();if(o-t>1e4&&(e=0),t=o,!(++e>2)){"string"!=typeof i&&(i=i.message||i.type);var l={type:"error",programming_language:"js",domain:location.host,request_url:location.pathname,errors:[{message:i,file:r,line:n,code:s}]};a&&a.name&&(l.errors[0].class=a.name),a&&a.stack&&(l.errors[0].trace=a.stack),a&&(l.data={message:a.message,stack:a.stack});var h=document.createElement("img");h.src="/hangover/report?report="+encodeURIComponent(JSON.stringify(l)),h.style.display="none",document.body?document.body.appendChild(h):setTimeout(()=>{document.body.appendChild(h)},0)}})};var nT=r(196),sT=r.n(nT);class Countdown{initialized=!1;constructor(e,t){this.el=e,this.Main=t,this.end=new Date(1e3*this.el.getAttribute("data-end")),this.targets=this.el.querySelectorAll("[data-value]"),this.init()}init(){this.parse(),this._t=setInterval(this.parse.bind(this),500)}parse(){var e=this.getTimeRemaining();if(e.total<0)return this.el.classList.add("--hide"),void clearInterval(this._t);this.targets.forEach(t=>{var i=t.getAttribute("data-value");t.innerHTML=("0000"+e[i]).slice(-2)})}destroy(){clearInterval(this._t)}getTimeRemaining(){const e=(this.end-Date.parse(new Date))/1e3,t=Math.floor(e%60),i=Math.floor(e/60%60),r=Math.floor(e/3600%24);return{total:e,days:Math.floor(e/86400),hours:r,minutes:i,seconds:t}}}class DoorwayVideo{constructor(e,t){this.el=e,this.Main=t,this.bounds=document.getElementById("doorways-content"),uo.on("click",this.el.querySelector('[data-method="toggle-play"]'),this.togglePlay.bind(this)),uo.on("click",this.el.querySelector('[data-method="toggle"]'),this.toggle.bind(this)),uo.on("click",this.el.querySelector('[data-method="toggle-preview"]'),this.togglePreview.bind(this)),this.root_audio=document.getElementById("audio"),this.audio_return_state=!this.root_audio.paused,this.audio_preview=document.getElementById("audio_preview"),setTimeout(this.ready.bind(this),200)}togglePreview(e){let t=e.target.closest(".audio-preview");t.classList.toggle("--is-playing"),t.classList.contains("--is-playing")?(this.Main.toggleSound(!0),this.audio_preview.currentTime=0,this.audio_preview.play(),this.root_audio.pause()):this.audio_preview.paused||this.audio_preview.pause()}ready(){this.el.classList.remove("--loading"),App.getView(this.el.querySelector(".bg-video")).play()}toggle(e){if(e.target.closest("a"))return!1;e.target.closest(".a-banner").classList.toggle("--open")}togglePlay(e){e.stopPropagation(),e.target.closest(".a-banner").classList.contains("--playing")?this.stop(e):this.play(e)}play(e){this.root_audio&&this.root_audio.pause(),this.audio_preview&&this.audio_preview.pause();let t=e.target.closest(".a-banner");t.classList.add("--playing");let i=App.getView(t.querySelector('[data-view="Video"]'));i.el.currentTime=0,i.play()}stop(e){let t=e.target.closest(".a-banner");t.classList.remove("--playing"),App.getView(t.querySelector('[data-view="Video"]')).pause()}destroy(){uo.off("click",this.el.querySelector('[data-method="toggle-play"]'),this.togglePlay.bind(this)),uo.off("click",this.el.querySelector('[data-method="toggle"]'),this.toggle.bind(this)),uo.off("click",this.el.querySelector('[data-method="toggle-preview"]'),this.togglePreview.bind(this)),this.audio_return_state&&this.root_audio.play(),delete this.el}}sT().polyfill();var aT=null,oT=null;function lT(e){oT&&clearTimeout(oT),e.volume<.95?(e.volume+=.05,e.muted=!1,aT=setTimeout(function(){lT(e)},50)):e.volume=1}function hT(e){if(aT&&clearTimeout(aT),/iPad|iPhone|iPod/.test(navigator.userAgent))return e.volume=0,void(e.muted=!0);e.volume>.05?(e.volume-=.05,oT=setTimeout(function(){hT(e)},25)):(e.volume=0,e.muted=!0)}function cT(e){var t=e.getBoundingClientRect(),i=document.body,r=document.documentElement,n=window.pageYOffset||r.scrollTop||i.scrollTop,s=window.pageXOffset||r.scrollLeft||i.scrollLeft,a=r.clientTop||i.clientTop||0,o=r.clientLeft||i.clientLeft||0,l=t.top+n-a,h=t.left+s-o;return{top:Math.round(l),left:Math.round(h)}}class Main{constructor(){let e=this;this.App=new App(this),this.App.addViews(Form,Field,FieldPhonenumber,FieldMultiselect,Video,Music,TourdatesAll,Tourdates),this.App.addViews(HOA,HOASlide),this.App.addViews(SimpleGlobe,Slider4D),this.App.addViews(Doorways,Countdown,DoorwayVideo),this.App.addViews(USA2025),this.el=document.querySelector("body"),this.ui=this.el.querySelector(".o-ui"),this.transitions=new Transitions,this.sound=!1,this.el.classList.add("--loading"),this.initializeHistory(),this.initializeEvents(),this.initializePage(),this.preloadMedia(()=>{e.el.classList.remove("--loading","--preloading"),e.el.classList.add("--loadingComplete"),this.ui.querySelector(".o-enter")&&e.el.classList.add("--enter"),e.showPage()},750),rT()}initializeEvents(){uo.on("click",'[data-sound="on"]',this.enableSound.bind(this)),uo.on("click",'[data-sound="off"]',this.disableSound.bind(this)),uo.on("click","[data-enter]",this.enter.bind(this)),uo.on("click","[data-scrollto]",this.scrollTo.bind(this)),uo.on("click",'[href^="/"]',this.navigateTo.bind(this))}destroy(){this.video=null,uo.off("click",'[data-sound="on"]',this.enableSound.bind(this)),uo.off("click",'[data-sound="off"]',this.disableSound.bind(this)),uo.off("click","[data-enter]",this.enter.bind(this)),uo.off("click","[data-scrollto]",this.scrollTo.bind(this)),uo.off("click",'[href^="/"]',this.navigateTo.bind(this))}initializeHistory(){window.onpopstate=function(){this.navigate(location.href)}.bind(this)}initializePage(){this.App.setupViews(this.ui),this.video=this.el.querySelector("#hero video"),this.video||(this.video=this.el.querySelector("#doorways video")),this.sound||this.el.querySelectorAll("audio, video").forEach(e=>{e.volume=0,e.muted=!0})}showPage(){this.transitions.setup(),window.scrollTo(0,0)}preloadMedia(e,t){var i=this.el.querySelectorAll("img, [data-img]"),r=Date.now();t||(t=0),Promise.all(Array.from(i).map(e=>"IMG"==e.tagName?e.complete?Promise.resolve(!0):new Promise(t=>{e.addEventListener("load",()=>t(!0)),e.addEventListener("error",()=>t(!1))}):"VIDEO"==e.tagName||"AUDIO"==e.tagName?4==e.readyState?Promise.resolve(!0):new Promise(t=>{e.addEventListener("canplaythrough",()=>t(!0)),e.addEventListener("error",()=>t(!1))}):new Promise(t=>{const i=new Image;i.addEventListener("load",()=>t(!0)),i.addEventListener("error",()=>t(!1)),i.src=e.getAttribute("data-img")}))).then(i=>{var n=i.every(e=>e),s=Date.now()-r,a=Math.max(t-s,0);setTimeout(()=>{e(n)},a)})}toggleSound(e){if(this.sound=e,this.el.classList.toggle("--soundEnabled",e),e){let e=document.getElementById("audio");e.muted=!1,e.play()}this.el.querySelectorAll("audio, video").forEach(function(t){e?lT(t):hT(t)})}scrollTo(e){e.preventDefault();var t=this.el.querySelector(e.initiator.getAttribute("data-scrollto"));t&&(e.initiator.blur(),window.scrollTo({top:cT(t).top,left:0,behavior:"smooth"}))}navigateTo(e){var t=e.initiator.getAttribute("href");t.startsWith("/")&&!t.startsWith("//:")&&(e.preventDefault(),this.navigatePush(t))}navigatePush(e,t){(e!=window.location.pathname||t)&&(history.pushState({url:e},"",e),this.navigate(e))}navigate(e){let t=this,i=t.el,r=t.ui,n=Date.now(),s=0;i.classList.add("--loadingTransition"),fetch(e,{method:"GET"}).then(e=>{if(e.ok)return e.text();throw new Error("Failed to submit")}).then(e=>{s=Date.now()-n;let a=Math.max(1e3-s,0);setTimeout(function(){let n=t.App.getViews(t.ui);for(let e in n)n[e]&&n[e].destroy&&(n[e].destroy(),n[e]=null);let s=null,a=new DOMParser;var o,l;(s=(e=a.parseFromString(e,"text/html")).querySelector(".o-enter"))&&s.remove(),r.innerHTML=e.querySelector(".o-ui").innerHTML,i.className=(o=e.querySelector("body"),l=[],o.classList.forEach(e=>{e.startsWith("page")&&l.push(e)}),l.push("--loadingTransition"),t.sound&&l.push("--soundEnabled"),l.join(" ")),e=null,a=null,t.initializePage(),t.preloadMedia(()=>{i.classList.remove("--loadingTransition"),i.classList.add("--loadingComplete"),t.showPage(),t.video&&t.video.play()},50)},a)}).catch(e=>{console.log("error",e)})}enableSound(e){e.preventDefault(),this.toggleSound(!0)}disableSound(e){e.preventDefault(),this.toggleSound(!1)}enter(e){e.preventDefault();var t="sound_on"==e.initiator.getAttribute("data-enter");this._enter(t)}_enter(e){this.toggleSound(e),this.video.play(),this.el.classList.remove("--enter"),this.el.classList.add("--enterComplete"),this.el.querySelector(".o-enter").setAttribute("aria-hidden",!0),window.scrollTo(0,0)}}"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?new Main:document.addEventListener("DOMContentLoaded",()=>new Main)})()})();